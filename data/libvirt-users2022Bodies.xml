<?xml version="1.0" encoding="utf-8"?>
<emails><email><emailId>20220701093755</emailId><senderName>Uriel_Emmanuel_Pelaez_Hernández</senderName><senderEmail>upelaez.hdz@ciencias.unam.mx</senderEmail><timestampReceived>2022-07-01 09:37:55-0400</timestampReceived><subject>Incomplete information in the website Wiki for libvirt.org</subject><body>

Dear Web Marster from wiki.libvirt.org,

I tried to look for the libvirtd, the demon that is suppose to run under
Linux/Unix environment,
but your site didn't show any information. Only a statement appeared:
"Create the page libvirtd "

Please, update your site or suggest any other weblink with the information.

In theory CygWin use your package, but the information is incomplete too,
about this issue.

I send this mail to these both Email address by the information displayed
in your wiki, about the contact address to solve this kind of problems.

By now, Google Service in my region is deprecated, so the information that
the WebBrowser display is not the best.

I send this request from my Email of Graduated Student form the University
domain.

Best Regards,
Mr. Pel=C3=A1ez Uriel.
Mexico City

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;Dear Web Marster from &lt;a \
href="http://wiki.libvirt.org"&gt;wiki.libvirt.org&lt;/a&gt;,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I tried to \
look for the libvirtd, the demon  that is suppose to run under Linux/Unix \
environment,&lt;/div&gt;&lt;div&gt;but your site didn't show any information. Only a \
statement appeared:  &lt;/div&gt;&lt;div&gt;"Create the page libvirtd \
"&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Please, update your site or suggest any other weblink \
with the information.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;In theory  CygWin use your package, \
but the information is incomplete too, about this issue.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I \
send this mail to these both Email address by the information displayed in your wiki, \
about the contact address to solve this kind of problems.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;By \
now, Google Service in my region is deprecated, so the information that the \
WebBrowser display is not the best.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I send this request from \
my Email of Graduated  Student form the University \
domain.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Best Regards,&lt;/div&gt;&lt;div&gt;Mr. Peláez \
Uriel.&lt;/div&gt;&lt;div&gt;Mexico City&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220701142517</emailId><senderName>Peter Krempa</senderName><senderEmail>pkrempa@redhat.com</senderEmail><timestampReceived>2022-07-01 14:25:17-0400</timestampReceived><subject>Re: Storage Pool - NFS v4.1</subject><body>

On Wed, Jun 29, 2022 at 17:58:28 +0200, Charles Koprowski wrote:
&gt; Le jeu. 23 juin 2022 à 17:19, Peter Krempa &lt;pkrempa@redhat.com&gt; a écrit :
&gt; 
&gt; &gt;
&gt; &gt; I've posted a patch that fixes this:
&gt; &gt;
&gt; &gt; https://listman.redhat.com/archives/libvir-list/2022-June/232541.html
&gt; &gt;
&gt; &gt;
&gt; Thank you !
&gt; 
&gt; This has been reported to Canonical support :
&gt; https://bugs.launchpad.net/ubuntu/+source/libvirt/+bug/1980134

It's now pushed as commit c44930d932203b4a58dccbbeaa814fff6cea8216

</body></email><email><emailId>20220701152746</emailId><senderName>"dberrange () yahoo ! com"</senderName><senderEmail>dberrange@yahoo.com</senderEmail><timestampReceived>2022-07-01 15:27:46-0400</timestampReceived><subject>Re: Testing DKIM handling</subject><body>

Testing DKIM handling with new mail server settings

    On Tuesday, 28 June 2022 at 17:24:05 BST, dberrange@yahoo.com &lt;dberrange@yahoo.com&gt; wrote:  
 
  
Another test of DKIM handling in Red Hat mail servers, apologies for the continued nuisance.
    On Wednesday, 8 June 2022 at 13:58:39 BST, dberrange@yahoo.com &lt;dberrange@yahoo.com&gt; wrote:  
 
  
Further DKIM handling test, apologies for the noise.
    On Friday, 13 May 2022, 10:03:32 BST, dberrange@yahoo.com &lt;dberrange@yahoo.com&gt; wrote:  
 
 Testing DKIM handling RH mail servers
      
[Attachment #3 (text/html)]

&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;div class="ydpca07deccyahoo-style-wrap" \
style="font-family:Helvetica Neue, Helvetica, Arial, \
                sans-serif;font-size:16px;"&gt;&lt;div&gt;&lt;/div&gt;
        &lt;div dir="ltr" data-setdir="false"&gt;Testing DKIM handling with new mail server \
settings&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;  
        &lt;/div&gt;&lt;div id="yahoo_quoted_7446283416" class="yahoo_quoted"&gt;
            &lt;div style="font-family:'Helvetica Neue', Helvetica, Arial, \
sans-serif;font-size:13px;color:#26282a;"&gt;  
                &lt;div&gt;
                    On Tuesday, 28 June 2022 at 17:24:05 BST, dberrange@yahoo.com \
&lt;dberrange@yahoo.com&gt; wrote:  &lt;/div&gt;
                &lt;div&gt;&lt;br&gt;&lt;/div&gt;
                &lt;div&gt;&lt;br&gt;&lt;/div&gt;
                &lt;div&gt;&lt;div id="yiv0032048850"&gt;&lt;div&gt;&lt;div style="font-family:Helvetica \
Neue, Helvetica, Arial, sans-serif;font-size:16px;" \
class="yiv0032048850ydp5812b662yahoo-style-wrap"&gt;&lt;div&gt;&lt;/div&gt;  &lt;div&gt;&lt;br \
clear="none"&gt;&lt;/div&gt;&lt;div dir="ltr"&gt;Another test of DKIM handling in Red Hat mail \
servers, apologies for the continued nuisance.&lt;/div&gt;&lt;div dir="ltr"&gt;&lt;br \
clear="none"&gt;&lt;/div&gt;  
        &lt;/div&gt;&lt;div id="yiv0032048850yqt29052" class="yiv0032048850yqt2697730012"&gt;&lt;div \
                id="yiv0032048850yahoo_quoted_6739749392" \
                class="yiv0032048850yahoo_quoted"&gt;
            &lt;div style="font-family:'Helvetica Neue', Helvetica, Arial, \
sans-serif;font-size:13px;color:#26282a;"&gt;  
                &lt;div&gt;
                    On Wednesday, 8 June 2022 at 13:58:39 BST, dberrange@yahoo.com \
&lt;dberrange@yahoo.com&gt; wrote:  &lt;/div&gt;
                &lt;div&gt;&lt;br clear="none"&gt;&lt;/div&gt;
                &lt;div&gt;&lt;br clear="none"&gt;&lt;/div&gt;
                &lt;div&gt;&lt;div id="yiv0032048850"&gt;&lt;div&gt;&lt;div style="font-family:Helvetica \
Neue, Helvetica, Arial, sans-serif;font-size:16px;" \
                class="yiv0032048850ydp2bdcabaeyahoo-style-wrap"&gt;&lt;div&gt;&lt;/div&gt;
        &lt;div&gt;&lt;br clear="none"&gt;&lt;/div&gt;&lt;div dir="ltr"&gt;Further DKIM handling test, \
apologies for the noise.&lt;br clear="none"&gt;&lt;/div&gt;  
        &lt;/div&gt;&lt;div id="yiv0032048850yqt17059" class="yiv0032048850yqt5088004138"&gt;&lt;div \
                id="yiv0032048850yahoo_quoted_5170972316" \
                class="yiv0032048850yahoo_quoted"&gt;
            &lt;div style="font-family:'Helvetica Neue', Helvetica, Arial, \
sans-serif;font-size:13px;color:#26282a;"&gt;  
                &lt;div&gt;
                    On Friday, 13 May 2022, 10:03:32 BST, dberrange@yahoo.com \
&lt;dberrange@yahoo.com&gt; wrote:  &lt;/div&gt;
                &lt;div&gt;&lt;br clear="none"&gt;&lt;/div&gt;
                &lt;div&gt;&lt;br clear="none"&gt;&lt;/div&gt;
                &lt;div&gt;&lt;div id="yiv0032048850"&gt;&lt;div&gt;&lt;div style="font-family:Helvetica \
Neue, Helvetica, Arial, sans-serif;font-size:16px;" \
class="yiv0032048850yahoo-style-wrap"&gt;&lt;div dir="ltr"&gt;Testing DKIM handling RH mail \
servers&lt;br clear="none"&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;  &lt;/div&gt;
        &lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;&lt;/body&gt;&lt;/html&gt;



</body></email><email><emailId>20220704111927</emailId><senderName>Martin Kletzander</senderName><senderEmail>mkletzan@redhat.com</senderEmail><timestampReceived>2022-07-04 11:19:27-0400</timestampReceived><subject>Re: Incomplete information in the website Wiki for libvirt.org</subject><body>


On Fri, Jul 01, 2022 at 04:37:55AM -0500, Uriel Emmanuel Pelaez Hern=E1ndez=
 wrote:
&gt;Dear Web Marster from wiki.libvirt.org,
&gt;
&gt;I tried to look for the libvirtd, the demon that is suppose to run under
&gt;Linux/Unix environment,
&gt;but your site didn't show any information. Only a statement appeared:
&gt;"Create the page libvirtd "
&gt;

Hi, we are slowly migrating the wiki pages to knowledge base articles
due to various issues with the wiki.

&gt;Please, update your site or suggest any other weblink with the information.
&gt;

Have a look at our docs page: https://libvirt.org/docs.html where you
might find what you are looking for.  There is a particular page about
daemons here: https://libvirt.org/daemons.html

&gt;In theory CygWin use your package, but the information is incomplete too,
&gt;about this issue.
&gt;
&gt;I send this mail to these both Email address by the information displayed
&gt;in your wiki, about the contact address to solve this kind of problems.
&gt;

Unfortunately I am not sure what are you trying to solve, so I don't
know what clearer pointers to give you.

&gt;By now, Google Service in my region is deprecated, so the information that
&gt;the WebBrowser display is not the best.
&gt;
&gt;I send this request from my Email of Graduated Student form the University
&gt;domain.
&gt;
&gt;Best Regards,
&gt;Mr. Pel=E1ez Uriel.
&gt;Mexico City

Have a nice day,
Martin

["signature.asc" (application/pgp-signature)]

</body></email><email><emailId>20220707191841</emailId><senderName>Stan Cox</senderName><senderEmail>scox@redhat.com</senderEmail><timestampReceived>2022-07-07 19:18:41-0400</timestampReceived><subject>Re: systemtap stapvirt tool</subject><body>

I turned on:
  LIBVIRT_DEBUG=debug
which shows the deviation, indicated by "-&gt;".  The working case, stdin 
event followed by stream event is:

stapvirt: ##### stdin_event:1000 fd 0 events 0x1 stbuf_off 0 stbuf 
0x7fff259eecb8 termbuf_off 58 buf "file 926928 stap_b861775"
   2022-07-07 17:20:55.565+0000: 353069: debug : 
virStreamEventUpdateCallback:1102 : stream=0x2013150, events=3
   2022-07-07 17:20:55.565+0000: 353069: debug : 
virNetClientStreamEventTimerUpdate:86 : Check timer rx=(nil) cbEvents=3
   2022-07-07 17:20:55.565+0000: 353069: debug : 
virNetClientStreamEventTimerUpdate:91 : Enabling event timer
   2022-07-07 17:20:55.565+0000: 353069: info : 
virEventGLibTimeoutUpdate:395 : EVENT_GLIB_UPDATE_TIMEOUT: timer=1 
interval=0
   2022-07-07 17:20:55.565+0000: 353069: debug : 
virEventGLibTimeoutUpdate:406 : Update timeout data=0x2017e00 timer=1 
interval=0 ms
   2022-07-07 17:20:55.565+0000: 353069: debug : 
virEventRunDefaultImpl:341 : running default event implementation
-&gt;2022-07-07 17:20:55.565+0000: 353069: debug : 
virEventGLibTimeoutDispatch:303 : Dispatch timeout data=0x2017e00 
cb=0x7fe5f98436a0 timer=1 opaque=0x200d170
   2022-07-07 17:20:55.565+0000: 353069: info : 
virEventGLibTimeoutDispatch:306 : EVENT_GLIB_DISPATCH_TIMEOUT: timer=1 
cb=0x7fe5f98436a0 opaque=0x200d170
   2022-07-07 17:20:55.565+0000: 353069: debug : 
virNetClientStreamEventTimer:116 : Got Timer dispatch events=2 
cbEvents=3 rx=(nil)
stapvirt: ##### stream_event:1043 st 0x2013150 events 0x2 stbuf_off 0 
stbuf 0x7fff259eecb8

The case where stream event is not hit is:


stapvirt: ##### stdin_event:1000 fd 0 events 0x1 stbuf_off 0 stbuf 
0x7fff259eecb8 termbuf_off 1024 buf "^?ELF^B^A^A"
   2022-07-07 17:20:55.565+0000: 353069: debug : 
virStreamEventUpdateCallback:1102 : stream=0x2013150, events=3
   2022-07-07 17:20:55.565+0000: 353069: debug : 
virNetClientStreamEventTimerUpdate:86 : Check timer rx=(nil) cbEvents=3
   2022-07-07 17:20:55.565+0000: 353069: debug : 
virNetClientStreamEventTimerUpdate:91 : Enabling event timer
   2022-07-07 17:20:55.565+0000: 353069: info : 
virEventGLibTimeoutUpdate:395 : EVENT_GLIB_UPDATE_TIMEOUT: timer=1 
interval=0
   2022-07-07 17:20:55.565+0000: 353069: debug : 
virEventGLibTimeoutUpdate:406 : Update timeout data=0x2017e00 timer=1 
interval=0 ms
   2022-07-07 17:20:55.566+0000: 353069: debug : 
virEventRunDefaultImpl:341 : running default event implementation
-&gt; 2022-07-07 17:20:55.566+0000: 353069: debug : 
virEventGLibHandleDispatch:113 : Dispatch handler data=0x201e600 watch=2 
fd=0 events=1 opaque=0x7fff259ee8a0
   2022-07-07 17:20:55.566+0000: 353069: info : 
virEventGLibHandleDispatch:116 : EVENT_GLIB_DISPATCH_HANDLE: watch=2 
events=1 cb=0x4046e9 opaque=0x7fff259ee8a0
stapvirt: ##### stdin_event:975 fd 0 events 0x1 termbuf_off 1024 1024


Hits stream			Doesn't hit stream
...				...
virEventRunDefaultImpl:341	virEventRunDefaultImpl:341
				virEventGLibHandleDispatch:113
virEventGLibTimeoutDispatch:303
virEventGLibTimeoutDispatch:306
virNetClientStreamEventTimer:116
				virEventGLibHandleDispatch:116
stream_event			stdin_event

&gt; What libvirt version are you testing with, and have you tried a differnt
&gt; version ?

This is:
libvirt-8.1.0-2.fc36.x86_64
I have not tried another version but will give that a shot.

</body></email><email><emailId>20220713110454</emailId><senderName>Daniel =?utf-8?B?UC4gQmVycmFuZ8Op?=</senderName><senderEmail>berrange@redhat.com</senderEmail><timestampReceived>2022-07-13 11:04:54-0400</timestampReceived><subject>Re: The default USB controller of pc machine type</subject><body>

On Wed, Jul 13, 2022 at 07:00:17PM +0800, Han Han wrote:
&gt; Hello,
&gt; I found that the default USB controller for q35 machine type is qemu-xhci
&gt; while for pc it is piix3-uhci. Here are the results(on qemu-kvm-7.0.0
&gt; qemu-kvm-7.0.0):
&gt; ➜  ~ cat /tmp/usb.xml
&gt; &lt;domain type="kvm"&gt;
&gt;   &lt;name&gt;USB&lt;/name&gt;
&gt;   &lt;uuid&gt;1a81d4ef-6537-4ae8-b257-8a15e0c0525f&lt;/uuid&gt;
&gt;   &lt;memory&gt;2097152&lt;/memory&gt;
&gt;   &lt;currentMemory&gt;2097152&lt;/currentMemory&gt;
&gt;   &lt;vcpu&gt;1&lt;/vcpu&gt;
&gt;   &lt;os&gt;
&gt;     &lt;type arch="x86_64" machine="q35"&gt;hvm&lt;/type&gt;
&gt;     &lt;boot dev="hd"/&gt;
&gt;   &lt;/os&gt;
&gt;   &lt;devices&gt;
&gt;     &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;
&gt;   &lt;/devices&gt;
&gt; &lt;/domain&gt;
&gt; 
&gt; ➜  ~ virsh define /tmp/usb.xml &amp;&amp; virsh dumpxml USB|grep usb
&gt; Domain 'USB' defined from /tmp/usb.xml
&gt; 
&gt;     &lt;controller type='usb' index='0' model='qemu-xhci'&gt;
&gt; 
&gt; 
&gt; ➜  ~ cat /tmp/usb-pc.xml
&gt; &lt;domain type="kvm"&gt;
&gt;   &lt;name&gt;USB&lt;/name&gt;
&gt;   &lt;uuid&gt;1a81d4ef-6537-4ae8-b257-8a15e0c0525f&lt;/uuid&gt;
&gt;   &lt;memory&gt;2097152&lt;/memory&gt;
&gt;   &lt;currentMemory&gt;2097152&lt;/currentMemory&gt;
&gt;   &lt;vcpu&gt;1&lt;/vcpu&gt;
&gt;   &lt;os&gt;
&gt;     &lt;type arch="x86_64" machine="pc"&gt;hvm&lt;/type&gt;
&gt;     &lt;boot dev="hd"/&gt;
&gt;   &lt;/os&gt;
&gt;   &lt;devices&gt;
&gt;     &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;
&gt;   &lt;/devices&gt;
&gt; &lt;/domain&gt;
&gt; 
&gt; ➜  ~ virsh define /tmp/usb-pc.xml &amp;&amp; virsh dumpxml USB|grep usb
&gt; Domain 'USB' defined from /tmp/usb-pc.xml
&gt; 
&gt;     &lt;controller type='usb' index='0' model='piix3-uhci'&gt;
&gt; 
&gt; And the default usb controller for q35 has been added since:
&gt; ed2049ea19 qemu: auto-add generic xhci rather than NEC xhci to Q35 domains
&gt; 
&gt; As I know, pc machine supports qemu-xhci as well.           Morever, the
&gt; performance of qemu-xhci is better than piix3-uhci. So why not update the
&gt; default usb controller of pc machine type to qemu-xhci? I think we can
&gt; improve it here.

A qemu-xhci controller can be added to any x86 machien type regardless
of the default, and most mgmt apps will do exactly that.


With regards,
Daniel
-- 
|: https://berrange.com      -o-    https://www.flickr.com/photos/dberrange :|
|: https://libvirt.org         -o-            https://fstop138.berrange.com :|
|: https://entangle-photo.org    -o-    https://www.instagram.com/dberrange :|

</body></email><email><emailId>20220706154341</emailId><senderName>Stan Cox</senderName><senderEmail>scox@redhat.com</senderEmail><timestampReceived>2022-07-06 15:43:41-0400</timestampReceived><subject>systemtap stapvirt tool</subject><body>

I am having a quandary with libvirt and am wondering if someone can shed 
some light.

Systemtap converts a probing and instrumentation language into a kernel 
module.  The module can optionally be run remotely via ssh or libvirt. 
The libvirt mechanism is not working (not yet sure of timing of 
regression)  The systemtap stap command pipes to a stapvirt command that 
is the libvirt interface.  The remote is running a stapsh tool that 
receives the requests.  The initial commands are sent and received okay 
(strace output on remote) but never receives the stap kernel module:

# local sent option data request
[pid 11959] read(3, "option data\n", 4096) = 12
# remote says OK
[pid 11959] write(3, "OK\n", 3)         = 3
[pid 11959] poll([{fd=3, events=POLLIN}, {fd=0, events=0}, {fd=0, 
events=0}], 3, -1) = 1 ([{fd=3, revents=POLLIN}])
[pid 11959] --- SIGIO {si_signo=SIGIO, si_code=SI_KERNEL} ---
[pid 11959] poll([{fd=3, events=POLLHUP}], 1, 0) = 0 (Timeout)
[pid 11959] rt_sigreturn({mask=[]})     = 1
# local sent file ... request to download the module
[pid 11959] read(3, "file 926928 stap_1f18b4b54e74602"..., 4096) = 58
# remote opens the module
[pid 11959] openat(AT_FDCWD, 
"stap_1f18b4b54e74602a0a1f0685f2f7333e_1006.ko", 
O_WRONLY|O_CREAT|O_TRUNC, 0666) = 4
# but never receives it
[pid 11959] read(3, "", 4096)           = 0


The local sets up callbacks for stdin, stdout, stream:
     ctxt.stdin_w = virEventAddHandle(STDIN_FILENO, 
VIR_EVENT_HANDLE_READABLE,
                                     stdin_event, &amp;ctxt, NULL);
  ...
     ctxt.stdout_w = virEventAddHandle(STDOUT_FILENO, 0,
                                       stdout_event, &amp;ctxt, NULL);
  ...
     virStreamEventAddCallback(ctxt.st, VIR_STREAM_EVENT_READABLE | 
VIR_EVENT_HANDLE_WRITABLE,
                                   stream_event, &amp;ctxt, NULL) &lt; 0)

Then starts an even loop
     while (!disconnect) {
         if (virEventRunDefaultImpl() != 0)
             break;
     }


stream_event is notified for the command requests, but is not notified 
for the kernel module chunks:

stdin_event excerpt:
         bytes_read = read(fd, ctxt-&gt;termbuf + ctxt-&gt;termbuf_off,
                               sizeof(ctxt-&gt;termbuf) - ctxt-&gt;termbuf_off);
  ...
         ctxt-&gt;termbuf_off += bytes_read;
  ...
     if (ctxt-&gt;termbuf_off) { // we have stuff to write to the stream
         virStreamEventUpdateCallback(ctxt-&gt;st, VIR_STREAM_EVENT_READABLE
                                              | VIR_STREAM_EVENT_WRITABLE);
     }

stream_event excerpt:

     if ((events &amp; VIR_STREAM_EVENT_READABLE)
             &amp;&amp; (ctxt-&gt;stbuf_off &lt; sizeof(ctxt-&gt;stbuf))) {
         int bytes_recv = virStreamRecv(st, ctxt-&gt;stbuf + ctxt-&gt;stbuf_off,
                                        sizeof(ctxt-&gt;stbuf) - 
ctxt-&gt;stbuf_off);

I notice
  https://libvirt.org/html/libvirt-libvirt-stream.html
has an example using virStreamSend.  Is that the preferred way to do the 
above?

</body></email><email><emailId>20220713105849</emailId><senderName>Han Han</senderName><senderEmail>hhan@redhat.com</senderEmail><timestampReceived>2022-07-13 10:58:49-0400</timestampReceived><subject>The default USB controller of pc machine type</subject><body>

Hello,
I found that the default USB controller for q35 machine type is qemu-xhci
while for pc it is piix3-uhci. Here are the results(on qemu-kvm-7.0.0
qemu-kvm-7.0.0):
➜  ~ cat /tmp/usb.xml
&lt;domain type="kvm"&gt;
  &lt;name&gt;USB&lt;/name&gt;
  &lt;uuid&gt;1a81d4ef-6537-4ae8-b257-8a15e0c0525f&lt;/uuid&gt;
  &lt;memory&gt;2097152&lt;/memory&gt;
  &lt;currentMemory&gt;2097152&lt;/currentMemory&gt;
  &lt;vcpu&gt;1&lt;/vcpu&gt;
  &lt;os&gt;
    &lt;type arch="x86_64" machine="q35"&gt;hvm&lt;/type&gt;
    &lt;boot dev="hd"/&gt;
  &lt;/os&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;
  &lt;/devices&gt;
&lt;/domain&gt;

➜  ~ virsh define /tmp/usb.xml &amp;&amp; virsh dumpxml USB|grep usb
Domain 'USB' defined from /tmp/usb.xml

    &lt;controller type='usb' index='0' model='qemu-xhci'&gt;


➜  ~ cat /tmp/usb-pc.xml
&lt;domain type="kvm"&gt;
  &lt;name&gt;USB&lt;/name&gt;
  &lt;uuid&gt;1a81d4ef-6537-4ae8-b257-8a15e0c0525f&lt;/uuid&gt;
  &lt;memory&gt;2097152&lt;/memory&gt;
  &lt;currentMemory&gt;2097152&lt;/currentMemory&gt;
  &lt;vcpu&gt;1&lt;/vcpu&gt;
  &lt;os&gt;
    &lt;type arch="x86_64" machine="pc"&gt;hvm&lt;/type&gt;
    &lt;boot dev="hd"/&gt;
  &lt;/os&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;
  &lt;/devices&gt;
&lt;/domain&gt;

➜  ~ virsh define /tmp/usb-pc.xml &amp;&amp; virsh dumpxml USB|grep usb
Domain 'USB' defined from /tmp/usb-pc.xml

    &lt;controller type='usb' index='0' model='piix3-uhci'&gt;

And the default usb controller for q35 has been added since:
ed2049ea19 qemu: auto-add generic xhci rather than NEC xhci to Q35 domains

As I know, pc machine supports qemu-xhci as well.           Morever, the
performance of qemu-xhci is better than piix3-uhci. So why not update the
default usb controller of pc machine type to qemu-xhci? I think we can
improve it here.

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;&lt;div&gt;Hello,&lt;/div&gt;&lt;div&gt;I found that the default USB controller for q35 \
machine type is qemu-xhci while for pc it is piix3-uhci. Here are the results(on \
qemu-kvm-7.0.0 qemu-kvm-7.0.0):&lt;/div&gt;&lt;div&gt;➜   ~ cat /tmp/usb.xml &lt;br&gt;&lt;domain \
type="kvm"&gt;&lt;br&gt;   &lt;name&gt;USB&lt;/name&gt;&lt;br&gt;   \
&lt;uuid&gt;1a81d4ef-6537-4ae8-b257-8a15e0c0525f&lt;/uuid&gt;&lt;br&gt;   \
&lt;memory&gt;2097152&lt;/memory&gt;&lt;br&gt;   \
&lt;currentMemory&gt;2097152&lt;/currentMemory&gt;&lt;br&gt;   \
&lt;vcpu&gt;1&lt;/vcpu&gt;&lt;br&gt;   &lt;os&gt;&lt;br&gt;      &lt;type arch="x86_64" \
machine="q35"&gt;hvm&lt;/type&gt;&lt;br&gt;      &lt;boot \
dev="hd"/&gt;&lt;br&gt;   &lt;/os&gt;&lt;br&gt;   &lt;devices&gt;&lt;br&gt;      \
&lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;&lt;br&gt;   \
&lt;/devices&gt;&lt;br&gt;&lt;/domain&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;➜   ~ virsh define \
/tmp/usb.xml &amp;&amp; virsh dumpxml USB|grep usb&lt;br&gt;Domain 'USB' defined \
from /tmp/usb.xml&lt;br&gt;&lt;br&gt;&lt;div&gt;      &lt;controller type='usb' \
index='0' model='qemu-xhci'&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;➜ \
~ cat /tmp/usb-pc.xml &lt;br&gt;&lt;domain type="kvm"&gt;&lt;br&gt;   \
&lt;name&gt;USB&lt;/name&gt;&lt;br&gt;   \
&lt;uuid&gt;1a81d4ef-6537-4ae8-b257-8a15e0c0525f&lt;/uuid&gt;&lt;br&gt;   \
&lt;memory&gt;2097152&lt;/memory&gt;&lt;br&gt;   \
&lt;currentMemory&gt;2097152&lt;/currentMemory&gt;&lt;br&gt;   \
&lt;vcpu&gt;1&lt;/vcpu&gt;&lt;br&gt;   &lt;os&gt;&lt;br&gt;      &lt;type arch="x86_64" \
machine="pc"&gt;hvm&lt;/type&gt;&lt;br&gt;      &lt;boot \
dev="hd"/&gt;&lt;br&gt;   &lt;/os&gt;&lt;br&gt;   &lt;devices&gt;&lt;br&gt;      \
&lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;&lt;br&gt;   \
&lt;/devices&gt;&lt;br&gt;&lt;/domain&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;➜   ~ virsh define \
/tmp/usb-pc.xml &amp;&amp; virsh dumpxml USB|grep usb &lt;br&gt;Domain 'USB' \
defined from /tmp/usb-pc.xml&lt;br&gt;&lt;br&gt;      &lt;controller type='usb' \
index='0' model='piix3-uhci'&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;And the \
default usb controller for q35 has been added since:&lt;/div&gt;&lt;div&gt;ed2049ea19 qemu: \
auto-add generic xhci rather than NEC xhci to Q35 domains&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;As \
I know, pc machine supports qemu-xhci as well.                     Morever, the \
performance of qemu-xhci is better than piix3-uhci. So why not update the default usb \
controller of pc machine type to qemu-xhci? I think we can improve it \
here.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220706162614</emailId><senderName>Daniel =?utf-8?B?UC4gQmVycmFuZ8Op?=</senderName><senderEmail>berrange@redhat.com</senderEmail><timestampReceived>2022-07-06 16:26:14-0400</timestampReceived><subject>Re: systemtap stapvirt tool</subject><body>

On Wed, Jul 06, 2022 at 11:43:41AM -0400, Stan Cox wrote:
&gt; I am having a quandary with libvirt and am wondering if someone can shed
&gt; some light.
&gt; 
&gt; Systemtap converts a probing and instrumentation language into a kernel
&gt; module.  The module can optionally be run remotely via ssh or libvirt. The
&gt; libvirt mechanism is not working (not yet sure of timing of regression)  The
&gt; systemtap stap command pipes to a stapvirt command that is the libvirt
&gt; interface.  The remote is running a stapsh tool that receives the requests.
&gt; The initial commands are sent and received okay (strace output on remote)
&gt; but never receives the stap kernel module:
&gt; 
&gt; # local sent option data request
&gt; [pid 11959] read(3, "option data\n", 4096) = 12
&gt; # remote says OK
&gt; [pid 11959] write(3, "OK\n", 3)         = 3
&gt; [pid 11959] poll([{fd=3, events=POLLIN}, {fd=0, events=0}, {fd=0,
&gt; events=0}], 3, -1) = 1 ([{fd=3, revents=POLLIN}])
&gt; [pid 11959] --- SIGIO {si_signo=SIGIO, si_code=SI_KERNEL} ---
&gt; [pid 11959] poll([{fd=3, events=POLLHUP}], 1, 0) = 0 (Timeout)
&gt; [pid 11959] rt_sigreturn({mask=[]})     = 1
&gt; # local sent file ... request to download the module
&gt; [pid 11959] read(3, "file 926928 stap_1f18b4b54e74602"..., 4096) = 58
&gt; # remote opens the module
&gt; [pid 11959] openat(AT_FDCWD,
&gt; "stap_1f18b4b54e74602a0a1f0685f2f7333e_1006.ko", O_WRONLY|O_CREAT|O_TRUNC,
&gt; 0666) = 4
&gt; # but never receives it
&gt; [pid 11959] read(3, "", 4096)           = 0
&gt; 
&gt; 
&gt; The local sets up callbacks for stdin, stdout, stream:
&gt;     ctxt.stdin_w = virEventAddHandle(STDIN_FILENO,
&gt; VIR_EVENT_HANDLE_READABLE,
&gt;                                     stdin_event, &amp;ctxt, NULL);
&gt;  ...
&gt;     ctxt.stdout_w = virEventAddHandle(STDOUT_FILENO, 0,
&gt;                                       stdout_event, &amp;ctxt, NULL);
&gt;  ...
&gt;     virStreamEventAddCallback(ctxt.st, VIR_STREAM_EVENT_READABLE |
&gt; VIR_EVENT_HANDLE_WRITABLE,
&gt;                                   stream_event, &amp;ctxt, NULL) &lt; 0)
&gt; 
&gt; Then starts an even loop
&gt;     while (!disconnect) {
&gt;         if (virEventRunDefaultImpl() != 0)
&gt;             break;
&gt;     }
&gt; 
&gt; 
&gt; stream_event is notified for the command requests, but is not notified for
&gt; the kernel module chunks:
&gt; 
&gt; stdin_event excerpt:
&gt;         bytes_read = read(fd, ctxt-&gt;termbuf + ctxt-&gt;termbuf_off,
&gt;                               sizeof(ctxt-&gt;termbuf) - ctxt-&gt;termbuf_off);
&gt;  ...
&gt;         ctxt-&gt;termbuf_off += bytes_read;
&gt;  ...
&gt;     if (ctxt-&gt;termbuf_off) { // we have stuff to write to the stream
&gt;         virStreamEventUpdateCallback(ctxt-&gt;st, VIR_STREAM_EVENT_READABLE
&gt;                                              | VIR_STREAM_EVENT_WRITABLE);
&gt;     }
&gt; 
&gt; stream_event excerpt:
&gt; 
&gt;     if ((events &amp; VIR_STREAM_EVENT_READABLE)
&gt;             &amp;&amp; (ctxt-&gt;stbuf_off &lt; sizeof(ctxt-&gt;stbuf))) {
&gt;         int bytes_recv = virStreamRecv(st, ctxt-&gt;stbuf + ctxt-&gt;stbuf_off,
&gt;                                        sizeof(ctxt-&gt;stbuf) -
&gt; ctxt-&gt;stbuf_off);
&gt; 
&gt; I notice
&gt;  https://libvirt.org/html/libvirt-libvirt-stream.html
&gt; has an example using virStreamSend.  Is that the preferred way to do the
&gt; above?

The example is fairly simplistic and wouldn't suit your need where
you have interleaved bi-directional I/O

The virsh console code is likely the best matching example that we
know is pretty reliable

  https://gitlab.com/libvirt/libvirt/-/blob/master/tools/virsh-console.c

With regards,
Daniel
-- 
|: https://berrange.com      -o-    https://www.flickr.com/photos/dberrange :|
|: https://libvirt.org         -o-            https://fstop138.berrange.com :|
|: https://entangle-photo.org    -o-    https://www.instagram.com/dberrange :|

</body></email><email><emailId>20220706212532</emailId><senderName>Stan Cox</senderName><senderEmail>scox@redhat.com</senderEmail><timestampReceived>2022-07-06 21:25:32-0400</timestampReceived><subject>Re: systemtap stapvirt tool</subject><body>

stapvirt seems to have a quite similar layout to virsh-console.  All is 
fine for short packets:

1. Send file command to remote, stdin_event gets event
stdin_event:1000 fd 0 events 0x1 stbuf_off 0 stbuf 0x7ffd0e99f848 
termbuf_off 58 buf "file 926928 stap_1f18b4b"
2. stream_event gets event
stream_event:1067 events 0x2 stbuf_off 0 stbuf 0x7ffd0e99f848 buf "file 
926928 stap_1f18b4b"

but stream_event is not triggered when kernel module is being sent in chunks

3. stdin_event reads first chunk of kernel module
    (which does virStreamEventUpdateCallback when it notices buffer 
contents)
stdin_event:1000 fd 0 events 0x1 stbuf_off 0 stbuf 0x7ffd0e99f848 
termbuf_off 1024 buf "^?ELF^B^A^A"
4. but stream_event is never triggered

What triggers stream_event to be called such that the 2 case would be 
triggered but not the 4 case?



</body></email><email><emailId>20220707080714</emailId><senderName>Daniel =?utf-8?B?UC4gQmVycmFuZ8Op?=</senderName><senderEmail>berrange@redhat.com</senderEmail><timestampReceived>2022-07-07 08:07:14-0400</timestampReceived><subject>Re: systemtap stapvirt tool</subject><body>

On Wed, Jul 06, 2022 at 05:25:32PM -0400, Stan Cox wrote:
&gt; stapvirt seems to have a quite similar layout to virsh-console.  All is fine
&gt; for short packets:
&gt; 
&gt; 1. Send file command to remote, stdin_event gets event
&gt; stdin_event:1000 fd 0 events 0x1 stbuf_off 0 stbuf 0x7ffd0e99f848
&gt; termbuf_off 58 buf "file 926928 stap_1f18b4b"
&gt; 2. stream_event gets event
&gt; stream_event:1067 events 0x2 stbuf_off 0 stbuf 0x7ffd0e99f848 buf "file
&gt; 926928 stap_1f18b4b"
&gt; 
&gt; but stream_event is not triggered when kernel module is being sent in chunks
&gt; 
&gt; 3. stdin_event reads first chunk of kernel module
&gt;    (which does virStreamEventUpdateCallback when it notices buffer contents)
&gt; stdin_event:1000 fd 0 events 0x1 stbuf_off 0 stbuf 0x7ffd0e99f848
&gt; termbuf_off 1024 buf "^?ELF^B^A^A"
&gt; 4. but stream_event is never triggered
&gt; 
&gt; What triggers stream_event to be called such that the 2 case would be
&gt; triggered but not the 4 case?

I don't know - as best I can tell all your logic matches what is in
virsh console.

What libvirt version are you testing with, and have you tried a differnt
version ?

With regards,
Daniel
-- 
|: https://berrange.com      -o-    https://www.flickr.com/photos/dberrange :|
|: https://libvirt.org         -o-            https://fstop138.berrange.com :|
|: https://entangle-photo.org    -o-    https://www.instagram.com/dberrange :|

</body></email><email><emailId>20220104030635</emailId><senderName>Tom Ammon</senderName><senderEmail>thomasammon@gmail.com</senderEmail><timestampReceived>2022-01-04 03:06:35-0400</timestampReceived><subject>simulating multiple hypervisors with the test driver</subject><body>

Hello,

I'm working on a python application that will manage multiple remote
libvirt hypervisors. I've been using the test:///default uri for
single-hypervisor tests, and it works great.

I'd like to simulate connecting to two different remote hypervisors,
however, in my testing so far it appears that multiple connections to the
test:///default uri just look like different connections to the same
hypervisor. Here's what I tried :

conn_one = libvirt.open('test:///default')
&lt;build and start some domains&gt;
one_vms = conn_one.listAllDomains(0)
for x in one_vms:
    print(f"The vm in set one is {x.name()}")

&lt;get list of all the domains I just built&gt;
conn_two = libvirt.open('test:///default')
&lt;build and start some different domains&gt;
two_vms = conn_two.listAllDomains(0)
for z in two_vms:
    print(f"The vm in set one is {z.name()}")

&lt;get list of ALL domains including those created with conn_one, not just
those created using the conn_two instance&gt;

What I would like is to be able to spin up two completely independent
instances of the test driver so that it can simulate two different
hypervisors/instances of libvirtd.

Is that possible?

Thanks,
Tom


-- 
-----------------------------------------------------------------------------
Tom Ammon
M: (737) 400-9042
thomasammon@gmail.com
-----------------------------------------------------------------------------

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;Hello,  &lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I'm working on a python application \
that will manage multiple remote libvirt hypervisors. I've been using the \
test:///default uri for single-hypervisor tests, and it works great.  \
&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I'd like to simulate connecting to two different remote \
hypervisors, however, in my testing so far it appears that multiple connections to \
the test:///default uri just look like different connections to the same hypervisor. \
Here's what I tried :&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;conn_one = \
libvirt.open('test:///default')&lt;br&gt;&lt;div&gt;&lt;build and start some \
domains&gt;&lt;/div&gt;&lt;div&gt;one_vms = conn_one.listAllDomains(0)&lt;br&gt;&lt;/div&gt;&lt;div&gt;for x in \
one_vms:&lt;br&gt;      print(f"The vm in set one is {&lt;a \
href="http://x.name"&gt;x.name&lt;/a&gt;()}")&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;get list of \
all the domains I just built&gt;&lt;/div&gt;&lt;div&gt;conn_two = \
libvirt.open('test:///default')&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;build and start some \
different domains&gt;&lt;/div&gt;&lt;div&gt;two_vms = conn_two.listAllDomains(0)&lt;br&gt;for z in \
two_vms:&lt;br&gt;      print(f"The vm in set one is {&lt;a \
href="http://z.name"&gt;z.name&lt;/a&gt;()}")&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;get list \
of ALL domains including those created with conn_one, not just those created using \
the conn_two instance&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;What I would like is to be able to \
spin up two completely independent instances of the test driver so that it can \
simulate two different hypervisors/instances of libvirtd.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Is \
that possible?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks,  \
&lt;/div&gt;&lt;div&gt;Tom&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;-- &lt;br&gt;&lt;div dir="ltr" \
class="gmail_signature" data-smartmail="gmail_signature"&gt;&lt;div dir="ltr"&gt;&lt;div&gt;&lt;div \
dir="ltr"&gt;-----------------------------------------------------------------------------&lt;br&gt;Tom \
Ammon&lt;br&gt;M: (737) 400-9042&lt;br&gt;&lt;a href="mailto:thomasammon@gmail.com" \
target="_blank"&gt;thomasammon@gmail.com&lt;/a&gt;&lt;br&gt;-----------------------------------------------------------------------------&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;




</body></email><email><emailId>20220201142755</emailId><senderName>"M, Shivakumar"</senderName><senderEmail>shivakumar.m@intel.com</senderEmail><timestampReceived>2022-02-01 14:27:55-0400</timestampReceived><subject>udmabuf error with libvirt + QEMU</subject><body>

[Attachment #2 (multipart/alternative)]


Hi,

We are seeing an issue with udambuf, where it says "open /dev/udmabuf: No such file \
or directory " even if the device exits. This issue particularly we are seeing with \
libvirt. When we run the QEMU args on the command line, everything works as expected. \
It seems to be some permission issue when we use the Libvirt, please help us on \
resolving this.

[cid:image001.png@01D817A5.0151F260]

Libvirt Version:  6.0.0
Host: Ubuntu 21.04

QEMU commands:

qemu-system-x86_64 \

-enable-kvm \

-smp cores=4,threads=2,sockets=1 \

-m 4096 \

-name win-vm-0 \

-cpu host \

-drive id=windows_drive,if=virtio,file=/win10_enterprise.qcow2,format=qcow2,cache=none \
\

-device vfio-pci,host=0000:00:02.2 \

-device e1000,netdev=net0,mac=00:a1:00:00:00:10 \

-netdev user,id=net0,ipv6=off,hostfwd=tcp::1111-:22,hostfwd=tcp::3389-:3389 \

-monitor tcp:127.0.0.1:11111,server,nowait \

-rtc base=localtime \

-usb \

-device usb-tablet \

-device usb-kbd \

-device usb-mouse \

-device virtio-vga,blob=true \

-display gtk,gl=on \

-object memory-backend-memfd,id=mem1,hugetlb=off,size=4096M \
-machine memory-backend=mem1

Libvirt XML:
&lt;?xml version="1.0"?&gt;
&lt;domain xmlns:qemu=http://libvirt.org/schemas/domain/qemu/1.0 type="kvm"&gt;
  &lt;name&gt;win-vm-0&lt;/name&gt;
  &lt;memory unit="KiB"&gt;4194304&lt;/memory&gt;
  &lt;currentMemory unit="KiB"&gt;4194304&lt;/currentMemory&gt;
  &lt;memoryBacking supported="yes"&gt;
    &lt;source type="memfd"/&gt;
  &lt;/memoryBacking&gt;
  &lt;vcpu&gt;6&lt;/vcpu&gt;
  &lt;os&gt;
    &lt;type arch="x86_64" machine="pc"&gt;hvm&lt;/type&gt;
    &lt;boot dev="hd"/&gt;
    &lt;boot dev="cdrom"/&gt;
  &lt;/os&gt;
  &lt;features&gt;
    &lt;acpi/&gt;
    &lt;apic/&gt;
    &lt;hyperv&gt;
      &lt;relaxed state="on"/&gt;
      &lt;vapic state="on"/&gt;
      &lt;spinlocks state="on" retries="8191"/&gt;
    &lt;/hyperv&gt;
    &lt;vmport state="off"/&gt;
  &lt;/features&gt;
  &lt;cpu mode="host-model"&gt;
    &lt;model fallback="forbid"/&gt;
  &lt;/cpu&gt;
  &lt;clock offset="utc"&gt;
 &lt;/clock&gt;
  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
  &lt;on_crash&gt;destroy&lt;/on_crash&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt;
    &lt;disk type="file" device="disk"&gt;
      &lt;driver name="qemu" type="qcow2"/&gt;
      &lt;source file="/win10_enterprise.qcow2" index="1"/&gt;
      &lt;backingStore/&gt;
      &lt;target dev="sda" bus="sata"/&gt;
      &lt;alias name="sata0-0-0"/&gt;
      &lt;address type="drive" controller="0" bus="0" target="0" unit="0"/&gt;
    &lt;/disk&gt;
    &lt;interface type="bridge"&gt;
      &lt;source bridge="br0"/&gt;
      &lt;model type="virtio"/&gt;
    &lt;/interface&gt;
    &lt;serial type="pty"&gt;
      &lt;target port="0"/&gt;
      &lt;target type="serial" port="0"&gt;
        &lt;/target&gt;
      &lt;alias name="serial0"/&gt;
    &lt;/serial&gt;
    &lt;console type="pty"&gt;
      &lt;target type="serial" port="0"/&gt;
      &lt;alias name="serial0"/&gt;
    &lt;/console&gt;
    &lt;hostdev mode="subsystem" type="pci" managed="yes"&gt;
      &lt;driver name="vfio"/&gt;
      &lt;source&gt;
        &lt;address domain="0x0000" bus="0x00" slot="0x02" function="0x02"/&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
  &lt;/devices&gt;
  &lt;qemu:commandline&gt;
    &lt;qemu:arg value="-device"/&gt;
    &lt;qemu:arg value="virtio-vga,blob=true"/&gt;
    &lt;qemu:arg value="-display"/&gt;
    &lt;qemu:arg value="gtk,gl=on"/&gt;
    &lt;qemu:env name="DISPLAY" value=":1.0"/&gt;
  &lt;/qemu:commandline&gt;
&lt;/domain&gt;


Thanks,
Shiv


[Attachment #5 (text/html)]

&lt;html xmlns:v="urn:schemas-microsoft-com:vml" \
xmlns:o="urn:schemas-microsoft-com:office:office" \
xmlns:w="urn:schemas-microsoft-com:office:word" \
xmlns:m="http://schemas.microsoft.com/office/2004/12/omml" \
xmlns="http://www.w3.org/TR/REC-html40"&gt; &lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=us-ascii"&gt;
&lt;meta name="Generator" content="Microsoft Word 15 (filtered medium)"&gt;
&lt;!--[if !mso]&gt;&lt;style&gt;v\:* {behavior:url(#default#VML);}
o\:* {behavior:url(#default#VML);}
w\:* {behavior:url(#default#VML);}
.shape {behavior:url(#default#VML);}
&lt;/style&gt;&lt;![endif]--&gt;&lt;style&gt;&lt;!--
/* Font Definitions */
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
/* Style Definitions */
p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin:0in;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
a:link, span.MsoHyperlink
	{mso-style-priority:99;
	color:#0563C1;
	text-decoration:underline;}
p.MsoPlainText, li.MsoPlainText, div.MsoPlainText
	{mso-style-priority:99;
	mso-style-link:"Plain Text Char";
	margin:0in;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
span.EmailStyle17
	{mso-style-type:personal-compose;
	font-family:"Calibri",sans-serif;
	color:windowtext;}
span.PlainTextChar
	{mso-style-name:"Plain Text Char";
	mso-style-priority:99;
	mso-style-link:"Plain Text";
	font-family:"Calibri",sans-serif;}
.MsoChpDefault
	{mso-style-type:export-only;
	font-family:"Calibri",sans-serif;}
@page WordSection1
	{size:8.5in 11.0in;
	margin:1.0in 1.0in 1.0in 1.0in;}
div.WordSection1
	{page:WordSection1;}
--&gt;&lt;/style&gt;&lt;!--[if gte mso 9]&gt;&lt;xml&gt;
&lt;o:shapedefaults v:ext="edit" spidmax="1026" /&gt;
&lt;/xml&gt;&lt;![endif]--&gt;&lt;!--[if gte mso 9]&gt;&lt;xml&gt;
&lt;o:shapelayout v:ext="edit"&gt;
&lt;o:idmap v:ext="edit" data="1" /&gt;
&lt;/o:shapelayout&gt;&lt;/xml&gt;&lt;![endif]--&gt;
&lt;/head&gt;
&lt;body lang="EN-US" link="#0563C1" vlink="#954F72" style="word-wrap:break-word"&gt;
&lt;div class="WordSection1"&gt;
&lt;p class="MsoNormal"&gt;Hi,&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;We are seeing an issue with udambuf, where it says \
&lt;b&gt;&lt;i&gt;“open /dev/udmabuf: No such file or directory “&lt;/i&gt;&lt;/b&gt; even if the \
device exits. This issue particularly we are seeing with libvirt. When we run the \
QEMU args on the command line,  everything works as expected. &lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;It seems to be some permission issue when we use the Libvirt, \
please help us on resolving this.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;img width="1194" \
height="276" style="width:12.4375in;height:2.875in" id="Picture_x0020_1" \
src="cid:image001.png@01D817A5.0151F260"&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;b&gt;Libvirt Version: \
 6.0.0 &lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;b&gt;Host: Ubuntu 21.04 \
 &lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;b&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;&lt;b&gt;QEMU commands:&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt;
&lt;table class="MsoTableGrid" border="1" cellspacing="0" cellpadding="0" \
style="border-collapse:collapse;border:none"&gt; &lt;tbody&gt;
&lt;tr&gt;
&lt;td width="623" valign="top" style="width:467.5pt;border:solid windowtext \
1.0pt;padding:0in 5.4pt 0in 5.4pt"&gt; &lt;p class="MsoPlainText"&gt;&lt;b&gt;&lt;i&gt;&lt;span \
style="color:#0070C0"&gt;qemu-system-x86_64 \&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/i&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoPlainText"&gt;&lt;b&gt;&lt;i&gt;&lt;span style="color:#0070C0"&gt;-enable-kvm \
\&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/i&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoPlainText"&gt;&lt;b&gt;&lt;i&gt;&lt;span \
style="color:#0070C0"&gt;-smp cores=4,threads=2,sockets=1 \
\&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/i&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoPlainText"&gt;&lt;b&gt;&lt;i&gt;&lt;span \
style="color:#0070C0"&gt;-m 4096 \&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/i&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoPlainText"&gt;&lt;b&gt;&lt;i&gt;&lt;span style="color:#0070C0"&gt;-name win-vm-0 \
\&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/i&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoPlainText"&gt;&lt;b&gt;&lt;i&gt;&lt;span \
style="color:#0070C0"&gt;-cpu host \&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/i&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoPlainText"&gt;&lt;b&gt;&lt;i&gt;&lt;span style="color:#0070C0"&gt;-drive \
id=windows_drive,if=virtio,file=/win10_enterprise.qcow2,format=qcow2,cache=none \
\&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/i&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoPlainText"&gt;&lt;b&gt;&lt;i&gt;&lt;span \
style="color:#0070C0"&gt;-device vfio-pci,host=0000:00:02.2 \
\&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/i&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoPlainText"&gt;&lt;b&gt;&lt;i&gt;&lt;span \
style="color:#0070C0"&gt;-device e1000,netdev=net0,mac=00:a1:00:00:00:10 \
\&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/i&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoPlainText"&gt;&lt;b&gt;&lt;i&gt;&lt;span \
style="color:#0070C0"&gt;-netdev \
user,id=net0,ipv6=off,hostfwd=tcp::1111-:22,hostfwd=tcp::3389-:3389 \
\&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/i&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoPlainText"&gt;&lt;b&gt;&lt;i&gt;&lt;span \
style="color:#0070C0"&gt;-monitor tcp:127.0.0.1:11111,server,nowait \
\&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/i&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoPlainText"&gt;&lt;b&gt;&lt;i&gt;&lt;span \
style="color:#0070C0"&gt;-rtc base=localtime \&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/i&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoPlainText"&gt;&lt;b&gt;&lt;i&gt;&lt;span style="color:#0070C0"&gt;-usb \
\&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/i&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoPlainText"&gt;&lt;b&gt;&lt;i&gt;&lt;span \
style="color:#0070C0"&gt;-device usb-tablet \&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/i&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoPlainText"&gt;&lt;b&gt;&lt;i&gt;&lt;span style="color:#0070C0"&gt;-device usb-kbd \
\&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/i&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoPlainText"&gt;&lt;b&gt;&lt;i&gt;&lt;span \
style="color:#0070C0"&gt;-device usb-mouse \&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/i&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoPlainText"&gt;&lt;b&gt;&lt;i&gt;&lt;span style="color:#0070C0"&gt;-device virtio-vga,blob=true \
\&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/i&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoPlainText"&gt;&lt;b&gt;&lt;i&gt;&lt;span \
style="color:#0070C0"&gt;-display gtk,gl=on \&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/i&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoPlainText"&gt;&lt;b&gt;&lt;i&gt;&lt;span style="color:#0070C0"&gt;-object \
memory-backend-memfd,id=mem1,hugetlb=off,size=4096M \&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/i&gt;&lt;/b&gt;&lt;/p&gt; \
&lt;p class="MsoNormal"&gt;&lt;b&gt;&lt;i&gt;&lt;span style="color:#0070C0"&gt;-machine \
memory-backend=mem1&lt;/span&gt;&lt;/i&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p class="MsoNormal"&gt;&lt;b&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;&lt;b&gt;Libvirt XML:&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt;
&lt;table class="MsoTableGrid" border="1" cellspacing="0" cellpadding="0" \
style="border-collapse:collapse;border:none"&gt; &lt;tbody&gt;
&lt;tr&gt;
&lt;td width="623" valign="top" style="width:467.5pt;border:solid windowtext \
1.0pt;padding:0in 5.4pt 0in 5.4pt"&gt; &lt;p class="MsoNormal"&gt;&lt;b&gt;&lt;?xml \
version="1.0"?&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;b&gt;&lt;domain \
xmlns:qemu=&lt;a href="http://libvirt.org/schemas/domain/qemu/1.0"&gt;http://libvirt.org/schemas/domain/qemu/1.0&lt;/a&gt; \
type="kvm"&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;b&gt;  \
&lt;name&gt;win-vm-0&lt;/name&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;b&gt;  \
&lt;memory unit="KiB"&gt;4194304&lt;/memory&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;  &lt;currentMemory \
unit="KiB"&gt;4194304&lt;/currentMemory&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;  &lt;memoryBacking \
supported="yes"&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;    &lt;source \
type="memfd"/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;b&gt;  \
&lt;/memoryBacking&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;b&gt;  \
&lt;vcpu&gt;6&lt;/vcpu&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;b&gt;  \
&lt;os&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;b&gt;    &lt;type \
arch="x86_64" machine="pc"&gt;hvm&lt;/type&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; \
&lt;p class="MsoNormal"&gt;&lt;b&gt;    &lt;boot \
dev="hd"/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;b&gt;    \
&lt;boot dev="cdrom"/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;b&gt;  \
&lt;/os&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;b&gt;  \
&lt;features&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;b&gt;    \
&lt;acpi/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;b&gt;    \
&lt;apic/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;b&gt;    \
&lt;hyperv&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;      &lt;relaxed \
state="on"/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;      &lt;vapic \
state="on"/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;      &lt;spinlocks \
state="on" retries="8191"/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;    &lt;/hyperv&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;    &lt;vmport \
state="off"/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;b&gt;  \
&lt;/features&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;b&gt;  &lt;cpu \
mode="host-model"&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;    &lt;model \
fallback="forbid"/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;b&gt;  \
&lt;/cpu&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;b&gt;  &lt;clock \
offset="utc"&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt; &lt;/clock&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;  \
&lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;  \
&lt;on_reboot&gt;restart&lt;/on_reboot&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;  \
&lt;on_crash&gt;destroy&lt;/on_crash&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;  &lt;devices&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;    \
&lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;    &lt;disk type="file" \
device="disk"&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;      &lt;driver name="qemu" \
type="qcow2"/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;b&gt;  \
    &lt;source file="/win10_enterprise.qcow2" \
index="1"/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;      \
&lt;backingStore/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;      &lt;target dev="sda" \
bus="sata"/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;      &lt;alias \
name="sata0-0-0"/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;      &lt;address \
type="drive" controller="0" bus="0" \
target="0" unit="0"/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;    &lt;/disk&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;    &lt;interface \
type="bridge"&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;      &lt;source \
bridge="br0"/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;      &lt;model \
type="virtio"/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;    &lt;/interface&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;    &lt;serial \
type="pty"&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;      &lt;target \
port="0"/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;      &lt;target \
type="serial" port="0"&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;        \
&lt;/target&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;      &lt;alias \
name="serial0"/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;    &lt;/serial&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;    &lt;console \
type="pty"&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;      &lt;target \
type="serial" port="0"/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;      &lt;alias \
name="serial0"/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;    &lt;/console&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;    &lt;hostdev mode="subsystem" \
type="pci" managed="yes"&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;      &lt;driver \
name="vfio"/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;      &lt;source&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; \
&lt;p class="MsoNormal"&gt;&lt;b&gt;        &lt;address \
domain="0x0000" bus="0x00" slot="0x02" \
function="0x02"/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;      \
&lt;/source&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;b&gt;    \
&lt;/hostdev&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;b&gt;  \
&lt;/devices&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;b&gt;  \
&lt;qemu:commandline&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;    &lt;qemu:arg \
value="-device"/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;    &lt;qemu:arg \
value="virtio-vga,blob=true"/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;    &lt;qemu:arg \
value="-display"/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;    &lt;qemu:arg \
value="gtk,gl=on"/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;    &lt;qemu:env name="DISPLAY" \
value=":1.0"/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;b&gt;  \
&lt;/qemu:commandline&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;b&gt;&lt;/domain&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p class="MsoNormal"&gt;&lt;b&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/b&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;Thanks,&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;Shiv&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;


["image001.png" (image/png)]

</body></email><email><emailId>20220222150050</emailId><senderName>Дмитрий</senderName><senderEmail>d.yakovets@maxiplace.ru</senderEmail><timestampReceived>2022-02-22 15:00:50-0400</timestampReceived><subject>libvirtd file descriptors leaking</subject><body>

Hello, 

## SETUP 

CentOS 8 Stream 
libguestfs-tools.noarch 1:1.40.2-24.el8.plesk 
libvirt.x86_64 7.6.0-6.el8s 

## ISSUE REPRODUCTION 

lsof -p $(cat /run/libvirtd.pid) | wc -l # here we have N open file descriptors by libvirtd 

guestfish --ro -d domain1 
run # here we have N+1 open file descriptors by libvirtd 
Ctrl+D # and we still have N+1 open file descriptors by libvirtd 

virt-df -d domain1 # after completion we still having N++ open file descriptors by libvirtd 

To fix this issue i am force to restart libvirtd 


[Attachment #3 (text/html)]

&lt;html&gt;&lt;body&gt;&lt;div style="font-family: arial, helvetica, sans-serif; font-size: 12pt; \
color: #000000"&gt;&lt;div data-marker="__QUOTED_TEXT__"&gt;&lt;div style="font-family:'arial' , \
'helvetica' , sans-serif;font-size:12pt;color:#000000"&gt;&lt;div&gt;&lt;div \
style="font-family:'arial' , 'helvetica' , \
sans-serif;font-size:12pt;color:#000000"&gt;&lt;div&gt;&lt;div&gt;Hello,&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;## \
SETUP&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;CentOS 8 \
Stream&lt;br&gt;&lt;/div&gt;&lt;div&gt;libguestfs-tools.noarch        \
              &amp;n \
bsp;                    \
1:1.40.2-24.el8.plesk&lt;br&gt;&lt;/div&gt;&lt;div&gt;libvirt.x86_64       \
              &amp;n \
bsp;                          \
7.6.0-6.el8s&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;## ISSUE REPRODUCTION&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;lsof -p $(cat \
/run/libvirtd.pid) | wc -l  # here we have N open file descriptors by \
libvirtd&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;guestfish --ro -d domain1&lt;br&gt;&lt;/div&gt;&lt;div&gt;run  # here \
we have N+1 open file descriptors by libvirtd&lt;br&gt;&lt;/div&gt;&lt;div&gt;Ctrl+D  # and we \
still have N+1 open file descriptors by libvirtd&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;virt-df -d \
domain1  # after completion we still having N++ open file descriptors by \
libvirtd&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;To fix this issue i am force to restart \
libvirtd&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;



</body></email><email><emailId>20220401082102</emailId><senderName>Peter Krempa</senderName><senderEmail>pkrempa@redhat.com</senderEmail><timestampReceived>2022-04-01 08:21:02-0400</timestampReceived><subject>Re: Debugging hanging libvirt</subject><body>

On Wed, Mar 30, 2022 at 01:11:50 +0000, Tobias Hofmann (tohofman) wrote:
&gt; Hello all,
&gt; 
&gt; I have a system with one VM running. After some time the VM needs to be temporarily \
&gt; stopped and started again. This start operation fails and from that point on any \
&gt; virsh command is hanging and does not execute. This issue is reproducible and I \
&gt; have already figured out that restarting libvirtd resolves this issue. However, I'm \
&gt; now trying to understand why it's getting stuck in the first place. 
&gt; I try not to get too much into detail because I think this would be more confusing \
&gt; than it would actually help to understand the problem. In general, I'm wondering \
&gt; what approach you should follow to debug why libvirt gets stuck. Online I've read \
&gt; that you should run this command: `# gdb -batch -p $(pidof libvirtd) -ex 't a a bt \
&gt; f'`. I've run that command and attached the output to this mail. However, I have to \
&gt; admit that I have no idea what to do with it.

So from the backtrace:


Thread 18 (Thread 0x7f58bcf3e700 (LWP 19010)):
#0  0x00007f58c9e3a9f5 in pthread_cond_wait@@GLIBC_2.3.2 () from \
/lib64/libpthread.so.0 #1  0x00007f58ccc79e26 in virCondWait () from \
/lib64/libvirt.so.0 #2  0x00007f58a046f70b in qemuMonitorSend () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so #3  0x00007f58a04811d0 in \
qemuMonitorJSONCommandWithFd () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so #4  0x00007f58a0482a01 in \
qemuMonitorJSONSetCapabilities () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so #5  0x00007f58a044f567 in \
qemuConnectMonitor () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so #6  0x00007f58a04506f8 in \
qemuProcessWaitForMonitor () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so #7  0x00007f58a0456a52 in \
qemuProcessLaunch () from /usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so \
#8  0x00007f58a045a4b2 in qemuProcessStart () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so #9  0x00007f58a04bd5c6 in \
qemuDomainObjStart.constprop.50 () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so #10 0x00007f58a04bdd26 in \
qemuDomainCreateWithFlags () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so #11 0x00007f58cce1524c in \
virDomainCreate () from /lib64/libvirt.so.0 #12 0x000055e7499a3da3 in \
remoteDispatchDomainCreateHelper ()

Libvirtd is not actually entirely stuck but it's waiting for qemu to
start communicating with us when starting the VM.

Now why qemu got stuck it's not clear from this.

To un-stuck libvirt it should not be needed to restart it, but it should
be simply enough to 'virsh destroy $VM', which kills of the stuck qemu.

Now you can use the same approach you did with collecting the backtrace
of libvirtd to check what qemu is doing.

Additionally you can also have a look in /var/log/libvirt/qemu/$VM.log
to see whether qemu logged something.

&gt; System related info:
&gt; 
&gt; *   OS: CentOS 7.8.2003
&gt; *   libvirt version: 4.5.0-33


</body></email><email><emailId>20220515154856</emailId><senderName>Digimer</senderName><senderEmail>lists@alteeve.ca</senderEmail><timestampReceived>2022-05-15 15:48:56-0400</timestampReceived><subject>Problem calling 'virsh' in a script</subject><body>

&lt;html&gt;
  &lt;head&gt;

    &lt;meta http-equiv="content-type" content="text/html; charset=UTF-8"&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;p&gt;Hi all,&lt;/p&gt;
    &lt;p&gt;   I've got a series of programs that monitor various things on a
      CentOS Stream 8 VM host. All of these scripts work when called
      directly. However, when I have a parent program that calls all the
      little programs in series, I found that some virsh calls hang.&lt;/p&gt;
    &lt;p&gt;   Initially, there were two scripts that were hanging repeatedly.
      Once called 'virsh net-list --all --name', so I changed it to
      check for configs in '/etc/libvirt/qemu/networks/', and that
      script started working. The other script though calls 'virsh list
      --all', and that can't be easily swapped out, so I really need to
      find the source of these hangs.&lt;/p&gt;
    &lt;p&gt;   Whenever the hang happens, about 30~45 seconds later, I see
      'libvirtd[1643714]: Cannot recv data: Connection reset by peer'. &lt;br&gt;
    &lt;/p&gt;
    &lt;p&gt;   I think the issue is striking other scripts that run, but this
      scenario is happening predictably and consistently right now. &lt;br&gt;
    &lt;/p&gt;
    &lt;p&gt;   I thought it might be a concurrent connect limit or a problem
      with how many times virsh is called by a script, so I wrote a test
      script that kept calling 'virsh list --all' each second, but it
      was close to 100 calls without hanging, far more that all the
      calls in my scripts combined, so I don't think that's it.&lt;/p&gt;
    &lt;p&gt;Any advice/guidance would be very much appreciated!&lt;/p&gt;
    &lt;pre class="moz-signature" cols="72"&gt;-- 
Digimer
Papers and Projects: &lt;a class="moz-txt-link-freetext" \
href="https://alteeve.com/w/"&gt;https://alteeve.com/w/&lt;/a&gt; "I am, somehow, less \
interested in the weight and convolutions of Einstein's brain than in the near \
certainty that people of equal talent have lived and died in cotton fields and \
sweatshops." - Stephen Jay Gould&lt;/pre&gt;  &lt;/body&gt;
&lt;/html&gt;


</body></email><email><emailId>20220601100558</emailId><senderName>"Lentes, Bernd"</senderName><senderEmail>bernd.lentes@helmholtz-muenchen.de</senderEmail><timestampReceived>2022-06-01 10:05:58-0400</timestampReceived><subject>how to use "virsh shutdown domain --mode [initctl|signal|paravirt) ?</subject><body>


Hi,

ocasionally my Virtual Domains running on a pacmekaer cluster don't shutdown, \
although beeing told to do it. "virsh help shutdown" says:
 ...
--mode &lt;string&gt;  shutdown mode: acpi|agent|initctl|signal|paravirt

How is it possible to use initctl or signal or paravirt ?
What do i have to do ? What are the prerequisites ?

Bernd

-- 

Bernd Lentes 
System Administrator 
Institute for Metabolism and Cell Death (MCD) 
Building 25 - office 122 
HelmholtzZentrum München 
bernd.lentes@helmholtz-muenchen.de 
phone: +49 89 3187 1241 
fax: +49 89 3187 2294 
http://www.helmholtz-muenchen.de/mcd 


Public key: 

30 82 01 0a 02 82 01 01 00 b3 72 3e ce 2c 0a 6f 58 49 2c 92 23 c7 b9 c1 ff 6c 3a 53 \
be f7 9e e9 24 b7 49 fa 3c e8 de 28 85 2c d3 ed f7 70 03 3f 4d 82 fc cc 96 4f 18 27 \
1f df 25 b3 13 00 db 4b 1d ec 7f 1b cf f9 cd e8 5b 1f 11 b3 a7 48 f8 c8 37 ed 41 ff \
18 9f d7 83 51 a9 bd 86 c2 32 b3 d6 2d 77 ff 32 83 92 67 9e ae ae 9c 99 ce 42 27 6f \
bf d8 c2 a1 54 fd 2b 6b 12 65 0e 8a 79 56 be 53 89 70 51 02 6a eb 76 b8 92 25 2d 88 \
aa 57 08 42 ef 57 fb fe 00 71 8e 90 ef b2 e3 22 f3 34 4f 7b f1 c4 b1 7c 2f 1d 6f bd \
c8 a6 a1 1f 25 f3 e4 4b 6a 23 d3 d2 fa 27 ae 97 80 a3 f0 5a c4 50 4a 45 e3 45 4d 82 \
9f 8b 87 90 d0 f9 92 2d a7 d2 67 53 e6 ae 1e 72 3e e9 e0 c9 d3 1c 23 e0 75 78 4a 45 \
60 94 f8 e3 03 0b 09 85 08 d0 6c f3 ff ce fa 50 25 d9 da 81 7b 2a dc 9e 28 8b 83 04 \
b4 0a 9f 37 b8 ac 58 f1 38 43 0e 72 af 02 03 01 00 01


["smime.p7s" (application/pkcs7-signature)]

</body></email><email><emailId>20220601215714</emailId><senderName>Laurent Dumont</senderName><senderEmail>laurentfdumont@gmail.com</senderEmail><timestampReceived>2022-06-01 21:57:14-0400</timestampReceived><subject>[Libvirt][emulator-cores][dpdk] Emulatorpin cpuset best practices</subject><body>

Hey folks,

I am curious to understand a bit more the core use of the emulatorpin CPUs
with libvirt.

For example :

    &lt;vcpupin vcpu='0' cpuset='34'/&gt;
    &lt;vcpupin vcpu='1' cpuset='14'/&gt;
    &lt;vcpupin vcpu='2' cpuset='10'/&gt;
    &lt;vcpupin vcpu='3' cpuset='30'/&gt;
    &lt;emulatorpin cpuset='10,14,30,34'/&gt;

In this case :

   - The VM has 4 vCPUs.
   - Each of the core is pinned to a physical/thread core - 34,14,10,30
   - The emulatorpin is also attached to the same physical CPUs.

In our case :

   - Same setup for cores.
   - Running DPDK inside the virtual machine.
   - The compute/libvirt is using OVS but without DPDK.

What we saw is the following :

   - DPDK is polling two cores at 100% to process packets.
   - From the compute metrics, we see USER %usage at 100% when the
   application starts.
   - From the compute metrics, as traffic increases, we see %SYSTEM going
   up.
   - As %SYSTEM goes up, %USER goes down.

We are not quite sure, but we are wondering if this could cause a direct
impact to the ability of DPDK to process traffic at the same X speed?

   - We can "live" move the emulator CPU to other cores.
   - This seems to be the recommended default setup for VNF/NFV deployments.


Feels like I am missing a piece of the puzzle but gotta start somewhere!

Thanks!

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;Hey folks,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I am curious to understand a bit more \
the core use of the emulatorpin CPUs with libvirt.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;For \
example :&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;      &lt;vcpupin vcpu='0' \
cpuset='34'/&gt;&lt;br&gt;      &lt;vcpupin vcpu='1' \
cpuset='14'/&gt;&lt;br&gt;      &lt;vcpupin vcpu='2' \
cpuset='10'/&gt;&lt;br&gt;      &lt;vcpupin vcpu='3' \
cpuset='30'/&gt;&lt;br&gt;      &lt;emulatorpin \
cpuset='10,14,30,34'/&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;In this case \
:&lt;/div&gt;&lt;div&gt;&lt;ul&gt;&lt;li&gt;The VM has 4 vCPUs.&lt;/li&gt;&lt;li&gt;Each of the core is pinned to a \
physical/thread core - 34,14,10,30&lt;/li&gt;&lt;li&gt;The emulatorpin is also attached to the \
same physical CPUs.&lt;/li&gt;&lt;/ul&gt;&lt;div&gt;In our case :&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;ul&gt;&lt;li&gt;Same setup \
for cores.&lt;/li&gt;&lt;li&gt;Running DPDK inside the virtual machine.&lt;/li&gt;&lt;li&gt;The \
compute/libvirt is using OVS but without DPDK.&lt;/li&gt;&lt;/ul&gt;&lt;div&gt;What we saw is the \
following :&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;ul&gt;&lt;li&gt;DPDK is polling two cores at 100% to process \
packets.&lt;/li&gt;&lt;li&gt;From the compute metrics, we see USER %usage at 100% when the \
application starts.&lt;/li&gt;&lt;li&gt;From the compute metrics, as traffic increases, we see \
%SYSTEM going up.&lt;/li&gt;&lt;li&gt;As %SYSTEM goes up, %USER goes down.&lt;/li&gt;&lt;/ul&gt;&lt;div&gt;We are \
not quite sure, but we are wondering if this could cause a direct impact to the \
ability of DPDK to process traffic at the same X speed?&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;ul&gt;&lt;li&gt;We \
can "live" move the emulator CPU to other cores.&lt;/li&gt;&lt;li&gt;This seems to be \
the recommended default setup for VNF/NFV \
deployments.&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Feels like I am missing a piece of \
the puzzle but gotta start somewhere!  &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks!&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220611125418</emailId><senderName>Gionatan Danti</senderName><senderEmail>g.danti@assyoma.it</senderEmail><timestampReceived>2022-06-11 12:54:18-0400</timestampReceived><subject>vepa-mode directly attached interface</subject><body>

Hi all,
I just realized that libvirt default for directly attached interface is 
vepa mode.

I discovered it now because virt-manager automatically enables bridge 
mode, while cockpit-machines get the default vepa mode. This is 
unfortunate because, being vepa switches very rare, it means that using 
cockpit to configure directly attached interfaces causes guests to not 
talk each other.

I have some questions:

- can libvirt default be changed/configured somehow (ie: to 
automatically create bridge-mode directly attached interface when no 
mode is specified)?

- how can I use virsh to discover machines with vepa-mode interfaces 
(virsh domiflist &lt;domain&gt; does not return the interface mode)?

- can I change the interface type at runtime (virt-xml &lt;domain&gt; --edit 
--network type=direct,source.mode=bridge works for inactive domains 
only)?

Thanks.

-- 
Danti Gionatan
Supporto Tecnico
Assyoma S.r.l. - www.assyoma.it
email: g.danti@assyoma.it - info@assyoma.it
GPG public key ID: FF5F32A8

</body></email><email><emailId>20220610133131</emailId><senderName>Tomáš Golembiovský</senderName><senderEmail>tgolembi@redhat.com</senderEmail><timestampReceived>2022-06-10 13:31:31-0400</timestampReceived><subject>Domain XML of a restored VM</subject><body>

Hi,

I am looking for clarification on what exactly is happening to the
domain XML when resuming a suspended VM. We would like to make sure we
don't lose any configuration and we also see some unexpected behavior.

The VM with the name/UUID same as resumed VM may or may not already
exist. If it does, what role does the original domain XML of a VM play
when resuming? Is there any merging taking place between the existing
domain XML and the domain XML stored in save image? Is the original XML
simply thrown away and replaced?

Is there any difference how the stored XML is treated compared to the
XML passed in `virDomainRestoreFlags()`? I see some unexpected changes
here. When I use `virDomainSaveImageGetXMLDesc()` to retrieve the stored
XML and pass it unchanged to the `virDomainRestoreFlags()` the final
domain XML is different then when `virDomainRestore()` is used or when
`virDomainRestoreFlags()` with no `dxml` argument is used. We have:

   &lt;graphics ... passwdValidTo='1970-01-01T00:00:01'&gt;

in the domain XML and the `passwdValidTo` argument disappears when
domain XML is passed in `dxml` argument but it is preserved in other
cases. Is this behavior expected? If yes, can we do anything to preserve
the configuration? What other changes in domain XML can be expected?

Thanks,

    Tomas

-- 
Tomáš Golembiovský &lt;tgolembi@redhat.com&gt;

</body></email><email><emailId>20220613021743</emailId><senderName>Han Han</senderName><senderEmail>hhan@redhat.com</senderEmail><timestampReceived>2022-06-13 02:17:43-0400</timestampReceived><subject>Re: After restarted libvirtd service, live migration VM hit an issue 'Target CPU check default does </subject><body>

[Attachment #2 (multipart/alternative)]


On Sun, Jun 12, 2022 at 9:31 PM 梁朝军 &lt;jesonliang040705@hotmail.com&gt; wrote:

&gt; Hi All,
&gt;
&gt; BTW, don't send the email to any member of the mail list. It is not
someone's duty to answer it.
Just only send it to the mail list.


&gt; After  restarted the libvirtd service on the source host,  we start live
&gt; migration VM to destination host and often hit an issue 'unsupported
&gt; configuration: Target CPU check default does not match source none'
&gt;
&gt; We don't configure any special setting for CPU model when start VM and I
&gt; think it should be ‘custom' mode by default . Furthermore , those two hosts
&gt; for doing live migration have almost the same capabilities as below.
&gt;
Please provides the guest CPU XML, the CPU model of the src and the dst
hosts:
# virsh dumpxml YOUR_VM --inactive|xmllint --xpath //cpu -
(VM is live)
# virsh dumpxml YOUR_VM |xmllint --xpath //cpu -

# virsh capabilities|xmllint --xpath //cpu -



&gt; It's confused me why failed to check the cpu configuration after restart
&gt; libvitd service on source host?
&gt;
&gt;
&gt;
&gt; The libvirt version is 7.9.0, package: 1.el8 (Unknown,
&gt; 2021-11-28-22:35:11) private build
&gt; Host OS version : rhat8.4
&gt; QEMU version: QEMU 5.1 private build
&gt;
&gt; Any comments are appreciated.
&gt;
&gt;
&gt; Thanks
&gt;
&gt;

[Attachment #5 (text/html)]

&lt;div dir="ltr"&gt;&lt;div dir="ltr"&gt;&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div class="gmail_quote"&gt;&lt;div dir="ltr" \
class="gmail_attr"&gt;On Sun, Jun 12, 2022 at 9:31 PM 梁朝军 &lt;&lt;a \
href="mailto:jesonliang040705@hotmail.com"&gt;jesonliang040705@hotmail.com&lt;/a&gt;&gt; \
wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0px 0px 0px \
0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"&gt; &lt;div \
style="overflow-wrap: break-word;"&gt;&lt;div dir="auto" style="overflow-wrap: \
break-word;"&gt;&lt;div dir="auto" style="overflow-wrap: break-word;"&gt;&lt;div&gt;Hi \
All,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;div&gt;BTW, don't send \
the email to any member of the mail list. It is not someone's duty to answer \
it.&lt;br&gt;&lt;/div&gt;&lt;div&gt;Just only send it to the mail list.&lt;/div&gt;  &lt;/div&gt;&lt;blockquote \
class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left:1px solid \
rgb(204,204,204);padding-left:1ex"&gt;&lt;div style="overflow-wrap: break-word;"&gt;&lt;div \
dir="auto" style="overflow-wrap: break-word;"&gt;&lt;div dir="auto" style="overflow-wrap: \
break-word;"&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;After   restarted the libvirtd service on the source \
host,   we start  live migration VM to destination host and often hit an issue  \
'unsupported configuration: Target CPU check default does not match source \
none'&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We don't configure any special setting for CPU model \
when start VM and I think it should be ‘custom' mode by default . Furthermore , \
those two hosts for doing live migration have almost the same capabilities as \
below.&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;Please provides the guest CPU XML, \
the CPU model of the src and the dst hosts:&lt;/div&gt;&lt;div&gt;# virsh dumpxml YOUR_VM \
--inactive|xmllint --xpath //cpu -&lt;/div&gt;&lt;div&gt;(VM is live)&lt;br&gt;&lt;/div&gt;&lt;div&gt;# virsh \
dumpxml YOUR_VM |xmllint --xpath //cpu -&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;# virsh \
capabilities|xmllint --xpath //cpu -&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote \
class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left:1px solid \
rgb(204,204,204);padding-left:1ex"&gt;&lt;div style="overflow-wrap: break-word;"&gt;&lt;div \
dir="auto" style="overflow-wrap: break-word;"&gt;&lt;div dir="auto" style="overflow-wrap: \
break-word;"&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It's confused me why failed to check the cpu \
configuration after restart libvitd service on source host?  \
&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;img \
id="gmail-m_820053152112882516888BDA3FF-4B18-47ED-8218-6DAE24B12537" \
src="cid:1815ad2cdc64e3a8c4a1"&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The libvirt \
version is 7.9.0, package: 1.el8 (Unknown, 2021-11-28-22:35:11) private \
build&lt;/div&gt;&lt;div&gt;Host OS version : rhat8.4&lt;/div&gt;&lt;div&gt;QEMU version: QEMU 5.1 private \
build  &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Any comments are \
appreciated.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;
 &lt;/div&gt;
&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;


["=?UTF-8?B?5bGP5bmV5b+r54WnIDIwMjItMDYtMTIg5LiL5Y2IOS4yMw==?=
	=?UTF-8?B?LjQxLnBuZw==?=" (image/png)]

</body></email><email><emailId>20220615155648</emailId><senderName>Francesc Guasch</senderName><senderEmail>frankie@telecos.upc.edu</senderEmail><timestampReceived>2022-06-15 15:56:48-0400</timestampReceived><subject>managed save returns "migration with virtiofs device is not supported"</subject><body>

Hello. I have a virtual machine with a virtiofs entry configured.

When I try to do a managed save it fails with this message:

     libvirt error code: 55, message: Requested operation is not valid:
     migration with virtiofs device is not supported

This is libvirt 8.0.0 that comes with Ubuntu 22.04. I have seen
the current release in git is libvirt 8.5 . I will try to build
from source and try again if you think this was not the expected
behaviour.

This is the filesystem entry:

&lt;filesystem type='mount' accessmode='passthrough'&gt;
   &lt;driver type='virtiofs'/&gt;
   &lt;source dir='/home/shared'/&gt;
   &lt;target dir='home_shared'/&gt;
   &lt;address type='pci' domain='0x0000' bus='0x01' slot='0x00'
	 function='0x0'/&gt;
&lt;/filesystem&gt;

Sorry if this is not the right place to ask. I can write an
issue in gitlab or whatever is more appropriate.

Thanks !

</body></email><email><emailId>20220616072021</emailId><senderName>Gionatan Danti</senderName><senderEmail>g.danti@assyoma.it</senderEmail><timestampReceived>2022-06-16 07:20:21-0400</timestampReceived><subject>Domain XML and VLAN tagging</subject><body>

Hi all,
from here [1]:

"Network connections that support guest-transparent VLAN tagging include 
1) type='bridge' interfaces connected to an Open vSwitch bridge Since 
0.10.0 , 2) SRIOV Virtual Functions (VF) used via type='hostdev' (direct 
device assignment) Since 0.10.0 , and 3) SRIOV VFs used via 
type='direct' with mode='passthrough' (macvtap "passthru" mode) Since 
1.3.5 . All other connection types, including standard linux bridges and 
libvirt's own virtual networks, do not support it."

I read it correctly that when used on a classical linux bridge these 
vlan tags does nothing? If so, it is due to something related to the 
underlying bridge device (ie: incomplete support for vlan filtering) or 
it is because libvirt lacks the necessary "plumbing" to use advanced 
bridge features?

Thanks.

[1] 
https://libvirt.org/formatdomain.html#setting-vlan-tag-on-supported-network-types-only

-- 
Danti Gionatan
Supporto Tecnico
Assyoma S.r.l. - www.assyoma.it
email: g.danti@assyoma.it - info@assyoma.it
GPG public key ID: FF5F32A8

</body></email><email><emailId>20220608125838</emailId><senderName>"dberrange () yahoo ! com"</senderName><senderEmail>dberrange@yahoo.com</senderEmail><timestampReceived>2022-06-08 12:58:38-0400</timestampReceived><subject>Re: Testing DKIM handling</subject><body>

Further DKIM handling test, apologies for the noise.
    On Friday, 13 May 2022, 10:03:32 BST, dberrange@yahoo.com &lt;dberrange@yahoo.com&gt; wrote:  
 
 Testing DKIM handling RH mail servers
  
[Attachment #3 (text/html)]

&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;div class="ydp2bdcabaeyahoo-style-wrap" \
style="font-family:Helvetica Neue, Helvetica, Arial, \
                sans-serif;font-size:16px;"&gt;&lt;div&gt;&lt;/div&gt;
        &lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div dir="ltr" data-setdir="false"&gt;Further DKIM handling test, \
apologies for the noise.&lt;br&gt;&lt;/div&gt;  
        &lt;/div&gt;&lt;div id="yahoo_quoted_5170972316" class="yahoo_quoted"&gt;
            &lt;div style="font-family:'Helvetica Neue', Helvetica, Arial, \
sans-serif;font-size:13px;color:#26282a;"&gt;  
                &lt;div&gt;
                    On Friday, 13 May 2022, 10:03:32 BST, dberrange@yahoo.com \
&lt;dberrange@yahoo.com&gt; wrote:  &lt;/div&gt;
                &lt;div&gt;&lt;br&gt;&lt;/div&gt;
                &lt;div&gt;&lt;br&gt;&lt;/div&gt;
                &lt;div&gt;&lt;div id="yiv9784349538"&gt;&lt;div&gt;&lt;div style="font-family:Helvetica \
Neue, Helvetica, Arial, sans-serif;font-size:16px;" \
class="yiv9784349538yahoo-style-wrap"&gt;&lt;div dir="ltr"&gt;Testing DKIM handling RH mail \
servers&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;  &lt;/div&gt;
        &lt;/div&gt;&lt;/body&gt;&lt;/html&gt;



</body></email><email><emailId>20220616072449</emailId><senderName>Peter Krempa</senderName><senderEmail>pkrempa@redhat.com</senderEmail><timestampReceived>2022-06-16 07:24:49-0400</timestampReceived><subject>Re: Domain XML and VLAN tagging</subject><body>

On Thu, Jun 16, 2022 at 09:20:21 +0200, Gionatan Danti wrote:
&gt; Hi all,
&gt; from here [1]:
&gt; 
&gt; "Network connections that support guest-transparent VLAN tagging include 1)
&gt; type='bridge' interfaces connected to an Open vSwitch bridge Since 0.10.0 ,
&gt; 2) SRIOV Virtual Functions (VF) used via type='hostdev' (direct device
&gt; assignment) Since 0.10.0 , and 3) SRIOV VFs used via type='direct' with
&gt; mode='passthrough' (macvtap "passthru" mode) Since 1.3.5 . All other
&gt; connection types, including standard linux bridges and libvirt's own virtual
&gt; networks, do not support it."
&gt; 
&gt; I read it correctly that when used on a classical linux bridge these vlan
&gt; tags does nothing? If so, it is due to something related to the underlying
&gt; bridge device (ie: incomplete support for vlan filtering) or it is because
&gt; libvirt lacks the necessary "plumbing" to use advanced bridge features?

AFAIK it was simply never implemented. There's also an upstream feature
request for this:

https://gitlab.com/libvirt/libvirt/-/issues/157

&gt; 
&gt; Thanks.
&gt; 
&gt; [1] https://libvirt.org/formatdomain.html#setting-vlan-tag-on-supported-network-types-only
&gt; 
&gt; -- 
&gt; Danti Gionatan
&gt; Supporto Tecnico
&gt; Assyoma S.r.l. - www.assyoma.it
&gt; email: g.danti@assyoma.it - info@assyoma.it
&gt; GPG public key ID: FF5F32A8
&gt; 

</body></email><email><emailId>20220616140318</emailId><senderName>Laine Stump</senderName><senderEmail>laine@redhat.com</senderEmail><timestampReceived>2022-06-16 14:03:18-0400</timestampReceived><subject>Re: Domain XML and VLAN tagging</subject><body>

On 6/16/22 3:24 AM, Peter Krempa wrote:
&gt; On Thu, Jun 16, 2022 at 09:20:21 +0200, Gionatan Danti wrote:
&gt;&gt; Hi all,
&gt;&gt; from here [1]:
&gt;&gt;
&gt;&gt; "Network connections that support guest-transparent VLAN tagging include 1)
&gt;&gt; type='bridge' interfaces connected to an Open vSwitch bridge Since 0.10.0 ,
&gt;&gt; 2) SRIOV Virtual Functions (VF) used via type='hostdev' (direct device
&gt;&gt; assignment) Since 0.10.0 , and 3) SRIOV VFs used via type='direct' with
&gt;&gt; mode='passthrough' (macvtap "passthru" mode) Since 1.3.5 . All other
&gt;&gt; connection types, including standard linux bridges and libvirt's own virtual
&gt;&gt; networks, do not support it."
&gt;&gt;
&gt;&gt; I read it correctly that when used on a classical linux bridge these vlan
&gt;&gt; tags does nothing? If so, it is due to something related to the underlying
&gt;&gt; bridge device (ie: incomplete support for vlan filtering) or it is because
&gt;&gt; libvirt lacks the necessary "plumbing" to use advanced bridge features?
&gt; 
&gt; AFAIK it was simply never implemented. There's also an upstream feature
&gt; request for this:
&gt; 
&gt; https://gitlab.com/libvirt/libvirt/-/issues/157


When VLAN tagging was first implemented, Linux host bridges didn't have 
this capability - the only way to get guest traffic transparently tagged 
in that case was by having the bridge attached to a host VLAN interface 
rather than directly to the physical ethernet (resulting in the traffic 
from all guests attached to the bridge being tagged/untagged). A few 
years later support for tagging on individual host bridge ports was aded 
to the Linux bridge driver, but there was never enough push for the 
feature to get it added to libvirt.

"Patches are welcome" of course!

</body></email><email><emailId>20220615160233</emailId><senderName>Francesc Guasch</senderName><senderEmail>frankie@etsetb.upc.edu</senderEmail><timestampReceived>2022-06-15 16:02:33-0400</timestampReceived><subject>managed save returns "migration with virtiofs device is not supported"</subject><body>

Hello. I have a virtual machine with a virtiofs entry configured.

When I try to do a managed save it fails with this message:

     libvirt error code: 55, message: Requested operation is not valid:
     migration with virtiofs device is not supported

This is libvirt 8.0.0 that comes with Ubuntu 22.04. I have seen
the current release in git is libvirt 8.5 . I will try to build
from source and try again if you think this was not the expected
behaviour.

This is the filesystem entry:

&lt;filesystem type='mount' accessmode='passthrough'&gt;
   &lt;driver type='virtiofs'/&gt;
   &lt;source dir='/home/shared'/&gt;
   &lt;target dir='home_shared'/&gt;
   &lt;address type='pci' domain='0x0000' bus='0x01' slot='0x00'
	 function='0x0'/&gt;
&lt;/filesystem&gt;

Sorry if this is not the right place to ask. I can write an
issue in gitlab or whatever is more appropriate.

Thanks !

</body></email><email><emailId>20220615212517</emailId><senderName>Ján Tomko</senderName><senderEmail>jtomko@redhat.com</senderEmail><timestampReceived>2022-06-15 21:25:17-0400</timestampReceived><subject>Re: managed save returns "migration with virtiofs device is not supported"</subject><body>


On a Wednesday in 2022, Francesc Guasch wrote:
&gt;Hello. I have a virtual machine with a virtiofs entry configured.
&gt;
&gt;When I try to do a managed save it fails with this message:
&gt;
&gt;    libvirt error code: 55, message: Requested operation is not valid:
&gt;    migration with virtiofs device is not supported
&gt;

Yes, this is not yet implemented.

&gt;This is libvirt 8.0.0 that comes with Ubuntu 22.04. I have seen
&gt;the current release in git is libvirt 8.5 . I will try to build
&gt;from source and try again if you think this was not the expected
&gt;behaviour.
&gt;
&gt;This is the filesystem entry:
&gt;
&gt;&lt;filesystem type='mount' accessmode='passthrough'&gt;
&gt;  &lt;driver type='virtiofs'/&gt;
&gt;  &lt;source dir='/home/shared'/&gt;
&gt;  &lt;target dir='home_shared'/&gt;
&gt;  &lt;address type='pci' domain='0x0000' bus='0x01' slot='0x00'
&gt;	 function='0x0'/&gt;
&gt;&lt;/filesystem&gt;
&gt;
&gt;Sorry if this is not the right place to ask.

This list is the perfect place to ask libvirt questions.

&gt;I can write an
&gt;issue in gitlab or whatever is more appropriate.
&gt;

If you file a gitlab issue (with the "feature" template), you
may get notified if someone implements it.

Jano

&gt;Thanks !
&gt;

["signature.asc" (application/pgp-signature)]

</body></email><email><emailId>20220616110911</emailId><senderName>Francesc Guasch</senderName><senderEmail>frankie@etsetb.upc.edu</senderEmail><timestampReceived>2022-06-16 11:09:11-0400</timestampReceived><subject>Re: managed save returns "migration with virtiofs device is not supported"</subject><body>

El 15/6/22 a les 23:25, Ján Tomko ha escrit:
&gt; On a Wednesday in 2022, Francesc Guasch wrote:
&gt;&gt; Hello. I have a virtual machine with a virtiofs entry configured.
&gt;&gt;
&gt;&gt; When I try to do a managed save it fails with this message:
&gt;&gt;
&gt;&gt;      libvirt error code: 55, message: Requested operation is not valid:
&gt;&gt;      migration with virtiofs device is not supported
&gt;&gt;
&gt; 
&gt; Yes, this is not yet implemented.
&gt; 

ok ! Thanks for answering me.

What still puzzles me is I didn't want to do a migration.
I just wanted to do managed save.

Does this error message still applies ?

</body></email><email><emailId>20220613050650</emailId><senderName>liang chaojun</senderName><senderEmail>jesonliang040705@hotmail.com</senderEmail><timestampReceived>2022-06-13 05:06:50-0400</timestampReceived><subject>Re: After restarted libvirtd service, live migration VM hit an issue 'Target CPU check default does </subject><body>

[Attachment #2 (multipart/related)]

[Attachment #4 (multipart/alternative)]

[Attachment #6 (text/plain)]

Thanks Han for your quick response.

1. Virsh dumpxml VM from source host machine.
[cid:fd7f5b1f-8551-4bf8-ae1a-30c7b95065db@jpnprd01.prod.outlook.com]

2, Attachments are the CPU capability information from both source and destination host machine.


在 2022年6月13日，上午10:17，Han Han &lt;hhan@redhat.com&lt;mailto:hhan@redhat.com&gt;&gt; 写道：

virsh capabilities|xmllint --xpath //cpu -


[Attachment #7 (text/html)]

&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div class="" style="word-wrap:break-word; line-break:after-white-space"&gt;
&lt;div dir="auto" class="" style="word-wrap:break-word; line-break:after-white-space"&gt;
Thanks Han for your quick response.
&lt;div class=""&gt;&lt;br class=""&gt;
&lt;/div&gt;
&lt;div class=""&gt;1. Virsh dumpxml VM from source host machine.&lt;/div&gt;
&lt;div class=""&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div&gt;&lt;img src="cid:fd7f5b1f-8551-4bf8-ae1a-30c7b95065db@jpnprd01.prod.outlook.com"&gt;
&lt;/div&gt;
&lt;div style="word-wrap:break-word; line-break:after-white-space"&gt;
&lt;div dir="auto" style="word-wrap:break-word; line-break:after-white-space"&gt;
&lt;div class=""&gt;&lt;/div&gt;
&lt;div class=""&gt;&lt;br class=""&gt;
&lt;/div&gt;
&lt;div class=""&gt;2, Attachments are the CPU capability information from both source and \
destination host machine.&lt;/div&gt; &lt;div class=""&gt;&lt;br class=""&gt;
&lt;/div&gt;
&lt;div class=""&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div style="word-wrap:break-word; line-break:after-white-space"&gt;
&lt;div dir="auto" style="word-wrap:break-word; line-break:after-white-space"&gt;
&lt;div&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="" style="word-wrap:break-word; line-break:after-white-space"&gt;
&lt;div dir="auto" class="" style="word-wrap:break-word; line-break:after-white-space"&gt;
&lt;div class=""&gt;&lt;/div&gt;
&lt;div class=""&gt;&lt;br class=""&gt;
&lt;div&gt;
&lt;blockquote type="cite" class=""&gt;
&lt;div class=""&gt;在 2022年6月13日，上午10:17，Han Han &lt;&lt;a \
href="mailto:hhan@redhat.com" class=""&gt;hhan@redhat.com&lt;/a&gt;&gt; 写道：&lt;/div&gt; &lt;br \
class="x_Apple-interchange-newline"&gt; &lt;div class=""&gt;&lt;span class="" \
style="font-family:Helvetica; font-size:12px; font-style:normal; \
font-variant-caps:normal; font-weight:normal; letter-spacing:normal; \
text-align:start; text-indent:0px; text-transform:none; white-space:normal; \
word-spacing:0px; text-decoration:none; float:none; display:inline!important"&gt;virsh  \
capabilities|xmllint --xpath //cpu -&lt;/span&gt;&lt;/div&gt; &lt;/blockquote&gt;
&lt;/div&gt;
&lt;br class=""&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;


["=?utf-8?B?5bGP5bmV5b+r54WnIDIwMjItMDYtMTMg5LiL5Y2IMTIuMzUuMTkucG5n?=" (image/png)]
["source.capbilites.txt" (text/plain)]

&lt;cpu&gt;
      &lt;arch&gt;x86_64&lt;/arch&gt;
      &lt;model&gt;Haswell-noTSX-IBRS&lt;/model&gt;
      &lt;vendor&gt;Intel&lt;/vendor&gt;
      &lt;microcode version="68"/&gt;
      &lt;counter name="tsc" frequency="2294685000" scaling="no"/&gt;
      &lt;topology sockets="1" dies="1" cores="18" threads="2"/&gt;
      &lt;feature name="vme"/&gt;
      &lt;feature name="ds"/&gt;
      &lt;feature name="acpi"/&gt;
      &lt;feature name="ss"/&gt;
      &lt;feature name="ht"/&gt;
      &lt;feature name="tm"/&gt;
      &lt;feature name="pbe"/&gt;
      &lt;feature name="dtes64"/&gt;
      &lt;feature name="monitor"/&gt;
      &lt;feature name="ds_cpl"/&gt;
      &lt;feature name="vmx"/&gt;
      &lt;feature name="smx"/&gt;
      &lt;feature name="est"/&gt;
      &lt;feature name="tm2"/&gt;
      &lt;feature name="xtpr"/&gt;
      &lt;feature name="pdcm"/&gt;
      &lt;feature name="dca"/&gt;
      &lt;feature name="osxsave"/&gt;
      &lt;feature name="f16c"/&gt;
      &lt;feature name="rdrand"/&gt;
      &lt;feature name="arat"/&gt;
      &lt;feature name="tsc_adjust"/&gt;
      &lt;feature name="cmt"/&gt;
      &lt;feature name="md-clear"/&gt;
      &lt;feature name="stibp"/&gt;
      &lt;feature name="ssbd"/&gt;
      &lt;feature name="xsaveopt"/&gt;
      &lt;feature name="pdpe1gb"/&gt;
      &lt;feature name="abm"/&gt;
      &lt;feature name="invtsc"/&gt;
      &lt;pages unit="KiB" size="4"/&gt;
      &lt;pages unit="KiB" size="2048"/&gt;
      &lt;pages unit="KiB" size="1048576"/&gt;
    &lt;/cpu&gt;&lt;cpu id="0" socket_id="0" die_id="0" core_id="0" siblings="0,36"/&gt;&lt;cpu \
id="1" socket_id="0" die_id="0" core_id="1" siblings="1,37"/&gt;&lt;cpu id="2" \
socket_id="0" die_id="0" core_id="2" siblings="2,38"/&gt;&lt;cpu id="3" socket_id="0" \
die_id="0" core_id="3" siblings="3,39"/&gt;&lt;cpu id="4" socket_id="0" die_id="0" \
core_id="4" siblings="4,40"/&gt;&lt;cpu id="5" socket_id="0" die_id="0" core_id="8" \
siblings="5,41"/&gt;&lt;cpu id="6" socket_id="0" die_id="0" core_id="9" \
siblings="6,42"/&gt;&lt;cpu id="7" socket_id="0" die_id="0" core_id="10" \
siblings="7,43"/&gt;&lt;cpu id="8" socket_id="0" die_id="0" core_id="11" \
siblings="8,44"/&gt;&lt;cpu id="9" socket_id="0" die_id="0" core_id="16" \
siblings="9,45"/&gt;&lt;cpu id="10" socket_id="0" die_id="0" core_id="17" \
siblings="10,46"/&gt;&lt;cpu id="11" socket_id="0" die_id="0" core_id="18" \
siblings="11,47"/&gt;&lt;cpu id="12" socket_id="0" die_id="0" core_id="19" \
siblings="12,48"/&gt;&lt;cpu id="13" socket_id="0" die_id="0" core_id="20" \
siblings="13,49"/&gt;&lt;cpu id="14" socket_id="0" die_id="0" core_id="24" \
siblings="14,50"/&gt;&lt;cpu id="15" socket_id="0" die_id="0" core_id="25" \
siblings="15,51"/&gt;&lt;cpu id="16" socket_id="0" die_id="0" core_id="26" \
siblings="16,52"/&gt;&lt;cpu id="17" socket_id="0" die_id="0" core_id="27" \
siblings="17,53"/&gt;&lt;cpu id="36" socket_id="0" die_id="0" core_id="0" \
siblings="0,36"/&gt;&lt;cpu id="37" socket_id="0" die_id="0" core_id="1" \
siblings="1,37"/&gt;&lt;cpu id="38" socket_id="0" die_id="0" core_id="2" \
siblings="2,38"/&gt;&lt;cpu id="39" socket_id="0" die_id="0" core_id="3" \
siblings="3,39"/&gt;&lt;cpu id="40" socket_id="0" die_id="0" core_id="4" \
siblings="4,40"/&gt;&lt;cpu id="41" socket_id="0" die_id="0" core_id="8" \
siblings="5,41"/&gt;&lt;cpu id="42" socket_id="0" die_id="0" core_id="9" \
siblings="6,42"/&gt;&lt;cpu id="43" socket_id="0" die_id="0" core_id="10" \
siblings="7,43"/&gt;&lt;cpu id="44" socket_id="0" die_id="0" core_id="11" \
siblings="8,44"/&gt;&lt;cpu id="45" socket_id="0" die_id="0" core_id="16" \
siblings="9,45"/&gt;&lt;cpu id="46" socket_id="0" die_id="0" core_id="17" \
siblings="10,46"/&gt;&lt;cpu id="47" socket_id="0" die_id="0" core_id="18" \
siblings="11,47"/&gt;&lt;cpu id="48" socket_id="0" die_id="0" core_id="19" \
siblings="12,48"/&gt;&lt;cpu id="49" socket_id="0" die_id="0" core_id="20" \
siblings="13,49"/&gt;&lt;cpu id="50" socket_id="0" die_id="0" core_id="24" \
siblings="14,50"/&gt;&lt;cpu id="51" socket_id="0" die_id="0" core_id="25" \
siblings="15,51"/&gt;&lt;cpu id="52" socket_id="0" die_id="0" core_id="26" \
siblings="16,52"/&gt;&lt;cpu id="53" socket_id="0" die_id="0" core_id="27" \
siblings="17,53"/&gt;&lt;cpu id="18" socket_id="1" die_id="0" core_id="0" \
siblings="18,54"/&gt;&lt;cpu id="19" socket_id="1" die_id="0" core_id="1" \
siblings="19,55"/&gt;&lt;cpu id="20" socket_id="1" die_id="0" core_id="2" \
siblings="20,56"/&gt;&lt;cpu id="21" socket_id="1" die_id="0" core_id="3" \
siblings="21,57"/&gt;&lt;cpu id="22" socket_id="1" die_id="0" core_id="4" \
siblings="22,58"/&gt;&lt;cpu id="23" socket_id="1" die_id="0" core_id="8" \
siblings="23,59"/&gt;&lt;cpu id="24" socket_id="1" die_id="0" core_id="9" \
siblings="24,60"/&gt;&lt;cpu id="25" socket_id="1" die_id="0" core_id="10" \
siblings="25,61"/&gt;&lt;cpu id="26" socket_id="1" die_id="0" core_id="11" \
siblings="26,62"/&gt;&lt;cpu id="27" socket_id="1" die_id="0" core_id="16" \
siblings="27,63"/&gt;&lt;cpu id="28" socket_id="1" die_id="0" core_id="17" \
siblings="28,64"/&gt;&lt;cpu id="29" socket_id="1" die_id="0" core_id="18" \
siblings="29,65"/&gt;&lt;cpu id="30" socket_id="1" die_id="0" core_id="19" \
siblings="30,66"/&gt;&lt;cpu id="31" socket_id="1" die_id="0" core_id="20" \
siblings="31,67"/&gt;&lt;cpu id="32" socket_id="1" die_id="0" core_id="24" \
siblings="32,68"/&gt;&lt;cpu id="33" socket_id="1" die_id="0" core_id="25" \
siblings="33,69"/&gt;&lt;cpu id="34" socket_id="1" die_id="0" core_id="26" \
siblings="34,70"/&gt;&lt;cpu id="35" socket_id="1" die_id="0" core_id="27" \
siblings="35,71"/&gt;&lt;cpu id="54" socket_id="1" die_id="0" core_id="0" \
siblings="18,54"/&gt;&lt;cpu id="55" socket_id="1" die_id="0" core_id="1" \
siblings="19,55"/&gt;&lt;cpu id="56" socket_id="1" die_id="0" core_id="2" \
siblings="20,56"/&gt;&lt;cpu id="57" socket_id="1" die_id="0" core_id="3" \
siblings="21,57"/&gt;&lt;cpu id="58" socket_id="1" die_id="0" core_id="4" \
siblings="22,58"/&gt;&lt;cpu id="59" socket_id="1" die_id="0" core_id="8" \
siblings="23,59"/&gt;&lt;cpu id="60" socket_id="1" die_id="0" core_id="9" \
siblings="24,60"/&gt;&lt;cpu id="61" socket_id="1" die_id="0" core_id="10" \
siblings="25,61"/&gt;&lt;cpu id="62" socket_id="1" die_id="0" core_id="11" \
siblings="26,62"/&gt;&lt;cpu id="63" socket_id="1" die_id="0" core_id="16" \
siblings="27,63"/&gt;&lt;cpu id="64" socket_id="1" die_id="0" core_id="17" \
siblings="28,64"/&gt;&lt;cpu id="65" socket_id="1" die_id="0" core_id="18" \
siblings="29,65"/&gt;&lt;cpu id="66" socket_id="1" die_id="0" core_id="19" \
siblings="30,66"/&gt;&lt;cpu id="67" socket_id="1" die_id="0" core_id="20" \
siblings="31,67"/&gt;&lt;cpu id="68" socket_id="1" die_id="0" core_id="24" \
siblings="32,68"/&gt;&lt;cpu id="69" socket_id="1" die_id="0" core_id="25" \
siblings="33,69"/&gt;&lt;cpu id="70" socket_id="1" die_id="0" core_id="26" \
siblings="34,70"/&gt;&lt;cpu id="71" socket_id="1" die_id="0" core_id="27" \
siblings="35,71"/&gt;


["dist.capbilites.txt" (text/plain)]

&lt;cpu&gt;
      &lt;arch&gt;x86_64&lt;/arch&gt;
      &lt;model&gt;Haswell-noTSX-IBRS&lt;/model&gt;
      &lt;vendor&gt;Intel&lt;/vendor&gt;
      &lt;microcode version="68"/&gt;
      &lt;counter name="tsc" frequency="2299998000" scaling="no"/&gt;
      &lt;topology sockets="1" dies="1" cores="18" threads="2"/&gt;
      &lt;feature name="vme"/&gt;
      &lt;feature name="ds"/&gt;
      &lt;feature name="acpi"/&gt;
      &lt;feature name="ss"/&gt;
      &lt;feature name="ht"/&gt;
      &lt;feature name="tm"/&gt;
      &lt;feature name="pbe"/&gt;
      &lt;feature name="dtes64"/&gt;
      &lt;feature name="monitor"/&gt;
      &lt;feature name="ds_cpl"/&gt;
      &lt;feature name="vmx"/&gt;
      &lt;feature name="smx"/&gt;
      &lt;feature name="est"/&gt;
      &lt;feature name="tm2"/&gt;
      &lt;feature name="xtpr"/&gt;
      &lt;feature name="pdcm"/&gt;
      &lt;feature name="dca"/&gt;
      &lt;feature name="osxsave"/&gt;
      &lt;feature name="f16c"/&gt;
      &lt;feature name="rdrand"/&gt;
      &lt;feature name="arat"/&gt;
      &lt;feature name="tsc_adjust"/&gt;
      &lt;feature name="cmt"/&gt;
      &lt;feature name="md-clear"/&gt;
      &lt;feature name="stibp"/&gt;
      &lt;feature name="ssbd"/&gt;
      &lt;feature name="xsaveopt"/&gt;
      &lt;feature name="pdpe1gb"/&gt;
      &lt;feature name="abm"/&gt;
      &lt;feature name="invtsc"/&gt;
      &lt;pages unit="KiB" size="4"/&gt;
      &lt;pages unit="KiB" size="2048"/&gt;
      &lt;pages unit="KiB" size="1048576"/&gt;
    &lt;/cpu&gt;&lt;cpu id="0" socket_id="0" die_id="0" core_id="0" siblings="0,36"/&gt;&lt;cpu \
id="1" socket_id="0" die_id="0" core_id="1" siblings="1,37"/&gt;&lt;cpu id="2" \
socket_id="0" die_id="0" core_id="2" siblings="2,38"/&gt;&lt;cpu id="3" socket_id="0" \
die_id="0" core_id="3" siblings="3,39"/&gt;&lt;cpu id="4" socket_id="0" die_id="0" \
core_id="4" siblings="4,40"/&gt;&lt;cpu id="5" socket_id="0" die_id="0" core_id="8" \
siblings="5,41"/&gt;&lt;cpu id="6" socket_id="0" die_id="0" core_id="9" \
siblings="6,42"/&gt;&lt;cpu id="7" socket_id="0" die_id="0" core_id="10" \
siblings="7,43"/&gt;&lt;cpu id="8" socket_id="0" die_id="0" core_id="11" \
siblings="8,44"/&gt;&lt;cpu id="9" socket_id="0" die_id="0" core_id="16" \
siblings="9,45"/&gt;&lt;cpu id="10" socket_id="0" die_id="0" core_id="17" \
siblings="10,46"/&gt;&lt;cpu id="11" socket_id="0" die_id="0" core_id="18" \
siblings="11,47"/&gt;&lt;cpu id="12" socket_id="0" die_id="0" core_id="19" \
siblings="12,48"/&gt;&lt;cpu id="13" socket_id="0" die_id="0" core_id="20" \
siblings="13,49"/&gt;&lt;cpu id="14" socket_id="0" die_id="0" core_id="24" \
siblings="14,50"/&gt;&lt;cpu id="15" socket_id="0" die_id="0" core_id="25" \
siblings="15,51"/&gt;&lt;cpu id="16" socket_id="0" die_id="0" core_id="26" \
siblings="16,52"/&gt;&lt;cpu id="17" socket_id="0" die_id="0" core_id="27" \
siblings="17,53"/&gt;&lt;cpu id="36" socket_id="0" die_id="0" core_id="0" \
siblings="0,36"/&gt;&lt;cpu id="37" socket_id="0" die_id="0" core_id="1" \
siblings="1,37"/&gt;&lt;cpu id="38" socket_id="0" die_id="0" core_id="2" \
siblings="2,38"/&gt;&lt;cpu id="39" socket_id="0" die_id="0" core_id="3" \
siblings="3,39"/&gt;&lt;cpu id="40" socket_id="0" die_id="0" core_id="4" \
siblings="4,40"/&gt;&lt;cpu id="41" socket_id="0" die_id="0" core_id="8" \
siblings="5,41"/&gt;&lt;cpu id="42" socket_id="0" die_id="0" core_id="9" \
siblings="6,42"/&gt;&lt;cpu id="43" socket_id="0" die_id="0" core_id="10" \
siblings="7,43"/&gt;&lt;cpu id="44" socket_id="0" die_id="0" core_id="11" \
siblings="8,44"/&gt;&lt;cpu id="45" socket_id="0" die_id="0" core_id="16" \
siblings="9,45"/&gt;&lt;cpu id="46" socket_id="0" die_id="0" core_id="17" \
siblings="10,46"/&gt;&lt;cpu id="47" socket_id="0" die_id="0" core_id="18" \
siblings="11,47"/&gt;&lt;cpu id="48" socket_id="0" die_id="0" core_id="19" \
siblings="12,48"/&gt;&lt;cpu id="49" socket_id="0" die_id="0" core_id="20" \
siblings="13,49"/&gt;&lt;cpu id="50" socket_id="0" die_id="0" core_id="24" \
siblings="14,50"/&gt;&lt;cpu id="51" socket_id="0" die_id="0" core_id="25" \
siblings="15,51"/&gt;&lt;cpu id="52" socket_id="0" die_id="0" core_id="26" \
siblings="16,52"/&gt;&lt;cpu id="53" socket_id="0" die_id="0" core_id="27" \
siblings="17,53"/&gt;&lt;cpu id="18" socket_id="1" die_id="0" core_id="0" \
siblings="18,54"/&gt;&lt;cpu id="19" socket_id="1" die_id="0" core_id="1" \
siblings="19,55"/&gt;&lt;cpu id="20" socket_id="1" die_id="0" core_id="2" \
siblings="20,56"/&gt;&lt;cpu id="21" socket_id="1" die_id="0" core_id="3" \
siblings="21,57"/&gt;&lt;cpu id="22" socket_id="1" die_id="0" core_id="4" \
siblings="22,58"/&gt;&lt;cpu id="23" socket_id="1" die_id="0" core_id="8" \
siblings="23,59"/&gt;&lt;cpu id="24" socket_id="1" die_id="0" core_id="9" \
siblings="24,60"/&gt;&lt;cpu id="25" socket_id="1" die_id="0" core_id="10" \
siblings="25,61"/&gt;&lt;cpu id="26" socket_id="1" die_id="0" core_id="11" \
siblings="26,62"/&gt;&lt;cpu id="27" socket_id="1" die_id="0" core_id="16" \
siblings="27,63"/&gt;&lt;cpu id="28" socket_id="1" die_id="0" core_id="17" \
siblings="28,64"/&gt;&lt;cpu id="29" socket_id="1" die_id="0" core_id="18" \
siblings="29,65"/&gt;&lt;cpu id="30" socket_id="1" die_id="0" core_id="19" \
siblings="30,66"/&gt;&lt;cpu id="31" socket_id="1" die_id="0" core_id="20" \
siblings="31,67"/&gt;&lt;cpu id="32" socket_id="1" die_id="0" core_id="24" \
siblings="32,68"/&gt;&lt;cpu id="33" socket_id="1" die_id="0" core_id="25" \
siblings="33,69"/&gt;&lt;cpu id="34" socket_id="1" die_id="0" core_id="26" \
siblings="34,70"/&gt;&lt;cpu id="35" socket_id="1" die_id="0" core_id="27" \
siblings="35,71"/&gt;&lt;cpu id="54" socket_id="1" die_id="0" core_id="0" \
siblings="18,54"/&gt;&lt;cpu id="55" socket_id="1" die_id="0" core_id="1" \
siblings="19,55"/&gt;&lt;cpu id="56" socket_id="1" die_id="0" core_id="2" \
siblings="20,56"/&gt;&lt;cpu id="57" socket_id="1" die_id="0" core_id="3" \
siblings="21,57"/&gt;&lt;cpu id="58" socket_id="1" die_id="0" core_id="4" \
siblings="22,58"/&gt;&lt;cpu id="59" socket_id="1" die_id="0" core_id="8" \
siblings="23,59"/&gt;&lt;cpu id="60" socket_id="1" die_id="0" core_id="9" \
siblings="24,60"/&gt;&lt;cpu id="61" socket_id="1" die_id="0" core_id="10" \
siblings="25,61"/&gt;&lt;cpu id="62" socket_id="1" die_id="0" core_id="11" \
siblings="26,62"/&gt;&lt;cpu id="63" socket_id="1" die_id="0" core_id="16" \
siblings="27,63"/&gt;&lt;cpu id="64" socket_id="1" die_id="0" core_id="17" \
siblings="28,64"/&gt;&lt;cpu id="65" socket_id="1" die_id="0" core_id="18" \
siblings="29,65"/&gt;&lt;cpu id="66" socket_id="1" die_id="0" core_id="19" \
siblings="30,66"/&gt;&lt;cpu id="67" socket_id="1" die_id="0" core_id="20" \
siblings="31,67"/&gt;&lt;cpu id="68" socket_id="1" die_id="0" core_id="24" \
siblings="32,68"/&gt;&lt;cpu id="69" socket_id="1" die_id="0" core_id="25" \
siblings="33,69"/&gt;&lt;cpu id="70" socket_id="1" die_id="0" core_id="26" \
siblings="34,70"/&gt;&lt;cpu id="71" socket_id="1" die_id="0" core_id="27" \
siblings="35,71"/&gt;



</body></email><email><emailId>20220613151513</emailId><senderName>Michal Prívozník</senderName><senderEmail>mprivozn@redhat.com</senderEmail><timestampReceived>2022-06-13 15:15:13-0400</timestampReceived><subject>Re: Domain XML of a restored VM</subject><body>

On 6/10/22 15:31, Tomáš Golembiovský wrote:
&gt; Hi,
&gt; 
&gt; I am looking for clarification on what exactly is happening to the
&gt; domain XML when resuming a suspended VM. We would like to make sure we
&gt; don't lose any configuration and we also see some unexpected behavior.
&gt; 
&gt; The VM with the name/UUID same as resumed VM may or may not already
&gt; exist. If it does, what role does the original domain XML of a VM play
&gt; when resuming? Is there any merging taking place between the existing
&gt; domain XML and the domain XML stored in save image? Is the original XML
&gt; simply thrown away and replaced?
&gt; 

A guest can have up to two XMLs:

1) defined guests have so called 'inactive' or 'config' XML. This XML
does not contain any runtime information, and is used as the initial
configuration when starting the guest. Once the guest is running, it'll
also have ...

2) live XML. This XML contains runtime information and because of
hotplug and plenty of APIs that tweak various XML knobs
(virDomainSetMemoryParameters(), virDomainSetInterfaceParameters(),
etc.) can be very different to the inactive XML. Changes to the live XML
are thrown away as soon as the guest is shut off and we're back to
square 1 where only the inactive XML is preserved (and used as the
initial config for the next run).

However, this live XML is very important because it reflects the guest
ABI. For instance, some of our APIs offer a way for users to supply
modified domain XML (as you say below, virDomainRestoreFlags() is onw of
them, migration APIs are another). After this user supplied XML is
parsed, it's thrown at an excessive ABI stability checker, who's only
goal is to make sure that the live XML maintained by Libvirt and the
user provided XML differ only in those ways that won't break guest ABI
(for instance, changing the port where SPICE is allowed, removing a
&lt;disk/&gt; isn't).

Having said all of this - the XML that's saved among the domain by
virDomainSave() API is the live XML. Because that's the one that
reflects the current state of the saved image. Inactive XML is
disconnected from all of this.

&gt; Is there any difference how the stored XML is treated compared to the
&gt; XML passed in `virDomainRestoreFlags()`? I see some unexpected changes
&gt; here. When I use `virDomainSaveImageGetXMLDesc()` to retrieve the stored
&gt; XML and pass it unchanged to the `virDomainRestoreFlags()` the final
&gt; domain XML is different then when `virDomainRestore()` is used or when
&gt; `virDomainRestoreFlags()` with no `dxml` argument is used. We have:
&gt; 
&gt;    &lt;graphics ... passwdValidTo='1970-01-01T00:00:01'&gt;
&gt; 
&gt; in the domain XML and the `passwdValidTo` argument disappears when
&gt; domain XML is passed in `dxml` argument but it is preserved in other
&gt; cases. Is this behavior expected? If yes, can we do anything to preserve
&gt; the configuration? What other changes in domain XML can be expected?

No, this behaviour is definitely not expected.
As explained above, runtime values, that don't affect guest ABI are
allowed to change. The rest is not. Password timeout should be allowed
to change, because guest has no idea about the password in the first
place. This is all done in the backed (that part of SPICE that faces the
host/clients).

Michal

</body></email><email><emailId>20220623144225</emailId><senderName>Charles Koprowski</senderName><senderEmail>charles@koprow.ski</senderEmail><timestampReceived>2022-06-23 14:42:25-0400</timestampReceived><subject>Storage Pool - NFS v4.1</subject><body>

Hello,

In order to use pNFS which is only available in NFS version 4.1, I'm trying
to create a netfs storage pool specifying the protocol version to be used :

&lt;pool type="netfs"&gt;
  &lt;name&gt;vms&lt;/name&gt;
  &lt;source&gt;
    ...
    &lt;format type="nfs"/&gt;
    &lt;protocol ver='4.1'/&gt;
  &lt;/source&gt;
  &lt;target&gt;
    ...
&lt;/pool&gt;

But the storage pool XML documentation [1] states that :

protocol

For a netfs Storage Pool provide a mechanism to define which NFS protocol
version number will be used to contact the server's NFS service. The
attribute ver accepts an unsigned *integer* as the version number to use.

And indeed, when I try to virsh pool-define I get :

error: Failed to define pool from pool.xml
error: XML error: storage pool protocol ver '4.1' is malformed

How can I specify the desired NFS minor version to libvirt ?

I could mount the NFS share myself and build a dir storage pool on top of
it but that's not very pretty.

Thank you,

[1] https://libvirt.org/formatstorage.html

-- 
Charles

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;Hello,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;In order to use pNFS which is only available \
in NFS version 4.1, I'm trying to create a netfs storage pool specifying the  \
protocol version to be used :&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;pool \
type="netfs"&gt;&lt;br&gt;   &lt;name&gt;vms&lt;/name&gt;&lt;br&gt;   \
&lt;source&gt;&lt;br&gt;      ...&lt;br&gt;      &lt;format type="nfs"/&gt;&lt;br&gt;      \
&lt;protocol ver='4.1'/&gt;&lt;br&gt;   &lt;/source&gt;&lt;br&gt;   &lt;target&gt;&lt;br&gt;    \
...&lt;br&gt;&lt;/pool&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;But the storage pool XML documentation \
[1] states that :&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote style="margin:0 0 0 \
40px;border:none;padding:0px"&gt;&lt;div&gt;protocol&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;For a netfs \
Storage Pool provide a mechanism to define which NFS protocol version number will be \
used to contact the server's NFS service. The attribute ver accepts an unsigned \
*integer* as the version number to use.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/blockquote&gt;And indeed, \
when I try to virsh pool-define I get :&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote style="margin:0 0 0 \
40px;border:none;padding:0px"&gt;error: Failed to define pool from pool.xml&lt;br&gt;error: \
XML error: storage pool protocol ver '4.1' is \
malformed&lt;br&gt;&lt;br&gt;&lt;/blockquote&gt;How can I specify the desired NFS minor version to \
libvirt ?&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I could mount the NFS share myself and build a dir \
storage pool on top of it but that's not very \
pretty.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thank you,&lt;br&gt;&lt;div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;[1] &lt;a \
href="https://libvirt.org/formatstorage.html"&gt;https://libvirt.org/formatstorage.html&lt;/a&gt;&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;-- \
&lt;br&gt;&lt;div dir="ltr" class="gmail_signature" data-smartmail="gmail_signature"&gt;&lt;div \
dir="ltr"&gt;Charles&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220623151937</emailId><senderName>Peter Krempa</senderName><senderEmail>pkrempa@redhat.com</senderEmail><timestampReceived>2022-06-23 15:19:37-0400</timestampReceived><subject>Re: Storage Pool - NFS v4.1</subject><body>

On Thu, Jun 23, 2022 at 16:42:25 +0200, Charles Koprowski wrote:
&gt; Hello,
&gt; 
&gt; In order to use pNFS which is only available in NFS version 4.1, I'm trying
&gt; to create a netfs storage pool specifying the protocol version to be used :
&gt; 
&gt; &lt;pool type="netfs"&gt;
&gt;   &lt;name&gt;vms&lt;/name&gt;
&gt;   &lt;source&gt;
&gt;     ...
&gt;     &lt;format type="nfs"/&gt;
&gt;     &lt;protocol ver='4.1'/&gt;
&gt;   &lt;/source&gt;
&gt;   &lt;target&gt;
&gt;     ...
&gt; &lt;/pool&gt;
&gt; 
&gt; But the storage pool XML documentation [1] states that :

[...]

I've posted a patch that fixes this:

https://listman.redhat.com/archives/libvir-list/2022-June/232541.html

</body></email><email><emailId>20220611173212</emailId><senderName>Laine Stump</senderName><senderEmail>laine@redhat.com</senderEmail><timestampReceived>2022-06-11 17:32:12-0400</timestampReceived><subject>Re: vepa-mode directly attached interface</subject><body>

On 6/11/22 8:54 AM, Gionatan Danti wrote:
&gt; Hi all,
&gt; I just realized that libvirt default for directly attached interface is 
&gt; vepa mode.
&gt; 
&gt; I discovered it now because virt-manager automatically enables bridge 
&gt; mode, while cockpit-machines get the default vepa mode. This is 
&gt; unfortunate because, being vepa switches very rare, it means that using 
&gt; cockpit to configure directly attached interfaces causes guests to not 
&gt; talk each other.
&gt; 
&gt; I have some questions:
&gt; 
&gt; - can libvirt default be changed/configured somehow (ie: to 
&gt; automatically create bridge-mode directly attached interface when no 
&gt; mode is specified)?

libvirt's defaults are defaults, and can't be changed with config. 
libvirt also will never changed the hardcoded default, because that 
could break existing installations.

I'm not sure why vepa was chosen as the default when macvtap support was 
added to libvirt, but my best guess is that it was just the bias of the 
person doing the work who assumed their usage would be the most common 
(IIRC it was done by someone who was specifically wanting to support 
connection to VEPA-capable switches, and since it was a new feature 
nobody else had experience with / opinions about which mode would be 
most common, so the reviewers just accepted this default)

&gt; 
&gt; - how can I use virsh to discover machines with vepa-mode interfaces 
&gt; (virsh domiflist &lt;domain&gt; does not return the interface mode)?

I guess you'll need to do a "virsh dumpxml --inactive" for each guest 
and parse it out of there.

&gt; 
&gt; - can I change the interface type at runtime (virt-xml &lt;domain&gt; --edit 
&gt; --network type=direct,source.mode=bridge works for inactive domains only)?

No, I think the mode of the macvtap interface is set when the interface 
is created, and can't be changed later (i.e. it's a limitation of 
macvtap, not libvirt)

</body></email><email><emailId>20220611221620</emailId><senderName>Gionatan Danti</senderName><senderEmail>g.danti@assyoma.it</senderEmail><timestampReceived>2022-06-11 22:16:20-0400</timestampReceived><subject>Re: vepa-mode directly attached interface</subject><body>

Il 2022-06-11 19:32 Laine Stump ha scritto:
&gt; libvirt's defaults are defaults, and can't be changed with config.
&gt; libvirt also will never changed the hardcoded default, because that
&gt; could break existing installations.

Thanks for the direct confirmation that default can not be changed with 
config. I opened a cockpit-machine bug to ask for a change there: 
https://bugzilla.redhat.com/show_bug.cgi?id=2095967

&gt; I'm not sure why vepa was chosen as the default when macvtap support
&gt; was added to libvirt, but my best guess is that it was just the bias
&gt; of the person doing the work who assumed their usage would be the most
&gt; common (IIRC it was done by someone who was specifically wanting to
&gt; support connection to VEPA-capable switches, and since it was a new
&gt; feature nobody else had experience with / opinions about which mode
&gt; would be most common, so the reviewers just accepted this default)

Sound reasonable. Do you know if directly attached bridge-mode interface 
is common and tested into production workload, or if "pure" bridge mode 
is the way to go?

Full disclosure: I always used "pure" bridges, but I like the idea to 
deny any guest-&gt;host traffic by design - hence my interest in 
bridge-mode macvtap interfaces. Moreover, by the virtue of not requiring 
a dedicated bridge interface, they can simplify the host network 
configuration.

&gt; I guess you'll need to do a "virsh dumpxml --inactive" for each guest
&gt; and parse it out of there.

It matches my results. However, virsh dumpxml is an expensive operation 
- polkitd can easily burn &gt;30% of a single core for 1s polling interval 
with virsh dumpxml. I settled (for testing) with grepping "mode..vepa" 
in /etc/libvirtd/qemu and it seems to work well (1s polling not even 
register in top).

Does libvirt support calling some external script when a new virtual 
machine is defined?

&gt; No, I think the mode of the macvtap interface is set when the
&gt; interface is created, and can't be changed later (i.e. it's a
&gt; limitation of macvtap, not libvirt)

Again, it matches my results (ip link showing "operation not supported" 
when trying to change the mode at runtime). I hoped to miss something, 
but it does not seem the case...

Thanks.

-- 
Danti Gionatan
Supporto Tecnico
Assyoma S.r.l. - www.assyoma.it
email: g.danti@assyoma.it - info@assyoma.it
GPG public key ID: FF5F32A8

</body></email><email><emailId>20220613074725</emailId><senderName>Peter Krempa</senderName><senderEmail>pkrempa@redhat.com</senderEmail><timestampReceived>2022-06-13 07:47:25-0400</timestampReceived><subject>Re: vepa-mode directly attached interface</subject><body>

On Sun, Jun 12, 2022 at 00:16:20 +0200, Gionatan Danti wrote:
&gt; Il 2022-06-11 19:32 Laine Stump ha scritto:

[...]

&gt; &gt; I guess you'll need to do a "virsh dumpxml --inactive" for each guest
&gt; &gt; and parse it out of there.
&gt; 
&gt; It matches my results. However, virsh dumpxml is an expensive operation -
&gt; polkitd can easily burn &gt;30% of a single core for 1s polling interval with
&gt; virsh dumpxml. I settled (for testing) with grepping "mode..vepa" in
&gt; /etc/libvirtd/qemu and it seems to work well (1s polling not even register
&gt; in top).

The unfortunate thing about using `virsh dumpxml $VM` as written is that
it opens a connection (which uses polkit to auth), gets the XML and then
closes the connection.

If you want it to be more optimized you can e.g. write a script using
python bindings for libvirt and simply keep the connection open ...

&gt; Does libvirt support calling some external script when a new virtual machine
&gt; is defined?

... which additionally allows you to register 'domain lifecycle events'
[1] which give you a trigger when a new VM is defined.


https://www.libvirt.org/html/libvirt-libvirt-domain.html#virConnectDomainEventRegister
https://www.libvirt.org/html/libvirt-libvirt-domain.html#virDomainEventID

</body></email><email><emailId>20220601102543</emailId><senderName>Peter Krempa</senderName><senderEmail>pkrempa@redhat.com</senderEmail><timestampReceived>2022-06-01 10:25:43-0400</timestampReceived><subject>Re: how to use "virsh shutdown domain --mode [initctl|signal|paravirt) ?</subject><body>

On Wed, Jun 01, 2022 at 12:05:58 +0200, Lentes, Bernd wrote:
&gt; Hi,
&gt; 
&gt; ocasionally my Virtual Domains running on a pacmekaer cluster don't shutdown, \
&gt; although beeing told to do it. "virsh help shutdown" says:
&gt; ...
&gt; --mode &lt;string&gt;  shutdown mode: acpi|agent|initctl|signal|paravirt
&gt; 
&gt; How is it possible to use initctl or signal or paravirt ?
&gt; What do i have to do ? What are the prerequisites ?

I presume you use qemu/kvm as virt, right? In such case only 'acpi' and
'agent' are available.

'initctl'/'signal' is meant for LXC containers, and
'paravirt' is a mode available for the XEN hypervisor


</body></email><email><emailId>20220515160758</emailId><senderName>Laine Stump</senderName><senderEmail>laine@redhat.com</senderEmail><timestampReceived>2022-05-15 16:07:58-0400</timestampReceived><subject>Re: Problem calling 'virsh' in a script</subject><body>

On 5/15/22 11:48 AM, Digimer wrote:
&gt; Hi all,
&gt; 
&gt; I've got a series of programs that monitor various things on a CentOS 
&gt; Stream 8 VM host. All of these scripts work when called directly. 
&gt; However, when I have a parent program that calls all the little programs 
&gt; in series, I found that some virsh calls hang.

Is your script being called from a libvirt "hook" script? 
(https://libvirt.org/hooks.html )If so, that won't work - a libvirt hook 
script is called from within libvirt, and can't call back into libvirt.

Other than that, is there anything different about the context the 
script is being run from vs. the context you're directly running virsh from?

&gt; 
&gt; Initially, there were two scripts that were hanging repeatedly. Once 
&gt; called 'virsh net-list --all --name', so I changed it to check for 
&gt; configs in '/etc/libvirt/qemu/networks/', and that script started 
&gt; working. The other script though calls 'virsh list --all', and that 
&gt; can't be easily swapped out, so I really need to find the source of 
&gt; these hangs.
&gt; 
&gt; Whenever the hang happens, about 30~45 seconds later, I see 
&gt; 'libvirtd[1643714]: Cannot recv data: Connection reset by peer'.
&gt; 
&gt; I think the issue is striking other scripts that run, but this 
&gt; scenario is happening predictably and consistently right now.
&gt; 
&gt; I thought it might be a concurrent connect limit or a problem with 
&gt; how many times virsh is called by a script, so I wrote a test script 
&gt; that kept calling 'virsh list --all' each second, but it was close to 
&gt; 100 calls without hanging, far more that all the calls in my scripts 
&gt; combined, so I don't think that's it.
&gt; 
&gt; Any advice/guidance would be very much appreciated!
&gt; 
&gt; -- 
&gt; Digimer
&gt; Papers and Projects:https://alteeve.com/w/
&gt; "I am, somehow, less interested in the weight and convolutions of Einstein’s brain \
&gt; than in the near certainty that people of equal talent have lived and died in \
&gt; cotton fields and sweatshops." - Stephen Jay Gould 


</body></email><email><emailId>20220515161340</emailId><senderName>Digimer</senderName><senderEmail>lists@alteeve.ca</senderEmail><timestampReceived>2022-05-15 16:13:40-0400</timestampReceived><subject>Re: Problem calling 'virsh' in a script</subject><body>

&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8"&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div class="moz-cite-prefix"&gt;On 2022-05-15 12:07, Laine Stump wrote:&lt;br&gt;
    &lt;/div&gt;
    &lt;blockquote type="cite"
      cite="mid:0284f7d2-46ae-a0cb-ae68-9d96e14365ba@redhat.com"&gt;On
      5/15/22 11:48 AM, Digimer wrote:
      &lt;br&gt;
      &lt;blockquote type="cite"&gt;Hi all,
        &lt;br&gt;
        &lt;br&gt;
             I've got a series of programs that monitor various things on
        a CentOS Stream 8 VM host. All of these scripts work when called
        directly. However, when I have a parent program that calls all
        the little programs in series, I found that some virsh calls
        hang.
        &lt;br&gt;
      &lt;/blockquote&gt;
      &lt;br&gt;
      Is your script being called from a libvirt "hook" script?
      (&lt;a class="moz-txt-link-freetext" \
href="https://libvirt.org/hooks.html"&gt;https://libvirt.org/hooks.html&lt;/a&gt; )If so, that \
won't work - a  libvirt hook script is called from within libvirt, and can't call
      back into libvirt.
      &lt;br&gt;
      &lt;br&gt;
      Other than that, is there anything different about the context the
      script is being run from vs. the context you're directly running
      virsh from?
      &lt;br&gt;
    &lt;/blockquote&gt;
    &lt;p&gt;It's a perl script making a shell (system) call. So it's
      basically;&lt;/p&gt;
    &lt;p&gt;open (my $fh, "/usr/bin/virsh list --all |") or die;&lt;br&gt;
      while ($fh)&lt;br&gt;
      {&lt;br&gt;
             chomp;&lt;br&gt;
             # Do things&lt;br&gt;
      }&lt;br&gt;
      close $fh;&lt;br&gt;
    &lt;/p&gt;
    &lt;p&gt;   There's about 15 programs that are sitting in a given
      directory. When the parent program runs, it looks at the scripts
      in the directory and runs them (again as simple shell calls), one
      after the other. This is where things fail. I'm happy to provide
      more detail or add debugging if you'd like.&lt;br&gt;
    &lt;/p&gt;
    &lt;p&gt;&lt;br&gt;
    &lt;/p&gt;
    &lt;blockquote type="cite"
      cite="mid:0284f7d2-46ae-a0cb-ae68-9d96e14365ba@redhat.com"&gt;
      &lt;br&gt;
      &lt;blockquote type="cite"&gt;
        &lt;br&gt;
             Initially, there were two scripts that were hanging
        repeatedly. Once called 'virsh net-list --all --name', so I
        changed it to check for configs in
        '/etc/libvirt/qemu/networks/', and that script started working.
        The other script though calls 'virsh list --all', and that can't
        be easily swapped out, so I really need to find the source of
        these hangs.
        &lt;br&gt;
        &lt;br&gt;
             Whenever the hang happens, about 30~45 seconds later, I see
        'libvirtd[1643714]: Cannot recv data: Connection reset by peer'.
        &lt;br&gt;
        &lt;br&gt;
             I think the issue is striking other scripts that run, but
        this scenario is happening predictably and consistently right
        now.
        &lt;br&gt;
        &lt;br&gt;
             I thought it might be a concurrent connect limit or a problem
        with how many times virsh is called by a script, so I wrote a
        test script that kept calling 'virsh list --all' each second,
        but it was close to 100 calls without hanging, far more that all
        the calls in my scripts combined, so I don't think that's it.
        &lt;br&gt;
        &lt;br&gt;
        Any advice/guidance would be very much appreciated!
        &lt;br&gt;
        &lt;br&gt;
        --  &lt;br&gt;
        Digimer
      &lt;/blockquote&gt;
    &lt;/blockquote&gt;
    &lt;br&gt;
  &lt;/body&gt;
&lt;/html&gt;


</body></email><email><emailId>20220515164947</emailId><senderName>Digimer</senderName><senderEmail>lists@alteeve.ca</senderEmail><timestampReceived>2022-05-15 16:49:47-0400</timestampReceived><subject>Re: Problem calling 'virsh' in a script</subject><body>

&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8"&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div class="moz-cite-prefix"&gt;On 2022-05-15 12:13, Digimer wrote:&lt;br&gt;
    &lt;/div&gt;
    &lt;blockquote type="cite"
      cite="mid:034422d6-5ddd-dd61-f94e-55ed3152db9b@alteeve.ca"&gt;
      &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8"&gt;
      &lt;div class="moz-cite-prefix"&gt;On 2022-05-15 12:07, Laine Stump
        wrote:&lt;br&gt;
      &lt;/div&gt;
      &lt;blockquote type="cite"
        cite="mid:0284f7d2-46ae-a0cb-ae68-9d96e14365ba@redhat.com"&gt;On
        5/15/22 11:48 AM, Digimer wrote: &lt;br&gt;
        &lt;blockquote type="cite"&gt;Hi all, &lt;br&gt;
          &lt;br&gt;
               I've got a series of programs that monitor various things
          on a CentOS Stream 8 VM host. All of these scripts work when
          called directly. However, when I have a parent program that
          calls all the little programs in series, I found that some
          virsh calls hang. &lt;br&gt;
        &lt;/blockquote&gt;
        &lt;br&gt;
        Is your script being called from a libvirt "hook" script? (&lt;a
          class="moz-txt-link-freetext"
          href="https://libvirt.org/hooks.html" moz-do-not-send="true"&gt;https://libvirt.org/hooks.html&lt;/a&gt;
        )If so, that won't work - a libvirt hook script is called from
        within libvirt, and can't call back into libvirt. &lt;br&gt;
        &lt;br&gt;
        Other than that, is there anything different about the context
        the script is being run from vs. the context you're directly
        running virsh from? &lt;br&gt;
      &lt;/blockquote&gt;
      &lt;p&gt;It's a perl script making a shell (system) call. So it's
        basically;&lt;/p&gt;
      &lt;p&gt;open (my $fh, "/usr/bin/virsh list --all |") or die;&lt;br&gt;
        while ($fh)&lt;br&gt;
        {&lt;br&gt;
               chomp;&lt;br&gt;
               # Do things&lt;br&gt;
        }&lt;br&gt;
        close $fh;&lt;br&gt;
      &lt;/p&gt;
      &lt;p&gt;   There's about 15 programs that are sitting in a given
        directory. When the parent program runs, it looks at the scripts
        in the directory and runs them (again as simple shell calls),
        one after the other. This is where things fail. I'm happy to
        provide more detail or add debugging if you'd like.&lt;br&gt;
      &lt;/p&gt;
    &lt;/blockquote&gt;
    &lt;p&gt;I just did a test where I reversed the order that the scripts
      were called, so that the problematic one was called first (in case
      it was a connection limit being hit or something), and I had a new
      failure mode...&lt;/p&gt;
    &lt;p&gt;When the parent program ran, it hung hard. I call the child
      scripts with 'timeout 30 /path/to/child/script' and timeout never
      fired, the program hung hard. In journald, I saw:&lt;/p&gt;
    &lt;p&gt;May 15 12:18:43 nr-a03n01.nray.ca libvirtd[1643714]: internal
      error: connection closed due to keepalive timeout&lt;br&gt;
      May 15 12:25:31 nr-a03n01.nray.ca libvirtd[1643714]: Cannot recv
      data: Connection reset by peer&lt;/p&gt;
    &lt;p&gt;I had to kill the parent program with two 'ctrl + c' entries;&lt;/p&gt;
    &lt;p&gt;====&lt;br&gt;
      time scancore --run-once &lt;br&gt;
      scancore has started.&lt;br&gt;
      Running the scan agent: [scan-storcli] with a timeout of: [30]
      seconds now...&lt;br&gt;
      - Scan agent: [scan-storcli] exited after: [4] seconds with the
      return code: [0].&lt;br&gt;
      Running the scan agent: [scan-server] with a timeout of: [30]
      seconds now...&lt;br&gt;
      ^C&lt;br&gt;
      &lt;br&gt;
      Process with PID: [1705068] exiting on SIGINT.&lt;br&gt;
      ^C&lt;br&gt;
      &lt;br&gt;
      Process with PID: [1705068] exiting on SIGINT.&lt;br&gt;
      &lt;br&gt;
      real       13m43.899s&lt;br&gt;
      user       0m5.253s&lt;br&gt;
      sys       0m2.097s&lt;br&gt;
      ====&lt;br&gt;
      &lt;br&gt;
      I checked 'ps aux' and found that, even after the ctrl + c, the
      processes were still running...&lt;br&gt;
      &lt;br&gt;
      ====&lt;br&gt;
      # scancore --run-once &lt;br&gt;
      scancore has started.&lt;br&gt;
      Running the scan agent: [scan-storcli] with a timeout of: [30]
      seconds now...&lt;br&gt;
      - Scan agent: [scan-storcli] exited after: [5] seconds with the
      return code: [0].&lt;br&gt;
      Running the scan agent: [scan-server] with a timeout of: [30]
      seconds now...&lt;br&gt;
      ^C&lt;br&gt;
      &lt;br&gt;
      Process with PID: [1708093] exiting on SIGINT.&lt;br&gt;
      ^C&lt;br&gt;
      &lt;br&gt;
      Process with PID: [1708093] exiting on SIGINT.&lt;br&gt;
      [root@nr-a03n01 ~]# ps aux | grep scan&lt;br&gt;
      root         1708900   0.0   0.0   12732   3132 pts/1       S       12:45     0:00
      sh -c /usr/bin/timeout 30
      /usr/sbin/scancore-agents/scan-server/scan-server 2&gt;&amp;1;
      /usr/bin/echo return_code:$?&lt;br&gt;
      root         1708901   0.0   0.0   11592     976 pts/1       S       12:45     0:00
      /usr/bin/timeout 30
      /usr/sbin/scancore-agents/scan-server/scan-server&lt;br&gt;
      root         1708902   5.8   0.0 249400 91960 pts/1       T       12:45     0:01
      /usr/bin/perl /usr/sbin/scancore-agents/scan-server/scan-server&lt;br&gt;
      ====&lt;/p&gt;
    &lt;p&gt;While this is hanging, _other_ programs call 'virsh list --all'
      just fine. And as mentioned, if I call the problem script
      directly, it runs just fine (confirmed by watching the logs,
      'virsh list --all' returns and logic runs fine)...&lt;/p&gt;
    &lt;p&gt;====&lt;br&gt;
      [root@nr-a03n01 ~]# ps aux | grep scan&lt;br&gt;
      root         1709321   0.0   0.0   12144   1108 pts/1       S+     12:47     0:00
      grep --color=auto scan&lt;br&gt;
    &lt;/p&gt;
    &lt;p&gt;[root@nr-a03n01 ~]#
      /usr/sbin/scancore-agents/scan-server/scan-server &lt;br&gt;
    &lt;/p&gt;
    &lt;p&gt;[root@nr-a03n01 ~]# ps aux | grep scan&lt;br&gt;
      root         1709716   0.0   0.0   12144   1112 pts/1       S+     12:48     0:00
      grep --color=auto scan&lt;br&gt;
      [root@nr-a03n01 ~]# &lt;br&gt;
      ====&lt;/p&gt;
    &lt;p&gt;I am so confused...&lt;/p&gt;
    &lt;p&gt;digimer&lt;br&gt;
    &lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;

</body></email><email><emailId>20220401082536</emailId><senderName>Daniel =?utf-8?B?UC4gQmVycmFuZ8Op?=</senderName><senderEmail>berrange@redhat.com</senderEmail><timestampReceived>2022-04-01 08:25:36-0400</timestampReceived><subject>Re: Debugging hanging libvirt</subject><body>

On Wed, Mar 30, 2022 at 01:11:50AM +0000, Tobias Hofmann (tohofman) wrote:
&gt; Hello all,
&gt; 
&gt; I have a system with one VM running. After some time the VM needs to be
&gt; temporarily stopped and started again. This start operation fails and
&gt; from that point on any virsh command is hanging and does not execute.
&gt; This issue is reproducible and I have already figured out that restarting
&gt; libvirtd resolves this issue. However, I'm now trying to understand why
&gt; it's getting stuck in the first place.
&gt; 
&gt; I try not to get too much into detail because I think this would be more
&gt; confusing than it would actually help to understand the problem. In
&gt; general, I'm wondering what approach you should follow to debug why
&gt; libvirt gets stuck.
&gt; Online I've read that you should run this command: `# gdb -batch -p
&gt; $(pidof libvirtd) -ex 't a a bt f'`. I've run that command and attached
&gt; the output to this mail. However, I have to admit that I have no idea
&gt; what to do with it.

That's perfect. In that trace we can see two threads of interest

One thread is attempting to start the QEMU instance:

    Thread 18 (Thread 0x7f58bcf3e700 (LWP 19010)):
    #0  0x00007f58c9e3a9f5 in pthread_cond_wait@@GLIBC_2.3.2 () from \
/lib64/libpthread.so.0  #1  0x00007f58ccc79e26 in virCondWait () from \
/lib64/libvirt.so.0  #2  0x00007f58a046f70b in qemuMonitorSend () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so  #3  0x00007f58a04811d0 \
in qemuMonitorJSONCommandWithFd () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so  #4  0x00007f58a0482a01 \
in qemuMonitorJSONSetCapabilities () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so  #5  0x00007f58a044f567 \
in qemuConnectMonitor () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so  #6  0x00007f58a04506f8 \
in qemuProcessWaitForMonitor () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so  #7  0x00007f58a0456a52 \
in qemuProcessLaunch () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so  #8  0x00007f58a045a4b2 \
in qemuProcessStart () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so  #9  0x00007f58a04bd5c6 \
in qemuDomainObjStart.constprop.50 () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so  #10 0x00007f58a04bdd26 \
in qemuDomainCreateWithFlags () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so  #11 0x00007f58cce1524c \
in virDomainCreate () from /lib64/libvirt.so.0  #12 0x000055e7499a3da3 in \
remoteDispatchDomainCreateHelper ()  #13 0x00007f58ccd461d5 in \
virNetServerProgramDispatch () from /lib64/libvirt.so.0  #14 0x00007f58ccd4c9ad in \
virNetServerHandleJob () from /lib64/libvirt.so.0  #15 0x00007f58ccc7a831 in \
virThreadPoolWorker () from /lib64/libvirt.so.0  #16 0x00007f58ccc79bb8 in \
virThreadHelper () from /lib64/libvirt.so.0  #17 0x00007f58c9e36e65 in start_thread \
() from /lib64/libpthread.so.0  #18 0x00007f58c9b5f92d in clone () from \
/lib64/libc.so.6

This shows we have started QEMU and are trying to connect to the monitor.
We have queued some data to send and are waiting for the event loop to
send it and get the reply back.


The next thread of interest is

    Thread 1 (Thread 0x7f58cd74c8c0 (LWP 19008)):
    #0  0x00007f58c9e3a35e in pthread_rwlock_wrlock () from /lib64/libpthread.so.0
    #1  0x00007f58a0b779e7 in nwfilterStateReload () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_nwfilter.so  #2  \
0x00007f58a0b77aa5 in nwfilterFirewalldDBusFilter () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_nwfilter.so  #3  \
0x00007f58ca8f6c5e in dbus_connection_dispatch () from /lib64/libdbus-1.so.3  #4  \
0x00007f58ccc0e421 in virDBusWatchCallback () from /lib64/libvirt.so.0  #5  \
0x00007f58ccc193a7 in virEventPollRunOnce () from /lib64/libvirt.so.0  #6  \
0x00007f58ccc17a72 in virEventRunDefaultImpl () from /lib64/libvirt.so.0  #7  \
0x00007f58ccd4c22d in virNetDaemonRun () from /lib64/libvirt.so.0  #8  \
0x000055e7499758b9 in main ()


This is the main event loop thread. Here we see that it is running a
reload operation for the nwfilter driver. This is triggered when something
restarts the firewalld daemon, or requests that it flushes &amp; reloads its
rules.

This is where the problem is.  The thread starting the QEMU process is
likely holding a read lock on the nwfilter driver, and is waiting for
the event loop thread to finish monitor I/O.

The event loop thread though is blocked waiting for a write lock on
the nwfilter driver, and this will never come available because the
othre thread holds a read lock and is waiting for this thread.


So the root problem here is that we should not be running the reload
code for the nwfilter driver in the main event loop thread, because
it blocks the entire event loop preventing othre threads making
process, and is also dependant on those othuer threads releasing
locks.

I'm really surprised no one has reported this problem to us before
since its existed forever AFAICT.

With current libvirt it should be harmless, since each QEMU process
now gets its own dedicated event loop, so would not be blocked by
the main event loop being stalled.

I think we should none the less fix this by moving the nwfilter
reload code to a background thread, as anything running in the
main event thread is expected to be completing very fast.


Back to why you get into this scenario. I guess something on your
system is triggering a firewall reload or restart at exactly the
same time as you are starting the VM. This is pretty strange,
unless you've somehow got this triggered from a hook related to
the VM startup/shutdown ?

With regards,
Daniel
-- 
&gt; &gt; https://berrange.com      -o-    https://www.flickr.com/photos/dberrange :|
&gt; &gt; https://libvirt.org         -o-            https://fstop138.berrange.com :|
&gt; &gt; https://entangle-photo.org    -o-    https://www.instagram.com/dberrange :|


</body></email><email><emailId>20220401195531</emailId><senderName>"Tobias Hofmann (tohofman)"</senderName><senderEmail>tohofman@cisco.com</senderEmail><timestampReceived>2022-04-01 19:55:31-0400</timestampReceived><subject>Re: Debugging hanging libvirt</subject><body>

Hi Daniel,

Thank you to Peter and you for the analysis =96 that was very helpful.
Indeed, it can happen that we restart the firewall during this scenario on =
our system so I think I can debug from here.

By the way, you mentioned that there is a libvirt version where QEMU proces=
s gets its own dedicated event loop. Would you mind sharing this libvirt ve=
rsion with me?

Thanks
Tobias

From: Daniel P. Berrang=E9 &lt;berrange@redhat.com&gt;
Date: Friday, 1. April 2022 at 01:26
To: Tobias Hofmann (tohofman) &lt;tohofman@cisco.com&gt;
Cc: libvirt-users@redhat.com &lt;libvirt-users@redhat.com&gt;
Subject: Re: Debugging hanging libvirt
On Wed, Mar 30, 2022 at 01:11:50AM +0000, Tobias Hofmann (tohofman) wrote:
&gt; Hello all,
&gt;
&gt; I have a system with one VM running. After some time the VM needs to be
&gt; temporarily stopped and started again. This start operation fails and
&gt; from that point on any virsh command is hanging and does not execute.
&gt; This issue is reproducible and I have already figured out that restarting
&gt; libvirtd resolves this issue. However, I=92m now trying to understand why
&gt; it=92s getting stuck in the first place.
&gt;
&gt; I try not to get too much into detail because I think this would be more
&gt; confusing than it would actually help to understand the problem. In
&gt; general, I=92m wondering what approach you should follow to debug why
&gt; libvirt gets stuck.
&gt; Online I=92ve read that you should run this command: `# gdb -batch -p
&gt; $(pidof libvirtd) -ex 't a a bt f'`. I=92ve run that command and attached
&gt; the output to this mail. However, I have to admit that I have no idea
&gt; what to do with it.

That's perfect. In that trace we can see two threads of interest

One thread is attempting to start the QEMU instance:

    Thread 18 (Thread 0x7f58bcf3e700 (LWP 19010)):
    #0  0x00007f58c9e3a9f5 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64=
/libpthread.so.0
    #1  0x00007f58ccc79e26 in virCondWait () from /lib64/libvirt.so.0
    #2  0x00007f58a046f70b in qemuMonitorSend () from /usr/lib64/libvirt/co=
nnection-driver/libvirt_driver_qemu.so
    #3  0x00007f58a04811d0 in qemuMonitorJSONCommandWithFd () from /usr/lib=
64/libvirt/connection-driver/libvirt_driver_qemu.so
    #4  0x00007f58a0482a01 in qemuMonitorJSONSetCapabilities () from /usr/l=
ib64/libvirt/connection-driver/libvirt_driver_qemu.so
    #5  0x00007f58a044f567 in qemuConnectMonitor () from /usr/lib64/libvirt=
/connection-driver/libvirt_driver_qemu.so
    #6  0x00007f58a04506f8 in qemuProcessWaitForMonitor () from /usr/lib64/=
libvirt/connection-driver/libvirt_driver_qemu.so
    #7  0x00007f58a0456a52 in qemuProcessLaunch () from /usr/lib64/libvirt/=
connection-driver/libvirt_driver_qemu.so
    #8  0x00007f58a045a4b2 in qemuProcessStart () from /usr/lib64/libvirt/c=
onnection-driver/libvirt_driver_qemu.so
    #9  0x00007f58a04bd5c6 in qemuDomainObjStart.constprop.50 () from /usr/=
lib64/libvirt/connection-driver/libvirt_driver_qemu.so
    #10 0x00007f58a04bdd26 in qemuDomainCreateWithFlags () from /usr/lib64/=
libvirt/connection-driver/libvirt_driver_qemu.so
    #11 0x00007f58cce1524c in virDomainCreate () from /lib64/libvirt.so.0
    #12 0x000055e7499a3da3 in remoteDispatchDomainCreateHelper ()
    #13 0x00007f58ccd461d5 in virNetServerProgramDispatch () from /lib64/li=
bvirt.so.0
    #14 0x00007f58ccd4c9ad in virNetServerHandleJob () from /lib64/libvirt.=
so.0
    #15 0x00007f58ccc7a831 in virThreadPoolWorker () from /lib64/libvirt.so=
.0
    #16 0x00007f58ccc79bb8 in virThreadHelper () from /lib64/libvirt.so.0
    #17 0x00007f58c9e36e65 in start_thread () from /lib64/libpthread.so.0
    #18 0x00007f58c9b5f92d in clone () from /lib64/libc.so.6

This shows we have started QEMU and are trying to connect to the monitor.
We have queued some data to send and are waiting for the event loop to
send it and get the reply back.


The next thread of interest is

    Thread 1 (Thread 0x7f58cd74c8c0 (LWP 19008)):
    #0  0x00007f58c9e3a35e in pthread_rwlock_wrlock () from /lib64/libpthre=
ad.so.0
    #1  0x00007f58a0b779e7 in nwfilterStateReload () from /usr/lib64/libvir=
t/connection-driver/libvirt_driver_nwfilter.so
    #2  0x00007f58a0b77aa5 in nwfilterFirewalldDBusFilter () from /usr/lib6=
4/libvirt/connection-driver/libvirt_driver_nwfilter.so
    #3  0x00007f58ca8f6c5e in dbus_connection_dispatch () from /lib64/libdb=
us-1.so.3
    #4  0x00007f58ccc0e421 in virDBusWatchCallback () from /lib64/libvirt.s=
o.0
    #5  0x00007f58ccc193a7 in virEventPollRunOnce () from /lib64/libvirt.so=
.0
    #6  0x00007f58ccc17a72 in virEventRunDefaultImpl () from /lib64/libvirt=
.so.0
    #7  0x00007f58ccd4c22d in virNetDaemonRun () from /lib64/libvirt.so.0
    #8  0x000055e7499758b9 in main ()


This is the main event loop thread. Here we see that it is running a
reload operation for the nwfilter driver. This is triggered when something
restarts the firewalld daemon, or requests that it flushes &amp; reloads its
rules.

This is where the problem is.  The thread starting the QEMU process is
likely holding a read lock on the nwfilter driver, and is waiting for
the event loop thread to finish monitor I/O.

The event loop thread though is blocked waiting for a write lock on
the nwfilter driver, and this will never come available because the
othre thread holds a read lock and is waiting for this thread.


So the root problem here is that we should not be running the reload
code for the nwfilter driver in the main event loop thread, because
it blocks the entire event loop preventing othre threads making
process, and is also dependant on those othuer threads releasing
locks.

I'm really surprised no one has reported this problem to us before
since its existed forever AFAICT.

With current libvirt it should be harmless, since each QEMU process
now gets its own dedicated event loop, so would not be blocked by
the main event loop being stalled.

I think we should none the less fix this by moving the nwfilter
reload code to a background thread, as anything running in the
main event thread is expected to be completing very fast.


Back to why you get into this scenario. I guess something on your
system is triggering a firewall reload or restart at exactly the
same time as you are starting the VM. This is pretty strange,
unless you've somehow got this triggered from a hook related to
the VM startup/shutdown ?

With regards,
Daniel
--
|: https://berrange.com      -o-    https://www.flickr.com/photos/dberrange=
 :|
|: https://libvirt.org         -o-            https://fstop138.berrange.com=
 :|
|: https://entangle-photo.org    -o-    https://www.instagram.com/dberrange=
 :|

[Attachment #3 (text/html)]

&lt;html xmlns:o="urn:schemas-microsoft-com:office:office" \
xmlns:w="urn:schemas-microsoft-com:office:word" \
xmlns:m="http://schemas.microsoft.com/office/2004/12/omml" \
xmlns="http://www.w3.org/TR/REC-html40"&gt; &lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=Windows-1252"&gt;
&lt;meta name="Generator" content="Microsoft Word 15 (filtered medium)"&gt;
&lt;style&gt;&lt;!--
/* Font Definitions */
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
/* Style Definitions */
p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin:0cm;
	font-size:10.0pt;
	font-family:"Calibri",sans-serif;}
a:link, span.MsoHyperlink
	{mso-style-priority:99;
	color:blue;
	text-decoration:underline;}
span.EmailStyle19
	{mso-style-type:personal-reply;
	font-family:"Calibri",sans-serif;
	color:windowtext;}
.MsoChpDefault
	{mso-style-type:export-only;
	font-size:10.0pt;}
@page WordSection1
	{size:612.0pt 792.0pt;
	margin:72.0pt 72.0pt 72.0pt 72.0pt;}
div.WordSection1
	{page:WordSection1;}
--&gt;&lt;/style&gt;
&lt;/head&gt;
&lt;body lang="en-DE" link="blue" vlink="purple" style="word-wrap:break-word"&gt;
&lt;div class="WordSection1"&gt;
&lt;p class="MsoNormal"&gt;&lt;span lang="EN-US" \
style="font-size:11.0pt;mso-fareast-language:EN-US"&gt;Hi Daniel,&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; \
&lt;p class="MsoNormal"&gt;&lt;span lang="EN-US" \
style="font-size:11.0pt;mso-fareast-language:EN-US"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;span lang="EN-US" \
style="font-size:11.0pt;mso-fareast-language:EN-US"&gt;Thank you to Peter and you for \
the analysis – that was very helpful.&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;span lang="EN-US" \
style="font-size:11.0pt;mso-fareast-language:EN-US"&gt;Indeed, it can happen that we \
restart the firewall during this scenario on our system so I think I can debug from \
here.&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;span lang="EN-US" \
style="font-size:11.0pt;mso-fareast-language:EN-US"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;span lang="EN-US" \
style="font-size:11.0pt;mso-fareast-language:EN-US"&gt;By the way, you mentioned that \
there is a libvirt version where &lt;/span&gt;&lt;span style="font-size:11.0pt"&gt;QEMU process \
gets its own dedicated event loop&lt;/span&gt;&lt;span lang="EN-US" style="font-size:11.0pt"&gt;. \
Would you mind sharing this libvirt version with me?&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;span lang="EN-US" \
style="font-size:11.0pt"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;span \
lang="EN-US" style="font-size:11.0pt"&gt;Thanks&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;span lang="EN-US" style="font-size:11.0pt"&gt;Tobias&lt;/span&gt;&lt;span \
lang="EN-US" style="font-size:11.0pt;mso-fareast-language:EN-US"&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class="MsoNormal"&gt;&lt;span lang="EN-US" \
style="font-size:11.0pt;mso-fareast-language:EN-US"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;div \
style="border:none;border-top:solid #B5C4DF 1.0pt;padding:3.0pt 0cm 0cm 0cm"&gt; &lt;p \
class="MsoNormal" style="margin-bottom:12.0pt"&gt;&lt;b&gt;&lt;span \
style="font-size:12.0pt;color:black"&gt;From: &lt;/span&gt;&lt;/b&gt;&lt;span \
style="font-size:12.0pt;color:black"&gt;Daniel P. Berrangé \
&lt;berrange@redhat.com&gt;&lt;br&gt; &lt;b&gt;Date: &lt;/b&gt;Friday, 1. April 2022 at 01:26&lt;br&gt;
&lt;b&gt;To: &lt;/b&gt;Tobias Hofmann (tohofman) &lt;tohofman@cisco.com&gt;&lt;br&gt;
&lt;b&gt;Cc: &lt;/b&gt;libvirt-users@redhat.com &lt;libvirt-users@redhat.com&gt;&lt;br&gt;
&lt;b&gt;Subject: &lt;/b&gt;Re: Debugging hanging libvirt&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div&gt;
&lt;p class="MsoNormal" style="margin-bottom:12.0pt"&gt;&lt;span style="font-size:11.0pt"&gt;On \
Wed, Mar 30, 2022 at 01:11:50AM +0000, Tobias Hofmann (tohofman) wrote:&lt;br&gt; &gt; \
Hello all,&lt;br&gt; &gt; &lt;br&gt;
&gt; I have a system with one VM running. After some time the VM needs to be&lt;br&gt;
&gt; temporarily stopped and started again. This start operation fails and&lt;br&gt;
&gt; from that point on any virsh command is hanging and does not execute.&lt;br&gt;
&gt; This issue is reproducible and I have already figured out that restarting&lt;br&gt;
&gt; libvirtd resolves this issue. However, I’m now trying to understand why&lt;br&gt;
&gt; it’s getting stuck in the first place.&lt;br&gt;
&gt; &lt;br&gt;
&gt; I try not to get too much into detail because I think this would be more&lt;br&gt;
&gt; confusing than it would actually help to understand the problem. In&lt;br&gt;
&gt; general, I’m wondering what approach you should follow to debug why&lt;br&gt;
&gt; libvirt gets stuck.&lt;br&gt;
&gt; Online I’ve read that you should run this command: `# gdb -batch -p&lt;br&gt;
&gt; $(pidof libvirtd) -ex 't a a bt f'`. I’ve run that command and attached&lt;br&gt;
&gt; the output to this mail. However, I have to admit that I have no idea&lt;br&gt;
&gt; what to do with it.&lt;br&gt;
&lt;br&gt;
That's perfect. In that trace we can see two threads of interest&lt;br&gt;
&lt;br&gt;
One thread is attempting to start the QEMU instance:&lt;br&gt;
&lt;br&gt;
    Thread 18 (Thread 0x7f58bcf3e700 (LWP 19010)):&lt;br&gt;
    #0  0x00007f58c9e3a9f5 in pthread_cond_wait@@GLIBC_2.3.2 () \
from /lib64/libpthread.so.0&lt;br&gt;     #1  0x00007f58ccc79e26 in \
virCondWait () from /lib64/libvirt.so.0&lt;br&gt;     #2  \
0x00007f58a046f70b in qemuMonitorSend () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so&lt;br&gt;     \
#3  0x00007f58a04811d0 in qemuMonitorJSONCommandWithFd () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so&lt;br&gt;     \
#4  0x00007f58a0482a01 in qemuMonitorJSONSetCapabilities () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so&lt;br&gt;     \
#5  0x00007f58a044f567 in qemuConnectMonitor () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so&lt;br&gt;     \
#6  0x00007f58a04506f8 in qemuProcessWaitForMonitor () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so&lt;br&gt;     \
#7  0x00007f58a0456a52 in qemuProcessLaunch () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so&lt;br&gt;     \
#8  0x00007f58a045a4b2 in qemuProcessStart () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so&lt;br&gt;     \
#9  0x00007f58a04bd5c6 in qemuDomainObjStart.constprop.50 () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so&lt;br&gt;     \
#10 0x00007f58a04bdd26 in qemuDomainCreateWithFlags () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so&lt;br&gt;     \
#11 0x00007f58cce1524c in virDomainCreate () from /lib64/libvirt.so.0&lt;br&gt; \
    #12 0x000055e7499a3da3 in remoteDispatchDomainCreateHelper ()&lt;br&gt; \
    #13 0x00007f58ccd461d5 in virNetServerProgramDispatch () from \
/lib64/libvirt.so.0&lt;br&gt;     #14 0x00007f58ccd4c9ad in \
virNetServerHandleJob () from /lib64/libvirt.so.0&lt;br&gt;     #15 \
0x00007f58ccc7a831 in virThreadPoolWorker () from /lib64/libvirt.so.0&lt;br&gt; \
    #16 0x00007f58ccc79bb8 in virThreadHelper () from \
/lib64/libvirt.so.0&lt;br&gt;     #17 0x00007f58c9e36e65 in start_thread () \
from /lib64/libpthread.so.0&lt;br&gt;     #18 0x00007f58c9b5f92d in clone () \
from /lib64/libc.so.6&lt;br&gt; &lt;br&gt;
This shows we have started QEMU and are trying to connect to the monitor.&lt;br&gt;
We have queued some data to send and are waiting for the event loop to&lt;br&gt;
send it and get the reply back.&lt;br&gt;
&lt;br&gt;
&lt;br&gt;
The next thread of interest is&lt;br&gt;
&lt;br&gt;
    Thread 1 (Thread 0x7f58cd74c8c0 (LWP 19008)):&lt;br&gt;
    #0  0x00007f58c9e3a35e in pthread_rwlock_wrlock () from \
/lib64/libpthread.so.0&lt;br&gt;     #1  0x00007f58a0b779e7 in \
nwfilterStateReload () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_nwfilter.so&lt;br&gt; \
    #2  0x00007f58a0b77aa5 in nwfilterFirewalldDBusFilter () from \
/usr/lib64/libvirt/connection-driver/libvirt_driver_nwfilter.so&lt;br&gt; \
    #3  0x00007f58ca8f6c5e in dbus_connection_dispatch () from \
/lib64/libdbus-1.so.3&lt;br&gt;     #4  0x00007f58ccc0e421 in \
virDBusWatchCallback () from /lib64/libvirt.so.0&lt;br&gt;     #5  \
0x00007f58ccc193a7 in virEventPollRunOnce () from /lib64/libvirt.so.0&lt;br&gt; \
    #6  0x00007f58ccc17a72 in virEventRunDefaultImpl () from \
/lib64/libvirt.so.0&lt;br&gt;     #7  0x00007f58ccd4c22d in \
virNetDaemonRun () from /lib64/libvirt.so.0&lt;br&gt;     #8  \
0x000055e7499758b9 in main ()&lt;br&gt; &lt;br&gt;
&lt;br&gt;
This is the main event loop thread. Here we see that it is running a&lt;br&gt;
reload operation for the nwfilter driver. This is triggered when something&lt;br&gt;
restarts the firewalld daemon, or requests that it flushes &amp; reloads its&lt;br&gt;
rules.&lt;br&gt;
&lt;br&gt;
This is where the problem is.  The thread starting the QEMU process is&lt;br&gt;
likely holding a read lock on the nwfilter driver, and is waiting for&lt;br&gt;
the event loop thread to finish monitor I/O.&lt;br&gt;
&lt;br&gt;
The event loop thread though is blocked waiting for a write lock on&lt;br&gt;
the nwfilter driver, and this will never come available because the&lt;br&gt;
othre thread holds a read lock and is waiting for this thread.&lt;br&gt;
&lt;br&gt;
&lt;br&gt;
So the root problem here is that we should not be running the reload&lt;br&gt;
code for the nwfilter driver in the main event loop thread, because&lt;br&gt;
it blocks the entire event loop preventing othre threads making&lt;br&gt;
process, and is also dependant on those othuer threads releasing&lt;br&gt;
locks.&lt;br&gt;
&lt;br&gt;
I'm really surprised no one has reported this problem to us before&lt;br&gt;
since its existed forever AFAICT.&lt;br&gt;
&lt;br&gt;
With current libvirt it should be harmless, since each QEMU process&lt;br&gt;
now gets its own dedicated event loop, so would not be blocked by&lt;br&gt;
the main event loop being stalled.&lt;br&gt;
&lt;br&gt;
I think we should none the less fix this by moving the nwfilter&lt;br&gt;
reload code to a background thread, as anything running in the&lt;br&gt;
main event thread is expected to be completing very fast.&lt;br&gt;
&lt;br&gt;
&lt;br&gt;
Back to why you get into this scenario. I guess something on your&lt;br&gt;
system is triggering a firewall reload or restart at exactly the&lt;br&gt;
same time as you are starting the VM. This is pretty strange,&lt;br&gt;
unless you've somehow got this triggered from a hook related to&lt;br&gt;
the VM startup/shutdown ?&lt;br&gt;
&lt;br&gt;
With regards,&lt;br&gt;
Daniel&lt;br&gt;
-- &lt;br&gt;
&gt; &gt; &lt;a href="https://berrange.com"&gt;https://berrange.com&lt;/a&gt;      \
&gt; &gt; -o-    &lt;a href="https://www.flickr.com/photos/dberrange"&gt;
https://www.flickr.com/photos/dberrange&lt;/a&gt; :|&lt;br&gt;
&gt; &gt; &lt;a href="https://libvirt.org"&gt;https://libvirt.org&lt;/a&gt;         \
&gt; &gt; -o-            &lt;a \
&gt; &gt; href="https://fstop138.berrange.com"&gt;
https://fstop138.berrange.com&lt;/a&gt; :|&lt;br&gt;
&gt; &gt; &lt;a href="https://entangle-photo.org"&gt;https://entangle-photo.org&lt;/a&gt;    \
&gt; &gt; -o-    &lt;a href="https://www.instagram.com/dberrange"&gt;
https://www.instagram.com/dberrange&lt;/a&gt; :|&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;



</body></email><email><emailId>20220222150659</emailId><senderName>Daniel =?utf-8?B?UC4gQmVycmFuZ8Op?=</senderName><senderEmail>berrange@redhat.com</senderEmail><timestampReceived>2022-02-22 15:06:59-0400</timestampReceived><subject>Re: libvirtd file descriptors leaking</subject><body>

On Tue, Feb 22, 2022 at 06:00:50PM +0300, Дмитрий wrote:
&gt; Hello, 
&gt; 
&gt; ## SETUP 
&gt; 
&gt; CentOS 8 Stream 
&gt; libguestfs-tools.noarch 1:1.40.2-24.el8.plesk 
&gt; libvirt.x86_64 7.6.0-6.el8s

The current libvirt shipping in CentOS 8 Stream is

8.0.0-2.module_el8.6.0+1087+b42c8331

which is 6 months newer than what you have installed. So I'd recommend
ensuring you have latest CentOS stream content as a first step.

Regards,
Daniel
-- 
|: https://berrange.com      -o-    https://www.flickr.com/photos/dberrange :|
|: https://libvirt.org         -o-            https://fstop138.berrange.com :|
|: https://entangle-photo.org    -o-    https://www.instagram.com/dberrange :|

</body></email><email><emailId>20220222152313</emailId><senderName>Дмитрий</senderName><senderEmail>d.yakovets@maxiplace.ru</senderEmail><timestampReceived>2022-02-22 15:23:13-0400</timestampReceived><subject>Re: libvirtd file descriptors leaking</subject><body>


Updated libvirt with:

# dnf install @virt

Not its 2.module_el8.6.0+1087+b42c8331

Testing:

# virt-df -d kvm3551

But still, issue remains. Here how it looks like in /proc (all these socket/pipe symlinks are broken):

# ls -lah /proc/$(pgrep -f libvirtd)/fd/*

lrwx------ 1 root root 64 фев 22 18:17 /proc/3600693/fd/49 -&gt; 'socket:[99301766]'
lrwx------ 1 root root 64 фев 22 18:13 /proc/3600693/fd/5 -&gt; 'socket:[99234506]'
lrwx------ 1 root root 64 фев 22 18:15 /proc/3600693/fd/51 -&gt; 'socket:[99295594]'
lrwx------ 1 root root 64 фев 22 18:13 /proc/3600693/fd/52 -&gt; 'socket:[99288645]'
lrwx------ 1 root root 64 фев 22 18:15 /proc/3600693/fd/53 -&gt; 'socket:[99296279]'
lrwx------ 1 root root 64 фев 22 18:15 /proc/3600693/fd/54 -&gt; 'socket:[99289772]'
lrwx------ 1 root root 64 фев 22 18:17 /proc/3600693/fd/55 -&gt; 'socket:[99300744]'
lrwx------ 1 root root 64 фев 22 18:15 /proc/3600693/fd/56 -&gt; 'socket:[99284626]'
lrwx------ 1 root root 64 фев 22 18:15 /proc/3600693/fd/57 -&gt; 'socket:[99294777]'
lrwx------ 1 root root 64 фев 22 18:17 /proc/3600693/fd/58 -&gt; 'socket:[99297768]'
lrwx------ 1 root root 64 фев 22 18:15 /proc/3600693/fd/59 -&gt; 'socket:[99279867]'
lrwx------ 1 root root 64 фев 22 18:13 /proc/3600693/fd/6 -&gt; 'socket:[99282298]'
lrwx------ 1 root root 64 фев 22 18:13 /proc/3600693/fd/60 -&gt; 'socket:[99286467]'
l-wx------ 1 root root 64 фев 22 18:13 /proc/3600693/fd/7 -&gt; /run/libvirtd.pid
lrwx------ 1 root root 64 фев 22 18:15 /proc/3600693/fd/70 -&gt; 'socket:[99286794]'
lr-x------ 1 root root 64 фев 22 18:13 /proc/3600693/fd/8 -&gt; 'pipe:[99282299]'
lrwx------ 1 root root 64 фев 22 18:15 /proc/3600693/fd/81 -&gt; 'socket:[99281902]'
lrwx------ 1 root root 64 фев 22 18:13 /proc/3600693/fd/82 -&gt; 'socket:[99288059]'
lrwx------ 1 root root 64 фев 22 18:13 /proc/3600693/fd/84 -&gt; 'socket:[99285702]'
lrwx------ 1 root root 64 фев 22 18:15 /proc/3600693/fd/85 -&gt; 'socket:[99300385]'
lrwx------ 1 root root 64 фев 22 18:13 /proc/3600693/fd/88 -&gt; 'socket:[99291046]'
lrwx------ 1 root root 64 фев 22 18:15 /proc/3600693/fd/89 -&gt; 'socket:[99299347]'
l-wx------ 1 root root 64 фев 22 18:13 /proc/3600693/fd/9 -&gt; 'pipe:[99282299]'
lrwx------ 1 root root 64 фев 22 18:15 /proc/3600693/fd/92 -&gt; 'socket:[99284744]'


</body></email><email><emailId>20220222153334</emailId><senderName>Daniel =?utf-8?B?UC4gQmVycmFuZ8Op?=</senderName><senderEmail>berrange@redhat.com</senderEmail><timestampReceived>2022-02-22 15:33:34-0400</timestampReceived><subject>Re: libvirtd file descriptors leaking</subject><body>

On Tue, Feb 22, 2022 at 06:23:13PM +0300, Дмитрий wrote:
&gt; 
&gt; Updated libvirt with:
&gt; 
&gt; # dnf install @virt
&gt; 
&gt; Not its 2.module_el8.6.0+1087+b42c8331
&gt; 
&gt; Testing:
&gt; 
&gt; # virt-df -d kvm3551
&gt; 
&gt; But still, issue remains. Here how it looks like in /proc (all these socket/pipe symlinks are broken):
&gt; 
&gt; # ls -lah /proc/$(pgrep -f libvirtd)/fd/*
&gt; 
&gt; lrwx------ 1 root root 64 фев 22 18:17 /proc/3600693/fd/49 -&gt; 'socket:[99301766]'
&gt; lrwx------ 1 root root 64 фев 22 18:13 /proc/3600693/fd/5 -&gt; 'socket:[99234506]'
&gt; lrwx------ 1 root root 64 фев 22 18:15 /proc/3600693/fd/51 -&gt; 'socket:[99295594]'
&gt; lrwx------ 1 root root 64 фев 22 18:13 /proc/3600693/fd/52 -&gt; 'socket:[99288645]'
&gt; lrwx------ 1 root root 64 фев 22 18:15 /proc/3600693/fd/53 -&gt; 'socket:[99296279]'
&gt; lrwx------ 1 root root 64 фев 22 18:15 /proc/3600693/fd/54 -&gt; 'socket:[99289772]'
&gt; lrwx------ 1 root root 64 фев 22 18:17 /proc/3600693/fd/55 -&gt; 'socket:[99300744]'
&gt; lrwx------ 1 root root 64 фев 22 18:15 /proc/3600693/fd/56 -&gt; 'socket:[99284626]'
&gt; lrwx------ 1 root root 64 фев 22 18:15 /proc/3600693/fd/57 -&gt; 'socket:[99294777]'
&gt; lrwx------ 1 root root 64 фев 22 18:17 /proc/3600693/fd/58 -&gt; 'socket:[99297768]'
&gt; lrwx------ 1 root root 64 фев 22 18:15 /proc/3600693/fd/59 -&gt; 'socket:[99279867]'
&gt; lrwx------ 1 root root 64 фев 22 18:13 /proc/3600693/fd/6 -&gt; 'socket:[99282298]'
&gt; lrwx------ 1 root root 64 фев 22 18:13 /proc/3600693/fd/60 -&gt; 'socket:[99286467]'
&gt; l-wx------ 1 root root 64 фев 22 18:13 /proc/3600693/fd/7 -&gt; /run/libvirtd.pid
&gt; lrwx------ 1 root root 64 фев 22 18:15 /proc/3600693/fd/70 -&gt; 'socket:[99286794]'
&gt; lr-x------ 1 root root 64 фев 22 18:13 /proc/3600693/fd/8 -&gt; 'pipe:[99282299]'
&gt; lrwx------ 1 root root 64 фев 22 18:15 /proc/3600693/fd/81 -&gt; 'socket:[99281902]'
&gt; lrwx------ 1 root root 64 фев 22 18:13 /proc/3600693/fd/82 -&gt; 'socket:[99288059]'
&gt; lrwx------ 1 root root 64 фев 22 18:13 /proc/3600693/fd/84 -&gt; 'socket:[99285702]'
&gt; lrwx------ 1 root root 64 фев 22 18:15 /proc/3600693/fd/85 -&gt; 'socket:[99300385]'
&gt; lrwx------ 1 root root 64 фев 22 18:13 /proc/3600693/fd/88 -&gt; 'socket:[99291046]'
&gt; lrwx------ 1 root root 64 фев 22 18:15 /proc/3600693/fd/89 -&gt; 'socket:[99299347]'
&gt; l-wx------ 1 root root 64 фев 22 18:13 /proc/3600693/fd/9 -&gt; 'pipe:[99282299]'
&gt; lrwx------ 1 root root 64 фев 22 18:15 /proc/3600693/fd/92 -&gt; 'socket:[99284744]'

It is generally more useful to use 'lsof -p $LIBVIRT_PID', so you
get readable names for sockets.

Also compare before &amp; after so you can identify which is the new
"leaked" file.

Also is that a one time leak, or is a new FD leaked for every
virt-df command that is run ?

Regards,
Daniel
-- 
|: https://berrange.com      -o-    https://www.flickr.com/photos/dberrange :|
|: https://libvirt.org         -o-            https://fstop138.berrange.com :|
|: https://entangle-photo.org    -o-    https://www.instagram.com/dberrange :|

</body></email><email><emailId>20220222153641</emailId><senderName>Дмитрий</senderName><senderEmail>d.yakovets@maxiplace.ru</senderEmail><timestampReceived>2022-02-22 15:36:41-0400</timestampReceived><subject>Re: libvirtd file descriptors leaking</subject><body>

# lsof -p $(cat /run/libvirtd.pid) &gt; run1
# virt-df -d kvm3586
# lsof -p $(cat /run/libvirtd.pid) &gt; run2
# diff run1 run2
196a197
&gt; libvirtd 3618992 root   54u     unix 0xffff902dc0c58440      0t0   99330533 type=STREAM

</body></email><email><emailId>20220301114032</emailId><senderName>Дмитрий</senderName><senderEmail>d.yakovets@maxiplace.ru</senderEmail><timestampReceived>2022-03-01 11:40:32-0400</timestampReceived><subject>Re: libvirtd file descriptors leaking</subject><body>

Any update on this issue? Does anyone have a success on reproducing that? Should I upgrade/downgrade/sidegrade?

Additional info:

I am using CentOS 8 Stream, but with kernel

5.14.15-1.el8.elrepo.x86_64 #1 SMP Tue Oct 26 11:45:20 EDT 2021 x86_64 x86_64 x86_64 GNU/Linux

</body></email><email><emailId>20220201143949</emailId><senderName>Peter Krempa</senderName><senderEmail>pkrempa@redhat.com</senderEmail><timestampReceived>2022-02-01 14:39:49-0400</timestampReceived><subject>Re: udmabuf error with libvirt + QEMU</subject><body>

On Tue, Feb 01, 2022 at 14:27:55 +0000, M, Shivakumar wrote:
&gt; Hi,
&gt; 
&gt; We are seeing an issue with udambuf, where it says "open /dev/udmabuf: No such file \
&gt; or directory " even if the device exits. This issue particularly we are seeing with \
&gt; libvirt. When we run the QEMU args on the command line, everything works as \
&gt; expected. It seems to be some permission issue when we use the Libvirt, please help \
&gt; us on resolving this.

libvirt runs qemu in a mount namespace where we propagate only nodes
from /dev/ which are know and used by libvirt so that the qemu proces is
confined to only what it needs.

Ideally you'll impelemt the support for the 'blob' parameter you are
using in a way which allows the use of the appropriate files for qemu:

&gt; 
&gt; Libvirt XML:
&gt; &lt;?xml version="1.0"?&gt;
&gt; &lt;domain xmlns:qemu=http://libvirt.org/schemas/domain/qemu/1.0 type="kvm"&gt;
&gt; &lt;name&gt;win-vm-0&lt;/name&gt;
&gt; &lt;memory unit="KiB"&gt;4194304&lt;/memory&gt;
&gt; &lt;currentMemory unit="KiB"&gt;4194304&lt;/currentMemory&gt;
&gt; &lt;memoryBacking supported="yes"&gt;
&gt; &lt;source type="memfd"/&gt;
&gt; &lt;/memoryBacking&gt;
&gt; &lt;vcpu&gt;6&lt;/vcpu&gt;
&gt; &lt;os&gt;
&gt; &lt;type arch="x86_64" machine="pc"&gt;hvm&lt;/type&gt;
&gt; &lt;boot dev="hd"/&gt;
&gt; &lt;boot dev="cdrom"/&gt;
&gt; &lt;/os&gt;
&gt; &lt;features&gt;
&gt; &lt;acpi/&gt;
&gt; &lt;apic/&gt;
&gt; &lt;hyperv&gt;
&gt; &lt;relaxed state="on"/&gt;
&gt; &lt;vapic state="on"/&gt;
&gt; &lt;spinlocks state="on" retries="8191"/&gt;
&gt; &lt;/hyperv&gt;
&gt; &lt;vmport state="off"/&gt;
&gt; &lt;/features&gt;
&gt; &lt;cpu mode="host-model"&gt;
&gt; &lt;model fallback="forbid"/&gt;
&gt; &lt;/cpu&gt;
&gt; &lt;clock offset="utc"&gt;
&gt; &lt;/clock&gt;
&gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
&gt; &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
&gt; &lt;on_crash&gt;destroy&lt;/on_crash&gt;
&gt; &lt;devices&gt;
&gt; &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt;
&gt; &lt;disk type="file" device="disk"&gt;
&gt; &lt;driver name="qemu" type="qcow2"/&gt;
&gt; &lt;source file="/win10_enterprise.qcow2" index="1"/&gt;
&gt; &lt;backingStore/&gt;
&gt; &lt;target dev="sda" bus="sata"/&gt;
&gt; &lt;alias name="sata0-0-0"/&gt;
&gt; &lt;address type="drive" controller="0" bus="0" target="0" unit="0"/&gt;
&gt; &lt;/disk&gt;
&gt; &lt;interface type="bridge"&gt;
&gt; &lt;source bridge="br0"/&gt;
&gt; &lt;model type="virtio"/&gt;
&gt; &lt;/interface&gt;
&gt; &lt;serial type="pty"&gt;
&gt; &lt;target port="0"/&gt;
&gt; &lt;target type="serial" port="0"&gt;
&gt; &lt;/target&gt;
&gt; &lt;alias name="serial0"/&gt;
&gt; &lt;/serial&gt;
&gt; &lt;console type="pty"&gt;
&gt; &lt;target type="serial" port="0"/&gt;
&gt; &lt;alias name="serial0"/&gt;
&gt; &lt;/console&gt;
&gt; &lt;hostdev mode="subsystem" type="pci" managed="yes"&gt;
&gt; &lt;driver name="vfio"/&gt;
&gt; &lt;source&gt;
&gt; &lt;address domain="0x0000" bus="0x00" slot="0x02" function="0x02"/&gt;
&gt; &lt;/source&gt;
&gt; &lt;/hostdev&gt;
&gt; &lt;/devices&gt;
&gt; &lt;qemu:commandline&gt;
&gt; &lt;qemu:arg value="-device"/&gt;
&gt; &lt;qemu:arg value="virtio-vga,blob=true"/&gt;
&gt; &lt;qemu:arg value="-display"/&gt;
&gt; &lt;qemu:arg value="gtk,gl=on"/&gt;
&gt; &lt;qemu:env name="DISPLAY" value=":1.0"/&gt;

Libvirt doesn't interpret this in any way so you'll need to implement
support for what you want.

Alternatively as a proof-of-concept/workaround you can set the
'cgroup_device_acl' setting in /etc/libvirt/qemu.conf. But as noted that
is not really a supportable solution.


</body></email><email><emailId>20220201144129</emailId><senderName>Daniel =?utf-8?B?UC4gQmVycmFuZ8Op?=</senderName><senderEmail>berrange@redhat.com</senderEmail><timestampReceived>2022-02-01 14:41:29-0400</timestampReceived><subject>Re: udmabuf error with libvirt + QEMU</subject><body>

On Tue, Feb 01, 2022 at 02:27:55PM +0000, M, Shivakumar wrote:
&gt; Hi,
&gt; 
&gt; We are seeing an issue with udambuf, where it says "open /dev/udmabuf: No such file \
&gt; or directory " even if the device exits. This issue particularly we are seeing with \
&gt; libvirt. When we run the QEMU args on the command line, everything works as \
&gt; expected. It seems to be some permission issue when we use the Libvirt, please help \
&gt; us on resolving this.

When libvirt launches QEMU it puts in place a number of strict
security protections. Libvirt will grant access on a per-file
basis to resources on the host that QEMU should be allowed to
access based on the device configuration in the XML.

In your case though you're using command line passthrough:

&gt; &lt;qemu:commandline&gt;
&gt; &lt;qemu:arg value="-device"/&gt;
&gt; &lt;qemu:arg value="virtio-vga,blob=true"/&gt;
&gt; &lt;qemu:arg value="-display"/&gt;
&gt; &lt;qemu:arg value="gtk,gl=on"/&gt;
&gt; &lt;qemu:env name="DISPLAY" value=":1.0"/&gt;
&gt; &lt;/qemu:commandline&gt;

This is totally opaque to libvirt and so libvirt won't be
granting access to any resources needed by these args. I'm
assuming /dev/udmabuf is needed by the GTK display for GL
support, or something along those lines.

For further information about your options please consult this page:

  https://libvirt.org/kbase/qemu-passthrough-security.html

Regards,
Daniel
-- 
&gt; &gt; https://berrange.com      -o-    https://www.flickr.com/photos/dberrange :|
&gt; &gt; https://libvirt.org         -o-            https://fstop138.berrange.com :|
&gt; &gt; https://entangle-photo.org    -o-    https://www.instagram.com/dberrange :|


</body></email><email><emailId>20220104105550</emailId><senderName>Daniel =?utf-8?B?UC4gQmVycmFuZ8Op?=</senderName><senderEmail>berrange@redhat.com</senderEmail><timestampReceived>2022-01-04 10:55:50-0400</timestampReceived><subject>Re: simulating multiple hypervisors with the test driver</subject><body>

On Mon, Jan 03, 2022 at 09:06:35PM -0600, Tom Ammon wrote:
&gt; Hello,
&gt; 
&gt; I'm working on a python application that will manage multiple remote
&gt; libvirt hypervisors. I've been using the test:///default uri for
&gt; single-hypervisor tests, and it works great.
&gt; 
&gt; I'd like to simulate connecting to two different remote hypervisors,
&gt; however, in my testing so far it appears that multiple connections to the
&gt; test:///default uri just look like different connections to the same
&gt; hypervisor. Here's what I tried :

Yes, the test:///default URI is shared process-global state.

&gt; What I would like is to be able to spin up two completely independent
&gt; instances of the test driver so that it can simulate two different
&gt; hypervisors/instances of libvirtd.

Pass in a path to a custom XML file for the connection

eg:

   test:///path/to/checkout/of/libvirt.git/examples/xml/test/testnode.xml

every instance of a file base URL will be unique. See this example
file for guidance on how to write the XML to pre-populate arbitrary
resources

Regards,
Daniel
-- 
|: https://berrange.com      -o-    https://www.flickr.com/photos/dberrange :|
|: https://libvirt.org         -o-            https://fstop138.berrange.com :|
|: https://entangle-photo.org    -o-    https://www.instagram.com/dberrange :|

</body></email><email><emailId>20220601114202</emailId><senderName>"Lentes, Bernd"</senderName><senderEmail>bernd.lentes@helmholtz-muenchen.de</senderEmail><timestampReceived>2022-06-01 11:42:02-0400</timestampReceived><subject>Re: how to use "virsh shutdown domain --mode [initctl|signal|paravirt) ?</subject><body>


----- On Jun 1, 2022, at 12:25 PM, Peter Krempa pkrempa@redhat.com wrote:

&gt; On Wed, Jun 01, 2022 at 12:05:58 +0200, Lentes, Bernd wrote:
&gt;&gt; Hi,
&gt;&gt; 
&gt;&gt; ocasionally my Virtual Domains running on a pacmekaer cluster don't shutdown,
&gt;&gt; although beeing told to do it.
&gt;&gt; "virsh help shutdown" says:
&gt;&gt;  ...
&gt;&gt; --mode &lt;string&gt;  shutdown mode: acpi|agent|initctl|signal|paravirt
&gt;&gt; 
&gt;&gt; How is it possible to use initctl or signal or paravirt ?
&gt;&gt; What do i have to do ? What are the prerequisites ?
&gt; 
&gt; I presume you use qemu/kvm as virt, right? 

yes.

&gt; In such case only 'acpi' and
&gt; 'agent' are available.
&gt; 

OK. Interesting.

&gt; 'initctl'/'signal' is meant for LXC containers, and
&gt; 'paravirt' is a mode available for the XEN hypervisor

Thanks.

Bernd
["smime.p7s" (application/pkcs7-signature)]

</body></email><email><emailId>20220607101641</emailId><senderName>Martin Kletzander</senderName><senderEmail>mkletzan@redhat.com</senderEmail><timestampReceived>2022-06-07 10:16:41-0400</timestampReceived><subject>Re: [Libvirt][emulator-cores][dpdk] Emulatorpin cpuset best practices</subject><body>


On Wed, Jun 01, 2022 at 05:57:14PM -0400, Laurent Dumont wrote:
&gt;Hey folks,
&gt;
&gt;I am curious to understand a bit more the core use of the emulatorpin CPUs
&gt;with libvirt.
&gt;
&gt;For example :
&gt;
&gt;    &lt;vcpupin vcpu='0' cpuset='34'/&gt;
&gt;    &lt;vcpupin vcpu='1' cpuset='14'/&gt;
&gt;    &lt;vcpupin vcpu='2' cpuset='10'/&gt;
&gt;    &lt;vcpupin vcpu='3' cpuset='30'/&gt;
&gt;    &lt;emulatorpin cpuset='10,14,30,34'/&gt;
&gt;

qemu launched like this is one process with (at least, but let's omit
that) 5 threads.  There is one thread for each vCPU and an extra thread
for all the extra work not running in the guest.  That can be I/O,
serving the monitor etc.  If you pin it onto the same host CPUs as the
vCPUs then you cannot expect to have enough resources allocated for
serving 100% utilisation in the guest.  But it is of course configurable
because overcommitting is sometimes wanted.

&gt;In this case :
&gt;
&gt;   - The VM has 4 vCPUs.
&gt;   - Each of the core is pinned to a physical/thread core - 34,14,10,30
&gt;   - The emulatorpin is also attached to the same physical CPUs.
&gt;
&gt;In our case :
&gt;
&gt;   - Same setup for cores.
&gt;   - Running DPDK inside the virtual machine.
&gt;   - The compute/libvirt is using OVS but without DPDK.
&gt;
&gt;What we saw is the following :
&gt;
&gt;   - DPDK is polling two cores at 100% to process packets.
&gt;   - From the compute metrics, we see USER %usage at 100% when the
&gt;   application starts.
&gt;   - From the compute metrics, as traffic increases, we see %SYSTEM going
&gt;   up.
&gt;   - As %SYSTEM goes up, %USER goes down.
&gt;
&gt;We are not quite sure, but we are wondering if this could cause a direct
&gt;impact to the ability of DPDK to process traffic at the same X speed?
&gt;
&gt;   - We can "live" move the emulator CPU to other cores.
&gt;   - This seems to be the recommended default setup for VNF/NFV deployments.
&gt;
&gt;
&gt;Feels like I am missing a piece of the puzzle but gotta start somewhere!
&gt;
&gt;Thanks!

["signature.asc" (application/pgp-signature)]

</body></email><email><emailId>20220613183307</emailId><senderName>Gionatan Danti</senderName><senderEmail>g.danti@assyoma.it</senderEmail><timestampReceived>2022-06-13 18:33:07-0400</timestampReceived><subject>Re: vepa-mode directly attached interface</subject><body>

Il 2022-06-13 09:47 Peter Krempa ha scritto:
&gt; If you want it to be more optimized you can e.g. write a script using
&gt; python bindings for libvirt and simply keep the connection open ...
&gt; 
&gt; ... which additionally allows you to register 'domain lifecycle events'
&gt; [1] which give you a trigger when a new VM is defined.

This is a good idea, indeed.
Thank you for suggesting!
Regards.

-- 
Danti Gionatan
Supporto Tecnico
Assyoma S.r.l. - www.assyoma.it
email: g.danti@assyoma.it - info@assyoma.it
GPG public key ID: FF5F32A8

</body></email><email><emailId>20220614075915</emailId><senderName>Tomáš Golembiovský</senderName><senderEmail>tgolembi@redhat.com</senderEmail><timestampReceived>2022-06-14 07:59:15-0400</timestampReceived><subject>Re: Domain XML of a restored VM</subject><body>

On Mon, Jun 13, 2022 at 05:15:13PM +0200, Michal Prívozník wrote:
&gt; On 6/10/22 15:31, Tomáš Golembiovský wrote:
&gt; &gt; Hi,
&gt; &gt; 
&gt; &gt; I am looking for clarification on what exactly is happening to the
&gt; &gt; domain XML when resuming a suspended VM. We would like to make sure we
&gt; &gt; don't lose any configuration and we also see some unexpected behavior.
&gt; &gt; 
&gt; &gt; The VM with the name/UUID same as resumed VM may or may not already
&gt; &gt; exist. If it does, what role does the original domain XML of a VM play
&gt; &gt; when resuming? Is there any merging taking place between the existing
&gt; &gt; domain XML and the domain XML stored in save image? Is the original XML
&gt; &gt; simply thrown away and replaced?
&gt; &gt; 
&gt; 
&gt; A guest can have up to two XMLs:
&gt; 
&gt; 1) defined guests have so called 'inactive' or 'config' XML. This XML
&gt; does not contain any runtime information, and is used as the initial
&gt; configuration when starting the guest. Once the guest is running, it'll
&gt; also have ...

I see, so this confirms it. When restoring a running VM this XML is not
taken into account at all.

&gt; 2) live XML. This XML contains runtime information and because of
&gt; hotplug and plenty of APIs that tweak various XML knobs
&gt; (virDomainSetMemoryParameters(), virDomainSetInterfaceParameters(),
&gt; etc.) can be very different to the inactive XML. Changes to the live XML
&gt; are thrown away as soon as the guest is shut off and we're back to
&gt; square 1 where only the inactive XML is preserved (and used as the
&gt; initial config for the next run).
&gt; 
&gt; However, this live XML is very important because it reflects the guest
&gt; ABI. For instance, some of our APIs offer a way for users to supply
&gt; modified domain XML (as you say below, virDomainRestoreFlags() is onw of
&gt; them, migration APIs are another). After this user supplied XML is
&gt; parsed, it's thrown at an excessive ABI stability checker, who's only
&gt; goal is to make sure that the live XML maintained by Libvirt and the
&gt; user provided XML differ only in those ways that won't break guest ABI
&gt; (for instance, changing the port where SPICE is allowed, removing a
&gt; &lt;disk/&gt; isn't).
&gt; 
&gt; Having said all of this - the XML that's saved among the domain by
&gt; virDomainSave() API is the live XML. Because that's the one that
&gt; reflects the current state of the saved image. Inactive XML is
&gt; disconnected from all of this.

&gt; 
&gt; &gt; Is there any difference how the stored XML is treated compared to the
&gt; &gt; XML passed in `virDomainRestoreFlags()`? I see some unexpected changes
&gt; &gt; here. When I use `virDomainSaveImageGetXMLDesc()` to retrieve the stored
&gt; &gt; XML and pass it unchanged to the `virDomainRestoreFlags()` the final
&gt; &gt; domain XML is different then when `virDomainRestore()` is used or when
&gt; &gt; `virDomainRestoreFlags()` with no `dxml` argument is used. We have:
&gt; &gt; 
&gt; &gt;    &lt;graphics ... passwdValidTo='1970-01-01T00:00:01'&gt;
&gt; &gt; 
&gt; &gt; in the domain XML and the `passwdValidTo` argument disappears when
&gt; &gt; domain XML is passed in `dxml` argument but it is preserved in other
&gt; &gt; cases. Is this behavior expected? If yes, can we do anything to preserve
&gt; &gt; the configuration? What other changes in domain XML can be expected?
&gt; 
&gt; No, this behaviour is definitely not expected.
&gt; As explained above, runtime values, that don't affect guest ABI are
&gt; allowed to change. The rest is not. Password timeout should be allowed
&gt; to change, because guest has no idea about the password in the first
&gt; place. This is all done in the backed (that part of SPICE that faces the
&gt; host/clients).

I have already figured out what is happening here. The problem is
missing secrets. Libvirt discards `passwdValidTo` if there is no
`passwd` argument too. The solution is to either supply new password or
use VIR_DOMAIN_SAVE_IMAGE_XML_SECURE flag when retrieving the saved XML.

    Tomas

-- 
Tomáš Golembiovský &lt;tgolembi@redhat.com&gt;

</body></email><email><emailId>20220615094612</emailId><senderName>Jiri Denemark</senderName><senderEmail>jdenemar@redhat.com</senderEmail><timestampReceived>2022-06-15 09:46:12-0400</timestampReceived><subject>Re: After restarted libvirtd service, live migration VM hit an issue 'Target CPU check default does </subject><body>

On Mon, Jun 13, 2022 at 05:06:50 +0000, liang chaojun wrote:
&gt; Thanks Han for your quick response.
&gt; 
&gt; 1. Virsh dumpxml VM from source host machine.
&gt; [cid:fd7f5b1f-8551-4bf8-ae1a-30c7b95065db@jpnprd01.prod.outlook.com]

Next time, please, paste text as text rather than attaching a screenshot
of a terminal with the text. The output of dumpxml --inactive looks
suspicious as it wouldn't normally have check='full' in it unless it was
explicitly mentioned in the XML when the domain was defined.

Anyway, you did not mention how exactly you are migrating your domain,
i.e., the exact command and its parameters. The error message looks like
you're passing a custom XML to the migration command, is that the case?
If so, how does the XML looks like and how did you create it?

Jirka

</body></email><email><emailId>20220616114827</emailId><senderName>Peter Krempa</senderName><senderEmail>pkrempa@redhat.com</senderEmail><timestampReceived>2022-06-16 11:48:27-0400</timestampReceived><subject>Re: managed save returns "migration with virtiofs device is not supported"</subject><body>

On Thu, Jun 16, 2022 at 13:09:11 +0200, Francesc Guasch wrote:
&gt; El 15/6/22 a les 23:25, Ján Tomko ha escrit:
&gt; &gt; On a Wednesday in 2022, Francesc Guasch wrote:
&gt; &gt; &gt; Hello. I have a virtual machine with a virtiofs entry configured.
&gt; &gt; &gt; 
&gt; &gt; &gt; When I try to do a managed save it fails with this message:
&gt; &gt; &gt; 
&gt; &gt; &gt;    libvirt error code: 55, message: Requested operation is not valid:
&gt; &gt; &gt;    migration with virtiofs device is not supported
&gt; &gt; &gt; 
&gt; &gt; 
&gt; &gt; Yes, this is not yet implemented.
&gt; &gt; 
&gt; 
&gt; ok ! Thanks for answering me.
&gt; 
&gt; What still puzzles me is I didn't want to do a migration.
&gt; I just wanted to do managed save.
&gt; 
&gt; Does this error message still applies ?

Saving of the execution state of a VM is basically identical to
migration. In case of qemu it is actually implemented using a migration
into the save file.

Certain configurations simply don't work with it either due to technical
reasons (e.g. restoring state of a hardware device might not be possible
to the extent that it's transparent to the guest OS) or not implemented.

</body></email><email><emailId>20220619172839</emailId><senderName>Gionatan Danti</senderName><senderEmail>g.danti@assyoma.it</senderEmail><timestampReceived>2022-06-19 17:28:39-0400</timestampReceived><subject>Re: Domain XML and VLAN tagging</subject><body>

Il 2022-06-16 16:03 Laine Stump ha scritto:
&gt; On 6/16/22 3:24 AM, Peter Krempa wrote:
&gt;&gt; AFAIK it was simply never implemented. There's also an upstream 
&gt;&gt; feature
&gt;&gt; request for this:
&gt;&gt; 
&gt;&gt; https://gitlab.com/libvirt/libvirt/-/issues/157
&gt; 
&gt; 
&gt; When VLAN tagging was first implemented, Linux host bridges didn't
&gt; have this capability - the only way to get guest traffic transparently
&gt; tagged in that case was by having the bridge attached to a host VLAN
&gt; interface rather than directly to the physical ethernet (resulting in
&gt; the traffic from all guests attached to the bridge being
&gt; tagged/untagged). A few years later support for tagging on individual
&gt; host bridge ports was aded to the Linux bridge driver, but there was
&gt; never enough push for the feature to get it added to libvirt.
&gt; 
&gt; "Patches are welcome" of course!

Thank you both,
Regards.

-- 
Danti Gionatan
Supporto Tecnico
Assyoma S.r.l. - www.assyoma.it
email: g.danti@assyoma.it - info@assyoma.it
GPG public key ID: FF5F32A8

</body></email><email><emailId>20220628134809</emailId><senderName>Anonymous Aardvark</senderName><senderEmail>anonymousaard22@gmail.com</senderEmail><timestampReceived>2022-06-28 13:48:09-0400</timestampReceived><subject>libvirt and Ledger Nano or hotswappable single USB port with virt-manager - almost there?</subject><body>

Hi

I am holding off on a full VFIO system (with a host just used for hosting
and main hardware forwarded) until after a build a new PC for the coming
generation of graphics cards but I have started using virt-manager to
partition my workspaces.

My host is Ubuntu 20.04 running QEMU v 5.0 on and Intel i5-4690K CPU and
GA-Z97X-Gaming 5 motherboard. Guest is Debian 11.

I am trying to solve the issue of how the Ledger Nano X changes its product
ID when using different applications
&lt;https://imil.net/blog/posts/2020/ledger_on_kvm/&gt;. Unfortunately all ports
seem to be in the same IOMMU group so I cannot just forward a controller. I
have learned that although my temporary fallback Virtualbox allows
forwarding by vendor ID without a product ID
&lt;https://www.reddit.com/r/ledgerwallet/comments/mf872x/how_can_you_run_ledger_live_nano_wallet_on/&gt;,
 and I have seen some libvirt references to this, including mention of a
patch that apparently should have been implemented I have not been able to
make it work:

from QEMU to libvirt(virsh) - add USB-port
&lt;https://stackoverflow.com/questions/46421962/from-qemu-to-libvirtvirsh-add-usb-port&gt;
Can I pass through a USB Port via qemu Command Line?
&lt;https://unix.stackexchange.com/questions/452934/can-i-pass-through-a-usb-port-via-qemu-command-line&gt;


Detail on on my comprehensive hotplugger attempts to forward a single port
here
&lt;https://www.reddit.com/r/VFIO/comments/lbvgpr/comment/idzml1k/?utm_source=share&amp;utm_medium=web2x&amp;context=3&gt;
                
.

Can you please tell me if there is some way I can edit either my debian.xml
or how hotplugger interacts with the socket so that I can forward a single
port that is hotswapable and/or so that Ledger Nano X will stay visible on
the guest even after it changes product ID?

Thanks

Aard.


[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;&lt;div class="gmail-"&gt;&lt;div class="gmail-public-DraftStyleDefault-block \
gmail-public-DraftStyleDefault-ltr"&gt;Hi&lt;/div&gt;&lt;div \
class="gmail-public-DraftStyleDefault-block \
gmail-public-DraftStyleDefault-ltr"&gt;&lt;br&gt;&lt;/div&gt;&lt;div \
class="gmail-public-DraftStyleDefault-block gmail-public-DraftStyleDefault-ltr"&gt;I am \
holding off on a full VFIO system (with a host just used for hosting and main \
hardware forwarded) until after a build a new PC for the coming generation of \
graphics cards but I have started using virt-manager to partition my \
workspaces.&lt;/div&gt;&lt;div class="gmail-public-DraftStyleDefault-block \
gmail-public-DraftStyleDefault-ltr"&gt;&lt;br&gt;&lt;/div&gt;&lt;div \
class="gmail-public-DraftStyleDefault-block gmail-public-DraftStyleDefault-ltr"&gt;My \
host is Ubuntu 20.04 running QEMU v 5.0 on and Intel i5-4690K CPU and GA-Z97X-Gaming \
5 motherboard. Guest is Debian 11.&lt;br&gt;&lt;/div&gt;&lt;div \
class="gmail-public-DraftStyleDefault-block \
gmail-public-DraftStyleDefault-ltr"&gt;&lt;br&gt;&lt;/div&gt;&lt;div \
class="gmail-public-DraftStyleDefault-block gmail-public-DraftStyleDefault-ltr"&gt;I am \
trying to solve the issue of how &lt;a \
href="https://imil.net/blog/posts/2020/ledger_on_kvm/" \
class="gmail-_1FRfMxEAy__7c8vezYv9qP"&gt;the Ledger Nano X changes its product ID when \
using different applications&lt;/a&gt;. Unfortunately all ports seem to be in the same \
IOMMU group so I cannot just forward a controller. I  have learned that although my \
temporary fallback Virtualbox &lt;a \
href="https://www.reddit.com/r/ledgerwallet/comments/mf872x/how_can_you_run_ledger_live_nano_wallet_on/" \
class="gmail-_1FRfMxEAy__7c8vezYv9qP"&gt;allows forwarding by vendor ID without a \
product ID&lt;/a&gt;, and I have seen some libvirt references to this, including mention of \
a patch that apparently should have been implemented I have not been able to make it \
work:&lt;/div&gt;&lt;/div&gt;&lt;div class="gmail-"&gt;&lt;div class="gmail-public-DraftStyleDefault-block \
gmail-public-DraftStyleDefault-ltr"&gt;&lt;br&gt;&lt;/div&gt;&lt;div \
class="gmail-public-DraftStyleDefault-block gmail-public-DraftStyleDefault-ltr"&gt;&lt;a \
href="https://stackoverflow.com/questions/46421962/from-qemu-to-libvirtvirsh-add-usb-port" \
class="gmail-_1FRfMxEAy__7c8vezYv9qP"&gt;from QEMU to libvirt(virsh) - add \
USB-port&lt;/a&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="gmail-"&gt;&lt;div \
class="gmail-public-DraftStyleDefault-block gmail-public-DraftStyleDefault-ltr"&gt;&lt;a \
href="https://unix.stackexchange.com/questions/452934/can-i-pass-through-a-usb-port-via-qemu-command-line" \
class="gmail-_1FRfMxEAy__7c8vezYv9qP"&gt;Can I pass through a USB Port via qemu Command \
Line?&lt;/a&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="gmail-"&gt;&lt;div \
class="gmail-public-DraftStyleDefault-block \
gmail-public-DraftStyleDefault-ltr"&gt;&lt;br&gt;&lt;/div&gt;&lt;div \
class="gmail-public-DraftStyleDefault-block \
gmail-public-DraftStyleDefault-ltr"&gt;Detail on on my comprehensive hotplugger attempts \
to forward a single port &lt;a \
href="https://www.reddit.com/r/VFIO/comments/lbvgpr/comment/idzml1k/?utm_source=share&amp;utm_medium=web2x&amp;context=3" \
class="gmail-_1FRfMxEAy__7c8vezYv9qP"&gt;here&lt;/a&gt;.&lt;/div&gt;&lt;/div&gt;&lt;div class="gmail-"&gt;&lt;div \
class="gmail-public-DraftStyleDefault-block \
gmail-public-DraftStyleDefault-ltr"&gt;&lt;br&gt;&lt;/div&gt;&lt;div \
class="gmail-public-DraftStyleDefault-block gmail-public-DraftStyleDefault-ltr"&gt;Can \
you please tell me if there is some way I can edit either my debian.xml or how \
hotplugger interacts with the socket so that I can forward a single port that is \
hotswapable and/or so that Ledger Nano X will stay visible on the guest even after it \
changes product ID?&lt;/div&gt;&lt;div class="gmail-public-DraftStyleDefault-block \
gmail-public-DraftStyleDefault-ltr"&gt;&lt;br&gt;&lt;/div&gt;&lt;div \
class="gmail-public-DraftStyleDefault-block \
gmail-public-DraftStyleDefault-ltr"&gt;Thanks&lt;/div&gt;&lt;div \
class="gmail-public-DraftStyleDefault-block \
gmail-public-DraftStyleDefault-ltr"&gt;&lt;br&gt;&lt;/div&gt;&lt;div \
class="gmail-public-DraftStyleDefault-block \
gmail-public-DraftStyleDefault-ltr"&gt;Aard.&lt;/div&gt;&lt;div \
class="gmail-public-DraftStyleDefault-block \
gmail-public-DraftStyleDefault-ltr"&gt;&lt;br&gt;&lt;/div&gt;&lt;div \
class="gmail-public-DraftStyleDefault-block \
gmail-public-DraftStyleDefault-ltr"&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="gmail-"&gt;&lt;div \
class="gmail-public-DraftStyleDefault-block \
gmail-public-DraftStyleDefault-ltr"&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220628162405</emailId><senderName>"dberrange () yahoo ! com"</senderName><senderEmail>dberrange@yahoo.com</senderEmail><timestampReceived>2022-06-28 16:24:05-0400</timestampReceived><subject>Re: Testing DKIM handling</subject><body>

Another test of DKIM handling in Red Hat mail servers, apologies for the continued nuisance.
    On Wednesday, 8 June 2022 at 13:58:39 BST, dberrange@yahoo.com &lt;dberrange@yahoo.com&gt; wrote:  
 
  
Further DKIM handling test, apologies for the noise.
    On Friday, 13 May 2022, 10:03:32 BST, dberrange@yahoo.com &lt;dberrange@yahoo.com&gt; wrote:  
 
 Testing DKIM handling RH mail servers
    
[Attachment #3 (text/html)]

&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;div class="ydp5812b662yahoo-style-wrap" \
style="font-family:Helvetica Neue, Helvetica, Arial, \
sans-serif;font-size:16px;"&gt;&lt;div&gt;&lt;/div&gt;  &lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div dir="ltr" \
data-setdir="false"&gt;Another test of DKIM handling in Red Hat mail servers, apologies \
for the continued nuisance.&lt;/div&gt;&lt;div dir="ltr" data-setdir="false"&gt;&lt;br&gt;&lt;/div&gt;  
        &lt;/div&gt;&lt;div id="yahoo_quoted_6739749392" class="yahoo_quoted"&gt;
            &lt;div style="font-family:'Helvetica Neue', Helvetica, Arial, \
sans-serif;font-size:13px;color:#26282a;"&gt;  
                &lt;div&gt;
                    On Wednesday, 8 June 2022 at 13:58:39 BST, dberrange@yahoo.com \
&lt;dberrange@yahoo.com&gt; wrote:  &lt;/div&gt;
                &lt;div&gt;&lt;br&gt;&lt;/div&gt;
                &lt;div&gt;&lt;br&gt;&lt;/div&gt;
                &lt;div&gt;&lt;div id="yiv5458276099"&gt;&lt;div&gt;&lt;div style="font-family:Helvetica \
Neue, Helvetica, Arial, sans-serif;font-size:16px;" \
                class="yiv5458276099ydp2bdcabaeyahoo-style-wrap"&gt;&lt;div&gt;&lt;/div&gt;
        &lt;div&gt;&lt;br clear="none"&gt;&lt;/div&gt;&lt;div dir="ltr"&gt;Further DKIM handling test, \
apologies for the noise.&lt;br clear="none"&gt;&lt;/div&gt;  
        &lt;/div&gt;&lt;div id="yiv5458276099yqt17059" class="yiv5458276099yqt5088004138"&gt;&lt;div \
                id="yiv5458276099yahoo_quoted_5170972316" \
                class="yiv5458276099yahoo_quoted"&gt;
            &lt;div style="font-family:'Helvetica Neue', Helvetica, Arial, \
sans-serif;font-size:13px;color:#26282a;"&gt;  
                &lt;div&gt;
                    On Friday, 13 May 2022, 10:03:32 BST, dberrange@yahoo.com \
&lt;dberrange@yahoo.com&gt; wrote:  &lt;/div&gt;
                &lt;div&gt;&lt;br clear="none"&gt;&lt;/div&gt;
                &lt;div&gt;&lt;br clear="none"&gt;&lt;/div&gt;
                &lt;div&gt;&lt;div id="yiv5458276099"&gt;&lt;div&gt;&lt;div style="font-family:Helvetica \
Neue, Helvetica, Arial, sans-serif;font-size:16px;" \
class="yiv5458276099yahoo-style-wrap"&gt;&lt;div dir="ltr"&gt;Testing DKIM handling RH mail \
servers&lt;br clear="none"&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;  &lt;/div&gt;
        &lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;&lt;/body&gt;&lt;/html&gt;



</body></email><email><emailId>20220629155828</emailId><senderName>Charles Koprowski</senderName><senderEmail>charles@koprow.ski</senderEmail><timestampReceived>2022-06-29 15:58:28-0400</timestampReceived><subject>Re: Storage Pool - NFS v4.1</subject><body>

Le jeu. 23 juin 2022 Ã  17:19, Peter Krempa &lt;pkrempa@redhat.com&gt; a Ã©crit :

&gt;
&gt; I've posted a patch that fixes this:
&gt;
&gt; https://listman.redhat.com/archives/libvir-list/2022-June/232541.html
&gt;
&gt;
Thank you !

This has been reported to Canonical support :
https://bugs.launchpad.net/ubuntu/+source/libvirt/+bug/1980134

-- 
Charles

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;&lt;div dir="ltr"&gt;Le  jeu. 23 juin 2022 Ã   17:19, Peter Krempa &lt;&lt;a \
href="mailto:pkrempa@redhat.com"&gt;pkrempa@redhat.com&lt;/a&gt;&gt; a Ã©crit  :&lt;br&gt;&lt;/div&gt;&lt;div \
class="gmail_quote"&gt;&lt;blockquote class="gmail_quote" style="margin:0px 0px 0px \
0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"&gt; &lt;br&gt;
I've posted a patch that fixes this:&lt;br&gt;
&lt;br&gt;
&lt;a href="https://listman.redhat.com/archives/libvir-list/2022-June/232541.html" \
rel="noreferrer" target="_blank"&gt;https://listman.redhat.com/archives/libvir-list/2022-June/232541.html&lt;/a&gt;&lt;br&gt;
 &lt;br&gt;
&lt;/blockquote&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;Thank you !&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This has been \
reported to Canonical support :  &lt;a \
href="https://bugs.launchpad.net/ubuntu/+source/libvirt/+bug/1980134"&gt;https://bugs.launchpad.net/ubuntu/+source/libvirt/+bug/1980134&lt;/a&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;-- \
&lt;br&gt;&lt;div dir="ltr" class="gmail_signature"&gt;&lt;div \
dir="ltr"&gt;Charles&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220506110241</emailId><senderName>lejeczek</senderName><senderEmail>peljasz@yahoo.co.uk</senderEmail><timestampReceived>2022-05-06 11:02:41-0400</timestampReceived><subject>virtqemud high CPU load</subject><body>

Hi guys,

Anybody on centos9?
With latest updates I get 100% load (so one core fully 
loaded) almost all the time, I don't remember that being the 
case before.
'virtqemud' itself does not log much, with default verbosity.

Any thoughts?
many thanks, L.

</body></email><email><emailId>20220510094855</emailId><senderName>Jeff Brown</senderName><senderEmail>jeff@ff.co.za</senderEmail><timestampReceived>2022-05-10 09:48:55-0400</timestampReceived><subject>Any size limitation on the backing store?</subject><body>

We have a few QCOW2 images that have grown rather large (&gt; 250GB) and to 
back them up across the VLAN is resource intensive and time consuming.

What I'd like to do to optimise backups is freeze the backing store and 
always run the VMs in 'snapshot 1', and then run 'snapshot 2' to backup 
'snapshot 1' to reciprocal failover hypervisors in the DC.

I do know it's common practice to even run multiple VMs off a single 
"golden image" backing store, but I'm concerned about the performance 
impact with such a large backing store, and 'snapshot 1' growing at 
~10GB a year. With that in mind, it should be feasible to pivot 
'snapshot 1' into the backing image periodically.

Further, I am aware of incremental backups which Debian 11 doesn't yet 
support. I think it's coming in Debian 12, but some of our servers are 
actually still on Debian 10.

jeff@abacus:/var/lib/libvirt/images$ virsh backup-begin dev
error: Operation not supported: incremental backup is not supported yet

In a nutshell, is it feasible to run off an &gt; 250GB and growing backing 
store?

Thanks in advance for any advice.

-- 
Jeff Brown
Future Foundation
Cell 074 101 5170
VoIP 087 550 1210
Fax: 086 532 3508

[Attachment #3 (text/html)]

&lt;html&gt;
  &lt;head&gt;

    &lt;meta http-equiv="content-type" content="text/html; charset=UTF-8"&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;p&gt;We have a few QCOW2 images that have grown rather large (&gt;
      250GB) and to back them up across the VLAN is resource intensive
      and time consuming.&lt;/p&gt;
    &lt;p&gt;What I'd like to do to optimise backups is freeze the backing
      store and always run the VMs in 'snapshot 1', and then run
      'snapshot 2' to backup 'snapshot 1' to reciprocal failover
      hypervisors in the DC.&lt;/p&gt;
    &lt;p&gt;I do know it's common practice to even run multiple VMs off a
      single "golden image" backing store, but I'm concerned about the
      performance impact with such a large backing store, and 'snapshot
      1' growing at ~10GB a year. With that in mind, it should be
      feasible to pivot 'snapshot 1' into the backing image
      periodically.&lt;/p&gt;
    &lt;p&gt;Further, I am aware of incremental backups which Debian 11
      doesn't yet support. I think it's coming in Debian 12, but some of
      our servers are actually still on Debian 10.&lt;br&gt;
    &lt;/p&gt;
    &lt;p&gt;&lt;span style="font-family:monospace"&gt;&lt;font color="#21a621"&gt;&lt;span
            style="font-weight: bold; background-color: rgb(255, 255,
            255);"&gt;jeff@abacus&lt;/span&gt;&lt;/font&gt;&lt;span
          style="color:#000000;background-color:#ffffff;"&gt;:&lt;/span&gt;&lt;span
style="font-weight:bold;color:#5454ff;background-color:#ffffff;"&gt;/var/lib/libvirt/images&lt;/span&gt;&lt;span
          style="color:#000000;background-color:#ffffff;"&gt;$ virsh
          backup-begin dev
        &lt;/span&gt;&lt;br&gt;
        error: Operation not supported: incremental backup is not
        supported yet&lt;/span&gt;&lt;br&gt;
    &lt;/p&gt;
    &lt;p&gt;In a nutshell, is it feasible to run off an &gt; 250GB and
      growing backing store?&lt;/p&gt;
    &lt;p&gt;Thanks in advance for any advice.&lt;br&gt;
    &lt;/p&gt;
    &lt;pre class="moz-signature" cols="72"&gt;-- 
Jeff Brown
Future Foundation
Cell 074 101 5170
VoIP 087 550 1210
Fax: 086 532 3508&lt;/pre&gt;
  &lt;/body&gt;
&lt;/html&gt;


</body></email><email><emailId>20220513090332</emailId><senderName>"dberrange () yahoo ! com"</senderName><senderEmail>dberrange@yahoo.com</senderEmail><timestampReceived>2022-05-13 09:03:32-0400</timestampReceived><subject>Testing DKIM handling</subject><body>

Testing DKIM handling RH mail servers

[Attachment #3 (text/html)]

&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;div class="yahoo-style-wrap" style="font-family:Helvetica \
Neue, Helvetica, Arial, sans-serif;font-size:16px;"&gt;&lt;div dir="ltr" \
data-setdir="false"&gt;Testing DKIM handling RH mail \
servers&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;



</body></email><email><emailId>20220516091455</emailId><senderName>Michal Prívozník</senderName><senderEmail>mprivozn@redhat.com</senderEmail><timestampReceived>2022-05-16 09:14:55-0400</timestampReceived><subject>Re: Problem calling 'virsh' in a script</subject><body>

On 5/15/22 17:48, Digimer wrote:
&gt; Hi all,
&gt; 
&gt;   I've got a series of programs that monitor various things on a CentOS
&gt; Stream 8 VM host. All of these scripts work when called directly.
&gt; However, when I have a parent program that calls all the little programs
&gt; in series, I found that some virsh calls hang.
&gt; 
&gt;   Initially, there were two scripts that were hanging repeatedly. Once
&gt; called 'virsh net-list --all --name', so I changed it to check for
&gt; configs in '/etc/libvirt/qemu/networks/', and that script started
&gt; working. The other script though calls 'virsh list --all', and that
&gt; can't be easily swapped out, so I really need to find the source of
&gt; these hangs.
&gt; 
&gt;   Whenever the hang happens, about 30~45 seconds later, I see
&gt; 'libvirtd[1643714]: Cannot recv data: Connection reset by peer'.
&gt; 
&gt;   I think the issue is striking other scripts that run, but this
&gt; scenario is happening predictably and consistently right now.
&gt; 
&gt;   I thought it might be a concurrent connect limit or a problem with how
&gt; many times virsh is called by a script, so I wrote a test script that
&gt; kept calling 'virsh list --all' each second, but it was close to 100
&gt; calls without hanging, far more that all the calls in my scripts
&gt; combined, so I don't think that's it.
&gt; 
&gt; Any advice/guidance would be very much appreciated!

I wonder whether specifying the connection URI explicitly would help. I
don't know anything about your app, but if it perhaps clears some env
vars (LIBVIRT_DEFAULT_URI VIRSH_DEFAULT_CONNECT_URI) or runs under
different user than what you're testing virsh under then virsh will try
to start a session daemon. If you wan it to connect to the system URI
specify that explicitly:

  virsh -c qemu:///system list ...

Michal

</body></email><email><emailId>20220517072917</emailId><senderName>Darragh Bailey</senderName><senderEmail>daragh.bailey@gmail.com</senderEmail><timestampReceived>2022-05-17 07:29:17-0400</timestampReceived><subject>Re: Updating domains definitions via API</subject><body>

On Mon 16 May 2022, 14:32 Michal Prívozník, &lt;mprivozn@redhat.com&gt; wrote:

&gt; On 5/16/22 14:52, Darragh Bailey wrote:
&gt;
&gt; &gt; So perhaps this is less a bug with the loader/nvram XML element handling
&gt; &gt; and more a documentation bug and a possible enhancement that possibly
&gt; &gt; the virDomainDefineXMLFlags could consider accepting a flag to verify the
&gt; &gt; returned domain XML is equivalent as a general fix for those applications
&gt; &gt; that would find this useful?
&gt;
&gt; Yes to the first part, but no the second. Comparing XMLs is not as easy
&gt; as you would think. For instance:
&gt;
&gt; &lt;domain id='1' type='kvm'&gt;
&gt;   &lt;uuid&gt;123456&lt;/uuid&gt;
&gt;   &lt;name&gt;myGuest&lt;/name&gt;
&gt; &lt;/domain&gt;
&gt;
&gt; &lt;domain type='kvm' id='1'&gt;
&gt;   &lt;name&gt;myGuest&lt;/uuid&gt;
&gt;   &lt;uuid&gt;123456&lt;/uuid&gt;
&gt; &lt;/domain&gt;
&gt;
&gt; The former is just an example of possible user input, the latter is how
&gt; libvirt would format it. Obviously, these XMLs are equivalent, but not
&gt; stcmp() equal.
&gt;

I'm familiar with the fun of checking for equivalence, I was hoping that as
libvirt was working with XML it might already be using a library that could
handle this. A quick look at libxml2 suggests it's been left up to the
consumer to implement.

So each project that becomes aware of this behaviour will have to find a
library to do the comparison or implement it directly themselves.
--
Darragh Bailey

[Attachment #3 (text/html)]

&lt;div dir="auto"&gt;&lt;div&gt;&lt;br&gt;&lt;br&gt;&lt;div data-smartmail="gmail_signature"&gt;&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div \
class="gmail_quote"&gt;&lt;div dir="ltr" class="gmail_attr"&gt;On Mon 16 May 2022, 14:32 \
Michal Prívozník, &lt;&lt;a \
href="mailto:mprivozn@redhat.com"&gt;mprivozn@redhat.com&lt;/a&gt;&gt; \
wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0 0 0 \
.8ex;border-left:1px #ccc solid;padding-left:1ex"&gt;On 5/16/22 14:52, Darragh Bailey \
wrote:&lt;br&gt; &lt;br&gt;
&gt; So perhaps this is less a bug with the loader/nvram XML element handling&lt;br&gt;
&gt; and more a documentation bug and a possible enhancement that possibly&lt;br&gt;
&gt; the virDomainDefineXMLFlags could consider accepting a flag to verify the&lt;br&gt;
&gt; returned domain XML is equivalent as a general fix for those applications&lt;br&gt;
&gt; that would find this useful?&lt;br&gt;
&lt;br&gt;
Yes to the first part, but no the second. Comparing XMLs is not as easy&lt;br&gt;
as you would think. For instance:&lt;br&gt;
&lt;br&gt;
&lt;domain id='1' type='kvm'&gt;&lt;br&gt;
   &lt;uuid&gt;123456&lt;/uuid&gt;&lt;br&gt;
   &lt;name&gt;myGuest&lt;/name&gt;&lt;br&gt;
&lt;/domain&gt;&lt;br&gt;
&lt;br&gt;
&lt;domain type='kvm' id='1'&gt;&lt;br&gt;
   &lt;name&gt;myGuest&lt;/uuid&gt;&lt;br&gt;
   &lt;uuid&gt;123456&lt;/uuid&gt;&lt;br&gt;
&lt;/domain&gt;&lt;br&gt;
&lt;br&gt;
The former is just an example of possible user input, the latter is how&lt;br&gt;
libvirt would format it. Obviously, these XMLs are equivalent, but not&lt;br&gt;
stcmp() equal.&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;&lt;div dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div \
dir="auto"&gt;I'm familiar with the fun of checking for equivalence, I was hoping \
that as libvirt was working with XML it might already be using a library that could \
handle this. A quick look at libxml2 suggests it's been left up to the consumer \
to implement.&lt;/div&gt;&lt;div dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div dir="auto"&gt;So each project that \
becomes aware of this behaviour will have to find a library to do the comparison or \
implement it directly themselves.&lt;/div&gt;&lt;div dir="auto"&gt;--&lt;/div&gt;&lt;div \
dir="auto"&gt;Darragh Bailey&lt;br&gt;&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220519172938</emailId><senderName>Gionatan Danti</senderName><senderEmail>g.danti@assyoma.it</senderEmail><timestampReceived>2022-05-19 17:29:38-0400</timestampReceived><subject>Re: macvtap with disconnected physical interface</subject><body>

Il 2022-05-09 08:42 Gionatan Danti ha scritto:
&gt; Hi all,
&gt; any comment / suggestion on the steps described above? Does a simpler
&gt; approach exists?

Hi list,
any insight on bridge vs macvlan setup previously described? Am I 
over-thinking it?

Thanks.

-- 
Danti Gionatan
Supporto Tecnico
Assyoma S.r.l. - www.assyoma.it
email: g.danti@assyoma.it - info@assyoma.it
GPG public key ID: FF5F32A8

</body></email><email><emailId>20220520031341</emailId><senderName>Petr Beneš</senderName><senderEmail>w.benny@outlook.com</senderEmail><timestampReceived>2022-05-20 03:13:41-0400</timestampReceived><subject>Re: Slow VM start/revert, when trying to start/revert dozens of VMs in parallel</subject><body>

[Attachment #2 (text/plain)]

Sure.
As for flushing/reading from disk - as I said, all VMs reside on ramdisk.
I'd also like to add, that the VMs are "linked-clones" with the same underlying base \
qcow2 - which is also​ in the ramdisk.

```xml
&lt;domain type='kvm'&gt;
  &lt;name&gt;win7-x86-1-101&lt;/name&gt;
  &lt;uuid&gt;dc7296c0-228a-44e8-bd47-db019a1f6344&lt;/uuid&gt;
  &lt;metadata&gt;
    &lt;libosinfo:libosinfo \
xmlns:libosinfo="http://libosinfo.org/xmlns/libvirt/domain/1.0"&gt;  &lt;libosinfo:os \
id="http://microsoft.com/win/10"/&gt;  &lt;/libosinfo:libosinfo&gt;
  &lt;/metadata&gt;
  &lt;memory unit='KiB'&gt;8388608&lt;/memory&gt;
  &lt;currentMemory unit='KiB'&gt;8388608&lt;/currentMemory&gt;
  &lt;vcpu placement='static'&gt;4&lt;/vcpu&gt;
  &lt;os&gt;
    &lt;type arch='x86_64' machine='pc-q35-6.2'&gt;hvm&lt;/type&gt;
    &lt;boot dev='hd'/&gt;
  &lt;/os&gt;
  &lt;features&gt;
    &lt;acpi/&gt;
    &lt;apic/&gt;
    &lt;hyperv mode='custom'&gt;
      &lt;relaxed state='on'/&gt;
      &lt;vapic state='on'/&gt;
      &lt;spinlocks state='on' retries='8191'/&gt;
    &lt;/hyperv&gt;
    &lt;vmcoreinfo state='on'/&gt;
  &lt;/features&gt;
  &lt;cpu mode='host-passthrough' check='none' migratable='on'&gt;
    &lt;topology sockets='1' dies='1' cores='4' threads='1'/&gt;
  &lt;/cpu&gt;
  &lt;clock offset='localtime'&gt;
    &lt;timer name='rtc' tickpolicy='catchup'/&gt;
    &lt;timer name='pit' tickpolicy='delay'/&gt;
    &lt;timer name='hpet' present='no'/&gt;
    &lt;timer name='hypervclock' present='yes'/&gt;
  &lt;/clock&gt;
  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
  &lt;on_crash&gt;preserve&lt;/on_crash&gt;
  &lt;pm&gt;
    &lt;suspend-to-mem enabled='no'/&gt;
    &lt;suspend-to-disk enabled='no'/&gt;
  &lt;/pm&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt;
    &lt;disk type='file' device='disk'&gt;
      &lt;driver name='qemu' type='qcow2'/&gt;
      &lt;source file='/mnt/ramdisk/vms/clones/win7-x86-1-101/image.qcow2'/&gt;
      &lt;target dev='hda' bus='sata'/&gt;
      &lt;address type='drive' controller='0' bus='0' target='0' unit='0'/&gt;
    &lt;/disk&gt;
    &lt;controller type='usb' index='0' model='qemu-xhci' ports='15'&gt;
      &lt;address type='pci' domain='0x0000' bus='0x03' slot='0x00' function='0x0'/&gt;
    &lt;/controller&gt;
    &lt;controller type='sata' index='0'&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x1f' function='0x2'/&gt;
    &lt;/controller&gt;
    &lt;controller type='pci' index='0' model='pcie-root'/&gt;
    &lt;controller type='pci' index='1' model='pcie-root-port'&gt;
      &lt;model name='pcie-root-port'/&gt;
      &lt;target chassis='1' port='0x10'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0' \
multifunction='on'/&gt;  &lt;/controller&gt;
    &lt;controller type='pci' index='2' model='pcie-to-pci-bridge'&gt;
      &lt;model name='pcie-pci-bridge'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x01' slot='0x00' function='0x0'/&gt;
    &lt;/controller&gt;
    &lt;controller type='pci' index='3' model='pcie-root-port'&gt;
      &lt;model name='pcie-root-port'/&gt;
      &lt;target chassis='3' port='0x11'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x1'/&gt;
    &lt;/controller&gt;
    &lt;controller type='pci' index='4' model='pcie-root-port'&gt;
      &lt;model name='pcie-root-port'/&gt;
      &lt;target chassis='4' port='0x12'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x2'/&gt;
    &lt;/controller&gt;
    &lt;controller type='pci' index='5' model='pcie-root-port'&gt;
      &lt;model name='pcie-root-port'/&gt;
      &lt;target chassis='5' port='0x13'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x3'/&gt;
    &lt;/controller&gt;
    &lt;interface type='network'&gt;
      &lt;mac address='52:54:00:bf:7b:01'/&gt;
      &lt;source network='cuckoonet1'/&gt;
      &lt;model type='e1000'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x02' slot='0x01' function='0x0'/&gt;
    &lt;/interface&gt;
    &lt;serial type='pty'&gt;
      &lt;target type='isa-serial' port='0'&gt;
        &lt;model name='isa-serial'/&gt;
      &lt;/target&gt;
    &lt;/serial&gt;
    &lt;console type='pty'&gt;
      &lt;target type='serial' port='0'/&gt;
    &lt;/console&gt;
    &lt;input type='tablet' bus='usb'&gt;
      &lt;address type='usb' bus='0' port='1'/&gt;
    &lt;/input&gt;
    &lt;input type='mouse' bus='ps2'/&gt;
    &lt;input type='keyboard' bus='ps2'/&gt;
    &lt;graphics type='vnc' port='21101' autoport='no' websocket='11101' \
listen='0.0.0.0'&gt;  &lt;listen type='address' address='0.0.0.0'/&gt;
    &lt;/graphics&gt;
    &lt;audio id='1' type='none'/&gt;
    &lt;video&gt;
      &lt;model type='qxl' ram='65536' vram='65536' vgamem='16384' heads='1' \
                primary='yes'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x0'/&gt;
    &lt;/video&gt;
    &lt;memballoon model='virtio'&gt;
      &lt;address type='pci' domain='0x0000' bus='0x04' slot='0x00' function='0x0'/&gt;
    &lt;/memballoon&gt;
    &lt;panic model='hyperv'/&gt;
  &lt;/devices&gt;
&lt;/domain&gt;
```

________________________________
Od: Daniel P. Berrangé &lt;berrange@redhat.com&gt;
Odesláno: úterý 10. května 2022 10:08
Komu: Petr Beneš &lt;w.benny@outlook.com&gt;
Kopie: libvirt-users@redhat.com &lt;libvirt-users@redhat.com&gt;
Předmět: Re: Slow VM start/revert, when trying to start/revert dozens of VMs in \
parallel

On Mon, May 09, 2022 at 06:52:32PM +0000, Petr Beneš wrote:
&gt; Hi,
&gt; 
&gt; my problem can be described simply: libvirt can't handle starting dozens of VMs at \
&gt; the same time. 
&gt; (technically, it can, but it's really slow.)
&gt; 
&gt; We have an AMD machine with 256 logical cores and 1.5T ram.
&gt; On that machine there is roughly 200 VMs.
&gt; Each VM is the same: 8GB of RAM, 4 VCPUs. Half of them is Win7 x86, the other half \
&gt; is Win7 x64. VMs are using qcow2 as the disk image. These images reside in the \
&gt; ramdisk (tmpfs). 
&gt; We use these machines for automatic malware analysis, so our scenario consists of \
&gt;                 this cycle:
&gt; - reverting VM to a running state
&gt; - execute sample inside of the VM for ~1-2 minutes
&gt; - shutdown the VM
&gt; 
&gt; Of course, this results in multiple VMs trying to start at the same time.
&gt; At first, reverts/starts are really fast - second or two.
&gt; After about a minute, the "revertToSnapshot" suddenly takes 10-15 seconds, which is \
&gt; really unacceptable. For comparison, we're running the same scenarion on Proxmox, \
&gt; where the revertToSnapshot usually takes 2 seconds.

Can you share the XML configuration of one of your guests - assuming
they all have the same basic configuration.

As a gut feeling it sounds to me like it could be initially fast due to
utilization of host I/O cache, but then slows down due to having to
flush data to disk / read fresh from disk. This could be the case if
the disk configuration cache mode is set to certain values, so the XML
config will show us this info.

With regards,
Daniel
--
&gt; &gt; https://berrange.com      -o-    https://www.flickr.com/photos/dberrange :|
&gt; &gt; https://libvirt.org         -o-            https://fstop138.berrange.com :|
&gt; &gt; https://entangle-photo.org    -o-    https://www.instagram.com/dberrange :|


[Attachment #3 (text/html)]

&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"&gt;
&lt;style type="text/css" style="display:none;"&gt; P {margin-top:0;margin-bottom:0;} \
&lt;/style&gt; &lt;/head&gt;
&lt;body dir="ltr"&gt;
&lt;div style="font-family: Calibri, Helvetica, sans-serif; font-size: 12pt; color: \
rgb(0, 0, 0); background-color: rgb(255, 255, 255);"&gt; Sure.
&lt;div&gt;As for flushing/reading from disk - as I said, all VMs reside on ramdisk.&lt;/div&gt;
&lt;div&gt;I'd also like to add, that the VMs are "linked-clones" with the same \
underlying base qcow2 - which is also​ in the ramdisk.&lt;/div&gt; &lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;```xml&lt;/div&gt;
&lt;div&gt;&lt;domain type='kvm'&gt;&lt;/div&gt;
&lt;div&gt;  &lt;name&gt;win7-x86-1-101&lt;/name&gt;&lt;/div&gt;
&lt;div&gt;  &lt;uuid&gt;dc7296c0-228a-44e8-bd47-db019a1f6344&lt;/uuid&gt;&lt;/div&gt;
&lt;div&gt;  &lt;metadata&gt;&lt;/div&gt;
&lt;div&gt;    &lt;libosinfo:libosinfo \
xmlns:libosinfo="http://libosinfo.org/xmlns/libvirt/domain/1.0"&gt;&lt;/div&gt; \
&lt;div&gt;      &lt;libosinfo:os \
id="http://microsoft.com/win/10"/&gt;&lt;/div&gt; &lt;div&gt;    \
&lt;/libosinfo:libosinfo&gt;&lt;/div&gt; &lt;div&gt;  &lt;/metadata&gt;&lt;/div&gt;
&lt;div&gt;  &lt;memory unit='KiB'&gt;8388608&lt;/memory&gt;&lt;/div&gt;
&lt;div&gt;  &lt;currentMemory unit='KiB'&gt;8388608&lt;/currentMemory&gt;&lt;/div&gt;
&lt;div&gt;  &lt;vcpu placement='static'&gt;4&lt;/vcpu&gt;&lt;/div&gt;
&lt;div&gt;  &lt;os&gt;&lt;/div&gt;
&lt;div&gt;    &lt;type arch='x86_64' \
machine='pc-q35-6.2'&gt;hvm&lt;/type&gt;&lt;/div&gt; &lt;div&gt;    &lt;boot \
dev='hd'/&gt;&lt;/div&gt; &lt;div&gt;  &lt;/os&gt;&lt;/div&gt;
&lt;div&gt;  &lt;features&gt;&lt;/div&gt;
&lt;div&gt;    &lt;acpi/&gt;&lt;/div&gt;
&lt;div&gt;    &lt;apic/&gt;&lt;/div&gt;
&lt;div&gt;    &lt;hyperv mode='custom'&gt;&lt;/div&gt;
&lt;div&gt;      &lt;relaxed state='on'/&gt;&lt;/div&gt;
&lt;div&gt;      &lt;vapic state='on'/&gt;&lt;/div&gt;
&lt;div&gt;      &lt;spinlocks state='on' retries='8191'/&gt;&lt;/div&gt;
&lt;div&gt;    &lt;/hyperv&gt;&lt;/div&gt;
&lt;div&gt;    &lt;vmcoreinfo state='on'/&gt;&lt;/div&gt;
&lt;div&gt;  &lt;/features&gt;&lt;/div&gt;
&lt;div&gt;  &lt;cpu mode='host-passthrough' check='none' migratable='on'&gt;&lt;/div&gt;
&lt;div&gt;    &lt;topology sockets='1' dies='1' cores='4' threads='1'/&gt;&lt;/div&gt;
&lt;div&gt;  &lt;/cpu&gt;&lt;/div&gt;
&lt;div&gt;  &lt;clock offset='localtime'&gt;&lt;/div&gt;
&lt;div&gt;    &lt;timer name='rtc' tickpolicy='catchup'/&gt;&lt;/div&gt;
&lt;div&gt;    &lt;timer name='pit' tickpolicy='delay'/&gt;&lt;/div&gt;
&lt;div&gt;    &lt;timer name='hpet' present='no'/&gt;&lt;/div&gt;
&lt;div&gt;    &lt;timer name='hypervclock' present='yes'/&gt;&lt;/div&gt;
&lt;div&gt;  &lt;/clock&gt;&lt;/div&gt;
&lt;div&gt;  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;&lt;/div&gt;
&lt;div&gt;  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;&lt;/div&gt;
&lt;div&gt;  &lt;on_crash&gt;preserve&lt;/on_crash&gt;&lt;/div&gt;
&lt;div&gt;  &lt;pm&gt;&lt;/div&gt;
&lt;div&gt;    &lt;suspend-to-mem enabled='no'/&gt;&lt;/div&gt;
&lt;div&gt;    &lt;suspend-to-disk enabled='no'/&gt;&lt;/div&gt;
&lt;div&gt;  &lt;/pm&gt;&lt;/div&gt;
&lt;div&gt;  &lt;devices&gt;&lt;/div&gt;
&lt;div&gt;    &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt;&lt;/div&gt;
&lt;div&gt;    &lt;disk type='file' device='disk'&gt;&lt;/div&gt;
&lt;div&gt;      &lt;driver name='qemu' type='qcow2'/&gt;&lt;/div&gt;
&lt;div&gt;      &lt;source \
file='/mnt/ramdisk/vms/clones/win7-x86-1-101/image.qcow2'/&gt;&lt;/div&gt; &lt;div&gt;  \
    &lt;target dev='hda' bus='sata'/&gt;&lt;/div&gt; &lt;div&gt;      \
&lt;address type='drive' controller='0' bus='0' target='0' unit='0'/&gt;&lt;/div&gt; \
&lt;div&gt;    &lt;/disk&gt;&lt;/div&gt; &lt;div&gt;    &lt;controller type='usb' \
index='0' model='qemu-xhci' ports='15'&gt;&lt;/div&gt; &lt;div&gt;      \
&lt;address type='pci' domain='0x0000' bus='0x03' slot='0x00' \
function='0x0'/&gt;&lt;/div&gt; &lt;div&gt;    &lt;/controller&gt;&lt;/div&gt;
&lt;div&gt;    &lt;controller type='sata' index='0'&gt;&lt;/div&gt;
&lt;div&gt;      &lt;address type='pci' domain='0x0000' bus='0x00' \
slot='0x1f' function='0x2'/&gt;&lt;/div&gt; &lt;div&gt;    &lt;/controller&gt;&lt;/div&gt;
&lt;div&gt;    &lt;controller type='pci' index='0' model='pcie-root'/&gt;&lt;/div&gt;
&lt;div&gt;    &lt;controller type='pci' index='1' \
model='pcie-root-port'&gt;&lt;/div&gt; &lt;div&gt;      &lt;model \
name='pcie-root-port'/&gt;&lt;/div&gt; &lt;div&gt;      &lt;target chassis='1' \
port='0x10'/&gt;&lt;/div&gt; &lt;div&gt;      &lt;address type='pci' \
domain='0x0000' bus='0x00' slot='0x02' function='0x0' multifunction='on'/&gt;&lt;/div&gt; \
&lt;div&gt;    &lt;/controller&gt;&lt;/div&gt; &lt;div&gt;    &lt;controller \
type='pci' index='2' model='pcie-to-pci-bridge'&gt;&lt;/div&gt; &lt;div&gt;      \
&lt;model name='pcie-pci-bridge'/&gt;&lt;/div&gt; &lt;div&gt;      &lt;address \
type='pci' domain='0x0000' bus='0x01' slot='0x00' function='0x0'/&gt;&lt;/div&gt; \
&lt;div&gt;    &lt;/controller&gt;&lt;/div&gt; &lt;div&gt;    &lt;controller \
type='pci' index='3' model='pcie-root-port'&gt;&lt;/div&gt; &lt;div&gt;      \
&lt;model name='pcie-root-port'/&gt;&lt;/div&gt; &lt;div&gt;      &lt;target \
chassis='3' port='0x11'/&gt;&lt;/div&gt; &lt;div&gt;      &lt;address type='pci' \
domain='0x0000' bus='0x00' slot='0x02' function='0x1'/&gt;&lt;/div&gt; &lt;div&gt;    \
&lt;/controller&gt;&lt;/div&gt; &lt;div&gt;    &lt;controller type='pci' index='4' \
model='pcie-root-port'&gt;&lt;/div&gt; &lt;div&gt;      &lt;model \
name='pcie-root-port'/&gt;&lt;/div&gt; &lt;div&gt;      &lt;target chassis='4' \
port='0x12'/&gt;&lt;/div&gt; &lt;div&gt;      &lt;address type='pci' \
domain='0x0000' bus='0x00' slot='0x02' function='0x2'/&gt;&lt;/div&gt; &lt;div&gt;    \
&lt;/controller&gt;&lt;/div&gt; &lt;div&gt;    &lt;controller type='pci' index='5' \
model='pcie-root-port'&gt;&lt;/div&gt; &lt;div&gt;      &lt;model \
name='pcie-root-port'/&gt;&lt;/div&gt; &lt;div&gt;      &lt;target chassis='5' \
port='0x13'/&gt;&lt;/div&gt; &lt;div&gt;      &lt;address type='pci' \
domain='0x0000' bus='0x00' slot='0x02' function='0x3'/&gt;&lt;/div&gt; &lt;div&gt;    \
&lt;/controller&gt;&lt;/div&gt; &lt;div&gt;    &lt;interface type='network'&gt;&lt;/div&gt;
&lt;div&gt;      &lt;mac address='52:54:00:bf:7b:01'/&gt;&lt;/div&gt;
&lt;div&gt;      &lt;source network='cuckoonet1'/&gt;&lt;/div&gt;
&lt;div&gt;      &lt;model type='e1000'/&gt;&lt;/div&gt;
&lt;div&gt;      &lt;address type='pci' domain='0x0000' bus='0x02' \
slot='0x01' function='0x0'/&gt;&lt;/div&gt; &lt;div&gt;    &lt;/interface&gt;&lt;/div&gt;
&lt;div&gt;    &lt;serial type='pty'&gt;&lt;/div&gt;
&lt;div&gt;      &lt;target type='isa-serial' port='0'&gt;&lt;/div&gt;
&lt;div&gt;        &lt;model name='isa-serial'/&gt;&lt;/div&gt;
&lt;div&gt;      &lt;/target&gt;&lt;/div&gt;
&lt;div&gt;    &lt;/serial&gt;&lt;/div&gt;
&lt;div&gt;    &lt;console type='pty'&gt;&lt;/div&gt;
&lt;div&gt;      &lt;target type='serial' port='0'/&gt;&lt;/div&gt;
&lt;div&gt;    &lt;/console&gt;&lt;/div&gt;
&lt;div&gt;    &lt;input type='tablet' bus='usb'&gt;&lt;/div&gt;
&lt;div&gt;      &lt;address type='usb' bus='0' port='1'/&gt;&lt;/div&gt;
&lt;div&gt;    &lt;/input&gt;&lt;/div&gt;
&lt;div&gt;    &lt;input type='mouse' bus='ps2'/&gt;&lt;/div&gt;
&lt;div&gt;    &lt;input type='keyboard' bus='ps2'/&gt;&lt;/div&gt;
&lt;div&gt;    &lt;graphics type='vnc' port='21101' autoport='no' \
websocket='11101' listen='0.0.0.0'&gt;&lt;/div&gt; &lt;div&gt;      &lt;listen \
type='address' address='0.0.0.0'/&gt;&lt;/div&gt; &lt;div&gt;    \
&lt;/graphics&gt;&lt;/div&gt; &lt;div&gt;    &lt;audio id='1' type='none'/&gt;&lt;/div&gt;
&lt;div&gt;    &lt;video&gt;&lt;/div&gt;
&lt;div&gt;      &lt;model type='qxl' ram='65536' vram='65536' \
vgamem='16384' heads='1' primary='yes'/&gt;&lt;/div&gt; &lt;div&gt;      \
&lt;address type='pci' domain='0x0000' bus='0x00' slot='0x01' \
function='0x0'/&gt;&lt;/div&gt; &lt;div&gt;    &lt;/video&gt;&lt;/div&gt;
&lt;div&gt;    &lt;memballoon model='virtio'&gt;&lt;/div&gt;
&lt;div&gt;      &lt;address type='pci' domain='0x0000' bus='0x04' \
slot='0x00' function='0x0'/&gt;&lt;/div&gt; &lt;div&gt;    &lt;/memballoon&gt;&lt;/div&gt;
&lt;div&gt;    &lt;panic model='hyperv'/&gt;&lt;/div&gt;
&lt;div&gt;  &lt;/devices&gt;&lt;/div&gt;
&lt;div&gt;&lt;/domain&gt;&lt;/div&gt;
&lt;div&gt;```&lt;/div&gt;
&lt;br&gt;
&lt;/div&gt;
&lt;div id="appendonsend"&gt;&lt;/div&gt;
&lt;hr style="display:inline-block;width:98%" tabindex="-1"&gt;
&lt;div id="divRplyFwdMsg" dir="ltr"&gt;&lt;font face="Calibri, sans-serif" \
style="font-size:11pt" color="#000000"&gt;&lt;b&gt;Od:&lt;/b&gt; Daniel P. Berrangé \
&lt;berrange@redhat.com&gt;&lt;br&gt; &lt;b&gt;Odesláno:&lt;/b&gt; úterý 10. května 2022 10:08&lt;br&gt;
&lt;b&gt;Komu:&lt;/b&gt; Petr Beneš &lt;w.benny@outlook.com&gt;&lt;br&gt;
&lt;b&gt;Kopie:&lt;/b&gt; libvirt-users@redhat.com &lt;libvirt-users@redhat.com&gt;&lt;br&gt;
&lt;b&gt;Předmět:&lt;/b&gt; Re: Slow VM start/revert, when trying to start/revert dozens of VMs \
in parallel&lt;/font&gt; &lt;div&gt; &lt;/div&gt;
&lt;/div&gt;
&lt;div class="BodyFragment"&gt;&lt;font size="2"&gt;&lt;span style="font-size:11pt;"&gt;
&lt;div class="PlainText"&gt;On Mon, May 09, 2022 at 06:52:32PM +0000, Petr Beneš \
wrote:&lt;br&gt; &gt; Hi,&lt;br&gt;
&gt; &lt;br&gt;
&gt; my problem can be described simply: libvirt can't handle starting dozens of VMs \
at the same time.&lt;br&gt; &gt; &lt;br&gt;
&gt; (technically, it can, but it's really slow.)&lt;br&gt;
&gt; &lt;br&gt;
&gt; We have an AMD machine with 256 logical cores and 1.5T ram.&lt;br&gt;
&gt; On that machine there is roughly 200 VMs.&lt;br&gt;
&gt; Each VM is the same: 8GB of RAM, 4 VCPUs. Half of them is Win7 x86, the other \
half is Win7 x64.&lt;br&gt; &gt; VMs are using qcow2 as the disk image. These images reside \
in the ramdisk (tmpfs).&lt;br&gt; &gt; &lt;br&gt;
&gt; We use these machines for automatic malware analysis, so our scenario consists \
of this cycle:&lt;br&gt; &gt; - reverting VM to a running state&lt;br&gt;
&gt; - execute sample inside of the VM for ~1-2 minutes&lt;br&gt;
&gt; - shutdown the VM&lt;br&gt;
&gt; &lt;br&gt;
&gt; Of course, this results in multiple VMs trying to start at the same time.&lt;br&gt;
&gt; At first, reverts/starts are really fast - second or two.&lt;br&gt;
&gt; After about a minute, the "revertToSnapshot" suddenly takes 10-15 \
seconds, which is really unacceptable.&lt;br&gt; &gt; For comparison, we're running the \
same scenarion on Proxmox, where the revertToSnapshot usually takes 2 seconds.&lt;br&gt; \
&lt;br&gt; Can you share the XML configuration of one of your guests - assuming&lt;br&gt;
they all have the same basic configuration.&lt;br&gt;
&lt;br&gt;
As a gut feeling it sounds to me like it could be initially fast due to&lt;br&gt;
utilization of host I/O cache, but then slows down due to having to&lt;br&gt;
flush data to disk / read fresh from disk. This could be the case if&lt;br&gt;
the disk configuration cache mode is set to certain values, so the XML&lt;br&gt;
config will show us this info.&lt;br&gt;
&lt;br&gt;
With regards,&lt;br&gt;
Daniel&lt;br&gt;
-- &lt;br&gt;
&gt; &gt; &lt;a href="https://berrange.com"&gt;https://berrange.com&lt;/a&gt;      \
&gt; &gt; -o-    &lt;a href="https://www.flickr.com/photos/dberrange"&gt;
https://www.flickr.com/photos/dberrange&lt;/a&gt; :|&lt;br&gt;
&gt; &gt; &lt;a href="https://libvirt.org"&gt;https://libvirt.org&lt;/a&gt;         \
&gt; &gt; -o-            &lt;a \
&gt; &gt; href="https://fstop138.berrange.com"&gt;
https://fstop138.berrange.com&lt;/a&gt; :|&lt;br&gt;
&gt; &gt; &lt;a href="https://entangle-photo.org"&gt;https://entangle-photo.org&lt;/a&gt;    \
&gt; &gt; -o-    &lt;a href="https://www.instagram.com/dberrange"&gt;
https://www.instagram.com/dberrange&lt;/a&gt; :|&lt;br&gt;
&lt;br&gt;
&lt;/div&gt;
&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;



</body></email><email><emailId>20220523122109</emailId><senderName>Andrea Bolognani</senderName><senderEmail>abologna@redhat.com</senderEmail><timestampReceived>2022-05-23 12:21:09-0400</timestampReceived><subject>Re: something (qemu?) is leaking</subject><body>

On Mon, May 23, 2022 at 12:08:00PM +0100, lejeczek wrote:
&gt;
&gt;
&gt; On 23/05/2022 11:03, Michal Prívozník wrote:
&gt; &gt; On 5/23/22 11:19, lejeczek wrote:
&gt; &gt; &gt; Hi guys.
&gt; &gt; &gt;
&gt; &gt; &gt; I do a simple thing which should be easy to reproduce.
&gt; &gt; &gt;
&gt; &gt; &gt; -&gt; $ virt-install -n rum1 --virt-type kvm --os-variant centos8 --memory
&gt; &gt; &gt; $((4*1024)) --disk=/VMs3/rum1.qcow2,device=disk,bus=virtio --network
&gt; &gt; &gt; network=10_3_1,model=virtio --graphics=listen=0.0.0.0 --cpu EPYC-Rome
&gt; &gt; &gt; --vcpus 3 --cdrom /VMs3/CentOS-Stream-9-latest-x86_64-dvd1.iso
&gt; &gt; &gt;
&gt; &gt; &gt; During manual setup in the VM I set 'hostname' to something and when
&gt; &gt; &gt; installation begins and disk config stage takes place I can see - and
&gt; &gt; &gt; later when VM(c9s) is ready can confirm - that VG name is taken from
&gt; &gt; &gt; another VM defined/running on the host.
&gt; &gt;
&gt; &gt; I'm no LVM expert, but I always thought that installer has some defaults
&gt; &gt; built in and thus it's kind of expected if you went with defaults.
&gt; &gt;
&gt; &gt; But I'm kind of failing why is this a problem since all you're giving to
&gt; &gt; the guest is a single qcow2 disk which is not shared between two
&gt; &gt; domains. Maybe I'm misunderstanding something?
&gt;
&gt; I did one type there in, it should have been:
&gt; ... During manual setup in the VM _if_ I _do not_ set 'hostname' to
&gt; something
&gt;
&gt; It's a critical problem - when something leaks - the VM/guest ended up
&gt; "knowing" about other VMs on the host.
&gt;
&gt; Those are simple defaults for disk part of the install process:
&gt; When 'hostname' is set by a user then VG   gets name from installer set to
&gt; eg. 'cs_hostname'.
&gt; When that 'hostname' is not set then it should be just 'cs'
&gt;
&gt; I have a newly installed, clean VM with VG of 'cs_other-guest-on-this-host'
&gt; - somehow that new VM "knew" about other guest on the host - it happened
&gt; twice, two installation as with above cmd, each time with new guest's VG
&gt; name of hostname of a already existing, different guest, each time different
&gt; guest.

Have you made sure the disk image didn't exist before calling
virt-install? If it's a leftover from a previous (aborted?)
installation, then the installer might be picking up the VG as
defined earlier instead of creating it from scratch, which would
explain the name.

-- 
Andrea Bolognani / Red Hat / Virtualization

</body></email><email><emailId>20220523140102</emailId><senderName>ksobrenat32</senderName><senderEmail>ksobrenat32@null.8shield.net</senderEmail><timestampReceived>2022-05-23 14:01:02-0400</timestampReceived><subject>Re: Virtiofs xattr options on domain xml</subject><body>

So as a temporal fix I have changed some things to make it work, I will 
leave this in case it is useful:

1. Upgrade Debian libvirt packages

        I had to upgrade the libvirt packages in order to use the socket 
option for virtiofs, the updates were from Debian 11 back-ports and the 
packages are 'qemu qemu-kvm qemu-system qemu-utils libvirt-clients 
libvirt-daemon-system virtinst' after installing you should restart 
libvirtd

2. Run virtiofsd as a systemd service

        In order to use the socket option, we need to run virtiofsd, I 
decided to run it as a systemd service:

        [Unit]
        Description=Virtiofsd for sharing disk WD-WX32D5143K0L
        Documentation=https://gitlab.com/virtio-fs/virtiofsd

        [Service]
        ExecStart=/usr/lib/qemu/virtiofsd --socket-path=/var/virtiofsd.sock 
--socket-group=libvirt-qemu -o 
xattr,source="/mnt/WD-Disk",xattrmap=":map:security.selinux:trusted.virtiofs.:",modcaps=+sys_admin 


        [Install]
        WantedBy=multi-user.target

        The extra options are 'xattr' for enabling those, 'source' to 
declare the dir to share, 'xattrmap' so you can have different selinux 
context on the host and the guest, 'modcaps' so it is able to set 
trusted xattr. The service should run as root.

3. Add the xml to the vm

        With virsh edit you should edit the domain xml of the vm, on the 
filesystem part to use the socket:

        &lt;filesystem type='mount'&gt;
            &lt;driver type='virtiofs' queue='1024'/&gt;
            &lt;source socket='/var/virtiofsd.sock'/&gt;
            &lt;target dir='media'/&gt;
            &lt;alias name='fs0'/&gt;
            &lt;address type='pci' domain='0x0000' bus='0x07' slot='0x00' 
function='0x0'/&gt;
        &lt;/filesystem&gt;

I know that it may not be the most secure way but it is the best way I 
could found to have a non selinux host with a selinux guest.

On 19/05/22 03:41, Michal Prívozník - mprivozn(a)redhat.com wrote:
&gt; On 5/19/22 00:53, ksobrenat32 wrote:
&gt;&gt; Hi!
&gt;&gt;
&gt;&gt; I have a debian 11 (bullseye) machine running libvirtd version 7.0.0 and
&gt;&gt; a RHEL 9 virtual machine that I need to share a disk and though about
&gt;&gt; virtiofs.
&gt;&gt;
&gt;&gt; The disk is a btrfs disk and I have successfully mount it with:
&gt;&gt;
&gt;&gt;         &lt;filesystem type='mount' accessmode='passthrough'&gt;
&gt;&gt;             &lt;driver type='virtiofs' queue='1024'/&gt;
&gt;&gt;             &lt;binary path='/usr/lib/qemu/virtiofsd' xattr='on'&gt;
&gt;&gt;                 &lt;cache mode='always'/&gt;
&gt;&gt;                 &lt;lock posix='on' flock='on'/&gt;
&gt;&gt;             &lt;/binary&gt;
&gt;&gt;             &lt;source dir='/mnt/WD-Disk'/&gt;
&gt;&gt;             &lt;target dir='media'/&gt;
&gt;&gt;             &lt;alias name='fs0'/&gt;
&gt;&gt;             &lt;address type='pci' domain='0x0000' bus='0x07' slot='0x00'
&gt;&gt; function='0x0'/&gt;
&gt;&gt;         &lt;/filesystem&gt;
&gt;&gt;
&gt;&gt; The problem I have is with selinux, when I try to change the context of
&gt;&gt; a file inside the virtual machine I get a 'Operation not permitted'
&gt;&gt; error, I can change the context in the Debian host and see the changes
&gt;&gt; in the virtual machine but I would want to be able to change the context
&gt;&gt; from the vm to able to use podman containers with selinux enabled.
&gt;&gt;
&gt;&gt; I see on the docs
&gt;&gt; https://qemu.readthedocs.io/en/latest/tools/virtiofsd.html#selinux-support
&gt;&gt; you can run virtiofsd with a xattr option so it is compatible with
&gt;&gt; selinux but I do not find a way to change the domain xml to add this
&gt;&gt; option, is there a way to add this option? Does a better option exists
&gt;&gt; (maybe on the guest side)?
&gt;&gt;
&gt;&gt;
&gt;
&gt; Yeah, I don't think this was implemented. However, virtiofsd is running
&gt; as root:root and with no capabilities dropped. So I guess what we're
&gt; missing here is -o security_label or might as well implement the remap
&gt; as docs suggest which is much safer.
&gt;
&gt; Michal
&gt;
&gt;

</body></email><email><emailId>20220512200346</emailId><senderName>Darragh Bailey</senderName><senderEmail>daragh.bailey@gmail.com</senderEmail><timestampReceived>2022-05-12 20:03:46-0400</timestampReceived><subject>Updating domains definitions via API</subject><body>

Hi,


Looking into a bug in vagrant-libvirt where an error during the update will
cause the domain to be completely discarded.

https://github.com/vagrant-libvirt/vagrant-libvirt/issues/949

Basically I think it stems from doing an undefine -&gt; create with XML new
process, which if there is an issue with the new XML due to KVM module not
loaded or something similar it will be rejected, but unfortunately it is
also unlikely to allow the old definition to be restored either.

I'm looking around to try and see if there is an API (specfically in
ruby-libvirt) for updating the domain definition, so that if the new XML is
rejected at least the old definition remains, and so far I'm drawing a
blank.

Is the only option here to write using a temporary domain name, then remove
the old domain and rename the new definition to the old domain?

Or have I missed the obvious API analogous to the edit functionality?
--
Darragh Bailey
"Nothing is foolproof to a sufficiently talented fool" - unknown

[Attachment #3 (text/html)]

&lt;div dir="auto"&gt;Hi,&lt;div dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div \
dir="auto"&gt;Looking into a bug in vagrant-libvirt where an error during the update \
will cause the domain to be completely discarded.&lt;/div&gt;&lt;div dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div \
dir="auto"&gt;&lt;a href="https://github.com/vagrant-libvirt/vagrant-libvirt/issues/949"&gt;https://github.com/vagrant-libvirt/vagrant-libvirt/issues/949&lt;/a&gt;&lt;br&gt;&lt;br&gt;Basically \
I think it stems from doing an undefine -&gt; create with XML new process, which if \
there is an issue with the new XML due to KVM module not loaded or something similar \
it will be rejected, but unfortunately it is also unlikely to allow the old \
definition to be restored either.&lt;/div&gt;&lt;div dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div \
dir="auto"&gt;I'm looking around to try and see if there is an API (specfically in \
ruby-libvirt) for updating the domain definition, so that if the new XML is rejected \
at least the old definition remains, and so far I'm drawing a blank.&lt;/div&gt;&lt;div \
dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div dir="auto"&gt;Is the only option here to write using a \
temporary domain name, then remove the old domain and rename the new definition to \
the old domain?&lt;/div&gt;&lt;div dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div dir="auto"&gt;Or have I missed the \
obvious API analogous to the edit functionality?&lt;br&gt;--&lt;br&gt;&lt;div \
data-smartmail="gmail_signature" dir="auto"&gt;Darragh Bailey&lt;br&gt;"Nothing is \
foolproof to a sufficiently talented fool" - unknown&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220502014205</emailId><senderName>Gionatan Danti</senderName><senderEmail>g.danti@assyoma.it</senderEmail><timestampReceived>2022-05-02 01:42:05-0400</timestampReceived><subject>macvtap with disconnected physical interface</subject><body>

Dear list,
I just discovered the hard way that if the lower lever physical 
interface of a macvlan bridge is disconnected (ie: by unplugging the eth 
cable, resulting in no carrier), inter-guest network traffic from all 
virtual machines bound to the disconnected interface is dropped.

This behavior surprises me, as with the classic bridges I can disconnect 
the underlying physical interface without causing any harm to 
inter-guest traffic.

Am I doing something wrong, or this really is the expected behavior? If 
so, can I force the macvtap interfaces to bridge traffic even when the 
underlying physical interface is disconnected?

Regards.

-- 
Danti Gionatan
Supporto Tecnico
Assyoma S.r.l. - www.assyoma.it
email: g.danti@assyoma.it - info@assyoma.it
GPG public key ID: FF5F32A8

</body></email><email><emailId>20220509185232</emailId><senderName>Petr Beneš</senderName><senderEmail>w.benny@outlook.com</senderEmail><timestampReceived>2022-05-09 18:52:32-0400</timestampReceived><subject>Slow VM start/revert, when trying to start/revert dozens of VMs in parallel</subject><body>

[Attachment #2 (text/plain)]

Hi,

my problem can be described simply: libvirt can't handle starting dozens of VMs at \
the same time.

(technically, it can, but it's really slow.)

We have an AMD machine with 256 logical cores and 1.5T ram.
On that machine there is roughly 200 VMs.
Each VM is the same: 8GB of RAM, 4 VCPUs. Half of them is Win7 x86, the other half is \
Win7 x64. VMs are using qcow2 as the disk image. These images reside in the ramdisk \
(tmpfs).

We use these machines for automatic malware analysis, so our scenario consists of \
                this cycle:
- reverting VM to a running state
- execute sample inside of the VM for ~1-2 minutes
- shutdown the VM

Of course, this results in multiple VMs trying to start at the same time.
At first, reverts/starts are really fast - second or two.
After about a minute, the "revertToSnapshot" suddenly takes 10-15 seconds, which is \
really unacceptable. For comparison, we're running the same scenarion on Proxmox, \
where the revertToSnapshot usually takes 2 seconds.

Few notes:
- Because of this fast cycle (~2-3 minutes) and because of VMs taking 10-15 seconds \
to start, there is barely more than 25-30 VMs running at once.  We would really love \
to utilise the whole potential of such beast machine of ours, and have at least ~100 \
                VMs running at any given time.
- During the time running, the avg. CPU load isn't higher than 25%. Also, there's \
                only about 280 GB of RAM used. Therefore, it's not limitation of our \
                resources.
- When the framwork is running and libvirt is making its best to start our VMs, I \
noticed that every libvirt operation is suddenly very slow.  Even simple "virsh list \
[--all]" takes few seconds to complete, even though it finishes instantly when no VM \
is running/starting.

I was trying to search for this issue, but didn't really find anything besides this \
presentation: https://events19.linuxfoundation.org/wp-content/uploads/2017/12/Scalabil \
ity-and-Stability-of-libvirt-Experiences-with-Very-Large-Hosts-Marc-Hartmayer-IBM-1.pdf


However, I couldn't find those commits in your upstream.

Is this a known issue? Or is there some setting I don't know of which would magically \
make the VMs start faster?

As for steps to reproduce - I don't think there is anything special needed. Just try \
to start/destroy several VMs in a loop. There is even provided one-liner for that in \
the presentation above.

```
# For multiple domains:
# while virsh start $vm &amp;&amp; virsh destroy $vm; do : ; done
# → ~30s hang ups of the libvirtd main loop
```

Best Regards,
Petr


[Attachment #3 (text/html)]

&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"&gt;
&lt;style type="text/css" style="display:none;"&gt; P {margin-top:0;margin-bottom:0;} \
&lt;/style&gt; &lt;/head&gt;
&lt;body dir="ltr"&gt;
&lt;div style="font-family: Calibri, Helvetica, sans-serif; font-size: 12pt; color: \
rgb(0, 0, 0); background-color: rgb(255, 255, 255);" class="elementToProof"&gt; Hi,
&lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;my problem can be described simply: libvirt can't handle starting dozens of VMs \
at the same time.&lt;/div&gt; &lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;(technically, it can, but it's really slow.)&lt;/div&gt;
&lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;We have an AMD machine with 256 logical cores and 1.5T ram.&lt;/div&gt;
&lt;div&gt;On that machine there is roughly 200 VMs.&lt;/div&gt;
&lt;div&gt;Each VM is the same: 8GB of RAM, 4 VCPUs. Half of them is Win7 x86, the other \
half is Win7 x64.&lt;/div&gt; &lt;div&gt;VMs are using qcow2 as the disk image. These images \
reside in the ramdisk (tmpfs).&lt;/div&gt; &lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;We use these machines for automatic malware analysis, so our scenario consists \
of this cycle:&lt;/div&gt; &lt;div&gt;- reverting VM to a running state&lt;/div&gt;
&lt;div&gt;- execute sample inside of the VM for ~1-2 minutes&lt;/div&gt;
&lt;div&gt;- shutdown the VM&lt;/div&gt;
&lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;Of course, this results in multiple VMs trying to start at the same time.&lt;/div&gt;
&lt;div&gt;At first, reverts/starts are really fast - second or two.&lt;/div&gt;
&lt;div&gt;After about a minute, the "revertToSnapshot" suddenly takes 10-15 \
seconds, which is really unacceptable.&lt;/div&gt; &lt;div&gt;For comparison, we're running the \
same scenarion on Proxmox, where the revertToSnapshot usually takes 2 seconds.&lt;/div&gt; \
&lt;div&gt;&lt;br&gt; &lt;/div&gt;
&lt;div&gt;Few notes:&lt;/div&gt;
&lt;div&gt;- Because of this fast cycle (~2-3 minutes) and because of VMs taking 10-15 \
seconds to start, there is barely more than 25-30 VMs running at once.&lt;/div&gt; \
&lt;div&gt;  We would really love to utilise the whole potential of such beast machine \
of ours, and have at least ~100 VMs running at any given time.&lt;/div&gt; &lt;div&gt;- During \
the time running, the avg. CPU load isn't higher than 25%. Also, there's only about \
280 GB of RAM used. Therefore, it's not limitation of our resources.&lt;/div&gt; &lt;div&gt;- \
When the framwork is running and libvirt is making its best to start our VMs, I \
noticed that every libvirt operation is suddenly very slow.&lt;/div&gt; &lt;div&gt;  Even \
simple "virsh list [--all]" takes few seconds to complete, even though it \
finishes instantly when no VM is running/starting.&lt;/div&gt; &lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;I was trying to search for this issue, but didn't really find anything besides \
this presentation:&lt;/div&gt; \
&lt;div&gt;https://events19.linuxfoundation.org/wp-content/uploads/2017/12/Scalability-and-S \
tability-of-libvirt-Experiences-with-Very-Large-Hosts-Marc-Hartmayer-IBM-1.pdf&lt;/div&gt; \
&lt;div&gt;&lt;br&gt; &lt;/div&gt;
&lt;div&gt;However, I couldn't find those commits in your upstream.&lt;/div&gt;
&lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;Is this a known issue? Or is there some setting I don't know of which would \
magically make the VMs start faster?&lt;/div&gt; &lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;As for steps to reproduce - I don't think there is anything special needed. Just \
try to start/destroy several VMs in a loop.&lt;/div&gt; &lt;div&gt;There is even provided \
one-liner for that in the presentation above.&lt;/div&gt; &lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;```&lt;/div&gt;
&lt;div&gt;# For multiple domains:&lt;/div&gt;
&lt;div&gt;# while virsh start $vm &amp;&amp; virsh destroy $vm; do : ; done&lt;/div&gt;
&lt;div&gt;# → ~30s hang ups of the libvirtd main loop&lt;/div&gt;
&lt;div&gt;```&lt;/div&gt;
&lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;Best Regards,&lt;/div&gt;
&lt;div&gt;Petr&lt;/div&gt;
&lt;br&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;



</body></email><email><emailId>20220523091924</emailId><senderName>lejeczek</senderName><senderEmail>peljasz@yahoo.co.uk</senderEmail><timestampReceived>2022-05-23 09:19:24-0400</timestampReceived><subject>something (qemu?) is leaking</subject><body>

Hi guys.

I do a simple thing which should be easy to reproduce.

-&gt; $ virt-install -n rum1 --virt-type kvm --os-variant 
centos8 --memory $((4*1024)) 
--disk=/VMs3/rum1.qcow2,device=disk,bus=virtio --network 
network=10_3_1,model=virtio --graphics=listen=0.0.0.0 --cpu 
EPYC-Rome --vcpus 3 --cdrom 
/VMs3/CentOS-Stream-9-latest-x86_64-dvd1.iso

During manual setup in the VM I set 'hostname' to something 
and when installation begins and disk config stage takes 
place I can see - and later when VM(c9s) is ready can 
confirm - that VG name is taken from another VM 
defined/running on the host.

Host is c9s with:
qemu-kvm-7.0.0-1.el9.x86_64
libvirt-daemon-8.2.0-1.el9.x86_64
5.14.0-86.el9.x86_64

Does anybody see this/similar?
many thanks, L.

</body></email><email><emailId>20220523100336</emailId><senderName>Michal Prívozník</senderName><senderEmail>mprivozn@redhat.com</senderEmail><timestampReceived>2022-05-23 10:03:36-0400</timestampReceived><subject>Re: something (qemu?) is leaking</subject><body>

On 5/23/22 11:19, lejeczek wrote:
&gt; Hi guys.
&gt; 
&gt; I do a simple thing which should be easy to reproduce.
&gt; 
&gt; -&gt; $ virt-install -n rum1 --virt-type kvm --os-variant centos8 --memory
&gt; $((4*1024)) --disk=/VMs3/rum1.qcow2,device=disk,bus=virtio --network
&gt; network=10_3_1,model=virtio --graphics=listen=0.0.0.0 --cpu EPYC-Rome
&gt; --vcpus 3 --cdrom /VMs3/CentOS-Stream-9-latest-x86_64-dvd1.iso
&gt; 
&gt; During manual setup in the VM I set 'hostname' to something and when
&gt; installation begins and disk config stage takes place I can see - and
&gt; later when VM(c9s) is ready can confirm - that VG name is taken from
&gt; another VM defined/running on the host.

I'm no LVM expert, but I always thought that installer has some defaults
built in and thus it's kind of expected if you went with defaults.

But I'm kind of failing why is this a problem since all you're giving to
the guest is a single qcow2 disk which is not shared between two
domains. Maybe I'm misunderstanding something?

Michal

</body></email><email><emailId>20220518225346</emailId><senderName>ksobrenat32</senderName><senderEmail>ksobrenat32@null.8shield.net</senderEmail><timestampReceived>2022-05-18 22:53:46-0400</timestampReceived><subject>Virtiofs xattr options on domain xml</subject><body>

Hi!

I have a debian 11 (bullseye) machine running libvirtd version 7.0.0 and 
a RHEL 9 virtual machine that I need to share a disk and though about 
virtiofs.

The disk is a btrfs disk and I have successfully mount it with:

        &lt;filesystem type='mount' accessmode='passthrough'&gt;
            &lt;driver type='virtiofs' queue='1024'/&gt;
            &lt;binary path='/usr/lib/qemu/virtiofsd' xattr='on'&gt;
                &lt;cache mode='always'/&gt;
                &lt;lock posix='on' flock='on'/&gt;
            &lt;/binary&gt;
            &lt;source dir='/mnt/WD-Disk'/&gt;
            &lt;target dir='media'/&gt;
            &lt;alias name='fs0'/&gt;
            &lt;address type='pci' domain='0x0000' bus='0x07' slot='0x00' 
function='0x0'/&gt;
        &lt;/filesystem&gt;

The problem I have is with selinux, when I try to change the context of 
a file inside the virtual machine I get a 'Operation not permitted' 
error, I can change the context in the Debian host and see the changes 
in the virtual machine but I would want to be able to change the context 
from the vm to able to use podman containers with selinux enabled.

I see on the docs 
https://qemu.readthedocs.io/en/latest/tools/virtiofsd.html#selinux-support 
you can run virtiofsd with a xattr option so it is compatible with 
selinux but I do not find a way to change the domain xml to add this 
option, is there a way to add this option? Does a better option exists 
(maybe on the guest side)?


</body></email><email><emailId>20220519084138</emailId><senderName>Michal Prívozník</senderName><senderEmail>mprivozn@redhat.com</senderEmail><timestampReceived>2022-05-19 08:41:38-0400</timestampReceived><subject>Re: Virtiofs xattr options on domain xml</subject><body>

On 5/19/22 00:53, ksobrenat32 wrote:
&gt; Hi!
&gt; 
&gt; I have a debian 11 (bullseye) machine running libvirtd version 7.0.0 and
&gt; a RHEL 9 virtual machine that I need to share a disk and though about
&gt; virtiofs.
&gt; 
&gt; The disk is a btrfs disk and I have successfully mount it with:
&gt; 
&gt;     &lt;filesystem type='mount' accessmode='passthrough'&gt;
&gt;       &lt;driver type='virtiofs' queue='1024'/&gt;
&gt;       &lt;binary path='/usr/lib/qemu/virtiofsd' xattr='on'&gt;
&gt;         &lt;cache mode='always'/&gt;
&gt;         &lt;lock posix='on' flock='on'/&gt;
&gt;       &lt;/binary&gt;
&gt;       &lt;source dir='/mnt/WD-Disk'/&gt;
&gt;       &lt;target dir='media'/&gt;
&gt;       &lt;alias name='fs0'/&gt;
&gt;       &lt;address type='pci' domain='0x0000' bus='0x07' slot='0x00'
&gt; function='0x0'/&gt;
&gt;     &lt;/filesystem&gt;
&gt; 
&gt; The problem I have is with selinux, when I try to change the context of
&gt; a file inside the virtual machine I get a 'Operation not permitted'
&gt; error, I can change the context in the Debian host and see the changes
&gt; in the virtual machine but I would want to be able to change the context
&gt; from the vm to able to use podman containers with selinux enabled.
&gt; 
&gt; I see on the docs
&gt; https://qemu.readthedocs.io/en/latest/tools/virtiofsd.html#selinux-support
&gt; you can run virtiofsd with a xattr option so it is compatible with
&gt; selinux but I do not find a way to change the domain xml to add this
&gt; option, is there a way to add this option? Does a better option exists
&gt; (maybe on the guest side)?
&gt; 
&gt; 


Yeah, I don't think this was implemented. However, virtiofsd is running
as root:root and with no capabilities dropped. So I guess what we're
missing here is -o security_label or might as well implement the remap
as docs suggest which is much safer.

Michal

</body></email><email><emailId>20220523110800</emailId><senderName>lejeczek</senderName><senderEmail>peljasz@yahoo.co.uk</senderEmail><timestampReceived>2022-05-23 11:08:00-0400</timestampReceived><subject>Re: something (qemu?) is leaking</subject><body>



On 23/05/2022 11:03, Michal Prívozník wrote:
&gt; On 5/23/22 11:19, lejeczek wrote:
&gt;&gt; Hi guys.
&gt;&gt;
&gt;&gt; I do a simple thing which should be easy to reproduce.
&gt;&gt;
&gt;&gt; -&gt; $ virt-install -n rum1 --virt-type kvm --os-variant centos8 --memory
&gt;&gt; $((4*1024)) --disk=/VMs3/rum1.qcow2,device=disk,bus=virtio --network
&gt;&gt; network=10_3_1,model=virtio --graphics=listen=0.0.0.0 --cpu EPYC-Rome
&gt;&gt; --vcpus 3 --cdrom /VMs3/CentOS-Stream-9-latest-x86_64-dvd1.iso
&gt;&gt;
&gt;&gt; During manual setup in the VM I set 'hostname' to something and when
&gt;&gt; installation begins and disk config stage takes place I can see - and
&gt;&gt; later when VM(c9s) is ready can confirm - that VG name is taken from
&gt;&gt; another VM defined/running on the host.
&gt; I'm no LVM expert, but I always thought that installer has some defaults
&gt; built in and thus it's kind of expected if you went with defaults.
&gt;
&gt; But I'm kind of failing why is this a problem since all you're giving to
&gt; the guest is a single qcow2 disk which is not shared between two
&gt; domains. Maybe I'm misunderstanding something?
&gt;
&gt; Michal
&gt;
I did one type there in, it should have been:
... During manual setup in the VM _if_ I _do not_ set 
'hostname' to something

It's a critical problem - when something leaks - the 
VM/guest ended up "knowing" about other VMs on the host.

Those are simple defaults for disk part of the install process:
When 'hostname' is set by a user then VG   gets name from 
installer set to eg. 'cs_hostname'.
When that 'hostname' is not set then it should be just 'cs'

I have a newly installed, clean VM with VG of 
'cs_other-guest-on-this-host' - somehow that new VM "knew" 
about other guest on the host - it happened twice, two 
installation as with above cmd, each time with new guest's 
VG name of hostname of a already existing, different guest, 
each time different guest.

thanks, L.

</body></email><email><emailId>20220401151250</emailId><senderName>jonetsu</senderName><senderEmail>jonetsu@teksavvy.com</senderEmail><timestampReceived>2022-04-01 15:12:50-0400</timestampReceived><subject>Guest restarting after issuing a shutdown</subject><body>

Hello everyone,

I create kvm machines using a bash script.  As expected from the
script, the resulting virtual machines are performing as they should
be.  The aspect that I do not get is at the end of the creation, when
issuing a 'shutdown now' in the guest and expecting that it will shut
down.  Instead it does shut down, but it is restarted immediately.

The machines are created using an Arch Linux ISO file.  The bash script
runs in three stages, the first stage is on the host. virt-install
will show the regular Arch Linux installation interface.  The bash
script is copied to the machine and its second stage is ran.  After
that a chroot is done and the third phase of the script is executed.
When everything is configured and installed, here is what happens,
commands are prefixed '%', text output is as is, and comments in
'()' :

guest : % shutdown now
host  :   Domain creation completed.
host  :   Restarting guest.
(virt-manager shows the guest restarting)

host  : % virsh shutdown test02
(nothing happens, guest still shown)

host  : % virsh destroy test02
host  :   Domain test02 destroyed
(guest display closes)

What I'm expecting is that, when the 'shutdown now' is issued in the
guest, that it will effectively terminate the guest, 'virsh list --all'
will not show it running, and there'll be no need to issue a 'virsh
destroy'. I have no clue at the moment why virsh is restarting the
guest after a shutdown was issued in the guest.  Looks like virsh did
not get that it should terminate the guest and considers the shutdown
as an error.

Here are the versions involved :

host : xubuntu 20.04 LTS
libvirt 6.0.0-0ubuntu8.15
virt-manager 1:2.2.1-3ubuntu2.1
guest : archlinux 2022.03.01-x86_64

Thanks !

</body></email><email><emailId>20220404180836</emailId><senderName>Ian Pilcher</senderName><senderEmail>arequipeno@gmail.com</senderEmail><timestampReceived>2022-04-04 18:08:36-0400</timestampReceived><subject>Network interface element not working</subject><body>

I've added an interface element to a libvirt network, but it isn't
working.  The interface is not being added to the bridge, even after the
system is rebooted.

# virsh net-dumpxml ocp4-net
&lt;network&gt;
   &lt;name&gt;ocp4-net&lt;/name&gt;
   &lt;uuid&gt;b5852945-9889-4d22-ba61-879125316cec&lt;/uuid&gt;
   &lt;forward dev='eno2' mode='nat'&gt;
     &lt;nat&gt;
       &lt;port start='1024' end='65535'/&gt;
     &lt;/nat&gt;
     &lt;interface dev='eno2'/&gt;
   &lt;/forward&gt;
   &lt;bridge name='virbr-ocp4' stp='on' delay='0'/&gt;
   &lt;mac address='52:54:00:99:99:99'/&gt;
   &lt;ip address='192.168.123.1' netmask='255.255.255.0'&gt;
   &lt;/ip&gt;
&lt;/network&gt;

# brctl show
bridge name     bridge id               STP enabled     interfaces
virbr-ocp4              8000.525400999999       yes             vnet0
virbr0          8000.525400a7ce7f       yes
virbr1          8000.52540051eb1f       yes             vnet1

# rpm -q libvirt
libvirt-8.0.0-2.module_el8.6.0+1087+b42c8331.x86_64

Any ideas?

-- 
========================================================================
Google                                      Where SkyNet meets Idiocracy
========================================================================

</body></email><email><emailId>20220405021051</emailId><senderName>Laine Stump</senderName><senderEmail>laine@redhat.com</senderEmail><timestampReceived>2022-04-05 02:10:51-0400</timestampReceived><subject>Re: Network interface element not working</subject><body>

On 4/4/22 2:08 PM, Ian Pilcher wrote:
&gt; I've added an interface element to a libvirt network, but it isn't
&gt; working.  The interface is not being added to the bridge, even after the
&gt; system is rebooted.

That's not what the &lt;interface&gt; element in a &lt;network&gt; is used for. It's 
actual use is (in my opinion) not all that useful, which has led to 
people assuming other functionality for it that doesn't exist.

The *actual* use of the &lt;interface&gt; element is simply to add an extra 
iptables rule that will drop all traffic originating from a guest and 
outbound to the real network if the interface it uses for egress doesn't 
match the one listed in the &lt;interface&gt; element. It doesn't attach this 
egress interface to the network's bridge, and it doesn't modify the 
next-hop routing of the traffic (which is the more common mistaken 
belief of its function).

Anyway, if you want to have a bridge device that is directly attached to 
a physical ethernet, then you should set up a bridge in the host OS 
outside the scope of libvirt, with the physical ethernet attached to it, 
and then configure your libvirt guests to use that bridge with, e.g.

     &lt;interface type='bridge'&gt;
       &lt;source bridge='br0'/&gt;
       ...


&gt; 
&gt; # virsh net-dumpxml ocp4-net
&gt; &lt;network&gt;
&gt;    &lt;name&gt;ocp4-net&lt;/name&gt;
&gt;    &lt;uuid&gt;b5852945-9889-4d22-ba61-879125316cec&lt;/uuid&gt;
&gt;    &lt;forward dev='eno2' mode='nat'&gt;
&gt;      &lt;nat&gt;
&gt;        &lt;port start='1024' end='65535'/&gt;
&gt;      &lt;/nat&gt;
&gt;      &lt;interface dev='eno2'/&gt;
&gt;    &lt;/forward&gt;
&gt;    &lt;bridge name='virbr-ocp4' stp='on' delay='0'/&gt;
&gt;    &lt;mac address='52:54:00:99:99:99'/&gt;
&gt;    &lt;ip address='192.168.123.1' netmask='255.255.255.0'&gt;
&gt;    &lt;/ip&gt;
&gt; &lt;/network&gt;
&gt; 
&gt; # brctl show
&gt; bridge name     bridge id               STP enabled     interfaces
&gt; virbr-ocp4              8000.525400999999       yes             vnet0
&gt; virbr0          8000.525400a7ce7f       yes
&gt; virbr1          8000.52540051eb1f       yes             vnet1
&gt; 
&gt; # rpm -q libvirt
&gt; libvirt-8.0.0-2.module_el8.6.0+1087+b42c8331.x86_64
&gt; 
&gt; Any ideas?
&gt; 

</body></email><email><emailId>20220405142849</emailId><senderName>Ian Pilcher</senderName><senderEmail>arequipeno@gmail.com</senderEmail><timestampReceived>2022-04-05 14:28:49-0400</timestampReceived><subject>Re: Network interface element not working</subject><body>

On 4/4/22 21:10, Laine Stump wrote:
&gt; That's not what the &lt;interface&gt; element in a &lt;network&gt; is used for. It's 
&gt; actual use is (in my opinion) not all that useful, which has led to 
&gt; people assuming other functionality for it that doesn't exist.

Ah.  Thanks for clarifying that.

&gt; Anyway, if you want to have a bridge device that is directly attached to 
&gt; a physical ethernet, then you should set up a bridge in the host OS 
&gt; outside the scope of libvirt, with the physical ethernet attached to it, 
&gt; and then configure your libvirt guests to use that bridge with, e.g.

That is how I normally do things.  In this case, I'm "piggy backing" on
a pre-existing automation setup that uses libvirt to set up the bridges.
I'm using a hook script to add the physical interface to the bridge when
the virtual network is started, which seems to be working.

Thanks!

-- 
========================================================================
Google                                      Where SkyNet meets Idiocracy
========================================================================

</body></email><email><emailId>20220405151255</emailId><senderName>Laine Stump</senderName><senderEmail>laine@redhat.com</senderEmail><timestampReceived>2022-04-05 15:12:55-0400</timestampReceived><subject>Re: Network interface element not working</subject><body>

On 4/5/22 10:28 AM, Ian Pilcher wrote:
&gt; On 4/4/22 21:10, Laine Stump wrote:
&gt;&gt; That's not what the &lt;interface&gt; element in a &lt;network&gt; is used for. 
&gt;&gt; It's actual use is (in my opinion) not all that useful, which has led 
&gt;&gt; to people assuming other functionality for it that doesn't exist.
&gt; 
&gt; Ah.  Thanks for clarifying that.
&gt; 
&gt;&gt; Anyway, if you want to have a bridge device that is directly attached 
&gt;&gt; to a physical ethernet, then you should set up a bridge in the host OS 
&gt;&gt; outside the scope of libvirt, with the physical ethernet attached to 
&gt;&gt; it, and then configure your libvirt guests to use that bridge with, e.g.
&gt; 
&gt; That is how I normally do things.  In this case, I'm "piggy backing" on
&gt; a pre-existing automation setup that uses libvirt to set up the bridges.
&gt; I'm using a hook script to add the physical interface to the bridge when
&gt; the virtual network is started, which seems to be working.

Umm.... That's how it was intended to *not* work :-P. The whole point of 
the self-managed libvirt virtual networks is to setup a separate subnet 
that has all traffic routed via IP to the physical network. I'm 
impressed you've found a hack that works for you[*], but just be 
prepared to "pick up the pieces" if it breaks :-)

(I hope you've removed the DHCP service, DNS service, and for that 
matter even the IP address from the libvirt network definition. Also, is 
the host ethernet being used (i.e. does it have an IP address) prior to 
attaching it to the bridge? Normally when an ethernet is attached to a 
bridge, its IP configuration is moved to the bridge device, and the 
ethernet has no IP. I'm not sure what kind of connectivity oddities 
would show up if you left the IP address on the ethernet itself)

</body></email><email><emailId>20220401164156</emailId><senderName>Peter Crowther</senderName><senderEmail>peter.crowther@melandra.com</senderEmail><timestampReceived>2022-04-01 16:41:56-0400</timestampReceived><subject>Re: Guest restarting after issuing a shutdown</subject><body>

virt-install is expecting the installation process to need a reboot partway
through, so carefully restarts the guest on its first shutdown. Then it
gets out of the way. Either change what virt-install thinks it's installing
(not sure how, never done it), or write and enable a service during
installation that removes itself then shuts down the guest. First install
doesn't run the service, so restarts normally. Next boot starts the
service, which removes itself and forces a shutdown. Job done.

Cheers,

Peter

On Fri, 1 Apr 2022, 16:14 jonetsu, &lt;jonetsu@teksavvy.com&gt; wrote:

&gt; Hello everyone,
&gt;
&gt; I create kvm machines using a bash script.  As expected from the
&gt; script, the resulting virtual machines are performing as they should
&gt; be.  The aspect that I do not get is at the end of the creation, when
&gt; issuing a 'shutdown now' in the guest and expecting that it will shut
&gt; down.  Instead it does shut down, but it is restarted immediately.
&gt;
&gt; The machines are created using an Arch Linux ISO file.  The bash script
&gt; runs in three stages, the first stage is on the host. virt-install
&gt; will show the regular Arch Linux installation interface.  The bash
&gt; script is copied to the machine and its second stage is ran.  After
&gt; that a chroot is done and the third phase of the script is executed.
&gt; When everything is configured and installed, here is what happens,
&gt; commands are prefixed '%', text output is as is, and comments in
&gt; '()' :
&gt;
&gt; guest : % shutdown now
&gt; host  :   Domain creation completed.
&gt; host  :   Restarting guest.
&gt; (virt-manager shows the guest restarting)
&gt;
&gt; host  : % virsh shutdown test02
&gt; (nothing happens, guest still shown)
&gt;
&gt; host  : % virsh destroy test02
&gt; host  :   Domain test02 destroyed
&gt; (guest display closes)
&gt;
&gt; What I'm expecting is that, when the 'shutdown now' is issued in the
&gt; guest, that it will effectively terminate the guest, 'virsh list --all'
&gt; will not show it running, and there'll be no need to issue a 'virsh
&gt; destroy'. I have no clue at the moment why virsh is restarting the
&gt; guest after a shutdown was issued in the guest.  Looks like virsh did
&gt; not get that it should terminate the guest and considers the shutdown
&gt; as an error.
&gt;
&gt; Here are the versions involved :
&gt;
&gt; host : xubuntu 20.04 LTS
&gt; libvirt 6.0.0-0ubuntu8.15
&gt; virt-manager 1:2.2.1-3ubuntu2.1
&gt; guest : archlinux 2022.03.01-x86_64
&gt;
&gt; Thanks !
&gt;
&gt;

[Attachment #3 (text/html)]

&lt;div dir="auto"&gt;virt-install is expecting the installation process to need a reboot \
partway through, so carefully restarts the guest on its first shutdown. Then it gets \
out of the way. Either change what virt-install thinks it's installing (not sure \
how, never done it), or write and enable a service during installation that removes \
itself then shuts down the guest. First install doesn't run the service, so \
restarts normally. Next boot starts the service, which removes itself and forces a \
shutdown. Job done.&lt;div dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div dir="auto"&gt;Cheers,  &lt;/div&gt;&lt;div \
dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div dir="auto"&gt;Peter  &lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div \
class="gmail_quote"&gt;&lt;div dir="ltr" class="gmail_attr"&gt;On Fri, 1 Apr 2022, 16:14 \
jonetsu, &lt;&lt;a href="mailto:jonetsu@teksavvy.com"&gt;jonetsu@teksavvy.com&lt;/a&gt;&gt; \
wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0 0 0 \
.8ex;border-left:1px #ccc solid;padding-left:1ex"&gt;Hello everyone,&lt;br&gt; &lt;br&gt;
I create kvm machines using a bash script.   As expected from the&lt;br&gt;
script, the resulting virtual machines are performing as they should&lt;br&gt;
be.   The aspect that I do not get is at the end of the creation, when&lt;br&gt;
issuing a 'shutdown now' in the guest and expecting that it will shut&lt;br&gt;
down.   Instead it does shut down, but it is restarted immediately.&lt;br&gt;
&lt;br&gt;
The machines are created using an Arch Linux ISO file.   The bash script&lt;br&gt;
runs in three stages, the first stage is on the host. virt-install&lt;br&gt;
will show the regular Arch Linux installation interface.   The bash&lt;br&gt;
script is copied to the machine and its second stage is ran.   After&lt;br&gt;
that a chroot is done and the third phase of the script is executed.&lt;br&gt;
When everything is configured and installed, here is what happens,&lt;br&gt;
commands are prefixed '%', text output is as is, and comments in&lt;br&gt;
'()' :&lt;br&gt;
&lt;br&gt;
guest : % shutdown now&lt;br&gt;
host   :     Domain creation completed.&lt;br&gt;
host   :     Restarting guest.&lt;br&gt;
(virt-manager shows the guest restarting)&lt;br&gt;
&lt;br&gt;
host   : % virsh shutdown test02&lt;br&gt;
(nothing happens, guest still shown)&lt;br&gt;
&lt;br&gt;
host   : % virsh destroy test02&lt;br&gt;
host   :     Domain test02 destroyed&lt;br&gt;
(guest display closes)&lt;br&gt;
&lt;br&gt;
What I'm expecting is that, when the 'shutdown now' is issued in the&lt;br&gt;
guest, that it will effectively terminate the guest, 'virsh list --all'&lt;br&gt;
will not show it running, and there'll be no need to issue a 'virsh&lt;br&gt;
destroy'. I have no clue at the moment why virsh is restarting the&lt;br&gt;
guest after a shutdown was issued in the guest.   Looks like virsh did&lt;br&gt;
not get that it should terminate the guest and considers the shutdown&lt;br&gt;
as an error.&lt;br&gt;
&lt;br&gt;
Here are the versions involved :&lt;br&gt;
&lt;br&gt;
host : xubuntu 20.04 LTS&lt;br&gt;
libvirt 6.0.0-0ubuntu8.15&lt;br&gt;
virt-manager 1:2.2.1-3ubuntu2.1&lt;br&gt;
guest : archlinux 2022.03.01-x86_64&lt;br&gt;
&lt;br&gt;
Thanks !&lt;br&gt;
&lt;br&gt;
&lt;/blockquote&gt;&lt;/div&gt;



</body></email><email><emailId>20220401174200</emailId><senderName>Andrea Bolognani</senderName><senderEmail>abologna@redhat.com</senderEmail><timestampReceived>2022-04-01 17:42:00-0400</timestampReceived><subject>Re: Guest restarting after issuing a shutdown</subject><body>

On Fri, Apr 01, 2022 at 11:12:50AM -0400, jonetsu wrote:
&gt; guest : % shutdown now
&gt; host  :   Domain creation completed.
&gt; host  :   Restarting guest.
&gt; (virt-manager shows the guest restarting)

Try passing --no-reboot to virt-install.

&gt; host  : % virsh shutdown test02
&gt; (nothing happens, guest still shown)

If the guest OS is fully booted up at this point, you should be able
to initiate a clean shutdown from the host.

If that doesn't work, make sure your VM configuration contains

  &lt;domain&gt;
    ...
    &lt;features&gt;
      &lt;acpi/&gt;
    &lt;/features&gt;
    ...
    &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
    ...
  &lt;/domain&gt;

and that there is some software running in the guest that will
process the ACPI event appropriately. systemd will usually take care
of that part.

-- 
Andrea Bolognani / Red Hat / Virtualization

</body></email><email><emailId>20220315103950</emailId><senderName>lejeczek</senderName><senderEmail>peljasz@yahoo.co.uk</senderEmail><timestampReceived>2022-03-15 10:39:50-0400</timestampReceived><subject>"default" watchdog device - ?</subject><body>

Hi guys.

Without explicitly, manually using watchdog device for a VM, 
the VM (centOS 8 Stream 4.18.0-365.el8.x86_64) shows 
'/dev/watchdog' exists.
To double check - 'dumpxml' does not show any such device - 
what kind of a 'watchdog' that is?
watchdog-5.15-2.el8.x86_64 on such a VM does not seem to do 
anything with it.

Host is centOS 9 with: qemu-img-6.2.0-11.el9.x86_64 
libvirt-daemon-8.0.0-5.el9.x86_64

many thanks, L.

</body></email><email><emailId>20220401215606</emailId><senderName>Michael Espinoza</senderName><senderEmail>mikespinoza@gmail.com</senderEmail><timestampReceived>2022-04-01 21:56:06-0400</timestampReceived><subject>Libvirt Daemon Question</subject><body>

Hi

I've been googling this for a bit with no luck.  Is there a way of
determining what mode an already running libvirt daemon is running
in.(session or system)  From the docs it sounded like it was determined by
what user started the daemon. But in a test node I set up, I have libvirtd
running as root yet I can still connect to both the session and system
qemus with virsh. And if I were to want libvirtd only in session mode, how
would I do that?

Thanks for the help!  This stuff is really awesome and I'm just trying to
get a full understanding of it.

-Mike
-- 
Michael Espinoza
Mobile Phone : 646 327 9273
Email : Mikespinoza@gmail.com

[Attachment #3 (text/html)]

Hi&lt;div dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div dir="auto"&gt;I've been googling this for a bit with no \
luck.   Is there a way of determining what mode an already running libvirt daemon is \
running in.(session or system)   From the docs it sounded like it was determined by \
what user started the daemon. But in a test node I set up, I have libvirtd running as \
root yet I can still connect to both the session and system qemus with virsh. And if \
I were to want libvirtd only in session mode, how would I do that?&lt;/div&gt;&lt;div \
dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div dir="auto"&gt;Thanks for the help!   This stuff is really \
awesome and I'm just trying to get a full understanding of it.  &lt;/div&gt;&lt;div \
dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div dir="auto"&gt;-Mike&lt;/div&gt;-- &lt;br&gt;&lt;div dir="ltr" \
class="gmail_signature" data-smartmail="gmail_signature"&gt;&lt;div dir="ltr"&gt;Michael \
Espinoza&lt;br&gt;Mobile Phone : 646 327 9273&lt;br&gt;Email : &lt;a \
href="mailto:Mikespinoza@gmail.com" \
target="_blank"&gt;Mikespinoza@gmail.com&lt;/a&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220406124437</emailId><senderName>"M, Shivakumar"</senderName><senderEmail>shivakumar.m@intel.com</senderEmail><timestampReceived>2022-04-06 12:44:37-0400</timestampReceived><subject>Libvirt vs QEMU benefits</subject><body>

Hello,

For one of our case validation, we were using direct QEMU commands before f=
or VM creation as it was easier to configure the VMs. Inside VM we do run t=
he real-time latency test.
Recently we switched to libvirt for the VM creation and deletion. Surprisin=
gly, we do see a significant increase in the real-time latency performance =
for the VMs launched through the libvirt.

W.r.t configuration wise both VMs are the same, we just converted the exist=
ing QEMU commands into libvirt XMLs.

I am wondering what and all the features which libvirt has, improving this =
performance.


Thanks,
Shivakumar M

[Attachment #3 (text/html)]

&lt;html xmlns:v="urn:schemas-microsoft-com:vml" \
xmlns:o="urn:schemas-microsoft-com:office:office" \
xmlns:w="urn:schemas-microsoft-com:office:word" \
xmlns:m="http://schemas.microsoft.com/office/2004/12/omml" \
xmlns="http://www.w3.org/TR/REC-html40"&gt; &lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=us-ascii"&gt;
&lt;meta name="Generator" content="Microsoft Word 15 (filtered medium)"&gt;
&lt;style&gt;&lt;!--
/* Font Definitions */
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
/* Style Definitions */
p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin:0in;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
span.EmailStyle17
	{mso-style-type:personal-compose;
	font-family:"Calibri",sans-serif;
	color:windowtext;}
.MsoChpDefault
	{mso-style-type:export-only;
	font-family:"Calibri",sans-serif;}
@page WordSection1
	{size:8.5in 11.0in;
	margin:1.0in 1.0in 1.0in 1.0in;}
div.WordSection1
	{page:WordSection1;}
--&gt;&lt;/style&gt;&lt;!--[if gte mso 9]&gt;&lt;xml&gt;
&lt;o:shapedefaults v:ext="edit" spidmax="1026" /&gt;
&lt;/xml&gt;&lt;![endif]--&gt;&lt;!--[if gte mso 9]&gt;&lt;xml&gt;
&lt;o:shapelayout v:ext="edit"&gt;
&lt;o:idmap v:ext="edit" data="1" /&gt;
&lt;/o:shapelayout&gt;&lt;/xml&gt;&lt;![endif]--&gt;
&lt;/head&gt;
&lt;body lang="EN-US" link="#0563C1" vlink="#954F72" style="word-wrap:break-word"&gt;
&lt;div class="WordSection1"&gt;
&lt;p class="MsoNormal"&gt;Hello,&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;For one of our case validation, we were using direct QEMU \
commands before for VM creation as it was easier to configure the VMs. Inside VM we \
do run the real-time latency test.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;Recently we \
switched to libvirt for the VM creation and deletion. Surprisingly, we do see a \
significant increase in the real-time latency performance for the VMs launched \
through the libvirt.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;W.r.t configuration wise both VMs are the same, we just \
converted the existing QEMU commands into libvirt XMLs.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;I am wondering what and \
all the features which libvirt has, improving this performance.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;Thanks,&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;Shivakumar M&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;



</body></email><email><emailId>20220413103647</emailId><senderName>Martin Kletzander</senderName><senderEmail>mkletzan@redhat.com</senderEmail><timestampReceived>2022-04-13 10:36:47-0400</timestampReceived><subject>Re: Help with libvirt</subject><body>


On Mon, Apr 11, 2022 at 01:06:54PM +0000, Eduardo Kiassucumuca wrote:
&gt;Good morning I'm Eduardo, a computer science student and I'm doing a
&gt;final course work focused on virtualization. The work consists of
&gt;creating virtual machines on a server and allowing ssh access to the
&gt;virtual machines that are on the server containing
&gt;qemu/kvm/libvirt. The problem is that I can't access the virtual
&gt;machines from an external network but I can access them inside the
&gt;server. I would like to know what would be the best way since we want
&gt;to have a single public ip and be able to have a reverse proxy to
&gt;access the virtual machines, I would like to know from your experience
&gt;what you recommend?

It all depends on what network are the VMs running.  There are lot of
options, but my guess is you are using the default network.  It also
depends on whether you want to just forward few ports or have those
machines fully accessible.  For port forwarding you can have a look at
our wiki:

   https://wiki.libvirt.org/page/Networking#Forwarding_Incoming_Connections

but there are always more ways to do the same thing, so that page
describes only few variants.

Have a nice day,
Martin

["signature.asc" (application/pgp-signature)]

</body></email><email><emailId>20220407091645</emailId><senderName>Han Han</senderName><senderEmail>hhan@redhat.com</senderEmail><timestampReceived>2022-04-07 09:16:45-0400</timestampReceived><subject>When does the balloon-change or control-error event occur</subject><body>

Hi developers,
I have questions about balloon-change or control-error event:
1. What's the meaning of these events
2. When do the events occur?

The comments of their callbacks don't mention that(
https://gitlab.com/libvirt/libvirt/-/blob/master/include/libvirt/libvirt-domain.h#L4130
https://gitlab.com/libvirt/libvirt/-/blob/master/include/libvirt/libvirt-domain.h#L3736
)

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;&lt;div&gt;Hi developers,&lt;/div&gt;&lt;div&gt;I have questions about balloon-change or \
control-error event:&lt;/div&gt;&lt;div&gt;1. What's the meaning of these events&lt;/div&gt;&lt;div&gt;2. \
When do the events occur?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The comments of their callbacks \
don't mention that(&lt;a \
href="https://gitlab.com/libvirt/libvirt/-/blob/master/include/libvirt/libvirt-domain. \
h#L4130"&gt;https://gitlab.com/libvirt/libvirt/-/blob/master/include/libvirt/libvirt-domain.h#L4130&lt;/a&gt; \
&lt;a href="https://gitlab.com/libvirt/libvirt/-/blob/master/include/libvirt/libvirt-doma \
in.h#L3736"&gt;https://gitlab.com/libvirt/libvirt/-/blob/master/include/libvirt/libvirt-domain.h#L3736&lt;/a&gt;)&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;




</body></email><email><emailId>20220414163638</emailId><senderName>Bjoern Teipel</senderName><senderEmail>bjoern.teipel@rackspace.com</senderEmail><timestampReceived>2022-04-14 16:36:38-0400</timestampReceived><subject>Virtio-scsi and block mirroring</subject><body>

Hello everyone,

I=92m looking at an issue where I do see guests freezing (Dl) process state=
 during a block disk mirror from one storage to another storage (NFS) where=
 the network stack of the guest can freeze for up to 10 seconds.
Looking at the storage and IO I noticed good throughput ad low latency &lt;3ms=
 and I am having trouble to track down the source for the issue, as neither=
 storage nor networking  show issues. Interestingly when I do the same test=
 with virtio-blk I do not really see the process freezes at the frequency o=
r duration compared to virtio-scsi which seem to indicate a client side rat=
her than storage side problem.

I had looked at the syscalls and nothing stuck out:


% time     seconds  usecs/call     calls    errors syscall
------ ----------- ----------- --------- --------- ----------------
28.51   20.672654        8339      2479           ioctl
 27.81   20.162714        3379      5967        31 futex
 22.02   15.964498         785     20335           poll
 15.22   11.038403         150     73561           io_submit
  4.17    3.023285          41     73540           lseek
  1.20    0.868003           5    158591           write
  0.63    0.459030          11     42871           ppoll
  0.22    0.159263           8     19314           recvmsg
  0.16    0.115520           5     22526           read
  0.04    0.029149       29149         1           restart_syscall
  0.01    0.009252          28       330           sendmsg
  0.00    0.001221        1221         1           munmap
  0.00    0.000458          22        21           fcntl
  0.00    0.000286          95         3           openat
  0.00    0.000166           5        32           rt_sigprocmask
  0.00    0.000103          10        10           fdatasync
  0.00    0.000099          25         4           clone
  0.00    0.000081           7        12           mmap
  0.00    0.000077          19         4           close
  0.00    0.000076           6        12           mprotect
  0.00    0.000056          14         4           madvise
  0.00    0.000025           6         4           set_robust_list
  0.00    0.000023           6         4           prctl
------ ----------- ----------- --------- --------- ----------------
100.00   72.504442                419626        31 total


Does anyone have an idea how to better debug this issue ?

Thanks
Bjoern

[Attachment #3 (text/html)]

&lt;html xmlns:o="urn:schemas-microsoft-com:office:office" \
xmlns:w="urn:schemas-microsoft-com:office:word" \
xmlns:m="http://schemas.microsoft.com/office/2004/12/omml" \
xmlns="http://www.w3.org/TR/REC-html40"&gt; &lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=Windows-1252"&gt;
&lt;meta name="Generator" content="Microsoft Word 15 (filtered medium)"&gt;
&lt;style&gt;&lt;!--
/* Font Definitions */
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
@font-face
	{font-family:Menlo;
	panose-1:2 11 6 9 3 8 4 2 2 4;}
/* Style Definitions */
p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin:0in;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
.MsoChpDefault
	{mso-style-type:export-only;
	font-size:10.0pt;
	font-family:"Calibri",sans-serif;}
@page WordSection1
	{size:8.5in 11.0in;
	margin:1.0in 1.0in 1.0in 1.0in;}
div.WordSection1
	{page:WordSection1;}
--&gt;&lt;/style&gt;
&lt;/head&gt;
&lt;body lang="EN-US" link="#0563C1" vlink="#954F72" style="word-wrap:break-word"&gt;
&lt;div class="WordSection1"&gt;
&lt;p class="MsoNormal"&gt;Hello everyone,&lt;/p&gt;
&lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;I’m looking at an issue where I do see guests freezing (Dl) \
process state during a block disk mirror from one storage to another storage (NFS) \
where the network stack of the guest can freeze for up to 10 seconds.&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;Looking at the storage and IO I noticed good throughput ad low \
latency &lt;3ms and I am having trouble to track down the source for the issue, as \
neither storage nor networking  show issues. Interestingly when I do the same \
test with virtio-blk  I do not really see the process freezes at the frequency or \
duration compared to virtio-scsi which seem to indicate a client side rather than \
storage side problem.&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;I had looked at the syscalls and nothing stuck out:&lt;/p&gt;
&lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal" style="line-height:13.5pt;background:#1E1E1E"&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; \
&lt;p class="MsoNormal" style="line-height:13.5pt;background:#1E1E1E"&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;% &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;time&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;     \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;seconds&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;  &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;usecs&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;/&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;call&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;     \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;calls&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;    \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;errors&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt; &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;syscall&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt; &lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal" style="line-height:13.5pt;background:#1E1E1E"&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;------ ----------- \
----------- --------- --------- ----------------&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;p \
class="MsoNormal" style="line-height:13.5pt;background:#1E1E1E"&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;28.51&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;   &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;20.672654&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;       
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;8339&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;     
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;2479&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;ioctl&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal" style="line-height:13.5pt;background:#1E1E1E"&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt; &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;27.81&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;   &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;20.162714&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;       
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;3379&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;     
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;5967&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;       
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;31&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt; &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;futex&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal" style="line-height:13.5pt;background:#1E1E1E"&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt; &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;22.02&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;   &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;15.964498&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;        
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;785&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;     \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;20335&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;poll&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;           
 &lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal" style="line-height:13.5pt;background:#1E1E1E"&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt; &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;15.22&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;   &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;11.038403&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;        
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;150&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;     \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;73561&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;io_submit&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;      
 &lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal" style="line-height:13.5pt;background:#1E1E1E"&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;  &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;4.17&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;    \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;3.023285&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;         
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;41&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;     \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;73540&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;lseek&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal" style="line-height:13.5pt;background:#1E1E1E"&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;  &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;1.20&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;    \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.868003&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;5&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;    \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;158591&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;write&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal" style="line-height:13.5pt;background:#1E1E1E"&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;  &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.63&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;    \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.459030&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;         
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;11&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;     \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;42871&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;ppoll&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal" style="line-height:13.5pt;background:#1E1E1E"&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;  &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.22&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;    \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.159263&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;8&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;     \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;19314&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;recvmsg&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;        
 &lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal" style="line-height:13.5pt;background:#1E1E1E"&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;  &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.16&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;    \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.115520&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;5&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;     \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;22526&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;read&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;           
 &lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal" style="line-height:13.5pt;background:#1E1E1E"&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;  &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.04&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;    \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.029149&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;      
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;29149&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;        
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;1&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;restart_syscall&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt; &lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal" style="line-height:13.5pt;background:#1E1E1E"&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;  &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.01&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;    \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.009252&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;         
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;28&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;      
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;330&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;sendmsg&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;        
 &lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal" style="line-height:13.5pt;background:#1E1E1E"&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;  &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.00&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;    \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.001221&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;       
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;1221&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;        
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;1&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;munmap&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;         
 &lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal" style="line-height:13.5pt;background:#1E1E1E"&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;  &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.00&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;    \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.000458&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;         
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;22&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;       
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;21&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;fcntl&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;      \
     &lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;p class="MsoNormal" \
style="line-height:13.5pt;background:#1E1E1E"&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;  &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.00&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;    \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.000286&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;         
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;95&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;        
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;3&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;openat&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;         
 &lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal" style="line-height:13.5pt;background:#1E1E1E"&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;  &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.00&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;    \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.000166&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;5&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;       
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;32&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;rt_sigprocmask&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;  &lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal" style="line-height:13.5pt;background:#1E1E1E"&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;  &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.00&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;    \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.000103&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;         
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;10&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;       
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;10&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;fdatasync&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;      
 &lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal" style="line-height:13.5pt;background:#1E1E1E"&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;  &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.00&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;    \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.000099&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;         
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;25&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;        
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;4&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;     \
      &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;clone&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal" style="line-height:13.5pt;background:#1E1E1E"&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;  &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.00&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;    \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.000081&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;7&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;       
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;12&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;mmap&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;           
 &lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal" style="line-height:13.5pt;background:#1E1E1E"&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;  &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.00&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;    \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.000077&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;         
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;19&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;        
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;4&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;close&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal" style="line-height:13.5pt;background:#1E1E1E"&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;  &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.00&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;    \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.000076&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;6&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;       
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;12&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;mprotect&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;       
 &lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal" style="line-height:13.5pt;background:#1E1E1E"&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;  &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.00&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;    \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.000056&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;         
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;14&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;        
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;4&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;madvise&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;        
 &lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal" style="line-height:13.5pt;background:#1E1E1E"&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;  &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.00&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;    \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.000025&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;6&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;        
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;4&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;set_robust_list&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt; &lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal" style="line-height:13.5pt;background:#1E1E1E"&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;  &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.00&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;    \
&lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;0.000023&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;6&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;        
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;4&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;prctl&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;          
 &lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal" style="line-height:13.5pt;background:#1E1E1E"&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;------ ----------- \
----------- --------- --------- ----------------&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;p \
class="MsoNormal" style="line-height:13.5pt;background:#1E1E1E"&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;100.00&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;   &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;72.504442&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;               
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;419626&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;       
 &lt;/span&gt;&lt;span style="font-size:9.0pt;font-family:Menlo;color:#B5CEA8"&gt;31&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt; &lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#9CDCFE"&gt;total&lt;/span&gt;&lt;span \
style="font-size:9.0pt;font-family:Menlo;color:#D4D4D4"&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;Does anyone have an idea how to better debug this issue ?&lt;/p&gt;
&lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;Thanks&lt;/p&gt;
&lt;p class="MsoNormal"&gt;Bjoern&lt;/p&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;



</body></email><email><emailId>20220419111950</emailId><senderName>Peter Krempa</senderName><senderEmail>pkrempa@redhat.com</senderEmail><timestampReceived>2022-04-19 11:19:50-0400</timestampReceived><subject>Re: Virtio-scsi and block mirroring</subject><body>

On Thu, Apr 14, 2022 at 16:36:38 +0000, Bjoern Teipel wrote:
&gt; Hello everyone,

Hi,

&gt; 
&gt; I'm looking at an issue where I do see guests freezing (Dl) process state during a \
&gt; block disk mirror from one storage to another storage (NFS) where the network stack \
&gt; of the guest can freeze for up to 10 seconds. Looking at the storage and IO I \
&gt; noticed good throughput ad low latency &lt;3ms and I am having trouble to track down \
&gt; the source for the issue, as neither storage nor networking  show issues. \
&gt; Interestingly when I do the same test with virtio-blk I do not really see the \
&gt; process freezes at the frequency or duration compared to virtio-scsi which seem to \
&gt; indicate a client side rather than storage side problem.

Hmm, this is really weird if the difference is in the guest-facing
device frontend.

Since libvirt is merely setting up the block job for the copy and the
copy itself is handled by qemu I suggest you contact the
qemu-block@nongnu.org mailing list.

Unfortunately you didn't provide any information on the disk
configuration (the VM XML) or how you start the blockjob, which I could
translate for you into qemu specifics. If you provide such information I
can do that to ensure that the qemu folks have all the relevant
information.


</body></email><email><emailId>20220315112113</emailId><senderName>Daniel =?utf-8?B?UC4gQmVycmFuZ8Op?=</senderName><senderEmail>berrange@redhat.com</senderEmail><timestampReceived>2022-03-15 11:21:13-0400</timestampReceived><subject>Re: "default" watchdog device - ?</subject><body>

On Tue, Mar 15, 2022 at 10:39:50AM +0000, lejeczek wrote:
&gt; Hi guys.
&gt; 
&gt; Without explicitly, manually using watchdog device for a VM, the VM (centOS
&gt; 8 Stream 4.18.0-365.el8.x86_64) shows '/dev/watchdog' exists.
&gt; To double check - 'dumpxml' does not show any such device - what kind of a
&gt; 'watchdog' that is?

The kernel can always provide a pure software watchdog IIRC. It can be
useful if a userspace app wants a watchdog. The limitation is that it
relies on the kernel remaining functional, as there's no hardware
backing it up.

Regards,
Daniel
-- 
|: https://berrange.com      -o-    https://www.flickr.com/photos/dberrange :|
|: https://libvirt.org         -o-            https://fstop138.berrange.com :|
|: https://entangle-photo.org    -o-    https://www.instagram.com/dberrange :|

</body></email><email><emailId>20220415145808</emailId><senderName>Valentijn Sessink</senderName><senderEmail>valentijn@sessink.nl</senderEmail><timestampReceived>2022-04-15 14:58:08-0400</timestampReceived><subject>race condition? virsh migrate --copy-storage-all</subject><body>

Hi list,

I'm trying to migrate a few qemu virtual machines between two 1G 
ethernet connected hosts, with local storage only. I got endless "error: 
operation failed: migration of disk vda failed: Input/output error" 
errors and thought: something wrong with settings.

However, then, suddenly: I succeeded without changing anything. And, hey:
  while ! time virsh migrate --live --persistent --undefinesource 
--copy-storage-all ubuntu20.04 qemu+ssh://duikboot/system; do a=$(( $a + 
1 )); echo $a; done

... retried 8 times, but then: success. This smells like a race 
condition, doesn't it? A bit weird is the fact that the migration seems 
to succeed every time while copying from revolving disks to SSD; but the 
other way around has this Input/output error.

There are some messages in /var/log/syslog, but not at the time of the 
failure, and no disk errors. These disks are LVM2 volumes and they live 
on raid arrays - and/so there is not a real, as in physical, I/O-error.

Source system has SSD's, target system has regular disks.

1) is this the right mailing list? I'm not 100% sure.
2) how can I research this further? Spending hours on a "while / then" 
loop to try and retry live migration looks like a dull job for my poor 
computers ;-)

Best regards,

Valentijn

</body></email><email><emailId>20220419112210</emailId><senderName>Peter Krempa</senderName><senderEmail>pkrempa@redhat.com</senderEmail><timestampReceived>2022-04-19 11:22:10-0400</timestampReceived><subject>Re: race condition? virsh migrate --copy-storage-all</subject><body>

On Fri, Apr 15, 2022 at 16:58:08 +0200, Valentijn Sessink wrote:
&gt; Hi list,
&gt; 
&gt; I'm trying to migrate a few qemu virtual machines between two 1G ethernet
&gt; connected hosts, with local storage only. I got endless "error: operation
&gt; failed: migration of disk vda failed: Input/output error" errors and
&gt; thought: something wrong with settings.
&gt; 
&gt; However, then, suddenly: I succeeded without changing anything. And, hey:
&gt;  while ! time virsh migrate --live --persistent --undefinesource
&gt; --copy-storage-all ubuntu20.04 qemu+ssh://duikboot/system; do a=$(( $a + 1
&gt; )); echo $a; done
&gt; 
&gt; ... retried 8 times, but then: success. This smells like a race condition,
&gt; doesn't it? A bit weird is the fact that the migration seems to succeed
&gt; every time while copying from revolving disks to SSD; but the other way
&gt; around has this Input/output error.
&gt; 
&gt; There are some messages in /var/log/syslog, but not at the time of the
&gt; failure, and no disk errors. These disks are LVM2 volumes and they live on
&gt; raid arrays - and/so there is not a real, as in physical, I/O-error.
&gt; 
&gt; Source system has SSD's, target system has regular disks.
&gt; 
&gt; 1) is this the right mailing list? I'm not 100% sure.
&gt; 2) how can I research this further? Spending hours on a "while / then" loop
&gt; to try and retry live migration looks like a dull job for my poor computers
&gt; ;-)

It would be helpful if you provide the VM XML file to see how your disks
are configured and the debug log file when the bug reproduces:

https://www.libvirt.org/kbase/debuglogs.html#less-verbose-logging-for-qemu-vms

Without that my only hunch would be that you ran out of disk space on
the destination which caused the I/O error.

</body></email><email><emailId>20220419135132</emailId><senderName>Valentijn Sessink</senderName><senderEmail>valentijn@sessink.nl</senderEmail><timestampReceived>2022-04-19 13:51:32-0400</timestampReceived><subject>Re: race condition? virsh migrate --copy-storage-all</subject><body>

Hi Peter,

Thanks.

On 19-04-2022 13:22, Peter Krempa wrote:
&gt; It would be helpful if you provide the VM XML file to see how your disks
&gt; are configured and the debug log file when the bug reproduces:

I created a random VM to show the effect. XML file attached.

&gt; Without that my only hunch would be that you ran out of disk space on
&gt; the destination which caused the I/O error.

... it's an LVM2 volume with exact the same size as the source machine, 
so that would be rather odd ;-)

I'm guessing that it's this weird message at the destination machine:

2022-04-19 13:31:09.394+0000: 1412559: error : 
virKeepAliveTimerInternal:137 : internal error: connection closed due to 
keepalive timeout

Source machine says:
2022-04-19 13:31:09.432+0000: 2641309: debug : 
qemuMonitorJSONIOProcessLine:220 : Line [{"timestamp": {"seconds": 
1650375069, "microseconds": 432613}, "event": "BLOCK_JOB_ERROR", "data": 
{"device": "drive-virtio-disk2", "operation": "write", "action": "report"}}]
2022-04-19 13:31:09.432+0000: 2641309: debug : 
virJSONValueFromString:1822 : string={"timestamp": {"seconds": 
1650375069, "microseconds": 432613}, "event": "BLOCK_JOB_ERROR", "data": 
{"device": "drive-virtio-disk2", "operation": "write", "action": "report"}}
2022-04-19 13:31:09.432+0000: 2641309: info : 
qemuMonitorJSONIOProcessLine:234 : QEMU_MONITOR_RECV_EVENT: 
mon=0x7f70080028a0 event={"timestamp": {"seconds": 1650375069, 
"microseconds": 432613}, "event": "BLOCK_JOB_ERROR", "data": {"device": 
"drive-virtio-disk2", "operation": "write", "action": "report"}}
2022-04-19 13:31:09.432+0000: 2641309: debug : qemuMonitorEmitEvent:1198 
: mon=0x7f70080028a0 event=BLOCK_JOB_ERROR
2022-04-19 13:31:09.432+0000: 2641309: debug : 
qemuMonitorJSONIOProcessLine:220 : Line [{"timestamp": {"seconds": 
1650375069, "microseconds": 432668}, "event": "BLOCK_JOB_ERROR", "data": 
{"device": "drive-virtio-disk2", "operation": "write", "action": "report"}}]
2022-04-19 13:31:09.432+0000: 2641309: debug : 
virJSONValueFromString:1822 : string={"timestamp": {"seconds": 
1650375069, "microseconds": 432668}, "event": "BLOCK_JOB_ERROR", "data": 
{"device": "drive-virtio-disk2", "operation": "write", "action": "report"}}
2022-04-19 13:31:09.433+0000: 2641309: info : 
qemuMonitorJSONIOProcessLine:234 : QEMU_MONITOR_RECV_EVENT: 
mon=0x7f70080028a0 event={"timestamp": {"seconds": 1650375069, 
"microseconds": 432668}, "event": "BLOCK_JOB_ERROR", "data": {"device": 
"drive-virtio-disk2", "operation": "write", "action": "report"}}
2022-04-19 13:31:09.433+0000: 2641309: debug : qemuMonitorEmitEvent:1198 
: mon=0x7f70080028a0 event=BLOCK_JOB_ERROR
2022-04-19 13:31:09.433+0000: 2641309: debug : 
qemuMonitorJSONIOProcessLine:220 : Line [{"timestamp": {"seconds": 
1650375069, "microseconds": 432688}, "event": "BLOCK_JOB_ERROR", "data": 
{"device": "drive-virtio-disk2", "operation": "write", "action": "report"}}]
2022-04-19 13:31:09.433+0000: 2641309: debug : 
virJSONValueFromString:1822 : string={"timestamp": {"seconds": 
1650375069, "microseconds": 432688}, "event": "BLOCK_JOB_ERROR", "data": 
{"device": "drive-virtio-disk2", "operation": "write", "action": "report"}}
2022-04-19 13:31:09.433+0000: 2641309: info : 
qemuMonitorJSONIOProcessLine:234 : QEMU_MONITOR_RECV_EVENT: 
mon=0x7f70080028a0 event={"timestamp": {"seconds": 1650375069, 
"microseconds": 432688}, "event": "BLOCK_JOB_ERROR", "data": {"device": 
"drive-virtio-disk2", "operation": "write", "action": "report"}}
2022-04-19 13:31:09.433+0000: 2641309: debug : qemuMonitorEmitEvent:1198 
: mon=0x7f70080028a0 event=BLOCK_JOB_ERROR

... and more of these. XML file attached.

Does that show anything? Please note that there is no real "block error" 
anywhere, there is an exact LVM volume on the other side, I'm actually 
using a script to extract the name of the volume at source; then I'm 
reading the source volume size and I'm creating a destination volume 
with the exact size before I start the migration. Disks are RAID volumes 
and there are no read or write errors.

Best regards,

Valentijn
-- 
Durgerdamstraat 29, 1507 JL Zaandam; telefoon 075-7100071
["water.xml" (text/xml)]

&lt;domain type='kvm' id='16'&gt;
  &lt;name&gt;water&lt;/name&gt;
  &lt;uuid&gt;959c1a50-5784-e3f4-1006-1bac01d513e5&lt;/uuid&gt;
  &lt;metadata&gt;
    &lt;libosinfo:libosinfo xmlns:libosinfo="http://libosinfo.org/xmlns/libvirt/domain/1.0"&gt;
      &lt;libosinfo:os id="http://ubuntu.com/ubuntu/20.04"/&gt;
    &lt;/libosinfo:libosinfo&gt;
  &lt;/metadata&gt;
  &lt;memory unit='KiB'&gt;4194304&lt;/memory&gt;
  &lt;currentMemory unit='KiB'&gt;1740804&lt;/currentMemory&gt;
  &lt;vcpu placement='static'&gt;1&lt;/vcpu&gt;
  &lt;resource&gt;
    &lt;partition&gt;/machine&lt;/partition&gt;
  &lt;/resource&gt;
  &lt;os&gt;
    &lt;type arch='x86_64' machine='pc-1.1'&gt;hvm&lt;/type&gt;
    &lt;boot dev='hd'/&gt;
  &lt;/os&gt;
  &lt;features&gt;
    &lt;acpi/&gt;
    &lt;apic/&gt;
    &lt;pae/&gt;
  &lt;/features&gt;
  &lt;cpu mode='custom' match='exact' check='full'&gt;
    &lt;model fallback='forbid'&gt;Westmere&lt;/model&gt;
    &lt;feature policy='require' name='hypervisor'/&gt;
  &lt;/cpu&gt;
  &lt;clock offset='utc'/&gt;
  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
  &lt;on_crash&gt;restart&lt;/on_crash&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/bin/kvm&lt;/emulator&gt;
    &lt;disk type='block' device='disk'&gt;
      &lt;driver name='qemu' type='raw' cache='none' io='native'/&gt;
      &lt;source dev='/dev/OpenOffice/water' index='2'/&gt;
      &lt;backingStore/&gt;
      &lt;target dev='vda' bus='virtio'/&gt;
      &lt;alias name='virtio-disk0'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x06' function='0x0'/&gt;
    &lt;/disk&gt;
    &lt;disk type='block' device='disk'&gt;
      &lt;driver name='qemu' type='raw' cache='none' io='native'/&gt;
      &lt;source dev='/dev/OpenOffice/water.var.mail.img' index='1'/&gt;
      &lt;backingStore/&gt;
      &lt;target dev='vdc' bus='virtio'/&gt;
      &lt;alias name='virtio-disk2'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x09' function='0x0'/&gt;
    &lt;/disk&gt;
    &lt;controller type='usb' index='0' model='piix3-uhci'&gt;
      &lt;alias name='usb'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x2'/&gt;
    &lt;/controller&gt;
    &lt;controller type='pci' index='0' model='pci-root'&gt;
      &lt;alias name='pci.0'/&gt;
    &lt;/controller&gt;
    &lt;interface type='bridge'&gt;
      &lt;mac address='52:54:00:70:c2:c4'/&gt;
      &lt;source bridge='br0'/&gt;
      &lt;target dev='vnet2'/&gt;
      &lt;model type='e1000'/&gt;
      &lt;alias name='net0'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/&gt;
    &lt;/interface&gt;
    &lt;interface type='bridge'&gt;
      &lt;mac address='52:54:00:16:2e:1f'/&gt;
      &lt;source bridge='br1'/&gt;
      &lt;target dev='vnet3'/&gt;
      &lt;model type='e1000'/&gt;
      &lt;alias name='net1'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/&gt;
    &lt;/interface&gt;
    &lt;input type='mouse' bus='ps2'&gt;
      &lt;alias name='input0'/&gt;
    &lt;/input&gt;
    &lt;input type='keyboard' bus='ps2'&gt;
      &lt;alias name='input1'/&gt;
    &lt;/input&gt;
    &lt;graphics type='vnc' port='5902' autoport='yes' listen='127.0.0.1'&gt;
      &lt;listen type='address' address='127.0.0.1'/&gt;
    &lt;/graphics&gt;
    &lt;sound model='es1370'&gt;
      &lt;alias name='sound0'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0'/&gt;
    &lt;/sound&gt;
    &lt;video&gt;
      &lt;model type='cirrus' vram='16384' heads='1' primary='yes'/&gt;
      &lt;alias name='video0'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0'/&gt;
    &lt;/video&gt;
    &lt;memballoon model='virtio'&gt;
      &lt;alias name='balloon0'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x07' function='0x0'/&gt;
    &lt;/memballoon&gt;
  &lt;/devices&gt;
  &lt;seclabel type='dynamic' model='apparmor' relabel='yes'&gt;
    &lt;label&gt;libvirt-959c1a50-5784-e3f4-1006-1bac01d513e5&lt;/label&gt;
    &lt;imagelabel&gt;libvirt-959c1a50-5784-e3f4-1006-1bac01d513e5&lt;/imagelabel&gt;
  &lt;/seclabel&gt;
  &lt;seclabel type='dynamic' model='dac' relabel='yes'&gt;
    &lt;label&gt;+111:+111&lt;/label&gt;
    &lt;imagelabel&gt;+111:+111&lt;/imagelabel&gt;
  &lt;/seclabel&gt;
&lt;/domain&gt;



</body></email><email><emailId>20220419140729</emailId><senderName>Peter Krempa</senderName><senderEmail>pkrempa@redhat.com</senderEmail><timestampReceived>2022-04-19 14:07:29-0400</timestampReceived><subject>Re: race condition? virsh migrate --copy-storage-all</subject><body>

On Tue, Apr 19, 2022 at 15:51:32 +0200, Valentijn Sessink wrote:
&gt; Hi Peter,
&gt; 
&gt; Thanks.
&gt; 
&gt; On 19-04-2022 13:22, Peter Krempa wrote:
&gt; &gt; It would be helpful if you provide the VM XML file to see how your disks
&gt; &gt; are configured and the debug log file when the bug reproduces:
&gt; 
&gt; I created a random VM to show the effect. XML file attached.
&gt; 
&gt; &gt; Without that my only hunch would be that you ran out of disk space on
&gt; &gt; the destination which caused the I/O error.
&gt; 
&gt; ... it's an LVM2 volume with exact the same size as the source machine, so
&gt; that would be rather odd ;-)

Oh, you are using raw disks backed by block volumes. That was not
obvious before ;)

&gt; 
&gt; I'm guessing that it's this weird message at the destination machine:
&gt; 
&gt; 2022-04-19 13:31:09.394+0000: 1412559: error : virKeepAliveTimerInternal:137
&gt; : internal error: connection closed due to keepalive timeout

That certainly could be a hint ...

&gt; 
&gt; Source machine says:
&gt; 2022-04-19 13:31:09.432+0000: 2641309: debug :
&gt; qemuMonitorJSONIOProcessLine:220 : Line [{"timestamp": {"seconds":
&gt; 1650375069, "microseconds": 432613}, "event": "BLOCK_JOB_ERROR", "data":
&gt; {"device": "drive-virtio-disk2", "operation": "write", "action": "report"}}]
&gt; 2022-04-19 13:31:09.432+0000: 2641309: debug : virJSONValueFromString:1822 :
&gt; string={"timestamp": {"seconds": 1650375069, "microseconds": 432613},
&gt; "event": "BLOCK_JOB_ERROR", "data": {"device": "drive-virtio-disk2",
&gt; "operation": "write", "action": "report"}}

The migration of non-shared storage works as follows:

1) libvirt sets up everything
2) libvirt asks destination qemu to open an NBD server exporting the
   disk backends
3) source libvirt instructs qemu to copy the disks to the NBD server via
   a block-copy job
4) when the block jobs converge, source qemu is instructed to migrate
   memory
5) when memory migrates, source qemu is killed and destination is
resumed

Now from the keepalive failure on the destiantion it seems that the
network connection at least between the migration controller and the
destination libvirt broke. That might actually cause also the NBD
connection to break and in such case the block job gets an I/O error.

Now the I/O error is actually based on the network connection and not
any storage issue.

So at this point I suspect that something without the network broke and
the migration was aborted in the storage copy phase, but could been in
any other.

</body></email><email><emailId>20220419142131</emailId><senderName>Valentijn Sessink</senderName><senderEmail>valentijn@sessink.nl</senderEmail><timestampReceived>2022-04-19 14:21:31-0400</timestampReceived><subject>Re: race condition? virsh migrate --copy-storage-all</subject><body>

Hi,

On 19-04-2022 16:07, Peter Krempa wrote:
&gt; So at this point I suspect that something without the network broke and
&gt; the migration was aborted in the storage copy phase, but could been in
&gt; any other.

Hmm, thank you. My problem is much clearer now - and probably not 
getting easier:

     192.168.112.31.39324 &gt; 192.168.112.12.22: Flags [P.], cksum 0x61e7 
(incorrect -&gt; 0x3220), seq 9618:9686, ack 5038, win 501, options 
[nop,nop,TS val 3380045136 ecr 1586940949], length 68
(Many more of these - then a timeout. And mind you: this is not related 
to any virtual checksum waiver or anything like that, it's the physical 
machine).

Anyway, thanks for your help.

Best regards,

Valentijn
-- 

</body></email><email><emailId>20220315145933</emailId><senderName>lejeczek</senderName><senderEmail>peljasz@yahoo.co.uk</senderEmail><timestampReceived>2022-03-15 14:59:33-0400</timestampReceived><subject>Re: "default" watchdog device - ?</subject><body>



On 15/03/2022 11:21, Daniel P. Berrangé wrote:
&gt; On Tue, Mar 15, 2022 at 10:39:50AM +0000, lejeczek wrote:
&gt;&gt; Hi guys.
&gt;&gt;
&gt;&gt; Without explicitly, manually using watchdog device for a VM, the VM (centOS
&gt;&gt; 8 Stream 4.18.0-365.el8.x86_64) shows '/dev/watchdog' exists.
&gt;&gt; To double check - 'dumpxml' does not show any such device - what kind of a
&gt;&gt; 'watchdog' that is?
&gt; The kernel can always provide a pure software watchdog IIRC. It can be
&gt; useful if a userspace app wants a watchdog. The limitation is that it
&gt; relies on the kernel remaining functional, as there's no hardware
&gt; backing it up.
&gt;
&gt; Regards,
&gt; Daniel
many thanks Daniel
Is qemu's watchdog configurable just like on bare-metal? 
Perhaps same very way - via/in BIOS?
L.

</body></email><email><emailId>20220316115504</emailId><senderName>lejeczek</senderName><senderEmail>peljasz@yahoo.co.uk</senderEmail><timestampReceived>2022-03-16 11:55:04-0400</timestampReceived><subject>Re: "default" watchdog device - ?</subject><body>



On 15/03/2022 11:21, Daniel P. Berrangé wrote:
&gt; On Tue, Mar 15, 2022 at 10:39:50AM +0000, lejeczek wrote:
&gt;&gt; Hi guys.
&gt;&gt;
&gt;&gt; Without explicitly, manually using watchdog device for a VM, the VM (centOS
&gt;&gt; 8 Stream 4.18.0-365.el8.x86_64) shows '/dev/watchdog' exists.
&gt;&gt; To double check - 'dumpxml' does not show any such device - what kind of a
&gt;&gt; 'watchdog' that is?
&gt; The kernel can always provide a pure software watchdog IIRC. It can be
&gt; useful if a userspace app wants a watchdog. The limitation is that it
&gt; relies on the kernel remaining functional, as there's no hardware
&gt; backing it up.
&gt;
&gt; Regards,
&gt; Daniel
On a related note - with 'i6300esb' watchdog which I tested 
and I believe is working.
I get often in my VMs from 'dmesg':
...
watchdog: BUG: soft lockup - CPU#0 stuck for xxxs! [swapper/0:0]
rcu: INFO: rcu_sched self-detected stall on CPU
...
This above is from Ubuntu and CentOS alike and when this 
happens, console via VNC responds to until first 'enter' 
then is non-resposive.
This happens after VM(s) was migrated between hosts, but 
anyway..
I do not see what I expected from 'watchdog' - there is no 
action whatsoever, which should be 'reset'. VM remains in 
such 'frozen' state forever.

any &amp; all shared thoughts much appreciated.
L.

</body></email><email><emailId>20220405162746</emailId><senderName>lejeczek</senderName><senderEmail>peljasz@yahoo.co.uk</senderEmail><timestampReceived>2022-04-05 16:27:46-0400</timestampReceived><subject>Re: "default" watchdog device - ?</subject><body>



On 29/03/2022 20:25, Nir Soffer wrote:
&gt; On Wed, Mar 16, 2022 at 1:55 PM lejeczek &lt;peljasz@yahoo.co.uk&gt; wrote:
&gt;&gt;
&gt;&gt;
&gt;&gt; On 15/03/2022 11:21, Daniel P. Berrangé wrote:
&gt;&gt;&gt; On Tue, Mar 15, 2022 at 10:39:50AM +0000, lejeczek wrote:
&gt;&gt;&gt;&gt; Hi guys.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Without explicitly, manually using watchdog device for a VM, the VM (centOS
&gt;&gt;&gt;&gt; 8 Stream 4.18.0-365.el8.x86_64) shows '/dev/watchdog' exists.
&gt;&gt;&gt;&gt; To double check - 'dumpxml' does not show any such device - what kind of a
&gt;&gt;&gt;&gt; 'watchdog' that is?
&gt;&gt;&gt; The kernel can always provide a pure software watchdog IIRC. It can be
&gt;&gt;&gt; useful if a userspace app wants a watchdog. The limitation is that it
&gt;&gt;&gt; relies on the kernel remaining functional, as there's no hardware
&gt;&gt;&gt; backing it up.
&gt;&gt;&gt;
&gt;&gt;&gt; Regards,
&gt;&gt;&gt; Daniel
&gt;&gt; On a related note - with 'i6300esb' watchdog which I tested
&gt;&gt; and I believe is working.
&gt;&gt; I get often in my VMs from 'dmesg':
&gt;&gt; ...
&gt;&gt; watchdog: BUG: soft lockup - CPU#0 stuck for xxxs! [swapper/0:0]
&gt;&gt; rcu: INFO: rcu_sched self-detected stall on CPU
&gt;&gt; ...
&gt;&gt; This above is from Ubuntu and CentOS alike and when this
&gt;&gt; happens, console via VNC responds to until first 'enter'
&gt;&gt; then is non-resposive.
&gt;&gt; This happens after VM(s) was migrated between hosts, but
&gt;&gt; anyway..
&gt;&gt; I do not see what I expected from 'watchdog' - there is no
&gt;&gt; action whatsoever, which should be 'reset'. VM remains in
&gt;&gt; such 'frozen' state forever.
&gt;&gt;
&gt;&gt; any &amp; all shared thoughts much appreciated.
&gt;&gt; L.
&gt; You need to run some userspace tool that will open the watchdog
&gt; device, and pet it periodically, telling the kernel that userspace is alive.
&gt;
&gt; If this tool will stop petting the watchdog, maybe because of a soft lockup
&gt; or other trouble, the watchdog device will reset the VM.
&gt;
&gt; watchdog(8) may be the tool you need.
&gt;
&gt; See also
&gt; https://www.kernel.org/doc/Documentation/watchdog/watchdog-api.rst
&gt;
&gt; Nir
&gt;
I do not think that 'i6300esb' watchog works under those 
soft-lockups, whether it's qemu or OS end I cannot say.
With:
     &lt;watchdog model='i6300esb' action='reset'/&gt;
in dom xml OS sees:
-&gt; $ llr /dev/watchdog*
crw-------. 1 root root  10, 130 Apr  5 16:59 /dev/watchdog
crw-------. 1 root root 248,   0 Apr  5 16:59 /dev/watchdog0
crw-------. 1 root root 248,   1 Apr  5 16:59 /dev/watchdog1
and
-&gt; $ wdctl
Device:        /dev/watchdog
Identity:      i6300ESB timer [version 0]
Timeout:       30 seconds
Pre-timeout:    0 seconds
FLAG           DESCRIPTION               STATUS BOOT-STATUS
KEEPALIVEPING  Keep alive ping reply          1           0
MAGICCLOSE     Supports magic close char      0           0
SETTIMEOUT     Set timeout (in seconds)       0           0

If it worked, the HW watchdog, then 'i6300esb' should reset 
the VM if nothing is pinging the watchdog - I read that it's 
possible to exit 'software' watchdog and not to cause HW 
watchdog take action. I do not know it that's happening here 
when I just 'systemclt stop watchdog'
In '/etc/watchdog.conf' I do not point to any specific 
device, which I believe makes watchdogd do its things.
Simple test:
-&gt; $ cat &gt;&gt; /dev/watchdog
&amp; 'Enter' press twice
does invoke 'reset' action and I was to believe 'wdctl' that 
is HW watchdog working. But!...
The main issue I have are those "soft lockups" where VM's OS 
becomes frozen, but nothing from the watchdog, no action - 
though, as VM is in such frozen state host shows high CPU 
for the VM.

I do not anything fancy so I really wonder if what I see is 
that rare.
Soft-lockup occur I think usually, cannot say that uniquely 
though, during or after VM live-migration.

thanks, L.

</body></email><email><emailId>20220509185810</emailId><senderName>Petr Beneš</senderName><senderEmail>w.benny@outlook.com</senderEmail><timestampReceived>2022-05-09 18:58:10-0400</timestampReceived><subject>Re: Slow VM start/revert, when trying to start/revert dozens of VMs in parallel</subject><body>

[Attachment #2 (text/plain)]

I forgot to mention:

```
$ lsb_release -a
Distributor ID: Ubuntu
Description:    Ubuntu 22.04 LTS
Release:        22.04
Codename:       jammy

$ virsh version
Compiled against library: libvirt 8.0.0
Using library: libvirt 8.0.0
Using API: QEMU 8.0.0
Running hypervisor: QEMU 6.2.0
```

________________________________
Od: Petr Beneš &lt;w.benny@outlook.com&gt;
Odesláno: pondělí 9. května 2022 20:52
Komu: libvirt-users@redhat.com &lt;libvirt-users@redhat.com&gt;
Předmět: Slow VM start/revert, when trying to start/revert dozens of VMs in \
parallel

Hi,

my problem can be described simply: libvirt can't handle starting dozens of VMs at \
the same time.

(technically, it can, but it's really slow.)

We have an AMD machine with 256 logical cores and 1.5T ram.
On that machine there is roughly 200 VMs.
Each VM is the same: 8GB of RAM, 4 VCPUs. Half of them is Win7 x86, the other half is \
Win7 x64. VMs are using qcow2 as the disk image. These images reside in the ramdisk \
(tmpfs).

We use these machines for automatic malware analysis, so our scenario consists of \
                this cycle:
- reverting VM to a running state
- execute sample inside of the VM for ~1-2 minutes
- shutdown the VM

Of course, this results in multiple VMs trying to start at the same time.
At first, reverts/starts are really fast - second or two.
After about a minute, the "revertToSnapshot" suddenly takes 10-15 seconds, which is \
really unacceptable. For comparison, we're running the same scenarion on Proxmox, \
where the revertToSnapshot usually takes 2 seconds.

Few notes:
- Because of this fast cycle (~2-3 minutes) and because of VMs taking 10-15 seconds \
to start, there is barely more than 25-30 VMs running at once.  We would really love \
to utilise the whole potential of such beast machine of ours, and have at least ~100 \
                VMs running at any given time.
- During the time running, the avg. CPU load isn't higher than 25%. Also, there's \
                only about 280 GB of RAM used. Therefore, it's not limitation of our \
                resources.
- When the framwork is running and libvirt is making its best to start our VMs, I \
noticed that every libvirt operation is suddenly very slow.  Even simple "virsh list \
[--all]" takes few seconds to complete, even though it finishes instantly when no VM \
is running/starting.

I was trying to search for this issue, but didn't really find anything besides this \
presentation: https://events19.linuxfoundation.org/wp-content/uploads/2017/12/Scalabil \
ity-and-Stability-of-libvirt-Experiences-with-Very-Large-Hosts-Marc-Hartmayer-IBM-1.pdf


However, I couldn't find those commits in your upstream.

Is this a known issue? Or is there some setting I don't know of which would magically \
make the VMs start faster?

As for steps to reproduce - I don't think there is anything special needed. Just try \
to start/destroy several VMs in a loop. There is even provided one-liner for that in \
the presentation above.

```
# For multiple domains:
# while virsh start $vm &amp;&amp; virsh destroy $vm; do : ; done
# → ~30s hang ups of the libvirtd main loop
```

Best Regards,
Petr


[Attachment #3 (text/html)]

&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"&gt;
&lt;style type="text/css" style="display:none;"&gt; P {margin-top:0;margin-bottom:0;} \
&lt;/style&gt; &lt;/head&gt;
&lt;body dir="ltr"&gt;
&lt;div style="font-family: Calibri, Helvetica, sans-serif; font-size: 12pt; color: \
rgb(0, 0, 0); background-color: rgb(255, 255, 255);"&gt; I forgot to mention:&lt;/div&gt;
&lt;div style="font-family: Calibri, Helvetica, sans-serif; font-size: 12pt; color: \
rgb(0, 0, 0); background-color: rgb(255, 255, 255);"&gt; &lt;br&gt;
&lt;/div&gt;
&lt;div style="font-family: Calibri, Helvetica, sans-serif; font-size: 12pt; color: \
rgb(0, 0, 0); background-color: rgb(255, 255, 255);"&gt; ```&lt;/div&gt;
&lt;div style="font-family: Calibri, Helvetica, sans-serif; font-size: 12pt; color: \
rgb(0, 0, 0); background-color: rgb(255, 255, 255);"&gt; $ lsb_release -a
&lt;div&gt;Distributor ID: Ubuntu&lt;/div&gt;
&lt;div&gt;Description:    Ubuntu 22.04 LTS&lt;/div&gt;
&lt;div&gt;Release:        22.04&lt;/div&gt;
&lt;div&gt;Codename:       jammy&lt;/div&gt;
&lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;$ virsh version&lt;/div&gt;
&lt;div&gt;Compiled against library: libvirt 8.0.0&lt;/div&gt;
&lt;div&gt;Using library: libvirt 8.0.0&lt;/div&gt;
&lt;div&gt;Using API: QEMU 8.0.0&lt;/div&gt;
Running hypervisor: QEMU 6.2.0&lt;br&gt;
&lt;/div&gt;
&lt;div style="font-family: Calibri, Helvetica, sans-serif; font-size: 12pt; color: \
rgb(0, 0, 0); background-color: rgb(255, 255, 255);"&gt; &lt;span style="color: rgb(0, 0, \
0); background-color: rgb(255, 255, 255); display: inline !important;"&gt;```&lt;/span&gt;&lt;br&gt; \
&lt;/div&gt; &lt;div style="font-family: Calibri, Helvetica, sans-serif; font-size: 12pt; \
color: rgb(0, 0, 0); background-color: rgb(255, 255, 255);"&gt; &lt;span style="color: \
rgb(0, 0, 0); background-color: rgb(255, 255, 255); display: inline !important;"&gt;&lt;br&gt; \
&lt;/span&gt;&lt;/div&gt; &lt;div id="appendonsend"&gt;&lt;/div&gt;
&lt;hr style="display:inline-block;width:98%" tabindex="-1"&gt;
&lt;div id="divRplyFwdMsg" dir="ltr"&gt;&lt;font face="Calibri, sans-serif" \
style="font-size:11pt" color="#000000"&gt;&lt;b&gt;Od:&lt;/b&gt; Petr Beneš \
&lt;w.benny@outlook.com&gt;&lt;br&gt; &lt;b&gt;Odesláno:&lt;/b&gt; pondělí 9. května 2022 20:52&lt;br&gt;
&lt;b&gt;Komu:&lt;/b&gt; libvirt-users@redhat.com &lt;libvirt-users@redhat.com&gt;&lt;br&gt;
&lt;b&gt;Předmět:&lt;/b&gt; Slow VM start/revert, when trying to start/revert dozens of VMs in \
parallel&lt;/font&gt; &lt;div&gt; &lt;/div&gt;
&lt;/div&gt;
&lt;style type="text/css" style="display:none"&gt;
&lt;!--
p
	{margin-top:0;
	margin-bottom:0}
--&gt;
&lt;/style&gt;
&lt;div dir="ltr"&gt;
&lt;div class="x_elementToProof" style="font-family:Calibri,Helvetica,sans-serif; \
font-size:12pt; color:rgb(0,0,0); background-color:rgb(255,255,255)"&gt; Hi,
&lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;my problem can be described simply: libvirt can't handle starting dozens of VMs \
at the same time.&lt;/div&gt; &lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;(technically, it can, but it's really slow.)&lt;/div&gt;
&lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;We have an AMD machine with 256 logical cores and 1.5T ram.&lt;/div&gt;
&lt;div&gt;On that machine there is roughly 200 VMs.&lt;/div&gt;
&lt;div&gt;Each VM is the same: 8GB of RAM, 4 VCPUs. Half of them is Win7 x86, the other \
half is Win7 x64.&lt;/div&gt; &lt;div&gt;VMs are using qcow2 as the disk image. These images \
reside in the ramdisk (tmpfs).&lt;/div&gt; &lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;We use these machines for automatic malware analysis, so our scenario consists \
of this cycle:&lt;/div&gt; &lt;div&gt;- reverting VM to a running state&lt;/div&gt;
&lt;div&gt;- execute sample inside of the VM for ~1-2 minutes&lt;/div&gt;
&lt;div&gt;- shutdown the VM&lt;/div&gt;
&lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;Of course, this results in multiple VMs trying to start at the same time.&lt;/div&gt;
&lt;div&gt;At first, reverts/starts are really fast - second or two.&lt;/div&gt;
&lt;div&gt;After about a minute, the "revertToSnapshot" suddenly takes 10-15 \
seconds, which is really unacceptable.&lt;/div&gt; &lt;div&gt;For comparison, we're running the \
same scenarion on Proxmox, where the revertToSnapshot usually takes 2 seconds.&lt;/div&gt; \
&lt;div&gt;&lt;br&gt; &lt;/div&gt;
&lt;div&gt;Few notes:&lt;/div&gt;
&lt;div&gt;- Because of this fast cycle (~2-3 minutes) and because of VMs taking 10-15 \
seconds to start, there is barely more than 25-30 VMs running at once.&lt;/div&gt; \
&lt;div&gt;  We would really love to utilise the whole potential of such beast machine \
of ours, and have at least ~100 VMs running at any given time.&lt;/div&gt; &lt;div&gt;- During \
the time running, the avg. CPU load isn't higher than 25%. Also, there's only about \
280 GB of RAM used. Therefore, it's not limitation of our resources.&lt;/div&gt; &lt;div&gt;- \
When the framwork is running and libvirt is making its best to start our VMs, I \
noticed that every libvirt operation is suddenly very slow.&lt;/div&gt; &lt;div&gt;  Even \
simple "virsh list [--all]" takes few seconds to complete, even though it \
finishes instantly when no VM is running/starting.&lt;/div&gt; &lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;I was trying to search for this issue, but didn't really find anything besides \
this presentation:&lt;/div&gt; \
&lt;div&gt;https://events19.linuxfoundation.org/wp-content/uploads/2017/12/Scalability-and-S \
tability-of-libvirt-Experiences-with-Very-Large-Hosts-Marc-Hartmayer-IBM-1.pdf&lt;/div&gt; \
&lt;div&gt;&lt;br&gt; &lt;/div&gt;
&lt;div&gt;However, I couldn't find those commits in your upstream.&lt;/div&gt;
&lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;Is this a known issue? Or is there some setting I don't know of which would \
magically make the VMs start faster?&lt;/div&gt; &lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;As for steps to reproduce - I don't think there is anything special needed. Just \
try to start/destroy several VMs in a loop.&lt;/div&gt; &lt;div&gt;There is even provided \
one-liner for that in the presentation above.&lt;/div&gt; &lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;```&lt;/div&gt;
&lt;div&gt;# For multiple domains:&lt;/div&gt;
&lt;div&gt;# while virsh start $vm &amp;&amp; virsh destroy $vm; do : ; done&lt;/div&gt;
&lt;div&gt;# → ~30s hang ups of the libvirtd main loop&lt;/div&gt;
&lt;div&gt;```&lt;/div&gt;
&lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;Best Regards,&lt;/div&gt;
&lt;div&gt;Petr&lt;/div&gt;
&lt;br&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;



</body></email><email><emailId>20220510080844</emailId><senderName>Daniel =?utf-8?B?UC4gQmVycmFuZ8Op?=</senderName><senderEmail>berrange@redhat.com</senderEmail><timestampReceived>2022-05-10 08:08:44-0400</timestampReceived><subject>Re: Slow VM start/revert, when trying to start/revert dozens of VMs in parallel</subject><body>

On Mon, May 09, 2022 at 06:52:32PM +0000, Petr Beneš wrote:
&gt; Hi,
&gt; 
&gt; my problem can be described simply: libvirt can't handle starting dozens of VMs at \
&gt; the same time. 
&gt; (technically, it can, but it's really slow.)
&gt; 
&gt; We have an AMD machine with 256 logical cores and 1.5T ram.
&gt; On that machine there is roughly 200 VMs.
&gt; Each VM is the same: 8GB of RAM, 4 VCPUs. Half of them is Win7 x86, the other half \
&gt; is Win7 x64. VMs are using qcow2 as the disk image. These images reside in the \
&gt; ramdisk (tmpfs). 
&gt; We use these machines for automatic malware analysis, so our scenario consists of \
&gt;                 this cycle:
&gt; - reverting VM to a running state
&gt; - execute sample inside of the VM for ~1-2 minutes
&gt; - shutdown the VM
&gt; 
&gt; Of course, this results in multiple VMs trying to start at the same time.
&gt; At first, reverts/starts are really fast - second or two.
&gt; After about a minute, the "revertToSnapshot" suddenly takes 10-15 seconds, which is \
&gt; really unacceptable. For comparison, we're running the same scenarion on Proxmox, \
&gt; where the revertToSnapshot usually takes 2 seconds.

Can you share the XML configuration of one of your guests - assuming
they all have the same basic configuration.

As a gut feeling it sounds to me like it could be initially fast due to
utilization of host I/O cache, but then slows down due to having to
flush data to disk / read fresh from disk. This could be the case if
the disk configuration cache mode is set to certain values, so the XML
config will show us this info.

With regards,
Daniel
-- 
&gt; &gt; https://berrange.com      -o-    https://www.flickr.com/photos/dberrange :|
&gt; &gt; https://libvirt.org         -o-            https://fstop138.berrange.com :|
&gt; &gt; https://entangle-photo.org    -o-    https://www.instagram.com/dberrange :|


</body></email><email><emailId>20220503083141</emailId><senderName>Daniel =?utf-8?B?UC4gQmVycmFuZ8Op?=</senderName><senderEmail>berrange@redhat.com</senderEmail><timestampReceived>2022-05-03 08:31:41-0400</timestampReceived><subject>Re: macvtap with disconnected physical interface</subject><body>

On Mon, May 02, 2022 at 03:42:05AM +0200, Gionatan Danti wrote:
&gt; Dear list,
&gt; I just discovered the hard way that if the lower lever physical interface of
&gt; a macvlan bridge is disconnected (ie: by unplugging the eth cable, resulting
&gt; in no carrier), inter-guest network traffic from all virtual machines bound
&gt; to the disconnected interface is dropped.
&gt; 
&gt; This behavior surprises me, as with the classic bridges I can disconnect the
&gt; underlying physical interface without causing any harm to inter-guest
&gt; traffic.
&gt; 
&gt; Am I doing something wrong, or this really is the expected behavior? If so,
&gt; can I force the macvtap interfaces to bridge traffic even when the
&gt; underlying physical interface is disconnected?

Can you share the &lt;interface&gt; configuration for your guest NIC so we
can see how it is setup.

With regards,
Daniel
-- 
|: https://berrange.com      -o-    https://www.flickr.com/photos/dberrange :|
|: https://libvirt.org         -o-            https://fstop138.berrange.com :|
|: https://entangle-photo.org    -o-    https://www.instagram.com/dberrange :|

</body></email><email><emailId>20220503125832</emailId><senderName>Laine Stump</senderName><senderEmail>laine@redhat.com</senderEmail><timestampReceived>2022-05-03 12:58:32-0400</timestampReceived><subject>Re: macvtap with disconnected physical interface</subject><body>

On 5/3/22 4:31 AM, Daniel P. Berrangé wrote:
&gt; On Mon, May 02, 2022 at 03:42:05AM +0200, Gionatan Danti wrote:
&gt;&gt; Dear list,
&gt;&gt; I just discovered the hard way that if the lower lever physical interface of
&gt;&gt; a macvlan bridge is disconnected (ie: by unplugging the eth cable, resulting
&gt;&gt; in no carrier), inter-guest network traffic from all virtual machines bound
&gt;&gt; to the disconnected interface is dropped.
&gt;&gt;
&gt;&gt; This behavior surprises me, as with the classic bridges I can disconnect the
&gt;&gt; underlying physical interface without causing any harm to inter-guest
&gt;&gt; traffic.
&gt;&gt;
&gt;&gt; Am I doing something wrong, or this really is the expected behavior? If so,
&gt;&gt; can I force the macvtap interfaces to bridge traffic even when the
&gt;&gt; underlying physical interface is disconnected?
&gt; 
&gt; Can you share the &lt;interface&gt; configuration for your guest NIC so we
&gt; can see how it is setup.

I can't say that I've ever tried this, since my only reason for using 
macvtap is to provide the guests with direct connectivity to the 
physical network, and unplugging the physdev negates that. The behavior 
you describe doesn't surprise me all that much though, since the 
physical device in the case of a host bridge isn't an integral part of 
the bridge (it's just one more device attached to a port), while the 
physical device and macvlan bridge a much more closely associated.

I'm Cc'ing Michael Tsirkin to see if he has more authoritative 
information on whether or not the macvtaps connected to a macvlan bridge 
can communicate amongst themselves when the physdev is disconnected.

In the meantime, is there a reason you don't want to just use a standard 
host bridge that's not connected to any physdev? The one thing I can 
think of is that you might not want to allow communication between the 
host and guests, but as long as the bridge itself isn't given an IP 
address, that won't be possible (at least at the level of IP).

</body></email><email><emailId>20220503205913</emailId><senderName>Gionatan Danti</senderName><senderEmail>g.danti@assyoma.it</senderEmail><timestampReceived>2022-05-03 20:59:13-0400</timestampReceived><subject>Re: macvtap with disconnected physical interface</subject><body>

Il 2022-05-03 10:31 Daniel P. Berrangé ha scritto:
&gt; Can you share the &lt;interface&gt; configuration for your guest NIC so we
&gt; can see how it is setup.

Here we go...

&lt;interface type='direct'&gt;
   &lt;mac address='xx:xx:xx:xx:xx:xx'/&gt;
   &lt;source dev='enp0s31f6' mode='bridge'/&gt;
   &lt;target dev='macvtap0'/&gt;
   &lt;model type='virtio'/&gt;
   &lt;alias name='net0'/&gt;
   &lt;address type='pci' domain='0x0000' bus='0x01' slot='0x00' 
function='0x0'/&gt;
&lt;/interface&gt;

# ifconfig
Both the physical and macvtap interfaces are disconnected (note how 
RUNNING is missing):
enp0s31f6: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500
         ether xx:xx:xx:xx:xx:xx  txqueuelen 1000  (Ethernet)
         RX packets 0  bytes 0 (0.0 B)
         RX errors 0  dropped 0  overruns 0  frame 0
         TX packets 0  bytes 0 (0.0 B)
         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
         device interrupt 16  memory 0xf4300000-f4320000
macvtap0: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500
         ether xx:xx:xx:xx:xx:xx  txqueuelen 500  (Ethernet)
         RX packets 0  bytes 0 (0.0 B)
         RX errors 0  dropped 0  overruns 0  frame 0
         TX packets 0  bytes 0 (0.0 B)
         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

# ip link
2: enp0s31f6: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc 
fq_codel state DOWN mode DEFAULT group default qlen 1000
     link/ether xx:xx:xx:xx:xx:xx brd ff:ff:ff:ff:ff:ff
6: macvtap0@enp0s31f6: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 
qdisc noqueue state LOWERLAYERDOWN mode DEFAULT group default qlen 500
     link/ether xx:xx:xx:xx:xx:xx brd ff:ff:ff:ff:ff:ff

I can bring up the macvtap interface with the following command (notice 
the RUNNING/UP flag):
# ip link set macvtap0 protodown off
# ifconfig
macvtap0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
         inet6 fe80::redacted  prefixlen 64  scopeid 0x20&lt;link&gt;
         ether xx:xx:xx:xx:xx:xx  txqueuelen 500  (Ethernet)
         RX packets 0  bytes 0 (0.0 B)
         RX errors 0  dropped 0  overruns 0  frame 0
         TX packets 42  bytes 6001 (6.0 KB)
         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
# ip link
6: macvtap0@enp0s31f6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc 
noqueue state UP mode DEFAULT group default qlen 500
     link/ether xx:xx:xx:xx:xx:xx brd ff:ff:ff:ff:ff:ff

However, at the next connection/disconnection of the physical link, the 
macvtap interface will go down again.

Regards.


-- 
Danti Gionatan
Supporto Tecnico
Assyoma S.r.l. - www.assyoma.it
email: g.danti@assyoma.it - info@assyoma.it
GPG public key ID: FF5F32A8

</body></email><email><emailId>20220503211526</emailId><senderName>Gionatan Danti</senderName><senderEmail>g.danti@assyoma.it</senderEmail><timestampReceived>2022-05-03 21:15:26-0400</timestampReceived><subject>Re: macvtap with disconnected physical interface</subject><body>

Il 2022-05-03 14:58 Laine Stump ha scritto:
&gt; I can't say that I've ever tried this, since my only reason for using
&gt; macvtap is to provide the guests with direct connectivity to the
&gt; physical network, and unplugging the physdev negates that. The
&gt; behavior you describe doesn't surprise me all that much though, since
&gt; the physical device in the case of a host bridge isn't an integral
&gt; part of the bridge (it's just one more device attached to a port),
&gt; while the physical device and macvlan bridge a much more closely
&gt; associated.

Yeah, it sound very plausible.

&gt; I'm Cc'ing Michael Tsirkin to see if he has more authoritative
&gt; information on whether or not the macvtaps connected to a macvlan
&gt; bridge can communicate amongst themselves when the physdev is
&gt; disconnected.

Thanks.

&gt; In the meantime, is there a reason you don't want to just use a
&gt; standard host bridge that's not connected to any physdev? The one
&gt; thing I can think of is that you might not want to allow communication
&gt; between the host and guests, but as long as the bridge itself isn't
&gt; given an IP address, that won't be possible (at least at the level of
&gt; IP).

I generally use plain bridge for my KVM setup. Specifically, when using 
VLANs I setup the following:
eth -&gt; eth.xx -&gt; bridge -&gt; vnet

This time, however, I need *both* a trunk-enabled VM (a virtual 
firewall) and other segregated virtual machines. A "plain" bridge setup 
would be something as:
eth -&gt; bridge -&gt; bridge.xx -&gt; bridge -&gt; vnet

Notice the two bridges, needed because bridge.xx is a VLAN interface 
when no vnet can be directly attached. To avoid the double bridges, I 
tried the following:
eth -&gt; bridge -&gt; bridge.xx -&gt; macvtap

It seems to work very well but, during testing, I discovered that if the 
interface under the macvtap one (in this case the bridge itself) goes 
down, inter-guest networking is lost. As a side note, in the specific 
scenario I described above, such issues can not really happen: as a vnet 
interface is going to be always bound to the first bridge, it will be 
*always* up due to the vnet interface itself being always up 
(irrespective of the physical link status) and forcing the bridge up.

However, working so well, I thought to change my classical bridge setup 
with a macvtap based one even for simpler installation. In short, going 
from:
eth -&gt; bridge -&gt; vnet
to:
eth -&gt; macvtap

But this very simple setup is going deny all guest traffic should the 
physical interface become disconnected. A very crude solution would be 
to issues "ip link set macvtap0 protodown off" when the physical link 
goes down, but I wonder if a better solution exists.

That said, is replacing classical bridges with macvtap interfaces a bad 
idea? Anything I should know before doing that?
Regards.

-- 
Danti Gionatan
Supporto Tecnico
Assyoma S.r.l. - www.assyoma.it
email: g.danti@assyoma.it - info@assyoma.it
GPG public key ID: FF5F32A8

</body></email><email><emailId>20220503220319</emailId><senderName>"Michael S. Tsirkin"</senderName><senderEmail>mst@redhat.com</senderEmail><timestampReceived>2022-05-03 22:03:19-0400</timestampReceived><subject>Re: macvtap with disconnected physical interface</subject><body>

On Tue, May 03, 2022 at 11:15:26PM +0200, Gionatan Danti wrote:
&gt; Il 2022-05-03 14:58 Laine Stump ha scritto:
&gt; &gt; I can't say that I've ever tried this, since my only reason for using
&gt; &gt; macvtap is to provide the guests with direct connectivity to the
&gt; &gt; physical network, and unplugging the physdev negates that. The
&gt; &gt; behavior you describe doesn't surprise me all that much though, since
&gt; &gt; the physical device in the case of a host bridge isn't an integral
&gt; &gt; part of the bridge (it's just one more device attached to a port),
&gt; &gt; while the physical device and macvlan bridge a much more closely
&gt; &gt; associated.
&gt; 
&gt; Yeah, it sound very plausible.
&gt; 
&gt; &gt; I'm Cc'ing Michael Tsirkin to see if he has more authoritative
&gt; &gt; information on whether or not the macvtaps connected to a macvlan
&gt; &gt; bridge can communicate amongst themselves when the physdev is
&gt; &gt; disconnected.
&gt; 
&gt; Thanks.
&gt; 
&gt; &gt; In the meantime, is there a reason you don't want to just use a
&gt; &gt; standard host bridge that's not connected to any physdev? The one
&gt; &gt; thing I can think of is that you might not want to allow communication
&gt; &gt; between the host and guests, but as long as the bridge itself isn't
&gt; &gt; given an IP address, that won't be possible (at least at the level of
&gt; &gt; IP).
&gt; 
&gt; I generally use plain bridge for my KVM setup. Specifically, when using
&gt; VLANs I setup the following:
&gt; eth -&gt; eth.xx -&gt; bridge -&gt; vnet
&gt; 
&gt; This time, however, I need *both* a trunk-enabled VM (a virtual firewall)
&gt; and other segregated virtual machines. A "plain" bridge setup would be
&gt; something as:
&gt; eth -&gt; bridge -&gt; bridge.xx -&gt; bridge -&gt; vnet
&gt; 
&gt; Notice the two bridges, needed because bridge.xx is a VLAN interface when no
&gt; vnet can be directly attached. To avoid the double bridges, I tried the
&gt; following:
&gt; eth -&gt; bridge -&gt; bridge.xx -&gt; macvtap
&gt; 
&gt; It seems to work very well but, during testing, I discovered that if the
&gt; interface under the macvtap one (in this case the bridge itself) goes down,
&gt; inter-guest networking is lost. As a side note, in the specific scenario I
&gt; described above, such issues can not really happen: as a vnet interface is
&gt; going to be always bound to the first bridge, it will be *always* up due to
&gt; the vnet interface itself being always up (irrespective of the physical link
&gt; status) and forcing the bridge up.

well this is kind of by design. if we don't force guest's link
down it will think it can access internet, with all packets
being lost.
I see how you might want that in some cases - maybe we
should consider an option to disable this behaviour.

&gt; However, working so well, I thought to change my classical bridge setup with
&gt; a macvtap based one even for simpler installation. In short, going from:
&gt; eth -&gt; bridge -&gt; vnet
&gt; to:
&gt; eth -&gt; macvtap
&gt; 
&gt; But this very simple setup is going deny all guest traffic should the
&gt; physical interface become disconnected. A very crude solution would be to
&gt; issues "ip link set macvtap0 protodown off" when the physical link goes
&gt; down, but I wonder if a better solution exists.
&gt; 
&gt; That said, is replacing classical bridges with macvtap interfaces a bad
&gt; idea? Anything I should know before doing that?
&gt; Regards.
&gt; 
&gt; -- 
&gt; Danti Gionatan
&gt; Supporto Tecnico
&gt; Assyoma S.r.l. - www.assyoma.it
&gt; email: g.danti@assyoma.it - info@assyoma.it
&gt; GPG public key ID: FF5F32A8

</body></email><email><emailId>20220504072425</emailId><senderName>Gionatan Danti</senderName><senderEmail>g.danti@assyoma.it</senderEmail><timestampReceived>2022-05-04 07:24:25-0400</timestampReceived><subject>Re: macvtap with disconnected physical interface</subject><body>

Il 2022-05-04 00:03 Michael S. Tsirkin ha scritto:
&gt; well this is kind of by design. if we don't force guest's link
&gt; down it will think it can access internet, with all packets
&gt; being lost.

I understand. But in my opinion, inter-guest communication should be 
preserved because:
a) this is how the classical bridge mode works;
b) modern guest have internal checks for internet connection;
c) guest-to-guest communication should not be impaired by (lack of) 
internet access.

&gt; I see how you might want that in some cases - maybe we
&gt; should consider an option to disable this behaviour.

It would be great - especially as default behavior.
In the meantime, do we have some virsh command (or libvirt xml snippet) 
to work around the issue, rather than messing with "ip link protodown 
off"?

Thanks.

-- 
Danti Gionatan
Supporto Tecnico
Assyoma S.r.l. - www.assyoma.it
email: g.danti@assyoma.it - info@assyoma.it
GPG public key ID: FF5F32A8

</body></email><email><emailId>20220509064211</emailId><senderName>Gionatan Danti</senderName><senderEmail>g.danti@assyoma.it</senderEmail><timestampReceived>2022-05-09 06:42:11-0400</timestampReceived><subject>Re: macvtap with disconnected physical interface</subject><body>

Il 2022-05-03 23:15 Gionatan Danti ha scritto:
&gt; I generally use plain bridge for my KVM setup. Specifically, when
&gt; using VLANs I setup the following:
&gt; eth -&gt; eth.xx -&gt; bridge -&gt; vnet
&gt; 
&gt; This time, however, I need *both* a trunk-enabled VM (a virtual
&gt; firewall) and other segregated virtual machines. A "plain" bridge
&gt; setup would be something as:
&gt; eth -&gt; bridge -&gt; bridge.xx -&gt; bridge -&gt; vnet
&gt; 
&gt; Notice the two bridges, needed because bridge.xx is a VLAN interface
&gt; when no vnet can be directly attached. To avoid the double bridges, I
&gt; tried the following:
&gt; eth -&gt; bridge -&gt; bridge.xx -&gt; macvtap
&gt; 
&gt; It seems to work very well but, during testing, I discovered that if
&gt; the interface under the macvtap one (in this case the bridge itself)
&gt; goes down, inter-guest networking is lost. As a side note, in the
&gt; specific scenario I described above, such issues can not really
&gt; happen: as a vnet interface is going to be always bound to the first
&gt; bridge, it will be *always* up due to the vnet interface itself being
&gt; always up (irrespective of the physical link status) and forcing the
&gt; bridge up.
&gt; 
&gt; However, working so well, I thought to change my classical bridge
&gt; setup with a macvtap based one even for simpler installation. In
&gt; short, going from:
&gt; eth -&gt; bridge -&gt; vnet
&gt; to:
&gt; eth -&gt; macvtap
&gt; 
&gt; But this very simple setup is going deny all guest traffic should the
&gt; physical interface become disconnected. A very crude solution would be
&gt; to issues "ip link set macvtap0 protodown off" when the physical link
&gt; goes down, but I wonder if a better solution exists.
&gt; 
&gt; That said, is replacing classical bridges with macvtap interfaces a
&gt; bad idea? Anything I should know before doing that?
&gt; Regards.

Hi all,
any comment / suggestion on the steps described above? Does a simpler 
approach exists?

Thanks.

-- 
Danti Gionatan
Supporto Tecnico
Assyoma S.r.l. - www.assyoma.it
email: g.danti@assyoma.it - info@assyoma.it
GPG public key ID: FF5F32A8

</body></email><email><emailId>20220512203453</emailId><senderName>Laine Stump</senderName><senderEmail>laine@redhat.com</senderEmail><timestampReceived>2022-05-12 20:34:53-0400</timestampReceived><subject>Re: Updating domains definitions via API</subject><body>

On 5/12/22 4:03 PM, Darragh Bailey wrote:
&gt; Hi,
&gt; 
&gt; 
&gt; Looking into a bug in vagrant-libvirt where an error during the update 
&gt; will cause the domain to be completely discarded.
&gt; 
&gt; https://github.com/vagrant-libvirt/vagrant-libvirt/issues/949 
&gt; &lt;https://github.com/vagrant-libvirt/vagrant-libvirt/issues/949&gt;
&gt; 
&gt; Basically I think it stems from doing an undefine -&gt; create with XML new 
&gt; process, which if there is an issue with the new XML due to KVM module 
&gt; not loaded or something similar it will be rejected, but unfortunately 
&gt; it is also unlikely to allow the old definition to be restored either.
&gt; 
&gt; I'm looking around to try and see if there is an API (specfically in 
&gt; ruby-libvirt) for updating the domain definition, so that if the new XML 
&gt; is rejected at least the old definition remains, and so far I'm drawing 
&gt; a blank.
&gt; 
&gt; Is the only option here to write using a temporary domain name, then 
&gt; remove the old domain and rename the new definition to the old domain?
&gt; 
&gt; Or have I missed the obvious API analogous to the edit functionality?

The virDomainDefineXMLFlags API (and also the older/deprecated 
virDomainDefineXML API) doesn't require that the domain first be 
undefined (with one notable exception - see below[*]). If you define a 
domain that already exists with the same name and uuid, then the effect 
is to "redefine" (or "update" if you prefer) the existing domain of that 
name. If the domain is currently active, then the changes will take 
effect the next time the domain is shut down ("Destroy"ed in libvirt API 
parlance) and re-started.

If any error is encountered during this redefinition, then no changes 
are made to the existing domain definition.

[*]The exception to this - if you attempt to Define a domain that has 
the same name or uuid as an existing domain, but the uuid/name is 
different, that is an error.

</body></email><email><emailId>20220512231739</emailId><senderName>Darragh Bailey</senderName><senderEmail>daragh.bailey@gmail.com</senderEmail><timestampReceived>2022-05-12 23:17:39-0400</timestampReceived><subject>Re: Updating domains definitions via API</subject><body>

Hi,

On Thu 12 May 2022, 21:34 Laine Stump, &lt;laine@redhat.com&gt; wrote:

&gt; The virDomainDefineXMLFlags API (and also the older/deprecated
&gt; virDomainDefineXML API) doesn't require that the domain first be
&gt; undefined (with one notable exception - see below[*]). If you define a
&gt; domain that already exists with the same name and uuid, then the effect
&gt; is to "redefine" (or "update" if you prefer) the existing domain of that
&gt; name. If the domain is currently active, then the changes will take
&gt; effect the next time the domain is shut down ("Destroy"ed in libvirt API
&gt; parlance) and re-started.
&gt;

That makes it much easier, and makes what the code was previously doing
rather stupid. Probably a case that I never thought to read the API doc for
virDomainDefineXML

If any error is encountered during this redefinition, then no changes
&gt; are made to the existing domain definition.
&gt;

That is the ideal behaviour

&gt;
&gt; [*]The exception to this - if you attempt to Define a domain that has
&gt; the same name or uuid as an existing domain, but the uuid/name is
&gt; different, that is an error.
&gt;


Are there any gotchas/limitations dealing with NVRAM when redefining
domains that I should be aware of? Typically setting some flags to allow
the undefine to work as expected, just not clear whether a NVRAM file could
be orphaned by updating the domain XML, or if a reference will be
maintained so if a domain once had NVRAM it's necessary to pass the flag to
remove on undefine. Hopefully nget to test around some of this later, just
not sure I know enough to ensure I check all behaviours.

--
Darragh Bailey
"Nothing is foolproof to a sufficiently talented fool" - unknown

&gt;

[Attachment #3 (text/html)]

&lt;div dir="auto"&gt;&lt;div&gt;Hi,&lt;br&gt;&lt;div data-smartmail="gmail_signature"&gt;&lt;br&gt;&lt;/div&gt;&lt;div \
class="gmail_quote"&gt;&lt;div dir="ltr" class="gmail_attr"&gt;On Thu 12 May 2022, 21:34 Laine \
Stump, &lt;&lt;a href="mailto:laine@redhat.com"&gt;laine@redhat.com&lt;/a&gt;&gt; \
wrote:&lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px \
#ccc solid;padding-left:1ex"&gt; The virDomainDefineXMLFlags API (and also the \
older/deprecated &lt;br&gt; virDomainDefineXML API) doesn't require that the domain \
first be &lt;br&gt; undefined (with one notable exception - see below[*]). If you define a \
&lt;br&gt; domain that already exists with the same name and uuid, then the effect &lt;br&gt;
is to "redefine" (or "update" if you prefer) the existing domain \
of that &lt;br&gt; name. If the domain is currently active, then the changes will take &lt;br&gt;
effect the next time the domain is shut down ("Destroy"ed in libvirt API \
&lt;br&gt; parlance) and re-started.&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;&lt;div \
dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div dir="auto"&gt;That makes it much easier, and makes what the \
code was previously doing rather stupid. Probably a case that I never thought to read \
the API doc for virDomainDefineXML&lt;/div&gt;&lt;div dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div \
dir="auto"&gt;&lt;div class="gmail_quote"&gt;&lt;blockquote class="gmail_quote" style="margin:0 0 \
0 .8ex;border-left:1px #ccc solid;padding-left:1ex"&gt;If any error is encountered \
during this redefinition, then no changes &lt;br&gt; are made to the existing domain \
definition.&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;&lt;div dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div \
dir="auto"&gt;That is the ideal behaviour&lt;/div&gt;&lt;div dir="auto"&gt;&lt;div \
class="gmail_quote"&gt;&lt;blockquote class="gmail_quote" style="margin:0 0 0 \
.8ex;border-left:1px #ccc solid;padding-left:1ex"&gt; &lt;br&gt;
[*]The exception to this - if you attempt to Define a domain that has &lt;br&gt;
the same name or uuid as an existing domain, but the uuid/name is &lt;br&gt;
different, that is an error.&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;&lt;div \
dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div dir="auto"&gt;Are there any \
gotchas/limitations dealing with NVRAM when redefining domains that I should be aware \
of? Typically setting some flags to allow the undefine to work as expected, just not \
clear whether a NVRAM file could be orphaned by updating the domain XML, or if a \
reference will be maintained so if a domain once had NVRAM it's necessary to pass \
the flag to remove on undefine. Hopefully nget to test around some of this later, \
just not sure I know enough to ensure I check all behaviours.&lt;/div&gt;&lt;div \
dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div dir="auto"&gt;--&lt;/div&gt;&lt;div dir="auto"&gt;Darragh \
Bailey&lt;br&gt;"Nothing is foolproof to a sufficiently talented fool" - \
unknown&lt;br&gt;&lt;/div&gt;&lt;div dir="auto"&gt;&lt;div class="gmail_quote"&gt;&lt;blockquote \
class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc \
solid;padding-left:1ex"&gt; &lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220514192334</emailId><senderName>Darragh Bailey</senderName><senderEmail>daragh.bailey@gmail.com</senderEmail><timestampReceived>2022-05-14 19:23:34-0400</timestampReceived><subject>Re: Updating domains definitions via API</subject><body>

On Fri, 13 May 2022 at 00:17, Darragh Bailey &lt;daragh.bailey@gmail.com&gt;
wrote:

&gt; Hi,
&gt;
&gt; On Thu 12 May 2022, 21:34 Laine Stump, &lt;laine@redhat.com&gt; wrote:
&gt;
&gt;&gt; The virDomainDefineXMLFlags API (and also the older/deprecated
&gt;&gt; virDomainDefineXML API) doesn't require that the domain first be
&gt;&gt; undefined (with one notable exception - see below[*]). If you define a
&gt;&gt; domain that already exists with the same name and uuid, then the effect
&gt;&gt; is to "redefine" (or "update" if you prefer) the existing domain of that
&gt;&gt; name. If the domain is currently active, then the changes will take
&gt;&gt; effect the next time the domain is shut down ("Destroy"ed in libvirt API
&gt;&gt; parlance) and re-started.
&gt;&gt;
&gt;
Unfortunately trying to call this via ruby-libvirt doesn't appear to behave
as expected. It appears that if I add an nvram element without a loader
element to the os block, the following code block will execute without
issue but also without changing the domain XML:

# Apply XML changes directly
if descr_changed
  begin
    env[:ui].info("Updating domain definition due to configuration change")
    new_descr = String.new
    xml_descr.write new_descr
    # env[:machine].provider.driver.connection.client provides access to
the ruby-libvirt connection object
    libvirt_domain =
env[:machine].provider.driver.connection.client.define_domain_xml(new_descr,
1)
    domain =
env[:machine].provider.driver.connection.servers.get(env[:machine].id.to_s)
  rescue Fog::Errors::Error =&gt; e
    raise Errors::UpdateServerError, error_message: e.message
  end
end

I've by-passing the fog-libvirt to call the ruby-libvirt connection object
directly to try and avoid any unexpected interference when testing the API
call out e.g.
https://libvirt.org/ruby/api/Libvirt/Connect.html#method-i-define_domain_xml

So not only is there no exception thrown if the XML change is ignored, I've
noticed there doesn't appear to be an easy way to check using the API
either, in that
https://libvirt.org/ruby/api/Libvirt/Domain.html#method-i-updated-3F
doesn't indicate that the domain has been updated whether I call it on the
libvirt_domain object returned, or an instance from before the
define_domain_xml call is made.

It appears that the only way is to perform a call to get the xml definition
of the libvirt_domain object returned in the above block and see if that
matches the xml that was sent, if not, error.

Is this the expected usage of the API? Or should the call to
define_domain_xml raise an exception if it cannot update the domain XML? as
opposed to a schema validation error which does appear to be detected when
I did something stupid.

--
Darragh

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;&lt;br&gt;&lt;div class="gmail_quote"&gt;&lt;div dir="ltr" class="gmail_attr"&gt;On Fri, \
13 May 2022 at 00:17, Darragh Bailey &lt;&lt;a \
href="mailto:daragh.bailey@gmail.com"&gt;daragh.bailey@gmail.com&lt;/a&gt;&gt; \
wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0px 0px 0px \
0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"&gt;&lt;div \
dir="auto"&gt;&lt;div&gt;Hi,&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div class="gmail_quote"&gt;&lt;div dir="ltr" \
class="gmail_attr"&gt;On Thu 12 May 2022, 21:34 Laine Stump, &lt;&lt;a \
href="mailto:laine@redhat.com" target="_blank"&gt;laine@redhat.com&lt;/a&gt;&gt; \
wrote:&lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0px 0px 0px \
0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"&gt; The \
virDomainDefineXMLFlags API (and also the older/deprecated &lt;br&gt; virDomainDefineXML \
API) doesn't require that the domain first be &lt;br&gt; undefined (with one notable \
exception - see below[*]). If you define a &lt;br&gt; domain that already exists with the \
same name and uuid, then the effect &lt;br&gt; is to "redefine" (or \
"update" if you prefer) the existing domain of that &lt;br&gt; name. If the \
domain is currently active, then the changes will take &lt;br&gt; effect the next time the \
domain is shut down ("Destroy"ed in libvirt API &lt;br&gt; parlance) and \
re-started.&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Unfortunately \
trying to call this via ruby-libvirt doesn't appear to behave as expected. It \
appears that if I add an nvram element without a loader element to the os block, the \
following code block will execute without issue but also without changing the domain \
XML:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;span style="font-family:monospace"&gt;# Apply XML changes \
directly&lt;br&gt;if descr_changed&lt;br&gt;   begin&lt;br&gt;      env[:ui].info("Updating domain \
definition due to configuration change")&lt;br&gt;      new_descr = String.new&lt;br&gt;     \
xml_descr.write new_descr&lt;/span&gt;&lt;/div&gt;&lt;div class="gmail_quote"&gt;&lt;span \
style="font-family:monospace"&gt;       # &lt;span \
style="font-family:monospace"&gt;env[:machine].provider.driver.connection.client \
provides access to the ruby-libvirt connection object&lt;br&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div \
class="gmail_quote"&gt;&lt;span style="font-family:monospace"&gt;      libvirt_domain = \
env[:machine].provider.driver.connection.client.define_domain_xml(new_descr, 1)&lt;br&gt;   \
domain = env[:machine].provider.driver.connection.servers.get(env[:machine].id.to_s)&lt;br&gt; \
rescue Fog::Errors::Error =&gt; e&lt;br&gt;      raise Errors::UpdateServerError, \
error_message: e.message&lt;br&gt;   end&lt;br&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div \
class="gmail_quote"&gt;&lt;br&gt;&lt;/div&gt;&lt;div class="gmail_quote"&gt;I've by-passing the \
fog-libvirt to call the ruby-libvirt connection object directly to try and avoid any \
unexpected interference when testing the API call out e.g. &lt;a \
href="https://libvirt.org/ruby/api/Libvirt/Connect.html#method-i-define_domain_xml"&gt;ht \
tps://libvirt.org/ruby/api/Libvirt/Connect.html#method-i-define_domain_xml&lt;/a&gt;&lt;/div&gt;&lt;div \
class="gmail_quote"&gt;&lt;br&gt;&lt;/div&gt;&lt;div class="gmail_quote"&gt;So not only is there no \
exception thrown if the XML change is ignored, I've noticed there doesn't \
appear to be an easy way to check using the API either, in that &lt;a \
href="https://libvirt.org/ruby/api/Libvirt/Domain.html#method-i-updated-3F"&gt;https://libvirt.org/ruby/api/Libvirt/Domain.html#method-i-updated-3F&lt;/a&gt; \
doesn't indicate that the domain has been updated whether I call it on the \
libvirt_domain object returned, or an instance from before the define_domain_xml call \
is made.&lt;/div&gt;&lt;div class="gmail_quote"&gt;&lt;br&gt;&lt;/div&gt;&lt;div class="gmail_quote"&gt;It appears \
that the only way is to perform a call to get the xml definition of the \
libvirt_domain object returned in the above block and see if that matches the xml \
that was sent, if not, error.&lt;/div&gt;&lt;div class="gmail_quote"&gt;&lt;br&gt;&lt;/div&gt;&lt;div \
class="gmail_quote"&gt;Is this the expected usage of the API? Or should the call to \
define_domain_xml raise an exception if it cannot update the domain XML? as opposed \
to a schema validation error which does appear to be detected when I did something \
stupid.&lt;/div&gt;&lt;div class="gmail_quote"&gt;&lt;br&gt;&lt;/div&gt;&lt;div \
class="gmail_quote"&gt;--&lt;br&gt;&lt;/div&gt;&lt;div class="gmail_quote"&gt;Darragh&lt;br&gt;&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220514201113</emailId><senderName>Laine Stump</senderName><senderEmail>laine@redhat.com</senderEmail><timestampReceived>2022-05-14 20:11:13-0400</timestampReceived><subject>Re: Updating domains definitions via API</subject><body>

On 5/14/22 3:23 PM, Darragh Bailey wrote:
&gt; 
&gt; On Fri, 13 May 2022 at 00:17, Darragh Bailey &lt;daragh.bailey@gmail.com 
&gt; &lt;mailto:daragh.bailey@gmail.com&gt;&gt; wrote:
&gt; 
&gt;     Hi,
&gt; 
&gt;     On Thu 12 May 2022, 21:34 Laine Stump, &lt;laine@redhat.com
&gt;     &lt;mailto:laine@redhat.com&gt;&gt; wrote:
&gt; 
&gt;         The virDomainDefineXMLFlags API (and also the older/deprecated
&gt;         virDomainDefineXML API) doesn't require that the domain first be
&gt;         undefined (with one notable exception - see below[*]). If you
&gt;         define a
&gt;         domain that already exists with the same name and uuid, then the
&gt;         effect
&gt;         is to "redefine" (or "update" if you prefer) the existing domain
&gt;         of that
&gt;         name. If the domain is currently active, then the changes will take
&gt;         effect the next time the domain is shut down ("Destroy"ed in
&gt;         libvirt API
&gt;         parlance) and re-started.
&gt; 
&gt; 
&gt; Unfortunately trying to call this via ruby-libvirt doesn't appear to 
&gt; behave as expected. It appears that if I add an nvram element without a 
&gt; loader element to the os block, the following code block will execute 
&gt; without issue but also without changing the domain XML:
&gt; 
&gt; # Apply XML changes directly
&gt; if descr_changed
&gt;    begin
&gt;      env[:ui].info("Updating domain definition due to configuration change")
&gt;      new_descr = String.new
&gt;      xml_descr.write new_descr
&gt;      # env[:machine].provider.driver.connection.client provides access 
&gt; to the ruby-libvirt connection object
&gt;      libvirt_domain = 
&gt; env[:machine].provider.driver.connection.client.define_domain_xml(new_descr, 
&gt; 1)
&gt;      domain = 
&gt; env[:machine].provider.driver.connection.servers.get(env[:machine].id.to_s)
&gt;    rescue Fog::Errors::Error =&gt; e
&gt;      raise Errors::UpdateServerError, error_message: e.message
&gt;    end
&gt; end
&gt; 
&gt; I've by-passing the fog-libvirt to call the ruby-libvirt connection 
&gt; object directly to try and avoid any unexpected interference when 
&gt; testing the API call out e.g. 
&gt; https://libvirt.org/ruby/api/Libvirt/Connect.html#method-i-define_domain_xml 
&gt; &lt;https://libvirt.org/ruby/api/Libvirt/Connect.html#method-i-define_domain_xml&gt;
&gt; 
&gt; So not only is there no exception thrown if the XML change is ignored, 
&gt; I've noticed there doesn't appear to be an easy way to check using the 
&gt; API either, in that 
&gt; https://libvirt.org/ruby/api/Libvirt/Domain.html#method-i-updated-3F 
&gt; &lt;https://libvirt.org/ruby/api/Libvirt/Domain.html#method-i-updated-3F&gt; 
&gt; doesn't indicate that the domain has been updated whether I call it on 
&gt; the libvirt_domain object returned, or an instance from before the 
&gt; define_domain_xml call is made.
&gt; 
&gt; It appears that the only way is to perform a call to get the xml 
&gt; definition of the libvirt_domain object returned in the above block and 
&gt; see if that matches the xml that was sent, if not, error.
&gt; 
&gt; Is this the expected usage of the API? Or should the call to 
&gt; define_domain_xml raise an exception if it cannot update the domain XML? 
&gt; as opposed to a schema validation error which does appear to be detected 
&gt; when I did something stupid.

Caveat - I'm completely unfamiliar with ruby and the libvirt-ruby API 
bindings.

If there is a problem that causes the domain config to not be updated, 
libvirt will return an error. So I would suspect one of the two things 
is happening:

1) there may be a problem in the libvirt-ruby bindings that causes the 
error reported by the call (in whatever C code is behind the ruby 
bindings) to libvirt to be properly propagated to ruby. I would hope 
this isn't the case, but "bugs happen", so it should be considered as a 
possibility.

2) As I said in my earlier mail, any changes that are made will take 
effect the next time the domain is destroyed and restarted. This also 
means that the changes won't be reflected in the "live/status" XML of 
the domain until that time. If you want to see the new configuration 
after you've made changes, you should add the VIR_DOMAIN_XML_INACTIVE 
flag when requesting the domain XML. Possibly you haven't included this 
flag, and that's why you think that your change hasn't taken effect?

</body></email><email><emailId>20220514224213</emailId><senderName>Darragh Bailey</senderName><senderEmail>daragh.bailey@gmail.com</senderEmail><timestampReceived>2022-05-14 22:42:13-0400</timestampReceived><subject>Re: Updating domains definitions via API</subject><body>

Hi,

On Sat 14 May 2022, 21:11 Laine Stump, &lt;laine@redhat.com&gt; wrote:

&gt; Caveat - I'm completely unfamiliar with ruby and the libvirt-ruby API
&gt; bindings.
&gt;
&gt; If there is a problem that causes the domain config to not be updated,
&gt; libvirt will return an error. So I would suspect one of the two things
&gt; is happening:
&gt;

Thanks, that's what I was expecting should happen, just wanted to be sure
that there wasn't some other behaviour in place for compatibility reasons.

1) there may be a problem in the libvirt-ruby bindings that causes the
&gt; error reported by the call (in whatever C code is behind the ruby
&gt; bindings) to libvirt to be properly propagated to ruby. I would hope
&gt; this isn't the case, but "bugs happen", so it should be considered as a
&gt; possibility.
&gt;

A quick look suggests that the code looks to raise an exception if the dom
pointer returned is NULL, so I think the bindings are correct. But I will
check that what version of ruby-libvirt I have installed matches the source
code I'm looked at.

2) As I said in my earlier mail, any changes that are made will take
&gt; effect the next time the domain is destroyed and restarted. This also
&gt; means that the changes won't be reflected in the "live/status" XML of
&gt; the domain until that time. If you want to see the new configuration
&gt; after you've made changes, you should add the VIR_DOMAIN_XML_INACTIVE
&gt; flag when requesting the domain XML. Possibly you haven't included this
&gt; flag, and that's why you think that your change hasn't taken effect?
&gt;

Ah, I forgot to outline where in the lifecycle the update is taking place.
The domain isn't running when the code attempts to update the definition.

Does that still mean that the VIR_DOMAIN_XML_INACTIVE flag is needed? I was
assuming when the domain is inactive the XML changes would be reflected
immediately.

Oddly I thought during some experiments when the added NVRAM XML element
was ignored, the updated number of CPUs which was in the same XML
definition passed in was applied.

Will dig further tomorrow or Monday on the version of ruby-libvirt
installed into my rvm dev env as well as checking passing in the flag.

I'm sure it'll turn out to be something obvious that I'm overlooking.

Thanks,
--
Darragh

&gt;

[Attachment #3 (text/html)]

&lt;div dir="auto"&gt;&lt;div&gt;&lt;div data-smartmail="gmail_signature"&gt;Hi,&lt;/div&gt;&lt;div \
data-smartmail="gmail_signature" dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div class="gmail_quote"&gt;&lt;div \
dir="ltr" class="gmail_attr"&gt;On Sat 14 May 2022, 21:11 Laine Stump, &lt;&lt;a \
href="mailto:laine@redhat.com"&gt;laine@redhat.com&lt;/a&gt;&gt; wrote:&lt;/div&gt;&lt;blockquote \
class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc \
solid;padding-left:1ex"&gt; Caveat - I'm completely unfamiliar with ruby and the \
libvirt-ruby API &lt;br&gt; bindings.&lt;br&gt;
&lt;br&gt;
If there is a problem that causes the domain config to not be updated, &lt;br&gt;
libvirt will return an error. So I would suspect one of the two things &lt;br&gt;
is happening:&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;&lt;div dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div \
dir="auto"&gt;Thanks, that's what I was expecting should happen, just wanted to be \
sure that there wasn't some other behaviour in place for compatibility \
reasons.&lt;/div&gt;&lt;div dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div dir="auto"&gt;&lt;div \
class="gmail_quote"&gt;&lt;blockquote class="gmail_quote" style="margin:0 0 0 \
.8ex;border-left:1px #ccc solid;padding-left:1ex"&gt;1) there may be a problem in the \
libvirt-ruby bindings that causes the &lt;br&gt; error reported by the call (in whatever C \
code is behind the ruby &lt;br&gt; bindings) to libvirt to be properly propagated to ruby. \
I would hope &lt;br&gt; this isn't the case, but "bugs happen", so it should \
be considered as a &lt;br&gt; possibility.&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;&lt;div \
dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div dir="auto"&gt;A quick look suggests that the code looks to \
raise an exception if the dom pointer returned is NULL, so I think the bindings are \
correct. But I will check that what version of ruby-libvirt I have installed matches \
the source code I'm looked at.&lt;/div&gt;&lt;div dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div \
dir="auto"&gt;&lt;div class="gmail_quote"&gt;&lt;blockquote class="gmail_quote" style="margin:0 0 \
0 .8ex;border-left:1px #ccc solid;padding-left:1ex"&gt;2) As I said in my earlier mail, \
any changes that are made will take &lt;br&gt; effect the next time the domain is destroyed \
and restarted. This also &lt;br&gt; means that the changes won't be reflected in the \
"live/status" XML of &lt;br&gt; the domain until that time. If you want to see \
the new configuration &lt;br&gt; after you've made changes, you should add the \
VIR_DOMAIN_XML_INACTIVE &lt;br&gt; flag when requesting the domain XML. Possibly you \
haven't included this &lt;br&gt; flag, and that's why you think that your change \
hasn't taken effect?&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;&lt;div dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div \
dir="auto"&gt;Ah, I forgot to outline where in the lifecycle the update is taking place. \
The domain isn't running when the code attempts to update the \
definition.&lt;/div&gt;&lt;div dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div dir="auto"&gt;Does that still mean that \
the VIR_DOMAIN_XML_INACTIVE flag is needed? I was assuming when the domain is \
inactive the XML changes would be reflected immediately.&lt;/div&gt;&lt;div \
dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div dir="auto"&gt;Oddly I thought during some experiments when the \
added NVRAM XML element was ignored, the updated number of CPUs which was in the same \
XML definition passed in was applied.&lt;/div&gt;&lt;div dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div \
dir="auto"&gt;Will dig further tomorrow or Monday on the version of ruby-libvirt \
installed into my rvm dev env as well as checking passing in the flag.&lt;/div&gt;&lt;div \
dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div dir="auto"&gt;I'm sure it'll turn out to be something \
obvious that I'm overlooking.&lt;/div&gt;&lt;div dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div \
dir="auto"&gt;Thanks,&lt;/div&gt;&lt;div dir="auto"&gt;--&lt;/div&gt;&lt;div dir="auto"&gt;Darragh&lt;/div&gt;&lt;div \
dir="auto"&gt;&lt;div class="gmail_quote"&gt;&lt;blockquote class="gmail_quote" style="margin:0 0 \
0 .8ex;border-left:1px #ccc solid;padding-left:1ex"&gt; &lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220515111907</emailId><senderName>Darragh Bailey</senderName><senderEmail>daragh.bailey@gmail.com</senderEmail><timestampReceived>2022-05-15 11:19:07-0400</timestampReceived><subject>Re: Updating domains definitions via API</subject><body>

Hi,

On Sat, 14 May 2022 at 23:42, Darragh Bailey &lt;daragh.bailey@gmail.com&gt;
wrote:

&gt; Hi,
&gt;
&gt; On Sat 14 May 2022, 21:11 Laine Stump, &lt;laine@redhat.com&gt; wrote:
&gt;
&gt;&gt; Caveat - I'm completely unfamiliar with ruby and the libvirt-ruby API
&gt;&gt; bindings.
&gt;&gt;
&gt;&gt; If there is a problem that causes the domain config to not be updated,
&gt;&gt; libvirt will return an error. So I would suspect one of the two things
&gt;&gt; is happening:
&gt;&gt;
&gt;
Looks like I've stumbled across an edge case here regarding domain config
not being fully updated but also not returning an error.


&gt; 1) there may be a problem in the libvirt-ruby bindings that causes the
&gt;&gt; error reported by the call (in whatever C code is behind the ruby
&gt;&gt; bindings) to libvirt to be properly propagated to ruby. I would hope
&gt;&gt; this isn't the case, but "bugs happen", so it should be considered as a
&gt;&gt; possibility.
&gt;&gt;
&gt;
I decided to test the behaviour slightly more directly via virsh rather
than through the ruby bindings and based on replicating the same there, and
a review of the ruby binding API code, I believe the binding code is
working fine, the problem is unexpected behaviour in libvirt.

It appears that if the XML passed in contains an nvram XML tag without a
corresponding loader tag, then the nvram tag will be dropped without an
error. In fact if you change any other information such as the vcpu
definition in the same update, that will still be applied while the nvram
tag is ignored.

Simply the reason the ruby code isn't raising an exception is that libvirt
thinks nothing went wrong and is returning a non null pointer.

Put together a gist to make it easier to show what I'm seeing
https://gist.github.com/electrofelix/6f66714c14a0d6e3b1078037aadae398

I'm assuming at this point that this is a bug, the domain XML in
test_with_nvram.xml should be rejected because it's not all applied.
--
Darragh

&gt;

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;&lt;div&gt;Hi,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div class="gmail_quote"&gt;&lt;div \
dir="ltr" class="gmail_attr"&gt;On Sat, 14 May 2022 at 23:42, Darragh Bailey &lt;&lt;a \
href="mailto:daragh.bailey@gmail.com"&gt;daragh.bailey@gmail.com&lt;/a&gt;&gt; \
wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0px 0px 0px \
0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"&gt;&lt;div \
dir="auto"&gt;&lt;div&gt;&lt;div&gt;Hi,&lt;/div&gt;&lt;div dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div class="gmail_quote"&gt;&lt;div \
dir="ltr" class="gmail_attr"&gt;On Sat 14 May 2022, 21:11 Laine Stump, &lt;&lt;a \
href="mailto:laine@redhat.com" target="_blank"&gt;laine@redhat.com&lt;/a&gt;&gt; \
wrote:&lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0px 0px 0px \
0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"&gt; Caveat - I'm \
completely unfamiliar with ruby and the libvirt-ruby API &lt;br&gt; bindings.&lt;br&gt;
&lt;br&gt;
If there is a problem that causes the domain config to not be updated, &lt;br&gt;
libvirt will return an error. So I would suspect one of the two things &lt;br&gt;
is happening:&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Looks \
like I've stumbled across an edge case here regarding domain config not being \
fully updated but also not returning an error.&lt;br&gt;&lt;/div&gt;&lt;div&gt;  &lt;/div&gt;&lt;blockquote \
class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left:1px solid \
rgb(204,204,204);padding-left:1ex"&gt;&lt;div dir="auto"&gt;&lt;div dir="auto"&gt;&lt;/div&gt;&lt;div \
dir="auto"&gt;&lt;div class="gmail_quote"&gt;&lt;blockquote class="gmail_quote" style="margin:0px \
0px 0px 0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"&gt;1) there may \
be a problem in the libvirt-ruby bindings that causes the &lt;br&gt; error reported by the \
call (in whatever C code is behind the ruby &lt;br&gt; bindings) to libvirt to be properly \
propagated to ruby. I would hope &lt;br&gt; this isn't the case, but "bugs \
happen", so it should be considered as a &lt;br&gt; \
possibility.&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I \
decided to test the behaviour slightly more directly via virsh rather than through \
the ruby bindings and based on replicating the same there, and a review of the ruby \
binding API code, I believe the binding code is working fine, the problem is \
unexpected behaviour in libvirt.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;It appears that \
if the XML passed in contains an nvram XML tag without a corresponding loader tag, \
then the nvram tag will be dropped without an error. In fact if you change any other \
information such as the vcpu definition in the same update, that will still be \
applied while the nvram tag is ignored.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Simply the \
reason the ruby code isn't raising an exception is that libvirt thinks nothing \
went wrong and is returning a non null pointer.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Put \
together a gist to make it easier to show what I'm seeing&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;a \
href="https://gist.github.com/electrofelix/6f66714c14a0d6e3b1078037aadae398"&gt;https://g \
ist.github.com/electrofelix/6f66714c14a0d6e3b1078037aadae398&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I'm \
assuming at this point that this is a bug, the domain XML in test_with_nvram.xml \
should be rejected because it's not all \
applied.&lt;br&gt;&lt;/div&gt;&lt;div&gt;--&lt;/div&gt;&lt;div&gt;Darragh&lt;br&gt;&lt;/div&gt;&lt;blockquote class="gmail_quote" \
style="margin:0px 0px 0px 0.8ex;border-left:1px solid \
rgb(204,204,204);padding-left:1ex"&gt; &lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220515144527</emailId><senderName>Laine Stump</senderName><senderEmail>laine@redhat.com</senderEmail><timestampReceived>2022-05-15 14:45:27-0400</timestampReceived><subject>Re: Updating domains definitions via API</subject><body>

On 5/14/22 6:42 PM, Darragh Bailey wrote:
&gt; Hi,
&gt; 
&gt; On Sat 14 May 2022, 21:11 Laine Stump, &lt;laine@redhat.com 
&gt; &lt;mailto:laine@redhat.com&gt;&gt; wrote:
&gt; 
&gt;     Caveat - I'm completely unfamiliar with ruby and the libvirt-ruby API
&gt;     bindings.
&gt; 
&gt;     If there is a problem that causes the domain config to not be updated,
&gt;     libvirt will return an error. So I would suspect one of the two things
&gt;     is happening:
&gt; 
&gt; 
&gt; Thanks, that's what I was expecting should happen, just wanted to be 
&gt; sure that there wasn't some other behaviour in place for compatibility 
&gt; reasons.
&gt; 
&gt;     1) there may be a problem in the libvirt-ruby bindings that causes the
&gt;     error reported by the call (in whatever C code is behind the ruby
&gt;     bindings) to libvirt to be properly propagated to ruby. I would hope
&gt;     this isn't the case, but "bugs happen", so it should be considered as a
&gt;     possibility.
&gt; 
&gt; 
&gt; A quick look suggests that the code looks to raise an exception if the 
&gt; dom pointer returned is NULL, so I think the bindings are correct. But I 
&gt; will check that what version of ruby-libvirt I have installed matches 
&gt; the source code I'm looked at.
&gt; 
&gt;     2) As I said in my earlier mail, any changes that are made will take
&gt;     effect the next time the domain is destroyed and restarted. This also
&gt;     means that the changes won't be reflected in the "live/status" XML of
&gt;     the domain until that time. If you want to see the new configuration
&gt;     after you've made changes, you should add the VIR_DOMAIN_XML_INACTIVE
&gt;     flag when requesting the domain XML. Possibly you haven't included this
&gt;     flag, and that's why you think that your change hasn't taken effect?
&gt; 
&gt; 
&gt; Ah, I forgot to outline where in the lifecycle the update is taking 
&gt; place. The domain isn't running when the code attempts to update the 
&gt; definition.
&gt; 
&gt; Does that still mean that the VIR_DOMAIN_XML_INACTIVE flag is needed? I 
&gt; was assuming when the domain is inactive the XML changes would be 
&gt; reflected immediately.

No, your thinking was correct - if the domain isn't active, then the 
change should take effect immediately, and there is no difference 
whether or not you have VIR_DOMAIN_XML_INACTIVE.

I've never done anything directly with the nvram setting (just accepted 
whatever virt-manager put in there), but from your other message, it 
sounds like you've found a bonafide libvirt bug (either that, or I just 
don't know enough about how the nvram settings work :-)). Can you file 
an issue at https://gitlab.com/groups/libvirt/-/issues ?

&gt; 
&gt; Oddly I thought during some experiments when the added NVRAM XML element 
&gt; was ignored, the updated number of CPUs which was in the same XML 
&gt; definition passed in was applied.

Another indication that it's a bug - updates to the domain config are 
always an all-or-nothing thing.

&gt; Will dig further tomorrow or Monday on the version of ruby-libvirt 
&gt; installed into my rvm dev env as well as checking passing in the flag.
&gt; 
&gt; I'm sure it'll turn out to be something obvious that I'm overlooking.
&gt; 
&gt; Thanks,
&gt; --
&gt; Darragh
&gt; 

</body></email><email><emailId>20220516091032</emailId><senderName>Michal Prívozník</senderName><senderEmail>mprivozn@redhat.com</senderEmail><timestampReceived>2022-05-16 09:10:32-0400</timestampReceived><subject>Re: Updating domains definitions via API</subject><body>

On 5/14/22 21:23, Darragh Bailey wrote:
&gt; 
&gt; On Fri, 13 May 2022 at 00:17, Darragh Bailey &lt;daragh.bailey@gmail.com
&gt; &lt;mailto:daragh.bailey@gmail.com&gt;&gt; wrote:
&gt; 
&gt;     Hi,
&gt; 
&gt;     On Thu 12 May 2022, 21:34 Laine Stump, &lt;laine@redhat.com
&gt;     &lt;mailto:laine@redhat.com&gt;&gt; wrote:
&gt; 
&gt;         The virDomainDefineXMLFlags API (and also the older/deprecated
&gt;         virDomainDefineXML API) doesn't require that the domain first be
&gt;         undefined (with one notable exception - see below[*]). If you
&gt;         define a
&gt;         domain that already exists with the same name and uuid, then the
&gt;         effect
&gt;         is to "redefine" (or "update" if you prefer) the existing domain
&gt;         of that
&gt;         name. If the domain is currently active, then the changes will take
&gt;         effect the next time the domain is shut down ("Destroy"ed in
&gt;         libvirt API
&gt;         parlance) and re-started.
&gt; 
&gt; 
&gt; Unfortunately trying to call this via ruby-libvirt doesn't appear to
&gt; behave as expected. It appears that if I add an nvram element without a
&gt; loader element to the os block, the following code block will execute
&gt; without issue but also without changing the domain XML:

I think that's kind of expected. If you take a look how libvirt parses
that part of XML:

https://gitlab.com/libvirt/libvirt/-/blob/master/src/conf/domain_conf.c#L18257

if no &lt;loader/&gt; is found then the function exits early without looking
at &lt;nvram/&gt; at all. It kind of makes sense - what good does nvram do
without loader?

Michal

</body></email><email><emailId>20220516104632</emailId><senderName>Darragh Bailey</senderName><senderEmail>daragh.bailey@gmail.com</senderEmail><timestampReceived>2022-05-16 10:46:32-0400</timestampReceived><subject>Re: Updating domains definitions via API</subject><body>

On Mon 16 May 2022, 10:10 Michal Pr=C3=ADvozn=C3=ADk, &lt;mprivozn@redhat.com&gt;=
 wrote:

&gt; On 5/14/22 21:23, Darragh Bailey wrote:
&gt; &gt;
&gt; &gt; On Fri, 13 May 2022 at 00:17, Darragh Bailey &lt;daragh.bailey@gmail.com
&gt; &gt; &lt;mailto:daragh.bailey@gmail.com&gt;&gt; wrote:
&gt; &gt;
&gt; &gt; Unfortunately trying to call this via ruby-libvirt doesn't appear to
&gt; &gt; behave as expected. It appears that if I add an nvram element without a
&gt; &gt; loader element to the os block, the following code block will execute
&gt; &gt; without issue but also without changing the domain XML:
&gt;
&gt; I think that's kind of expected. If you take a look how libvirt parses
&gt; that part of XML:
&gt;
&gt;
&gt; https://gitlab.com/libvirt/libvirt/-/blob/master/src/conf/domain_conf.c#L=
18257
&gt;
&gt; if no &lt;loader/&gt; is found then the function exits early without looking
&gt; at &lt;nvram/&gt; at all. It kind of makes sense - what good does nvram do
&gt; without loader?


I don't know, I realised that there was a bug in our vagrant-libvirt in
that it should be checking for both loader and NVRAM config settings to be
passed in if the end user was updating the machine config. And subsequently
set both elements or neither.

However I was not expecting the silent discarding of the XML element and
instead to get an error saying that an nvram XML element without a loader
XML element is invalid and for the entire request to be rejected. Basically
that the provided XML domain definition was invalid.

Based on the previous explanation of how the define_domain_xml should work
along with the response on the example reproducer this seems like a bug.

Does your reply mean this is expected behaviour? Or were you looking for
clarification on what I expected to see?
--
Darragh Bailey

[Attachment #3 (text/html)]

&lt;div dir="auto"&gt;&lt;div&gt;&lt;div data-smartmail="gmail_signature"&gt;&lt;br&gt;&lt;/div&gt;&lt;div \
class="gmail_quote"&gt;&lt;div dir="ltr" class="gmail_attr"&gt;On Mon 16 May 2022, 10:10 \
Michal Prívozník, &lt;&lt;a \
href="mailto:mprivozn@redhat.com"&gt;mprivozn@redhat.com&lt;/a&gt;&gt; \
wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0 0 0 \
.8ex;border-left:1px #ccc solid;padding-left:1ex"&gt;On 5/14/22 21:23, Darragh Bailey \
wrote:&lt;br&gt; &gt; &lt;br&gt;
&gt; On Fri, 13 May 2022 at 00:17, Darragh Bailey &lt;&lt;a \
href="mailto:daragh.bailey@gmail.com" target="_blank" \
rel="noreferrer"&gt;daragh.bailey@gmail.com&lt;/a&gt;&lt;br&gt; &gt; &lt;mailto:&lt;a \
href="mailto:daragh.bailey@gmail.com" target="_blank" \
rel="noreferrer"&gt;daragh.bailey@gmail.com&lt;/a&gt;&gt;&gt; wrote:&lt;br&gt; &gt;&lt;br&gt;
&gt; Unfortunately trying to call this via ruby-libvirt doesn't appear to&lt;br&gt;
&gt; behave as expected. It appears that if I add an nvram element without a&lt;br&gt;
&gt; loader element to the os block, the following code block will execute&lt;br&gt;
&gt; without issue but also without changing the domain XML:&lt;br&gt;
&lt;br&gt;
I think that's kind of expected. If you take a look how libvirt parses&lt;br&gt;
that part of XML:&lt;br&gt;
&lt;br&gt;
&lt;a href="https://gitlab.com/libvirt/libvirt/-/blob/master/src/conf/domain_conf.c#L18257" \
rel="noreferrer noreferrer" \
target="_blank"&gt;https://gitlab.com/libvirt/libvirt/-/blob/master/src/conf/domain_conf.c#L18257&lt;/a&gt;&lt;br&gt;
 &lt;br&gt;
if no &lt;loader/&gt; is found then the function exits early without looking&lt;br&gt;
at &lt;nvram/&gt; at all. It kind of makes sense - what good does nvram do&lt;br&gt;
without loader?&lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;&lt;div dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div dir="auto"&gt;I \
don't know, I realised that there was a bug in our vagrant-libvirt in that it \
should be checking for both loader and NVRAM config settings to be passed in if the \
end user was updating the machine config. And subsequently set both elements or \
neither.  &lt;/div&gt;&lt;div dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div dir="auto"&gt;However I was not expecting \
the silent discarding of the XML element and instead to get an error saying that an \
nvram XML element without a loader XML element is invalid and for the entire request \
to be rejected. Basically that the provided XML domain definition was \
invalid.&lt;/div&gt;&lt;div dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div dir="auto"&gt;Based on the previous \
explanation of how the define_domain_xml should work along with the response on the \
example reproducer this seems like a bug.&lt;/div&gt;&lt;div dir="auto"&gt;&lt;br&gt;&lt;/div&gt;&lt;div \
dir="auto"&gt;Does your reply mean this is expected behaviour? Or were you looking for \
clarification on what I expected to see?&lt;/div&gt;&lt;div dir="auto"&gt;--&lt;/div&gt;&lt;div \
dir="auto"&gt;Darragh Bailey&lt;/div&gt;&lt;div dir="auto"&gt;&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220516113052</emailId><senderName>Michal Prívozník</senderName><senderEmail>mprivozn@redhat.com</senderEmail><timestampReceived>2022-05-16 11:30:52-0400</timestampReceived><subject>Re: Updating domains definitions via API</subject><body>

On 5/16/22 12:46, Darragh Bailey wrote:
&gt; 
&gt; On Mon 16 May 2022, 10:10 Michal Prívozník, &lt;mprivozn@redhat.com
&gt; &lt;mailto:mprivozn@redhat.com&gt;&gt; wrote:
&gt; 
&gt;     On 5/14/22 21:23, Darragh Bailey wrote:
&gt;     &gt;
&gt;     &gt; On Fri, 13 May 2022 at 00:17, Darragh Bailey
&gt;     &lt;daragh.bailey@gmail.com &lt;mailto:daragh.bailey@gmail.com&gt;
&gt;     &gt; &lt;mailto:daragh.bailey@gmail.com &lt;mailto:daragh.bailey@gmail.com&gt;&gt;&gt;
&gt;     wrote:
&gt;     &gt;
&gt;     &gt; Unfortunately trying to call this via ruby-libvirt doesn't appear to
&gt;     &gt; behave as expected. It appears that if I add an nvram element
&gt;     without a
&gt;     &gt; loader element to the os block, the following code block will execute
&gt;     &gt; without issue but also without changing the domain XML:
&gt; 
&gt;     I think that's kind of expected. If you take a look how libvirt parses
&gt;     that part of XML:
&gt; 
&gt;     https://gitlab.com/libvirt/libvirt/-/blob/master/src/conf/domain_conf.c#L18257
&gt;     &lt;https://gitlab.com/libvirt/libvirt/-/blob/master/src/conf/domain_conf.c#L18257&gt;
&gt; 
&gt;     if no &lt;loader/&gt; is found then the function exits early without looking
&gt;     at &lt;nvram/&gt; at all. It kind of makes sense - what good does nvram do
&gt;     without loader?
&gt; 
&gt; 
&gt; I don't know, I realised that there was a bug in our vagrant-libvirt in
&gt; that it should be checking for both loader and NVRAM config settings to
&gt; be passed in if the end user was updating the machine config. And
&gt; subsequently set both elements or neither.  
&gt; 
&gt; However I was not expecting the silent discarding of the XML element and
&gt; instead to get an error saying that an nvram XML element without a
&gt; loader XML element is invalid and for the entire request to be rejected.
&gt; Basically that the provided XML domain definition was invalid.
&gt; 
&gt; Based on the previous explanation of how the define_domain_xml should
&gt; work along with the response on the example reproducer this seems like a
&gt; bug.
&gt; 
&gt; Does your reply mean this is expected behaviour? Or were you looking for
&gt; clarification on what I expected to see?

I mean, fixing this particular problem is trivial. But what's not as
trivial is fixing ALL occurrences of this problem (where an
attribute/element is ignored because of something we've parsed earlier).
Mostly because we don't know what those are.

BTW: Have you spotted the other demonstration of this problem (in the
same function)? Yes, if fw autoselection is enabled (&lt;os
firmware='something'&gt;) then &lt;nvram template=''/&gt; is ignored.

Anyway, there used to be an unwritten agreement with users that they get
XML of a domain they just defined to see if it contains everything they
want. This is used to be because different drivers support different
features. But I guess it's hard to argue with an unwritten rule esp. if
it's not known to everybody.

Michal

</body></email><email><emailId>20220516125229</emailId><senderName>Darragh Bailey</senderName><senderEmail>daragh.bailey@gmail.com</senderEmail><timestampReceived>2022-05-16 12:52:29-0400</timestampReceived><subject>Re: Updating domains definitions via API</subject><body>

On Mon, 16 May 2022 at 12:30, Michal Prívozník &lt;mprivozn@redhat.com&gt; wrote:

&gt; I mean, fixing this particular problem is trivial. But what's not as
&gt; trivial is fixing ALL occurrences of this problem (where an
&gt; attribute/element is ignored because of something we've parsed earlier).
&gt; Mostly because we don't know what those are.
&gt;

tbf, this is the clarification I needed. I was previously operating under
the
assumption that given the description define_domain_xml was checking
if the resulting XML for the domain matched what was passed in.


&gt; BTW: Have you spotted the other demonstration of this problem (in the
&gt; same function)? Yes, if fw autoselection is enabled (&lt;os
&gt; firmware='something'&gt;) then &lt;nvram template=''/&gt; is ignored.
&gt;

No, I think it was probably a bit of a fluck that I hit the issue as I was
looking
at trying to avoid the special handling around nvram with the current code
undefining a domain before creating the new definition. Could easily have
missed it altogether.


&gt; Anyway, there used to be an unwritten agreement with users that they get
&gt; XML of a domain they just defined to see if it contains everything they
&gt; want. This is used to be because different drivers support different
&gt; features. But I guess it's hard to argue with an unwritten rule esp. if
&gt; it's not known to everybody.
&gt;
&gt; Michal
&gt;

I had started to lean towards checking the XML for the domain returned as
a final validation step.Perhaps the API docs for
https://libvirt.org/html/libvirt-libvirt-domain.html#virDomainDefineXML and
https://libvirt.org/html/libvirt-libvirt-domain.html#virDomainDefineXMLFlags
could mention that it doesnot guarantee that the entire XML document has
been applied to the domain?

So perhaps this is less a bug with the loader/nvram XML element handling
and more a documentation bug and a possible enhancement that possibly
the virDomainDefineXMLFlags could consider accepting a flag to verify the
returned domain XML is equivalent as a general fix for those applications
that would find this useful?
--
Darragh Bailey
"Nothing is foolproof to a sufficiently talented fool"

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;&lt;div dir="ltr"&gt;&lt;/div&gt;&lt;br&gt;&lt;div class="gmail_quote"&gt;&lt;div dir="ltr" \
class="gmail_attr"&gt;On Mon, 16 May 2022 at 12:30, Michal Prívozník &lt;&lt;a \
href="mailto:mprivozn@redhat.com"&gt;mprivozn@redhat.com&lt;/a&gt;&gt; \
wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0px 0px 0px \
0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"&gt; I mean, fixing this \
particular problem is trivial. But what's not as&lt;br&gt; trivial is fixing ALL \
occurrences of this problem (where an&lt;br&gt; attribute/element is ignored because of \
something we've parsed earlier).&lt;br&gt; Mostly because we don't know what those \
are.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;tbf, this is the clarification I needed. I \
was previously operating under the&lt;/div&gt;&lt;div&gt;assumption that given the description \
define_domain_xml was checking&lt;/div&gt;&lt;div&gt;if the resulting XML for the domain matched \
what was passed in.&lt;/div&gt;&lt;div&gt;  &lt;/div&gt;&lt;blockquote class="gmail_quote" \
style="margin:0px 0px 0px 0.8ex;border-left:1px solid \
rgb(204,204,204);padding-left:1ex"&gt;

BTW: Have you spotted the other demonstration of this problem (in the&lt;br&gt;
same function)? Yes, if fw autoselection is enabled (&lt;os&lt;br&gt;
firmware='something'&gt;) then &lt;nvram template=''/&gt; is \
ignored.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;No, I think it was probably a bit of a \
fluck that I hit the issue as I was looking&lt;/div&gt;&lt;div&gt;at trying to avoid the special \
handling around nvram with the current code&lt;/div&gt;&lt;div&gt;undefining a domain before \
creating the new definition. Could easily have&lt;/div&gt;&lt;div&gt;missed it \
altogether.&lt;br&gt;&lt;/div&gt;&lt;div&gt;  &lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0px \
0px 0px 0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"&gt;

Anyway, there used to be an unwritten agreement with users that they get&lt;br&gt;
XML of a domain they just defined to see if it contains everything they&lt;br&gt;
want. This is used to be because different drivers support different&lt;br&gt;
features. But I guess it's hard to argue with an unwritten rule esp. if&lt;br&gt;
it's not known to everybody.&lt;br&gt;
&lt;br&gt;
Michal&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I had started to lean towards checking the \
XML for the domain returned as&lt;/div&gt;&lt;div&gt;a final validation step.Perhaps the API docs \
for&lt;/div&gt;&lt;div&gt;&lt;a href="https://libvirt.org/html/libvirt-libvirt-domain.html#virDomainD \
efineXML"&gt;https://libvirt.org/html/libvirt-libvirt-domain.html#virDomainDefineXML&lt;/a&gt; \
and&lt;/div&gt;&lt;div&gt;&lt;a href="https://libvirt.org/html/libvirt-libvirt-domain.html#virDomainD \
efineXMLFlags"&gt;https://libvirt.org/html/libvirt-libvirt-domain.html#virDomainDefineXMLFlags&lt;/a&gt;&lt;/div&gt;&lt;div&gt;could \
mention that it doesnot guarantee that the entire XML document has&lt;/div&gt;&lt;div&gt;been \
applied to the domain?&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So perhaps this is less a bug \
with the loader/nvram XML element handling&lt;/div&gt;&lt;div&gt;and more a documentation bug and \
a possible enhancement that possibly&lt;/div&gt;&lt;div&gt;the virDomainDefineXMLFlags could \
consider accepting a flag to verify the&lt;/div&gt;&lt;div&gt;returned domain XML is equivalent \
as a general fix for those applications&lt;/div&gt;&lt;div&gt;that would find this \
useful?&lt;/div&gt;&lt;div&gt;--&lt;br clear="all"&gt;&lt;div&gt;&lt;div dir="ltr" \
class="gmail_signature"&gt;Darragh Bailey&lt;br&gt;"Nothing is foolproof to a \
sufficiently talented fool"&lt;/div&gt;&lt;/div&gt;  &lt;/div&gt;&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220516133157</emailId><senderName>Michal Prívozník</senderName><senderEmail>mprivozn@redhat.com</senderEmail><timestampReceived>2022-05-16 13:31:57-0400</timestampReceived><subject>Re: Updating domains definitions via API</subject><body>

On 5/16/22 14:52, Darragh Bailey wrote:

&gt; So perhaps this is less a bug with the loader/nvram XML element handling
&gt; and more a documentation bug and a possible enhancement that possibly
&gt; the virDomainDefineXMLFlags could consider accepting a flag to verify the
&gt; returned domain XML is equivalent as a general fix for those applications
&gt; that would find this useful?

Yes to the first part, but no the second. Comparing XMLs is not as easy
as you would think. For instance:

&lt;domain id='1' type='kvm'&gt;
  &lt;uuid&gt;123456&lt;/uuid&gt;
  &lt;name&gt;myGuest&lt;/name&gt;
&lt;/domain&gt;

&lt;domain type='kvm' id='1'&gt;
  &lt;name&gt;myGuest&lt;/uuid&gt;
  &lt;uuid&gt;123456&lt;/uuid&gt;
&lt;/domain&gt;

The former is just an example of possible user input, the latter is how
libvirt would format it. Obviously, these XMLs are equivalent, but not
stcmp() equal.

Michal

</body></email><email><emailId>20220404120831</emailId><senderName>Michal PrÃ­voznÃ­k</senderName><senderEmail>mprivozn@redhat.com</senderEmail><timestampReceived>2022-04-04 12:08:31-0400</timestampReceived><subject>Re: Debugging hanging libvirt</subject><body>

On 4/1/22 21:55, Tobias Hofmann (tohofman) wrote:
&gt; Hi Daniel,
&gt; 
&gt;  
&gt; 
&gt; Thank you to Peter and you for the analysis – that was very helpful.
&gt; 
&gt; Indeed, it can happen that we restart the firewall during this scenario
&gt; on our system so I think I can debug from here.
&gt; 
&gt;  
&gt; 
&gt; By the way, you mentioned that there is a libvirt version where QEMU
&gt; process gets its own dedicated event loop. Would you mind sharing this
&gt; libvirt version with me?

It's since libvirt-6.2.0 but IIUC you're running on unsupported CentOS 7
which doesn't have that release available.

Michal

</body></email><email><emailId>20220404130820</emailId><senderName>jonetsu</senderName><senderEmail>jonetsu@teksavvy.com</senderEmail><timestampReceived>2022-04-04 13:08:20-0400</timestampReceived><subject>Re: Guest restarting after issuing a shutdown</subject><body>

On Fri, 1 Apr 2022 13:42:00 -0400
Andrea Bolognani &lt;abologna@redhat.com&gt; wrote:

&gt; Try passing --no-reboot to virt-install.

Thanks, this works very well.

... And it reminded me to look at the manual ! :)

Cheers.

</body></email><email><emailId>20220405160538</emailId><senderName>Ian Pilcher</senderName><senderEmail>arequipeno@gmail.com</senderEmail><timestampReceived>2022-04-05 16:05:38-0400</timestampReceived><subject>Re: Network interface element not working</subject><body>

On 4/5/22 10:12, Laine Stump wrote:
&gt; Umm.... That's how it was intended to *not* work :-P. The whole point of 
&gt; the self-managed libvirt virtual networks is to setup a separate subnet 
&gt; that has all traffic routed via IP to the physical network. I'm 
&gt; impressed you've found a hack that works for you[*], but just be 
&gt; prepared to "pick up the pieces" if it breaks :-)

This is a lab setup.  It only has to work for a few days.

&gt; (I hope you've removed the DHCP service, DNS service, and for that 
&gt; matter even the IP address from the libvirt network definition. Also, is 
&gt; the host ethernet being used (i.e. does it have an IP address) prior to 
&gt; attaching it to the bridge? Normally when an ethernet is attached to a 
&gt; bridge, its IP configuration is moved to the bridge device, and the 
&gt; ethernet has no IP. I'm not sure what kind of connectivity oddities 
&gt; would show up if you left the IP address on the ethernet itself)

Actually, the physical interface is connected to a VLAN that I'm using
extend the existing virtual environment to some physical machines, so I
want to leave the virtual network otherwise unchanged, but have the
ability to add physical machines to the virtual network (if that makes
sense).

-- 
========================================================================
Google                                      Where SkyNet meets Idiocracy
========================================================================

</body></email><email><emailId>20220408203551</emailId><senderName>Nir Soffer</senderName><senderEmail>nsoffer@redhat.com</senderEmail><timestampReceived>2022-04-08 20:35:51-0400</timestampReceived><subject>Re: "default" watchdog device - ?</subject><body>

On Tue, Apr 5, 2022 at 7:27 PM lejeczek &lt;peljasz@yahoo.co.uk&gt; wrote:
&gt;
&gt;
&gt;
&gt; On 29/03/2022 20:25, Nir Soffer wrote:
&gt; &gt; On Wed, Mar 16, 2022 at 1:55 PM lejeczek &lt;peljasz@yahoo.co.uk&gt; wrote:
&gt; &gt;&gt;
&gt; &gt;&gt;
&gt; &gt;&gt; On 15/03/2022 11:21, Daniel P. Berrangé wrote:
&gt; &gt;&gt;&gt; On Tue, Mar 15, 2022 at 10:39:50AM +0000, lejeczek wrote:
&gt; &gt;&gt;&gt;&gt; Hi guys.
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; Without explicitly, manually using watchdog device for a VM, the VM (centOS
&gt; &gt;&gt;&gt;&gt; 8 Stream 4.18.0-365.el8.x86_64) shows '/dev/watchdog' exists.
&gt; &gt;&gt;&gt;&gt; To double check - 'dumpxml' does not show any such device - what kind of a
&gt; &gt;&gt;&gt;&gt; 'watchdog' that is?
&gt; &gt;&gt;&gt; The kernel can always provide a pure software watchdog IIRC. It can be
&gt; &gt;&gt;&gt; useful if a userspace app wants a watchdog. The limitation is that it
&gt; &gt;&gt;&gt; relies on the kernel remaining functional, as there's no hardware
&gt; &gt;&gt;&gt; backing it up.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Regards,
&gt; &gt;&gt;&gt; Daniel
&gt; &gt;&gt; On a related note - with 'i6300esb' watchdog which I tested
&gt; &gt;&gt; and I believe is working.
&gt; &gt;&gt; I get often in my VMs from 'dmesg':
&gt; &gt;&gt; ...
&gt; &gt;&gt; watchdog: BUG: soft lockup - CPU#0 stuck for xxxs! [swapper/0:0]
&gt; &gt;&gt; rcu: INFO: rcu_sched self-detected stall on CPU
&gt; &gt;&gt; ...
&gt; &gt;&gt; This above is from Ubuntu and CentOS alike and when this
&gt; &gt;&gt; happens, console via VNC responds to until first 'enter'
&gt; &gt;&gt; then is non-resposive.
&gt; &gt;&gt; This happens after VM(s) was migrated between hosts, but
&gt; &gt;&gt; anyway..
&gt; &gt;&gt; I do not see what I expected from 'watchdog' - there is no
&gt; &gt;&gt; action whatsoever, which should be 'reset'. VM remains in
&gt; &gt;&gt; such 'frozen' state forever.
&gt; &gt;&gt;
&gt; &gt;&gt; any &amp; all shared thoughts much appreciated.
&gt; &gt;&gt; L.
&gt; &gt; You need to run some userspace tool that will open the watchdog
&gt; &gt; device, and pet it periodically, telling the kernel that userspace is alive.
&gt; &gt;
&gt; &gt; If this tool will stop petting the watchdog, maybe because of a soft lockup
&gt; &gt; or other trouble, the watchdog device will reset the VM.
&gt; &gt;
&gt; &gt; watchdog(8) may be the tool you need.
&gt; &gt;
&gt; &gt; See also
&gt; &gt; https://www.kernel.org/doc/Documentation/watchdog/watchdog-api.rst
&gt; &gt;
&gt; &gt; Nir
&gt; &gt;
&gt; I do not think that 'i6300esb' watchog works under those
&gt; soft-lockups, whether it's qemu or OS end I cannot say.
&gt; With:
&gt;      &lt;watchdog model='i6300esb' action='reset'/&gt;
&gt; in dom xml OS sees:
&gt; -&gt; $ llr /dev/watchdog*
&gt; crw-------. 1 root root  10, 130 Apr  5 16:59 /dev/watchdog
&gt; crw-------. 1 root root 248,   0 Apr  5 16:59 /dev/watchdog0
&gt; crw-------. 1 root root 248,   1 Apr  5 16:59 /dev/watchdog1
&gt; and
&gt; -&gt; $ wdctl
&gt; Device:        /dev/watchdog
&gt; Identity:      i6300ESB timer [version 0]
&gt; Timeout:       30 seconds
&gt; Pre-timeout:    0 seconds
&gt; FLAG           DESCRIPTION               STATUS BOOT-STATUS
&gt; KEEPALIVEPING  Keep alive ping reply          1           0
&gt; MAGICCLOSE     Supports magic close char      0           0
&gt; SETTIMEOUT     Set timeout (in seconds)       0           0
&gt;
&gt; If it worked, the HW watchdog, then 'i6300esb' should reset
&gt; the VM if nothing is pinging the watchdog - I read that it's
&gt; possible to exit 'software' watchdog and not to cause HW
&gt; watchdog take action. I do not know it that's happening here
&gt; when I just 'systemclt stop watchdog'
&gt; In '/etc/watchdog.conf' I do not point to any specific
&gt; device, which I believe makes watchdogd do its things.
&gt; Simple test:
&gt; -&gt; $ cat &gt;&gt; /dev/watchdog
&gt; &amp; 'Enter' press twice
&gt; does invoke 'reset' action and I was to believe 'wdctl' that
&gt; is HW watchdog working. But!...
&gt; The main issue I have are those "soft lockups" where VM's OS
&gt; becomes frozen, but nothing from the watchdog, no action -
&gt; though, as VM is in such frozen state host shows high CPU
&gt; for the VM.
&gt;
&gt; I do not anything fancy so I really wonder if what I see is
&gt; that rare.
&gt; Soft-lockup occur I think usually, cannot say that uniquely
&gt; though, during or after VM live-migration.
&gt;
&gt; thanks, L.

On my fedora 35 vm, I see that /dev/watchdog0 is the right device:

# wdctl
Device:        /dev/watchdog0
Identity:      i6300ESB timer [version 0]
Timeout:       30 seconds
Pre-timeout:    0 seconds
FLAG           DESCRIPTION               STATUS BOOT-STATUS
KEEPALIVEPING  Keep alive ping reply          1           0
MAGICCLOSE     Supports magic close char      0           0
SETTIMEOUT     Set timeout (in seconds)       0           0

I tested this script:

# cat watchdog-test.py
import os
import time

fd = os.open("/dev/watchdog0", os.O_WRONLY)

print("Opened /dev/watchdog0") cat /etc/watchdog.conf | grep watchdog-device
watchdog-device = /dev/watchdog0


for i in range(1, 120):
    time.sleep(1)
    print(i)

# python3 watchdog-test.py
Opened /dev/watchdog0
1
2
3
...
30

The VM was reset after 30 seconds, showing that the hardware watchdog works.

I also tested the watchdog package, with this configuration:

# cat /etc/watchdog.conf
...
watchdog-device = /dev/watchdog0

Then starting the service:

# systemctl status watchdog
● watchdog.service - watchdog daemon
     Loaded: loaded (/usr/lib/systemd/system/watchdog.service;
enabled; vendor preset: disabled)
     Active: active (running) since Fri 2022-04-08 23:23:54 IDT; 7min ago
    Process: 757 ExecStart=/usr/sbin/watchdog (code=exited, status=0/SUCCESS)
   Main PID: 759 (watchdog)
      Tasks: 1 (limit: 2310)
     Memory: 616.0K
        CPU: 101ms
     CGroup: /system.slice/watchdog.service
             └─759 /usr/sbin/watchdog

Apr 08 23:23:54 fedora35 watchdog[759]:  interface: no interface to check
Apr 08 23:23:54 fedora35 watchdog[759]:  temperature: no sensors to check
Apr 08 23:23:54 fedora35 watchdog[759]:  no test binary files
Apr 08 23:23:54 fedora35 watchdog[759]:  no repair binary files
Apr 08 23:23:54 fedora35 watchdog[759]:  error retry time-out = 60 seconds
Apr 08 23:23:54 fedora35 watchdog[759]:  repair attempts = 1
Apr 08 23:23:54 fedora35 watchdog[759]:  alive=/dev/watchdog0
heartbeat=[none] to=root no_act=no force=no
Apr 08 23:23:54 fedora35 watchdog[759]: watchdog now set to 60 seconds
Apr 08 23:23:54 fedora35 watchdog[759]: hardware watchdog identity:
i6300ESB timer
Apr 08 23:23:54 fedora35 systemd[1]: Started watchdog daemon.


Finally, stopping the watchdog daemon:

# kill -STOP 759

And the VM was reset in about 60 seconds.

So I think it can work for your use case.

You can try  to find a way to trigger a soft lockup, or maybe crash the kernel
to test this.

Nir

</body></email><email><emailId>20220411185106</emailId><senderName>John McInnes</senderName><senderEmail>jmcinnes@svt.org</senderEmail><timestampReceived>2022-04-11 18:51:06-0400</timestampReceived><subject>WinServer2016 guest no mouse in VirtManager</subject><body>

[Attachment #2 (text/plain)]

Hi! I recently converted several Windows Server VMs from HyperV to libvirt/KVM. The \
host is running openSUSE Leap 15.3. I used virt-v2v and I installed virtio drivers on \
all of them and it all went well - except for one VM. The mouse does not work for \
this VM in VirtualMachineManager. There is no cursor and no response. There are no \
issues showing in Windows Device Manager. The mouse shows up as a PS/2 mouse. \
Interestingly if I RDP into this VM using Microsoft Remote Desktop the mouse works \
fine. Any ideas?

----
John McInnes
jmcinnes /\T svt.org


[Attachment #3 (text/html)]

&lt;html xmlns:o="urn:schemas-microsoft-com:office:office" \
xmlns:w="urn:schemas-microsoft-com:office:word" \
xmlns:m="http://schemas.microsoft.com/office/2004/12/omml" \
xmlns="http://www.w3.org/TR/REC-html40"&gt; &lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"&gt;
&lt;meta name="Generator" content="Microsoft Word 15 (filtered medium)"&gt;
&lt;style&gt;&lt;!--
/* Font Definitions */
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
/* Style Definitions */
p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin:0in;
	font-size:12.0pt;
	font-family:"Calibri",sans-serif;}
span.EmailStyle17
	{mso-style-type:personal-compose;
	font-family:"Calibri",sans-serif;
	color:windowtext;}
.MsoChpDefault
	{mso-style-type:export-only;
	font-size:12.0pt;
	font-family:"Calibri",sans-serif;}
@page WordSection1
	{size:8.5in 11.0in;
	margin:1.0in 1.0in 1.0in 1.0in;}
div.WordSection1
	{page:WordSection1;}
--&gt;&lt;/style&gt;
&lt;/head&gt;
&lt;body lang="EN-US" link="#0563C1" vlink="#954F72" style="word-wrap:break-word"&gt;
&lt;div class="WordSection1"&gt;
&lt;p class="MsoNormal"&gt;&lt;span style="font-size:11.0pt"&gt;Hi! I recently converted several \
Windows Server VMs from HyperV to libvirt/KVM. The host is running openSUSE Leap \
15.3. I used virt-v2v and I installed virtio drivers on all of them and it all went \
well -  except for one VM. The mouse does not work for this VM in \
VirtualMachineManager. There is no cursor and no response. There are no issues \
showing in Windows Device Manager. The mouse shows up as a PS/2 mouse. Interestingly \
if I RDP into this VM using Microsoft  Remote Desktop the mouse works fine. Any \
ideas?&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;span \
style="font-size:11.0pt"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;div&gt;
&lt;div&gt;
&lt;p class="MsoNormal"&gt;&lt;span style="font-size:11.0pt"&gt;----&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;&lt;span style="font-size:11.0pt"&gt;John \
McInnes&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;/div&gt;
&lt;/div&gt;
&lt;p class="MsoNormal"&gt;&lt;span style="font-size:11.0pt"&gt;jmcinnes /\T \
svt.org&lt;/span&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;



</body></email><email><emailId>20220413102959</emailId><senderName>Martin Kletzander</senderName><senderEmail>mkletzan@redhat.com</senderEmail><timestampReceived>2022-04-13 10:29:59-0400</timestampReceived><subject>Re: Libvirt Daemon Question</subject><body>


On Fri, Apr 01, 2022 at 05:56:06PM -0400, Michael Espinoza wrote:
&gt;Hi
&gt;
&gt;I've been googling this for a bit with no luck.  Is there a way of
&gt;determining what mode an already running libvirt daemon is running
&gt;in.(session or system)  From the docs it sounded like it was determined by
&gt;what user started the daemon. But in a test node I set up, I have libvirtd

libvirtd running as root is a system daemon, for all other users it is a
session daemon

&gt;running as root yet I can still connect to both the session and system
&gt;qemus with virsh.

That's because the session daemon does not need to be started to connect
to it, virsh will start it when you want to connect and then it will end
itself after a certain timeout with no operation.

&gt;And if I were to want libvirtd only in session mode, how would I do
&gt;that?
&gt;

Do not start the system daemon and also disable socket activation for
all the daemons you do not want to be used (if you are using systemd for
example).

&gt;Thanks for the help!  This stuff is really awesome and I'm just trying to
&gt;get a full understanding of it.
&gt;

Glad we could help, enjoy the day ;)

&gt;-Mike
&gt;-- 
&gt;Michael Espinoza
&gt;Mobile Phone : 646 327 9273
&gt;Email : Mikespinoza@gmail.com

["signature.asc" (application/pgp-signature)]

</body></email><email><emailId>20220419102531</emailId><senderName>Daniel =?utf-8?B?UC4gQmVycmFuZ8Op?=</senderName><senderEmail>berrange@redhat.com</senderEmail><timestampReceived>2022-04-19 10:25:31-0400</timestampReceived><subject>Re: Libvirt vs QEMU benefits</subject><body>

On Wed, Apr 06, 2022 at 12:44:37PM +0000, M, Shivakumar wrote:
&gt; Hello,
&gt; 
&gt; For one of our case validation, we were using direct QEMU commands before for VM \
&gt; creation as it was easier to configure the VMs. Inside VM we do run the real-time \
&gt; latency test. Recently we switched to libvirt for the VM creation and deletion. \
&gt; Surprisingly, we do see a significant increase in the real-time latency performance \
&gt; for the VMs launched through the libvirt. 
&gt; W.r.t configuration wise both VMs are the same, we just converted the existing QEMU \
&gt; commands into libvirt XMLs.

It would be useful to share your QEMU command line args seen both
with directly running QEMU and via libvirt. I'd be really suprised
if your direct config was exactly the same as libvirt's.

&gt; I am wondering what and all the features which libvirt has,
&gt; improving this performance.

If it isn't related to QEMU configuration, then most likely candidate
is the use of cgroups for placing VMs.

With regards,
Daniel
-- 
&gt; &gt; https://berrange.com      -o-    https://www.flickr.com/photos/dberrange :|
&gt; &gt; https://libvirt.org         -o-            https://fstop138.berrange.com :|
&gt; &gt; https://entangle-photo.org    -o-    https://www.instagram.com/dberrange :|


</body></email><email><emailId>20220419102546</emailId><senderName>Francesc Guasch</senderName><senderEmail>frankie@telecos.upc.edu</senderEmail><timestampReceived>2022-04-19 10:25:46-0400</timestampReceived><subject>Re: Help with libvirt</subject><body>

El 11/4/22 a les 15:06, Eduardo Kiassucumuca ha escrit:
&gt; Good morning I'm Eduardo, a computer science student and I'm doing a final 
&gt; course work focused on virtualization. The work consists of creating virtual 
&gt; machines on a server and allowing ssh access to the virtual machines that are 
&gt; on the server containing qemu/kvm/libvirt. The problem is that I can't access 
&gt; the virtual machines from an external network but I can access them inside the 
&gt; server. I would like to know what would be the best way since we want to have 
&gt; a single public ip and be able to have a reverse proxy to access the virtual 
&gt; machines, I would like to know from your experience what you recommend?

Hello Eduardo. I am afraid I am promoting our own project now. :)

We have a feature in Ravada VDI to easily expose ports. It was
a feature created for students virtual machines in a classroom.
But it can be applied anywhere.

https://ravada.readthedocs.io/en/latest/docs/expose_ports.html

Hope this helps.

</body></email><email><emailId>20220419103247</emailId><senderName>Daniel =?utf-8?B?UC4gQmVycmFuZ8Op?=</senderName><senderEmail>berrange@redhat.com</senderEmail><timestampReceived>2022-04-19 10:32:47-0400</timestampReceived><subject>Re: When does the balloon-change or control-error event occur</subject><body>

On Thu, Apr 07, 2022 at 05:16:45PM +0800, Han Han wrote:
&gt; Hi developers,
&gt; I have questions about balloon-change or control-error event:
&gt; 1. What's the meaning of these events
&gt; 2. When do the events occur?
&gt; 
&gt; The comments of their callbacks don't mention that(
&gt; https://gitlab.com/libvirt/libvirt/-/blob/master/include/libvirt/libvirt-domain.h#L4130
&gt; https://gitlab.com/libvirt/libvirt/-/blob/master/include/libvirt/libvirt-domain.h#L3736

'balloon-change' is emitted any time the guest OS changes the ballon
inflation level.

eg if the host admin sets the balloon target to 1 GB and the guest is
currently using 2 GB, it might not be able to immediately drop down to
the 1 GB mark. The balloon-change events will emited as it make progress
towards teh 1 GB mark.

control-error is emitted when libvirt has some kind of problem controlling
the VM. The VM is still running, but libvirt may not be able to make changes
to its config. This can happen if libvirt has problems parsing JSON from QMP.
In practice it is highly unlikely for this to ever happen.

With regards,
Daniel
-- 
|: https://berrange.com      -o-    https://www.flickr.com/photos/dberrange :|
|: https://libvirt.org         -o-            https://fstop138.berrange.com :|
|: https://entangle-photo.org    -o-    https://www.instagram.com/dberrange :|

</body></email><email><emailId>20220419170220</emailId><senderName>Bjoern Teipel</senderName><senderEmail>bjoern.teipel@rackspace.com</senderEmail><timestampReceived>2022-04-19 17:02:20-0400</timestampReceived><subject>Re: Virtio-scsi and block mirroring</subject><body>

Thanks Peter, that’s what I figured that the actual copy is done by the qemu process.
The copy job is setup by openstack volume migration and translate into

      &lt;mirror type='file' file='/var/lib/nova/mnt/xxx' format='raw' job='copy'&gt;
        &lt;format type='raw'/&gt;
        &lt;source file='/var/lib/nova/mnt/yyy' index='4'/&gt;
        &lt;backingStore/&gt;
      &lt;/mirror&gt;

From what I observed the issue is more noticeable when I see more fdatasync calls \
during the copy but I haven’t been able to correlate that to the issue 100% yet

Thanks
Bjoern
From: Peter Krempa &lt;pkrempa@redhat.com&gt;
Date: Tuesday, April 19, 2022 at 6:20 AM
To: Bjoern Teipel &lt;bjoern.teipel@RACKSPACE.COM&gt;
Cc: libvirt-users@redhat.com &lt;libvirt-users@redhat.com&gt;
Subject: Re: Virtio-scsi and block mirroring
CAUTION: This message originated externally, please use caution when clicking on \
links or opening attachments!


On Thu, Apr 14, 2022 at 16:36:38 +0000, Bjoern Teipel wrote:
&gt; Hello everyone,

Hi,

&gt; 
&gt; I’m looking at an issue where I do see guests freezing (Dl) process state during a \
&gt; block disk mirror from one storage to another storage (NFS) where the network stack \
&gt; of the guest can freeze for up to 10 seconds. Looking at the storage and IO I \
&gt; noticed good throughput ad low latency &lt;3ms and I am having trouble to track down \
&gt; the source for the issue, as neither storage nor networking  show issues. \
&gt; Interestingly when I do the same test with virtio-blk I do not really see the \
&gt; process freezes at the frequency or duration compared to virtio-scsi which seem to \
&gt; indicate a client side rather than storage side problem.

Hmm, this is really weird if the difference is in the guest-facing
device frontend.

Since libvirt is merely setting up the block job for the copy and the
copy itself is handled by qemu I suggest you contact the
qemu-block@nongnu.org mailing list.

Unfortunately you didn't provide any information on the disk
configuration (the VM XML) or how you start the blockjob, which I could
translate for you into qemu specifics. If you provide such information I
can do that to ensure that the qemu folks have all the relevant
information.


[Attachment #3 (text/html)]

&lt;html xmlns:o="urn:schemas-microsoft-com:office:office" \
xmlns:w="urn:schemas-microsoft-com:office:word" \
xmlns:m="http://schemas.microsoft.com/office/2004/12/omml" \
xmlns="http://www.w3.org/TR/REC-html40"&gt; &lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=Windows-1252"&gt;
&lt;meta name="Generator" content="Microsoft Word 15 (filtered medium)"&gt;
&lt;style&gt;&lt;!--
/* Font Definitions */
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
/* Style Definitions */
p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin:0in;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
.MsoChpDefault
	{mso-style-type:export-only;
	font-size:10.0pt;}
@page WordSection1
	{size:8.5in 11.0in;
	margin:1.0in 1.0in 1.0in 1.0in;}
div.WordSection1
	{page:WordSection1;}
--&gt;&lt;/style&gt;
&lt;/head&gt;
&lt;body lang="EN-US" link="#0563C1" vlink="#954F72" style="word-wrap:break-word"&gt;
&lt;div class="WordSection1"&gt;
&lt;p class="MsoNormal"&gt;Thanks Peter, that’s what I figured that the actual copy is done \
by the qemu process.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;The copy job is setup by \
openstack volume migration and translate into&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;span \
style="font-family:"Courier New""&gt;      &lt;mirror \
type='file' file='/var/lib/nova/mnt/xxx' format='raw' \
job='copy'&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;span \
style="font-family:"Courier \
New""&gt;        &lt;format \
type='raw'/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;span \
style="font-family:"Courier \
New""&gt;        &lt;source \
file='/var/lib/nova/mnt/yyy' index='4'/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;span style="font-family:"Courier \
New""&gt;        \
&lt;backingStore/&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;span \
style="font-family:"Courier New""&gt;      \
&lt;/mirror&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;From what I observed the issue is more noticeable when I see \
more fdatasync calls during the copy but I haven’t been able to correlate that to the \
issue 100% yet&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;Thanks&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;Bjoern&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;div style="border:none;border-top:solid #B5C4DF 1.0pt;padding:3.0pt 0in 0in 0in"&gt;
&lt;p class="MsoNormal" style="margin-bottom:12.0pt"&gt;&lt;b&gt;&lt;span \
style="font-size:12.0pt;color:black"&gt;From: &lt;/span&gt;&lt;/b&gt;&lt;span \
style="font-size:12.0pt;color:black"&gt;Peter Krempa &lt;pkrempa@redhat.com&gt;&lt;br&gt; \
&lt;b&gt;Date: &lt;/b&gt;Tuesday, April 19, 2022 at 6:20 AM&lt;br&gt; &lt;b&gt;To: &lt;/b&gt;Bjoern Teipel \
&lt;bjoern.teipel@RACKSPACE.COM&gt;&lt;br&gt; &lt;b&gt;Cc: &lt;/b&gt;libvirt-users@redhat.com \
&lt;libvirt-users@redhat.com&gt;&lt;br&gt; &lt;b&gt;Subject: &lt;/b&gt;Re: Virtio-scsi and block \
mirroring&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;/div&gt;
&lt;div&gt;
&lt;p class="MsoNormal" style="margin-bottom:12.0pt"&gt;CAUTION: This message originated \
externally, please use caution when clicking on links or opening attachments!&lt;br&gt; \
&lt;br&gt; &lt;br&gt;
On Thu, Apr 14, 2022 at 16:36:38 +0000, Bjoern Teipel wrote:&lt;br&gt;
&gt; Hello everyone,&lt;br&gt;
&lt;br&gt;
Hi,&lt;br&gt;
&lt;br&gt;
&gt;&lt;br&gt;
&gt; I’m looking at an issue where I do see guests freezing (Dl) process state during \
a block disk mirror from one storage to another storage (NFS) where the network stack \
of the guest can freeze for up to 10 seconds.&lt;br&gt; &gt; Looking at the storage and IO \
I noticed good throughput ad low latency &lt;3ms and I am having trouble to track \
down the source for the issue, as neither storage nor networking  show issues. \
Interestingly when I do the same test with virtio-blk I do not really  see the \
process freezes at the frequency or duration compared to virtio-scsi which seem to \
indicate a client side rather than storage side problem.&lt;br&gt; &lt;br&gt;
Hmm, this is really weird if the difference is in the guest-facing&lt;br&gt;
device frontend.&lt;br&gt;
&lt;br&gt;
Since libvirt is merely setting up the block job for the copy and the&lt;br&gt;
copy itself is handled by qemu I suggest you contact the&lt;br&gt;
qemu-block@nongnu.org mailing list.&lt;br&gt;
&lt;br&gt;
Unfortunately you didn't provide any information on the disk&lt;br&gt;
configuration (the VM XML) or how you start the blockjob, which I could&lt;br&gt;
translate for you into qemu specifics. If you provide such information I&lt;br&gt;
can do that to ensure that the qemu folks have all the relevant&lt;br&gt;
information.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;



</body></email><email><emailId>20220420092930</emailId><senderName>Valentijn Sessink</senderName><senderEmail>v.sessink@openoffice.nl</senderEmail><timestampReceived>2022-04-20 09:29:30-0400</timestampReceived><subject>Re: race condition? virsh migrate --copy-storage-all</subject><body>

Hi, not really virsh related anymore, but just to summarize: it was in
fact an ethernet problem:

On 19-04-2022 16:21, Valentijn Sessink wrote:
&gt; 192.168.112.31.39324 &gt; 192.168.112.12.22: Flags [P.], cksum 0x61e7 
&gt; (incorrect -&gt; 0x3220), seq 9618:9686, ack 5038, win 501, options

Probably related to https://bugzilla.kernel.org/show_bug.cgi?id=206969 
(same adapter).

# ethtool -K enp1s0 tx off
... helped.

Thanks again for your help. Best regards,

Valentijn
-- 
http://www.openoffice.nl/   Open Office - Linux Office Solutions
Valentijn Sessink  v.sessink@openoffice.nl  +31(0)20-4214059

</body></email><email><emailId>20220425182925</emailId><senderName>Nate Collins</senderName><senderEmail>ncollins@xes-inc.com</senderEmail><timestampReceived>2022-04-25 18:29:25-0400</timestampReceived><subject>discard option on ext4 mounts in QEMU qcow2 images</subject><body>

Hello,

Does anyone have any real-world statistics on the reliability and
performance of the ext4 discard option in QEMU VMs? I've heard it's
discouraged for physical devices, as some are inefficient in how
TRIM requests are processed, but I was wondering if there were any
drawbacks/warnings when it comes to virtual disks (in this case, QCOW2s).

I currently use either virtio-scsi or virtio-blk drivers for disk
images depending on what the host/guest support, and run TRIMs weekly,
but having an immediate freeing of space is desirable for many reasons.

Also wondering if snapshots on snapshotting filesystems (such as ZFS) can
run into corruption or other issues if snapshots are taken during a TRIM.

Thanks.

</body></email><email><emailId>20220426153721</emailId><senderName>Peter Krempa</senderName><senderEmail>pkrempa@redhat.com</senderEmail><timestampReceived>2022-04-26 15:37:21-0400</timestampReceived><subject>Re: set fixed time at vm guest startup?</subject><body>

On Fri, Apr 22, 2022 at 12:54:35 -0600, Fred Clift wrote:
&gt; I'm looking at the &lt;clock&gt; libvirt parameters.
&gt; 
&gt; Is there a way to set the guests clock to a specific time/date at  virt
&gt; startup?  I'm trying to virtualize a system with pci passthrough for a
&gt; hardware device that wants to always live in pre-2011.  The license manager
&gt; for the software/hardware has 31-bit overflow of time calculations.

Hi, currently there is no such thing, only stuff that would allow you to
set an arbitrary offset to the current time, which would not be zero
maintenance.

However it's very simple to implement
https://listman.redhat.com/archives/libvir-list/2022-April/230492.html

That patchset introduces an 'absolute' mode for clock with an element
'start' where you can put an arbitrary unix epoch timestamp which is set
always on boot of the VM.

</body></email><email><emailId>20220427090443</emailId><senderName>Jiatong Shen</senderName><senderEmail>yshxxsjt715@gmail.com</senderEmail><timestampReceived>2022-04-27 09:04:43-0400</timestampReceived><subject>Re: how to change emulator path during live migration</subject><body>

[Attachment #2 (multipart/alternative)]


ah.. sorry for the mistake.

I find that on the source libvirt will also verify emulator binary, thus
emulator must
also exist on src. because in qemuMigrationBegin method, it will
call qemuDomainDefCopy
and eventually validates emulator exists...

best,

Jiatong Shen

On Wed, Apr 27, 2022 at 4:03 PM Peter Krempa &lt;pkrempa@redhat.com&gt; wrote:

&gt; [re-adding libvirt-users list]
&gt;
&gt; Please always reply to the list so that the follow-up conversation is
&gt; archived and delivered to all subscribers.
&gt;
&gt; On Wed, Apr 27, 2022 at 15:36:54 +0800, Jiatong Shen wrote:
&gt; &gt; Thank you for the feedback!
&gt; &gt;
&gt; &gt; Is it ok if the source node does not contain a emulator path used by the
&gt; &gt; dest node? for example, on src emulator path is /a/b/c, but
&gt; &gt; on dest it is /a/b/d, and /a/b/d does not exist on src.
&gt;
&gt; You can change the emulator path arbitrarily. The only limitation is
&gt; that the emulator you pick (the binary, not the path) must be able to
&gt; run the VM, but that will be validated during the migration.
&gt;
&gt;

-- 

Best Regards,

Jiatong Shen

[Attachment #5 (text/html)]

&lt;div dir="ltr"&gt;ah.. sorry for the mistake.&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I find that on the \
source libvirt will also verify emulator binary, thus emulator must  &lt;/div&gt;&lt;div&gt;also \
exist on src. because in  qemuMigrationBegin method, it will call  \
qemuDomainDefCopy&lt;/div&gt;&lt;div&gt;and eventually  validates emulator \
exists...&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;best,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Jiatong \
Shen&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div class="gmail_quote"&gt;&lt;div dir="ltr" class="gmail_attr"&gt;On \
Wed, Apr 27, 2022 at 4:03 PM Peter Krempa &lt;&lt;a href="mailto:pkrempa@redhat.com" \
target="_blank"&gt;pkrempa@redhat.com&lt;/a&gt;&gt; wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote \
class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left:1px solid \
rgb(204,204,204);padding-left:1ex"&gt;[re-adding libvirt-users list]&lt;br&gt; &lt;br&gt;
Please always reply to the list so that the follow-up conversation is&lt;br&gt;
archived and delivered to all subscribers.&lt;br&gt;
&lt;br&gt;
On Wed, Apr 27, 2022 at 15:36:54 +0800, Jiatong Shen wrote:&lt;br&gt;
&gt; Thank you for the feedback!&lt;br&gt;
&gt; &lt;br&gt;
&gt; Is it ok if the source node does not contain a emulator path used by the&lt;br&gt;
&gt; dest node? for example, on src emulator path is /a/b/c, but&lt;br&gt;
&gt; on dest it is /a/b/d, and /a/b/d does not exist on src.&lt;br&gt;
&lt;br&gt;
You can change the emulator path arbitrarily. The only limitation is&lt;br&gt;
that the emulator you pick (the binary, not the path) must be able to&lt;br&gt;
run the VM, but that will be validated during the migration.&lt;br&gt;
&lt;br&gt;
&lt;/blockquote&gt;&lt;/div&gt;&lt;br clear="all"&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;-- &lt;br&gt;&lt;div dir="ltr"&gt;&lt;div \
dir="ltr"&gt;&lt;br&gt;&lt;div&gt;Best Regards,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Jiatong \
Shen&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;


["debug.txt" (text/plain)]

(gdb) where
#0  virQEMUCapsNewForBinaryInternal (hostArch=VIR_ARCH_X86_64, binary=0x7fffe800d530 \
"/usr/bin/sjt-test", libDir=0x7fff94021dd0 "/var/lib/libvirt/qemu", runUid=0, \
runGid=0, microcodeVersion=1,   kernelVersion=0x7fff9400a7c0 "4.15.0-112-generic \
#113-Ubuntu SMP Thu Jul 9 23:41:39 UTC 2020", qmpOnly=false) at \
../../src/qemu/qemu_capabilities.c:5262 #1  0x00007fffc3aacd95 in virQEMUCapsNewData \
(binary=&lt;optimized out&gt;, privData=&lt;optimized out&gt;) at \
../../src/qemu/qemu_capabilities.c:5340 #2  0x00007ffff737a6e7 in virFileCacheNewData \
(name=0x7fffe800d530 "/usr/bin/sjt-test", cache=0x7fff940286d0) at \
../../src/util/virfilecache.c:223 #3  virFileCacheValidate \
(cache=cache@entry=0x7fff940286d0, name=name@entry=0x7fffe800d530 \
"/usr/bin/sjt-test", data=data@entry=0x7ffff0b47410) at \
../../src/util/virfilecache.c:294 #4  0x00007ffff737ab37 in virFileCacheLookup \
(cache=0x7fff940286d0, name=name@entry=0x7fffe800d530 "/usr/bin/sjt-test") at \
../../src/util/virfilecache.c:327 #5  0x00007fffc3aad02e in virQEMUCapsCacheLookup \
(cache=&lt;optimized out&gt;, binary=0x7fffe800d530 "/usr/bin/sjt-test") at \
../../src/qemu/qemu_capabilities.c:5477 #6  0x00007fffc3acc677 in \
qemuDomainPostParseDataAlloc (def=&lt;optimized out&gt;, caps=&lt;optimized out&gt;, \
parseFlags=&lt;optimized out&gt;, opaque=&lt;optimized out&gt;, parseOpaque=0x7ffff0b474b0) at \
../../src/qemu/qemu_domain.c:4623 #7  0x00007ffff73a65a9 in \
virDomainDefPostParseInternal (def=def@entry=0x7fffe800cf20, \
caps=caps@entry=0x7fff94161560, parseFlags=parseFlags@entry=1026, \
xmlopt=xmlopt@entry=0x7fff94157830,   parseOpaque=parseOpaque@entry=0x0, \
bootHash=bootHash@entry=0x7fffe800d7e0) at ../../src/conf/domain_conf.c:5036 #8  \
0x00007ffff73bb6fd in virDomainDefParseXML (xml=xml@entry=0x7fffe800fcc0, \
root=root@entry=0x7fffe8003c40, ctxt=ctxt@entry=0x7fffe8006950, \
caps=caps@entry=0x7fff94161560, xmlopt=xmlopt@entry=0x7fff94157830,   \
parseOpaque=parseOpaque@entry=0x0, flags=1026) at ../../src/conf/domain_conf.c:19957 \
#9  0x00007ffff73bf11c in virDomainDefParseNode (xml=xml@entry=0x7fffe800fcc0, \
root=0x7fffe8003c40, caps=caps@entry=0x7fff94161560, \
xmlopt=xmlopt@entry=0x7fff94157830, parseOpaque=parseOpaque@entry=0x0,   \
flags=flags@entry=1026) at ../../src/conf/domain_conf.c:20144 #10 0x00007ffff73bf242 \
in virDomainDefParse (  xmlStr=0x7fffe8010630 "&lt;domain type='kvm'&gt;\n  \
&lt;name&gt;sjt-test&lt;/name&gt;\n  &lt;uuid&gt;c7a5fdbd-cdaf-9455-926a-d65c16db1809&lt;/uuid&gt;\n  &lt;memory \
unit='KiB'&gt;220160&lt;/memory&gt;\n  &lt;currentMemory unit='KiB'&gt;219200&lt;/currentMemory&gt;\n  \
&lt;vcpu placemen"..., filename=filename@entry=0x0, caps=caps@entry=0x7fff94161560, \
xmlopt=xmlopt@entry=0x7fff94157830, parseOpaque=parseOpaque@entry=0x0, \
flags=flags@entry=1026) at ../../src/conf/domain_conf.c:20088 #11 0x00007ffff73bf293 \
in virDomainDefParseString (xmlStr=&lt;optimized out&gt;, caps=caps@entry=0x7fff94161560, \
xmlopt=xmlopt@entry=0x7fff94157830, parseOpaque=parseOpaque@entry=0x0, \
flags=flags@entry=1026)  at ../../src/conf/domain_conf.c:20104
#12 0x00007ffff73bf2f2 in virDomainDefCopy (src=src@entry=0x7fffe8010f20, \
caps=caps@entry=0x7fff94161560, xmlopt=0x7fff94157830, \
parseOpaque=parseOpaque@entry=0x0, migratable=&lt;optimized out&gt;)  at \
../../src/conf/domain_conf.c:27416 #13 0x00007fffc3ad7bca in \
qemuDomainDefFormatBufInternal (driver=driver@entry=0x7fff94034de0, \
def=def@entry=0x7fffe8010f20, origCPU=origCPU@entry=0x0, flags=flags@entry=9, \
buf=buf@entry=0x7ffff0b47870)  at ../../src/qemu/qemu_domain.c:5246
#14 0x00007fffc3ad815a in qemuDomainDefFormatXMLInternal \
(driver=driver@entry=0x7fff94034de0, def=def@entry=0x7fffe8010f20, \
origCPU=origCPU@entry=0x0, flags=flags@entry=9) at ../../src/qemu/qemu_domain.c:5432 \
#15 0x00007fffc3ad8196 in qemuDomainDefFormatXML (driver=driver@entry=0x7fff94034de0, \
def=def@entry=0x7fffe8010f20, flags=flags@entry=9) at \
../../src/qemu/qemu_domain.c:5444 #16 0x00007fffc3ad81bd in qemuDomainDefCopy \
(driver=driver@entry=0x7fff94034de0, src=src@entry=0x7fffe8010f20, \
flags=flags@entry=9) at ../../src/qemu/qemu_domain.c:5218 #17 0x00007fffc3ad8345 in \
qemuDomainCheckABIStability (driver=driver@entry=0x7fff94034de0, \
vm=vm@entry=0x7fff940ebbd0, dst=dst@entry=0x7fffe8010f20) at \
../../src/qemu/qemu_domain.c:7098 #18 0x00007fffc3b09066 in qemuMigrationBeginPhase \
(driver=driver@entry=0x7fff94034de0, vm=&lt;optimized out&gt;,   \
xmlin=xmlin@entry=0x7fffe80059a0 "&lt;domain type='kvm'&gt;\n  &lt;name&gt;sjt-test&lt;/name&gt;\n  \
&lt;uuid&gt;c7a5fdbd-cdaf-9455-926a-d65c16db1809&lt;/uuid&gt;\n  &lt;memory \
unit='KiB'&gt;220160&lt;/memory&gt;\n  &lt;currentMemory unit='KiB'&gt;219200&lt;/currentMemory&gt;\n  \
&lt;vcpu placemen"..., dname=dname@entry=0x0, cookieout=cookieout@entry=0x7ffff0b47ba8, \
cookieoutlen=cookieoutlen@entry=0x7ffff0b47b9c, nmigrate_disks=0, migrate_disks=0x0, \
flags=328)  at ../../src/qemu/qemu_migration.c:2120
#19 0x00007fffc3b09911 in qemuMigrationBegin (conn=0x7fffd4000d50, vm=&lt;optimized \
out&gt;,   xmlin=0x7fffe80059a0 "&lt;domain type='kvm'&gt;\n  &lt;name&gt;sjt-test&lt;/name&gt;\n  \
&lt;uuid&gt;c7a5fdbd-cdaf-9455-926a-d65c16db1809&lt;/uuid&gt;\n  &lt;memory \
unit='KiB'&gt;220160&lt;/memory&gt;\n  &lt;currentMemory unit='KiB'&gt;219200&lt;/currentMemory&gt;\n  \
&lt;vcpu placemen"..., dname=0x0, cookieout=cookieout@entry=0x7ffff0b47ba8, \
cookieoutlen=cookieoutlen@entry=0x7ffff0b47b9c, nmigrate_disks=0, migrate_disks=0x0, \
flags=328) at ../../src/qemu/qemu_migration.c:2177 #20 0x00007fffc3b41280 in \
qemuDomainMigrateBegin3Params (domain=0x7fffe8001e60, params=&lt;optimized out&gt;, \
nparams=2, cookieout=0x7ffff0b47ba8, cookieoutlen=0x7ffff0b47b9c, flags=&lt;optimized \
out&gt;)  at ../../src/qemu/qemu_driver.c:12389
#21 0x00007ffff741abe9 in virDomainMigrateBegin3Params \
(domain=domain@entry=0x7fffe8001e60, params=&lt;optimized out&gt;, nparams=2, \
cookieout=cookieout@entry=0x7ffff0b47ba8, \
cookieoutlen=cookieoutlen@entry=0x7ffff0b47b9c,   flags=328) at \
../../src/libvirt-domain.c:4832 #22 0x000055555557cec8 in \
remoteDispatchDomainMigrateBegin3Params (server=0x55555581ef70, msg=0x5555558666b0, \
ret=0x7fffe8001a30, args=0x7fffe8006910, rerr=0x7ffff0b47ca0, client=&lt;optimized out&gt;) \
at ../../daemon/remote.c:5212 #23 remoteDispatchDomainMigrateBegin3ParamsHelper \
(server=0x55555581ef70, client=&lt;optimized out&gt;, msg=0x5555558666b0, \
rerr=0x7ffff0b47ca0, args=0x7fffe8006910, ret=0x7fffe8001a30) at \
../../daemon/remote_dispatch.h:7421 #24 0x00007ffff748639c in \
virNetServerProgramDispatchCall (msg=0x5555558666b0, client=0x555555864260, \
server=0x55555581ef70, prog=0x55555583e7e0) at \
../../src/rpc/virnetserverprogram.c:436 #25 virNetServerProgramDispatch \
(prog=0x55555583e7e0, server=server@entry=0x55555581ef70, client=0x555555864260, \
                msg=0x5555558666b0) at ../../src/rpc/virnetserverprogram.c:307
---Type &lt;return&gt; to continue, or q &lt;return&gt; to quit---
#26 0x00005555555a8088 in virNetServerProcessMsg (msg=&lt;optimized out&gt;, \
prog=&lt;optimized out&gt;, client=&lt;optimized out&gt;, srv=0x55555581ef70) at \
../../src/rpc/virnetserver.c:148 #27 virNetServerHandleJob (jobOpaque=&lt;optimized \
out&gt;, opaque=0x55555581ef70) at ../../src/rpc/virnetserver.c:169 #28 \
0x00007ffff736dba1 in virThreadPoolWorker (opaque=opaque@entry=0x55555580fbd0) at \
../../src/util/virthreadpool.c:167 #29 0x00007ffff736cf18 in virThreadHelper \
(data=&lt;optimized out&gt;) at ../../src/util/virthread.c:206 #30 0x00007ffff6e4d6db in \
start_thread (arg=0x7ffff0b48700) at pthread_create.c:463 #31 0x00007ffff6b7661f in \
clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95



</body></email><email><emailId>20220429152052</emailId><senderName>Thomas Luening</senderName><senderEmail>toml@thlu.de</senderEmail><timestampReceived>2022-04-29 15:20:52-0400</timestampReceived><subject>Issue with Guest and 2 Displays</subject><body>


Hi @ all

Since switching from Debian 10 to Debian 11, I've had a new small unsolved
problem... with essentially the same customizing as before.

It all takes place on my local Desktop-PC, where I have set up a
restricted VM for actions in the internet.

After I started the VM locally on my PC, I can operate the VM with the
virtviewer without any errors. If I then open the second monitor via
the Menu 'View-&gt;Display', a blank white window appears with the message
"Waiting for display 2".

xrandr correctly shows the second display as disconnected and also all
available display-modes.

After the following command
xrandr --output Virtual-2 --auto --right-of Virtual-1
both (!) displays are white and both are waiting for a display.... and
nothing works anymore.

A previously started SSH connection to the VM from the PC shows the
following for this moment:
tom@pc:~
$ ssh 192.168.100.10

$ tom@vm:~
$su-
Password:

root@vm:~
# journalctl -f
Apr 29 16:24:34 internet kernel: [drm] driver is in bug mode
Apr 29 16:24:44 internet spice-vdagent[809]: Unable to find a display id for output \
                index 2)
Apr 29 16:24:44 internet spice-vdagent[809]: Unable to find a display id for output \
                index 3)
Apr 29 16:24:44 internet spice-vdagent[809]: Unable to find a display id for output \
                index 2)
Apr 29 16:24:44 internet spice-vdagent[809]: Unable to find a display id for output \
                index 3)
Apr 29 16:24:44 internet kernel: input: spice vdagent tablet as \
/devices/virtual/input/input7

It is no longer possible to restart the VM via "systemctl reboot",
the VM is probably stuck in some systemd-timeouts, only
"systemctl reboot -ff" leads to a reboot as a hard intervention.

Does anyone know this problem? Is there a solution for this, to get the second \
display working?



Below some relevant system-informations of my PC and the VM.

root@pc:~
$ lsb_release -a
Distributor ID:	Debian
Description:    Debian GNU/Linux 11 (bullseye)
Release:        11
Codename:       bullseye

root@pc:~
# uname -a
Linux pc 5.10.0-13-amd64 #1 SMP Debian 5.10.106-1 (2022-03-17) x86_64 GNU/Linux

root@pc:~
# cat /etc/libvirt/qemu/internet.xml | grep '&lt;video' -A 3
     &lt;video&gt;
       &lt;model type='qxl' ram='65536' vram='65536' vgamem='16384' heads='2' \
                primary='yes'/&gt;
       &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0'/&gt;
     &lt;/video&gt;



tom@vm:~
$ lsb_release -a
Distributor ID: Debian
Description:    Debian GNU/Linux 11 (bullseye)
Release:        11
Codename:       bullseye

tom@vm:~
$ dpkg -l | grep -i spice
ii  spice-vdagent  0.20.0-2  amd64   Spice agent for Linux

tom@vm:~
$ systemctl status spice-vdagent.service
● spice-vdagentd.service - Agent daemon for Spice guests
      Loaded: loaded (/lib/systemd/system/spice-vdagentd.service; indirect; vendor \
                preset: enabled)
      Active: active (running) since Fri 2022-04-29 16:00:56 CEST; 16min ago
TriggeredBy: ● spice-vdagentd.socket
     Process: 847 ExecStart=/usr/sbin/spice-vdagentd $SPICE_VDAGENTD_EXTRA_ARGS \
(code=exited, status=0/SUCCESS)  Main PID: 849 (spice-vdagentd)
       Tasks: 2 (limit: 4702)
      Memory: 944.0K
         CPU: 1.918s
      CGroup: /system.slice/spice-vdagentd.service
              └─849 /usr/sbin/spice-vdagentd


Thanks and Best Regards
Tom


</body></email><email><emailId>20220422185435</emailId><senderName>Fred Clift</senderName><senderEmail>fred@clift.org</senderEmail><timestampReceived>2022-04-22 18:54:35-0400</timestampReceived><subject>set fixed time at vm guest startup?</subject><body>

I'm looking at the &lt;clock&gt; libvirt parameters.

Is there a way to set the guests clock to a specific time/date at  virt
startup?  I'm trying to virtualize a system with pci passthrough for a
hardware device that wants to always live in pre-2011.  The license manager
for the software/hardware has 31-bit overflow of time calculations.

The current process on the physical machine is to power it on, use the bios
to set the hardware date to Jan 1 2010, boot the system, use an RC script
to ntp-set the date now that the hardware is up and running, and then
everything works till next boot.  We even have a nice rc script that will
set the clock back to 2010 if you do a clean shutdown/reboot.

I see I can set my clock sync to variable and specify a negative offset -
is there a way to just say "always be jan 10 2010 when you power on"?

Fred

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;I'm looking at the &lt;clock&gt; libvirt \
parameters.&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Is there a way to set the guests clock to a specific \
time/date at   virt startup?   I'm trying to virtualize a system with pci \
passthrough for a hardware device that wants to always live in pre-2011.   The \
license manager for the software/hardware has 31-bit overflow of time calculations.   \
&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The current process on the physical machine is to power it \
on, use the bios to set the hardware date to Jan 1 2010, boot the system, use an RC \
script to ntp-set the date now that the hardware is up and running, and then \
everything works till next boot.   We even have a nice rc script that will set the \
clock back to 2010 if you do a clean shutdown/reboot.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I see \
I can set my clock sync to variable and specify a negative offset - is there a way to \
just say "always be jan 10 2010 when you power \
on"?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Fred&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220427061123</emailId><senderName>Jiatong Shen</senderName><senderEmail>yshxxsjt715@gmail.com</senderEmail><timestampReceived>2022-04-27 06:11:23-0400</timestampReceived><subject>how to change emulator path during live migration</subject><body>

Hello libvirt experts,

  I am facing the following exceptions during live migrating a virtual
machine from one compute node to another.

file or directory: libvirt.libvirtError: Cannot check QEMU binary
/usr/bin/kvm-spice: No such file or directory
  File "/var/lib/openstack/lib/python3.6/site-packages/eventlet/tpool.py",
line 83, in tworker
    rv = meth(*args, **kwargs)
  File "/var/lib/openstack/lib/python3.6/site-packages/libvirt.py", line
1745, in migrateToURI3
    if ret == -1: raise libvirtError ('virDomainMigrateToURI3() failed',
dom=self)
libvirt.libvirtError: Cannot check QEMU binary /usr/bin/kvm-spice: No such
file or directory

After some investigation, we found that this error is triggered because we
do not have qemu-kvm installed in our container, btw the libvirt is
directly installed on the source node.

I have following questions

Is it possible to change emulator during live migration? I try to to remove
emulator under devices but looks like it does not help.

thank you very much and looking forward for the feedback.
-- 

Best Regards,

Jiatong Shen

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;Hello libvirt experts,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;   I am facing the following \
exceptions during live migrating a virtual machine from one compute node to \
another.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;file or directory: libvirt.libvirtError: Cannot \
check QEMU binary /usr/bin/kvm-spice: No such file or directory&lt;br&gt;   File \
"/var/lib/openstack/lib/python3.6/site-packages/eventlet/tpool.py", line \
83, in tworker&lt;br&gt;      rv = meth(*args, **kwargs)&lt;br&gt;   File \
"/var/lib/openstack/lib/python3.6/site-packages/libvirt.py", line 1745, in \
migrateToURI3&lt;br&gt;      if ret == -1: raise libvirtError \
('virDomainMigrateToURI3() failed', dom=self)&lt;br&gt;libvirt.libvirtError: Cannot \
check QEMU binary /usr/bin/kvm-spice: No such file or directory&lt;br \
clear="all"&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;After some investigation, we found that this error is \
triggered because we do not have qemu-kvm installed in our container, btw the libvirt \
is directly installed on the source node.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I have following \
questions&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Is it possible to change emulator during live \
migration? I try to to remove emulator under devices but looks like it does not \
help.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;thank you very much and looking forward for the \
feedback.&lt;/div&gt;-- &lt;br&gt;&lt;div dir="ltr" class="gmail_signature" \
data-smartmail="gmail_signature"&gt;&lt;div dir="ltr"&gt;&lt;br&gt;&lt;div&gt;Best \
Regards,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Jiatong Shen&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220427070126</emailId><senderName>Peter Krempa</senderName><senderEmail>pkrempa@redhat.com</senderEmail><timestampReceived>2022-04-27 07:01:26-0400</timestampReceived><subject>Re: how to change emulator path during live migration</subject><body>

On Wed, Apr 27, 2022 at 14:11:23 +0800, Jiatong Shen wrote:
&gt; Hello libvirt experts,
&gt; 
&gt;   I am facing the following exceptions during live migrating a virtual
&gt; machine from one compute node to another.
&gt; 
&gt; file or directory: libvirt.libvirtError: Cannot check QEMU binary
&gt; /usr/bin/kvm-spice: No such file or directory
&gt;   File "/var/lib/openstack/lib/python3.6/site-packages/eventlet/tpool.py",
&gt; line 83, in tworker
&gt;     rv = meth(*args, **kwargs)
&gt;   File "/var/lib/openstack/lib/python3.6/site-packages/libvirt.py", line
&gt; 1745, in migrateToURI3
&gt;     if ret == -1: raise libvirtError ('virDomainMigrateToURI3() failed',
&gt; dom=self)
&gt; libvirt.libvirtError: Cannot check QEMU binary /usr/bin/kvm-spice: No such
&gt; file or directory
&gt; 
&gt; After some investigation, we found that this error is triggered because we
&gt; do not have qemu-kvm installed in our container, btw the libvirt is
&gt; directly installed on the source node.
&gt; 
&gt; I have following questions
&gt; 
&gt; Is it possible to change emulator during live migration? I try to to remove
&gt; emulator under devices but looks like it does not help.

The migration API you've used (virDomainMigrateToURI3) supports
additional parameters. One of the supported parameters is:

VIR_MIGRATE_PARAM_DEST_XML:

/**
 * VIR_MIGRATE_PARAM_DEST_XML:
 *
 * virDomainMigrate* params field: the new configuration to be used for the
 * domain on the destination host as VIR_TYPED_PARAM_STRING. The configuration
 * must include an identical set of virtual devices, to ensure a stable guest
 * ABI across migration. Only parameters related to host side configuration
 * can be changed in the XML. Hypervisors which support this field will forbid
 * migration if the provided XML would cause a change in the guest ABI. This
 * field cannot be used to rename the domain during migration (use
 * VIR_MIGRATE_PARAM_DEST_NAME field for that purpose). Domain name in the
 * destination XML must match the original domain name.
 *
 * Omitting this parameter keeps the original domain configuration. Using this
 * field with hypervisors that do not support changing domain configuration
 * during migration will result in a failure.
 *
 * Since: v1.1.0
 */

So you fetch a migratable version of the XML (VIR_DOMAIN_XML_MIGRATABLE
flag for the XML dumping API) and update the emulator path. Then feed it
as the additional parameter

</body></email><email><emailId>20220427080348</emailId><senderName>Peter Krempa</senderName><senderEmail>pkrempa@redhat.com</senderEmail><timestampReceived>2022-04-27 08:03:48-0400</timestampReceived><subject>Re: how to change emulator path during live migration</subject><body>

[re-adding libvirt-users list]

Please always reply to the list so that the follow-up conversation is
archived and delivered to all subscribers.

On Wed, Apr 27, 2022 at 15:36:54 +0800, Jiatong Shen wrote:
&gt; Thank you for the feedback!
&gt; 
&gt; Is it ok if the source node does not contain a emulator path used by the
&gt; dest node? for example, on src emulator path is /a/b/c, but
&gt; on dest it is /a/b/d, and /a/b/d does not exist on src.

You can change the emulator path arbitrarily. The only limitation is
that the emulator you pick (the binary, not the path) must be able to
run the VM, but that will be validated during the migration.

</body></email><email><emailId>20220423035205</emailId><senderName>Deepti S</senderName><senderEmail>deeptiyhere@gmail.com</senderEmail><timestampReceived>2022-04-23 03:52:05-0400</timestampReceived><subject>Re: set fixed time at vm guest startup?</subject><body>

Can the admin please remove me from the mailing list?

Regards,
Deepti

On Sat, Apr 23, 2022 at 12:24 AM Fred Clift &lt;fred@clift.org&gt; wrote:

&gt; I'm looking at the &lt;clock&gt; libvirt parameters.
&gt;
&gt; Is there a way to set the guests clock to a specific time/date at  virt
&gt; startup?  I'm trying to virtualize a system with pci passthrough for a
&gt; hardware device that wants to always live in pre-2011.  The license manager
&gt; for the software/hardware has 31-bit overflow of time calculations.
&gt;
&gt; The current process on the physical machine is to power it on, use the
&gt; bios to set the hardware date to Jan 1 2010, boot the system, use an RC
&gt; script to ntp-set the date now that the hardware is up and running, and
&gt; then everything works till next boot.  We even have a nice rc script that
&gt; will set the clock back to 2010 if you do a clean shutdown/reboot.
&gt;
&gt; I see I can set my clock sync to variable and specify a negative offset -
&gt; is there a way to just say "always be jan 10 2010 when you power on"?
&gt;
&gt; Fred
&gt;

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;Can the admin please remove me from the mailing \
list?&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Regards,&lt;/div&gt;&lt;div&gt;Deepti&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div \
class="gmail_quote"&gt;&lt;div dir="ltr" class="gmail_attr"&gt;On Sat, Apr 23, 2022 at 12:24 \
AM Fred Clift &lt;&lt;a href="mailto:fred@clift.org"&gt;fred@clift.org&lt;/a&gt;&gt; \
wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0px 0px 0px \
0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"&gt;&lt;div dir="ltr"&gt;I'm \
looking at the &lt;clock&gt; libvirt parameters.&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Is there a way to \
set the guests clock to a specific time/date at   virt startup?   I'm trying to \
virtualize a system with pci passthrough for a hardware device that wants to always \
live in pre-2011.   The license manager for the software/hardware has 31-bit overflow \
of time calculations.    &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The current process on the \
physical machine is to power it on, use the bios to set the hardware date to Jan 1 \
2010, boot the system, use an RC script to ntp-set the date now that the hardware is \
up and running, and then everything works till next boot.   We even have a nice rc \
script that will set the clock back to 2010 if you do a clean \
shutdown/reboot.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I see I can set my clock sync to variable \
and specify a negative offset - is there a way to just say "always be jan 10 \
2010 when you power on"?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Fred&lt;/div&gt;&lt;/div&gt; \
&lt;/blockquote&gt;&lt;/div&gt;



</body></email><email><emailId>20220301121238</emailId><senderName>Michal Prívozník</senderName><senderEmail>mprivozn@redhat.com</senderEmail><timestampReceived>2022-03-01 12:12:38-0400</timestampReceived><subject>Re: libvirtd file descriptors leaking</subject><body>

On 3/1/22 12:40, Дмитрий wrote:
&gt; Any update on this issue? Does anyone have a success on reproducing that? Should I \
&gt; upgrade/downgrade/sidegrade? 
&gt; Additional info:
&gt; 
&gt; I am using CentOS 8 Stream, but with kernel
&gt; 
&gt; 5.14.15-1.el8.elrepo.x86_64 #1 SMP Tue Oct 26 11:45:20 EDT 2021 x86_64 x86_64 \
&gt; x86_64 GNU/Linux 

I believe this was fixed in RHEL-8, by a RHEL-only patch, because in
there glib backported a commit that broke our upstream workaround. And
since CentOS 8 Stream is behind RHEL you will get the fix eventually
(sorry I don't know the schedule). However, I don't think that the
RHEL-only patch can be merged upstream, because then it would break
distros with older glib that did not mangle it.

I'm sorry, I don't have a better answer.

Michal


</body></email><email><emailId>20220308010054</emailId><senderName>Yalan Zhang</senderName><senderEmail>yalzhang@redhat.com</senderEmail><timestampReceived>2022-03-08 01:00:54-0400</timestampReceived><subject>Re: Number of the max supported VFs are different</subject><body>

Hi Michal,

Get it, Thank you!


On Mon, Mar 7, 2022 at 7:36 PM Michal Pr=C3=ADvozn=C3=ADk &lt;mprivozn@redhat.=
com&gt; wrote:

&gt; On 3/3/22 03:55, Yalan Zhang wrote:
&gt; &gt; Hi there,
&gt; &gt;
&gt; &gt; I have an Intel X520 network card, and I find the max supported VFs are
&gt; &gt; different.
&gt; &gt; Please check below outputs:
&gt; &gt;
&gt; &gt; # lspci -vvv -s 04:00.0
&gt; &gt; 04:00.0 Ethernet controller: Intel Corporation Ethernet 10G 2P X520
&gt; &gt; Adapter (rev 01)
&gt; &gt; ...
&gt; &gt;  Capabilities: [160 v1] Single Root I/O Virtualization (SR-IOV)
&gt; &gt; IOVCap: Migration-, Interrupt Message Number: 000
&gt; &gt; IOVCtl: Enable- Migration- Interrupt- MSE- ARIHierarchy+
&gt; &gt; IOVSta: Migration-
&gt; &gt; ** Initial VFs: 64, Total VFs: 64**, Number of VFs: 0, Function
&gt; &gt; Dependency Link: 00
&gt; &gt; VF offset: 128, stride: 2, Device ID: 10ed
&gt; &gt; Supported Page Size: 00000553, System Page Size: 00000001
&gt; &gt; Region 0: Memory at 0000000094400000 (64-bit, prefetchable)
&gt; &gt; Region 3: Memory at 0000000094500000 (64-bit, prefetchable)
&gt; &gt; VF Migration: offset: 00000000, BIR: 0
&gt; &gt; Kernel driver in use: ixgbe
&gt; &gt; Kernel modules: ixgbe
&gt; &gt;
&gt; &gt; # cat /sys/class/net/enp4s0f0/device/sriov_totalvfs
&gt; &gt; 63
&gt; &gt;
&gt; &gt; # echo 64 &gt; /sys/class/net/enp4s0f0/device/sriov_numvfs
&gt; &gt; -bash: echo: write error: Numerical result out of range
&gt; &gt; # echo 63 &gt; /sys/class/net/enp4s0f0/device/sriov_numvfs
&gt; &gt; # cat /sys/class/net/enp4s0f0/device/sriov_numvfs
&gt; &gt; 63
&gt; &gt;
&gt; &gt; The lspci command says the Total VFs supported is 64, while in the file
&gt; &gt; "sriov_totalvfs"  says it's 63.
&gt; &gt; And the sriov_numvfs file will take precedence.
&gt; &gt; Why are the numbers different?  Just a little curious.
&gt;
&gt; I believe this comes from the driver implementation:
&gt;
&gt; /*  ixgbe driver limit the max number of VFs could be enabled to
&gt;  *  63 (IXGBE_MAX_VF_FUNCTIONS - 1)
&gt;  */
&gt; #define IXGBE_MAX_VFS_DRV_LIMIT  (IXGBE_MAX_VF_FUNCTIONS - 1)
&gt;
&gt;
&gt; https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/d=
rivers/net/ethernet/intel/ixgbe/ixgbe_sriov.h#n7
&gt;
&gt; Michal
&gt;
&gt;

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;Hi Michal,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Get it, Thank you!&lt;br \
clear="all"&gt;&lt;div&gt;&lt;div dir="ltr" class="gmail_signature" \
data-smartmail="gmail_signature"&gt;&lt;div \
dir="ltr"&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div \
class="gmail_quote"&gt;&lt;div dir="ltr" class="gmail_attr"&gt;On Mon, Mar 7, 2022 at 7:36 PM \
Michal Prívozník &lt;&lt;a \
href="mailto:mprivozn@redhat.com"&gt;mprivozn@redhat.com&lt;/a&gt;&gt; \
wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0px 0px 0px \
0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"&gt;On 3/3/22 03:55, Yalan \
Zhang wrote:&lt;br&gt; &gt; Hi there,&lt;br&gt;
&gt; &lt;br&gt;
&gt; I have an Intel X520 network card, and I find the max supported VFs are&lt;br&gt;
&gt; different.&lt;br&gt;
&gt; Please check below outputs:&lt;br&gt;
&gt; &lt;br&gt;
&gt; # lspci -vvv -s 04:00.0&lt;br&gt;
&gt; 04:00.0 Ethernet controller: Intel Corporation Ethernet 10G 2P X520&lt;br&gt;
&gt; Adapter (rev 01)&lt;br&gt;
&gt; ...&lt;br&gt;
&gt;   Capabilities: [160 v1] Single Root I/O Virtualization (SR-IOV)&lt;br&gt;
&gt; IOVCap: Migration-, Interrupt Message Number: 000&lt;br&gt;
&gt; IOVCtl: Enable- Migration- Interrupt- MSE- ARIHierarchy+&lt;br&gt;
&gt; IOVSta: Migration-&lt;br&gt;
&gt; ** Initial VFs: 64, Total VFs: 64**, Number of VFs: 0, Function&lt;br&gt;
&gt; Dependency Link: 00&lt;br&gt;
&gt; VF offset: 128, stride: 2, Device ID: 10ed&lt;br&gt;
&gt; Supported Page Size: 00000553, System Page Size: 00000001&lt;br&gt;
&gt; Region 0: Memory at 0000000094400000 (64-bit, prefetchable)&lt;br&gt;
&gt; Region 3: Memory at 0000000094500000 (64-bit, prefetchable)&lt;br&gt;
&gt; VF Migration: offset: 00000000, BIR: 0&lt;br&gt;
&gt; Kernel driver in use: ixgbe&lt;br&gt;
&gt; Kernel modules: ixgbe&lt;br&gt;
&gt; &lt;br&gt;
&gt; # cat /sys/class/net/enp4s0f0/device/sriov_totalvfs&lt;br&gt;
&gt; 63&lt;br&gt;
&gt; &lt;br&gt;
&gt; # echo 64 &gt; /sys/class/net/enp4s0f0/device/sriov_numvfs&lt;br&gt;
&gt; -bash: echo: write error: Numerical result out of range&lt;br&gt;
&gt; # echo 63 &gt; /sys/class/net/enp4s0f0/device/sriov_numvfs&lt;br&gt;
&gt; # cat /sys/class/net/enp4s0f0/device/sriov_numvfs&lt;br&gt;
&gt; 63&lt;br&gt;
&gt; &lt;br&gt;
&gt; The lspci command says the Total VFs supported  is 64, while in the file&lt;br&gt;
&gt; "sriov_totalvfs"   says it's 63.&lt;br&gt;
&gt; And the  sriov_numvfs file will take  precedence.&lt;br&gt;
&gt; Why are the numbers different?   Just a little curious.&lt;br&gt;
&lt;br&gt;
I believe this comes from the driver implementation:&lt;br&gt;
&lt;br&gt;
/*   ixgbe driver limit the max number of VFs could be enabled to&lt;br&gt;
  *   63 (IXGBE_MAX_VF_FUNCTIONS - 1)&lt;br&gt;
  */&lt;br&gt;
#define IXGBE_MAX_VFS_DRV_LIMIT   (IXGBE_MAX_VF_FUNCTIONS - 1)&lt;br&gt;
&lt;br&gt;
&lt;a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/net/ethernet/intel/ixgbe/ixgbe_sriov.h#n7" \
rel="noreferrer" target="_blank"&gt;https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/net/ethernet/intel/ixgbe/ixgbe_sriov.h#n7&lt;/a&gt;&lt;br&gt;
 &lt;br&gt;
Michal&lt;br&gt;
&lt;br&gt;
&lt;/blockquote&gt;&lt;/div&gt;



</body></email><email><emailId>20220308013326</emailId><senderName>Xingbo Kan</senderName><senderEmail>xkan@redhat.com</senderEmail><timestampReceived>2022-03-08 01:33:26-0400</timestampReceived><subject>Re: About RO connection</subject><body>

Thanks, I'll check them out.

On Mon, Mar 7, 2022 at 7:31 PM Michal Pr=C3=ADvozn=C3=ADk &lt;mprivozn@redhat.=
com&gt; wrote:
&gt;
&gt; On 3/2/22 03:28, Xingbo Kan wrote:
&gt; &gt; Dear developers and users:
&gt; &gt; Is there any standard or convention of which kind of APIs&amp;flags could
&gt; &gt; be invoked by RO connection? If there is any, please tell me in
&gt; &gt; detail, thanks a lot!
&gt;
&gt; Your best bet is to look at public API implementation [1] and see if
&gt; virCheckReadOnly*() is called. But in general, anything that can't
&gt; change state of a domain/network/... is considered okay for RO
&gt; connections (e.g. listing domains, getting domain XML without security
&gt; info, etc.). For everything else you'll need RW connection.
&gt;
&gt; Alternatively, you may look at our RPC protocol description [2] and if
&gt; the API is described with "domain:read" then it's okay for RO connection.
&gt;
&gt; 1: https://gitlab.com/libvirt/libvirt/-/blob/master/src/libvirt-domain.c
&gt; 2:
&gt; https://gitlab.com/libvirt/libvirt/-/blob/master/src/remote/remote_protoc=
ol.x#L3918
&gt;
&gt; Michal
&gt;

</body></email><email><emailId>20220308082432</emailId><senderName>Peter Krempa</senderName><senderEmail>pkrempa@redhat.com</senderEmail><timestampReceived>2022-03-08 08:24:32-0400</timestampReceived><subject>Re: Resize backing store</subject><body>

On Tue, Mar 08, 2022 at 06:17:32 +0200, Jeff Brown wrote:
&gt; Apologies in advance if this be a stupid question, as everything I've read
&gt; seems to suggest it's impossible.
&gt; 
&gt; Slowly running out of space on a 200GB root partition.
&gt; 
&gt; Is it possible to create a snapshot - leaving the QCOW2 image 'quiescent' -
&gt; resize it using 'qemu-img resize' - then pivot the snapshot back? (Then
&gt; shutdown, attach the storage to another bootable OS, and run fdisk and
&gt; resize2fs.)
&gt; 
&gt; Everything I've read says to shutdown the VM; but besides the real
&gt; possibility of the snapshot blockcommit being corrupted when pivoted into
&gt; the newly resized backing store, I don't see why it shouldn't work. And save
&gt; some significant downtime.
&gt; 
&gt; Please can someone advise if this is actually possible, or if I'm wasting my
&gt; time?

We actually also have 'virsh blockresize' which allows to modify the
size of the disk while the VM is running.

There are some caveats, e.g. certain disk bus and operating system
combinations will not notice that the size increased, but in most common
cases it actually works while the VM is running. The workaround if that
happens is to just reboot the guest.

The common approach is to:

virsh blockresize $VM $DISK $NEWSIZE (look into the manual for how size is treated)

in the vm then:

1) increase the size of the partition
2) resize LVM (physical volume) if used
3) resize filesystem using resize2fs or similar

</body></email><email><emailId>20220309151750</emailId><senderName>Ferenc_Wágner</senderName><senderEmail>wferi@niif.hu</senderEmail><timestampReceived>2022-03-09 15:17:50-0400</timestampReceived><subject>Re: how to reliably shutdown domains ?</subject><body>

"Lentes, Bernd" &lt;bernd.lentes@helmholtz-muenchen.de&gt; writes:

&gt; i have a two-node cluster with around 20 domains. Cluster-Software is
&gt; pacemaker and corosync, OS is SLES 12 SP5.  The scripts for starting/
&gt; stopping the domains use virsh. Is there a way to reliably shutdown
&gt; the domains via virsh ?

I issue virsh shutdown commands periodically until the Pacemaker stop
operation timeout - 10 s, then switch over to virsh destroy.  This way
the domain is eventually stopped whether it cooperates or not.  Except
when libvirt itself is blocked, which happened with some old versions,
but fencing is a reasonable solution in such cases.
-- 
Feri

</body></email><email><emailId>20220321091504</emailId><senderName>Martin Kletzander</senderName><senderEmail>mkletzan@redhat.com</senderEmail><timestampReceived>2022-03-21 09:15:04-0400</timestampReceived><subject>Re: How to make the libvirt VM installed under the regular user boot during the system bootup?</subject><body>


On Sun, Mar 20, 2022 at 10:09:36PM +0200, Martin T wrote:
&gt;Hi.
&gt;
&gt;I installed a virtual machine under a regular user(in other words, not
&gt;under root user) with virt-install and configured this VM to boot
&gt;automatically:
&gt;
&gt;$ virsh dominfo vm
&gt;Id:             1
&gt;Name:           vm
&gt;UUID:           eef95dd6-5efe-4059-8dcc-3e35db12f55d
&gt;OS Type:        hvm
&gt;State:          running
&gt;CPU(s):         4
&gt;CPU time:       253.7s
&gt;Max memory:     4194304 KiB
&gt;Used memory:    4194304 KiB
&gt;Persistent:     yes
&gt;Autostart:      enable
&gt;Managed save:   no
&gt;Security model: none
&gt;Security DOI:   0
&gt;
&gt;$ ls -l /home/user/.config/libvirt/qemu/autostart/
&gt;total 0
&gt;lrwxrwxrwx 1 user user 47 Apr 30 16:59 vm.xml -&gt;
&gt;/home/user/.config/libvirt/qemu/vm.xml
&gt;$
&gt;

This is still using the session daemon, which only starts when you
connect to it or when you log in with the session daemon service setup
to start automatically.

There are two ways to overcome this.  One is to use the system daemon
instead (virsh -c qemu:///system) which you can also set as your default
for example by setting uri_default = "qemu:///system" in
~/.config/libvirt/libvirt.conf and there are other means as well.

If you are running a system with systemd then you can also setup
lingering for your user (loginctl enable-linger &lt;your-user&gt;) as that
would enable running the user services even without being logged in.

&gt;The vm indeed starts automatically, but only when the regular user has
&gt;logged in. I would like libvirtd(started by the systemd) to execute
&gt;this VM already during the system bootup when the regular user has not
&gt;yet logged in. How to accomplish this? I also made a symlink under
&gt;/etc/libvirt/qemu/autostart/, but this did not help.
&gt;
&gt;
&gt;thanks,
&gt;Martin
&gt;

["signature.asc" (application/pgp-signature)]

</body></email><email><emailId>20220329065428</emailId><senderName>Michal Prívozník</senderName><senderEmail>mprivozn@redhat.com</senderEmail><timestampReceived>2022-03-29 06:54:28-0400</timestampReceived><subject>Re: PHP Warning: libvirt_domain_new(): Cannot get installation XML</subject><body>

On 3/24/22 21:48, Benjamin Smith wrote:
&gt; Despite great success at using php-libvirt with other functions, I have
&gt; been entirely unsuccessful in getting it to create a new domain/machine.
&gt; Any time I do, and with virtually anything I try, I get the above error
&gt; message. 
&gt; 
&gt; Running PHP 7.4 (remi) on otherwise stock AlmaLinux.
&gt; *[root@sb4 html]# cat /etc/redhat-release
&gt; AlmaLinux release 8.5 (Arctic Sphynx
&gt; *
&gt; 
&gt; *[root@sb4 html]# rpm -qa php php-fpm php-libvirt nginx
&gt; php-7.4.28-1.el8.remi.x86_64
&gt; nginx-1.14.1-9.module_el8.3.0+2165+af250afe.alma.x86_64
&gt; php-fpm-7.4.28-1.el8.remi.x86_64
&gt; php-libvirt-0.5.5-1.el8.remi.7.4.x86_64
&gt; 12 XEON E312xx cores, 24 w/HT, 192GB RAM, etc. *
&gt; 

Hey,

so libvirt-php is not really that well maintained. The original author
moved to different project and I used to do at least very basic
maintenance but also got side tracked too often.

Looking into the code, which lives at:

  https://gitlab.com/libvirt/libvirt-php

it's the installation_get_xml() function that's failing:


https://gitlab.com/libvirt/libvirt-php/-/blob/master/src/libvirt-php.c#L2353

and honestly, I don't have any clue why. Do you think you could attach a
debugger and step through the function to find out which line is failing?

Michal

</body></email><email><emailId>20220329065703</emailId><senderName>Michal Prívozník</senderName><senderEmail>mprivozn@redhat.com</senderEmail><timestampReceived>2022-03-29 06:57:03-0400</timestampReceived><subject>Re: virDomainCoreDump output format</subject><body>

On 3/23/22 14:19, Shelly Kagan wrote:
&gt; Hi all,
&gt; I have a small question regarding virDomainCoreDump.
&gt; In the documentation[1] it is stated that the output is of format RAW.
&gt; After implementing a function using this command the output file
&gt; format that I see is ELF. I understand those formats are different, so
&gt; is the documentation not updated? Is there a reason I will get an ELF
&gt; format instead of RAW?
&gt; Appreciate your help!


Hey,

I believe that what you see is expected. If you'd dump memory of any
process you'll get ELF. QEMU is no exception as guest memory is in fact
QEMU's memory too. RAW is abstraction because other hypervisors (that
are not ELF based) can provide different formats.

Michal

</body></email><email><emailId>20220329192534</emailId><senderName>Nir Soffer</senderName><senderEmail>nsoffer@redhat.com</senderEmail><timestampReceived>2022-03-29 19:25:34-0400</timestampReceived><subject>Re: "default" watchdog device - ?</subject><body>

On Wed, Mar 16, 2022 at 1:55 PM lejeczek &lt;peljasz@yahoo.co.uk&gt; wrote:
&gt;
&gt;
&gt;
&gt; On 15/03/2022 11:21, Daniel P. Berrang=C3=A9 wrote:
&gt; &gt; On Tue, Mar 15, 2022 at 10:39:50AM +0000, lejeczek wrote:
&gt; &gt;&gt; Hi guys.
&gt; &gt;&gt;
&gt; &gt;&gt; Without explicitly, manually using watchdog device for a VM, the VM (c=
entOS
&gt; &gt;&gt; 8 Stream 4.18.0-365.el8.x86_64) shows '/dev/watchdog' exists.
&gt; &gt;&gt; To double check - 'dumpxml' does not show any such device - what kind =
of a
&gt; &gt;&gt; 'watchdog' that is?
&gt; &gt; The kernel can always provide a pure software watchdog IIRC. It can be
&gt; &gt; useful if a userspace app wants a watchdog. The limitation is that it
&gt; &gt; relies on the kernel remaining functional, as there's no hardware
&gt; &gt; backing it up.
&gt; &gt;
&gt; &gt; Regards,
&gt; &gt; Daniel
&gt; On a related note - with 'i6300esb' watchdog which I tested
&gt; and I believe is working.
&gt; I get often in my VMs from 'dmesg':
&gt; ...
&gt; watchdog: BUG: soft lockup - CPU#0 stuck for xxxs! [swapper/0:0]
&gt; rcu: INFO: rcu_sched self-detected stall on CPU
&gt; ...
&gt; This above is from Ubuntu and CentOS alike and when this
&gt; happens, console via VNC responds to until first 'enter'
&gt; then is non-resposive.
&gt; This happens after VM(s) was migrated between hosts, but
&gt; anyway..
&gt; I do not see what I expected from 'watchdog' - there is no
&gt; action whatsoever, which should be 'reset'. VM remains in
&gt; such 'frozen' state forever.
&gt;
&gt; any &amp; all shared thoughts much appreciated.
&gt; L.

You need to run some userspace tool that will open the watchdog
device, and pet it periodically, telling the kernel that userspace is alive=
.

If this tool will stop petting the watchdog, maybe because of a soft lockup
or other trouble, the watchdog device will reset the VM.

watchdog(8) may be the tool you need.

See also
https://www.kernel.org/doc/Documentation/watchdog/watchdog-api.rst

Nir

</body></email><email><emailId>20220330011150</emailId><senderName>"Tobias Hofmann (tohofman)"</senderName><senderEmail>tohofman@cisco.com</senderEmail><timestampReceived>2022-03-30 01:11:50-0400</timestampReceived><subject>Debugging hanging libvirt</subject><body>

[Attachment #2 (multipart/alternative)]


Hello all,

I have a system with one VM running. After some time the VM needs to be tem=
porarily stopped and started again. This start operation fails and from tha=
t point on any virsh command is hanging and does not execute.
This issue is reproducible and I have already figured out that restarting l=
ibvirtd resolves this issue. However, I=92m now trying to understand why it=
=92s getting stuck in the first place.

I try not to get too much into detail because I think this would be more co=
nfusing than it would actually help to understand the problem. In general, =
I=92m wondering what approach you should follow to debug why libvirt gets s=
tuck.
Online I=92ve read that you should run this command: `# gdb -batch -p $(pid=
of libvirtd) -ex 't a a bt f'`. I=92ve run that command and attached the ou=
tput to this mail. However, I have to admit that I have no idea what to do =
with it.

System related info:

  *   OS: CentOS 7.8.2003
  *   libvirt version: 4.5.0-33

Appreciate any help here!

Thank you!
Tobias


[Attachment #5 (text/html)]

&lt;html xmlns:o="urn:schemas-microsoft-com:office:office" \
xmlns:w="urn:schemas-microsoft-com:office:word" \
xmlns:m="http://schemas.microsoft.com/office/2004/12/omml" \
xmlns="http://www.w3.org/TR/REC-html40"&gt; &lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=Windows-1252"&gt;
&lt;meta name="Generator" content="Microsoft Word 15 (filtered medium)"&gt;
&lt;style&gt;&lt;!--
/* Font Definitions */
@font-face
	{font-family:Wingdings;
	panose-1:5 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
@font-face
	{font-family:Consolas;
	panose-1:2 11 6 9 2 2 4 3 2 4;}
/* Style Definitions */
p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin:0cm;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;
	mso-fareast-language:EN-US;}
p.MsoListParagraph, li.MsoListParagraph, div.MsoListParagraph
	{mso-style-priority:34;
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:36.0pt;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;
	mso-fareast-language:EN-US;}
.MsoChpDefault
	{mso-style-type:export-only;
	font-size:10.0pt;
	mso-fareast-language:EN-US;}
@page WordSection1
	{size:612.0pt 792.0pt;
	margin:72.0pt 72.0pt 72.0pt 72.0pt;}
div.WordSection1
	{page:WordSection1;}
/* List Definitions */
@list l0
	{mso-list-id:423186364;
	mso-list-type:hybrid;
	mso-list-template-ids:-10733038 1383758744 134807555 134807557 134807553 134807555 \
134807557 134807553 134807555 134807557;} @list l0:level1
	{mso-level-start-at:0;
	mso-level-number-format:bullet;
	mso-level-text:\F0B7 ;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	text-indent:-18.0pt;
	font-family:Symbol;
	mso-fareast-font-family:Calibri;
	mso-bidi-font-family:"Times New Roman";}
@list l0:level2
	{mso-level-number-format:bullet;
	mso-level-text:o;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	text-indent:-18.0pt;
	font-family:"Courier New";}
@list l0:level3
	{mso-level-number-format:bullet;
	mso-level-text:\F0A7 ;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	text-indent:-18.0pt;
	font-family:Wingdings;}
@list l0:level4
	{mso-level-number-format:bullet;
	mso-level-text:\F0B7 ;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	text-indent:-18.0pt;
	font-family:Symbol;}
@list l0:level5
	{mso-level-number-format:bullet;
	mso-level-text:o;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	text-indent:-18.0pt;
	font-family:"Courier New";}
@list l0:level6
	{mso-level-number-format:bullet;
	mso-level-text:\F0A7 ;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	text-indent:-18.0pt;
	font-family:Wingdings;}
@list l0:level7
	{mso-level-number-format:bullet;
	mso-level-text:\F0B7 ;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	text-indent:-18.0pt;
	font-family:Symbol;}
@list l0:level8
	{mso-level-number-format:bullet;
	mso-level-text:o;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	text-indent:-18.0pt;
	font-family:"Courier New";}
@list l0:level9
	{mso-level-number-format:bullet;
	mso-level-text:\F0A7 ;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	text-indent:-18.0pt;
	font-family:Wingdings;}
@list l1
	{mso-list-id:994336111;
	mso-list-template-ids:1920522770;}
@list l1:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F0B7 ;
	mso-level-tab-stop:36.0pt;
	mso-level-number-position:left;
	text-indent:-18.0pt;
	mso-ansi-font-size:10.0pt;
	font-family:Symbol;}
@list l1:level2
	{mso-level-start-at:0;
	mso-level-number-format:bullet;
	mso-level-text:\F0B7 ;
	mso-level-tab-stop:72.0pt;
	mso-level-number-position:left;
	text-indent:-18.0pt;
	mso-ansi-font-size:10.0pt;
	font-family:Symbol;}
@list l1:level3
	{mso-level-start-at:0;
	mso-level-number-format:bullet;
	mso-level-text:\F0B7 ;
	mso-level-tab-stop:108.0pt;
	mso-level-number-position:left;
	text-indent:-18.0pt;
	mso-ansi-font-size:10.0pt;
	font-family:Symbol;}
@list l1:level4
	{mso-level-start-at:0;
	mso-level-number-format:bullet;
	mso-level-text:\F0B7 ;
	mso-level-tab-stop:144.0pt;
	mso-level-number-position:left;
	text-indent:-18.0pt;
	mso-ansi-font-size:10.0pt;
	font-family:Symbol;}
@list l1:level5
	{mso-level-start-at:0;
	mso-level-number-format:bullet;
	mso-level-text:\F0B7 ;
	mso-level-tab-stop:180.0pt;
	mso-level-number-position:left;
	text-indent:-18.0pt;
	mso-ansi-font-size:10.0pt;
	font-family:Symbol;}
@list l1:level6
	{mso-level-start-at:0;
	mso-level-number-format:bullet;
	mso-level-text:\F0B7 ;
	mso-level-tab-stop:216.0pt;
	mso-level-number-position:left;
	text-indent:-18.0pt;
	mso-ansi-font-size:10.0pt;
	font-family:Symbol;}
@list l1:level7
	{mso-level-start-at:0;
	mso-level-number-format:bullet;
	mso-level-text:\F0B7 ;
	mso-level-tab-stop:252.0pt;
	mso-level-number-position:left;
	text-indent:-18.0pt;
	mso-ansi-font-size:10.0pt;
	font-family:Symbol;}
@list l1:level8
	{mso-level-start-at:0;
	mso-level-number-format:bullet;
	mso-level-text:\F0B7 ;
	mso-level-tab-stop:288.0pt;
	mso-level-number-position:left;
	text-indent:-18.0pt;
	mso-ansi-font-size:10.0pt;
	font-family:Symbol;}
@list l1:level9
	{mso-level-start-at:0;
	mso-level-number-format:bullet;
	mso-level-text:\F0B7 ;
	mso-level-tab-stop:324.0pt;
	mso-level-number-position:left;
	text-indent:-18.0pt;
	mso-ansi-font-size:10.0pt;
	font-family:Symbol;}
ol
	{margin-bottom:0cm;}
ul
	{margin-bottom:0cm;}
--&gt;&lt;/style&gt;
&lt;/head&gt;
&lt;body lang="en-DE" link="#0563C1" vlink="#954F72" style="word-wrap:break-word"&gt;
&lt;div class="WordSection1"&gt;
&lt;p class="MsoNormal"&gt;&lt;span lang="EN-US"&gt;Hello all,&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;&lt;span lang="EN-US"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;&lt;span lang="EN-US"&gt;I have a system with one VM running. After \
some time the VM needs to be temporarily stopped and started again. This start \
operation fails and from that point on any virsh command is hanging and does not \
execute.&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;span lang="EN-US"&gt;This issue is \
reproducible and I have already figured out that restarting libvirtd resolves this \
issue. However, I’m now trying to understand why it’s getting stuck in the first \
place.&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;span \
lang="EN-US"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;span lang="EN-US"&gt;I \
try not to get too much into detail because I think this would be more confusing than \
it would actually help to understand the problem. In general, I’m wondering what \
approach you should follow to debug why libvirt  gets stuck.&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;&lt;span lang="EN-US"&gt;Online I’ve read that you should run this \
command: `&lt;/span&gt;# gdb -batch -p $(pidof libvirtd) -ex 't a a bt f'&lt;span \
lang="EN-US"&gt;`. I’ve run that command and attached the output to this mail. However, \
I have to admit that  I have no idea what to do with it.&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;&lt;span lang="EN-US"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;&lt;span lang="EN-US"&gt;System related info:&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;
&lt;ul style="margin-top:0cm" type="disc"&gt;
&lt;li class="MsoListParagraph" style="margin-left:0cm;mso-list:l0 level1 lfo3"&gt;&lt;span \
lang="EN-US"&gt;OS: CentOS 7.8.2003&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/li&gt;&lt;li class="MsoListParagraph" \
style="margin-left:0cm;mso-list:l0 level1 lfo3"&gt;&lt;span lang="EN-US"&gt;libvirt version: \
4.5.0-33&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt; &lt;p class="MsoNormal"&gt;&lt;span \
lang="EN-US"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;span \
lang="EN-US"&gt;Appreciate any help here!&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;span lang="EN-US"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;span lang="EN-US"&gt;Thank you!&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;span lang="EN-US"&gt;Tobias&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt; &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;


["gdb_libvirtd.log" (application/octet-stream)]

</body></email><email><emailId>20220330152536</emailId><senderName>Andrew Martin</senderName><senderEmail>amartin@xes-inc.com</senderEmail><timestampReceived>2022-03-30 15:25:36-0400</timestampReceived><subject>Requirements to enable discard support on virtio-blk</subject><body>

Hello,

I am attempting to enable discard support on the virtio-blk device on a QEMU VM
however it isn't working. My understanding is that this is enabled in QEMU &gt;=
4.0, so I am not sure why this isn't working:

Host OS: Ubuntu 20.04 (kernel 5.4.0)
Guest OS: Ubuntu 18.04 (kernel 4.15.0)

Guest config:
&lt;os&gt;
  &lt;type arch='x86_64' machine='pc-q35-4.2'&gt;hvm&lt;/type&gt;
&lt;/os&gt;
&lt;disk type='file' device='disk'&gt;
  &lt;driver name='qemu' type='qcow2' discard='unmap'/&gt;
  &lt;source file='/var/lib/libvirt/images/myvm.qcow2' index='1'/&gt;
  &lt;backingStore/&gt;
  &lt;target dev='vda' bus='virtio'/&gt;
  &lt;alias name='virtio-disk0'/&gt;
  &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x08' function='0x0'/&gt;
&lt;/disk&gt;

What are the values for machine type that will support discard on virtio-blk?
Anything 4.0 or greater (e.g. would pc-i440fx-4.0 work too)?

I can see from the host's perspective that the guest appears to have discard
enabled because the following command shows "discard = true":
# virsh qemu-monitor-command myvm --hmp info qtree | grep discard

yet inside the VM, even with the "discard" mount option set:
 # for f in /sys/block/vda/queue/discard_*; do echo $f; cat $f; done
/sys/block/vda/queue/discard_granularity
0
/sys/block/vda/queue/discard_max_bytes
0
/sys/block/vda/queue/discard_max_hw_bytes
0
/sys/block/vda/queue/discard_zeroes_data
0

Are the virtio drivers in the guest kernel too old to support discard on
virtio-blk? Or is something else missing?

Thanks,

Andrew

[Attachment #3 (text/html)]

&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"&gt;
&lt;style type="text/css" style="display:none;"&gt; P {margin-top:0;margin-bottom:0;} \
&lt;/style&gt; &lt;/head&gt;
&lt;body dir="ltr"&gt;
&lt;div style="font-family: Calibri, Arial, Helvetica, sans-serif; font-size: 12pt; \
color: rgb(0, 0, 0); background-color: rgb(255, 255, 255);"&gt; Hello,
&lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;I am attempting to enable discard support on the virtio-blk device on a QEMU \
VM&lt;/div&gt; &lt;div&gt;however it isn't working. My understanding is that this is enabled in \
QEMU &gt;=&lt;/div&gt; &lt;div&gt;4.0, so I am not sure why this isn't working:&lt;/div&gt;
&lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;Host OS: Ubuntu 20.04 (kernel 5.4.0)&lt;/div&gt;
&lt;div&gt;Guest OS: Ubuntu 18.04 (kernel 4.15.0)&lt;/div&gt;
&lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;Guest config:&lt;/div&gt;
&lt;div&gt;&lt;os&gt;&lt;/div&gt;
&lt;div&gt;  &lt;type arch='x86_64' machine='pc-q35-4.2'&gt;hvm&lt;/type&gt;&lt;/div&gt;
&lt;div&gt;&lt;/os&gt;&lt;/div&gt;
&lt;div&gt;&lt;disk type='file' device='disk'&gt;&lt;/div&gt;
&lt;div&gt;  &lt;driver name='qemu' type='qcow2' discard='unmap'/&gt;&lt;/div&gt;
&lt;div&gt;  &lt;source file='/var/lib/libvirt/images/myvm.qcow2' index='1'/&gt;&lt;/div&gt;
&lt;div&gt;  &lt;backingStore/&gt;&lt;/div&gt;
&lt;div&gt;  &lt;target dev='vda' bus='virtio'/&gt;&lt;/div&gt;
&lt;div&gt;  &lt;alias name='virtio-disk0'/&gt;&lt;/div&gt;
&lt;div&gt;  &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x08' \
function='0x0'/&gt;&lt;/div&gt; &lt;div&gt;&lt;/disk&gt;&lt;/div&gt;
&lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;What are the values for machine type that will support discard on \
virtio-blk?&lt;/div&gt; &lt;div&gt;Anything 4.0 or greater (e.g. would pc-i440fx-4.0 work \
too)?&lt;/div&gt; &lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;I can see from the host's perspective that the guest appears to have \
discard&lt;/div&gt; &lt;div&gt;enabled because the following command shows "discard = \
true":&lt;/div&gt; &lt;div&gt;# virsh qemu-monitor-command myvm --hmp info qtree | grep \
discard&lt;/div&gt; &lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;yet inside the VM, even with the "discard" mount option set:&lt;/div&gt;
&lt;div&gt; # for f in /sys/block/vda/queue/discard_*; do echo $f; cat $f; done&lt;/div&gt;
&lt;div&gt;/sys/block/vda/queue/discard_granularity&lt;/div&gt;
&lt;div&gt;0&lt;/div&gt;
&lt;div&gt;/sys/block/vda/queue/discard_max_bytes&lt;/div&gt;
&lt;div&gt;0&lt;/div&gt;
&lt;div&gt;/sys/block/vda/queue/discard_max_hw_bytes&lt;/div&gt;
&lt;div&gt;0&lt;/div&gt;
&lt;div&gt;/sys/block/vda/queue/discard_zeroes_data&lt;/div&gt;
&lt;div&gt;0&lt;/div&gt;
&lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;Are the virtio drivers in the guest kernel too old to support discard on&lt;/div&gt;
&lt;div&gt;virtio-blk? Or is something else missing?&lt;/div&gt;
&lt;div&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;Thanks,&lt;/div&gt;
&lt;div&gt;&lt;br&gt;
&lt;/div&gt;
Andrew&lt;br&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;



</body></email><email><emailId>20220331161343</emailId><senderName>Carl_Winbäck</senderName><senderEmail>c@tunnel53.net</senderEmail><timestampReceived>2022-03-31 16:13:43-0400</timestampReceived><subject>Networking on macOS host, without TunTap</subject><body>

Dear libvirt users,

I'm trying to get the following setup up and running:

libvirt+qemu on a macOS Monterey host, with a Debian 11 guest. The domain
type
is hvf.

The thing I'm struggling with now is how to configure networking in a sane
way. Older articles reference the "TunTap" project, but AFAICT this
software it
is no longer recommended.

Does anyone know of a good way to add networking to this setup without using
TunTap?


Best regards,
Carl Winbäck

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;Dear libvirt users,&lt;br&gt;&lt;br&gt;I'm trying to get the following setup up \
and running:&lt;br&gt;&lt;br&gt;libvirt+qemu on a macOS Monterey host, with a Debian 11 guest. \
The domain type&lt;br&gt;is hvf.&lt;br&gt;&lt;br&gt;The thing I'm struggling with now is how to \
configure networking in a sane&lt;br&gt;way. Older articles reference the "TunTap" project, \
but AFAICT this software it&lt;br&gt;is no longer recommended.&lt;br&gt;&lt;br&gt;Does anyone know of a \
good way to add networking to this setup without using&lt;br&gt;TunTap?&lt;br&gt;&lt;br&gt;&lt;br&gt;Best \
regards,&lt;br&gt;Carl Winbäck&lt;br&gt;&lt;/div&gt;



</body></email><email><emailId>20220303025541</emailId><senderName>Yalan Zhang</senderName><senderEmail>yalzhang@redhat.com</senderEmail><timestampReceived>2022-03-03 02:55:41-0400</timestampReceived><subject>Number of the max supported VFs are different</subject><body>

Hi there,

I have an Intel X520 network card, and I find the max supported VFs are
different.
Please check below outputs:

# lspci -vvv -s 04:00.0
04:00.0 Ethernet controller: Intel Corporation Ethernet 10G 2P X520 Adapter
(rev 01)
...
 Capabilities: [160 v1] Single Root I/O Virtualization (SR-IOV)
IOVCap: Migration-, Interrupt Message Number: 000
IOVCtl: Enable- Migration- Interrupt- MSE- ARIHierarchy+
IOVSta: Migration-
** Initial VFs: 64, Total VFs: 64**, Number of VFs: 0, Function Dependency
Link: 00
VF offset: 128, stride: 2, Device ID: 10ed
Supported Page Size: 00000553, System Page Size: 00000001
Region 0: Memory at 0000000094400000 (64-bit, prefetchable)
Region 3: Memory at 0000000094500000 (64-bit, prefetchable)
VF Migration: offset: 00000000, BIR: 0
Kernel driver in use: ixgbe
Kernel modules: ixgbe

# cat /sys/class/net/enp4s0f0/device/sriov_totalvfs
63

# echo 64 &gt; /sys/class/net/enp4s0f0/device/sriov_numvfs
-bash: echo: write error: Numerical result out of range
# echo 63 &gt; /sys/class/net/enp4s0f0/device/sriov_numvfs
# cat /sys/class/net/enp4s0f0/device/sriov_numvfs
63

The lspci command says the Total VFs supported is 64, while in the file
"sriov_totalvfs"  says it's 63.
And the sriov_numvfs file will take precedence.
Why are the numbers different?  Just a little curious.
Thank you!

-------
Best Regards,
Yalan Zhang
IRC: yalzhang

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;Hi there,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I have an Intel X520 network card, and I \
find the max supported VFs are different.&lt;/div&gt;&lt;div&gt;Please check below outputs:&lt;br \
clear="all"&gt;&lt;div&gt;&lt;div dir="ltr" class="gmail_signature" \
data-smartmail="gmail_signature"&gt;&lt;div dir="ltr"&gt;&lt;div&gt;&lt;br&gt;# lspci -vvv -s \
04:00.0&lt;br&gt;04:00.0 Ethernet controller: Intel Corporation Ethernet 10G 2P X520 \
Adapter (rev 01)&lt;br&gt;...&lt;/div&gt;&lt;div&gt;  Capabilities: [160 v1] Single Root I/O \
Virtualization (SR-IOV)&lt;br&gt;		IOVCap:	Migration-, Interrupt Message Number: \
000&lt;br&gt;		IOVCtl:	Enable- Migration- Interrupt- MSE- \
ARIHierarchy+&lt;br&gt;		IOVSta:	Migration-&lt;br&gt;** Initial VFs: 64, Total VFs: 64**, Number \
of VFs: 0, Function Dependency Link: 00&lt;br&gt;		VF offset: 128, stride: 2, Device ID: \
10ed&lt;br&gt;		Supported Page Size: 00000553, System Page Size: 00000001&lt;br&gt;		Region 0: \
Memory at 0000000094400000 (64-bit, prefetchable)&lt;br&gt;		Region 3: Memory at \
0000000094500000 (64-bit, prefetchable)&lt;br&gt;		VF Migration: offset: 00000000, BIR: \
0&lt;br&gt;	Kernel driver in use: ixgbe&lt;br&gt;	Kernel modules: \
ixgbe&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;# cat \
/sys/class/net/enp4s0f0/device/sriov_totalvfs&lt;br&gt;63&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;# \
echo 64 &gt; /sys/class/net/enp4s0f0/device/sriov_numvfs&lt;br&gt;-bash: echo: write error: \
Numerical result out of range&lt;br&gt;# echo 63 &gt; \
/sys/class/net/enp4s0f0/device/sriov_numvfs&lt;br&gt;# cat \
/sys/class/net/enp4s0f0/device/sriov_numvfs&lt;br&gt;63&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The lspci \
command says the Total VFs supported  is 64, while in the file \
"sriov_totalvfs"   says it's 63.&lt;br&gt;And the  sriov_numvfs file will \
take  precedence.&lt;/div&gt;&lt;div&gt;Why are the numbers different?   Just a little \
curious.&lt;/div&gt;&lt;div&gt;Thank you!&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;-------&lt;br&gt;Best \
Regards,&lt;br&gt;Yalan Zhang&lt;br&gt;IRC: yalzhang&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220307113648</emailId><senderName>Michal Prívozník</senderName><senderEmail>mprivozn@redhat.com</senderEmail><timestampReceived>2022-03-07 11:36:48-0400</timestampReceived><subject>Re: Number of the max supported VFs are different</subject><body>

On 3/3/22 03:55, Yalan Zhang wrote:
&gt; Hi there,
&gt; 
&gt; I have an Intel X520 network card, and I find the max supported VFs are
&gt; different.
&gt; Please check below outputs:
&gt; 
&gt; # lspci -vvv -s 04:00.0
&gt; 04:00.0 Ethernet controller: Intel Corporation Ethernet 10G 2P X520
&gt; Adapter (rev 01)
&gt; ...
&gt; Capabilities: [160 v1] Single Root I/O Virtualization (SR-IOV)
&gt; IOVCap: Migration-, Interrupt Message Number: 000
&gt; IOVCtl: Enable- Migration- Interrupt- MSE- ARIHierarchy+
&gt; IOVSta: Migration-
&gt; ** Initial VFs: 64, Total VFs: 64**, Number of VFs: 0, Function
&gt; Dependency Link: 00
&gt; VF offset: 128, stride: 2, Device ID: 10ed
&gt; Supported Page Size: 00000553, System Page Size: 00000001
&gt; Region 0: Memory at 0000000094400000 (64-bit, prefetchable)
&gt; Region 3: Memory at 0000000094500000 (64-bit, prefetchable)
&gt; VF Migration: offset: 00000000, BIR: 0
&gt; Kernel driver in use: ixgbe
&gt; Kernel modules: ixgbe
&gt; 
&gt; # cat /sys/class/net/enp4s0f0/device/sriov_totalvfs
&gt; 63
&gt; 
&gt; # echo 64 &gt; /sys/class/net/enp4s0f0/device/sriov_numvfs
&gt; -bash: echo: write error: Numerical result out of range
&gt; # echo 63 &gt; /sys/class/net/enp4s0f0/device/sriov_numvfs
&gt; # cat /sys/class/net/enp4s0f0/device/sriov_numvfs
&gt; 63
&gt; 
&gt; The lspci command says the Total VFs supported is 64, while in the file
&gt; "sriov_totalvfs"  says it's 63.
&gt; And the sriov_numvfs file will take precedence.
&gt; Why are the numbers different?  Just a little curious.

I believe this comes from the driver implementation:

/*  ixgbe driver limit the max number of VFs could be enabled to
 *  63 (IXGBE_MAX_VF_FUNCTIONS - 1)
 */
#define IXGBE_MAX_VFS_DRV_LIMIT  (IXGBE_MAX_VF_FUNCTIONS - 1)

https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/net/ethernet/intel/ixgbe/ixgbe_sriov.h#n7


Michal


</body></email><email><emailId>20220302022848</emailId><senderName>Xingbo Kan</senderName><senderEmail>xkan@redhat.com</senderEmail><timestampReceived>2022-03-02 02:28:48-0400</timestampReceived><subject>About RO connection</subject><body>

Dear developers and users:
Is there any standard or convention of which kind of APIs&amp;flags could
be invoked by RO connection? If there is any, please tell me in
detail, thanks a lot!
Kind regards,
xkan

</body></email><email><emailId>20220308041732</emailId><senderName>Jeff Brown</senderName><senderEmail>jeff@ff.co.za</senderEmail><timestampReceived>2022-03-08 04:17:32-0400</timestampReceived><subject>Resize backing store</subject><body>

Apologies in advance if this be a stupid question, as everything I've 
read seems to suggest it's impossible.

Slowly running out of space on a 200GB root partition.

Is it possible to create a snapshot - leaving the QCOW2 image 
'quiescent' - resize it using 'qemu-img resize' - then pivot the 
snapshot back? (Then shutdown, attach the storage to another bootable 
OS, and run fdisk and resize2fs.)

Everything I've read says to shutdown the VM; but besides the real 
possibility of the snapshot blockcommit being corrupted when pivoted 
into the newly resized backing store, I don't see why it shouldn't work. 
And save some significant downtime.

Please can someone advise if this is actually possible, or if I'm 
wasting my time?

Thanks!

-- 
Jeff Brown
Future Foundation
Cell 074 101 5170
VoIP 087 550 1210
Fax: 086 532 3508

</body></email><email><emailId>20220308192540</emailId><senderName>"Lentes, Bernd"</senderName><senderEmail>bernd.lentes@helmholtz-muenchen.de</senderEmail><timestampReceived>2022-03-08 19:25:40-0400</timestampReceived><subject>how to reliably shutdown domains ?</subject><body>


Hey guys,

i have a two-node cluster with around 20 domains. Cluster-Software is pacemaker and \
corosync, OS is SLES 12 SP5. The scripts for starting/stopping the domains use virsh. \
Is there a way to reliably shutdown the domains via virsh ? I'm testing around, but \
sometimes the domains stop, sometimes they don't, sometimes it takes very long so \
that the cluster times out and fence the respective node.
I'm using "virsh shutdown domain --mode acpi,agent" for the windows domains (not \
reliable) and for the linux domains "virsh shutdown domain", also not reliable.

What can i do ?

Bernd

-- 

Bernd Lentes 
System Administrator 
Institute for Metabolism and Cell Death (MCD) 
Building 25 - office 122 
HelmholtzZentrum München 
bernd.lentes@helmholtz-muenchen.de 
phone: +49 89 3187 1241 
fax: +49 89 3187 2294 
http://www.helmholtz-muenchen.de/mcd 


Public key: 

30 82 01 0a 02 82 01 01 00 b3 72 3e ce 2c 0a 6f 58 49 2c 92 23 c7 b9 c1 ff 6c 3a 53 \
be f7 9e e9 24 b7 49 fa 3c e8 de 28 85 2c d3 ed f7 70 03 3f 4d 82 fc cc 96 4f 18 27 \
1f df 25 b3 13 00 db 4b 1d ec 7f 1b cf f9 cd e8 5b 1f 11 b3 a7 48 f8 c8 37 ed 41 ff \
18 9f d7 83 51 a9 bd 86 c2 32 b3 d6 2d 77 ff 32 83 92 67 9e ae ae 9c 99 ce 42 27 6f \
bf d8 c2 a1 54 fd 2b 6b 12 65 0e 8a 79 56 be 53 89 70 51 02 6a eb 76 b8 92 25 2d 88 \
aa 57 08 42 ef 57 fb fe 00 71 8e 90 ef b2 e3 22 f3 34 4f 7b f1 c4 b1 7c 2f 1d 6f bd \
c8 a6 a1 1f 25 f3 e4 4b 6a 23 d3 d2 fa 27 ae 97 80 a3 f0 5a c4 50 4a 45 e3 45 4d 82 \
9f 8b 87 90 d0 f9 92 2d a7 d2 67 53 e6 ae 1e 72 3e e9 e0 c9 d3 1c 23 e0 75 78 4a 45 \
60 94 f8 e3 03 0b 09 85 08 d0 6c f3 ff ce fa 50 25 d9 da 81 7b 2a dc 9e 28 8b 83 04 \
b4 0a 9f 37 b8 ac 58 f1 38 43 0e 72 af 02 03 01 00 01


["smime.p7s" (application/pkcs7-signature)]

</body></email><email><emailId>20220320200936</emailId><senderName>Martin T</senderName><senderEmail>m4rtntns@gmail.com</senderEmail><timestampReceived>2022-03-20 20:09:36-0400</timestampReceived><subject>How to make the libvirt VM installed under the regular user boot during the system bootup?</subject><body>

Hi.

I installed a virtual machine under a regular user(in other words, not
under root user) with virt-install and configured this VM to boot
automatically:

$ virsh dominfo vm
Id:             1
Name:           vm
UUID:           eef95dd6-5efe-4059-8dcc-3e35db12f55d
OS Type:        hvm
State:          running
CPU(s):         4
CPU time:       253.7s
Max memory:     4194304 KiB
Used memory:    4194304 KiB
Persistent:     yes
Autostart:      enable
Managed save:   no
Security model: none
Security DOI:   0

$ ls -l /home/user/.config/libvirt/qemu/autostart/
total 0
lrwxrwxrwx 1 user user 47 Apr 30 16:59 vm.xml -&gt;
/home/user/.config/libvirt/qemu/vm.xml
$

The vm indeed starts automatically, but only when the regular user has
logged in. I would like libvirtd(started by the systemd) to execute
this VM already during the system bootup when the regular user has not
yet logged in. How to accomplish this? I also made a symlink under
/etc/libvirt/qemu/autostart/, but this did not help.


thanks,
Martin

</body></email><email><emailId>20220324204843</emailId><senderName>Benjamin Smith</senderName><senderEmail>yesthatguy@gmail.com</senderEmail><timestampReceived>2022-03-24 20:48:43-0400</timestampReceived><subject>PHP Warning: libvirt_domain_new(): Cannot get installation XML</subject><body>

Despite great success at using php-libvirt with other functions, I have
been entirely unsuccessful in getting it to create a new domain/machine.
Any time I do, and with virtually anything I try, I get the above error
message.

Running PHP 7.4 (remi) on otherwise stock AlmaLinux.


*[root@sb4 html]# cat /etc/redhat-release AlmaLinux release 8.5 (Arctic
Sphynx*






*[root@sb4 html]# rpm -qa php php-fpm php-libvirt
nginxphp-7.4.28-1.el8.remi.x86_64nginx-1.14.1-9.module_el8.3.0+2165+af250afe.alma.x86_64php-fpm-7.4.28-1.el8.remi.x86_64php-libvirt-0.5.5-1.el8.remi.7.4.x86_6412
 XEON E312xx cores, 24 w/HT, 192GB RAM, etc. *

When I run it, I find in php-fpm www.error-log:

*[24-Mar-2022 20:05:51 UTC] PHP Warning:  libvirt_domain_new(): Cannot get
installation XML in /var/www/html/manage.php on line 190*

Matching message onscreen: *Warning: libvirt_domain_new(): Cannot get
installation XML in /var/www/html/manage.php on line 191*

Here's the offending code:

$networks = [

    *'mac'* =&gt; '52:54:00:06:a7:df',

    *'network'* =&gt; 'default',

    *'model'* =&gt;  *'e1000'*,

    ];

$disks = [

    *'path'* =&gt; *"/var/lib/libvirt/images/myvm.qcow2"*,

    *'driver'* =&gt; *'qcow2'*,

    *'bus'* =&gt; *'ide'*,

    *'dev'* =&gt; *'hda'*,

    *'size'* =&gt; *'40G'*,

    *'flags'* =&gt; null,

    ];

  error_reporting(-1);

$result = libvirt_domain_new(

    $conn,

    'myvm',* // name of the new domain*

    null,* // optional architecture string, can be NULL to get default (or
false)*

    2048,* // number of megabytes of RAM to be allocated for domain*

    8192,* // maximum number of megabytes of RAM to be allocated for domain*

    2,* // number of VCPUs to be allocated to domain*

    *'/var/www/html/AlmaLinux-8.4-x86_64-dvd.iso'*,* // installation ISO
image for*$

    $disks,* // array of disk devices for domain*

    $networks,

    null

    );

I've tried various values for $disks and $networks, setting error reporting
to -1 (display anything and everything), journalctl -f on both the
webserver and the virt host, etc but was never able to see any error other
than this one.


I've also been looking in the source code file for anything obvious, and
I've been utterly unsuccessful in changing the error message. For example,
inserting an invalid path for the ISO image doesn't result in an error
message that it *looks* like it should be throwing errors about invalid ISO
image.


In fact, I've even tried passing ALL NULL/EMPTY VALUES and with the
exception of the $conn connection variable, I only get this "Cannot get
installation XML" error message:

$result = libvirt_domain_new(
    $conn,
    null,
    null,
    null,
    null,
    null,
    null,
    [],
    []
    );


Shouldn't I at least be seeing a message like "Name is 'myvm', memMB is 2048,
maxmemMB is 8192" ?


https://github.com/php/pecl-virtualization-libvirt/blob/master/src/libvirt-php.c


[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;&lt;font face="monospace"&gt;Despite great success at using php-libvirt with \
other functions, I have been entirely unsuccessful in getting it to create a new \
domain/machine. Any time I do, and with virtually anything I try, I get the above \
error message.  &lt;br&gt;&lt;br&gt;Running PHP 7.4 (remi) on otherwise stock AlmaLinux. \
&lt;br&gt;&lt;b&gt;[root@sb4 html]# cat /etc/redhat-release &lt;br&gt;AlmaLinux release 8.5 (Arctic \
Sphynx&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;p class="gmail-p1" \
style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(0,0,0)"&gt;&lt;font \
face="monospace"&gt;&lt;b&gt;&lt;span class="gmail-s1" \
style="font-variant-ligatures:no-common-ligatures"&gt;[root@sb4 html]# rpm -qa php \
php-fpm php-libvirt nginx&lt;br&gt;php-7.4.28-1.el8.remi.x86_64&lt;br&gt;nginx-1.14.1-9.module_el8 \
.3.0+2165+af250afe.alma.x86_64&lt;br&gt;php-fpm-7.4.28-1.el8.remi.x86_64&lt;br&gt;php-libvirt-0.5.5-1.el8.remi.7.4.x86_64&lt;br&gt;12 \
XEON  &lt;/span&gt;&lt;span style="font-variant-ligatures:no-common-ligatures"&gt;E312xx cores, \
24 w/HT, 192GB RAM, etc.  &lt;/span&gt;&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;&lt;font face="monospace"&gt;&lt;br&gt;When I run \
it, I find in php-fpm www.error-log:  &lt;br&gt;&lt;/font&gt;&lt;div&gt;&lt;font face="monospace"&gt;&lt;br&gt;





&lt;/font&gt;&lt;p class="gmail-p1" \
style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(0,0,0)"&gt;&lt;span \
class="gmail-s1" style="font-variant-ligatures:no-common-ligatures"&gt;&lt;font \
face="monospace"&gt;&lt;b&gt;[24-Mar-2022 20:05:51 UTC] PHP Warning:&lt;span \
class="gmail-Apple-converted-space"&gt;   &lt;/span&gt;libvirt_domain_new(): Cannot get \
installation XML in /var/www/html/manage.php on line 190&lt;/b&gt;&lt;br&gt;&lt;br&gt;Matching message \
onscreen: &lt;b&gt;Warning: libvirt_domain_new(): Cannot get installation XML in \
/var/www/html/manage.php on line 191&lt;/b&gt;&lt;br&gt;&lt;br&gt;Here's the offending code:  \
&lt;br&gt;&lt;br&gt;





&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p class="gmail-p1" \
style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(56,185,199)"&gt;&lt;font \
face="monospace"&gt;&lt;span class="gmail-s2" \
style="font-variant-ligatures:no-common-ligatures"&gt;$networks&lt;/span&gt;&lt;span \
class="gmail-s1" style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt; \
= [&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p class="gmail-p2" \
style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(0,0,0)"&gt;&lt;font \
face="monospace"&gt;&lt;span class="gmail-s2" \
style="font-variant-ligatures:no-common-ligatures"&gt;&lt;span \
class="gmail-Apple-converted-space"&gt;      &lt;/span&gt;&lt;/span&gt;&lt;span class="gmail-s3" \
style="font-variant-ligatures:no-common-ligatures;color:rgb(170,171,37)"&gt;&lt;b&gt;'mac'&lt;/b&gt;&lt;/span&gt;&lt;span \
class="gmail-s2" style="font-variant-ligatures:no-common-ligatures"&gt; =&gt; \
'&lt;/span&gt;52:54:00:06:a7:df'&lt;span \
style="font-variant-ligatures:no-common-ligatures"&gt;,&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p \
class="gmail-p2" style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(0,0,0)"&gt;&lt;font \
face="monospace"&gt;&lt;span class="gmail-s2" \
style="font-variant-ligatures:no-common-ligatures"&gt;&lt;span \
class="gmail-Apple-converted-space"&gt;      &lt;/span&gt;&lt;/span&gt;&lt;span class="gmail-s3" \
style="font-variant-ligatures:no-common-ligatures;color:rgb(170,171,37)"&gt;&lt;b&gt;'network'&lt;/b&gt;&lt;/span&gt;&lt;span \
class="gmail-s2" style="font-variant-ligatures:no-common-ligatures"&gt; =&gt; \
'default',&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p class="gmail-p3" \
style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(170,171,37)"&gt;&lt;font \
face="monospace"&gt;&lt;span class="gmail-s1" \
style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt;&lt;span \
class="gmail-Apple-converted-space"&gt;      &lt;/span&gt;&lt;/span&gt;&lt;span class="gmail-s2" \
style="font-variant-ligatures:no-common-ligatures"&gt;&lt;b&gt;'model'&lt;/b&gt;&lt;/span&gt;&lt;span \
class="gmail-s1" style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt; \
=&gt;&lt;span class="gmail-Apple-converted-space"&gt;   &lt;/span&gt;&lt;/span&gt;&lt;span \
class="gmail-s2" style="font-variant-ligatures:no-common-ligatures"&gt;&lt;b&gt;'e1000'&lt;/b&gt;&lt;/span&gt;&lt;span \
class="gmail-s1" style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt;,&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p \
class="gmail-p2" style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(0,0,0)"&gt;&lt;span \
class="gmail-s2" style="font-variant-ligatures:no-common-ligatures"&gt;&lt;font \
face="monospace"&gt;&lt;span class="gmail-Apple-converted-space"&gt;      \
&lt;/span&gt;];&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p class="gmail-p2" \
style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(0,0,0)"&gt;&lt;font \
face="monospace"&gt;&lt;span class="gmail-s4" \
style="font-variant-ligatures:no-common-ligatures;color:rgb(56,185,199)"&gt;$disks&lt;/span&gt;&lt;span \
class="gmail-s2" style="font-variant-ligatures:no-common-ligatures"&gt; = \
[&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p class="gmail-p3" \
style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(170,171,37)"&gt;&lt;font \
face="monospace"&gt;&lt;span class="gmail-s1" \
style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt;&lt;span \
class="gmail-Apple-converted-space"&gt;      &lt;/span&gt;&lt;/span&gt;&lt;span class="gmail-s2" \
style="font-variant-ligatures:no-common-ligatures"&gt;&lt;b&gt;'path'&lt;/b&gt;&lt;/span&gt;&lt;span \
class="gmail-s1" style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt; \
=&gt; &lt;/span&gt;&lt;span class="gmail-s2" \
style="font-variant-ligatures:no-common-ligatures"&gt;&lt;b&gt;"/var/lib/libvirt/images/myvm.qcow2"&lt;/b&gt;&lt;/span&gt;&lt;span \
class="gmail-s1" style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt;,&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p \
class="gmail-p3" style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(170,171,37)"&gt;&lt;font \
face="monospace"&gt;&lt;span class="gmail-s1" \
style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt;&lt;span \
class="gmail-Apple-converted-space"&gt;      &lt;/span&gt;&lt;/span&gt;&lt;span class="gmail-s2" \
style="font-variant-ligatures:no-common-ligatures"&gt;&lt;b&gt;'driver'&lt;/b&gt;&lt;/span&gt;&lt;span \
class="gmail-s1" style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt; \
=&gt; &lt;/span&gt;&lt;span class="gmail-s2" \
style="font-variant-ligatures:no-common-ligatures"&gt;&lt;b&gt;'qcow2'&lt;/b&gt;&lt;/span&gt;&lt;span \
class="gmail-s1" style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt;,&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p \
class="gmail-p3" style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(170,171,37)"&gt;&lt;font \
face="monospace"&gt;&lt;span class="gmail-s1" \
style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt;&lt;span \
class="gmail-Apple-converted-space"&gt;      &lt;/span&gt;&lt;/span&gt;&lt;span class="gmail-s2" \
style="font-variant-ligatures:no-common-ligatures"&gt;&lt;b&gt;'bus'&lt;/b&gt;&lt;/span&gt;&lt;span \
class="gmail-s1" style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt; \
=&gt; &lt;/span&gt;&lt;span class="gmail-s2" \
style="font-variant-ligatures:no-common-ligatures"&gt;&lt;b&gt;'ide'&lt;/b&gt;&lt;/span&gt;&lt;span \
class="gmail-s1" style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt;,&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p \
class="gmail-p3" style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(170,171,37)"&gt;&lt;font \
face="monospace"&gt;&lt;span class="gmail-s1" \
style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt;&lt;span \
class="gmail-Apple-converted-space"&gt;      &lt;/span&gt;&lt;/span&gt;&lt;span class="gmail-s2" \
style="font-variant-ligatures:no-common-ligatures"&gt;&lt;b&gt;'dev'&lt;/b&gt;&lt;/span&gt;&lt;span \
class="gmail-s1" style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt; \
=&gt; &lt;/span&gt;&lt;span class="gmail-s2" \
style="font-variant-ligatures:no-common-ligatures"&gt;&lt;b&gt;'hda'&lt;/b&gt;&lt;/span&gt;&lt;span \
class="gmail-s1" style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt;,&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p \
class="gmail-p3" style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(170,171,37)"&gt;&lt;font \
face="monospace"&gt;&lt;span class="gmail-s1" \
style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt;&lt;span \
class="gmail-Apple-converted-space"&gt;      &lt;/span&gt;&lt;/span&gt;&lt;span class="gmail-s2" \
style="font-variant-ligatures:no-common-ligatures"&gt;&lt;b&gt;'size'&lt;/b&gt;&lt;/span&gt;&lt;span \
class="gmail-s1" style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt; \
=&gt; &lt;/span&gt;&lt;span class="gmail-s2" \
style="font-variant-ligatures:no-common-ligatures"&gt;&lt;b&gt;'40G'&lt;/b&gt;&lt;/span&gt;&lt;span \
class="gmail-s1" style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt;,&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p \
class="gmail-p2" style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(0,0,0)"&gt;&lt;font \
face="monospace"&gt;&lt;span class="gmail-s2" \
style="font-variant-ligatures:no-common-ligatures"&gt;&lt;span \
class="gmail-Apple-converted-space"&gt;      &lt;/span&gt;&lt;/span&gt;&lt;span class="gmail-s3" \
style="font-variant-ligatures:no-common-ligatures;color:rgb(170,171,37)"&gt;&lt;b&gt;'flags'&lt;/b&gt;&lt;/span&gt;&lt;span \
class="gmail-s2" style="font-variant-ligatures:no-common-ligatures"&gt; =&gt; \
null,&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p class="gmail-p2" \
style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(0,0,0)"&gt;&lt;span \
class="gmail-s2" style="font-variant-ligatures:no-common-ligatures"&gt;&lt;font \
face="monospace"&gt;&lt;span class="gmail-Apple-converted-space"&gt;      \
&lt;/span&gt;];&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;





&lt;p class="gmail-p2" style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(0,0,0)"&gt;&lt;span \
class="gmail-s2" style="font-variant-ligatures:no-common-ligatures;color:rgb(56,185,199)"&gt;&lt;font \
face="monospace"&gt;&lt;span class="gmail-s1" style="color:rgb(0,0,0)"&gt;&lt;span \
class="gmail-Apple-converted-space"&gt;    &lt;/span&gt;&lt;/span&gt;&lt;span class="gmail-s2" \
style="color:rgb(199,199,199)"&gt;error_reporting(&lt;/span&gt;&lt;span class="gmail-s1" \
style="color:rgb(0,0,0)"&gt;-1);&lt;/span&gt;&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p class="gmail-p2" \
style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(0,0,0)"&gt;&lt;font \
face="monospace"&gt;&lt;span class="gmail-s2" \
style="font-variant-ligatures:no-common-ligatures;color:rgb(56,185,199)"&gt;$result&lt;/span&gt;&lt;span \
class="gmail-s1" style="font-variant-ligatures:no-common-ligatures"&gt; = &lt;/span&gt;&lt;span \
class="gmail-s3" style="color:rgb(199,199,199);font-variant-ligatures:no-common-ligatures"&gt;libvirt_domain_new(&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p \
class="gmail-p2" style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(0,0,0)"&gt;&lt;font \
face="monospace"&gt;&lt;span class="gmail-s3" \
style="font-variant-ligatures:no-common-ligatures"&gt;&lt;span \
class="gmail-Apple-converted-space"&gt;      &lt;/span&gt;&lt;/span&gt;&lt;span class="gmail-s2" \
style="font-variant-ligatures:no-common-ligatures;color:rgb(56,185,199)"&gt;$conn&lt;/span&gt;&lt;span \
class="gmail-s3" style="font-variant-ligatures:no-common-ligatures"&gt;,&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p \
class="gmail-p3" style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal"&gt;&lt;font \
face="monospace"&gt;&lt;span class="gmail-s1" \
style="font-variant-ligatures:no-common-ligatures"&gt;&lt;span \
class="gmail-Apple-converted-space" style=""&gt;&lt;font color="#000000"&gt;      &lt;/font&gt;&lt;font \
color="#38b9c7"&gt;'myvm'&lt;/font&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="gmail-s1" \
style="color:rgb(0,0,0);font-variant-ligatures:no-common-ligatures"&gt;,&lt;/span&gt;&lt;span \
class="gmail-s3" style="color:rgb(86,32,244);font-variant-ligatures:no-common-ligatures"&gt;&lt;b&gt; \
// name of the new domain&lt;/b&gt;&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p class="gmail-p3" \
style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(86,32,244)"&gt;&lt;font \
face="monospace"&gt;&lt;span class="gmail-s1" \
style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt;&lt;span \
class="gmail-Apple-converted-space"&gt;      &lt;/span&gt;null,&lt;/span&gt;&lt;span class="gmail-s3" \
style="font-variant-ligatures:no-common-ligatures"&gt;&lt;b&gt; // optional architecture \
string, can be NULL to get default (or false)&lt;/b&gt;&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p \
class="gmail-p3" style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(86,32,244)"&gt;&lt;font \
face="monospace"&gt;&lt;span class="gmail-s1" \
style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt;&lt;span \
class="gmail-Apple-converted-space"&gt;      &lt;/span&gt;2048,&lt;/span&gt;&lt;span class="gmail-s3" \
style="font-variant-ligatures:no-common-ligatures"&gt;&lt;b&gt; // number of megabytes of RAM \
to be allocated for domain&lt;/b&gt;&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p class="gmail-p3" \
style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(86,32,244)"&gt;&lt;font \
face="monospace"&gt;&lt;span class="gmail-s1" \
style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt;&lt;span \
class="gmail-Apple-converted-space"&gt;      &lt;/span&gt;8192,&lt;/span&gt;&lt;span class="gmail-s3" \
style="font-variant-ligatures:no-common-ligatures"&gt;&lt;b&gt; // maximum number of megabytes \
of RAM to be allocated for domain&lt;/b&gt;&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p class="gmail-p3" \
style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(86,32,244)"&gt;&lt;font \
face="monospace"&gt;&lt;span class="gmail-s1" \
style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt;&lt;span \
class="gmail-Apple-converted-space"&gt;      &lt;/span&gt;2,&lt;/span&gt;&lt;span class="gmail-s3" \
style="font-variant-ligatures:no-common-ligatures"&gt;&lt;b&gt; // number of VCPUs to be \
allocated to domain&lt;/b&gt;&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p class="gmail-p4" \
style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(170,171,37)"&gt;&lt;font \
face="monospace"&gt;&lt;span class="gmail-s1" \
style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt;&lt;span \
class="gmail-Apple-converted-space"&gt;      &lt;/span&gt;&lt;/span&gt;&lt;span class="gmail-s3" \
style="font-variant-ligatures:no-common-ligatures"&gt;&lt;b&gt;'/var/www/html/AlmaLinux-8.4-x86_64-dvd.iso'&lt;/b&gt;&lt;/span&gt;&lt;span \
class="gmail-s1" style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt;,&lt;/span&gt;&lt;span \
class="gmail-s5" style="font-variant-ligatures:no-common-ligatures;color:rgb(86,32,244)"&gt;&lt;b&gt; \
// installation ISO image for&lt;/b&gt;&lt;/span&gt;&lt;span class="gmail-s1" \
style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt;$&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p \
class="gmail-p3" style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(86,32,244)"&gt;&lt;font \
face="monospace"&gt;&lt;span class="gmail-s1" \
style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt;&lt;span \
class="gmail-Apple-converted-space"&gt;      &lt;/span&gt;&lt;/span&gt;&lt;span class="gmail-s2" \
style="font-variant-ligatures:no-common-ligatures;color:rgb(56,185,199)"&gt;$disks&lt;/span&gt;&lt;span \
class="gmail-s1" style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt;,&lt;/span&gt;&lt;span \
class="gmail-s3" style="font-variant-ligatures:no-common-ligatures"&gt;&lt;b&gt; // array of \
disk devices for domain&lt;/b&gt;&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p class="gmail-p5" \
style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(56,185,199)"&gt;&lt;font \
face="monospace"&gt;&lt;span class="gmail-s1" \
style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt;&lt;span \
class="gmail-Apple-converted-space"&gt;      &lt;/span&gt;&lt;/span&gt;&lt;span class="gmail-s3" \
style="font-variant-ligatures:no-common-ligatures"&gt;$networks&lt;/span&gt;&lt;span \
class="gmail-s1" style="font-variant-ligatures:no-common-ligatures;color:rgb(0,0,0)"&gt;,&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p \
class="gmail-p2" style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(0,0,0)"&gt;&lt;span \
class="gmail-s3" style="font-variant-ligatures:no-common-ligatures"&gt;&lt;font \
face="monospace"&gt;&lt;span class="gmail-Apple-converted-space"&gt;      \
&lt;/span&gt;null&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p class="gmail-p2" \
style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(0,0,0)"&gt;&lt;span \
class="gmail-s2" style="font-variant-ligatures:no-common-ligatures"&gt;&lt;font \
face="monospace"&gt;










&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p class="gmail-p2" \
style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(0,0,0)"&gt;&lt;span \
class="gmail-s3" style="font-variant-ligatures:no-common-ligatures"&gt;&lt;font \
face="monospace"&gt;&lt;span class="gmail-Apple-converted-space"&gt;      \
&lt;/span&gt;);&lt;br&gt;&lt;br&gt;I've tried various values for $disks and $networks, setting \
error reporting to -1 (display anything and everything), journalctl -f on both the \
webserver and the virt host, etc but was never able to see any error other than this \
one.  &lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p class="gmail-p1" \
style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(0,0,0)"&gt;&lt;span \
class="gmail-s1" style="font-variant-ligatures:no-common-ligatures"&gt;&lt;font \
face="monospace"&gt;











&lt;br&gt;I've also been looking in the source code file for anything obvious, and \
I've been utterly unsuccessful in changing the error message. For example, \
inserting an invalid path for the ISO image doesn't result in an error message \
that it *looks* like it should be throwing errors about invalid ISO image.  \
&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p class="gmail-p1" \
style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(0,0,0)"&gt;&lt;span \
class="gmail-s1" style="font-variant-ligatures:no-common-ligatures"&gt;&lt;font \
face="monospace"&gt;&lt;br&gt;&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p class="gmail-p1" \
style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal"&gt;&lt;span \
class="gmail-s1" style="color:rgb(0,0,0);font-variant-ligatures:no-common-ligatures"&gt;&lt;font \
face="monospace"&gt;In fact, I've even tried passing ALL NULL/EMPTY VALUES and with \
the exception of the $conn connection variable, I only get this "Cannot get \
installation XML" error message:  &lt;br&gt;&lt;br&gt;$result = libvirt_domain_new(&lt;br&gt;      \
$conn,&lt;br&gt;      null,&lt;br&gt;      null,&lt;br&gt;      null,&lt;br&gt;      null,&lt;br&gt;      null,&lt;br&gt; \
null,&lt;br&gt;      [],&lt;br&gt;      []&lt;br&gt;      );&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p class="gmail-p1" \
style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal"&gt;&lt;span \
class="gmail-s1" style="color:rgb(0,0,0);font-variant-ligatures:no-common-ligatures"&gt;&lt;font \
face="monospace"&gt;&lt;br&gt;&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p class="gmail-p1" \
style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal"&gt;&lt;font \
face="monospace"&gt;&lt;span class="gmail-s1" \
style="color:rgb(0,0,0);font-variant-ligatures:no-common-ligatures"&gt;Shouldn't I \
at least be seeing a message like "&lt;/span&gt;&lt;span \
style="color:rgb(10,48,105);white-space:pre"&gt;Name is '&lt;/span&gt;&lt;span \
style="white-space:pre"&gt;myvm&lt;/span&gt;&lt;span \
style="color:rgb(10,48,105);white-space:pre"&gt;', memMB is 2048&lt;/span&gt;&lt;span \
style="color:rgb(10,48,105);white-space:pre"&gt;, maxmemMB is &lt;/span&gt;&lt;span \
style="white-space:pre"&gt;8192&lt;font color="#0a3069"&gt;" ? \
&lt;/font&gt;&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p class="gmail-p1" \
style="margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;line-height:normal;color:rgb(0,0,0)"&gt;&lt;span \
class="gmail-s1" style="font-variant-ligatures:no-common-ligatures"&gt;&lt;font \
face="monospace" style=""&gt;&lt;br&gt;&lt;a \
href="https://github.com/php/pecl-virtualization-libvirt/blob/master/src/libvirt-php.c \
"&gt;https://github.com/php/pecl-virtualization-libvirt/blob/master/src/libvirt-php.c&lt;/a&gt;&lt;/font&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;/div&gt;&lt;/div&gt;




</body></email><email><emailId>20220323131952</emailId><senderName>Shelly Kagan</senderName><senderEmail>skagan@redhat.com</senderEmail><timestampReceived>2022-03-23 13:19:52-0400</timestampReceived><subject>virDomainCoreDump output format</subject><body>

Hi all,
I have a small question regarding virDomainCoreDump.
In the documentation[1] it is stated that the output is of format RAW.
After implementing a function using this command the output file
format that I see is ELF. I understand those formats are different, so is
the documentation not updated? Is there a reason I will get an ELF format
instead of RAW?
Appreciate your help!



[1]
https://libvirt.org/html/libvirt-libvirt-domain.html#virDomainCoreDumpWithFormat

-- 

Shelly Kagan

Senior Software Engineer

Red Hat &lt;https://www.redhat.com&gt;
&lt;https://www.redhat.com&gt;

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;Hi all,&lt;div&gt;I have a small question regarding  \
virDomainCoreDump.&lt;/div&gt;&lt;div&gt;In the documentation[1] it is stated that the output is \
of format RAW. After implementing  a function using this command the output file \
format  that I see is ELF. I understand those formats are different, so is the \
documentation not updated? Is there a reason I will get an ELF format instead of \
RAW?&lt;/div&gt;&lt;div&gt;Appreciate your \
help!&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;[1] &lt;a \
href="https://libvirt.org/html/libvirt-libvirt-domain.html#virDomainCoreDumpWithFormat \
"&gt;https://libvirt.org/html/libvirt-libvirt-domain.html#virDomainCoreDumpWithFormat&lt;/a&gt;&lt;br \
clear="all"&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;-- &lt;br&gt;&lt;div dir="ltr" class="gmail_signature" \
                data-smartmail="gmail_signature"&gt;&lt;div dir="ltr"&gt;&lt;div&gt;
        &lt;p style="font-weight:bold;margin:0;padding:0;font-size:14px;margin-bottom:0;font-family:'RedHatText',sans-serif"&gt;
                
          &lt;span&gt;Shelly&lt;/span&gt; &lt;span&gt;Kagan&lt;/span&gt;&lt;span \
style="color:#aaa;margin:0"&gt;&lt;/span&gt;  &lt;/p&gt;
        
        &lt;p style="font-weight:normal;font-size:12px;margin:0px;font-family:"RedHatText",sans-serif"&gt;
  &lt;span&gt;Senior Software Engineer&lt;/span&gt;
        &lt;/p&gt;
        &lt;p style="font-weight:normal;margin:0;margin-bottom:4px;font-size:12px;font-family:'RedHatText',sans-serif"&gt;
  &lt;a style="color:#0088ce;font-size:12px;margin:0;text-decoration:none;font-family:'RedHatText',sans-serif" \
href="https://www.redhat.com" target="_blank"&gt;Red Hat &lt;span&gt;&lt;/span&gt;&lt;/a&gt;  &lt;/p&gt;
    &lt;div style="margin-bottom:4px"&gt;
      
      
    &lt;/div&gt;
    
    

     

    

    &lt;div style="margin-top:12px"&gt;
      &lt;table border="0"&gt;
        &lt;tbody&gt;&lt;tr&gt;
          &lt;td width="100px"&gt;&lt;a href="https://www.redhat.com" target="_blank"&gt; &lt;img \
src="https://static.redhat.com/libs/redhat/brand-assets/2/corp/logo--200.png" \
width="90" height="auto"&gt;&lt;/a&gt; &lt;/td&gt;  
        &lt;/tr&gt;
      &lt;/tbody&gt;&lt;/table&gt;
    &lt;/div&gt;

  &lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220309093422</emailId><senderName>Michal Prívozník</senderName><senderEmail>mprivozn@redhat.com</senderEmail><timestampReceived>2022-03-09 09:34:22-0400</timestampReceived><subject>Re: how to reliably shutdown domains ?</subject><body>

On 3/8/22 20:25, Lentes, Bernd wrote:
&gt; Hey guys,
&gt; 
&gt; i have a two-node cluster with around 20 domains. Cluster-Software is pacemaker and \
&gt; corosync, OS is SLES 12 SP5. The scripts for starting/stopping the domains use \
&gt; virsh. Is there a way to reliably shutdown the domains via virsh ? I'm testing \
&gt; around, but sometimes the domains stop, sometimes they don't, sometimes it takes \
&gt; very long so that the cluster times out and fence the respective node.
&gt; I'm using "virsh shutdown domain --mode acpi,agent" for the windows domains (not \
&gt; reliable) and for the linux domains "virsh shutdown domain", also not reliable.

In general, if agent is available it's more likely to succeed than acpi,
because the shutdown is initiated from inside the guest (/sbin/shutdown
is invoked for UNIX-like systems, or Windows equivalent) while with ACPI
a guest can simply chose to ignore it. In fact, that's what libvirt does
- whenever agent method is available (i.e. --mode contains agent, or no
specific --mode was requested = libvirt is free to chose), it is preferred.

I assume you don't see any errors reported by virsh and thus "sometimes
it takes very long" [to shutdown a guest] could mean that guests are
under heavy load, e.g. they are syncing disks before shutdown, stopping
services, etc. I don't think I have a good answer for you until the root
cause if found.

Michal


</body></email><email><emailId>20220307113131</emailId><senderName>Michal Prívozník</senderName><senderEmail>mprivozn@redhat.com</senderEmail><timestampReceived>2022-03-07 11:31:31-0400</timestampReceived><subject>Re: About RO connection</subject><body>

On 3/2/22 03:28, Xingbo Kan wrote:
&gt; Dear developers and users:
&gt; Is there any standard or convention of which kind of APIs&amp;flags could
&gt; be invoked by RO connection? If there is any, please tell me in
&gt; detail, thanks a lot!

Your best bet is to look at public API implementation [1] and see if
virCheckReadOnly*() is called. But in general, anything that can't
change state of a domain/network/... is considered okay for RO
connections (e.g. listing domains, getting domain XML without security
info, etc.). For everything else you'll need RW connection.

Alternatively, you may look at our RPC protocol description [2] and if
the API is described with "domain:read" then it's okay for RO connection.

1: https://gitlab.com/libvirt/libvirt/-/blob/master/src/libvirt-domain.c
2:
https://gitlab.com/libvirt/libvirt/-/blob/master/src/remote/remote_protocol.x#L3918

Michal

</body></email><email><emailId>20220201145317</emailId><senderName>"M, Shivakumar"</senderName><senderEmail>shivakumar.m@intel.com</senderEmail><timestampReceived>2022-02-01 14:53:17-0400</timestampReceived><subject>RE: udmabuf error with libvirt + QEMU</subject><body>

Hi Daniel,

You're right , /dev/udmabuf is required for GTK display for GL support. I agree \
passing the device using qemu:arg breaks the security confinement of Libvirt. For our \
use-case we need to have the GL support, is there any way to specify the GTK display \
option in the Libvirt XML ? or any other alternatives?

Thanks,
Shiv

-----Original Message-----
From: Daniel P. Berrangé &lt;berrange@redhat.com&gt; 
Sent: Tuesday, February 1, 2022 8:11 PM
To: M, Shivakumar &lt;shivakumar.m@intel.com&gt;
Cc: libvirt-users@redhat.com
Subject: Re: udmabuf error with libvirt + QEMU

On Tue, Feb 01, 2022 at 02:27:55PM +0000, M, Shivakumar wrote:
&gt; Hi,
&gt; 
&gt; We are seeing an issue with udambuf, where it says "open /dev/udmabuf: No such file \
&gt; or directory " even if the device exits. This issue particularly we are seeing with \
&gt; libvirt. When we run the QEMU args on the command line, everything works as \
&gt; expected. It seems to be some permission issue when we use the Libvirt, please help \
&gt; us on resolving this.

When libvirt launches QEMU it puts in place a number of strict security protections. \
Libvirt will grant access on a per-file basis to resources on the host that QEMU \
should be allowed to access based on the device configuration in the XML.

In your case though you're using command line passthrough:

&gt; &lt;qemu:commandline&gt;
&gt; &lt;qemu:arg value="-device"/&gt;
&gt; &lt;qemu:arg value="virtio-vga,blob=true"/&gt;
&gt; &lt;qemu:arg value="-display"/&gt;
&gt; &lt;qemu:arg value="gtk,gl=on"/&gt;
&gt; &lt;qemu:env name="DISPLAY" value=":1.0"/&gt;
&gt; &lt;/qemu:commandline&gt;

This is totally opaque to libvirt and so libvirt won't be granting access to any \
resources needed by these args. I'm assuming /dev/udmabuf is needed by the GTK \
display for GL support, or something along those lines.

For further information about your options please consult this page:

  https://libvirt.org/kbase/qemu-passthrough-security.html

Regards,
Daniel
-- 
&gt; &gt; https://berrange.com      -o-    https://www.flickr.com/photos/dberrange :|
&gt; &gt; https://libvirt.org         -o-            https://fstop138.berrange.com :|
&gt; &gt; https://entangle-photo.org    -o-    https://www.instagram.com/dberrange :|


</body></email><email><emailId>20220207185339</emailId><senderName>"Kalra, Ashish"</senderName><senderEmail>ashish.kalra@amd.com</senderEmail><timestampReceived>2022-02-07 18:53:39-0400</timestampReceived><subject>RE: NVMe drive PCI passthrough and suprise hotplug</subject><body>

[AMD Official Use Only]

Hello Peter,

Thanks for your response, we will try with the latest fedora and possibly also with \
the latest libvirt  and re-test.

Will reply with attached debug logs as mentioned below in case we still face the same \
issue with re-testing.

Thanks,
Ashish

-----Original Message-----
From: Peter Krempa &lt;pkrempa@redhat.com&gt; 
Sent: Friday, February 4, 2022 3:21 AM
To: Kalra, Ashish &lt;Ashish.Kalra@amd.com&gt;
Cc: libvirt-users@redhat.com; Grimm, Jon &lt;Jon.Grimm@amd.com&gt;; Ma, Mang-kwan \
                &lt;Mang-kwan.Ma@amd.com&gt;; Huang2, Wei &lt;Wei.Huang2@amd.com&gt;
Subject: Re: NVMe drive PCI passthrough and suprise hotplug

On Thu, Feb 03, 2022 at 23:25:05 +0000, Kalra, Ashish wrote:
&gt; [AMD Official Use Only]

Well, I hope it's okay to use it for libvirt officially too ;)

&gt; 
&gt; Hi,
&gt; I am using Fedora 33, with the following KVM, qemu and libvirt versions:

Note that Fedora 33 is already end-of-life, it would be great if you can re-test with \
a more recent version

&gt; QEMU 5.1.0
&gt; libvirt 6.6.0

specifically this was released 1.5 years ago

&gt; KVM 5.14.18
&gt; 
&gt; We have done pass-through of a PCIe NVMe device to the guest running 
&gt; on FC33 using either virt-manager or virsh and then we do the 
&gt; hot-unplug of the device while it is attached to the guest.
&gt; 
&gt; The device is no longer seen on the guest hardware device list on 
&gt; virt-manager and then we hotplug the device again and we are able to 
&gt; use it on the Host, but when we try to re-attach it to the guest, we get the \
&gt; following error message: 
&gt; Requested operation is not valid, PCI device 0000:c4::00.0 is in use 
&gt; by driver QEMU, Domain fedora 33.

[...]

Unfortunately the tracing you've done doesn't really help in seeing what gone wrong \
in libvirt.

Please attach debug logs per \
https://nam11.safelinks.protection.outlook.com/?url=https%3A%2F%2Fwww.libvirt.org%2Fkb \
ase%2Fdebuglogs.html&amp;data=04%7C01%7Cashish.kalra%40amd.com%7C5f355af2132945d794dd0 \
8d9e7bfa9a0%7C3dd8961fe4884e608e11a82d994e183d%7C0%7C0%7C637795632650001047%7CUnknown% \
7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000&amp;sdata=ksuLz1tv7dr3f3iq4v6RzQosU0Lq0pxXb11mJ7nJWfg%3D&amp;reserved=0



</body></email><email><emailId>20220214014819</emailId><senderName>Yalan Zhang</senderName><senderEmail>yalzhang@redhat.com</senderEmail><timestampReceived>2022-02-14 01:48:19-0400</timestampReceived><subject>Re: qemu+ssh connections to a remote libvirt fail as ssh banner configured</subject><body>

Hi Jiri,

Get it! Have tried and it works well, Thank you all!

On Thu, Feb 10, 2022 at 6:14 PM Jiri Denemark &lt;jdenemar@redhat.com&gt; wrote:

&gt; On Thu, Feb 10, 2022 at 17:47:43 +0800, Yalan Zhang wrote:
&gt; &gt; Thank you! I tried /etc/motd, and it does not impact the libvirt
&gt; connection.
&gt; &gt; Happy to learn something new!
&gt;
&gt; Alternatively if you really need to run commands in .bashrc which can
&gt; potentially print some output, you can put them after a check for
&gt; interactive shell:
&gt;
&gt;     if [[ $- != *i* ]] ; then
&gt;         # Shell is non-interactive.  Be done now!
&gt;         return
&gt;     fi
&gt;
&gt;     echo "Interactive shell here. How are you?"
&gt;
&gt; Jirka
&gt;
&gt;

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;&lt;br clear="all"&gt;&lt;div&gt;&lt;div dir="ltr" class="gmail_signature" \
data-smartmail="gmail_signature"&gt;&lt;div dir="ltr"&gt;&lt;div&gt;Hi \
Jiri,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Get it! Have tried and it works well, Thank you \
all!&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div class="gmail_quote"&gt;&lt;div dir="ltr" \
class="gmail_attr"&gt;On Thu, Feb 10, 2022 at 6:14 PM Jiri Denemark &lt;&lt;a \
href="mailto:jdenemar@redhat.com"&gt;jdenemar@redhat.com&lt;/a&gt;&gt; \
wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0px 0px 0px \
0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"&gt;On Thu, Feb 10, 2022 \
at 17:47:43 +0800, Yalan Zhang wrote:&lt;br&gt; &gt; Thank you! I tried /etc/motd, and it \
does not impact the libvirt connection.&lt;br&gt; &gt; Happy to learn something new!&lt;br&gt;
&lt;br&gt;
Alternatively if you really need to run commands in .bashrc which can&lt;br&gt;
potentially print some output, you can put them after a check for&lt;br&gt;
interactive shell:&lt;br&gt;
&lt;br&gt;
      if [[ $- != *i* ]] ; then&lt;br&gt;
            # Shell is non-interactive.   Be done now!&lt;br&gt;
            return&lt;br&gt;
      fi&lt;br&gt;
&lt;br&gt;
      echo "Interactive shell here. How are you?"&lt;br&gt;
&lt;br&gt;
Jirka&lt;br&gt;
&lt;br&gt;
&lt;/blockquote&gt;&lt;/div&gt;



</body></email><email><emailId>20220215104010</emailId><senderName>Sai Kiran Kumar Reddy</senderName><senderEmail>skiran@cimware.in</senderEmail><timestampReceived>2022-02-15 10:40:10-0400</timestampReceived><subject>Re: libvirtd daemon missing in LFS</subject><body>

Hi Michal,

I am able to build qemu with the options you have suggested. It indeed is a
qemu issue. Thank you for pointing that out.

On Mon, Feb 14, 2022 at 3:51 PM Michal Prívozník &lt;mprivozn@redhat.com&gt;
wrote:

&gt; On 2/14/22 10:09, Sai Kiran Kumar Reddy wrote:
&gt; &gt; Hi Peter,
&gt; &gt;
&gt; &gt; Thanks for your inputs. I have looked at all the dependencies and built
&gt; &gt; libvirt with the appropriate dependencies enabled. I am able to run
&gt; &gt; virt-manager also, without any errors. I am trying to create a VM using
&gt; &gt; virsh. I get an error saying "domain configuration does not support
&gt; &gt; video mode qxl". Could you please let me know if it is libvirt related
&gt; &gt; error or qemu related one?
&gt;
&gt; This is QEMU related and your qemu was probably build without SPICE
&gt; support:
&gt;
&gt;   https://www.spice-space.org/
&gt;
&gt; pass --enable-spice to QEMU ./configure script. Alternatively, Gentoo
&gt; has all these dependencies recorded and maintained. So it's easier to
&gt; install.
&gt;
&gt; Michal
&gt;
&gt;

-- 
Regards,
Sai Kiran.

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;&lt;div&gt;Hi Michal,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I am able to build qemu with \
the options you have suggested. It indeed is a qemu issue. Thank you for pointing \
that out.&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div class="gmail_quote"&gt;&lt;div dir="ltr" \
class="gmail_attr"&gt;On Mon, Feb 14, 2022 at 3:51 PM Michal Prívozník &lt;&lt;a \
href="mailto:mprivozn@redhat.com"&gt;mprivozn@redhat.com&lt;/a&gt;&gt; \
wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0px 0px 0px \
0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"&gt;On 2/14/22 10:09, Sai \
Kiran Kumar Reddy wrote:&lt;br&gt; &gt; Hi Peter,&lt;br&gt;
&gt; &lt;br&gt;
&gt; Thanks for your inputs. I have looked at all the dependencies and built&lt;br&gt;
&gt; libvirt with the appropriate dependencies enabled. I am able to run&lt;br&gt;
&gt; virt-manager also, without any errors. I am trying to create a VM using&lt;br&gt;
&gt; virsh. I get an error saying "domain configuration  does not support&lt;br&gt;
&gt; video mode qxl". Could you please  let me know if it is libvirt related&lt;br&gt;
&gt; error or qemu related one?&lt;br&gt;
&lt;br&gt;
This is QEMU related and your qemu was probably build without SPICE support:&lt;br&gt;
&lt;br&gt;
   &lt;a href="https://www.spice-space.org/" rel="noreferrer" \
target="_blank"&gt;https://www.spice-space.org/&lt;/a&gt;&lt;br&gt; &lt;br&gt;
pass --enable-spice to QEMU ./configure script. Alternatively, Gentoo&lt;br&gt;
has all these dependencies recorded and maintained. So it's easier to&lt;br&gt;
install.&lt;br&gt;
&lt;br&gt;
Michal&lt;br&gt;
&lt;br&gt;
&lt;/blockquote&gt;&lt;/div&gt;&lt;br clear="all"&gt;&lt;br&gt;-- &lt;br&gt;&lt;div dir="ltr" \
class="gmail_signature"&gt;&lt;div dir="ltr"&gt;&lt;div&gt;&lt;span \
style="color:rgb(102,102,102)"&gt;Regards,&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font \
color="#666666"&gt;Sai Kiran.&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220215145750</emailId><senderName>Laine Stump</senderName><senderEmail>laine@redhat.com</senderEmail><timestampReceived>2022-02-15 14:57:50-0400</timestampReceived><subject>Re: Public IP on virtual machine network issue</subject><body>



On 2/14/22 10:18 AM, Tom Ammon wrote:
&gt; Laine,
&gt; 
&gt; Though I can't remember the particulars, I have a vague memory of the 
&gt; sysctl settings in that article indeed solving the problem of traffic 
&gt; not being forwarded on the bridge when I had configured no filtering on 
&gt; the guest - hence my attempt to share what worked for me. Perhaps it 
&gt; would be good to update that page.

Yeah, I had completely forgot of its existence until there were two 
unrelated references suddenly made to it in the last week.

&gt; I looked around for a link to create 
&gt; an account on the libvirt wiki but could find none. I'm happy to go do 
&gt; some more research around the items you mentioned and add a quick note 
&gt; to that page to keep from leading people astray in the future, if I 
&gt; could get an account on the wiki. Do you know how I would do that?

I actually tried to update the article after this second reference, and 
found that my password no longer works. Awhile back the decision was 
made to deprecate the wiki and slowly move content into "knowledgebase" 
articles that are included in the project git repo, and I think the wiki 
may have been made read-only at that time. I had planned to ask about 
that in IRC yesterday, but either forgot, or it was too late to catch 
anyone by the time I asked (I've even forgotten what happened yesterday :-/)

Anyway, even in the days when the wiki was "active", automatic account 
creation was disabled to prevent spam articles, so creating an account 
required sending a message to danpb asking for an account; these days I 
think he'd just say "don't bother - it's going away anyway".

Thanks anyway for the offer to update it though (and also for piping in 
with the idea in the first place - hopefully my response didn't come off 
as discouraging responses - even though it wasn't the source of the 
problem this time, next time yours might be the idea that solves the 
issue :-)).

I'll try to take care of the wiki article in the next day or two.

&gt; 
&gt; Thanks,
&gt; Tom
&gt; 
&gt; On Mon, Feb 14, 2022 at 8:12 AM Laine Stump &lt;laine@redhat.com 
&gt; &lt;mailto:laine@redhat.com&gt;&gt; wrote:
&gt; 
&gt; 
&gt; 
&gt;     On 2/13/22 5:38 PM, Tom Ammon wrote:
&gt;      &gt; Can you post the output of iptables -L?
&gt;      &gt;
&gt;      &gt; By default, the bridge module in the kernel sends packets
&gt;     traversing the
&gt;      &gt; bridge to iptables (in the FORWARD chain I believe) for
&gt;     processing. So
&gt;      &gt; if you have configured a DENY policy on the FORWARD chain, or are
&gt;      &gt; otherwise filtering in the forward chain, you'll be affecting
&gt;     packets
&gt;      &gt; traversing the bridge. Check out this page for details on how to
&gt;     change
&gt;      &gt; this behavior:
&gt;      &gt;
&gt;     https://wiki.libvirt.org/page/Net.bridge.bridge-nf-call_and_sysctl.conf
&gt;     &lt;https://wiki.libvirt.org/page/Net.bridge.bridge-nf-call_and_sysctl.conf&gt;
&gt; 
&gt;      &gt;
&gt;     &lt;https://wiki.libvirt.org/page/Net.bridge.bridge-nf-call_and_sysctl.conf
&gt;     &lt;https://wiki.libvirt.org/page/Net.bridge.bridge-nf-call_and_sysctl.conf&gt;&gt;
&gt; 
&gt;     That information is *very* out of date; the situation has changed quite
&gt;     a lot since that was written in 2014.
&gt; 
&gt;     Filtering of packets traversing a bridge device are now only
&gt;     filtered if
&gt;     the br_netfilter module is loaded, which isn't done by default. It *is*
&gt;     autoloaded if certain types of iptables rules are added(I can't
&gt;     remember
&gt;     the details of the type of rule though - there was a bug in iptables a
&gt;     year or so ago where autoload of br_netfilter was triggered by libvirt
&gt;     attempting to *remove* a rule of whatever type it was).
&gt; 
&gt;     Anyway, unless "lsmod | grep br_netfilter" shows that you have
&gt;     br_netfilter loaded, this entire path is a red herring (if you do have
&gt;     it loaded, unload it, and try to figure out why it was loaded).
&gt; 
&gt;     (Interestingly, this is the 2nd time this particular outdated page has
&gt;     come up in the last week. Has something else broken somewhere that's
&gt;     causing people to search out this page?)
&gt; 
&gt;      &gt;
&gt;      &gt; Tom
&gt;      &gt;
&gt;      &gt; On Sun, Feb 13, 2022 at 4:08 PM Marcin Groszek
&gt;     &lt;marcin@voipplus.net &lt;mailto:marcin@voipplus.net&gt;
&gt;      &gt; &lt;mailto:marcin@voipplus.net &lt;mailto:marcin@voipplus.net&gt;&gt;&gt; wrote:
&gt;      &gt;
&gt;      &gt;     I have been struggling with this for weeks and I was unable
&gt;     to find an
&gt;      &gt;     answer on line. Perhaps someone here can help me.
&gt;      &gt;
&gt;      &gt;     Oracle linux 8 running virtualization:
&gt;      &gt;
&gt;      &gt;     hardware node has a public IP address on interface bridge0
&gt;     and physical
&gt;      &gt;     eno1 is a member of the bridge0
&gt;      &gt;
&gt;      &gt;     a virtual OS has interface bridged to lan and source is
&gt;     bridge0, Ip
&gt;      &gt;     address of virtual OS is also a public from same class as the
&gt;      &gt;     hardware node.
&gt;      &gt;
&gt;      &gt;     I can route in and out of virtual, I can ping from hardware
&gt;     node to
&gt;      &gt;     virtual and vice versa, so the routing works as it should,
&gt;     sort of.
&gt;      &gt;
&gt;      &gt;     When I try tracepath or traceroute from outside to virtual I
&gt;     get !H on
&gt;      &gt;     last hup
&gt;      &gt;
&gt;      &gt;     same result when I try to do the same form hardware node to
&gt;     virtual
&gt;      &gt;     I get !H
&gt;      &gt;
&gt;      &gt;     Also, when I telnet (TCP) to a specific port on virtual where
&gt;     I have a
&gt;      &gt;     daemon LISTENING OR NOT I get: No route to host. Same
&gt;     experiment works
&gt;      &gt;     just fine for ssh port.
&gt;      &gt;
&gt;      &gt;     Firewalld is not running, and I just have very basic iptables
&gt;     rules
&gt;      &gt;     like
&gt;      &gt;     allowing external address block to ssh to hardware node and
&gt;     to virtual
&gt;      &gt;     dropping connections from all other sources
&gt;      &gt;
&gt;      &gt;     This issue presented it self when I attempted to setup a
&gt;     galera node on
&gt;      &gt;     virtual and ports 4567 is responding but 4568 and 4444 are
&gt;     not, but the
&gt;      &gt;     daemons are running and I can clearly see lsoft showing
&gt;     "LISTENING"
&gt;      &gt;
&gt;      &gt;     I capture the traffic and the tcp as well as udp are getting
&gt;     to the
&gt;      &gt;     virtual. Is there a preconfigured netfiltering that I am not
&gt;     aware of?
&gt;      &gt;
&gt;      &gt;     What am I missing?
&gt;      &gt;
&gt;      &gt;
&gt;      &gt;
&gt;      &gt;
&gt;      &gt;     --
&gt;      &gt;     Best Regards:
&gt;      &gt;     Marcin Groszek
&gt;      &gt;     Business Voip Resource.
&gt;      &gt; http://www.voipplus.net &lt;http://www.voipplus.net&gt;
&gt;     &lt;http://www.voipplus.net &lt;http://www.voipplus.net&gt;&gt;
&gt;      &gt;
&gt;      &gt;
&gt;      &gt;
&gt;      &gt; --
&gt;      &gt;
&gt;     -----------------------------------------------------------------------------
&gt;      &gt; Tom Ammon
&gt;      &gt; M: (737) 400-9042
&gt;      &gt; thomasammon@gmail.com &lt;mailto:thomasammon@gmail.com&gt;
&gt;     &lt;mailto:thomasammon@gmail.com &lt;mailto:thomasammon@gmail.com&gt;&gt;
&gt;      &gt;
&gt;     -----------------------------------------------------------------------------
&gt; 
&gt; 
&gt; 
&gt; -- 
&gt; -----------------------------------------------------------------------------
&gt; Tom Ammon
&gt; M: (737) 400-9042
&gt; thomasammon@gmail.com &lt;mailto:thomasammon@gmail.com&gt;
&gt; -----------------------------------------------------------------------------

</body></email><email><emailId>20220216142839</emailId><senderName>Laine Stump</senderName><senderEmail>laine@redhat.com</senderEmail><timestampReceived>2022-02-16 14:28:39-0400</timestampReceived><subject>Re: SSH VM from outside, but not from host</subject><body>

On 2/16/22 4:40 AM, Peter Crowther wrote:
&gt; ... hang on.  Why does the *bridge* have an IP address?  Think of a 
&gt; bridge as being like a switch; it has no address of its own.

It's not the IP address of the bridge, it's the IP address of the 
"default / built-in" port of the bridge. The standard way to configure a 
Linux host bridge is to attach the host's physical ethernet to the 
bridge, and move the IP config from the ethernet device to the bridge 
device. This is because each Linux host bridge has a single port 
(netdev) that is connected to the routing stack of the host's kernel. So 
traffic comes in the ethernet, to the port on the bridge that's 
connected to the ethernet, and then sent out of the bridge via this 
"built-in" port up to the host's IP stack for either reception by the 
host, or routing by IP. Since this built-in port is "closer" to the host 
kernel, it makes sense for the IP config to be there (at least that's 
how I think about it).


The comment I have about the *original* problem is this: what's being 
described sounds exactly like what would happen if the guest config was 
using &lt;interface type='direct'&gt; rather than &lt;interface type='bridge'&gt;. 
Because the description talks about being connectd via a bridge, I at 
first I assumed that the connection is &lt;interface type='bridge'&gt;, but 
then just now realized that although it is pointless to use 
type='direct' (a macvtap device) to connect via a bridge, it still would 
work (except host&lt;-&gt;guest communication wouldn't work), so it's at least 
worth asking if possibly type='direct' was used by mistake.

https://wiki.libvirt.org/page/TroubleshootMacvtapHostFail

Probably not the issue here, but I thought I should throw it out there 
just in case :-)

&gt; 
&gt; Cheers,
&gt; 
&gt; Peter
&gt; 
&gt; On Tue, 15 Feb 2022 at 20:21, Wolf &lt;ort_libvirt@bergersen.no 
&gt; &lt;mailto:ort_libvirt@bergersen.no&gt;&gt; wrote:
&gt; 
&gt;     On 15 Feb 2022, at 20:04, Peter Crowther
&gt;     &lt;peter.crowther@melandra.com &lt;mailto:peter.crowther@melandra.com&gt;&gt;
&gt;     wrote:
&gt;&gt;
&gt;&gt;     And eno1 and eno2 are *both* connected to the same external
&gt;&gt;     switch, yes?
&gt; 
&gt;     Correct, where each NIC has its ip access-list.
&gt;     XX1.XX1.XX1.150 and XX2.XX2.XX2.100 are on separate NICs.
&gt; 
&gt;     When I ping the VM, XX2.XX2.XX2.100, from the host, XX1.XX1.XX1.150,
&gt;     the host pings itself.
&gt; 
&gt;     Thanks!
&gt; 
&gt;     Wolf
&gt; 
&gt; 
&gt; 
&gt;&gt;
&gt;&gt;     On Tue, 15 Feb 2022 at 17:17, Wolf &lt;ort_libvirt@bergersen.no
&gt;&gt;     &lt;mailto:ort_libvirt@bergersen.no&gt;&gt; wrote:
&gt;&gt;
&gt;&gt;          Hi!
&gt;&gt;
&gt;&gt;         1) I have two network ports on my server.
&gt;&gt;          -      eno1 has the IP: XX1.XX1.XX1.150
&gt;&gt;
&gt;&gt;          -      bridge0 has the IP: XX2.XX2.XX2.100
&gt;&gt;                 and has the interface member: port eno2.
&gt;&gt;                 eno2 is not set up with an IP address.
&gt;&gt;
&gt;&gt;         2) The host runs on IP: XX1.XX1.XX1.150
&gt;&gt;
&gt;&gt;         3) A VM uses the bridge: bridge0, and has the IP: XX2.XX2.XX2.100
&gt;&gt;
&gt;&gt;         I have a problem with this setup:
&gt;&gt;         I can ssh the VM on XX2.XX2.XX2.100 from outside, but from the
&gt;&gt;         host, XX1.XX1.XX1.150, I can't ssh the VM on XX2.XX2.XX2.100.
&gt;&gt;
&gt;&gt;         Have I set up this wrong or is it something I can do to solve
&gt;&gt;         this?
&gt;&gt;
&gt;&gt;         Thanks!
&gt;&gt;
&gt;&gt;         Wolf
&gt;&gt;
&gt;&gt;
&gt; 

</body></email><email><emailId>20220220210701</emailId><senderName>Ján Tomko</senderName><senderEmail>jtomko@redhat.com</senderEmail><timestampReceived>2022-02-20 21:07:01-0400</timestampReceived><subject>Re: libvirt-python for alpine linux</subject><body>


On a Saturday in 2022, Tom Ammon wrote:
&gt;Hi everybody,
&gt;
&gt;Is there a libvirt-python package for alpine linux? I'm looking to
&gt;containerize an app that uses libvirt-python, using alpine linux, but all I
&gt;found that looked similar to libvirt-python was py-libvirt (
&gt;https://pkgs.alpinelinux.org/package/v3.3/main/x86/py-libvirt) and it looks

Yes, looking at the 'APKBUILD' file of py-libvirt, it is built from
upstream libvirt's libvirt-python sources:
https://git.alpinelinux.org/aports/tree/community/py3-libvirt/APKBUILD

&gt;pretty old.

The link you posted leads to the 'py-libvirt' version in Alpine release v3.3.

If you look at a more recent release, the version should be closer to
(if not equal) to the version of your libvirt-dev package:

https://pkgs.alpinelinux.org/packages?name=py3-libvirt&amp;branch=v3.15

Jano

["signature.asc" (application/pgp-signature)]

</body></email><email><emailId>20220203232505</emailId><senderName>"Kalra, Ashish"</senderName><senderEmail>ashish.kalra@amd.com</senderEmail><timestampReceived>2022-02-03 23:25:05-0400</timestampReceived><subject>NVMe drive PCI passthrough and suprise hotplug</subject><body>

[AMD Official Use Only]

Hi,
I am using Fedora 33, with the following KVM, qemu and libvirt versions:
QEMU 5.1.0
libvirt 6.6.0
KVM 5.14.18

We have done pass-through of a PCIe NVMe device to the guest running on FC3=
3
using either virt-manager or virsh and then we do the hot-unplug of the dev=
ice
while it is attached to the guest.

The device is no longer seen on the guest hardware device list on virt-mana=
ger
and then we hotplug the device again and we are able to use it on the Host,
but when we try to re-attach it to the guest, we get the following error me=
ssage:

Requested operation is not valid, PCI device 0000:c4::00.0 is in use by dri=
ver QEMU,
Domain fedora 33.

So somehow libvirt still thinks the hot-unplugged device is attached.

Tracing the flow of hot un-plug event from guest to host :

-&gt;Guest pcie hotplug support detected the NVMe driver unplug (from guest ke=
rnel logs):

pciehp: Slot (0-6): Attention button pressed

pciehp: Slot (0-6): Powering off due to to button press.

-&gt; Also looks like the guest notified Host/KVM (from host kernel logs):

pcieport: 0000:c4:0000.0: pciehp: Slot (208): Card not present

-&gt; Correspondingly, vfio-pci module notified Qemu :

vfio-pci: 0000:c4:0000.0: Relaying device request to user (#0)

-&gt; Then the un-plugged device reset is done.

vfio-pci: vfio_bar_restore: reset recovery - restoring BARs

pci 0000:c4:00.0: Removing from iommu group 105.

-&gt; Next tried to verify if libvirt detected the DELETED_DRIVE event from qe=
mu.

Running SystemTap script to capture events between qemu and libvirt :

stap examples/systemtap/qemu-monitor.stp

When the NVMe drive is attached to VM the following log output is seen from=
 SystemTap:

execute "device-add", driver: "vfio-pci", host: "0000:c4:00.0", id: "hostde=
v0", bus: "pci.7", addr: "0".

When we hot-unplug the NVMe drive, the following log output is seen from Sy=
stemTap:

event: DEVICE_DELETED, device: "hostdev0", path: "/machine/peripheral/hostd=
ev0".

So it looks like that qemu sent the "DEVICE_DELTED" event to libvirt, but l=
ibvirt has still not removed the attached
device from its bookeeping list.

I understand there is already a thread from 20202, discussing a similar iss=
ue :
https://www.spinics.net/linux/fedora/libvirt-users/msg12590.html

But I am not sure if there is any fix/support added for this recently.

Looking for any feedback related to above and PCI device passthrough and ho=
tplug support.

Thanks,
Ashish

[Attachment #3 (text/html)]

&lt;html xmlns:v="urn:schemas-microsoft-com:vml" \
xmlns:o="urn:schemas-microsoft-com:office:office" \
xmlns:w="urn:schemas-microsoft-com:office:word" \
xmlns:m="http://schemas.microsoft.com/office/2004/12/omml" \
xmlns="http://www.w3.org/TR/REC-html40"&gt; &lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=us-ascii"&gt;
&lt;meta name="Generator" content="Microsoft Word 15 (filtered medium)"&gt;
&lt;style&gt;&lt;!--
/* Font Definitions */
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
@font-face
	{font-family:"Segoe UI";
	panose-1:2 11 5 2 4 2 4 2 2 3;}
/* Style Definitions */
p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin:0in;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
a:link, span.MsoHyperlink
	{mso-style-priority:99;
	color:#0563C1;
	text-decoration:underline;}
span.EmailStyle17
	{mso-style-type:personal-compose;
	font-family:"Calibri",sans-serif;
	color:windowtext;}
.MsoChpDefault
	{mso-style-type:export-only;}
@page WordSection1
	{size:8.5in 11.0in;
	margin:1.0in 1.0in 1.0in 1.0in;}
div.WordSection1
	{page:WordSection1;}
--&gt;&lt;/style&gt;&lt;!--[if gte mso 9]&gt;&lt;xml&gt;
&lt;o:shapedefaults v:ext="edit" spidmax="1026" /&gt;
&lt;/xml&gt;&lt;![endif]--&gt;&lt;!--[if gte mso 9]&gt;&lt;xml&gt;
&lt;o:shapelayout v:ext="edit"&gt;
&lt;o:idmap v:ext="edit" data="1" /&gt;
&lt;/o:shapelayout&gt;&lt;/xml&gt;&lt;![endif]--&gt;
&lt;/head&gt;
&lt;body lang="EN-US" link="#0563C1" vlink="#954F72" style="word-wrap:break-word"&gt;
&lt;p class="msipheadera4477989" align="Left" style="margin:0"&gt;&lt;span \
style="font-size:10.0pt;font-family:Arial;color:#0000FF"&gt;[AMD Official Use \
Only]&lt;/span&gt;&lt;/p&gt; &lt;br&gt;
&lt;div class="WordSection1"&gt;
&lt;p class="MsoNormal"&gt;Hi,&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;I am using Fedora 33, with the following KVM, qemu and libvirt \
versions:&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;QEMU 5.1.0&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;libvirt 6.6.0&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;KVM 5.14.18&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;We have done pass-through of a PCIe NVMe device to the guest \
running on FC33&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;using either virt-manager or \
virsh and then we do the hot-unplug of the device&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;while it is attached to the guest.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;The device is no longer \
seen on the guest hardware device list on virt-manager&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;and then we hotplug the device again and we are able to use it on \
the Host,&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;but when we try to re-attach it to the \
guest, we get the following error message:&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;Requested operation is \
not valid, PCI device 0000:c4::00.0 is in use by driver QEMU,&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;Domain fedora 33. &lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;So somehow libvirt still \
thinks the hot-unplugged device is attached.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;               \
&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;Tracing the flow of hot un-plug event from guest \
to host :&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;-&gt;Guest pcie hotplug support detected the NVMe driver unplug \
(from guest kernel logs): &lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;pciehp: Slot (0-6): Attention button pressed&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;pciehp: Slot (0-6): Powering off due to to button \
press.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;-&gt; Also looks like the guest notified Host/KVM (from host \
kernel logs):&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;pcieport: 0000:c4:0000.0: pciehp: Slot (208): Card not \
present&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;-&gt; Correspondingly, vfio-pci module notified Qemu \
:&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;vfio-pci: 0000:c4:0000.0: Relaying device request to user \
(#0)&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;-&gt; Then the un-plugged device reset is done.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;vfio-pci: vfio_bar_restore: reset recovery - restoring \
BARs&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;pci 0000:c4:00.0: Removing from iommu group 105.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;-&gt; Next tried to verify if libvirt detected the DELETED_DRIVE \
event from qemu.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;Running SystemTap script to capture events between qemu and \
libvirt :&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;stap examples/systemtap/qemu-monitor.stp&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;When the NVMe drive is attached to VM the following log output \
is seen from SystemTap:&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;execute "device-add", driver: "vfio-pci", \
host: "0000:c4:00.0", id: "hostdev0", bus: "pci.7", \
addr: "0".&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;When we hot-unplug the NVMe drive, the following log output is \
seen from SystemTap:&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;event: DEVICE_DELETED, device: "hostdev0", path: \
"/machine/peripheral/hostdev0".&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;So it looks like that \
qemu sent the "DEVICE_DELTED" event to libvirt, but libvirt has still not \
removed the attached&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;device from its bookeeping \
list.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;I understand there is already a thread from 20202, discussing a \
similar issue :&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;span \
style="font-size:10.5pt;font-family:"Segoe \
UI",sans-serif;color:black;background:white"&gt;&lt;a \
href="https://www.spinics.net/linux/fedora/libvirt-users/msg12590.html"&gt;https://www.spinics.net/linux/fedora/libvirt-users/msg12590.html&lt;/a&gt;&lt;/span&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
 &lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;But I am not sure if there is any fix/support added for this \
recently. &lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;Looking for any feedback related to above and PCI device \
passthrough and hotplug support. &lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;Thanks,&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;Ashish&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;



</body></email><email><emailId>20220210015252</emailId><senderName>Yalan Zhang</senderName><senderEmail>yalzhang@redhat.com</senderEmail><timestampReceived>2022-02-10 01:52:52-0400</timestampReceived><subject>qemu+ssh connections to a remote libvirt fail as ssh banner configured</subject><body>

Hi there,

I have a system configured with ssh login banner like as below:
# cat ~/.bashrc
...
echo
"================================================================================="
echo "====== This machine is occupied by xxx for testing now. If you are
about to use it, contact xxx first ======"
echo
"================================================================================="

It works as expected that whenever someone logs into this system by ssh,
he/she will see this warning message.
But it seems such settings will impact a virsh client connection with ssh,
when I try to connect the libvirt daemon on this system, it will error out :
# virsh -c qemu+ssh://${my_host}/system list --all
root@${my_host}'s password:
error: failed to connect to the hypervisor
error: packet 1027423545 bytes received from server too large, want 33554432

I have searched and found some related explanations[1], and [2] says "The
virsh man page doesn't mention ssh, so it sounds like the file
/usr/share/doc/libvirt-doc/remote.html shipped with libvirt-doc could use a
patch mentioning this."
But I can not find anything about this currently on
file:///usr/share/doc/libvirt-docs/html/remote.html.
Could we have this documented for reference with all the possibilities?
Thank you!

[1]
https://bugs.launchpad.net/ubuntu/+source/libvirt/+bug/868753/comments/17
[2]
https://bugs.launchpad.net/ubuntu/+source/libvirt/+bug/868753/comments/14


-------
Best Regards,
Yalan Zhang
IRC: yalzhang

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;&lt;div&gt;Hi there,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I have a system configured \
with ssh login banner like as below:&lt;/div&gt;&lt;div&gt;# cat \
~/.bashrc&lt;br&gt;&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;echo \
"================================================================================="&lt;br&gt;echo \
"====== This machine is occupied by xxx for testing now. If you are about to use \
it, contact xxx first ======"&lt;br&gt;echo \
"================================================================================="&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It \
works as expected that whenever someone logs into this system by ssh, he/she will see \
this warning message.&lt;/div&gt;&lt;div&gt;But it seems such settings will impact a virsh client \
connection with ssh, when I try to connect the libvirt daemon on this system, it will \
error out :&lt;/div&gt;&lt;div&gt;# virsh -c qemu+ssh://${my_host}/system list \
--all&lt;br&gt;root@${my_host}'s password:&lt;/div&gt;&lt;div&gt;error: failed to connect to the \
hypervisor&lt;br&gt;error: packet 1027423545 bytes received from server too large, want \
33554432&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I have searched and found some related \
explanations[1], and [2] says  "The virsh man page doesn't mention ssh, so \
it sounds like the file /usr/share/doc/libvirt-doc/remote.html shipped with \
libvirt-doc could use a patch mentioning this."&lt;/div&gt;&lt;div&gt;But I can not find \
anything about this currently on file:///usr/share/doc/libvirt-docs/html/remote.html. \
&lt;/div&gt;&lt;div&gt;Could we have this documented for reference with all the possibilities? \
Thank you!&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div dir="ltr" class="gmail_signature" \
data-smartmail="gmail_signature"&gt;&lt;div dir="ltr"&gt;&lt;div&gt;[1] &lt;a \
href="https://bugs.launchpad.net/ubuntu/+source/libvirt/+bug/868753/comments/17"&gt;https \
://bugs.launchpad.net/ubuntu/+source/libvirt/+bug/868753/comments/17&lt;/a&gt;&lt;/div&gt;&lt;div&gt;[2] \
&lt;a href="https://bugs.launchpad.net/ubuntu/+source/libvirt/+bug/868753/comments/14"&gt;ht \
tps://bugs.launchpad.net/ubuntu/+source/libvirt/+bug/868753/comments/14&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;-------&lt;br&gt;Best \
Regards,&lt;br&gt;Yalan Zhang&lt;br&gt;IRC: yalzhang&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220210080236</emailId><senderName>Daniel =?utf-8?B?UC4gQmVycmFuZ8Op?=</senderName><senderEmail>berrange@redhat.com</senderEmail><timestampReceived>2022-02-10 08:02:36-0400</timestampReceived><subject>Re: qemu+ssh connections to a remote libvirt fail as ssh banner configured</subject><body>

On Thu, Feb 10, 2022 at 09:52:52AM +0800, Yalan Zhang wrote:
&gt; Hi there,
&gt; 
&gt; I have a system configured with ssh login banner like as below:
&gt; # cat ~/.bashrc
&gt; ...
&gt; echo
&gt; "================================================================================="
&gt; echo "====== This machine is occupied by xxx for testing now. If you are
&gt; about to use it, contact xxx first ======"
&gt; echo
&gt; "================================================================================="
&gt; 
&gt; It works as expected that whenever someone logs into this system by ssh,
&gt; he/she will see this warning message.
&gt; But it seems such settings will impact a virsh client connection with ssh,
&gt; when I try to connect the libvirt daemon on this system, it will error out :
&gt; # virsh -c qemu+ssh://${my_host}/system list --all
&gt; root@${my_host}'s password:
&gt; error: failed to connect to the hypervisor
&gt; error: packet 1027423545 bytes received from server too large, want 33554432

Libvirt is tunnelling an RPC protocol over the SSH connection.
Your bashrc is printing this text onto the SSH conmnection and
that corrupts the libvirt RPC protocol.

If you want to print something whjen people login use the
/etc/motd file which is designed for this pupose, don't
print stuff from a .bashrc.  Libvirt gives the options to
SSH that prevent display of /etc/motd contents, so that
its RPC protocol doesn't get corrupted.

Regards,
Daniel
-- 
|: https://berrange.com      -o-    https://www.flickr.com/photos/dberrange :|
|: https://libvirt.org         -o-            https://fstop138.berrange.com :|
|: https://entangle-photo.org    -o-    https://www.instagram.com/dberrange :|

</body></email><email><emailId>20220210083338</emailId><senderName>Michal Prívozník</senderName><senderEmail>mprivozn@redhat.com</senderEmail><timestampReceived>2022-02-10 08:33:38-0400</timestampReceived><subject>Re: qemu+ssh connections to a remote libvirt fail as ssh banner configured</subject><body>

On 2/10/22 09:02, Daniel P. Berrangé wrote:
&gt; On Thu, Feb 10, 2022 at 09:52:52AM +0800, Yalan Zhang wrote:
&gt;&gt; Hi there,
&gt;&gt;
&gt;&gt; I have a system configured with ssh login banner like as below:
&gt;&gt; # cat ~/.bashrc
&gt;&gt; ...
&gt;&gt; echo
&gt;&gt; "================================================================================="
&gt;&gt; echo "====== This machine is occupied by xxx for testing now. If you are
&gt;&gt; about to use it, contact xxx first ======"
&gt;&gt; echo
&gt;&gt; "================================================================================="
&gt;&gt;
&gt;&gt; It works as expected that whenever someone logs into this system by ssh,
&gt;&gt; he/she will see this warning message.
&gt;&gt; But it seems such settings will impact a virsh client connection with ssh,
&gt;&gt; when I try to connect the libvirt daemon on this system, it will error out :
&gt;&gt; # virsh -c qemu+ssh://${my_host}/system list --all
&gt;&gt; root@${my_host}'s password:
&gt;&gt; error: failed to connect to the hypervisor
&gt;&gt; error: packet 1027423545 bytes received from server too large, want 33554432
&gt; 
&gt; Libvirt is tunnelling an RPC protocol over the SSH connection.
&gt; Your bashrc is printing this text onto the SSH conmnection and
&gt; that corrupts the libvirt RPC protocol.
&gt; 
&gt; If you want to print something whjen people login use the
&gt; /etc/motd file which is designed for this pupose, don't
&gt; print stuff from a .bashrc.  Libvirt gives the options to
&gt; SSH that prevent display of /etc/motd contents, so that
&gt; its RPC protocol doesn't get corrupted.

One more thing, I wasn't able to reproduce when virt-ssh-helper was
used. But maybe I wasn't trying hard enough.

Michal

</body></email><email><emailId>20220210085010</emailId><senderName>Daniel =?utf-8?B?UC4gQmVycmFuZ8Op?=</senderName><senderEmail>berrange@redhat.com</senderEmail><timestampReceived>2022-02-10 08:50:10-0400</timestampReceived><subject>Re: qemu+ssh connections to a remote libvirt fail as ssh banner configured</subject><body>

On Thu, Feb 10, 2022 at 09:33:38AM +0100, Michal Prívozník wrote:
&gt; On 2/10/22 09:02, Daniel P. Berrangé wrote:
&gt; &gt; On Thu, Feb 10, 2022 at 09:52:52AM +0800, Yalan Zhang wrote:
&gt; &gt;&gt; Hi there,
&gt; &gt;&gt;
&gt; &gt;&gt; I have a system configured with ssh login banner like as below:
&gt; &gt;&gt; # cat ~/.bashrc
&gt; &gt;&gt; ...
&gt; &gt;&gt; echo
&gt; &gt;&gt; "================================================================================="
&gt; &gt;&gt; echo "====== This machine is occupied by xxx for testing now. If you are
&gt; &gt;&gt; about to use it, contact xxx first ======"
&gt; &gt;&gt; echo
&gt; &gt;&gt; "================================================================================="
&gt; &gt;&gt;
&gt; &gt;&gt; It works as expected that whenever someone logs into this system by ssh,
&gt; &gt;&gt; he/she will see this warning message.
&gt; &gt;&gt; But it seems such settings will impact a virsh client connection with ssh,
&gt; &gt;&gt; when I try to connect the libvirt daemon on this system, it will error out :
&gt; &gt;&gt; # virsh -c qemu+ssh://${my_host}/system list --all
&gt; &gt;&gt; root@${my_host}'s password:
&gt; &gt;&gt; error: failed to connect to the hypervisor
&gt; &gt;&gt; error: packet 1027423545 bytes received from server too large, want 33554432
&gt; &gt; 
&gt; &gt; Libvirt is tunnelling an RPC protocol over the SSH connection.
&gt; &gt; Your bashrc is printing this text onto the SSH conmnection and
&gt; &gt; that corrupts the libvirt RPC protocol.
&gt; &gt; 
&gt; &gt; If you want to print something whjen people login use the
&gt; &gt; /etc/motd file which is designed for this pupose, don't
&gt; &gt; print stuff from a .bashrc.  Libvirt gives the options to
&gt; &gt; SSH that prevent display of /etc/motd contents, so that
&gt; &gt; its RPC protocol doesn't get corrupted.
&gt; 
&gt; One more thing, I wasn't able to reproduce when virt-ssh-helper was
&gt; used. But maybe I wasn't trying hard enough.

That should be affected in exactly the same way. It still relies on
stdout/stdin being clean data channels.

Regards,
Daniel
-- 
|: https://berrange.com      -o-    https://www.flickr.com/photos/dberrange :|
|: https://libvirt.org         -o-            https://fstop138.berrange.com :|
|: https://entangle-photo.org    -o-    https://www.instagram.com/dberrange :|

</body></email><email><emailId>20220210094743</emailId><senderName>Yalan Zhang</senderName><senderEmail>yalzhang@redhat.com</senderEmail><timestampReceived>2022-02-10 09:47:43-0400</timestampReceived><subject>Re: qemu+ssh connections to a remote libvirt fail as ssh banner configured</subject><body>

Thank you! I tried /etc/motd, and it does not impact the libvirt connection.
Happy to learn something new!

On Thu, Feb 10, 2022 at 4:50 PM Daniel P. Berrangé &lt;berrange@redhat.com&gt;
wrote:

&gt; On Thu, Feb 10, 2022 at 09:33:38AM +0100, Michal Prívozník wrote:
&gt; &gt; On 2/10/22 09:02, Daniel P. Berrangé wrote:
&gt; &gt; &gt; On Thu, Feb 10, 2022 at 09:52:52AM +0800, Yalan Zhang wrote:
&gt; &gt; &gt;&gt; Hi there,
&gt; &gt; &gt;&gt;
&gt; &gt; &gt;&gt; I have a system configured with ssh login banner like as below:
&gt; &gt; &gt;&gt; # cat ~/.bashrc
&gt; &gt; &gt;&gt; ...
&gt; &gt; &gt;&gt; echo
&gt; &gt; &gt;&gt;
&gt; "================================================================================="
&gt; &gt; &gt;&gt; echo "====== This machine is occupied by xxx for testing now. If you
&gt; are
&gt; &gt; &gt;&gt; about to use it, contact xxx first ======"
&gt; &gt; &gt;&gt; echo
&gt; &gt; &gt;&gt;
&gt; "================================================================================="
&gt; &gt; &gt;&gt;
&gt; &gt; &gt;&gt; It works as expected that whenever someone logs into this system by
&gt; ssh,
&gt; &gt; &gt;&gt; he/she will see this warning message.
&gt; &gt; &gt;&gt; But it seems such settings will impact a virsh client connection with
&gt; ssh,
&gt; &gt; &gt;&gt; when I try to connect the libvirt daemon on this system, it will
&gt; error out :
&gt; &gt; &gt;&gt; # virsh -c qemu+ssh://${my_host}/system list --all
&gt; &gt; &gt;&gt; root@${my_host}'s password:
&gt; &gt; &gt;&gt; error: failed to connect to the hypervisor
&gt; &gt; &gt;&gt; error: packet 1027423545 bytes received from server too large, want
&gt; 33554432
&gt; &gt; &gt;
&gt; &gt; &gt; Libvirt is tunnelling an RPC protocol over the SSH connection.
&gt; &gt; &gt; Your bashrc is printing this text onto the SSH conmnection and
&gt; &gt; &gt; that corrupts the libvirt RPC protocol.
&gt; &gt; &gt;
&gt; &gt; &gt; If you want to print something whjen people login use the
&gt; &gt; &gt; /etc/motd file which is designed for this pupose, don't
&gt; &gt; &gt; print stuff from a .bashrc.  Libvirt gives the options to
&gt; &gt; &gt; SSH that prevent display of /etc/motd contents, so that
&gt; &gt; &gt; its RPC protocol doesn't get corrupted.
&gt; &gt;
&gt; &gt; One more thing, I wasn't able to reproduce when virt-ssh-helper was
&gt; &gt; used. But maybe I wasn't trying hard enough.
&gt;
&gt; That should be affected in exactly the same way. It still relies on
&gt; stdout/stdin being clean data channels.
&gt;
&gt; Regards,
&gt; Daniel
&gt; --
&gt; |: https://berrange.com      -o-
&gt; https://www.flickr.com/photos/dberrange :|
&gt; |: https://libvirt.org         -o-
&gt; https://fstop138.berrange.com :|
&gt; |: https://entangle-photo.org    -o-
&gt; https://www.instagram.com/dberrange :|
&gt;
&gt;

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;&lt;br clear="all"&gt;&lt;div&gt;&lt;div dir="ltr" class="gmail_signature" \
data-smartmail="gmail_signature"&gt;&lt;div dir="ltr"&gt;&lt;div&gt;Thank you! I tried /etc/motd, \
and it does not impact the libvirt connection.&lt;/div&gt;&lt;div&gt;Happy to learn something \
new!&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div class="gmail_quote"&gt;&lt;div dir="ltr" \
class="gmail_attr"&gt;On Thu, Feb 10, 2022 at 4:50 PM Daniel P. Berrangé &lt;&lt;a \
href="mailto:berrange@redhat.com"&gt;berrange@redhat.com&lt;/a&gt;&gt; \
wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0px 0px 0px \
0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"&gt;On Thu, Feb 10, 2022 \
at 09:33:38AM +0100, Michal Prívozník wrote:&lt;br&gt; &gt; On 2/10/22 09:02, Daniel P. \
Berrangé wrote:&lt;br&gt; &gt; &gt; On Thu, Feb 10, 2022 at 09:52:52AM +0800, Yalan Zhang \
wrote:&lt;br&gt; &gt; &gt;&gt; Hi there,&lt;br&gt;
&gt; &gt;&gt;&lt;br&gt;
&gt; &gt;&gt; I have a system configured with ssh login banner like as below:&lt;br&gt;
&gt; &gt;&gt; # cat ~/.bashrc&lt;br&gt;
&gt; &gt;&gt; ...&lt;br&gt;
&gt; &gt;&gt; echo&lt;br&gt;
&gt; &gt;&gt; "================================================================================="&lt;br&gt;
 &gt; &gt;&gt; echo "====== This machine is occupied by xxx for testing now. If \
you are&lt;br&gt; &gt; &gt;&gt; about to use it, contact xxx first ======"&lt;br&gt;
&gt; &gt;&gt; echo&lt;br&gt;
&gt; &gt;&gt; "================================================================================="&lt;br&gt;
 &gt; &gt;&gt;&lt;br&gt;
&gt; &gt;&gt; It works as expected that whenever someone logs into this system by \
ssh,&lt;br&gt; &gt; &gt;&gt; he/she will see this warning message.&lt;br&gt;
&gt; &gt;&gt; But it seems such settings will impact a virsh client connection with \
ssh,&lt;br&gt; &gt; &gt;&gt; when I try to connect the libvirt daemon on this system, it \
will error out :&lt;br&gt; &gt; &gt;&gt; # virsh -c qemu+ssh://${my_host}/system list \
--all&lt;br&gt; &gt; &gt;&gt; root@${my_host}'s password:&lt;br&gt;
&gt; &gt;&gt; error: failed to connect to the hypervisor&lt;br&gt;
&gt; &gt;&gt; error: packet 1027423545 bytes received from server too large, want \
33554432&lt;br&gt; &gt; &gt; &lt;br&gt;
&gt; &gt; Libvirt is tunnelling an RPC protocol over the SSH connection.&lt;br&gt;
&gt; &gt; Your bashrc is printing this text onto the SSH conmnection and&lt;br&gt;
&gt; &gt; that corrupts the libvirt RPC protocol.&lt;br&gt;
&gt; &gt; &lt;br&gt;
&gt; &gt; If you want to print something whjen people login use the&lt;br&gt;
&gt; &gt; /etc/motd file which is designed for this pupose, don't&lt;br&gt;
&gt; &gt; print stuff from a .bashrc.   Libvirt gives the options to&lt;br&gt;
&gt; &gt; SSH that prevent display of /etc/motd contents, so that&lt;br&gt;
&gt; &gt; its RPC protocol doesn't get corrupted.&lt;br&gt;
&gt; &lt;br&gt;
&gt; One more thing, I wasn't able to reproduce when virt-ssh-helper was&lt;br&gt;
&gt; used. But maybe I wasn't trying hard enough.&lt;br&gt;
&lt;br&gt;
That should be affected in exactly the same way. It still relies on&lt;br&gt;
stdout/stdin being clean data channels.&lt;br&gt;
&lt;br&gt;
Regards,&lt;br&gt;
Daniel&lt;br&gt;
-- &lt;br&gt;
&gt; &gt; &lt;a href="https://berrange.com" rel="noreferrer" \
&gt; &gt; target="_blank"&gt;https://berrange.com&lt;/a&gt;         -o-      &lt;a \
&gt; &gt; href="https://www.flickr.com/photos/dberrange" rel="noreferrer" \
&gt; &gt; target="_blank"&gt;https://www.flickr.com/photos/dberrange&lt;/a&gt; :|&lt;br&gt;
&gt; &gt; &lt;a href="https://libvirt.org" rel="noreferrer" \
&gt; &gt; target="_blank"&gt;https://libvirt.org&lt;/a&gt;              -o-                  &lt;a \
&gt; &gt; href="https://fstop138.berrange.com" rel="noreferrer" \
&gt; &gt; target="_blank"&gt;https://fstop138.berrange.com&lt;/a&gt; :|&lt;br&gt;
&gt; &gt; &lt;a href="https://entangle-photo.org" rel="noreferrer" \
&gt; &gt; target="_blank"&gt;https://entangle-photo.org&lt;/a&gt;      -o-      &lt;a \
&gt; &gt; href="https://www.instagram.com/dberrange" rel="noreferrer" \
&gt; &gt; target="_blank"&gt;https://www.instagram.com/dberrange&lt;/a&gt; :|&lt;br&gt;
&lt;br&gt;
&lt;/blockquote&gt;&lt;/div&gt;



</body></email><email><emailId>20220209111643</emailId><senderName>Sai Kiran Kumar Reddy</senderName><senderEmail>skiran@cimware.in</senderEmail><timestampReceived>2022-02-09 11:16:43-0400</timestampReceived><subject>libvirtd daemon missing in LFS</subject><body>

Hi,

I am Sai Kiran. I am trying to build libvirt from source on my Linux From
Scratch(LFS) system. I have successfully installed libvirt and its
dependencies. When I start virt-manager, there is a prompt in GUI saying
that "libvirtd service is not installed".  I also do not see any libvirtd
in my system. I would like to install the libvirtd service(build from
source). But I am not able to find the source code for it and also, I am
not sure about the build process for the daemon. Could you please help me
out here.

Thanks in advance for your time and support.

-- 
Regards,
Sai Kiran.

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;Hi,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I am Sai Kiran. I am trying to build libvirt \
from source on my Linux From Scratch(LFS) system. I have successfully installed \
libvirt and its dependencies. When I start virt-manager, there is a prompt in GUI \
saying that "libvirtd service is not installed".   I also do not see any \
libvirtd in my system. I would like to install the libvirtd service(build from \
source). But I am not able to find the source code for it and also, I am not sure \
about the build process for the daemon. Could you please help me out \
here.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks in advance for your time and support.&lt;br \
clear="all"&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;-- &lt;br&gt;&lt;div dir="ltr" class="gmail_signature" \
data-smartmail="gmail_signature"&gt;&lt;div dir="ltr"&gt;&lt;div&gt;&lt;span \
style="color:rgb(102,102,102)"&gt;Regards,&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font \
color="#666666"&gt;Sai Kiran.&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220213213005</emailId><senderName>Marcin Groszek</senderName><senderEmail>marcin@voipplus.net</senderEmail><timestampReceived>2022-02-13 21:30:05-0400</timestampReceived><subject>Public IP on virtual machine network issue</subject><body>

I have been struggling with this for weeks and I was unable to find an 
answer on line. Perhaps someone here can help me.

Oracle linux 8 running virtualization:

hardware node has a public IP address on interface bridge0 and physical 
eno1 is a member of the bridge0

a virtual OS has interface bridged to lan and source is bridge0, Ip 
address of virtual OS is also a public from same class as the hardware node.

I can route in and out of virtual, I can ping from hardware node to 
virtual and vice versa, so the routing works as it should, sort of.

When I try tracepath or traceroute from outside to virtual I get !H on 
last hup

same result when I try to do the same form hardware node to virtual I get !H

Also, when I telnet (TCP) to a specific port on virtual where I have a 
daemon LISTENING OR NOT I get: No route to host. Same experiment works 
just fine for ssh port.

Firewalld is not running, and I just have very basic iptables rules like 
allowing external address block to ssh to hardware node and to virtual 
dropping connections from all other sources

This issue presented it self when I attempted to setup a galera node on 
virtual and ports 4567 is responding but 4568 and 4444 are not, but the 
daemons are running and I can clearly see lsoft showing "LISTENING"

I capture the traffic and the tcp as well as udp are getting to the 
virtual. Is there a preconfigured netfiltering that I am not aware of?

What am I missing?




-- 
Best Regards:
Marcin Groszek
Business Voip Resource.
http://www.voipplus.net

</body></email><email><emailId>20220215170310</emailId><senderName>Wolf</senderName><senderEmail>ort_libvirt@bergersen.no</senderEmail><timestampReceived>2022-02-15 17:03:10-0400</timestampReceived><subject>SSH VM from outside, but not from host</subject><body>

 Hi!
 
1) I have two network ports on my server.
 - 	eno1 has the IP: XX1.XX1.XX1.150
 
 -	bridge0 has the IP: XX2.XX2.XX2.100
 	and has the interface member: port eno2.
 	eno2 is not set up with an IP address.
 	
2) The host runs on IP: XX1.XX1.XX1.150

3) A VM uses the bridge: bridge0, and has the IP: XX2.XX2.XX2.100

I have a problem with this setup:
I can ssh the VM on XX2.XX2.XX2.100 from outside, but from the host, XX1.XX1.XX1.150, \
I can't ssh the VM on XX2.XX2.XX2.100.

Have I set up this wrong or is it something I can do to solve this?

Thanks!

Wolf


</body></email><email><emailId>20220219174515</emailId><senderName>Tom Ammon</senderName><senderEmail>thomasammon@gmail.com</senderEmail><timestampReceived>2022-02-19 17:45:15-0400</timestampReceived><subject>libvirt-python for alpine linux</subject><body>

Hi everybody,

Is there a libvirt-python package for alpine linux? I'm looking to
containerize an app that uses libvirt-python, using alpine linux, but all I
found that looked similar to libvirt-python was py-libvirt (
https://pkgs.alpinelinux.org/package/v3.3/main/x86/py-libvirt) and it looks
pretty old.

Tom

-- 
-----------------------------------------------------------------------------
Tom Ammon
M: (737) 400-9042
thomasammon@gmail.com
-----------------------------------------------------------------------------

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;Hi everybody,  &lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Is there a libvirt-python package \
for alpine linux? I'm looking to containerize an app that uses libvirt-python, \
using alpine linux, but all I found that looked similar to libvirt-python was \
py-libvirt (&lt;a href="https://pkgs.alpinelinux.org/package/v3.3/main/x86/py-libvirt"&gt;https://pkgs.alpinelinux.org/package/v3.3/main/x86/py-libvirt&lt;/a&gt;) \
and it looks pretty old.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Tom&lt;br \
clear="all"&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;-- &lt;br&gt;&lt;div dir="ltr" class="gmail_signature" \
data-smartmail="gmail_signature"&gt;&lt;div dir="ltr"&gt;&lt;div&gt;&lt;div \
dir="ltr"&gt;-----------------------------------------------------------------------------&lt;br&gt;Tom \
Ammon&lt;br&gt;M: (737) 400-9042&lt;br&gt;&lt;a href="mailto:thomasammon@gmail.com" \
target="_blank"&gt;thomasammon@gmail.com&lt;/a&gt;&lt;br&gt;-----------------------------------------------------------------------------&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;




</body></email><email><emailId>20220220025714</emailId><senderName>Tom Ammon</senderName><senderEmail>thomasammon@gmail.com</senderEmail><timestampReceived>2022-02-20 02:57:14-0400</timestampReceived><subject>Re: libvirt-python for alpine linux</subject><body>

Nevermind - I was able to make this work myself by installing via pip,
after I installed the alpine libvirt-dev package.

Originally, the libvirt-python pip install was failing with errors pointing
to pkg-config location.

Tom

On Sat, Feb 19, 2022 at 11:45 AM Tom Ammon &lt;thomasammon@gmail.com&gt; wrote:

&gt; Hi everybody,
&gt;
&gt; Is there a libvirt-python package for alpine linux? I'm looking to
&gt; containerize an app that uses libvirt-python, using alpine linux, but all I
&gt; found that looked similar to libvirt-python was py-libvirt (
&gt; https://pkgs.alpinelinux.org/package/v3.3/main/x86/py-libvirt) and it
&gt; looks pretty old.
&gt;
&gt; Tom
&gt;
&gt; --
&gt;
&gt; -----------------------------------------------------------------------------
&gt; Tom Ammon
&gt; M: (737) 400-9042
&gt; thomasammon@gmail.com
&gt;
&gt; -----------------------------------------------------------------------------
&gt;


-- 
-----------------------------------------------------------------------------
Tom Ammon
M: (737) 400-9042
thomasammon@gmail.com
-----------------------------------------------------------------------------

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;Nevermind - I was able to make this work myself by installing via pip, \
after I installed the alpine libvirt-dev package.  &lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Originally, \
the libvirt-python pip install was failing with errors pointing to pkg-config \
location.&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Tom&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div \
class="gmail_quote"&gt;&lt;div dir="ltr" class="gmail_attr"&gt;On Sat, Feb 19, 2022 at 11:45 \
AM Tom Ammon &lt;&lt;a href="mailto:thomasammon@gmail.com"&gt;thomasammon@gmail.com&lt;/a&gt;&gt; \
wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0px 0px 0px \
0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"&gt;&lt;div dir="ltr"&gt;Hi \
everybody,  &lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Is there a libvirt-python package for alpine linux? \
I'm looking to containerize an app that uses libvirt-python, using alpine linux, \
but all I found that looked similar to libvirt-python was py-libvirt (&lt;a \
href="https://pkgs.alpinelinux.org/package/v3.3/main/x86/py-libvirt" \
target="_blank"&gt;https://pkgs.alpinelinux.org/package/v3.3/main/x86/py-libvirt&lt;/a&gt;) \
and it looks pretty old.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Tom&lt;br \
clear="all"&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;-- &lt;br&gt;&lt;div dir="ltr"&gt;&lt;div dir="ltr"&gt;&lt;div&gt;&lt;div \
dir="ltr"&gt;-----------------------------------------------------------------------------&lt;br&gt;Tom \
Ammon&lt;br&gt;M: (737) 400-9042&lt;br&gt;&lt;a href="mailto:thomasammon@gmail.com" \
target="_blank"&gt;thomasammon@gmail.com&lt;/a&gt;&lt;br&gt;-----------------------------------------------------------------------------&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;
 &lt;/blockquote&gt;&lt;/div&gt;&lt;br clear="all"&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;-- &lt;br&gt;&lt;div dir="ltr" \
class="gmail_signature"&gt;&lt;div dir="ltr"&gt;&lt;div&gt;&lt;div \
dir="ltr"&gt;-----------------------------------------------------------------------------&lt;br&gt;Tom \
Ammon&lt;br&gt;M: (737) 400-9042&lt;br&gt;&lt;a href="mailto:thomasammon@gmail.com" \
target="_blank"&gt;thomasammon@gmail.com&lt;/a&gt;&lt;br&gt;-----------------------------------------------------------------------------&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;




</body></email><email><emailId>20220215172401</emailId><senderName>Marc</senderName><senderEmail>marc@f1-outsourcing.eu</senderEmail><timestampReceived>2022-02-15 17:24:01-0400</timestampReceived><subject>RE: SSH VM from outside, but not from host</subject><body>

&gt; 
&gt; 1) I have two network ports on my server.
&gt; - 	eno1 has the IP: XX1.XX1.XX1.150
&gt; 
&gt; -	bridge0 has the IP: XX2.XX2.XX2.100
&gt; 	and has the interface member: port eno2.
&gt; 	eno2 is not set up with an IP address.
&gt; 
&gt; 2) The host runs on IP: XX1.XX1.XX1.150
&gt; 
&gt; 3) A VM uses the bridge: bridge0, and has the IP: XX2.XX2.XX2.100
&gt; 
&gt; I have a problem with this setup:
&gt; I can ssh the VM on XX2.XX2.XX2.100 from outside, but from the host,
&gt; XX1.XX1.XX1.150, I can't ssh the VM on XX2.XX2.XX2.100.
&gt; 

This can be anything from routing to iptables/firewall rules. Probably least likely \
to do with libvirt ;) Best to troubleshoot is revert to situation where everything \
works as you expect it, and then do one change at a time to see when your problem \
appears.


</body></email><email><emailId>20220215190427</emailId><senderName>Peter Crowther</senderName><senderEmail>peter.crowther@melandra.com</senderEmail><timestampReceived>2022-02-15 19:04:27-0400</timestampReceived><subject>Re: SSH VM from outside, but not from host</subject><body>

And eno1 and eno2 are *both* connected to the same external switch, yes?

Cheers,

Peter

On Tue, 15 Feb 2022 at 17:17, Wolf &lt;ort_libvirt@bergersen.no&gt; wrote:

&gt;  Hi!
&gt;
&gt; 1) I have two network ports on my server.
&gt;  -      eno1 has the IP: XX1.XX1.XX1.150
&gt;
&gt;  -      bridge0 has the IP: XX2.XX2.XX2.100
&gt;         and has the interface member: port eno2.
&gt;         eno2 is not set up with an IP address.
&gt;
&gt; 2) The host runs on IP: XX1.XX1.XX1.150
&gt;
&gt; 3) A VM uses the bridge: bridge0, and has the IP: XX2.XX2.XX2.100
&gt;
&gt; I have a problem with this setup:
&gt; I can ssh the VM on XX2.XX2.XX2.100 from outside, but from the host,
&gt; XX1.XX1.XX1.150, I can't ssh the VM on XX2.XX2.XX2.100.
&gt;
&gt; Have I set up this wrong or is it something I can do to solve this?
&gt;
&gt; Thanks!
&gt;
&gt; Wolf
&gt;
&gt;
&gt;

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;&lt;div&gt;And eno1 and eno2 are *both* connected to the same external \
switch, yes?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Cheers,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Peter&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div \
class="gmail_quote"&gt;&lt;div dir="ltr" class="gmail_attr"&gt;On Tue, 15 Feb 2022 at 17:17, \
Wolf &lt;&lt;a href="mailto:ort_libvirt@bergersen.no"&gt;ort_libvirt@bergersen.no&lt;/a&gt;&gt; \
wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0px 0px 0px \
0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"&gt;  Hi!&lt;br&gt; &lt;br&gt;
1) I have two network ports on my server.&lt;br&gt;
  -         eno1 has the IP: XX1.XX1.XX1.150&lt;br&gt;
&lt;br&gt;
  -         bridge0 has the IP: XX2.XX2.XX2.100&lt;br&gt;
            and has the interface member: port eno2.&lt;br&gt;
            eno2 is not set up with an IP address.&lt;br&gt;
&lt;br&gt;
2) The host runs on IP: XX1.XX1.XX1.150&lt;br&gt;
&lt;br&gt;
3) A VM uses the bridge: bridge0, and has the IP: XX2.XX2.XX2.100&lt;br&gt;
&lt;br&gt;
I have a problem with this setup:&lt;br&gt;
I can ssh the VM on XX2.XX2.XX2.100 from outside, but from the host, XX1.XX1.XX1.150, \
I can't ssh the VM on XX2.XX2.XX2.100.&lt;br&gt; &lt;br&gt;
Have I set up this wrong or is it something I can do to solve this?&lt;br&gt;
&lt;br&gt;
Thanks!&lt;br&gt;
&lt;br&gt;
Wolf&lt;br&gt;
&lt;br&gt;
&lt;br&gt;
&lt;/blockquote&gt;&lt;/div&gt;



</body></email><email><emailId>20220222084808</emailId><senderName>lejeczek</senderName><senderEmail>peljasz@yahoo.co.uk</senderEmail><timestampReceived>2022-02-22 08:48:08-0400</timestampReceived><subject>random but often VMs' - BUG: soft lockup</subject><body>

Hi guys

I see this often(perhaps once a day) on VMs:

... watchdog: BUG: soft -lockup - CPU#1 stuck for xxXXxxs! [swapper/1:0]

At the moment I cannot say I see a pattern - perhaps not spotted one yet 
- and this can happen to any VM between any one of the three hosts, 
which hosts are CentOS 9 on AMD Ryzen 5600G hardware. VMs are mostly 
CentOS 8 but a few Ubuntus too.

Anybody would know what that might be, is, a symptom of? But most 
importantly how to dig in to troubleshoot this?(when this happen then 
such affected VM I can only hard reset)

many thanks, L.

</body></email><email><emailId>20220220030751</emailId><senderName>Charles Polisher</senderName><senderEmail>chas@chasmo.org</senderEmail><timestampReceived>2022-02-20 03:07:51-0400</timestampReceived><subject>Hugepages -- "Memory backend 'pc.ram' not found"</subject><body>

Hello,

After defining hugepages, as documented at
https://libvirt.org/formatdomain.html#memory-backing ,
when I start the guest, I get a dialogue
box that says:

        Error starting domain: internal error: qemu unexpectedly
        closed the monitor: 2022-02-20T01:10:36.520955Z
        qemu-system-x86_64: Memory backend 'pc.ram' not found
        Traceback (most recent call last):
          File "/usr/share/virt-manager/virtManager/asyncjob.py", line 65, 
in cb_wrapper
              callback(asyncjob, *args, **kwargs)
          File "/usr/share/virt-manager/virtManager/asyncjob.py", line 101, 
in tmpcb
             callback(*args, **kwargs)
            File 
"/usr/share/virt-manager/virtManager/object/libvirtobject.py", line 57, 
in newfn
                ret = fn(self, *args, **kwargs)
            File "/usr/share/virt-manager/virtManager/object/domain.py", line 
1329, in startup
             self._backend.create()
            File "/usr/lib64/python3.9/site-packages/libvirt.py", line 1353, 
in create
             raise libvirtError('virDomainCreate() failed'

After backing out changes, guest starts normally.
I searched online for the error message, but found nothing useful.
The hypervisor is running libvirtd (libvirt) 7.8.0 and QEMU emulator 
version 6.1.0,
both build from source. I've got plenty of hugepages available.
The domain's XML definition is attached.

Any ideas where to look next?

Thanks,
-- 
Charles Polisher

["foo" (text/plain)]

&lt;domain type="kvm"&gt;
  &lt;name&gt;slacky-0&lt;/name&gt;
  &lt;uuid&gt;4a67eb39-9b92-8b8a-97ba-7e1250d56b07&lt;/uuid&gt;
  &lt;title&gt;slacky-0&lt;/title&gt;
  &lt;description&gt;elided&lt;/description&gt;
  &lt;memory unit="KiB"&gt;4194304&lt;/memory&gt;
  &lt;currentMemory unit="KiB"&gt;4194304&lt;/currentMemory&gt;
  &lt;memoryBacking&gt;
    &lt;hugepages&gt;
      &lt;page size="4194304" unit="KiB"/&gt;
    &lt;/hugepages&gt;
  &lt;/memoryBacking&gt;
  &lt;vcpu placement="static"&gt;2&lt;/vcpu&gt;
  &lt;os&gt;
    &lt;type arch="x86_64" machine="pc-i440fx-5.1"&gt;hvm&lt;/type&gt;
    &lt;bootmenu enable="no"/&gt;
  &lt;/os&gt;
  &lt;features&gt;
    &lt;acpi/&gt;
    &lt;apic/&gt;
    &lt;pae/&gt;
  &lt;/features&gt;
  &lt;cpu mode="custom" match="exact" check="none"&gt;
    &lt;model fallback="forbid"&gt;kvm64&lt;/model&gt;
  &lt;/cpu&gt;
  &lt;clock offset="utc"/&gt;
  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
  &lt;on_crash&gt;restart&lt;/on_crash&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt;
    &lt;disk type="file" device="cdrom"&gt;
      &lt;driver name="qemu" type="raw"/&gt;
      &lt;target dev="hdc" bus="ide"/&gt;
      &lt;readonly/&gt;
      &lt;address type="drive" controller="0" bus="1" target="0" unit="0"/&gt;
    &lt;/disk&gt;
    &lt;disk type="file" device="disk"&gt;
      &lt;driver name="qemu" type="qcow2" cache="writethrough"/&gt;
      &lt;source file="/mnt/nvme1/VIRTUAL_MACHINES/slacky-0.qcow2"/&gt;
      &lt;target dev="vda" bus="virtio"/&gt;
      &lt;boot order="1"/&gt;
      &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x09" function="0x0"/&gt;
    &lt;/disk&gt;
    &lt;controller type="usb" index="0" model="ich9-ehci1"&gt;
      &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x05" function="0x7"/&gt;
    &lt;/controller&gt;
    &lt;controller type="usb" index="0" model="ich9-uhci1"&gt;
      &lt;master startport="0"/&gt;
      &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x05" function="0x0" multifunction="on"/&gt;
    &lt;/controller&gt;
    &lt;controller type="usb" index="0" model="ich9-uhci2"&gt;
      &lt;master startport="2"/&gt;
      &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x05" function="0x1"/&gt;
    &lt;/controller&gt;
    &lt;controller type="usb" index="0" model="ich9-uhci3"&gt;
      &lt;master startport="4"/&gt;
      &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x05" function="0x2"/&gt;
    &lt;/controller&gt;
    &lt;controller type="ide" index="0"&gt;
      &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x01" function="0x1"/&gt;
    &lt;/controller&gt;
    &lt;controller type="virtio-serial" index="0"&gt;
      &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x07" function="0x0"/&gt;
    &lt;/controller&gt;
    &lt;controller type="scsi" index="0" model="virtio-scsi"&gt;
      &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x08" function="0x0"/&gt;
    &lt;/controller&gt;
    &lt;controller type="pci" index="0" model="pci-root"/&gt;
    &lt;interface type="network"&gt;
      &lt;mac address="52:54:00:c3:93:40"/&gt;
      &lt;source network="default"/&gt;
      &lt;model type="virtio"/&gt;
      &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x03" function="0x0"/&gt;
    &lt;/interface&gt;
    &lt;serial type="file"&gt;
      &lt;source path="/tmp/myconsoleoutput.txt"/&gt;
      &lt;target type="isa-serial" port="0"&gt;
        &lt;model name="isa-serial"/&gt;
      &lt;/target&gt;
    &lt;/serial&gt;
    &lt;console type="file"&gt;
      &lt;source path="/tmp/myconsoleoutput.txt"/&gt;
      &lt;target type="serial" port="0"/&gt;
    &lt;/console&gt;
    &lt;input type="tablet" bus="usb"&gt;
      &lt;address type="usb" bus="0" port="1"/&gt;
    &lt;/input&gt;
    &lt;input type="mouse" bus="ps2"/&gt;
    &lt;input type="keyboard" bus="ps2"/&gt;
    &lt;graphics type="spice" autoport="yes" listen="127.0.0.1"&gt;
      &lt;listen type="address" address="127.0.0.1"/&gt;
    &lt;/graphics&gt;
    &lt;sound model="ich9"&gt;
      &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x04" function="0x0"/&gt;
    &lt;/sound&gt;
    &lt;audio id="1" type="spice"/&gt;
    &lt;video&gt;
      &lt;model type="qxl" ram="65536" vram="65536" vgamem="16384" heads="1" primary="yes"/&gt;
      &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x02" function="0x0"/&gt;
    &lt;/video&gt;
    &lt;memballoon model="virtio"&gt;
      &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x06" function="0x0"/&gt;
    &lt;/memballoon&gt;
  &lt;/devices&gt;
&lt;/domain&gt;


</body></email><email><emailId>20220224180718</emailId><senderName>Natxo Asenjo</senderName><senderEmail>natxo.asenjo@gmail.com</senderEmail><timestampReceived>2022-02-24 18:07:18-0400</timestampReceived><subject>networking question</subject><body>

hi,

I have an issue with one host at a customer's site. I think this cannot
work, but I would like to ask you just in case I am confused.

host:
eno1: 172.20.10.x/24 management interface gw 172.20.10.254
bridge-service: 0.0.0.0/24
tun0: openvpn tunnel to external data center
internal-bridge: x.x.x.x/28 ; routed subnet that goes to openvpn tun0

on vm:
eth0: x.x.x.x/28 on internal-bridge (default gw)
eth1: 172.20.10.x/24 bridge-service gw 172.20.10.254 (same as eno1)

Connectivity to and from openvpn (from and to datacenter) is perfect. All
vms are directly reachable from our management services, no natting.

&gt;From hypervisor I can ping the gw, from vm I cannot ping 172.20.10.254.

My gut feeling is that this cannot work because traffic for the hypervisor
for subnet 172.20.10.x/24 flows through eno1, but for vm through the
bridge-loggin interface. So that cannot work.

Should we just ask the customer to give us different subnets for the host
and the vm?

TIA.
--
regards,
Natxo

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;&lt;div&gt;hi,&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I have an issue with one host at \
a customer's site. I think this cannot work, but I would like to ask you just in \
case I am confused.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;host:&lt;/div&gt;&lt;div&gt;eno1: 172.20.10.x/24 \
management interface gw 172.20.10.254&lt;br&gt;&lt;/div&gt;&lt;div&gt;bridge-service: &lt;a \
href="http://0.0.0.0/24"&gt;0.0.0.0/24&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;tun0: openvpn tunnel to \
external data center&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;internal-bridge: x.x.x.x/28 ; routed subnet \
that goes to openvpn tun0&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;on vm:&lt;/div&gt;&lt;div&gt;eth0: \
x.x.x.x/28 on internal-bridge (default gw)&lt;br&gt;&lt;/div&gt;&lt;div&gt;eth1: 172.20.10.x/24 \
bridge-service gw 172.20.10.254 (same as \
eno1)&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;Connectivity to and from openvpn (from and to \
datacenter) is perfect. All vms are directly reachable from our management services, \
no natting.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;From hypervisor I can ping the gw, from vm I \
cannot ping 172.20.10.254.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;My gut feeling is that this \
cannot work because traffic for the hypervisor for subnet 172.20.10.x/24 flows \
through eno1, but for vm through the bridge-loggin interface. So that cannot work. \
&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Should we just ask the customer to give us different \
subnets for the host and the vm?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;TIA.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div \
dir="ltr" class="gmail_signature" \
data-smartmail="gmail_signature"&gt;--&lt;br&gt;regards,&lt;br&gt;Natxo&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220225160532</emailId><senderName>Martin Kletzander</senderName><senderEmail>mkletzan@redhat.com</senderEmail><timestampReceived>2022-02-25 16:05:32-0400</timestampReceived><subject>Re: networking question</subject><body>


On Thu, Feb 24, 2022 at 07:07:18PM +0100, Natxo Asenjo wrote:
&gt;hi,
&gt;
&gt;I have an issue with one host at a customer's site. I think this cannot
&gt;work, but I would like to ask you just in case I am confused.
&gt;
&gt;host:
&gt;eno1: 172.20.10.x/24 management interface gw 172.20.10.254
&gt;bridge-service: 0.0.0.0/24
&gt;tun0: openvpn tunnel to external data center
&gt;internal-bridge: x.x.x.x/28 ; routed subnet that goes to openvpn tun0
&gt;
&gt;on vm:
&gt;eth0: x.x.x.x/28 on internal-bridge (default gw)
&gt;eth1: 172.20.10.x/24 bridge-service gw 172.20.10.254 (same as eno1)
&gt;
&gt;Connectivity to and from openvpn (from and to datacenter) is perfect. All
&gt;vms are directly reachable from our management services, no natting.
&gt;
&gt;&gt;From hypervisor I can ping the gw, from vm I cannot ping 172.20.10.254.
&gt;
&gt;My gut feeling is that this cannot work because traffic for the hypervisor
&gt;for subnet 172.20.10.x/24 flows through eno1, but for vm through the
&gt;bridge-loggin interface. So that cannot work.
&gt;

I am not sure, but I would try to see where the packets are really going
through by using wireshark/tshark or tcpdump.

The only thing that I can come up on the spot is that it is trying to go
through different interface at some point due to reverse path filtering,
settings for that are in /proc/sys/net/ipv4/conf/*/rp_filter, it might
be routed elsewhere anywhere along the way.  But it is hard to say
without knowing how all the networks are connected.  Maybe I'm just bad
at understanding your situation, for me it is usually better to see this
stuff happen in wireshark.  But I figured I at least let know know one
idea which we had an issue before as well.

Hope that helps,
Martin

&gt;Should we just ask the customer to give us different subnets for the host
&gt;and the vm?
&gt;
&gt;TIA.
&gt;--
&gt;regards,
&gt;Natxo

["signature.asc" (application/pgp-signature)]

</body></email><email><emailId>20220221095446</emailId><senderName>Michal Prívozník</senderName><senderEmail>mprivozn@redhat.com</senderEmail><timestampReceived>2022-02-21 09:54:46-0400</timestampReceived><subject>Re: Hugepages -- "Memory backend 'pc.ram' not found"</subject><body>

On 2/20/22 04:07, Charles Polisher wrote:
&gt; Hello,
&gt; 
&gt; After defining hugepages, as documented at
&gt; https://libvirt.org/formatdomain.html#memory-backing ,
&gt; when I start the guest, I get a dialogue
&gt; box that says:
&gt; 
&gt;     Error starting domain: internal error: qemu unexpectedly
&gt;     closed the monitor: 2022-02-20T01:10:36.520955Z
&gt;     qemu-system-x86_64: Memory backend 'pc.ram' not found
&gt;     Traceback (most recent call last):
&gt;       File "/usr/share/virt-manager/virtManager/asyncjob.py", line 65,
&gt; in cb_wrapper
&gt;         callback(asyncjob, *args, **kwargs)
&gt;       File "/usr/share/virt-manager/virtManager/asyncjob.py", line 101,
&gt; in tmpcb
&gt;         callback(*args, **kwargs)
&gt;       File
&gt; "/usr/share/virt-manager/virtManager/object/libvirtobject.py", line 57,
&gt; in newfn
&gt;         ret = fn(self, *args, **kwargs)
&gt;       File "/usr/share/virt-manager/virtManager/object/domain.py", line
&gt; 1329, in startup
&gt;         self._backend.create()
&gt;       File "/usr/lib64/python3.9/site-packages/libvirt.py", line 1353,
&gt; in create
&gt;         raise libvirtError('virDomainCreate() failed'
&gt; 
&gt; After backing out changes, guest starts normally.
&gt; I searched online for the error message, but found nothing useful.
&gt; The hypervisor is running libvirtd (libvirt) 7.8.0 and QEMU emulator
&gt; version 6.1.0,
&gt; both build from source. I've got plenty of hugepages available.
&gt; The domain's XML definition is attached.

Hey, can you share your domain XML and the generated cmd line? The
latter should be found in /var/log/libvirt/qemu/$domain.log

Thanks,
Michal

</body></email><email><emailId>20220222082544</emailId><senderName>Michal PrÃ­voznÃ­k</senderName><senderEmail>mprivozn@redhat.com</senderEmail><timestampReceived>2022-02-22 08:25:44-0400</timestampReceived><subject>Re: Hugepages -- "Memory backend 'pc.ram' not found"</subject><body>

On 2/21/22 17:12, Charles Polisher wrote:

Hey, please the list on CC for benefit of others, e.g. when somebody
runs into the same problem they can find the discussion in the archive.

&gt; On 2/21/22 01:54, Michal Prívozník wrote:
&gt; 
&gt; &gt; On 2/20/22 04:07, Charles Polisher wrote:
&gt; &gt; &gt; Hello,
&gt; &gt; &gt; 
&gt; &gt; &gt; After defining hugepages, as documented at
&gt; &gt; &gt; https://libvirt.org/formatdomain.html#memory-backing ,
&gt; &gt; &gt; when I start the guest, I get a dialogue
&gt; &gt; &gt; box that says:
&gt; &gt; &gt; 
&gt; &gt; &gt; Error starting domain: internal error: qemu unexpectedly
&gt; &gt; &gt; closed the monitor: 2022-02-20T01:10:36.520955Z
&gt; &gt; &gt; qemu-system-x86_64: Memory backend 'pc.ram' not found
&gt; &gt; &gt; Traceback (most recent call last):
&gt; &gt; &gt; File "/usr/share/virt-manager/virtManager/asyncjob.py", line 65,
&gt; &gt; &gt; in cb_wrapper
&gt; &gt; &gt; callback(asyncjob, *args, **kwargs)
&gt; &gt; &gt; File "/usr/share/virt-manager/virtManager/asyncjob.py", line 101,
&gt; &gt; &gt; in tmpcb
&gt; &gt; &gt; callback(*args, **kwargs)
&gt; &gt; &gt; File
&gt; &gt; &gt; "/usr/share/virt-manager/virtManager/object/libvirtobject.py", line 57,
&gt; &gt; &gt; in newfn
&gt; &gt; &gt; ret = fn(self, *args, **kwargs)
&gt; &gt; &gt; File "/usr/share/virt-manager/virtManager/object/domain.py", line
&gt; &gt; &gt; 1329, in startup
&gt; &gt; &gt; self._backend.create()
&gt; &gt; &gt; File "/usr/lib64/python3.9/site-packages/libvirt.py", line 1353,
&gt; &gt; &gt; in create
&gt; &gt; &gt; raise libvirtError('virDomainCreate() failed'
&gt; &gt; &gt; 
&gt; &gt; &gt; After backing out changes, guest starts normally.
&gt; &gt; &gt; I searched online for the error message, but found nothing useful.
&gt; &gt; &gt; The hypervisor is running libvirtd (libvirt) 7.8.0 and QEMU emulator
&gt; &gt; &gt; version 6.1.0,
&gt; &gt; &gt; both build from source. I've got plenty of hugepages available.
&gt; &gt; &gt; The domain's XML definition is attached.
&gt; &gt; Hey, can you share your domain XML and the generated cmd line? The
&gt; &gt; latter should be found in /var/log/libvirt/qemu/$domain.log
&gt; &gt; 
&gt; &gt; Thanks,
&gt; &gt; Michal
&gt; 
&gt; Thanks for your reply. As requested, the domain XML:
&gt; 
&gt; &lt;domain type="kvm"&gt;
&gt; &lt;name&gt;slacky-0&lt;/name&gt;
&gt; &lt;uuid&gt;4a67eb39-9b92-8b8a-97ba-7e1250d56b07&lt;/uuid&gt;
&gt; &lt;title&gt;slacky-0&lt;/title&gt;
&gt; &lt;description&gt;elided&lt;/description&gt;
&gt; &lt;memory unit="KiB"&gt;4194304&lt;/memory&gt;
&gt; &lt;currentMemory unit="KiB"&gt;4194304&lt;/currentMemory&gt;
&gt; &lt;memoryBacking&gt;
&gt; &lt;hugepages&gt;
&gt; &lt;page size="4194304" unit="KiB"/&gt;

This does not look correct. This is on x86_64 and there is no such size
for hugepages, only 2MiB and 1GiB.

&gt; &lt;/hugepages&gt;
&gt; &lt;/memoryBacking&gt;
&gt; &lt;vcpu placement="static"&gt;2&lt;/vcpu&gt;
&gt; &lt;os&gt;
&gt; &lt;type arch="x86_64" machine="pc-i440fx-5.1"&gt;hvm&lt;/type&gt;
&gt; &lt;bootmenu enable="no"/&gt;
&gt; &lt;/os&gt;
&gt; &lt;features&gt;
&gt; &lt;acpi/&gt;
&gt; &lt;apic/&gt;
&gt; &lt;pae/&gt;
&gt; &lt;/features&gt;
&gt; &lt;cpu mode="custom" match="exact" check="none"&gt;
&gt; &lt;model fallback="forbid"&gt;kvm64&lt;/model&gt;
&gt; &lt;/cpu&gt;
&gt; &lt;clock offset="utc"/&gt;
&gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
&gt; &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
&gt; &lt;on_crash&gt;restart&lt;/on_crash&gt;
&gt; &lt;devices&gt;
&gt; &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt;
&gt; &lt;disk type="file" device="cdrom"&gt;
&gt; &lt;driver name="qemu" type="raw"/&gt;
&gt; &lt;target dev="hdc" bus="ide"/&gt;
&gt; &lt;readonly/&gt;
&gt; &lt;address type="drive" controller="0" bus="1" target="0"
&gt; unit="0"/&gt;
&gt; &lt;/disk&gt;
&gt; &lt;disk type="file" device="disk"&gt;
&gt; &lt;driver name="qemu" type="qcow2" cache="writethrough"/&gt;
&gt; &lt;source file="/mnt/nvme1/VIRTUAL_MACHINES/slacky-0.qcow2"/&gt;
&gt; &lt;target dev="vda" bus="virtio"/&gt;
&gt; &lt;boot order="1"/&gt;
&gt; &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x09"
&gt; function="0x0"/&gt;
&gt; &lt;/disk&gt;
&gt; &lt;controller type="usb" index="0" model="ich9-ehci1"&gt;
&gt; &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x05"
&gt; function="0x7"/&gt;
&gt; &lt;/controller&gt;
&gt; &lt;controller type="usb" index="0" model="ich9-uhci1"&gt;
&gt; &lt;master startport="0"/&gt;
&gt; &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x05"
&gt; function="0x0" multifunction="on"/&gt;
&gt; &lt;/controller&gt;
&gt; &lt;controller type="usb" index="0" model="ich9-uhci2"&gt;
&gt; &lt;master startport="2"/&gt;
&gt; &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x05"
&gt; function="0x1"/&gt;
&gt; &lt;/controller&gt;
&gt; &lt;controller type="usb" index="0" model="ich9-uhci3"&gt;
&gt; &lt;master startport="4"/&gt;
&gt; &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x05"
&gt; function="0x2"/&gt;
&gt; &lt;/controller&gt;
&gt; &lt;controller type="ide" index="0"&gt;
&gt; &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x01"
&gt; function="0x1"/&gt;
&gt; &lt;/controller&gt;
&gt; &lt;controller type="virtio-serial" index="0"&gt;
&gt; &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x07"
&gt; function="0x0"/&gt;
&gt; &lt;/controller&gt;
&gt; &lt;controller type="scsi" index="0" model="virtio-scsi"&gt;
&gt; &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x08"
&gt; function="0x0"/&gt;
&gt; &lt;/controller&gt;
&gt; &lt;controller type="pci" index="0" model="pci-root"/&gt;
&gt; &lt;interface type="network"&gt;
&gt; &lt;mac address="52:54:00:c3:93:40"/&gt;
&gt; &lt;source network="default"/&gt;
&gt; &lt;model type="virtio"/&gt;
&gt; &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x03"
&gt; function="0x0"/&gt;
&gt; &lt;/interface&gt;
&gt; &lt;serial type="file"&gt;
&gt; &lt;source path="/tmp/myconsoleoutput.txt"/&gt;
&gt; &lt;target type="isa-serial" port="0"&gt;
&gt; &lt;model name="isa-serial"/&gt;
&gt; &lt;/target&gt;
&gt; &lt;/serial&gt;
&gt; &lt;console type="file"&gt;
&gt; &lt;source path="/tmp/myconsoleoutput.txt"/&gt;
&gt; &lt;target type="serial" port="0"/&gt;
&gt; &lt;/console&gt;
&gt; &lt;input type="tablet" bus="usb"&gt;
&gt; &lt;address type="usb" bus="0" port="1"/&gt;
&gt; &lt;/input&gt;
&gt; &lt;input type="mouse" bus="ps2"/&gt;
&gt; &lt;input type="keyboard" bus="ps2"/&gt;
&gt; &lt;graphics type="spice" autoport="yes" listen="127.0.0.1"&gt;
&gt; &lt;listen type="address" address="127.0.0.1"/&gt;
&gt; &lt;/graphics&gt;
&gt; &lt;sound model="ich9"&gt;
&gt; &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x04"
&gt; function="0x0"/&gt;
&gt; &lt;/sound&gt;
&gt; &lt;audio id="1" type="spice"/&gt;
&gt; &lt;video&gt;
&gt; &lt;model type="qxl" ram="65536" vram="65536" vgamem="16384"
&gt; heads="1" primary="yes"/&gt;
&gt; &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x02"
&gt; function="0x0"/&gt;
&gt; &lt;/video&gt;
&gt; &lt;memballoon model="virtio"&gt;
&gt; &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x06"
&gt; function="0x0"/&gt;
&gt; &lt;/memballoon&gt;
&gt; &lt;/devices&gt;
&gt; &lt;/domain&gt;
&gt; 
&gt; 
&gt; And the guest log with the generated command line:
&gt; 
&gt; 2022-02-20 01:13:12.985+0000: starting up libvirt version: 7.8.0,
&gt; qemu version: 6.1.0, kernel: 5.15.19, hostname: godzilla.peecee3.com
&gt; LC_ALL=C \
&gt; PATH=/sbin:/usr/sbin:/bin:/usr/bin \
&gt; HOME=/var/lib/libvirt/qemu/domain-34-slacky-0 \
&gt; XDG_DATA_HOME=/var/lib/libvirt/qemu/domain-34-slacky-0/.local/share \
&gt; XDG_CACHE_HOME=/var/lib/libvirt/qemu/domain-34-slacky-0/.cache \
&gt; XDG_CONFIG_HOME=/var/lib/libvirt/qemu/domain-34-slacky-0/.config \
&gt; /usr/bin/qemu-system-x86_64 \
&gt; -name guest=slacky-0,process=qemu:slacky-0,debug-threads=on \
&gt; -S \
&gt; -object
&gt; '{"qom-type":"secret","id":"masterKey0","format":"raw","file":"/var/lib/libvirt/qemu/domain-34-slacky-0/master-key.aes"}'
&gt;  \
&gt; -machine
&gt; pc-i440fx-5.1,accel=kvm,usb=off,dump-guest-core=off,memory-backend=pc.ram \

So this instructs qemu to use a memory device wih id='pc.ram' as the
default/generic memory for the guest..

&gt; -cpu kvm64 \
&gt; -m 4096 \
&gt; -overcommit mem-lock=off \

.. but we never generate such device. Here libvirt should have generated
-object memory-backend-file,id=pc.ram,path=/hugepages/...

And I think I know why. Let me post a patch.

&gt; -smp 2,sockets=2,cores=1,threads=1 \
&gt; -uuid 4a67eb39-9b92-8b8a-97ba-7e1250d56b07 \
&gt; -no-user-config \
&gt; -nodefaults \
&gt; -chardev socket,id=charmonitor,fd=34,server=on,wait=off \
&gt; -mon chardev=charmonitor,id=monitor,mode=control \
&gt; -rtc base=utc \
&gt; -no-shutdown \
&gt; -boot menu=off,strict=on \
&gt; -device ich9-usb-ehci1,id=usb,bus=pci.0,addr=0x5.0x7 \
&gt; -device
&gt; ich9-usb-uhci1,masterbus=usb.0,firstport=0,bus=pci.0,multifunction=on,addr=0x5
&gt; \
&gt; -device
&gt; ich9-usb-uhci2,masterbus=usb.0,firstport=2,bus=pci.0,addr=0x5.0x1 \
&gt; -device
&gt; ich9-usb-uhci3,masterbus=usb.0,firstport=4,bus=pci.0,addr=0x5.0x2 \
&gt; -device virtio-scsi-pci,id=scsi0,bus=pci.0,addr=0x8 \
&gt; -device virtio-serial-pci,id=virtio-serial0,bus=pci.0,addr=0x7 \
&gt; -device ide-cd,bus=ide.1,unit=0,id=ide0-1-0 \
&gt; -blockdev
&gt; '{"driver":"file","filename":"/mnt/nvme1/VIRTUAL_MACHINES/slacky-0.qcow2","node-name \
&gt; ":"libvirt-1-storage","cache":{"direct":false,"no-flush":false},"auto-read-only":true,"discard":"unmap"}'
&gt;  \
&gt; -blockdev
&gt; '{"node-name":"libvirt-1-format","read-only":false,"cache":{"direct":false,"no-flush":false},"driver":"qcow2","file":"libvirt-1-storage","backing":null}'
&gt;  \
&gt; -device
&gt; virtio-blk-pci,bus=pci.0,addr=0x9,drive=libvirt-1-format,id=virtio-disk0,bootindex=1,write-cache=off
&gt;  \
&gt; -netdev tap,fd=58,id=hostnet0,vhost=on,vhostfd=60 \
&gt; -device
&gt; virtio-net-pci,netdev=hostnet0,id=net0,mac=52:54:00:c3:93:40,bus=pci.0,addr=0x3
&gt; \
&gt; -add-fd set=3,fd=62 \
&gt; -chardev file,id=charserial0,path=/dev/fdset/3,append=on \
&gt; -device isa-serial,chardev=charserial0,id=serial0 \
&gt; -device usb-tablet,id=input0,bus=usb.0,port=1 \
&gt; -audiodev id=audio1,driver=spice \
&gt; -spice
&gt; port=5901,addr=127.0.0.1,disable-ticketing=on,seamless-migration=on \
&gt; -device
&gt; qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=16,max_outputs=1,bus=pci.0,addr=0x2
&gt;  \
&gt; -device ich9-intel-hda,id=sound0,bus=pci.0,addr=0x4 \
&gt; -device
&gt; hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0,audiodev=audio1 \
&gt; -device virtio-balloon-pci,id=balloon0,bus=pci.0,addr=0x6 \
&gt; -msg timestamp=on
&gt; 2022-02-20T01:13:13.136602Z qemu-system-x86_64: Memory backend
&gt; 'pc.ram' not found
&gt; 2022-02-20 01:13:13.186+0000: shutting down, reason=failed
&gt; 
&gt; Again, thank you!

Michal


</body></email><email><emailId>20220222220200</emailId><senderName>Charles Polisher</senderName><senderEmail>chas@chasmo.org</senderEmail><timestampReceived>2022-02-22 22:02:00-0400</timestampReceived><subject>Re: Hugepages -- "Memory backend 'pc.ram' not found"</subject><body>


On 2/22/22 00:25, Michal Prívozník wrote:
&gt; On 2/21/22 17:12, Charles Polisher wrote:
&gt; 
&gt; Hey, please the list on CC for benefit of others, e.g. when somebody
&gt; runs into the same problem they can find the discussion in the archive.
Oops... unintentional.
&gt; &gt; On 2/21/22 01:54, Michal Prívozník wrote:
&gt; &gt; &gt; On 2/20/22 04:07, Charles Polisher wrote:
&gt; &gt; &gt; &gt; Hello,
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; After defining hugepages, as documented at
&gt; &gt; &gt; &gt; https://libvirt.org/formatdomain.html#memory-backing ,
&gt; &gt; &gt; &gt; when I start the guest, I get a dialogue
&gt; &gt; &gt; &gt; box that says:
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; Error starting domain: internal error: qemu unexpectedly
&gt; &gt; &gt; &gt; closed the monitor: 2022-02-20T01:10:36.520955Z
&gt; &gt; &gt; &gt; qemu-system-x86_64: Memory backend 'pc.ram' not found
&gt; &gt; &gt; &gt; Traceback (most recent call last):
&gt; &gt; &gt; &gt; File "/usr/share/virt-manager/virtManager/asyncjob.py", line 65,
&gt; &gt; &gt; &gt; in cb_wrapper
&gt; &gt; &gt; &gt; callback(asyncjob, *args, **kwargs)
&gt; &gt; &gt; &gt; File "/usr/share/virt-manager/virtManager/asyncjob.py", line 101,
&gt; &gt; &gt; &gt; in tmpcb
&gt; &gt; &gt; &gt; callback(*args, **kwargs)
&gt; &gt; &gt; &gt; File
&gt; &gt; &gt; &gt; "/usr/share/virt-manager/virtManager/object/libvirtobject.py", line 57,
&gt; &gt; &gt; &gt; in newfn
&gt; &gt; &gt; &gt; ret = fn(self, *args, **kwargs)
&gt; &gt; &gt; &gt; File "/usr/share/virt-manager/virtManager/object/domain.py", line
&gt; &gt; &gt; &gt; 1329, in startup
&gt; &gt; &gt; &gt; self._backend.create()
&gt; &gt; &gt; &gt; File "/usr/lib64/python3.9/site-packages/libvirt.py", line 1353,
&gt; &gt; &gt; &gt; in create
&gt; &gt; &gt; &gt; raise libvirtError('virDomainCreate() failed'
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; After backing out changes, guest starts normally.
&gt; &gt; &gt; &gt; I searched online for the error message, but found nothing useful.
&gt; &gt; &gt; &gt; The hypervisor is running libvirtd (libvirt) 7.8.0 and QEMU emulator
&gt; &gt; &gt; &gt; version 6.1.0,
&gt; &gt; &gt; &gt; both build from source. I've got plenty of hugepages available.
&gt; &gt; &gt; &gt; The domain's XML definition is attached.
&gt; &gt; &gt; Hey, can you share your domain XML and the generated cmd line? The
&gt; &gt; &gt; latter should be found in /var/log/libvirt/qemu/$domain.log
&gt; &gt; &gt; 
&gt; &gt; &gt; Thanks,
&gt; &gt; &gt; Michal
&gt; &gt; Thanks for your reply. As requested, the domain XML:
&gt; &gt; 
&gt; &gt; &lt;domain type="kvm"&gt;
&gt; &gt; &lt;name&gt;slacky-0&lt;/name&gt;
&gt; &gt; &lt;uuid&gt;4a67eb39-9b92-8b8a-97ba-7e1250d56b07&lt;/uuid&gt;
&gt; &gt; &lt;title&gt;slacky-0&lt;/title&gt;
&gt; &gt; &lt;description&gt;elided&lt;/description&gt;
&gt; &gt; &lt;memory unit="KiB"&gt;4194304&lt;/memory&gt;
&gt; &gt; &lt;currentMemory unit="KiB"&gt;4194304&lt;/currentMemory&gt;
&gt; &gt; &lt;memoryBacking&gt;
&gt; &gt; &lt;hugepages&gt;
&gt; &gt; &lt;page size="4194304" unit="KiB"/&gt;
&gt; &gt; 
&gt; &gt; This does not look correct. This is on x86_64 and there is no such size
&gt; &gt; for hugepages, only 2MiB and 1GiB.

Interesting. I had originally specified a different page size
and units (probably GiB), but "virsh edit" rewrote the value
after I completed the edit, with the result above.

&gt; &gt; &lt;/hugepages&gt;
&gt; &gt; &lt;/memoryBacking&gt;
&gt; &gt; &lt;vcpu placement="static"&gt;2&lt;/vcpu&gt;
&gt; &gt; &lt;os&gt;
&gt; &gt; &lt;type arch="x86_64" machine="pc-i440fx-5.1"&gt;hvm&lt;/type&gt;
&gt; &gt; &lt;bootmenu enable="no"/&gt;
&gt; &gt; &lt;/os&gt;
&gt; &gt; &lt;features&gt;
&gt; &gt; &lt;acpi/&gt;
&gt; &gt; &lt;apic/&gt;
&gt; &gt; &lt;pae/&gt;
&gt; &gt; &lt;/features&gt;
&gt; &gt; &lt;cpu mode="custom" match="exact" check="none"&gt;
&gt; &gt; &lt;model fallback="forbid"&gt;kvm64&lt;/model&gt;
&gt; &gt; &lt;/cpu&gt;
&gt; &gt; &lt;clock offset="utc"/&gt;
&gt; &gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
&gt; &gt; &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
&gt; &gt; &lt;on_crash&gt;restart&lt;/on_crash&gt;
&gt; &gt; &lt;devices&gt;
&gt; &gt; &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt;
&gt; &gt; &lt;disk type="file" device="cdrom"&gt;
&gt; &gt; &lt;driver name="qemu" type="raw"/&gt;
&gt; &gt; &lt;target dev="hdc" bus="ide"/&gt;
&gt; &gt; &lt;readonly/&gt;
&gt; &gt; &lt;address type="drive" controller="0" bus="1" target="0"
&gt; &gt; unit="0"/&gt;
&gt; &gt; &lt;/disk&gt;
&gt; &gt; &lt;disk type="file" device="disk"&gt;
&gt; &gt; &lt;driver name="qemu" type="qcow2" cache="writethrough"/&gt;
&gt; &gt; &lt;source file="/mnt/nvme1/VIRTUAL_MACHINES/slacky-0.qcow2"/&gt;
&gt; &gt; &lt;target dev="vda" bus="virtio"/&gt;
&gt; &gt; &lt;boot order="1"/&gt;
&gt; &gt; &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x09"
&gt; &gt; function="0x0"/&gt;
&gt; &gt; &lt;/disk&gt;
&gt; &gt; &lt;controller type="usb" index="0" model="ich9-ehci1"&gt;
&gt; &gt; &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x05"
&gt; &gt; function="0x7"/&gt;
&gt; &gt; &lt;/controller&gt;
&gt; &gt; &lt;controller type="usb" index="0" model="ich9-uhci1"&gt;
&gt; &gt; &lt;master startport="0"/&gt;
&gt; &gt; &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x05"
&gt; &gt; function="0x0" multifunction="on"/&gt;
&gt; &gt; &lt;/controller&gt;
&gt; &gt; &lt;controller type="usb" index="0" model="ich9-uhci2"&gt;
&gt; &gt; &lt;master startport="2"/&gt;
&gt; &gt; &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x05"
&gt; &gt; function="0x1"/&gt;
&gt; &gt; &lt;/controller&gt;
&gt; &gt; &lt;controller type="usb" index="0" model="ich9-uhci3"&gt;
&gt; &gt; &lt;master startport="4"/&gt;
&gt; &gt; &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x05"
&gt; &gt; function="0x2"/&gt;
&gt; &gt; &lt;/controller&gt;
&gt; &gt; &lt;controller type="ide" index="0"&gt;
&gt; &gt; &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x01"
&gt; &gt; function="0x1"/&gt;
&gt; &gt; &lt;/controller&gt;
&gt; &gt; &lt;controller type="virtio-serial" index="0"&gt;
&gt; &gt; &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x07"
&gt; &gt; function="0x0"/&gt;
&gt; &gt; &lt;/controller&gt;
&gt; &gt; &lt;controller type="scsi" index="0" model="virtio-scsi"&gt;
&gt; &gt; &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x08"
&gt; &gt; function="0x0"/&gt;
&gt; &gt; &lt;/controller&gt;
&gt; &gt; &lt;controller type="pci" index="0" model="pci-root"/&gt;
&gt; &gt; &lt;interface type="network"&gt;
&gt; &gt; &lt;mac address="52:54:00:c3:93:40"/&gt;
&gt; &gt; &lt;source network="default"/&gt;
&gt; &gt; &lt;model type="virtio"/&gt;
&gt; &gt; &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x03"
&gt; &gt; function="0x0"/&gt;
&gt; &gt; &lt;/interface&gt;
&gt; &gt; &lt;serial type="file"&gt;
&gt; &gt; &lt;source path="/tmp/myconsoleoutput.txt"/&gt;
&gt; &gt; &lt;target type="isa-serial" port="0"&gt;
&gt; &gt; &lt;model name="isa-serial"/&gt;
&gt; &gt; &lt;/target&gt;
&gt; &gt; &lt;/serial&gt;
&gt; &gt; &lt;console type="file"&gt;
&gt; &gt; &lt;source path="/tmp/myconsoleoutput.txt"/&gt;
&gt; &gt; &lt;target type="serial" port="0"/&gt;
&gt; &gt; &lt;/console&gt;
&gt; &gt; &lt;input type="tablet" bus="usb"&gt;
&gt; &gt; &lt;address type="usb" bus="0" port="1"/&gt;
&gt; &gt; &lt;/input&gt;
&gt; &gt; &lt;input type="mouse" bus="ps2"/&gt;
&gt; &gt; &lt;input type="keyboard" bus="ps2"/&gt;
&gt; &gt; &lt;graphics type="spice" autoport="yes" listen="127.0.0.1"&gt;
&gt; &gt; &lt;listen type="address" address="127.0.0.1"/&gt;
&gt; &gt; &lt;/graphics&gt;
&gt; &gt; &lt;sound model="ich9"&gt;
&gt; &gt; &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x04"
&gt; &gt; function="0x0"/&gt;
&gt; &gt; &lt;/sound&gt;
&gt; &gt; &lt;audio id="1" type="spice"/&gt;
&gt; &gt; &lt;video&gt;
&gt; &gt; &lt;model type="qxl" ram="65536" vram="65536" vgamem="16384"
&gt; &gt; heads="1" primary="yes"/&gt;
&gt; &gt; &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x02"
&gt; &gt; function="0x0"/&gt;
&gt; &gt; &lt;/video&gt;
&gt; &gt; &lt;memballoon model="virtio"&gt;
&gt; &gt; &lt;address type="pci" domain="0x0000" bus="0x00" slot="0x06"
&gt; &gt; function="0x0"/&gt;
&gt; &gt; &lt;/memballoon&gt;
&gt; &gt; &lt;/devices&gt;
&gt; &gt; &lt;/domain&gt;
&gt; &gt; 
&gt; &gt; 
&gt; &gt; And the guest log with the generated command line:
&gt; &gt; 
&gt; &gt; 2022-02-20 01:13:12.985+0000: starting up libvirt version: 7.8.0,
&gt; &gt; qemu version: 6.1.0, kernel: 5.15.19, hostname: godzilla.peecee3.com
&gt; &gt; LC_ALL=C \
&gt; &gt; PATH=/sbin:/usr/sbin:/bin:/usr/bin \
&gt; &gt; HOME=/var/lib/libvirt/qemu/domain-34-slacky-0 \
&gt; &gt; XDG_DATA_HOME=/var/lib/libvirt/qemu/domain-34-slacky-0/.local/share \
&gt; &gt; XDG_CACHE_HOME=/var/lib/libvirt/qemu/domain-34-slacky-0/.cache \
&gt; &gt; XDG_CONFIG_HOME=/var/lib/libvirt/qemu/domain-34-slacky-0/.config \
&gt; &gt; /usr/bin/qemu-system-x86_64 \
&gt; &gt; -name guest=slacky-0,process=qemu:slacky-0,debug-threads=on \
&gt; &gt; -S \
&gt; &gt; -object
&gt; &gt; '{"qom-type":"secret","id":"masterKey0","format":"raw","file":"/var/lib/libvirt/qemu/domain-34-slacky-0/master-key.aes"}'
&gt; &gt;  \
&gt; &gt; -machine
&gt; &gt; pc-i440fx-5.1,accel=kvm,usb=off,dump-guest-core=off,memory-backend=pc.ram \
&gt; So this instructs qemu to use a memory device wih id='pc.ram' as the
&gt; default/generic memory for the guest..
&gt; 
&gt; &gt; -cpu kvm64 \
&gt; &gt; -m 4096 \
&gt; &gt; -overcommit mem-lock=off \
&gt; .. but we never generate such device. Here libvirt should have generated
&gt; -object memory-backend-file,id=pc.ram,path=/hugepages/...
&gt; 
&gt; And I think I know why. Let me post a patch.
&gt; 
&gt; &gt; -smp 2,sockets=2,cores=1,threads=1 \
&gt; &gt; -uuid 4a67eb39-9b92-8b8a-97ba-7e1250d56b07 \
&gt; &gt; -no-user-config \
&gt; &gt; -nodefaults \
&gt; &gt; -chardev socket,id=charmonitor,fd=34,server=on,wait=off \
&gt; &gt; -mon chardev=charmonitor,id=monitor,mode=control \
&gt; &gt; -rtc base=utc \
&gt; &gt; -no-shutdown \
&gt; &gt; -boot menu=off,strict=on \
&gt; &gt; -device ich9-usb-ehci1,id=usb,bus=pci.0,addr=0x5.0x7 \
&gt; &gt; -device
&gt; &gt; ich9-usb-uhci1,masterbus=usb.0,firstport=0,bus=pci.0,multifunction=on,addr=0x5
&gt; &gt; \
&gt; &gt; -device
&gt; &gt; ich9-usb-uhci2,masterbus=usb.0,firstport=2,bus=pci.0,addr=0x5.0x1 \
&gt; &gt; -device
&gt; &gt; ich9-usb-uhci3,masterbus=usb.0,firstport=4,bus=pci.0,addr=0x5.0x2 \
&gt; &gt; -device virtio-scsi-pci,id=scsi0,bus=pci.0,addr=0x8 \
&gt; &gt; -device virtio-serial-pci,id=virtio-serial0,bus=pci.0,addr=0x7 \
&gt; &gt; -device ide-cd,bus=ide.1,unit=0,id=ide0-1-0 \
&gt; &gt; -blockdev
&gt; &gt; '{"driver":"file","filename":"/mnt/nvme1/VIRTUAL_MACHINES/slacky-0.qcow2","node-na \
&gt; &gt; me":"libvirt-1-storage","cache":{"direct":false,"no-flush":false},"auto-read-only":true,"discard":"unmap"}'
&gt; &gt;  \
&gt; &gt; -blockdev
&gt; &gt; '{"node-name":"libvirt-1-format","read-only":false,"cache":{"direct":false,"no-flush":false},"driver":"qcow2","file":"libvirt-1-storage","backing":null}'
&gt; &gt;  \
&gt; &gt; -device
&gt; &gt; virtio-blk-pci,bus=pci.0,addr=0x9,drive=libvirt-1-format,id=virtio-disk0,bootindex=1,write-cache=off
&gt; &gt;  \
&gt; &gt; -netdev tap,fd=58,id=hostnet0,vhost=on,vhostfd=60 \
&gt; &gt; -device
&gt; &gt; virtio-net-pci,netdev=hostnet0,id=net0,mac=52:54:00:c3:93:40,bus=pci.0,addr=0x3
&gt; &gt; \
&gt; &gt; -add-fd set=3,fd=62 \
&gt; &gt; -chardev file,id=charserial0,path=/dev/fdset/3,append=on \
&gt; &gt; -device isa-serial,chardev=charserial0,id=serial0 \
&gt; &gt; -device usb-tablet,id=input0,bus=usb.0,port=1 \
&gt; &gt; -audiodev id=audio1,driver=spice \
&gt; &gt; -spice
&gt; &gt; port=5901,addr=127.0.0.1,disable-ticketing=on,seamless-migration=on \
&gt; &gt; -device
&gt; &gt; qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=16,max_outputs=1,bus=pci.0,addr=0x2
&gt; &gt;  \
&gt; &gt; -device ich9-intel-hda,id=sound0,bus=pci.0,addr=0x4 \
&gt; &gt; -device
&gt; &gt; hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0,audiodev=audio1 \
&gt; &gt; -device virtio-balloon-pci,id=balloon0,bus=pci.0,addr=0x6 \
&gt; &gt; -msg timestamp=on
&gt; &gt; 2022-02-20T01:13:13.136602Z qemu-system-x86_64: Memory backend
&gt; &gt; 'pc.ram' not found
&gt; &gt; 2022-02-20 01:13:13.186+0000: shutting down, reason=failed
&gt; &gt; 
&gt; &gt; Again, thank you!
&gt; &gt; 
&gt; &gt; Michal
Many thanks!


</body></email><email><emailId>20220215202113</emailId><senderName>Wolf</senderName><senderEmail>ort_libvirt@bergersen.no</senderEmail><timestampReceived>2022-02-15 20:21:13-0400</timestampReceived><subject>Re: SSH VM from outside, but not from host</subject><body>

On 15 Feb 2022, at 20:04, Peter Crowther &lt;peter.crowther@melandra.com \
&lt;mailto:peter.crowther@melandra.com&gt;&gt; wrote:
&gt; 
&gt; And eno1 and eno2 are *both* connected to the same external switch, yes?

Correct, where each NIC has its ip access-list.
XX1.XX1.XX1.150 and XX2.XX2.XX2.100 are on separate NICs.

When I ping the VM, XX2.XX2.XX2.100, from the host, XX1.XX1.XX1.150, the host pings \
itself.

Thanks!

Wolf



&gt; 
&gt; On Tue, 15 Feb 2022 at 17:17, Wolf &lt;ort_libvirt@bergersen.no \
&gt; &lt;mailto:ort_libvirt@bergersen.no&gt;&gt; wrote: Hi!
&gt; 
&gt; 1) I have two network ports on my server.
&gt; -      eno1 has the IP: XX1.XX1.XX1.150
&gt; 
&gt; -      bridge0 has the IP: XX2.XX2.XX2.100
&gt; and has the interface member: port eno2.
&gt; eno2 is not set up with an IP address.
&gt; 
&gt; 2) The host runs on IP: XX1.XX1.XX1.150
&gt; 
&gt; 3) A VM uses the bridge: bridge0, and has the IP: XX2.XX2.XX2.100
&gt; 
&gt; I have a problem with this setup:
&gt; I can ssh the VM on XX2.XX2.XX2.100 from outside, but from the host, \
&gt; XX1.XX1.XX1.150, I can't ssh the VM on XX2.XX2.XX2.100. 
&gt; Have I set up this wrong or is it something I can do to solve this?
&gt; 
&gt; Thanks!
&gt; 
&gt; Wolf
&gt; 
&gt; 


[Attachment #3 (unknown)]

&lt;html&gt;&lt;head&gt;&lt;meta http-equiv="Content-Type" content="text/html; \
charset=us-ascii"&gt;&lt;/head&gt;&lt;body style="word-wrap: break-word; -webkit-nbsp-mode: \
space; line-break: after-white-space;" class=""&gt;&lt;meta http-equiv="Content-Type" \
content="text/html; charset=us-ascii" class=""&gt;&lt;div style="word-wrap: break-word; \
-webkit-nbsp-mode: space; line-break: after-white-space;" class=""&gt;On 15 Feb 2022, at \
20:04, Peter Crowther &lt;&lt;a href="mailto:peter.crowther@melandra.com" \
class=""&gt;peter.crowther@melandra.com&lt;/a&gt;&gt; wrote:&lt;br class=""&gt;&lt;div \
class=""&gt;&lt;blockquote type="cite" class=""&gt;&lt;br class="Apple-interchange-newline"&gt;&lt;div \
class=""&gt;&lt;div dir="ltr" class=""&gt;&lt;div class=""&gt;And eno1 and eno2 are *both* connected \
to the same external switch, yes?&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div class=""&gt;&lt;br \
class=""&gt;&lt;/div&gt;Correct, where each NIC has its ip access-list.&lt;/div&gt;&lt;div \
class=""&gt;&lt;div class="gmail_quote"&gt;XX1.XX1.XX1.150 and XX2.XX2.XX2.100 are on \
separate NICs.&lt;/div&gt;&lt;div class="gmail_quote"&gt;&lt;br class=""&gt;&lt;/div&gt;&lt;div \
class="gmail_quote"&gt;When I ping the VM, XX2.XX2.XX2.100, from the \
host, XX1.XX1.XX1.150, the host pings itself.&lt;/div&gt;&lt;div class="gmail_quote"&gt;&lt;br \
class=""&gt;&lt;/div&gt;&lt;div class="gmail_quote"&gt;Thanks!&lt;/div&gt;&lt;div class="gmail_quote"&gt;&lt;br \
class=""&gt;&lt;/div&gt;&lt;div class="gmail_quote"&gt;Wolf&lt;/div&gt;&lt;div class=""&gt;&lt;br \
class=""&gt;&lt;/div&gt;&lt;div class=""&gt;&lt;br class=""&gt;&lt;/div&gt;&lt;br class=""&gt;&lt;blockquote type="cite" \
class=""&gt;&lt;div class=""&gt;&lt;br class=""&gt;&lt;div class="gmail_quote"&gt;&lt;div dir="ltr" \
class="gmail_attr"&gt;On Tue, 15 Feb 2022 at 17:17, Wolf &lt;&lt;a \
href="mailto:ort_libvirt@bergersen.no" class=""&gt;ort_libvirt@bergersen.no&lt;/a&gt;&gt; \
wrote:&lt;br class=""&gt;&lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0px 0px 0px \
0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"&gt; Hi!&lt;br class=""&gt; \
&lt;br class=""&gt; 1) I have two network ports on my server.&lt;br class=""&gt;
 -      eno1 has the IP: XX1.XX1.XX1.150&lt;br class=""&gt;
&lt;br class=""&gt;
 -      bridge0 has the IP: XX2.XX2.XX2.100&lt;br class=""&gt;
        and has the interface member: port eno2.&lt;br class=""&gt;
        eno2 is not set up with an IP address.&lt;br class=""&gt;
&lt;br class=""&gt;
2) The host runs on IP: XX1.XX1.XX1.150&lt;br class=""&gt;
&lt;br class=""&gt;
3) A VM uses the bridge: bridge0, and has the IP: XX2.XX2.XX2.100&lt;br class=""&gt;
&lt;br class=""&gt;
I have a problem with this setup:&lt;br class=""&gt;
I can ssh the VM on XX2.XX2.XX2.100 from outside, but from the host, XX1.XX1.XX1.150, \
I can't ssh the VM on XX2.XX2.XX2.100.&lt;br class=""&gt; &lt;br class=""&gt;
Have I set up this wrong or is it something I can do to solve this?&lt;br class=""&gt;
&lt;br class=""&gt;
Thanks!&lt;br class=""&gt;
&lt;br class=""&gt;
Wolf&lt;br class=""&gt;
&lt;br class=""&gt;
&lt;br class=""&gt;
&lt;/blockquote&gt;&lt;/div&gt;
&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br class=""&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;



</body></email><email><emailId>20220216094010</emailId><senderName>Peter Crowther</senderName><senderEmail>peter.crowther@melandra.com</senderEmail><timestampReceived>2022-02-16 09:40:10-0400</timestampReceived><subject>Re: SSH VM from outside, but not from host</subject><body>

... hang on.  Why does the *bridge* have an IP address?  Think of a bridge
as being like a switch; it has no address of its own.

Cheers,

Peter

On Tue, 15 Feb 2022 at 20:21, Wolf &lt;ort_libvirt@bergersen.no&gt; wrote:

&gt; On 15 Feb 2022, at 20:04, Peter Crowther &lt;peter.crowther@melandra.com&gt;
&gt; wrote:
&gt;
&gt;
&gt; And eno1 and eno2 are *both* connected to the same external switch, yes?
&gt;
&gt;
&gt; Correct, where each NIC has its ip access-list.
&gt; XX1.XX1.XX1.150 and XX2.XX2.XX2.100 are on separate NICs.
&gt;
&gt; When I ping the VM, XX2.XX2.XX2.100, from the host, XX1.XX1.XX1.150, the
&gt; host pings itself.
&gt;
&gt; Thanks!
&gt;
&gt; Wolf
&gt;
&gt;
&gt;
&gt;
&gt; On Tue, 15 Feb 2022 at 17:17, Wolf &lt;ort_libvirt@bergersen.no&gt; wrote:
&gt;
&gt;&gt;  Hi!
&gt;&gt;
&gt;&gt; 1) I have two network ports on my server.
&gt;&gt;  -      eno1 has the IP: XX1.XX1.XX1.150
&gt;&gt;
&gt;&gt;  -      bridge0 has the IP: XX2.XX2.XX2.100
&gt;&gt;         and has the interface member: port eno2.
&gt;&gt;         eno2 is not set up with an IP address.
&gt;&gt;
&gt;&gt; 2) The host runs on IP: XX1.XX1.XX1.150
&gt;&gt;
&gt;&gt; 3) A VM uses the bridge: bridge0, and has the IP: XX2.XX2.XX2.100
&gt;&gt;
&gt;&gt; I have a problem with this setup:
&gt;&gt; I can ssh the VM on XX2.XX2.XX2.100 from outside, but from the host,
&gt;&gt; XX1.XX1.XX1.150, I can't ssh the VM on XX2.XX2.XX2.100.
&gt;&gt;
&gt;&gt; Have I set up this wrong or is it something I can do to solve this?
&gt;&gt;
&gt;&gt; Thanks!
&gt;&gt;
&gt;&gt; Wolf
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;&lt;div&gt;... hang on.   Why does the *bridge* have an IP address?   Think \
of a bridge as being like a switch; it has no address of its \
own.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Cheers,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Peter&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div \
class="gmail_quote"&gt;&lt;div dir="ltr" class="gmail_attr"&gt;On Tue, 15 Feb 2022 at 20:21, \
Wolf &lt;&lt;a href="mailto:ort_libvirt@bergersen.no"&gt;ort_libvirt@bergersen.no&lt;/a&gt;&gt; \
wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0px 0px 0px \
0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"&gt;&lt;div \
style="overflow-wrap: break-word;"&gt;&lt;div style="overflow-wrap: break-word;"&gt;On 15 Feb \
2022, at 20:04, Peter Crowther &lt;&lt;a href="mailto:peter.crowther@melandra.com" \
target="_blank"&gt;peter.crowther@melandra.com&lt;/a&gt;&gt; wrote:&lt;br&gt;&lt;div&gt;&lt;blockquote \
type="cite"&gt;&lt;br&gt;&lt;div&gt;&lt;div dir="ltr"&gt;&lt;div&gt;And eno1 and eno2 are *both* connected to \
the same external switch, yes?&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;Correct, \
where each NIC has its ip access-list.&lt;/div&gt;&lt;div&gt;&lt;div \
class="gmail_quote"&gt;XX1.XX1.XX1.150 and  XX2.XX2.XX2.100 are on separate \
NICs.&lt;/div&gt;&lt;div class="gmail_quote"&gt;&lt;br&gt;&lt;/div&gt;&lt;div class="gmail_quote"&gt;When I ping \
the VM,  XX2.XX2.XX2.100, from the host,  XX1.XX1.XX1.150, the host pings \
itself.&lt;/div&gt;&lt;div class="gmail_quote"&gt;&lt;br&gt;&lt;/div&gt;&lt;div \
class="gmail_quote"&gt;Thanks!&lt;/div&gt;&lt;div class="gmail_quote"&gt;&lt;br&gt;&lt;/div&gt;&lt;div \
class="gmail_quote"&gt;Wolf&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;blockquote \
type="cite"&gt;&lt;div&gt;&lt;br&gt;&lt;div class="gmail_quote"&gt;&lt;div dir="ltr" class="gmail_attr"&gt;On \
Tue, 15 Feb 2022 at 17:17, Wolf &lt;&lt;a href="mailto:ort_libvirt@bergersen.no" \
target="_blank"&gt;ort_libvirt@bergersen.no&lt;/a&gt;&gt; wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote \
class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left:1px solid \
rgb(204,204,204);padding-left:1ex"&gt;  Hi!&lt;br&gt; &lt;br&gt;
1) I have two network ports on my server.&lt;br&gt;
  -         eno1 has the IP: XX1.XX1.XX1.150&lt;br&gt;
&lt;br&gt;
  -         bridge0 has the IP: XX2.XX2.XX2.100&lt;br&gt;
            and has the interface member: port eno2.&lt;br&gt;
            eno2 is not set up with an IP address.&lt;br&gt;
&lt;br&gt;
2) The host runs on IP: XX1.XX1.XX1.150&lt;br&gt;
&lt;br&gt;
3) A VM uses the bridge: bridge0, and has the IP: XX2.XX2.XX2.100&lt;br&gt;
&lt;br&gt;
I have a problem with this setup:&lt;br&gt;
I can ssh the VM on XX2.XX2.XX2.100 from outside, but from the host, XX1.XX1.XX1.150, \
I can't ssh the VM on XX2.XX2.XX2.100.&lt;br&gt; &lt;br&gt;
Have I set up this wrong or is it something I can do to solve this?&lt;br&gt;
&lt;br&gt;
Thanks!&lt;br&gt;
&lt;br&gt;
Wolf&lt;br&gt;
&lt;br&gt;
&lt;br&gt;
&lt;/blockquote&gt;&lt;/div&gt;
&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;



</body></email><email><emailId>20220216094634</emailId><senderName>Marc</senderName><senderEmail>marc@f1-outsourcing.eu</senderEmail><timestampReceived>2022-02-16 09:46:34-0400</timestampReceived><subject>RE: SSH VM from outside, but not from host</subject><body>

&gt; 
&gt; ... hang on.  Why does the *bridge* have an IP address?  Think of a bridge
&gt; as being like a switch; it has no address of its own.
&gt; 
&gt; 

??? Depends on how you use it. 

</body></email><email><emailId>20220213223810</emailId><senderName>Tom Ammon</senderName><senderEmail>thomasammon@gmail.com</senderEmail><timestampReceived>2022-02-13 22:38:10-0400</timestampReceived><subject>Re: Public IP on virtual machine network issue</subject><body>

Can you post the output of iptables -L?

By default, the bridge module in the kernel sends packets traversing the
bridge to iptables (in the FORWARD chain I believe) for processing. So if
you have configured a DENY policy on the FORWARD chain, or are otherwise
filtering in the forward chain, you'll be affecting packets traversing the
bridge. Check out this page for details on how to change this behavior:
https://wiki.libvirt.org/page/Net.bridge.bridge-nf-call_and_sysctl.conf

Tom

On Sun, Feb 13, 2022 at 4:08 PM Marcin Groszek &lt;marcin@voipplus.net&gt; wrote:

&gt; I have been struggling with this for weeks and I was unable to find an
&gt; answer on line. Perhaps someone here can help me.
&gt;
&gt; Oracle linux 8 running virtualization:
&gt;
&gt; hardware node has a public IP address on interface bridge0 and physical
&gt; eno1 is a member of the bridge0
&gt;
&gt; a virtual OS has interface bridged to lan and source is bridge0, Ip
&gt; address of virtual OS is also a public from same class as the hardware
&gt; node.
&gt;
&gt; I can route in and out of virtual, I can ping from hardware node to
&gt; virtual and vice versa, so the routing works as it should, sort of.
&gt;
&gt; When I try tracepath or traceroute from outside to virtual I get !H on
&gt; last hup
&gt;
&gt; same result when I try to do the same form hardware node to virtual I get
&gt; !H
&gt;
&gt; Also, when I telnet (TCP) to a specific port on virtual where I have a
&gt; daemon LISTENING OR NOT I get: No route to host. Same experiment works
&gt; just fine for ssh port.
&gt;
&gt; Firewalld is not running, and I just have very basic iptables rules like
&gt; allowing external address block to ssh to hardware node and to virtual
&gt; dropping connections from all other sources
&gt;
&gt; This issue presented it self when I attempted to setup a galera node on
&gt; virtual and ports 4567 is responding but 4568 and 4444 are not, but the
&gt; daemons are running and I can clearly see lsoft showing "LISTENING"
&gt;
&gt; I capture the traffic and the tcp as well as udp are getting to the
&gt; virtual. Is there a preconfigured netfiltering that I am not aware of?
&gt;
&gt; What am I missing?
&gt;
&gt;
&gt;
&gt;
&gt; --
&gt; Best Regards:
&gt; Marcin Groszek
&gt; Business Voip Resource.
&gt; http://www.voipplus.net
&gt;
&gt;

-- 
-----------------------------------------------------------------------------
Tom Ammon
M: (737) 400-9042
thomasammon@gmail.com
-----------------------------------------------------------------------------

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;Can you post the output of iptables -L?  &lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;By \
default, the bridge module in the kernel sends packets traversing the bridge to \
iptables (in the FORWARD chain I believe) for processing. So if you have configured a \
DENY policy on the FORWARD chain, or are otherwise filtering in the forward chain, \
you'll be affecting packets traversing the bridge. Check out this page for \
details on how to change this behavior:  &lt;a \
href="https://wiki.libvirt.org/page/Net.bridge.bridge-nf-call_and_sysctl.conf"&gt;https:/ \
/wiki.libvirt.org/page/Net.bridge.bridge-nf-call_and_sysctl.conf&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Tom&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div \
class="gmail_quote"&gt;&lt;div dir="ltr" class="gmail_attr"&gt;On Sun, Feb 13, 2022 at 4:08 PM \
Marcin Groszek &lt;&lt;a href="mailto:marcin@voipplus.net"&gt;marcin@voipplus.net&lt;/a&gt;&gt; \
wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0px 0px 0px \
0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"&gt;I have been struggling \
with this for weeks and I was unable to find an &lt;br&gt; answer on line. Perhaps someone \
here can help me.&lt;br&gt; &lt;br&gt;
Oracle linux 8 running virtualization:&lt;br&gt;
&lt;br&gt;
hardware node has a public IP address on interface bridge0 and physical &lt;br&gt;
eno1 is a member of the bridge0&lt;br&gt;
&lt;br&gt;
a virtual OS has interface bridged to lan and source is bridge0, Ip &lt;br&gt;
address of virtual OS is also a public from same class as the hardware node.&lt;br&gt;
&lt;br&gt;
I can route in and out of virtual, I can ping from hardware node to &lt;br&gt;
virtual and vice versa, so the routing works as it should, sort of.&lt;br&gt;
&lt;br&gt;
When I try tracepath or traceroute from outside to virtual I get !H on &lt;br&gt;
last hup&lt;br&gt;
&lt;br&gt;
same result when I try to do the same form hardware node to virtual I get !H&lt;br&gt;
&lt;br&gt;
Also, when I telnet (TCP) to a specific port on virtual where I have a &lt;br&gt;
daemon LISTENING OR NOT I get: No route to host. Same experiment works &lt;br&gt;
just fine for ssh port.&lt;br&gt;
&lt;br&gt;
Firewalld is not running, and I just have very basic iptables rules like &lt;br&gt;
allowing external address block to ssh to hardware node and to virtual &lt;br&gt;
dropping connections from all other sources&lt;br&gt;
&lt;br&gt;
This issue presented it self when I attempted to setup a galera node on &lt;br&gt;
virtual and ports 4567 is responding but 4568 and 4444 are not, but the &lt;br&gt;
daemons are running and I can clearly see lsoft showing "LISTENING"&lt;br&gt;
&lt;br&gt;
I capture the traffic and the tcp as well as udp are getting to the &lt;br&gt;
virtual. Is there a preconfigured netfiltering that I am not aware of?&lt;br&gt;
&lt;br&gt;
What am I missing?&lt;br&gt;
&lt;br&gt;
&lt;br&gt;
&lt;br&gt;
&lt;br&gt;
-- &lt;br&gt;
Best Regards:&lt;br&gt;
Marcin Groszek&lt;br&gt;
Business Voip Resource.&lt;br&gt;
&lt;a href="http://www.voipplus.net" rel="noreferrer" \
target="_blank"&gt;http://www.voipplus.net&lt;/a&gt;&lt;br&gt; &lt;br&gt;
&lt;/blockquote&gt;&lt;/div&gt;&lt;br clear="all"&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;-- &lt;br&gt;&lt;div dir="ltr" \
class="gmail_signature"&gt;&lt;div dir="ltr"&gt;&lt;div&gt;&lt;div \
dir="ltr"&gt;-----------------------------------------------------------------------------&lt;br&gt;Tom \
Ammon&lt;br&gt;M: (737) 400-9042&lt;br&gt;&lt;a href="mailto:thomasammon@gmail.com" \
target="_blank"&gt;thomasammon@gmail.com&lt;/a&gt;&lt;br&gt;-----------------------------------------------------------------------------&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;




</body></email><email><emailId>20220214031745</emailId><senderName>Daniel Romero</senderName><senderEmail>romero.cl@gmail.com</senderEmail><timestampReceived>2022-02-14 03:17:45-0400</timestampReceived><subject>Re: Public IP on virtual machine network issue</subject><body>

Hi,

as Tom says, check iptables forward rules. Also, you can check host sysctl
ipv4/6 global and per interface rules to double check bridge forward
capabilities. Finally, check your routes on guest vm, especially the
default gw, sometimes you can receive the packet and the answer is sent
through the wrong interface because of bad routes.

Best Regards.
Daniel Romero P.



On Sun, Feb 13, 2022 at 7:39 PM Tom Ammon &lt;thomasammon@gmail.com&gt; wrote:

&gt; Can you post the output of iptables -L?
&gt;
&gt; By default, the bridge module in the kernel sends packets traversing the
&gt; bridge to iptables (in the FORWARD chain I believe) for processing. So if
&gt; you have configured a DENY policy on the FORWARD chain, or are otherwise
&gt; filtering in the forward chain, you'll be affecting packets traversing the
&gt; bridge. Check out this page for details on how to change this behavior:
&gt; https://wiki.libvirt.org/page/Net.bridge.bridge-nf-call_and_sysctl.conf
&gt;
&gt; Tom
&gt;
&gt; On Sun, Feb 13, 2022 at 4:08 PM Marcin Groszek &lt;marcin@voipplus.net&gt;
&gt; wrote:
&gt;
&gt;&gt; I have been struggling with this for weeks and I was unable to find an
&gt;&gt; answer on line. Perhaps someone here can help me.
&gt;&gt;
&gt;&gt; Oracle linux 8 running virtualization:
&gt;&gt;
&gt;&gt; hardware node has a public IP address on interface bridge0 and physical
&gt;&gt; eno1 is a member of the bridge0
&gt;&gt;
&gt;&gt; a virtual OS has interface bridged to lan and source is bridge0, Ip
&gt;&gt; address of virtual OS is also a public from same class as the hardware
&gt;&gt; node.
&gt;&gt;
&gt;&gt; I can route in and out of virtual, I can ping from hardware node to
&gt;&gt; virtual and vice versa, so the routing works as it should, sort of.
&gt;&gt;
&gt;&gt; When I try tracepath or traceroute from outside to virtual I get !H on
&gt;&gt; last hup
&gt;&gt;
&gt;&gt; same result when I try to do the same form hardware node to virtual I get
&gt;&gt; !H
&gt;&gt;
&gt;&gt; Also, when I telnet (TCP) to a specific port on virtual where I have a
&gt;&gt; daemon LISTENING OR NOT I get: No route to host. Same experiment works
&gt;&gt; just fine for ssh port.
&gt;&gt;
&gt;&gt; Firewalld is not running, and I just have very basic iptables rules like
&gt;&gt; allowing external address block to ssh to hardware node and to virtual
&gt;&gt; dropping connections from all other sources
&gt;&gt;
&gt;&gt; This issue presented it self when I attempted to setup a galera node on
&gt;&gt; virtual and ports 4567 is responding but 4568 and 4444 are not, but the
&gt;&gt; daemons are running and I can clearly see lsoft showing "LISTENING"
&gt;&gt;
&gt;&gt; I capture the traffic and the tcp as well as udp are getting to the
&gt;&gt; virtual. Is there a preconfigured netfiltering that I am not aware of?
&gt;&gt;
&gt;&gt; What am I missing?
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; --
&gt;&gt; Best Regards:
&gt;&gt; Marcin Groszek
&gt;&gt; Business Voip Resource.
&gt;&gt; http://www.voipplus.net
&gt;&gt;
&gt;&gt;
&gt;
&gt; --
&gt;
&gt; -----------------------------------------------------------------------------
&gt; Tom Ammon
&gt; M: (737) 400-9042
&gt; thomasammon@gmail.com
&gt;
&gt; -----------------------------------------------------------------------------
&gt;

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;&lt;div&gt;Hi,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;as Tom says, check iptables forward \
rules. Also, you can check host sysctl ipv4/6 global and per interface rules to \
double check bridge forward capabilities. Finally, check your routes on guest vm, \
especially the default gw, sometimes you can receive the packet and the answer is \
sent through the wrong interface because of bad \
routes.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;div dir="ltr" class="gmail_signature" \
data-smartmail="gmail_signature"&gt;Best Regards.&lt;br&gt;Daniel Romero \
P.&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div class="gmail_quote"&gt;&lt;div dir="ltr" \
class="gmail_attr"&gt;On Sun, Feb 13, 2022 at 7:39 PM Tom Ammon &lt;&lt;a \
href="mailto:thomasammon@gmail.com"&gt;thomasammon@gmail.com&lt;/a&gt;&gt; \
wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0px 0px 0px \
0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"&gt;&lt;div dir="ltr"&gt;Can you \
post the output of iptables -L?  &lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;By default, the bridge module in \
the kernel sends packets traversing the bridge to iptables (in the FORWARD chain I \
believe) for processing. So if you have configured a DENY policy on the FORWARD \
chain, or are otherwise filtering in the forward chain, you'll be affecting \
packets traversing the bridge. Check out this page for details on how to change this \
behavior:  &lt;a href="https://wiki.libvirt.org/page/Net.bridge.bridge-nf-call_and_sysctl.conf" \
target="_blank"&gt;https://wiki.libvirt.org/page/Net.bridge.bridge-nf-call_and_sysctl.conf&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Tom&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div \
class="gmail_quote"&gt;&lt;div dir="ltr" class="gmail_attr"&gt;On Sun, Feb 13, 2022 at 4:08 PM \
Marcin Groszek &lt;&lt;a href="mailto:marcin@voipplus.net" \
target="_blank"&gt;marcin@voipplus.net&lt;/a&gt;&gt; wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote \
class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left:1px solid \
rgb(204,204,204);padding-left:1ex"&gt;I have been struggling with this for weeks and I \
was unable to find an &lt;br&gt; answer on line. Perhaps someone here can help me.&lt;br&gt;
&lt;br&gt;
Oracle linux 8 running virtualization:&lt;br&gt;
&lt;br&gt;
hardware node has a public IP address on interface bridge0 and physical &lt;br&gt;
eno1 is a member of the bridge0&lt;br&gt;
&lt;br&gt;
a virtual OS has interface bridged to lan and source is bridge0, Ip &lt;br&gt;
address of virtual OS is also a public from same class as the hardware node.&lt;br&gt;
&lt;br&gt;
I can route in and out of virtual, I can ping from hardware node to &lt;br&gt;
virtual and vice versa, so the routing works as it should, sort of.&lt;br&gt;
&lt;br&gt;
When I try tracepath or traceroute from outside to virtual I get !H on &lt;br&gt;
last hup&lt;br&gt;
&lt;br&gt;
same result when I try to do the same form hardware node to virtual I get !H&lt;br&gt;
&lt;br&gt;
Also, when I telnet (TCP) to a specific port on virtual where I have a &lt;br&gt;
daemon LISTENING OR NOT I get: No route to host. Same experiment works &lt;br&gt;
just fine for ssh port.&lt;br&gt;
&lt;br&gt;
Firewalld is not running, and I just have very basic iptables rules like &lt;br&gt;
allowing external address block to ssh to hardware node and to virtual &lt;br&gt;
dropping connections from all other sources&lt;br&gt;
&lt;br&gt;
This issue presented it self when I attempted to setup a galera node on &lt;br&gt;
virtual and ports 4567 is responding but 4568 and 4444 are not, but the &lt;br&gt;
daemons are running and I can clearly see lsoft showing "LISTENING"&lt;br&gt;
&lt;br&gt;
I capture the traffic and the tcp as well as udp are getting to the &lt;br&gt;
virtual. Is there a preconfigured netfiltering that I am not aware of?&lt;br&gt;
&lt;br&gt;
What am I missing?&lt;br&gt;
&lt;br&gt;
&lt;br&gt;
&lt;br&gt;
&lt;br&gt;
-- &lt;br&gt;
Best Regards:&lt;br&gt;
Marcin Groszek&lt;br&gt;
Business Voip Resource.&lt;br&gt;
&lt;a href="http://www.voipplus.net" rel="noreferrer" \
target="_blank"&gt;http://www.voipplus.net&lt;/a&gt;&lt;br&gt; &lt;br&gt;
&lt;/blockquote&gt;&lt;/div&gt;&lt;br clear="all"&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;-- &lt;br&gt;&lt;div dir="ltr"&gt;&lt;div \
dir="ltr"&gt;&lt;div&gt;&lt;div dir="ltr"&gt;-----------------------------------------------------------------------------&lt;br&gt;Tom \
Ammon&lt;br&gt;M: (737) 400-9042&lt;br&gt;&lt;a href="mailto:thomasammon@gmail.com" \
target="_blank"&gt;thomasammon@gmail.com&lt;/a&gt;&lt;br&gt;-----------------------------------------------------------------------------&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;
 &lt;/blockquote&gt;&lt;/div&gt;



</body></email><email><emailId>20220214132947</emailId><senderName>Marcin Groszek</senderName><senderEmail>marcin@voipplus.net</senderEmail><timestampReceived>2022-02-14 13:29:47-0400</timestampReceived><subject>Re: Public IP on virtual machine network issue</subject><body>

The issue has been resolved I had a firewald running on virtual host.

Thank you for the replay.


On 2/13/2022 9:17 PM, Daniel Romero wrote:
&gt; Hi,
&gt;
&gt; as Tom says, check iptables forward rules. Also, you can check host 
&gt; sysctl ipv4/6 global and per interface rules to double check bridge 
&gt; forward capabilities. Finally, check your routes on guest vm, 
&gt; especially the default gw, sometimes you can receive the packet and 
&gt; the answer is sent through the wrong interface because of bad routes.
&gt;
&gt; Best Regards.
&gt; Daniel Romero P.
&gt;
&gt;
&gt;
&gt; On Sun, Feb 13, 2022 at 7:39 PM Tom Ammon &lt;thomasammon@gmail.com 
&gt; &lt;mailto:thomasammon@gmail.com&gt;&gt; wrote:
&gt;
&gt;     Can you post the output of iptables -L?
&gt;
&gt;     By default, the bridge module in the kernel sends packets
&gt;     traversing the bridge to iptables (in the FORWARD chain I believe)
&gt;     for processing. So if you have configured a DENY policy on the
&gt;     FORWARD chain, or are otherwise filtering in the forward chain,
&gt;     you'll be affecting packets traversing the bridge. Check out this
&gt;     page for details on how to change this behavior:
&gt;     https://wiki.libvirt.org/page/Net.bridge.bridge-nf-call_and_sysctl.conf
&gt;
&gt;     Tom
&gt;
&gt;     On Sun, Feb 13, 2022 at 4:08 PM Marcin Groszek
&gt;     &lt;marcin@voipplus.net &lt;mailto:marcin@voipplus.net&gt;&gt; wrote:
&gt;
&gt;         I have been struggling with this for weeks and I was unable to
&gt;         find an
&gt;         answer on line. Perhaps someone here can help me.
&gt;
&gt;         Oracle linux 8 running virtualization:
&gt;
&gt;         hardware node has a public IP address on interface bridge0 and
&gt;         physical
&gt;         eno1 is a member of the bridge0
&gt;
&gt;         a virtual OS has interface bridged to lan and source is
&gt;         bridge0, Ip
&gt;         address of virtual OS is also a public from same class as the
&gt;         hardware node.
&gt;
&gt;         I can route in and out of virtual, I can ping from hardware
&gt;         node to
&gt;         virtual and vice versa, so the routing works as it should,
&gt;         sort of.
&gt;
&gt;         When I try tracepath or traceroute from outside to virtual I
&gt;         get !H on
&gt;         last hup
&gt;
&gt;         same result when I try to do the same form hardware node to
&gt;         virtual I get !H
&gt;
&gt;         Also, when I telnet (TCP) to a specific port on virtual where
&gt;         I have a
&gt;         daemon LISTENING OR NOT I get: No route to host. Same
&gt;         experiment works
&gt;         just fine for ssh port.
&gt;
&gt;         Firewalld is not running, and I just have very basic iptables
&gt;         rules like
&gt;         allowing external address block to ssh to hardware node and to
&gt;         virtual
&gt;         dropping connections from all other sources
&gt;
&gt;         This issue presented it self when I attempted to setup a
&gt;         galera node on
&gt;         virtual and ports 4567 is responding but 4568 and 4444 are
&gt;         not, but the
&gt;         daemons are running and I can clearly see lsoft showing
&gt;         "LISTENING"
&gt;
&gt;         I capture the traffic and the tcp as well as udp are getting
&gt;         to the
&gt;         virtual. Is there a preconfigured netfiltering that I am not
&gt;         aware of?
&gt;
&gt;         What am I missing?
&gt;
&gt;
&gt;
&gt;
&gt;         -- 
&gt;         Best Regards:
&gt;         Marcin Groszek
&gt;         Business Voip Resource.
&gt;         http://www.voipplus.net
&gt;
&gt;
&gt;
&gt;     -- 
&gt;     -----------------------------------------------------------------------------
&gt;     Tom Ammon
&gt;     M: (737) 400-9042
&gt;     thomasammon@gmail.com &lt;mailto:thomasammon@gmail.com&gt;
&gt;     -----------------------------------------------------------------------------
&gt;
-- 
Best Regards:
Marcin Groszek
Business Voip Resource.
http://www.voipplus.net


[Attachment #3 (text/html)]

&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8"&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;p&gt;The issue has been resolved I had a firewald running on virtual
      host.&lt;/p&gt;
    &lt;p&gt;Thank you for the replay.&lt;/p&gt;
    &lt;p&gt;&lt;br&gt;
    &lt;/p&gt;
    &lt;div class="moz-cite-prefix"&gt;On 2/13/2022 9:17 PM, Daniel Romero
      wrote:&lt;br&gt;
    &lt;/div&gt;
    &lt;blockquote type="cite"
cite="mid:CACVPrdkrJMLx7PN=X+Hs+HE+tdfsVNSTDYvf7fKtHPc2RZrz_w@mail.gmail.com"&gt;
      &lt;meta http-equiv="content-type" content="text/html; charset=UTF-8"&gt;
      &lt;div dir="ltr"&gt;
        &lt;div&gt;Hi,&lt;/div&gt;
        &lt;div&gt;&lt;br&gt;
        &lt;/div&gt;
        &lt;div&gt;as Tom says, check iptables forward rules. Also, you can
          check host sysctl ipv4/6 global and per interface rules to
          double check bridge forward capabilities. Finally, check your
          routes on guest vm, especially the default gw, sometimes you
          can receive the packet and the answer is sent through the
          wrong interface because of bad routes.&lt;br&gt;
        &lt;/div&gt;
        &lt;div&gt;&lt;br&gt;
        &lt;/div&gt;
        &lt;div&gt;
          &lt;div&gt;
            &lt;div dir="ltr" class="gmail_signature"
              data-smartmail="gmail_signature"&gt;Best Regards.&lt;br&gt;
              Daniel Romero P.&lt;br&gt;
              &lt;br&gt;
            &lt;/div&gt;
          &lt;/div&gt;
          &lt;br&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;br&gt;
      &lt;div class="gmail_quote"&gt;
        &lt;div dir="ltr" class="gmail_attr"&gt;On Sun, Feb 13, 2022 at 7:39
          PM Tom Ammon &lt;&lt;a href="mailto:thomasammon@gmail.com"
            moz-do-not-send="true"&gt;thomasammon@gmail.com&lt;/a&gt;&gt; wrote:&lt;br&gt;
        &lt;/div&gt;
        &lt;blockquote class="gmail_quote" style="margin:0px 0px 0px
          0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"&gt;
          &lt;div dir="ltr"&gt;Can you post the output of iptables -L?  
            &lt;div&gt;&lt;br&gt;
            &lt;/div&gt;
            &lt;div&gt;By default, the bridge module in the kernel sends
              packets traversing the bridge to iptables (in the FORWARD
              chain I believe) for processing. So if you have configured
              a DENY policy on the FORWARD chain, or are otherwise
              filtering in the forward chain, you'll be affecting
              packets traversing the bridge. Check out this page for
              details on how to change this behavior:  &lt;a
href="https://wiki.libvirt.org/page/Net.bridge.bridge-nf-call_and_sysctl.conf"
                target="_blank" \
moz-do-not-send="true"&gt;https://wiki.libvirt.org/page/Net.bridge.bridge-nf-call_and_sysctl.conf&lt;/a&gt;&lt;/div&gt;
  &lt;div&gt;&lt;br&gt;
            &lt;/div&gt;
            &lt;div&gt;Tom&lt;/div&gt;
          &lt;/div&gt;
          &lt;br&gt;
          &lt;div class="gmail_quote"&gt;
            &lt;div dir="ltr" class="gmail_attr"&gt;On Sun, Feb 13, 2022 at
              4:08 PM Marcin Groszek &lt;&lt;a
                href="mailto:marcin@voipplus.net" target="_blank"
                moz-do-not-send="true"&gt;marcin@voipplus.net&lt;/a&gt;&gt;
              wrote:&lt;br&gt;
            &lt;/div&gt;
            &lt;blockquote class="gmail_quote" style="margin:0px 0px 0px
              0.8ex;border-left:1px solid
              rgb(204,204,204);padding-left:1ex"&gt;I have been struggling
              with this for weeks and I was unable to find an &lt;br&gt;
              answer on line. Perhaps someone here can help me.&lt;br&gt;
              &lt;br&gt;
              Oracle linux 8 running virtualization:&lt;br&gt;
              &lt;br&gt;
              hardware node has a public IP address on interface bridge0
              and physical &lt;br&gt;
              eno1 is a member of the bridge0&lt;br&gt;
              &lt;br&gt;
              a virtual OS has interface bridged to lan and source is
              bridge0, Ip &lt;br&gt;
              address of virtual OS is also a public from same class as
              the hardware node.&lt;br&gt;
              &lt;br&gt;
              I can route in and out of virtual, I can ping from
              hardware node to &lt;br&gt;
              virtual and vice versa, so the routing works as it should,
              sort of.&lt;br&gt;
              &lt;br&gt;
              When I try tracepath or traceroute from outside to virtual
              I get !H on &lt;br&gt;
              last hup&lt;br&gt;
              &lt;br&gt;
              same result when I try to do the same form hardware node
              to virtual I get !H&lt;br&gt;
              &lt;br&gt;
              Also, when I telnet (TCP) to a specific port on virtual
              where I have a &lt;br&gt;
              daemon LISTENING OR NOT I get: No route to host. Same
              experiment works &lt;br&gt;
              just fine for ssh port.&lt;br&gt;
              &lt;br&gt;
              Firewalld is not running, and I just have very basic
              iptables rules like &lt;br&gt;
              allowing external address block to ssh to hardware node
              and to virtual &lt;br&gt;
              dropping connections from all other sources&lt;br&gt;
              &lt;br&gt;
              This issue presented it self when I attempted to setup a
              galera node on &lt;br&gt;
              virtual and ports 4567 is responding but 4568 and 4444 are
              not, but the &lt;br&gt;
              daemons are running and I can clearly see lsoft showing
              "LISTENING"&lt;br&gt;
              &lt;br&gt;
              I capture the traffic and the tcp as well as udp are
              getting to the &lt;br&gt;
              virtual. Is there a preconfigured netfiltering that I am
              not aware of?&lt;br&gt;
              &lt;br&gt;
              What am I missing?&lt;br&gt;
              &lt;br&gt;
              &lt;br&gt;
              &lt;br&gt;
              &lt;br&gt;
              -- &lt;br&gt;
              Best Regards:&lt;br&gt;
              Marcin Groszek&lt;br&gt;
              Business Voip Resource.&lt;br&gt;
              &lt;a href="http://www.voipplus.net" rel="noreferrer"
                target="_blank" \
moz-do-not-send="true"&gt;http://www.voipplus.net&lt;/a&gt;&lt;br&gt;  &lt;br&gt;
            &lt;/blockquote&gt;
          &lt;/div&gt;
          &lt;br clear="all"&gt;
          &lt;div&gt;&lt;br&gt;
          &lt;/div&gt;
          -- &lt;br&gt;
          &lt;div dir="ltr"&gt;
            &lt;div dir="ltr"&gt;
              &lt;div&gt;
                &lt;div \
dir="ltr"&gt;-----------------------------------------------------------------------------&lt;br&gt;
  Tom Ammon&lt;br&gt;
                  M: (737) 400-9042&lt;br&gt;
                  &lt;a href="mailto:thomasammon@gmail.com" target="_blank"
                    moz-do-not-send="true"&gt;thomasammon@gmail.com&lt;/a&gt;&lt;br&gt;
-----------------------------------------------------------------------------&lt;/div&gt;
              &lt;/div&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/blockquote&gt;
      &lt;/div&gt;
    &lt;/blockquote&gt;
    &lt;pre class="moz-signature" cols="72"&gt;-- 
Best Regards:
Marcin Groszek
Business Voip Resource.
&lt;a class="moz-txt-link-freetext" \
href="http://www.voipplus.net"&gt;http://www.voipplus.net&lt;/a&gt;&lt;/pre&gt;  &lt;/body&gt;
&lt;/html&gt;



</body></email><email><emailId>20220214141238</emailId><senderName>Laine Stump</senderName><senderEmail>laine@redhat.com</senderEmail><timestampReceived>2022-02-14 14:12:38-0400</timestampReceived><subject>Re: Public IP on virtual machine network issue</subject><body>



On 2/13/22 5:38 PM, Tom Ammon wrote:
&gt; Can you post the output of iptables -L?
&gt; 
&gt; By default, the bridge module in the kernel sends packets traversing the 
&gt; bridge to iptables (in the FORWARD chain I believe) for processing. So 
&gt; if you have configured a DENY policy on the FORWARD chain, or are 
&gt; otherwise filtering in the forward chain, you'll be affecting packets 
&gt; traversing the bridge. Check out this page for details on how to change 
&gt; this behavior: 
&gt; https://wiki.libvirt.org/page/Net.bridge.bridge-nf-call_and_sysctl.conf 
&gt; &lt;https://wiki.libvirt.org/page/Net.bridge.bridge-nf-call_and_sysctl.conf&gt;

That information is *very* out of date; the situation has changed quite 
a lot since that was written in 2014.

Filtering of packets traversing a bridge device are now only filtered if 
the br_netfilter module is loaded, which isn't done by default. It *is* 
autoloaded if certain types of iptables rules are added(I can't remember 
the details of the type of rule though - there was a bug in iptables a 
year or so ago where autoload of br_netfilter was triggered by libvirt 
attempting to *remove* a rule of whatever type it was).

Anyway, unless "lsmod | grep br_netfilter" shows that you have 
br_netfilter loaded, this entire path is a red herring (if you do have 
it loaded, unload it, and try to figure out why it was loaded).

(Interestingly, this is the 2nd time this particular outdated page has 
come up in the last week. Has something else broken somewhere that's 
causing people to search out this page?)

&gt; 
&gt; Tom
&gt; 
&gt; On Sun, Feb 13, 2022 at 4:08 PM Marcin Groszek &lt;marcin@voipplus.net 
&gt; &lt;mailto:marcin@voipplus.net&gt;&gt; wrote:
&gt; 
&gt;     I have been struggling with this for weeks and I was unable to find an
&gt;     answer on line. Perhaps someone here can help me.
&gt; 
&gt;     Oracle linux 8 running virtualization:
&gt; 
&gt;     hardware node has a public IP address on interface bridge0 and physical
&gt;     eno1 is a member of the bridge0
&gt; 
&gt;     a virtual OS has interface bridged to lan and source is bridge0, Ip
&gt;     address of virtual OS is also a public from same class as the
&gt;     hardware node.
&gt; 
&gt;     I can route in and out of virtual, I can ping from hardware node to
&gt;     virtual and vice versa, so the routing works as it should, sort of.
&gt; 
&gt;     When I try tracepath or traceroute from outside to virtual I get !H on
&gt;     last hup
&gt; 
&gt;     same result when I try to do the same form hardware node to virtual
&gt;     I get !H
&gt; 
&gt;     Also, when I telnet (TCP) to a specific port on virtual where I have a
&gt;     daemon LISTENING OR NOT I get: No route to host. Same experiment works
&gt;     just fine for ssh port.
&gt; 
&gt;     Firewalld is not running, and I just have very basic iptables rules
&gt;     like
&gt;     allowing external address block to ssh to hardware node and to virtual
&gt;     dropping connections from all other sources
&gt; 
&gt;     This issue presented it self when I attempted to setup a galera node on
&gt;     virtual and ports 4567 is responding but 4568 and 4444 are not, but the
&gt;     daemons are running and I can clearly see lsoft showing "LISTENING"
&gt; 
&gt;     I capture the traffic and the tcp as well as udp are getting to the
&gt;     virtual. Is there a preconfigured netfiltering that I am not aware of?
&gt; 
&gt;     What am I missing?
&gt; 
&gt; 
&gt; 
&gt; 
&gt;     -- 
&gt;     Best Regards:
&gt;     Marcin Groszek
&gt;     Business Voip Resource.
&gt;     http://www.voipplus.net &lt;http://www.voipplus.net&gt;
&gt; 
&gt; 
&gt; 
&gt; -- 
&gt; -----------------------------------------------------------------------------
&gt; Tom Ammon
&gt; M: (737) 400-9042
&gt; thomasammon@gmail.com &lt;mailto:thomasammon@gmail.com&gt;
&gt; -----------------------------------------------------------------------------

</body></email><email><emailId>20220214151854</emailId><senderName>Tom Ammon</senderName><senderEmail>thomasammon@gmail.com</senderEmail><timestampReceived>2022-02-14 15:18:54-0400</timestampReceived><subject>Re: Public IP on virtual machine network issue</subject><body>

Laine,

Though I can't remember the particulars, I have a vague memory of the
sysctl settings in that article indeed solving the problem of traffic not
being forwarded on the bridge when I had configured no filtering on the
guest - hence my attempt to share what worked for me. Perhaps it would be
good to update that page. I looked around for a link to create an account
on the libvirt wiki but could find none. I'm happy to go do some more
research around the items you mentioned and add a quick note to that page
to keep from leading people astray in the future, if I could get an account
on the wiki. Do you know how I would do that?

Thanks,
Tom

On Mon, Feb 14, 2022 at 8:12 AM Laine Stump &lt;laine@redhat.com&gt; wrote:

&gt;
&gt;
&gt; On 2/13/22 5:38 PM, Tom Ammon wrote:
&gt; &gt; Can you post the output of iptables -L?
&gt; &gt;
&gt; &gt; By default, the bridge module in the kernel sends packets traversing the
&gt; &gt; bridge to iptables (in the FORWARD chain I believe) for processing. So
&gt; &gt; if you have configured a DENY policy on the FORWARD chain, or are
&gt; &gt; otherwise filtering in the forward chain, you'll be affecting packets
&gt; &gt; traversing the bridge. Check out this page for details on how to change
&gt; &gt; this behavior:
&gt; &gt; https://wiki.libvirt.org/page/Net.bridge.bridge-nf-call_and_sysctl.conf
&gt; &gt; &lt;https://wiki.libvirt.org/page/Net.bridge.bridge-nf-call_and_sysctl.conf
&gt; &gt;
&gt;
&gt; That information is *very* out of date; the situation has changed quite
&gt; a lot since that was written in 2014.
&gt;
&gt; Filtering of packets traversing a bridge device are now only filtered if
&gt; the br_netfilter module is loaded, which isn't done by default. It *is*
&gt; autoloaded if certain types of iptables rules are added(I can't remember
&gt; the details of the type of rule though - there was a bug in iptables a
&gt; year or so ago where autoload of br_netfilter was triggered by libvirt
&gt; attempting to *remove* a rule of whatever type it was).
&gt;
&gt; Anyway, unless "lsmod | grep br_netfilter" shows that you have
&gt; br_netfilter loaded, this entire path is a red herring (if you do have
&gt; it loaded, unload it, and try to figure out why it was loaded).
&gt;
&gt; (Interestingly, this is the 2nd time this particular outdated page has
&gt; come up in the last week. Has something else broken somewhere that's
&gt; causing people to search out this page?)
&gt;
&gt; &gt;
&gt; &gt; Tom
&gt; &gt;
&gt; &gt; On Sun, Feb 13, 2022 at 4:08 PM Marcin Groszek &lt;marcin@voipplus.net
&gt; &gt; &lt;mailto:marcin@voipplus.net&gt;&gt; wrote:
&gt; &gt;
&gt; &gt;     I have been struggling with this for weeks and I was unable to find
&gt; an
&gt; &gt;     answer on line. Perhaps someone here can help me.
&gt; &gt;
&gt; &gt;     Oracle linux 8 running virtualization:
&gt; &gt;
&gt; &gt;     hardware node has a public IP address on interface bridge0 and
&gt; physical
&gt; &gt;     eno1 is a member of the bridge0
&gt; &gt;
&gt; &gt;     a virtual OS has interface bridged to lan and source is bridge0, Ip
&gt; &gt;     address of virtual OS is also a public from same class as the
&gt; &gt;     hardware node.
&gt; &gt;
&gt; &gt;     I can route in and out of virtual, I can ping from hardware node to
&gt; &gt;     virtual and vice versa, so the routing works as it should, sort of.
&gt; &gt;
&gt; &gt;     When I try tracepath or traceroute from outside to virtual I get !H
&gt; on
&gt; &gt;     last hup
&gt; &gt;
&gt; &gt;     same result when I try to do the same form hardware node to virtual
&gt; &gt;     I get !H
&gt; &gt;
&gt; &gt;     Also, when I telnet (TCP) to a specific port on virtual where I have
&gt; a
&gt; &gt;     daemon LISTENING OR NOT I get: No route to host. Same experiment
&gt; works
&gt; &gt;     just fine for ssh port.
&gt; &gt;
&gt; &gt;     Firewalld is not running, and I just have very basic iptables rules
&gt; &gt;     like
&gt; &gt;     allowing external address block to ssh to hardware node and to
&gt; virtual
&gt; &gt;     dropping connections from all other sources
&gt; &gt;
&gt; &gt;     This issue presented it self when I attempted to setup a galera node
&gt; on
&gt; &gt;     virtual and ports 4567 is responding but 4568 and 4444 are not, but
&gt; the
&gt; &gt;     daemons are running and I can clearly see lsoft showing "LISTENING"
&gt; &gt;
&gt; &gt;     I capture the traffic and the tcp as well as udp are getting to the
&gt; &gt;     virtual. Is there a preconfigured netfiltering that I am not aware
&gt; of?
&gt; &gt;
&gt; &gt;     What am I missing?
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt;     --
&gt; &gt;     Best Regards:
&gt; &gt;     Marcin Groszek
&gt; &gt;     Business Voip Resource.
&gt; &gt;     http://www.voipplus.net &lt;http://www.voipplus.net&gt;
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; --
&gt; &gt;
&gt; -----------------------------------------------------------------------------
&gt; &gt; Tom Ammon
&gt; &gt; M: (737) 400-9042
&gt; &gt; thomasammon@gmail.com &lt;mailto:thomasammon@gmail.com&gt;
&gt; &gt;
&gt; -----------------------------------------------------------------------------
&gt;
&gt;

-- 
-----------------------------------------------------------------------------
Tom Ammon
M: (737) 400-9042
thomasammon@gmail.com
-----------------------------------------------------------------------------

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;Laine,  &lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Though I can't remember the \
particulars, I have a vague memory of the sysctl settings in that article indeed \
solving the problem of traffic not being forwarded on the bridge when I had \
configured no filtering on the guest - hence my attempt to share what worked for me. \
Perhaps it would be good to update that page. I looked around for a link to create an \
account on the libvirt wiki but could find none. I'm happy to go do some more \
research around  the items you mentioned  and add a quick note to that page to keep \
from leading people astray in the future, if I could get an account on the wiki. Do \
you know how I would do that?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks,  \
&lt;/div&gt;&lt;div&gt;Tom&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div class="gmail_quote"&gt;&lt;div dir="ltr" \
class="gmail_attr"&gt;On Mon, Feb 14, 2022 at 8:12 AM Laine Stump &lt;&lt;a \
href="mailto:laine@redhat.com"&gt;laine@redhat.com&lt;/a&gt;&gt; wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote \
class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left:1px solid \
rgb(204,204,204);padding-left:1ex"&gt;&lt;br&gt; &lt;br&gt;
On 2/13/22 5:38 PM, Tom Ammon wrote:&lt;br&gt;
&gt; Can you post the output of iptables -L?&lt;br&gt;
&gt; &lt;br&gt;
&gt; By default, the bridge module in the kernel sends packets traversing the &lt;br&gt;
&gt; bridge to iptables (in the FORWARD chain I believe) for processing. So &lt;br&gt;
&gt; if you have configured a DENY policy on the FORWARD chain, or are &lt;br&gt;
&gt; otherwise filtering in the forward chain, you'll be affecting packets &lt;br&gt;
&gt; traversing the bridge. Check out this page for details on how to change &lt;br&gt;
&gt; this behavior: &lt;br&gt;
&gt; &lt;a href="https://wiki.libvirt.org/page/Net.bridge.bridge-nf-call_and_sysctl.conf" \
rel="noreferrer" target="_blank"&gt;https://wiki.libvirt.org/page/Net.bridge.bridge-nf-call_and_sysctl.conf&lt;/a&gt; \
&lt;br&gt; &gt; &lt;&lt;a href="https://wiki.libvirt.org/page/Net.bridge.bridge-nf-call_and_sysctl.conf" \
rel="noreferrer" target="_blank"&gt;https://wiki.libvirt.org/page/Net.bridge.bridge-nf-call_and_sysctl.conf&lt;/a&gt;&gt;&lt;br&gt;
 &lt;br&gt;
That information is *very* out of date; the situation has changed quite &lt;br&gt;
a lot since that was written in 2014.&lt;br&gt;
&lt;br&gt;
Filtering of packets traversing a bridge device are now only filtered if &lt;br&gt;
the br_netfilter module is loaded, which isn't done by default. It *is* &lt;br&gt;
autoloaded if certain types of iptables rules are added(I can't remember &lt;br&gt;
the details of the type of rule though - there was a bug in iptables a &lt;br&gt;
year or so ago where autoload of br_netfilter was triggered by libvirt &lt;br&gt;
attempting to *remove* a rule of whatever type it was).&lt;br&gt;
&lt;br&gt;
Anyway, unless "lsmod | grep br_netfilter" shows that you have &lt;br&gt;
br_netfilter loaded, this entire path is a red herring (if you do have &lt;br&gt;
it loaded, unload it, and try to figure out why it was loaded).&lt;br&gt;
&lt;br&gt;
(Interestingly, this is the 2nd time this particular outdated page has &lt;br&gt;
come up in the last week. Has something else broken somewhere that's &lt;br&gt;
causing people to search out this page?)&lt;br&gt;
&lt;br&gt;
&gt; &lt;br&gt;
&gt; Tom&lt;br&gt;
&gt; &lt;br&gt;
&gt; On Sun, Feb 13, 2022 at 4:08 PM Marcin Groszek &lt;&lt;a \
href="mailto:marcin@voipplus.net" target="_blank"&gt;marcin@voipplus.net&lt;/a&gt; &lt;br&gt; &gt; \
&lt;mailto:&lt;a href="mailto:marcin@voipplus.net" \
target="_blank"&gt;marcin@voipplus.net&lt;/a&gt;&gt;&gt; wrote:&lt;br&gt; &gt; &lt;br&gt;
&gt;        I have been struggling with this for weeks and I was unable to find \
an&lt;br&gt; &gt;        answer on line. Perhaps someone here can help me.&lt;br&gt;
&gt; &lt;br&gt;
&gt;        Oracle linux 8 running virtualization:&lt;br&gt;
&gt; &lt;br&gt;
&gt;        hardware node has a public IP address on interface bridge0 and \
physical&lt;br&gt; &gt;        eno1 is a member of the bridge0&lt;br&gt;
&gt; &lt;br&gt;
&gt;        a virtual OS has interface bridged to lan and source is bridge0, Ip&lt;br&gt;
&gt;        address of virtual OS is also a public from same class as the&lt;br&gt;
&gt;        hardware node.&lt;br&gt;
&gt; &lt;br&gt;
&gt;        I can route in and out of virtual, I can ping from hardware node to&lt;br&gt;
&gt;        virtual and vice versa, so the routing works as it should, sort of.&lt;br&gt;
&gt; &lt;br&gt;
&gt;        When I try tracepath or traceroute from outside to virtual I get !H \
on&lt;br&gt; &gt;        last hup&lt;br&gt;
&gt; &lt;br&gt;
&gt;        same result when I try to do the same form hardware node to virtual&lt;br&gt;
&gt;        I get !H&lt;br&gt;
&gt; &lt;br&gt;
&gt;        Also, when I telnet (TCP) to a specific port on virtual where I have \
a&lt;br&gt; &gt;        daemon LISTENING OR NOT I get: No route to host. Same experiment \
works&lt;br&gt; &gt;        just fine for ssh port.&lt;br&gt;
&gt; &lt;br&gt;
&gt;        Firewalld is not running, and I just have very basic iptables rules&lt;br&gt;
&gt;        like&lt;br&gt;
&gt;        allowing external address block to ssh to hardware node and to \
virtual&lt;br&gt; &gt;        dropping connections from all other sources&lt;br&gt;
&gt; &lt;br&gt;
&gt;        This issue presented it self when I attempted to setup a galera node \
on&lt;br&gt; &gt;        virtual and ports 4567 is responding but 4568 and 4444 are not, \
but the&lt;br&gt; &gt;        daemons are running and I can clearly see lsoft showing \
"LISTENING"&lt;br&gt; &gt; &lt;br&gt;
&gt;        I capture the traffic and the tcp as well as udp are getting to the&lt;br&gt;
&gt;        virtual. Is there a preconfigured netfiltering that I am not aware \
of?&lt;br&gt; &gt; &lt;br&gt;
&gt;        What am I missing?&lt;br&gt;
&gt; &lt;br&gt;
&gt; &lt;br&gt;
&gt; &lt;br&gt;
&gt; &lt;br&gt;
&gt;        -- &lt;br&gt;
&gt;        Best Regards:&lt;br&gt;
&gt;        Marcin Groszek&lt;br&gt;
&gt;        Business Voip Resource.&lt;br&gt;
&gt;        &lt;a href="http://www.voipplus.net" rel="noreferrer" \
target="_blank"&gt;http://www.voipplus.net&lt;/a&gt; &lt;&lt;a href="http://www.voipplus.net" \
rel="noreferrer" target="_blank"&gt;http://www.voipplus.net&lt;/a&gt;&gt;&lt;br&gt; &gt; &lt;br&gt;
&gt; &lt;br&gt;
&gt; &lt;br&gt;
&gt; -- &lt;br&gt;
&gt; -----------------------------------------------------------------------------&lt;br&gt;
 &gt; Tom Ammon&lt;br&gt;
&gt; M: (737) 400-9042&lt;br&gt;
&gt; &lt;a href="mailto:thomasammon@gmail.com" target="_blank"&gt;thomasammon@gmail.com&lt;/a&gt; \
&lt;mailto:&lt;a href="mailto:thomasammon@gmail.com" \
target="_blank"&gt;thomasammon@gmail.com&lt;/a&gt;&gt;&lt;br&gt; &gt; \
-----------------------------------------------------------------------------&lt;br&gt; \
&lt;br&gt; &lt;/blockquote&gt;&lt;/div&gt;&lt;br clear="all"&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;-- &lt;br&gt;&lt;div dir="ltr" \
class="gmail_signature"&gt;&lt;div dir="ltr"&gt;&lt;div&gt;&lt;div \
dir="ltr"&gt;-----------------------------------------------------------------------------&lt;br&gt;Tom \
Ammon&lt;br&gt;M: (737) 400-9042&lt;br&gt;&lt;a href="mailto:thomasammon@gmail.com" \
target="_blank"&gt;thomasammon@gmail.com&lt;/a&gt;&lt;br&gt;-----------------------------------------------------------------------------&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;




</body></email><email><emailId>20220209115352</emailId><senderName>Peter Krempa</senderName><senderEmail>pkrempa@redhat.com</senderEmail><timestampReceived>2022-02-09 11:53:52-0400</timestampReceived><subject>Re: libvirtd daemon missing in LFS</subject><body>

On Wed, Feb 09, 2022 at 16:34:43 +0530, Sai Kiran Kumar Reddy wrote:
&gt; Hi,
&gt; 
&gt; I am Sai Kiran. I am trying to build libvirt from source on my Linux From
&gt; Scratch(LFS) system. I have successfully installed libvirt and its
&gt; dependencies. When I start virt-manager, there is a prompt in GUI saying
&gt; that "libvirtd service is not installed".  I also do not see any libvirtd
&gt; in my system. I would like to install the libvirtd service(build from
&gt; source). But I am not able to find the source code for it and also, I am
&gt; not sure about the build process for the daemon. Could you please help me
&gt; out here.

The libvirt daemon is integral part of the libvirt project so the
sources you used to build the library also contain the daemon sources.

In your instance it's most likely that you are missing a dependancy and
libvirtd was not auto-enabled. To force-enable it configure libvirt with

 '-Ddriver_libvirtd=enabled'

which should report what you are missing. Since you are using LFS you
need to ensure that you have all deps yourself.

</body></email><email><emailId>20220210043918</emailId><senderName>Sai Kiran Kumar Reddy</senderName><senderEmail>skiran@cimware.in</senderEmail><timestampReceived>2022-02-10 04:39:18-0400</timestampReceived><subject>Re: libvirtd daemon missing in LFS</subject><body>

Hi,

Thanks for your inputs. I have compiled with -Ddriver_libvirtd=enabled
option. As you have mentioned, it shows missing dependencies. Let me
install them and try to get libvirtd up and running.

Once again, thanks for your help.

On Wed, Feb 9, 2022 at 5:24 PM Peter Krempa &lt;pkrempa@redhat.com&gt; wrote:

&gt; On Wed, Feb 09, 2022 at 16:34:43 +0530, Sai Kiran Kumar Reddy wrote:
&gt; &gt; Hi,
&gt; &gt;
&gt; &gt; I am Sai Kiran. I am trying to build libvirt from source on my Linux From
&gt; &gt; Scratch(LFS) system. I have successfully installed libvirt and its
&gt; &gt; dependencies. When I start virt-manager, there is a prompt in GUI saying
&gt; &gt; that "libvirtd service is not installed".  I also do not see any libvirtd
&gt; &gt; in my system. I would like to install the libvirtd service(build from
&gt; &gt; source). But I am not able to find the source code for it and also, I am
&gt; &gt; not sure about the build process for the daemon. Could you please help me
&gt; &gt; out here.
&gt;
&gt; The libvirt daemon is integral part of the libvirt project so the
&gt; sources you used to build the library also contain the daemon sources.
&gt;
&gt; In your instance it's most likely that you are missing a dependancy and
&gt; libvirtd was not auto-enabled. To force-enable it configure libvirt with
&gt;
&gt;  '-Ddriver_libvirtd=enabled'
&gt;
&gt; which should report what you are missing. Since you are using LFS you
&gt; need to ensure that you have all deps yourself.
&gt;
&gt;

-- 
Regards,
Sai Kiran.

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;Hi,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks for your inputs. I have compiled with \
-Ddriver_libvirtd=enabled option. As you have mentioned, it shows missing \
dependencies. Let me install  them and try to get libvirtd up and \
running.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Once again, thanks for your \
help.&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div class="gmail_quote"&gt;&lt;div dir="ltr" class="gmail_attr"&gt;On \
Wed, Feb 9, 2022 at 5:24 PM Peter Krempa &lt;&lt;a \
href="mailto:pkrempa@redhat.com"&gt;pkrempa@redhat.com&lt;/a&gt;&gt; \
wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0px 0px 0px \
0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"&gt;On Wed, Feb 09, 2022 \
at 16:34:43 +0530, Sai Kiran Kumar Reddy wrote:&lt;br&gt; &gt; Hi,&lt;br&gt;
&gt; &lt;br&gt;
&gt; I am Sai Kiran. I am trying to build libvirt from source on my Linux From&lt;br&gt;
&gt; Scratch(LFS) system. I have successfully installed libvirt and its&lt;br&gt;
&gt; dependencies. When I start virt-manager, there is a prompt in GUI saying&lt;br&gt;
&gt; that "libvirtd service is not installed".   I also do not see any \
libvirtd&lt;br&gt; &gt; in my system. I would like to install the libvirtd service(build \
from&lt;br&gt; &gt; source). But I am not able to find the source code for it and also, I \
am&lt;br&gt; &gt; not sure about the build process for the daemon. Could you please help \
me&lt;br&gt; &gt; out here.&lt;br&gt;
&lt;br&gt;
The libvirt daemon is integral part of the libvirt project so the&lt;br&gt;
sources you used to build the library also contain the daemon sources.&lt;br&gt;
&lt;br&gt;
In your instance it's most likely that you are missing a dependancy and&lt;br&gt;
libvirtd was not auto-enabled. To force-enable it configure libvirt with&lt;br&gt;
&lt;br&gt;
  '-Ddriver_libvirtd=enabled'&lt;br&gt;
&lt;br&gt;
which should report what you are missing. Since you are using LFS you&lt;br&gt;
need to ensure that you have all deps yourself.&lt;br&gt;
&lt;br&gt;
&lt;/blockquote&gt;&lt;/div&gt;&lt;br clear="all"&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;-- &lt;br&gt;&lt;div dir="ltr" \
class="gmail_signature"&gt;&lt;div dir="ltr"&gt;&lt;div&gt;&lt;span \
style="color:rgb(102,102,102)"&gt;Regards,&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font \
color="#666666"&gt;Sai Kiran.&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220210062117</emailId><senderName>Sai Kiran Kumar Reddy</senderName><senderEmail>skiran@cimware.in</senderEmail><timestampReceived>2022-02-10 06:21:17-0400</timestampReceived><subject>Re: libvirtd daemon missing in LFS</subject><body>

Hi,

There was some issue with pkg-config-path. I have fixed it. I see that it
looks for wireshark and other dependencies. I get an error saying "remote
driver is required for libvirtd daemon". I am not sure what this error
means. Does it mean that I have to install wireshark or is it looking for
something else. Could you please help me out here.

On Thu, Feb 10, 2022 at 9:57 AM Sai Kiran Kumar Reddy &lt;skiran@cimware.in&gt;
wrote:

&gt; Hi,
&gt;
&gt; Thanks for your inputs. I have compiled with -Ddriver_libvirtd=enabled
&gt; option. As you have mentioned, it shows missing dependencies. Let me
&gt; install them and try to get libvirtd up and running.
&gt;
&gt; Once again, thanks for your help.
&gt;
&gt; On Wed, Feb 9, 2022 at 5:24 PM Peter Krempa &lt;pkrempa@redhat.com&gt; wrote:
&gt;
&gt;&gt; On Wed, Feb 09, 2022 at 16:34:43 +0530, Sai Kiran Kumar Reddy wrote:
&gt;&gt; &gt; Hi,
&gt;&gt; &gt;
&gt;&gt; &gt; I am Sai Kiran. I am trying to build libvirt from source on my Linux
&gt;&gt; From
&gt;&gt; &gt; Scratch(LFS) system. I have successfully installed libvirt and its
&gt;&gt; &gt; dependencies. When I start virt-manager, there is a prompt in GUI saying
&gt;&gt; &gt; that "libvirtd service is not installed".  I also do not see any
&gt;&gt; libvirtd
&gt;&gt; &gt; in my system. I would like to install the libvirtd service(build from
&gt;&gt; &gt; source). But I am not able to find the source code for it and also, I am
&gt;&gt; &gt; not sure about the build process for the daemon. Could you please help
&gt;&gt; me
&gt;&gt; &gt; out here.
&gt;&gt;
&gt;&gt; The libvirt daemon is integral part of the libvirt project so the
&gt;&gt; sources you used to build the library also contain the daemon sources.
&gt;&gt;
&gt;&gt; In your instance it's most likely that you are missing a dependancy and
&gt;&gt; libvirtd was not auto-enabled. To force-enable it configure libvirt with
&gt;&gt;
&gt;&gt;  '-Ddriver_libvirtd=enabled'
&gt;&gt;
&gt;&gt; which should report what you are missing. Since you are using LFS you
&gt;&gt; need to ensure that you have all deps yourself.
&gt;&gt;
&gt;&gt;
&gt;
&gt; --
&gt; Regards,
&gt; Sai Kiran.
&gt;


-- 
Regards,
Sai Kiran.

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;Hi,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;There was some issue with pkg-config-path. I \
have fixed it. I see that it looks for wireshark and other dependencies. I get an \
error saying "remote driver is required for libvirtd daemon". I am not sure \
what this error means. Does it mean that I have to install wireshark or is it looking \
for something else. Could you please help me out here.&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div \
class="gmail_quote"&gt;&lt;div dir="ltr" class="gmail_attr"&gt;On Thu, Feb 10, 2022 at 9:57 AM \
Sai Kiran Kumar Reddy &lt;&lt;a \
href="mailto:skiran@cimware.in"&gt;skiran@cimware.in&lt;/a&gt;&gt; wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote \
class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left:1px solid \
rgb(204,204,204);padding-left:1ex"&gt;&lt;div dir="ltr"&gt;Hi,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks for \
your inputs. I have compiled with -Ddriver_libvirtd=enabled option. As you have \
mentioned, it shows missing dependencies. Let me install  them and try to get \
libvirtd up and running.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Once again, thanks for your \
help.&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div class="gmail_quote"&gt;&lt;div dir="ltr" class="gmail_attr"&gt;On \
Wed, Feb 9, 2022 at 5:24 PM Peter Krempa &lt;&lt;a href="mailto:pkrempa@redhat.com" \
target="_blank"&gt;pkrempa@redhat.com&lt;/a&gt;&gt; wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote \
class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left:1px solid \
rgb(204,204,204);padding-left:1ex"&gt;On Wed, Feb 09, 2022 at 16:34:43 +0530, Sai Kiran \
Kumar Reddy wrote:&lt;br&gt; &gt; Hi,&lt;br&gt;
&gt; &lt;br&gt;
&gt; I am Sai Kiran. I am trying to build libvirt from source on my Linux From&lt;br&gt;
&gt; Scratch(LFS) system. I have successfully installed libvirt and its&lt;br&gt;
&gt; dependencies. When I start virt-manager, there is a prompt in GUI saying&lt;br&gt;
&gt; that "libvirtd service is not installed".   I also do not see any \
libvirtd&lt;br&gt; &gt; in my system. I would like to install the libvirtd service(build \
from&lt;br&gt; &gt; source). But I am not able to find the source code for it and also, I \
am&lt;br&gt; &gt; not sure about the build process for the daemon. Could you please help \
me&lt;br&gt; &gt; out here.&lt;br&gt;
&lt;br&gt;
The libvirt daemon is integral part of the libvirt project so the&lt;br&gt;
sources you used to build the library also contain the daemon sources.&lt;br&gt;
&lt;br&gt;
In your instance it's most likely that you are missing a dependancy and&lt;br&gt;
libvirtd was not auto-enabled. To force-enable it configure libvirt with&lt;br&gt;
&lt;br&gt;
  '-Ddriver_libvirtd=enabled'&lt;br&gt;
&lt;br&gt;
which should report what you are missing. Since you are using LFS you&lt;br&gt;
need to ensure that you have all deps yourself.&lt;br&gt;
&lt;br&gt;
&lt;/blockquote&gt;&lt;/div&gt;&lt;br clear="all"&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;-- &lt;br&gt;&lt;div dir="ltr"&gt;&lt;div \
dir="ltr"&gt;&lt;div&gt;&lt;span \
style="color:rgb(102,102,102)"&gt;Regards,&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font \
color="#666666"&gt;Sai Kiran.&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt; &lt;/blockquote&gt;&lt;/div&gt;&lt;br \
clear="all"&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;-- &lt;br&gt;&lt;div dir="ltr" class="gmail_signature"&gt;&lt;div \
dir="ltr"&gt;&lt;div&gt;&lt;span \
style="color:rgb(102,102,102)"&gt;Regards,&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font \
color="#666666"&gt;Sai Kiran.&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220210082022</emailId><senderName>Peter Krempa</senderName><senderEmail>pkrempa@redhat.com</senderEmail><timestampReceived>2022-02-10 08:20:22-0400</timestampReceived><subject>Re: libvirtd daemon missing in LFS</subject><body>

On Thu, Feb 10, 2022 at 11:39:17 +0530, Sai Kiran Kumar Reddy wrote:
&gt; Hi,
&gt; 
&gt; There was some issue with pkg-config-path. I have fixed it. I see that it
&gt; looks for wireshark and other dependencies. I get an error saying "remote
&gt; driver is required for libvirtd daemon". I am not sure what this error

So you are missing some of the dependencies needed by the remote driver
which is needed for the libvirtd daemon. Similarly to what I've
suggested before can be used for any other option.

To list full configuration of the project along with options that were
selected you can run 'meson configure' from the builddir and it will
print all options:

$ meson configure

[... snipped ... ]

  Project options            Current Value                Possible Values             \
                Description
  ---------------            -------------                ---------------             \
-----------  apparmor                   auto                         [enabled, \
disabled, auto]    apparmor support  apparmor_profiles          auto                  \
[enabled, disabled, auto]    install apparmor profiles  attr                       \
auto                         [enabled, disabled, auto]    attr support  audit         \
auto                         [enabled, disabled, auto]    audit support  \
bash_completion            auto                         [enabled, disabled, auto]    \
bash-completion support  bash_completion_dir                                          \
directory containing bash completion scripts  blkid                      auto         \
[enabled, disabled, auto]    blkid support  capng                      auto           \
[enabled, disabled, auto]    cap-ng support  ch_group                                 \
groupname to run Cloud-Hypervisor system instance as  ch_user                         \
username to run Cloud-Hypervisor system instance as  chrdev_lock_files                \
                location for UUCP style lock files for character devices
                                                                                      \
(leave empty for default paths on some platforms)  curl                       auto    \
[enabled, disabled, auto]    curl support  docdir                                     \
documentation installation directory  docs                       auto                 \
[enabled, disabled, auto]    whether to generate documentation  driver_bhyve          \
auto                         [enabled, disabled, auto]    bhyve driver  driver_ch     \
auto                         [enabled, disabled, auto]    Cloud-Hypervisor driver  \
driver_esx                 auto                         [enabled, disabled, auto]    \
esx driver  driver_hyperv              auto                         [enabled, \
disabled, auto]    Hyper-V driver  driver_interface           auto                    \
[enabled, disabled, auto]    host interface driver  driver_libvirtd            auto   \
[enabled, disabled, auto]    libvirtd driver  driver_libxl               auto         \
[enabled, disabled, auto]    libxenlight driver  driver_lxc                 auto      \
[enabled, disabled, auto]    Linux Container driver  driver_network             auto  \
[enabled, disabled, auto]    virtual network driver  driver_openvz              auto  \
[enabled, disabled, auto]    OpenVZ driver  driver_qemu                auto           \
[enabled, disabled, auto]    QEMU/KVM driver  driver_remote              auto         \
[enabled, disabled, auto]    remote driver  driver_secrets             auto           \
[enabled, disabled, auto]    local secrets management driver  driver_test             \
auto                         [enabled, disabled, auto]    test driver  driver_vbox    \
auto                         [enabled, disabled, auto]    VirtualBox XPCOMC driver  \
driver_vmware              auto                         [enabled, disabled, auto]    \
VMware driver  driver_vz                  auto                         [enabled, \
disabled, auto]    Virtuozzo driver  dtrace                     auto                  \
[enabled, disabled, auto]    use dtrace for static probing  expensive_tests           \
auto                         [enabled, disabled, auto]    set the default for \
enabling expensive tests (long

[...]


&gt; means. Does it mean that I have to install wireshark or is it looking for

No wireshark is optional, only if you want to build the dissector for
the libvirt protocol as plugin into wireshark.

&gt; something else. Could you please help me out here.

So you want -D driver_remote=enabled and -D wireshark_dissector=disabled

make sure to consult all of the options you might want.


</body></email><email><emailId>20220214092106</emailId><senderName>Sai Kiran Kumar Reddy</senderName><senderEmail>skiran@cimware.in</senderEmail><timestampReceived>2022-02-14 09:21:06-0400</timestampReceived><subject>Re: libvirtd daemon missing in LFS</subject><body>

Hi Peter,

Thanks for your inputs. I have looked at all the dependencies and built
libvirt with the appropriate dependencies enabled. I am able to run
virt-manager also, without any errors. I am trying to create a VM using
virsh. I get an error saying "domain configuration does not support video
mode qxl". Could you please let me know if it is libvirt related error or
qemu related one?

On Thu, Feb 10, 2022 at 1:50 PM Peter Krempa &lt;pkrempa@redhat.com&gt; wrote:

&gt; On Thu, Feb 10, 2022 at 11:39:17 +0530, Sai Kiran Kumar Reddy wrote:
&gt; &gt; Hi,
&gt; &gt;
&gt; &gt; There was some issue with pkg-config-path. I have fixed it. I see that it
&gt; &gt; looks for wireshark and other dependencies. I get an error saying "remote
&gt; &gt; driver is required for libvirtd daemon". I am not sure what this error
&gt;
&gt; So you are missing some of the dependencies needed by the remote driver
&gt; which is needed for the libvirtd daemon. Similarly to what I've
&gt; suggested before can be used for any other option.
&gt;
&gt; To list full configuration of the project along with options that were
&gt; selected you can run 'meson configure' from the builddir and it will
&gt; print all options:
&gt;
&gt; $ meson configure
&gt;
&gt; [... snipped ... ]
&gt;
&gt;   Project options            Current Value                Possible Values
&gt;             Description
&gt;   ---------------            -------------                ---------------
&gt;             -----------
&gt;   apparmor                   auto                         [enabled,
&gt; disabled, auto]    apparmor support
&gt;   apparmor_profiles          auto                         [enabled,
&gt; disabled, auto]    install apparmor profiles
&gt;   attr                       auto                         [enabled,
&gt; disabled, auto]    attr support
&gt;   audit                      auto                         [enabled,
&gt; disabled, auto]    audit support
&gt;   bash_completion            auto                         [enabled,
&gt; disabled, auto]    bash-completion support
&gt;   bash_completion_dir
&gt;             directory containing bash completion scripts
&gt;   blkid                      auto                         [enabled,
&gt; disabled, auto]    blkid support
&gt;   capng                      auto                         [enabled,
&gt; disabled, auto]    cap-ng support
&gt;   ch_group
&gt;              groupname to run Cloud-Hypervisor system instance as
&gt;   ch_user
&gt;             username to run Cloud-Hypervisor system instance as
&gt;   chrdev_lock_files
&gt;             location for UUCP style lock files for character devices
&gt;
&gt;              (leave empty for default paths on some platforms)
&gt;   curl                       auto                         [enabled,
&gt; disabled, auto]    curl support
&gt;   docdir
&gt;              documentation installation directory
&gt;   docs                       auto                         [enabled,
&gt; disabled, auto]    whether to generate documentation
&gt;   driver_bhyve               auto                         [enabled,
&gt; disabled, auto]    bhyve driver
&gt;   driver_ch                  auto                         [enabled,
&gt; disabled, auto]    Cloud-Hypervisor driver
&gt;   driver_esx                 auto                         [enabled,
&gt; disabled, auto]    esx driver
&gt;   driver_hyperv              auto                         [enabled,
&gt; disabled, auto]    Hyper-V driver
&gt;   driver_interface           auto                         [enabled,
&gt; disabled, auto]    host interface driver
&gt;   driver_libvirtd            auto                         [enabled,
&gt; disabled, auto]    libvirtd driver
&gt;   driver_libxl               auto                         [enabled,
&gt; disabled, auto]    libxenlight driver
&gt;   driver_lxc                 auto                         [enabled,
&gt; disabled, auto]    Linux Container driver
&gt;   driver_network             auto                         [enabled,
&gt; disabled, auto]    virtual network driver
&gt;   driver_openvz              auto                         [enabled,
&gt; disabled, auto]    OpenVZ driver
&gt;   driver_qemu                auto                         [enabled,
&gt; disabled, auto]    QEMU/KVM driver
&gt;   driver_remote              auto                         [enabled,
&gt; disabled, auto]    remote driver
&gt;   driver_secrets             auto                         [enabled,
&gt; disabled, auto]    local secrets management driver
&gt;   driver_test                auto                         [enabled,
&gt; disabled, auto]    test driver
&gt;   driver_vbox                auto                         [enabled,
&gt; disabled, auto]    VirtualBox XPCOMC driver
&gt;   driver_vmware              auto                         [enabled,
&gt; disabled, auto]    VMware driver
&gt;   driver_vz                  auto                         [enabled,
&gt; disabled, auto]    Virtuozzo driver
&gt;   dtrace                     auto                         [enabled,
&gt; disabled, auto]    use dtrace for static probing
&gt;   expensive_tests            auto                         [enabled,
&gt; disabled, auto]    set the default for enabling expensive tests (long
&gt;
&gt; [...]
&gt;
&gt;
&gt; &gt; means. Does it mean that I have to install wireshark or is it looking for
&gt;
&gt; No wireshark is optional, only if you want to build the dissector for
&gt; the libvirt protocol as plugin into wireshark.
&gt;
&gt; &gt; something else. Could you please help me out here.
&gt;
&gt; So you want -D driver_remote=enabled and -D wireshark_dissector=disabled
&gt;
&gt; make sure to consult all of the options you might want.
&gt;
&gt;

-- 
Regards,
Sai Kiran.

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;Hi Peter,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks for your inputs. I have looked at \
all the dependencies and built libvirt with the appropriate dependencies enabled. I \
am able to run virt-manager also, without any errors. I am trying to create a VM \
using virsh. I get an error saying "domain configuration does not support video \
mode qxl". Could you please let me know if it is libvirt related error or qemu \
related one?&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div class="gmail_quote"&gt;&lt;div dir="ltr" \
class="gmail_attr"&gt;On Thu, Feb 10, 2022 at 1:50 PM Peter Krempa &lt;&lt;a \
href="mailto:pkrempa@redhat.com"&gt;pkrempa@redhat.com&lt;/a&gt;&gt; \
wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0px 0px 0px \
0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"&gt;On Thu, Feb 10, 2022 \
at 11:39:17 +0530, Sai Kiran Kumar Reddy wrote:&lt;br&gt; &gt; Hi,&lt;br&gt;
&gt; &lt;br&gt;
&gt; There was some issue with pkg-config-path. I have fixed it. I see that it&lt;br&gt;
&gt; looks for wireshark and other dependencies. I get an error saying \
"remote&lt;br&gt; &gt; driver is required for libvirtd daemon". I am not sure \
what this error&lt;br&gt; &lt;br&gt;
So you are missing some of the dependencies needed by the remote driver&lt;br&gt;
which is needed for the libvirtd daemon. Similarly to what I've&lt;br&gt;
suggested before can be used for any other option.&lt;br&gt;
&lt;br&gt;
To list full configuration of the project along with options that were&lt;br&gt;
selected you can run 'meson configure' from the builddir and it will&lt;br&gt;
print all options:&lt;br&gt;
&lt;br&gt;
$ meson configure&lt;br&gt;
&lt;br&gt;
[... snipped ... ]&lt;br&gt;
&lt;br&gt;
  Project options            Current Value                Possible Values             \
                Description&lt;br&gt;
  ---------------            -------------                ---------------             \
-----------&lt;br&gt;  apparmor                   auto                         [enabled, \
disabled, auto]    apparmor support&lt;br&gt;  apparmor_profiles          auto              \
[enabled, disabled, auto]    install apparmor profiles&lt;br&gt;  attr                      \
auto                         [enabled, disabled, auto]    attr support&lt;br&gt;  audit     \
auto                         [enabled, disabled, auto]    audit support&lt;br&gt;  \
bash_completion            auto                         [enabled, disabled, auto]    \
bash-completion support&lt;br&gt;  bash_completion_dir                                      \
directory containing bash completion scripts&lt;br&gt;  blkid                      auto     \
[enabled, disabled, auto]    blkid support&lt;br&gt;  capng                      auto       \
[enabled, disabled, auto]    cap-ng support&lt;br&gt;  ch_group                             \
groupname to run Cloud-Hypervisor system instance as&lt;br&gt;  ch_user                     \
username to run Cloud-Hypervisor system instance as&lt;br&gt;  chrdev_lock_files            \
                location for UUCP style lock files for character devices&lt;br&gt;
                                                                                      \
(leave empty for default paths on some platforms)&lt;br&gt;  curl                       \
auto                         [enabled, disabled, auto]    curl support&lt;br&gt;  docdir    \
documentation installation directory&lt;br&gt;  docs                       auto             \
[enabled, disabled, auto]    whether to generate documentation&lt;br&gt;  driver_bhyve      \
auto                         [enabled, disabled, auto]    bhyve driver&lt;br&gt;  driver_ch \
auto                         [enabled, disabled, auto]    Cloud-Hypervisor driver&lt;br&gt; \
driver_esx                 auto                         [enabled, disabled, auto]    \
esx driver&lt;br&gt;  driver_hyperv              auto                         [enabled, \
disabled, auto]    Hyper-V driver&lt;br&gt;  driver_interface           auto                \
[enabled, disabled, auto]    host interface driver&lt;br&gt;  driver_libvirtd            \
auto                         [enabled, disabled, auto]    libvirtd driver&lt;br&gt;  \
driver_libxl               auto                         [enabled, disabled, auto]    \
libxenlight driver&lt;br&gt;  driver_lxc                 auto                         \
[enabled, disabled, auto]    Linux Container driver&lt;br&gt;  driver_network             \
auto                         [enabled, disabled, auto]    virtual network driver&lt;br&gt;  \
driver_openvz              auto                         [enabled, disabled, auto]    \
OpenVZ driver&lt;br&gt;  driver_qemu                auto                         [enabled, \
disabled, auto]    QEMU/KVM driver&lt;br&gt;  driver_remote              auto               \
[enabled, disabled, auto]    remote driver&lt;br&gt;  driver_secrets             auto       \
[enabled, disabled, auto]    local secrets management driver&lt;br&gt;  driver_test         \
auto                         [enabled, disabled, auto]    test driver&lt;br&gt;  \
driver_vbox                auto                         [enabled, disabled, auto]    \
VirtualBox XPCOMC driver&lt;br&gt;  driver_vmware              auto                         \
[enabled, disabled, auto]    VMware driver&lt;br&gt;  driver_vz                  auto       \
[enabled, disabled, auto]    Virtuozzo driver&lt;br&gt;  dtrace                     auto    \
[enabled, disabled, auto]    use dtrace for static probing&lt;br&gt;  expensive_tests       \
auto                         [enabled, disabled, auto]    set the default for \
enabling expensive tests (long&lt;br&gt; &lt;br&gt;
[...]&lt;br&gt;
&lt;br&gt;
&lt;br&gt;
&gt; means. Does it mean that I have to install wireshark or is it looking for&lt;br&gt;
&lt;br&gt;
No wireshark is optional, only if you want to build the dissector for&lt;br&gt;
the libvirt protocol as plugin into wireshark.&lt;br&gt;
&lt;br&gt;
&gt; something else. Could you please help me out here.&lt;br&gt;
&lt;br&gt;
So you want -D driver_remote=enabled and -D wireshark_dissector=disabled&lt;br&gt;
&lt;br&gt;
make sure to consult all of the options you might want.&lt;br&gt;
&lt;br&gt;
&lt;/blockquote&gt;&lt;/div&gt;&lt;br clear="all"&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;-- &lt;br&gt;&lt;div dir="ltr" \
class="gmail_signature"&gt;&lt;div dir="ltr"&gt;&lt;div&gt;&lt;span \
style="color:rgb(102,102,102)"&gt;Regards,&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font \
color="#666666"&gt;Sai Kiran.&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220214102100</emailId><senderName>Michal Prívozník</senderName><senderEmail>mprivozn@redhat.com</senderEmail><timestampReceived>2022-02-14 10:21:00-0400</timestampReceived><subject>Re: libvirtd daemon missing in LFS</subject><body>

On 2/14/22 10:09, Sai Kiran Kumar Reddy wrote:
&gt; Hi Peter,
&gt; 
&gt; Thanks for your inputs. I have looked at all the dependencies and built
&gt; libvirt with the appropriate dependencies enabled. I am able to run
&gt; virt-manager also, without any errors. I am trying to create a VM using
&gt; virsh. I get an error saying "domain configuration does not support
&gt; video mode qxl". Could you please let me know if it is libvirt related
&gt; error or qemu related one?

This is QEMU related and your qemu was probably build without SPICE support:

  https://www.spice-space.org/

pass --enable-spice to QEMU ./configure script. Alternatively, Gentoo
has all these dependencies recorded and maintained. So it's easier to
install.

Michal

</body></email><email><emailId>20220210101437</emailId><senderName>Jiri Denemark</senderName><senderEmail>jdenemar@redhat.com</senderEmail><timestampReceived>2022-02-10 10:14:37-0400</timestampReceived><subject>Re: qemu+ssh connections to a remote libvirt fail as ssh banner configured</subject><body>

On Thu, Feb 10, 2022 at 17:47:43 +0800, Yalan Zhang wrote:
&gt; Thank you! I tried /etc/motd, and it does not impact the libvirt connection.
&gt; Happy to learn something new!

Alternatively if you really need to run commands in .bashrc which can
potentially print some output, you can put them after a check for
interactive shell:

    if [[ $- != *i* ]] ; then
        # Shell is non-interactive.  Be done now!
        return
    fi

    echo "Interactive shell here. How are you?"

Jirka

</body></email><email><emailId>20220204092050</emailId><senderName>Peter Krempa</senderName><senderEmail>pkrempa@redhat.com</senderEmail><timestampReceived>2022-02-04 09:20:50-0400</timestampReceived><subject>Re: NVMe drive PCI passthrough and suprise hotplug</subject><body>

On Thu, Feb 03, 2022 at 23:25:05 +0000, Kalra, Ashish wrote:
&gt; [AMD Official Use Only]

Well, I hope it's okay to use it for libvirt officially too ;)

&gt; 
&gt; Hi,
&gt; I am using Fedora 33, with the following KVM, qemu and libvirt versions:

Note that Fedora 33 is already end-of-life, it would be great if you can
re-test with a more recent version

&gt; QEMU 5.1.0
&gt; libvirt 6.6.0

specifically this was released 1.5 years ago

&gt; KVM 5.14.18
&gt; 
&gt; We have done pass-through of a PCIe NVMe device to the guest running on FC33
&gt; using either virt-manager or virsh and then we do the hot-unplug of the device
&gt; while it is attached to the guest.
&gt; 
&gt; The device is no longer seen on the guest hardware device list on virt-manager
&gt; and then we hotplug the device again and we are able to use it on the Host,
&gt; but when we try to re-attach it to the guest, we get the following error message:
&gt; 
&gt; Requested operation is not valid, PCI device 0000:c4::00.0 is in use by driver QEMU,
&gt; Domain fedora 33.

[...]

Unfortunately the tracing you've done doesn't really help in seeing what
gone wrong in libvirt.

Please attach debug logs per https://www.libvirt.org/kbase/debuglogs.html

</body></email><email><emailId>20220222110915</emailId><senderName>Michal Prívozník</senderName><senderEmail>mprivozn@redhat.com</senderEmail><timestampReceived>2022-02-22 11:09:15-0400</timestampReceived><subject>Re: random but often VMs' - BUG: soft lockup</subject><body>

On 2/22/22 09:48, lejeczek wrote:
&gt; Hi guys
&gt; 
&gt; I see this often(perhaps once a day) on VMs:
&gt; 
&gt; ... watchdog: BUG: soft -lockup - CPU#1 stuck for xxXXxxs! [swapper/1:0]


I used to see these when I suspended the host with guests running. But
in your case, because of the "swapper" suffix I suspect that the host
has gone trashing and thus can't schedule vCPUs fast enough to appease
watchdog.

Michal

</body></email><email><emailId>20220222154512</emailId><senderName>Michal Prívozník</senderName><senderEmail>mprivozn@redhat.com</senderEmail><timestampReceived>2022-02-22 15:45:12-0400</timestampReceived><subject>Re: libvirtd file descriptors leaking</subject><body>

On 2/22/22 16:36, Дмитрий wrote:
&gt; # lsof -p $(cat /run/libvirtd.pid) &gt; run1
&gt; # virt-df -d kvm3586
&gt; # lsof -p $(cat /run/libvirtd.pid) &gt; run2
&gt; # diff run1 run2
&gt; 196a197
&gt;&gt; libvirtd 3618992 root   54u     unix 0xffff902dc0c58440      0t0   99330533 type=STREAM
&gt; 

I wonder whether this is the glib event loop issue I've fixed a while
ago. Symptoms look similar.


https://gitlab.com/libvirt/libvirt/-/commit/5de203f8795d96229d2663e9ea1a24fba5db38fc

Let me check if that's backported into CentOS and what versions.

Michal

</body></email><email><emailId>20220222221144</emailId><senderName></senderName><senderEmail>admin@foundryserver.com</senderEmail><timestampReceived>2022-02-22 22:11:44-0400</timestampReceived><subject>help</subject><body>

This is a multipart message in MIME format.

help


[Attachment #3 (text/html)]

&lt;html xmlns:v="urn:schemas-microsoft-com:vml" \
xmlns:o="urn:schemas-microsoft-com:office:office" \
xmlns:w="urn:schemas-microsoft-com:office:word" \
xmlns:m="http://schemas.microsoft.com/office/2004/12/omml" \
xmlns="http://www.w3.org/TR/REC-html40"&gt;&lt;head&gt;&lt;META HTTP-EQUIV="Content-Type" \
CONTENT="text/html; charset=us-ascii"&gt;&lt;meta name=Generator content="Microsoft Word 15 \
(filtered medium)"&gt;&lt;style&gt;&lt;!-- /* Font Definitions */
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
/* Style Definitions */
p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin:0cm;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;
	mso-fareast-language:EN-US;}
span.EmailStyle17
	{mso-style-type:personal-compose;
	font-family:"Calibri",sans-serif;
	color:windowtext;}
.MsoChpDefault
	{mso-style-type:export-only;
	font-family:"Calibri",sans-serif;
	mso-fareast-language:EN-US;}
@page WordSection1
	{size:612.0pt 792.0pt;
	margin:72.0pt 72.0pt 72.0pt 72.0pt;}
div.WordSection1
	{page:WordSection1;}
--&gt;&lt;/style&gt;&lt;!--[if gte mso 9]&gt;&lt;xml&gt;
&lt;o:shapedefaults v:ext="edit" spidmax="1026" /&gt;
&lt;/xml&gt;&lt;![endif]--&gt;&lt;!--[if gte mso 9]&gt;&lt;xml&gt;
&lt;o:shapelayout v:ext="edit"&gt;
&lt;o:idmap v:ext="edit" data="1" /&gt;
&lt;/o:shapelayout&gt;&lt;/xml&gt;&lt;![endif]--&gt;&lt;/head&gt;&lt;body lang=EN-CA link="#0563C1" \
vlink="#954F72" style='word-wrap:break-word'&gt;&lt;div class=WordSection1&gt;&lt;p \
class=MsoNormal&gt;&lt;span lang=EN-US&gt;help&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;



</body></email><email><emailId>20220223084348</emailId><senderName>Charles Polisher</senderName><senderEmail>chas@chasmo.org</senderEmail><timestampReceived>2022-02-23 08:43:48-0400</timestampReceived><subject>Re: Hugepages -- "Memory backend 'pc.ram' not found"</subject><body>

On 2/22/22 00:25, Michal Prívozník wrote:
&gt;&gt; And I think I know why. Let me post a patch.
I'm building a package based on the patch, will report back when it's 
tested.
Thanks again!

</body></email><email><emailId>20220224031705</emailId><senderName>Zhen Tang</senderName><senderEmail>zhetang@redhat.com</senderEmail><timestampReceived>2022-02-24 03:17:05-0400</timestampReceived><subject>domblkinfo-&gt;allocation is not equals to domstats.1-&gt;allocation for disk with &lt;slices&gt; settings</subject><body>

Hi,

I did some testing about disk with &lt;slice&gt; setting and found that the value
of domblkinfo-&gt;allocation is not same with domstats.1-&gt;allocation for disk
with &lt;slices&gt;
Env:
libvirt-8.0.0-4.el9
qemu-kvm-6.2.0-9.el9

Step:
1. prepare a image
# qemu-img create /car/lib/libvirt/images/disk-raw -f raw 100M -o
preallocation=full

2. start a guest and attach the disk
➜  ~ cat disk.xml
&lt;disk type='file' device='disk'&gt;
      &lt;driver name='qemu' type='raw' cache='none' io='native'
copy_on_read='off' discard='ignore' detect_zeroes='on'/&gt;
      &lt;source file='/var/lib/libvirt/images/disk-raw' index='1'&gt;
        &lt;slices&gt;
          &lt;slice type='storage' offset='0' size='104857600'/&gt;
        &lt;/slices&gt;
      &lt;/source&gt;
      &lt;backingStore/&gt;
      &lt;target dev='sdb' bus='scsi'/&gt;
      &lt;iotune&gt;
        &lt;total_bytes_sec&gt;10000000&lt;/total_bytes_sec&gt;
        &lt;group_name&gt;slice&lt;/group_name&gt;
      &lt;/iotune&gt;
      &lt;alias name='ua-slices'/&gt;
      &lt;address type='drive' controller='0' bus='0' target='0' unit='1'/&gt;
    &lt;/disk&gt;

3. Write some data to the slices disk in vm
(in vm) dd if=/dev/zero of=/dev/sdb bs=10M count=1

4. check *domblkinfo* and *domstats*
➜  ~ virsh domstats rhel9.0-1 --block|grep -Ei
'block.1.(allocation|capacity|physical)'
  *block.1.allocation=0*
  block.1.capacity=104857600
  block.1.physical=104865792
➜  ~
➜  ~ virsh domblkinfo rhel9.0-1 sdb|grep -Ei
'(allocation|capacity|physical)'
Capacity:       104857600
*Allocation:     104865792*
Physical:       104857600

Are these 'allocation' values expected to be equal to each other?

Thanks,
Zhen Tang

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;Hi,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I did some testing about disk with \
&lt;slice&gt; setting and found that the value of  domblkinfo-&gt;allocation is not \
same with domstats.1-&gt;allocation for disk with \
&lt;slices&gt;&lt;/div&gt;&lt;div&gt;Env:&lt;/div&gt;&lt;div&gt;libvirt-8.0.0-4.el9&lt;br&gt;&lt;/div&gt;&lt;div&gt;qemu-kvm-6.2.0-9.el9&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Step:&lt;/div&gt;&lt;div&gt;1. \
prepare a image  &lt;/div&gt;&lt;div&gt;# qemu-img create /car/lib/libvirt/images/disk-raw -f raw \
100M -o preallocation=full&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;2. start a guest and attach \
the disk&lt;/div&gt;&lt;div&gt;➜   ~ cat disk.xml &lt;br&gt;&lt;disk type='file' \
device='disk'&gt;&lt;br&gt;         &lt;driver name='qemu' \
type='raw' cache='none' io='native' \
copy_on_read='off' discard='ignore' \
detect_zeroes='on'/&gt;&lt;br&gt;         &lt;source \
file='/var/lib/libvirt/images/disk-raw' index='1'&gt;&lt;br&gt;            \
&lt;slices&gt;&lt;br&gt;               &lt;slice type='storage' offset='0' \
size='104857600'/&gt;&lt;br&gt;            &lt;/slices&gt;&lt;br&gt;         \
&lt;/source&gt;&lt;br&gt;         &lt;backingStore/&gt;&lt;br&gt;         &lt;target \
dev='sdb' bus='scsi'/&gt;&lt;br&gt;         &lt;iotune&gt;&lt;br&gt;            \
&lt;total_bytes_sec&gt;10000000&lt;/total_bytes_sec&gt;&lt;br&gt;            \
&lt;group_name&gt;slice&lt;/group_name&gt;&lt;br&gt;         &lt;/iotune&gt;&lt;br&gt;         \
&lt;alias name='ua-slices'/&gt;&lt;br&gt;         &lt;address type='drive' \
controller='0' bus='0' target='0' unit='1'/&gt;&lt;br&gt;   \
&lt;/disk&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;3. Write some data to the slices disk in \
vm&lt;/div&gt;(in vm) dd if=/dev/zero of=/dev/sdb bs=10M count=1&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;4. \
check  &lt;b&gt;domblkinfo&lt;/b&gt; and &lt;b&gt;domstats&lt;/b&gt;&lt;br&gt;&lt;div&gt;➜   ~ virsh domstats rhel9.0-1 \
--block|grep -Ei 'block.1.(allocation|capacity|physical)'&lt;br&gt;   \
&lt;b&gt;block.1.allocation=0&lt;/b&gt;&lt;br&gt;   block.1.capacity=104857600&lt;br&gt;   \
block.1.physical=104865792&lt;br&gt;➜   ~ &lt;br&gt;➜   ~ virsh domblkinfo rhel9.0-1 sdb|grep \
-Ei '(allocation|capacity|physical)'&lt;br&gt;Capacity:          \
104857600&lt;br&gt;&lt;b&gt;Allocation:       104865792&lt;/b&gt;&lt;br&gt;Physical:          \
104857600&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Are these 'allocation' values \
expected to be equal to each other?  &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks,&lt;/div&gt;&lt;div&gt;Zhen \
Tang&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220225162023</emailId><senderName>Laine Stump</senderName><senderEmail>laine@redhat.com</senderEmail><timestampReceived>2022-02-25 16:20:23-0400</timestampReceived><subject>Re: networking question</subject><body>



On 2/25/22 11:05 AM, Martin Kletzander wrote:
&gt; On Thu, Feb 24, 2022 at 07:07:18PM +0100, Natxo Asenjo wrote:
&gt;&gt; hi,
&gt;&gt;
&gt;&gt; I have an issue with one host at a customer's site. I think this cannot
&gt;&gt; work, but I would like to ask you just in case I am confused.
&gt;&gt;
&gt;&gt; host:
&gt;&gt; eno1: 172.20.10.x/24 management interface gw 172.20.10.254
&gt;&gt; bridge-service: 0.0.0.0/24

I may be misunderstanding this "freehand" description of your setup, but 
it sounds like you have a Linux host bridge device that is attached to 
eno1 and to a VM (via a tap device), and that the bridge device has no 
IP address, but the host's ethernet device *does* have an IP address 
configured. I haven't ever tried the setup this way, but I do know that 
normally you should have *no IP* on the ethernet device, and an IP on 
the bridge device (every set of instructions I've ever seen for adding a 
bridge to an ethernet have included the step of "move the ethernet IP 
config over to the bridge device config").

If the config actually does have IP address on the ethernet but not on 
the bridge, try swapping that.



&gt;&gt; tun0: openvpn tunnel to external data center
&gt;&gt; internal-bridge: x.x.x.x/28 ; routed subnet that goes to openvpn tun0
&gt;&gt;
&gt;&gt; on vm:
&gt;&gt; eth0: x.x.x.x/28 on internal-bridge (default gw)
&gt;&gt; eth1: 172.20.10.x/24 bridge-service gw 172.20.10.254 (same as eno1)
&gt;&gt;
&gt;&gt; Connectivity to and from openvpn (from and to datacenter) is perfect. All
&gt;&gt; vms are directly reachable from our management services, no natting.
&gt;&gt;
&gt;&gt;&gt; From hypervisor I can ping the gw, from vm I cannot ping 172.20.10.254.
&gt;&gt;
&gt;&gt; My gut feeling is that this cannot work because traffic for the 
&gt;&gt; hypervisor
&gt;&gt; for subnet 172.20.10.x/24 flows through eno1, but for vm through the
&gt;&gt; bridge-loggin interface. So that cannot work.
&gt;&gt;
&gt; 
&gt; I am not sure, but I would try to see where the packets are really going
&gt; through by using wireshark/tshark or tcpdump.
&gt; 
&gt; The only thing that I can come up on the spot is that it is trying to go
&gt; through different interface at some point due to reverse path filtering,
&gt; settings for that are in /proc/sys/net/ipv4/conf/*/rp_filter, it might
&gt; be routed elsewhere anywhere along the way.  But it is hard to say
&gt; without knowing how all the networks are connected.  Maybe I'm just bad
&gt; at understanding your situation, for me it is usually better to see this
&gt; stuff happen in wireshark.  But I figured I at least let know know one
&gt; idea which we had an issue before as well.
&gt; 
&gt; Hope that helps,
&gt; Martin
&gt; 
&gt;&gt; Should we just ask the customer to give us different subnets for the host
&gt;&gt; and the vm?
&gt;&gt;
&gt;&gt; TIA.
&gt;&gt; -- 
&gt;&gt; regards,
&gt;&gt; Natxo

</body></email><email><emailId>20220227100841</emailId><senderName>lejeczek</senderName><senderEmail>peljasz@yahoo.co.uk</senderEmail><timestampReceived>2022-02-27 10:08:41-0400</timestampReceived><subject>virtio 3d acceleration - centOS 9 - ?</subject><body>

Hi guys

Would anybody know if RHEL &amp; all involved gangs plan or think to have 
c9, when is GA, offer/support 3d virtio?

many thanks, L.

</body></email><email><emailId>20220228075113</emailId><senderName>"M, Shivakumar"</senderName><senderEmail>shivakumar.m@intel.com</senderEmail><timestampReceived>2022-02-28 07:51:13-0400</timestampReceived><subject>QEMU  args generation order with libvirt</subject><body>

Hello,

We are trying to bring up the Android VM with Libvirt, as part of this exer=
cise it is advised to keep Replay Protected Memory Block (RPMB) device as t=
he first virtio device in the QEMU arg list, as the secure storage daemon i=
n Andriod side communicates with dev/vport0p1 for RPMB usage.

Is there any way we can make a qemu commands generation in particular order=
 with Libvirt XML ?

Thanks,
Shivakumar M

[Attachment #3 (text/html)]

&lt;html xmlns:v="urn:schemas-microsoft-com:vml" \
xmlns:o="urn:schemas-microsoft-com:office:office" \
xmlns:w="urn:schemas-microsoft-com:office:word" \
xmlns:m="http://schemas.microsoft.com/office/2004/12/omml" \
xmlns="http://www.w3.org/TR/REC-html40"&gt; &lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=us-ascii"&gt;
&lt;meta name="Generator" content="Microsoft Word 15 (filtered medium)"&gt;
&lt;style&gt;&lt;!--
/* Font Definitions */
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
/* Style Definitions */
p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin:0in;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
span.EmailStyle17
	{mso-style-type:personal-compose;
	font-family:"Calibri",sans-serif;
	color:windowtext;}
.MsoChpDefault
	{mso-style-type:export-only;}
@page WordSection1
	{size:8.5in 11.0in;
	margin:1.0in 1.0in 1.0in 1.0in;}
div.WordSection1
	{page:WordSection1;}
--&gt;&lt;/style&gt;&lt;!--[if gte mso 9]&gt;&lt;xml&gt;
&lt;o:shapedefaults v:ext="edit" spidmax="1026" /&gt;
&lt;/xml&gt;&lt;![endif]--&gt;&lt;!--[if gte mso 9]&gt;&lt;xml&gt;
&lt;o:shapelayout v:ext="edit"&gt;
&lt;o:idmap v:ext="edit" data="1" /&gt;
&lt;/o:shapelayout&gt;&lt;/xml&gt;&lt;![endif]--&gt;
&lt;/head&gt;
&lt;body lang="EN-US" link="#0563C1" vlink="#954F72" style="word-wrap:break-word"&gt;
&lt;div class="WordSection1"&gt;
&lt;p class="MsoNormal"&gt;Hello,&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;We are trying to bring up the Android VM with Libvirt, as part \
of this exercise it is advised to keep Replay Protected Memory Block (RPMB) device as \
the first virtio device in the QEMU arg list, as the secure storage daemon in Andriod \
side  communicates with dev/vport0p1 for RPMB usage. &lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;Is there any way we can make a qemu commands generation in \
particular order with Libvirt XML ?&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p \
class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;Thanks,&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;Shivakumar M&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;



</body></email><email><emailId>20220228092044</emailId><senderName>Michal Prívozník</senderName><senderEmail>mprivozn@redhat.com</senderEmail><timestampReceived>2022-02-28 09:20:44-0400</timestampReceived><subject>Re: QEMU args generation order with libvirt</subject><body>

On 2/28/22 08:51, M, Shivakumar wrote:
&gt; Hello,
&gt; 
&gt;  
&gt; 
&gt; We are trying to bring up the Android VM with Libvirt, as part of this
&gt; exercise it is advised to keep Replay Protected Memory Block (RPMB)
&gt; device as the first virtio device in the QEMU arg list, as the secure
&gt; storage daemon in Andriod side communicates with dev/vport0p1 for RPMB
&gt; usage.
&gt; 
&gt;  
&gt; 
&gt; Is there any way we can make a qemu commands generation in particular
&gt; order with Libvirt XML ?

Unfortunately no. While libvirt allows passing arbitrary cmd line
arguments (https://libvirt.org/kbase/qemu-passthrough-security.html)
these are appended only after libvirt generated part.

Michal

</body></email><email><emailId>20220104104608</emailId><senderName>Daniel =?utf-8?B?UC4gQmVycmFuZ8Op?=</senderName><senderEmail>berrange@redhat.com</senderEmail><timestampReceived>2022-01-04 10:46:08-0400</timestampReceived><subject>Re: Best way to install guest when it is not listed in output of osinfo-query os</subject><body>

On Tue, Dec 21, 2021 at 02:19:50PM +0100, john doe wrote:
&gt; On 12/21/2021 10:41 AM, Andrea Bolognani wrote:
&gt; &gt; On Mon, Dec 20, 2021 at 10:59:15PM +0100, Martin Kletzander wrote:
&gt; &gt; &gt; Any reason for debian not having an -unknown version like lot of the
&gt; &gt; &gt; other distros?
&gt; &gt; 
&gt; &gt; I don't think there's a specific reason for that, it's probably just
&gt; &gt; a matter of nobody thinking of it until now :)
&gt; &gt; 
&gt; &gt; In addition to that, considering that there already entries for
&gt; &gt; Debian testing and Fedora Rawhide, adding one for Debian unstable
&gt; &gt; might make sense too.
&gt; &gt; 
&gt; 
&gt; That would be lovely if 'debian-unknown' and 'debian11' could be
&gt; available on Bullseye!!! :)
&gt; 
&gt; Is it intentional that the Debian URLs in the output of 'osinfo-query
&gt; os' point to 'debian.org/debian/VERSION_ID' instead of
&gt; 'debian.org/releases/VERSION_ID|VERSION_CODENAME'?

The URLs are not a pointer to any specific resource. They are just an
arbitrarily invented unique identifier &amp; once released, we must never
change any URL. By convention we pick a short "product name" as the
first path component, because over time vendors have introduced new
or parallel products. Thus '/releases/' would not be future proof.

As an example, Fedora has both the traditional 'fedora' OS releases
and 'silverblue'.


Regards,
Daniel
-- 
|: https://berrange.com      -o-    https://www.flickr.com/photos/dberrange :|
|: https://libvirt.org         -o-            https://fstop138.berrange.com :|
|: https://entangle-photo.org    -o-    https://www.instagram.com/dberrange :|

</body></email><email><emailId>20220105031125</emailId><senderName>Tom Ammon</senderName><senderEmail>thomasammon@gmail.com</senderEmail><timestampReceived>2022-01-05 03:11:25-0400</timestampReceived><subject>Re: simulating multiple hypervisors with the test driver</subject><body>

Daniel,

That got me up and running quickly. The examples were easy to follow, all I
had to do was read a couple of the xml documents to figure out how to get
what I was after. Thank you, and the rest of the people working on the
project, for all the effort you've put into libvirt!

Tom

On Tue, Jan 4, 2022 at 4:56 AM Daniel P. Berrangé &lt;berrange@redhat.com&gt;
wrote:

&gt; On Mon, Jan 03, 2022 at 09:06:35PM -0600, Tom Ammon wrote:
&gt; &gt; Hello,
&gt; &gt;
&gt; &gt; I'm working on a python application that will manage multiple remote
&gt; &gt; libvirt hypervisors. I've been using the test:///default uri for
&gt; &gt; single-hypervisor tests, and it works great.
&gt; &gt;
&gt; &gt; I'd like to simulate connecting to two different remote hypervisors,
&gt; &gt; however, in my testing so far it appears that multiple connections to the
&gt; &gt; test:///default uri just look like different connections to the same
&gt; &gt; hypervisor. Here's what I tried :
&gt;
&gt; Yes, the test:///default URI is shared process-global state.
&gt;
&gt; &gt; What I would like is to be able to spin up two completely independent
&gt; &gt; instances of the test driver so that it can simulate two different
&gt; &gt; hypervisors/instances of libvirtd.
&gt;
&gt; Pass in a path to a custom XML file for the connection
&gt;
&gt; eg:
&gt;
&gt;    test:///path/to/checkout/of/libvirt.git/examples/xml/test/testnode.xml
&gt;
&gt; every instance of a file base URL will be unique. See this example
&gt; file for guidance on how to write the XML to pre-populate arbitrary
&gt; resources
&gt;
&gt; Regards,
&gt; Daniel
&gt; --
&gt; |: https://berrange.com      -o-
&gt; https://www.flickr.com/photos/dberrange :|
&gt; |: https://libvirt.org         -o-
&gt; https://fstop138.berrange.com :|
&gt; |: https://entangle-photo.org    -o-
&gt; https://www.instagram.com/dberrange :|
&gt;
&gt;

-- 
-----------------------------------------------------------------------------
Tom Ammon
M: (737) 400-9042
thomasammon@gmail.com
-----------------------------------------------------------------------------

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;Daniel,  &lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;That got me up and running quickly. The \
examples were easy to follow, all I had to do was read a couple of the xml documents \
to figure out how to get what I was after. Thank you, and the rest of the people \
working on the project, for all the effort you've put into \
libvirt!&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Tom&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div class="gmail_quote"&gt;&lt;div \
dir="ltr" class="gmail_attr"&gt;On Tue, Jan 4, 2022 at 4:56 AM Daniel P. Berrangé \
&lt;&lt;a href="mailto:berrange@redhat.com"&gt;berrange@redhat.com&lt;/a&gt;&gt; \
wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0px 0px 0px \
0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"&gt;On Mon, Jan 03, 2022 \
at 09:06:35PM -0600, Tom Ammon wrote:&lt;br&gt; &gt; Hello,&lt;br&gt;
&gt; &lt;br&gt;
&gt; I'm working on a python application that will manage multiple remote&lt;br&gt;
&gt; libvirt hypervisors. I've been using the test:///default uri for&lt;br&gt;
&gt; single-hypervisor tests, and it works great.&lt;br&gt;
&gt; &lt;br&gt;
&gt; I'd like to simulate connecting to two different remote hypervisors,&lt;br&gt;
&gt; however, in my testing so far it appears that multiple connections to the&lt;br&gt;
&gt; test:///default uri just look like different connections to the same&lt;br&gt;
&gt; hypervisor. Here's what I tried :&lt;br&gt;
&lt;br&gt;
Yes, the test:///default URI is shared process-global state.&lt;br&gt;
&lt;br&gt;
&gt; What I would like is to be able to spin up two completely independent&lt;br&gt;
&gt; instances of the test driver so that it can simulate two different&lt;br&gt;
&gt; hypervisors/instances of libvirtd.&lt;br&gt;
&lt;br&gt;
Pass in a path to a custom XML file for the connection&lt;br&gt;
&lt;br&gt;
eg:&lt;br&gt;
&lt;br&gt;
     test:///path/to/checkout/of/libvirt.git/examples/xml/test/testnode.xml&lt;br&gt;
&lt;br&gt;
every instance of a file base URL will be unique. See this example&lt;br&gt;
file for guidance on how to write the XML to pre-populate arbitrary&lt;br&gt;
resources&lt;br&gt;
&lt;br&gt;
Regards,&lt;br&gt;
Daniel&lt;br&gt;
-- &lt;br&gt;
&gt; &gt; &lt;a href="https://berrange.com" rel="noreferrer" \
&gt; &gt; target="_blank"&gt;https://berrange.com&lt;/a&gt;         -o-      &lt;a \
&gt; &gt; href="https://www.flickr.com/photos/dberrange" rel="noreferrer" \
&gt; &gt; target="_blank"&gt;https://www.flickr.com/photos/dberrange&lt;/a&gt; :|&lt;br&gt;
&gt; &gt; &lt;a href="https://libvirt.org" rel="noreferrer" \
&gt; &gt; target="_blank"&gt;https://libvirt.org&lt;/a&gt;              -o-                  &lt;a \
&gt; &gt; href="https://fstop138.berrange.com" rel="noreferrer" \
&gt; &gt; target="_blank"&gt;https://fstop138.berrange.com&lt;/a&gt; :|&lt;br&gt;
&gt; &gt; &lt;a href="https://entangle-photo.org" rel="noreferrer" \
&gt; &gt; target="_blank"&gt;https://entangle-photo.org&lt;/a&gt;      -o-      &lt;a \
&gt; &gt; href="https://www.instagram.com/dberrange" rel="noreferrer" \
&gt; &gt; target="_blank"&gt;https://www.instagram.com/dberrange&lt;/a&gt; :|&lt;br&gt;
&lt;br&gt;
&lt;/blockquote&gt;&lt;/div&gt;&lt;br clear="all"&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;-- &lt;br&gt;&lt;div dir="ltr" \
class="gmail_signature"&gt;&lt;div dir="ltr"&gt;&lt;div&gt;&lt;div \
dir="ltr"&gt;-----------------------------------------------------------------------------&lt;br&gt;Tom \
Ammon&lt;br&gt;M: (737) 400-9042&lt;br&gt;&lt;a href="mailto:thomasammon@gmail.com" \
target="_blank"&gt;thomasammon@gmail.com&lt;/a&gt;&lt;br&gt;-----------------------------------------------------------------------------&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;




</body></email><email><emailId>20220105144016</emailId><senderName>Gianluca Cecchi</senderName><senderEmail>gianluca.cecchi@gmail.com</senderEmail><timestampReceived>2022-01-05 14:40:16-0400</timestampReceived><subject>Re: Allow unsafe migration - ?</subject><body>

On Wed, Jan 5, 2022 at 2:25 PM lejeczek &lt;peljasz@yahoo.co.uk&gt; wrote:

&gt;
&gt; I think there is a quite urgent problem needing a repair
&gt; fast, I described it here:
&gt; https://bugzilla.redhat.com/show_bug.cgi?id=2037218
&gt; I was hoping, perhaps over-optimistically, for something I
&gt; could try as a 'quick' workaround.
&gt;
&gt; thanks, L.
&gt;
&gt;
I think GlusterFS usage in pacemaker clusters is not so common (eg, I don't
know if it is supported at all in RH EL clusters).
It is not so clear to me if you configured GlusterFS outside of pacemaker
or not: in fact through a quick search I found both types of attempts
around...
Probably inside the bugzilla you should precisely outline your
configuration and in case of embedding GlusterFS as a resource, what is you
pacemaker configuration, so how your configured your resources/clones (eg
ocf:glusterfs:glusterd, ocf:glusterfs:volume, ecc..), so that it easily
reproducible
Personally I never used GlusterFS with Pacemaker

Gianluca

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;&lt;div class="gmail_quote"&gt;&lt;div dir="ltr" class="gmail_attr"&gt;On Wed, Jan \
5, 2022 at 2:25 PM lejeczek &lt;&lt;a \
href="mailto:peljasz@yahoo.co.uk"&gt;peljasz@yahoo.co.uk&lt;/a&gt;&gt; \
wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0px 0px 0px \
0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"&gt;&lt;br&gt;

I think there is a quite urgent problem needing a repair &lt;br&gt;
fast, I described it here: &lt;br&gt;
&lt;a href="https://bugzilla.redhat.com/show_bug.cgi?id=2037218" rel="noreferrer" \
target="_blank"&gt;https://bugzilla.redhat.com/show_bug.cgi?id=2037218&lt;/a&gt;&lt;br&gt; I was \
hoping, perhaps over-optimistically, for something I &lt;br&gt; could try as a \
'quick' workaround.&lt;br&gt; &lt;br&gt;
thanks, L.&lt;br&gt;
&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I think GlusterFS usage in pacemaker clusters is \
not so common (eg, I don't know if it is supported at all in RH EL \
clusters).&lt;/div&gt;&lt;div&gt;It is not so clear to me if you configured GlusterFS outside of \
pacemaker or not: in fact through a quick search I found both types of attempts \
around...&lt;br&gt;&lt;/div&gt;&lt;div&gt;Probably inside the bugzilla you should precisely outline \
your configuration and in case of embedding GlusterFS as a resource, what is you \
pacemaker configuration, so how your configured your resources/clones (eg \
ocf:glusterfs:glusterd, ocf:glusterfs:volume, ecc..), so that it easily reproducible \
&lt;br&gt;&lt;/div&gt;&lt;div&gt;Personally I never used GlusterFS with \
Pacemaker&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Gianluca&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220106064557</emailId><senderName>Jiatong Shen</senderName><senderEmail>yshxxsjt715@gmail.com</senderEmail><timestampReceived>2022-01-06 06:45:57-0400</timestampReceived><subject>config vhost-user-scsi</subject><body>

Hello,

   I am trying spdk vhost-user. I managed to plug in vhost-user-blk, but
did not find the doc guiding me through setting up vhost-user-scsi. Is it
supported now? Thank you.

-- 

Best Regards,

Jiatong Shen

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;Hello,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;     I am trying spdk vhost-user. I managed \
to plug in vhost-user-blk, but did not find the doc guiding me through setting up \
vhost-user-scsi. Is it supported now? Thank you.&lt;br clear="all"&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;-- \
&lt;br&gt;&lt;div dir="ltr" class="gmail_signature" data-smartmail="gmail_signature"&gt;&lt;div \
dir="ltr"&gt;&lt;br&gt;&lt;div&gt;Best Regards,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Jiatong \
Shen&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220106134758</emailId><senderName>Daniel =?utf-8?B?UC4gQmVycmFuZ8Op?=</senderName><senderEmail>berrange@redhat.com</senderEmail><timestampReceived>2022-01-06 13:47:58-0400</timestampReceived><subject>Re: Failed in using LD_PRELOAD to hook mmap system call in qemu(through libvirt)</subject><body>

On Thu, Jan 06, 2022 at 07:44:25PM +0800, Xiong。 wrote:
&gt; Dear sir: 
&gt;     I want to hook mmap system call in qemu, and I use
&gt; libvirt to passthrough the environment argument like this:
&gt;  &lt;qemu:commandline&gt;
&gt;    &lt;qemu:env name='LD_PRELOAD' value='/glibcHookMMAP.so'/&gt;
&gt;  &lt;/qemu:commandline&gt;
&gt; But it failed. I can hardly find out what is the matter!
&gt; The log in libvirt like this:ERROR: ld.so: object
&gt; '/glibcHookMMAP.so' from LD_PRELOAD cannot be preloaded
&gt; (cannot open shared object file): ignored.    Firstly,
&gt; I think it's the problem of authority. But the file
&gt; glibcHookMMAP.so has been done with command `chmod 777`.
&gt; My environment is as follows: Ubuntu 18.04.2 Linux
&gt; 5.4.0-92 libvirt 4.0.0 qemu 2.11.1

Aside from normal file permissions, the other likely problem on Ubuntu
will be AppArmor policy. It likely won't allow QEMU to load files from
the / directory - if you put your .so in /usr/local/lib it might
work.



Regards,
Daniel
-- 
|: https://berrange.com      -o-    https://www.flickr.com/photos/dberrange :|
|: https://libvirt.org         -o-            https://fstop138.berrange.com :|
|: https://entangle-photo.org    -o-    https://www.instagram.com/dberrange :|

</body></email><email><emailId>20220107022925</emailId><senderName>"=?gb18030?B?WGlvbmehow==?="</senderName><senderEmail>sobxiong@qq.com</senderEmail><timestampReceived>2022-01-07 02:29:25-0400</timestampReceived><subject>=?gb18030?B?u9i4tKO6IEZhaWxlZCBpbiB1c2luZyBMRF9QUkVM?= =?gb18030?B?T0FEIHRvIGhvb2sgbW1hcCBzeXN0ZW0gY</subject><body>

[Attachment #2 (text/plain)]

On Thu, Jan 06, 2022 at 07:44:25PM +0800, Xiong¡£ wrote:
&gt; Dear sir: 
&gt;     I want to hook mmap system call in qemu, and I use
&gt; libvirt to passthrough the environment argument like this:
&gt;  &lt;qemu:commandline&gt;
&gt;    &lt;qemu:env name='LD_PRELOAD' value='/glibcHookMMAP.so'/&gt;
&gt;  &lt;/qemu:commandline&gt;
&gt; But it failed. I can hardly find out what is the matter!
&gt; The log in libvirt like this:ERROR: ld.so: object
&gt; '/glibcHookMMAP.so' from LD_PRELOAD cannot be preloaded
&gt; (cannot open shared object file): ignored.    Firstly,
&gt; I think it's the problem of authority. But the file
&gt; glibcHookMMAP.so has been done with command `chmod 777`.
&gt; My environment is as follows: Ubuntu 18.04.2 Linux
&gt; 5.4.0-92 libvirt 4.0.0 qemu 2.11.1

On Thu, Jan 06, 2022 at 09:47:25PM +0800, Daniel P. Berrang¨¦¡£ wrote:
&gt; Aside from normal file permissions, the other likely problem on Ubuntu
&gt; will be AppArmor policy. It likely won't allow QEMU to load files from
&gt; the / directory - if you put your .so in /usr/local/lib it might
&gt; work.



On Thu, Jan 07, 2022 at 09:27:25AM +0800, Xiong¡£ wrote:
&gt; I have a try, but it does not work and makes the same warning:
&gt; ld.so: object '/usr/local/lib/glibcHookMMAP.so' from LD_PRELOAD cannot be \
preloaded (cannot open shared object file): ignored. &gt; However, I use qemu command \
directly and it works. Command is like this: &gt; sudo \
LD_PRELOAD=/usr/local/lib/glibcHookMMAP.so qemu-system-x86_64 -enable-kvm ...(other \
args). &gt; After that, I get print information with my hook program. And I think the \
problem is in passing the environment args in libvirt.


Sorry, I find out what's the matter. The AppArmor policy limits the libvirt, and \
modifing configuration works. Thank you for your advise!


[Attachment #3 (text/html)]

&lt;meta http-equiv="Content-Type" content="text/html; charset=GB18030"&gt;&lt;div&gt;On Thu, Jan \
06, 2022 at 07:44:25PM +0800, Xiong¡£ wrote:&lt;/div&gt;&lt;div&gt;&gt; Dear sir: &lt;br&gt;&gt;   \
  I want to hook mmap system call in qemu, and I use&lt;br&gt;&gt; libvirt to \
passthrough the environment argument like this:&lt;br&gt;&gt;  \
&lt;qemu:commandline&gt;&lt;br&gt;&gt;    &lt;qemu:env name='LD_PRELOAD' \
value='/glibcHookMMAP.so'/&gt;&lt;br&gt;&gt;  &lt;/qemu:commandline&gt;&lt;br&gt;&gt; But it \
failed. I can hardly find out what is the matter!&lt;br&gt;&gt; The log in libvirt like \
this:ERROR: ld.so: object&lt;br&gt;&gt; '/glibcHookMMAP.so' from LD_PRELOAD cannot be \
preloaded&lt;br&gt;&gt; (cannot open shared object file): ignored.    \
Firstly,&lt;br&gt;&gt; I think it's the problem of authority. But the file&lt;br&gt;&gt; \
glibcHookMMAP.so has been done with command `chmod 777`.&lt;br&gt;&gt; My environment is as \
follows: Ubuntu 18.04.2 Linux&lt;br&gt;&gt; 5.4.0-92 libvirt 4.0.0 qemu 2.11.1&lt;br&gt;&lt;br&gt;On \
Thu, Jan 06, 2022 at 09:47:25PM +0800, Daniel P. Berrang¨¦¡£ wrote:&lt;br&gt;&gt; Aside \
from normal file permissions, the other likely problem on Ubuntu&lt;br&gt;&gt; will be \
AppArmor policy. It likely won't allow QEMU to load files from&lt;br&gt;&gt; the / \
directory - if you put your .so in /usr/local/lib it might&lt;br&gt;&gt; \
work.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;On Thu, Jan 07, 2022 at 09:27:25AM +0800, Xiong¡£ \
wrote:&lt;/div&gt;&lt;div&gt;&gt; I have a try, but it does not work and makes the same \
warning:&lt;/div&gt;&lt;div&gt;&gt; ld.so: object '/usr/local/lib/glibcHookMMAP.so' from \
LD_PRELOAD cannot be preloaded (cannot open shared object file): \
ignored.&lt;/div&gt;&lt;div&gt;&gt; However, I use qemu command directly and it works. Command is \
like this:&lt;/div&gt;&lt;div&gt;&gt; sudo LD_PRELOAD=/usr/local/lib/glibcHookMMAP.so \
qemu-system-x86_64 -enable-kvm ...(other args).&lt;/div&gt;&lt;div&gt;&gt; After that, I get \
print information with my hook program. And I think the problem is in passing the \
environment args in libvirt.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Sorry, I find out what's the \
matter. The AppArmor policy limits the libvirt, and modifing configuration \
works.&lt;/div&gt;&lt;div&gt;Thank you for your advise!&lt;/div&gt;



</body></email><email><emailId>20220111114645</emailId><senderName>Michal Prívozník</senderName><senderEmail>mprivozn@redhat.com</senderEmail><timestampReceived>2022-01-11 11:46:45-0400</timestampReceived><subject>Re: error during host deploy</subject><body>

On 1/11/22 11:13, Dana Elfassy wrote:
&gt; In the last one I don't see a link to download the RPM, can you check?

You have to click on the arch you are interested in, for instance x86_64
is the following link:

https://koji.fedoraproject.org/koji/taskinfo?taskID=81062428

And if you don't want to download all rpms by hand you can use koji:

koji download-task 81062428

Just replace the task ID with the one you want to download. The example
will download rpms for x86_64.

Michal

</body></email><email><emailId>20220103091448</emailId><senderName>Peter Krempa</senderName><senderEmail>pkrempa@redhat.com</senderEmail><timestampReceived>2022-01-03 09:14:48-0400</timestampReceived><subject>Re: Allow unsafe migration - ?</subject><body>

On Wed, Dec 29, 2021 at 17:56:57 +0000, lejeczek wrote:
&gt; Hi guys.
&gt; 
&gt; Is it possible to allow 'unsafe' migration globally?

No there's no global switch for this and there won't be one as there are
multiple reasons why migration can be unsafe.

</body></email><email><emailId>20220106114425</emailId><senderName>"=?gb18030?B?WGlvbmehow==?="</senderName><senderEmail>sobxiong@qq.com</senderEmail><timestampReceived>2022-01-06 11:44:25-0400</timestampReceived><subject>Failed in using LD_PRELOAD to hook mmap system call in qemu(through libvirt)</subject><body>

[Attachment #2 (text/plain)]

Dear sir: 
    I want to hook mmap system call in qemu, and I use libvirt to \
passthrough the environment argument like this:&lt;qemu:commandline&gt;   &lt;qemu:env \
name='LD_PRELOAD' value='/glibcHookMMAP.so'/&gt; &lt;/qemu:commandline&gt;    \
But it failed. I can hardly find out what is the matter! The log in libvirt like \
this:ERROR: ld.so: object '/glibcHookMMAP.so' from LD_PRELOAD cannot be preloaded \
(cannot open shared object file): ignored.    Firstly, I think it's the \
problem of authority. But the file glibcHookMMAP.so has been done with command `chmod \
777`.    My environment is as follows: Ubuntu 18.04.2 Linux \
5.4.0-92 libvirt 4.0.0 qemu 2.11.1     Look forward to your \
feedbacks.




    Sincerely yours


[Attachment #3 (text/html)]

&lt;meta http-equiv="Content-Type" content="text/html; charset=GB18030"&gt;&lt;div&gt;&lt;span \
style="color: rgb(35, 38, 41); font-family: -apple-system, "system-ui", \
"Segoe UI", "Liberation Sans", sans-serif; font-size: 15px;"&gt;Dear \
sir: &lt;/span&gt;&lt;/div&gt;&lt;span style="color: rgb(35, 38, 41); font-family: \
-apple-system, "system-ui", "Segoe UI", "Liberation \
Sans", sans-serif; font-size: 15px;"&gt;    I want to hook mmap system \
call in qemu, and I use libvirt to passthrough the environment &lt;/span&gt;&lt;span \
style="color: rgb(35, 38, 41); font-family: -apple-system, "system-ui", \
"Segoe UI", "Liberation Sans", sans-serif; font-size: \
15px;"&gt;argument like this:&lt;/span&gt;&lt;blockquote formatblock="1" style="margin: 0.8em 0px \
0.8em 2em; padding: 0px 0px 0px 0.7em; border-left: 2px solid rgb(221, 221, \
221);"&gt;&lt;pre style="margin-top: 0px; margin-bottom: calc(var(--s-prose-spacing) + \
0.4em); padding: 12px; border: 0px; font-variant-numeric: inherit; \
font-variant-east-asian: inherit; font-stretch: inherit; line-height: 1.30769; \
font-family: var(--ff-mono); font-size: 13px; vertical-align: baseline; box-sizing: \
inherit; width: auto; max-height: 600px; overflow: auto; background-color: \
var(--highlight-bg); border-radius: 5px; overflow-wrap: normal; color: \
var(--highlight-color);"&gt;&lt;code style="margin: 0px; padding: 0px; border: 0px; \
font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: \
inherit; line-height: inherit; font-family: var(--ff-mono); vertical-align: baseline; \
box-sizing: inherit; background-color: transparent; white-space: inherit; color: \
var(--black-800); border-radius: 0px;"&gt;&lt;qemu:commandline&gt;  &lt;qemu:env \
name='LD_PRELOAD' value='/glibcHookMMAP.so'/&gt; \
&lt;/qemu:commandline&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/blockquote&gt;&lt;span style="color: rgb(35, 38, \
41); font-family: -apple-system, "system-ui", "Segoe UI", \
"Liberation Sans", sans-serif; font-size: 15px;"&gt;    But it \
failed. I can hardly find out what is the matter! The log in libvirt like \
this:&lt;/span&gt;&lt;blockquote formatblock="1" style="margin: 0.8em 0px 0.8em 2em; padding: \
0px 0px 0px 0.7em; border-left: 2px solid rgb(221, 221, 221);"&gt;&lt;pre \
style="margin-top: 0px; margin-bottom: calc(var(--s-prose-spacing) + 0.4em); padding: \
12px; border: 0px; font-variant-numeric: inherit; font-variant-east-asian: inherit; \
font-stretch: inherit; line-height: 1.30769; font-family: var(--ff-mono); font-size: \
13px; vertical-align: baseline; box-sizing: inherit; width: auto; max-height: 600px; \
overflow: auto; background-color: var(--highlight-bg); border-radius: 5px; \
overflow-wrap: normal; color: var(--highlight-color);"&gt;&lt;code style="margin: 0px; \
padding: 0px; border: 0px; font-style: inherit; font-variant: inherit; font-weight: \
inherit; font-stretch: inherit; line-height: inherit; font-family: var(--ff-mono); \
vertical-align: baseline; box-sizing: inherit; background-color: transparent; \
white-space: inherit; color: var(--black-800); border-radius: 0px;"&gt;ERROR: ld.so: \
object '/glibcHookMMAP.so' from LD_PRELOAD cannot be preloaded (cannot open shared \
object file): ignored.&lt;/code&gt;&lt;/pre&gt;&lt;/blockquote&gt;&lt;span style="color: rgb(35, 38, 41); \
font-family: -apple-system, "system-ui", "Segoe UI", \
"Liberation Sans", sans-serif; font-size: 15px;"&gt;    Firstly, I \
think it's the problem of authority. But the file glibcHookMMAP.so has been done with \
command `&lt;/span&gt;&lt;code style="margin: 0px; padding: 2px 4px; border: 0px; \
font-variant-numeric: inherit; font-variant-east-asian: inherit; font-stretch: \
inherit; line-height: inherit; font-family: var(--ff-mono); font-size: 13px; \
vertical-align: baseline; box-sizing: inherit; background-color: var(--black-075); \
white-space: pre-wrap; color: rgb(35, 38, 41); border-radius: 3px;"&gt;chmod \
777`&lt;/code&gt;&lt;span style="color: rgb(35, 38, 41); font-family: -apple-system, \
"system-ui", "Segoe UI", "Liberation Sans", sans-serif; \
font-size: 15px;"&gt;.&lt;/span&gt;&lt;div&gt;&lt;span style="color: rgb(35, 38, 41); font-family: \
-apple-system, "system-ui", "Segoe UI", "Liberation \
Sans", sans-serif; font-size: 15px;"&gt;    My environment is as \
follows: &lt;/span&gt;&lt;span style="color: rgb(35, 38, 41); font-family: -apple-system, \
"system-ui", "Segoe UI", "Liberation Sans", sans-serif; \
font-size: 15px;"&gt;Ubuntu 18.04.2 Linux 5.4.0-92 &lt;/span&gt;&lt;span style="color: \
rgb(35, 38, 41); font-family: -apple-system, "system-ui", "Segoe \
UI", "Liberation Sans", sans-serif; font-size: 15px;"&gt;libvirt \
4.0.0 &lt;/span&gt;&lt;span style="color: rgb(35, 38, 41); font-family: -apple-system, \
"system-ui", "Segoe UI", "Liberation Sans", sans-serif; \
font-size: 15px;"&gt;qemu 2.11.1&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style="color: rgb(35, 38, 41); \
font-family: -apple-system, "system-ui", "Segoe UI", \
"Liberation Sans", sans-serif; font-size: 15px;"&gt;  \
  &lt;/span&gt;&lt;span style="color: rgb(18, 18, 18); font-family: -apple-system, \
"system-ui", "Helvetica Neue", "PingFang SC", \
"Microsoft YaHei", "Source Han Sans SC", "Noto Sans CJK \
SC", "WenQuanYi Micro Hei", sans-serif; font-size: 15px;"&gt;Look forward \
to your feedbacks.&lt;/span&gt;&lt;div&gt;&lt;div&gt;&lt;p style="margin: 0px; padding: 0px; border: 0px; \
font-variant-numeric: inherit; font-variant-east-asian: inherit; font-stretch: \
inherit; line-height: inherit; font-family: -apple-system, "system-ui", \
"Segoe UI", "Liberation Sans", sans-serif; font-size: 15px; \
vertical-align: baseline; box-sizing: inherit; clear: both; color: rgb(35, 38, \
41);"&gt;&lt;/p&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;span style="color: rgb(35, 38, 41); font-family: \
-apple-system, "system-ui", "Segoe UI", "Liberation \
Sans", sans-serif; font-size: 15px;"&gt;    Sincerely yours&lt;/span&gt;&lt;/div&gt;



</body></email><email><emailId>20220103092607</emailId><senderName>Peter Krempa</senderName><senderEmail>pkrempa@redhat.com</senderEmail><timestampReceived>2022-01-03 09:26:07-0400</timestampReceived><subject>Re: Allow unsafe migration - ?</subject><body>

On Mon, Jan 03, 2022 at 10:14:48 +0100, Peter Krempa wrote:
&gt; On Wed, Dec 29, 2021 at 17:56:57 +0000, lejeczek wrote:
&gt; &gt; Hi guys.
&gt; &gt; 
&gt; &gt; Is it possible to allow 'unsafe' migration globally?
&gt; 
&gt; No there's no global switch for this and there won't be one as there are
&gt; multiple reasons why migration can be unsafe.

Additionally, would you mind describing your setup and why you even need
unsafe? Maybe there's a gap that we can fix.

</body></email><email><emailId>20220105132423</emailId><senderName>lejeczek</senderName><senderEmail>peljasz@yahoo.co.uk</senderEmail><timestampReceived>2022-01-05 13:24:23-0400</timestampReceived><subject>Re: Allow unsafe migration - ?</subject><body>



On 03/01/2022 09:26, Peter Krempa wrote:
&gt; On Mon, Jan 03, 2022 at 10:14:48 +0100, Peter Krempa wrote:
&gt;&gt; On Wed, Dec 29, 2021 at 17:56:57 +0000, lejeczek wrote:
&gt;&gt;&gt; Hi guys.
&gt;&gt;&gt;
&gt;&gt;&gt; Is it possible to allow 'unsafe' migration globally?
&gt;&gt; No there's no global switch for this and there won't be one as there are
&gt;&gt; multiple reasons why migration can be unsafe.
&gt; Additionally, would you mind describing your setup and why you even need
&gt; unsafe? Maybe there's a gap that we can fix.
&gt;
I think there is a quite urgent problem needing a repair 
fast, I described it here: 
https://bugzilla.redhat.com/show_bug.cgi?id=2037218
I was hoping, perhaps over-optimistically, for something I 
could try as a 'quick' workaround.

thanks, L.

</body></email><email><emailId>20220111114919</emailId><senderName>"FRANK, Michael"</senderName><senderEmail>michael.frank@airbus.com</senderEmail><timestampReceived>2022-01-11 11:49:19-0400</timestampReceived><subject>unsubscribe</subject><body>

unsubscribe


The information in this e-mail is confidential. The contents may not be dis=
closed or used by anyone other than the addressee. Access to this e-mail by=
 anyone else is unauthorised.
If you are not the intended recipient, please notify Airbus immediately and=
 delete this e-mail.
Airbus cannot accept any responsibility for the accuracy or completeness of=
 this e-mail as it has been sent over public networks. If you have any conc=
erns over the content of this message or its Accuracy or Integrity, please =
contact Airbus immediately.
All outgoing e-mails from Airbus are checked using regularly updated virus =
scanning software but you should take whatever measures you deem to be appr=
opriate to ensure that this message and any attachments are virus free.

[Attachment #3 (text/html)]

&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=us-ascii"&gt;
&lt;meta name="Generator" content="Microsoft Exchange Server"&gt;
&lt;!-- converted from rtf --&gt;
&lt;style&gt;&lt;!-- .EmailQuote { margin-left: 1pt; padding-left: 4pt; border-left: #800000 \
2px solid; } --&gt;&lt;/style&gt; &lt;/head&gt;
&lt;body&gt;
&lt;font face="Calibri" size="2"&gt;&lt;span style="font-size:11pt;"&gt;
&lt;div&gt;unsubscribe&lt;/div&gt;
&lt;div&gt; &lt;/div&gt;
&lt;div&gt; &lt;/div&gt;
&lt;/span&gt;&lt;/font&gt;
&lt;font style="font-size: 9px;"&gt;The information in this e-mail is confidential. The \
contents may not be disclosed or used by anyone other than the addressee. Access to \
this e-mail by anyone else is unauthorised.&lt;br&gt;If you are not the intended recipient, \
please notify Airbus immediately and delete this e-mail.&lt;br&gt;Airbus cannot accept any \
responsibility for the accuracy or completeness of this e-mail as it has been sent \
over public networks. If you have any concerns over the content of this message or \
its Accuracy or Integrity, please contact Airbus immediately.&lt;br&gt;All outgoing e-mails \
from Airbus are checked using regularly updated virus scanning software but you \
should take whatever measures you deem to be appropriate to ensure that this message \
and any attachments are virus free.&lt;/font&gt;&lt;/body&gt; &lt;/html&gt;



</body></email><email><emailId>20220111184217</emailId><senderName>lejeczek</senderName><senderEmail>peljasz@yahoo.co.uk</senderEmail><timestampReceived>2022-01-11 18:42:17-0400</timestampReceived><subject>Re: 'migrate' says it worked but in reality it did not - centOS 9</subject><body>



On 11/01/2022 17:33, Daniel P. Berrangé wrote:
&gt; On Tue, Jan 11, 2022 at 05:14:53PM +0000, lejeczek wrote:
&gt;&gt;
&gt;&gt; On 11/01/2022 16:36, Daniel P. Berrangé wrote:
&gt;&gt;&gt; On Tue, Jan 11, 2022 at 04:30:11PM +0000, lejeczek wrote:
&gt;&gt;&gt;&gt; Hi guys.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; I have a peculiar situation where between boxes:
&gt;&gt;&gt;&gt; C-&gt;A
&gt;&gt;&gt;&gt; -&gt; $ virsh migrate --unsafe --live c8kubermaster1
&gt;&gt;&gt;&gt; qemu+ssh://10.1.1.99/system
&gt;&gt;&gt;&gt; -&gt; $ echo $?
&gt;&gt;&gt;&gt; 0
&gt;&gt;&gt;&gt; but above does _not_ happen, instead!! VM was stopped in started, but _not_
&gt;&gt;&gt;&gt; migrated LIVE
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; A-&gt;C
&gt;&gt;&gt;&gt; -&gt; $ virsh migrate --unsafe --live c8kubermaster1
&gt;&gt;&gt;&gt; qemu+ssh://10.1.1.100/system
&gt;&gt;&gt;&gt; -&gt; $ echo $?
&gt;&gt;&gt;&gt; 0
&gt;&gt;&gt;&gt; indeed VM migrates live.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; box A &amp; C have virtually identical OS stack,
&gt;&gt;&gt;&gt; HW difference is:
&gt;&gt;&gt;&gt; C = Ryzen 5 5600G
&gt;&gt;&gt;&gt; A = Ryzen 5 3600
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; domain XML snippet where I think it matters:
&gt;&gt;&gt;&gt; ...
&gt;&gt;&gt;&gt;     &lt;/metadata&gt;
&gt;&gt;&gt;&gt;     &lt;memory unit='GiB'&gt;4&lt;/memory&gt;
&gt;&gt;&gt;&gt;     &lt;currentMemory unit='GiB'&gt;4&lt;/currentMemory&gt;
&gt;&gt;&gt;&gt;     &lt;vcpu placement='static'&gt;2&lt;/vcpu&gt;
&gt;&gt;&gt;&gt;     &lt;resource&gt;
&gt;&gt;&gt;&gt;       &lt;partition&gt;/machine&lt;/partition&gt;
&gt;&gt;&gt;&gt;     &lt;/resource&gt;
&gt;&gt;&gt;&gt;     &lt;os&gt;
&gt;&gt;&gt;&gt;       &lt;type arch='x86_64' machine='pc-i440fx-rhel7.6.0'&gt;hvm&lt;/type&gt;
&gt;&gt;&gt;&gt;       &lt;boot dev='hd'/&gt;
&gt;&gt;&gt;&gt;     &lt;/os&gt;
&gt;&gt;&gt;&gt;     &lt;features&gt;
&gt;&gt;&gt;&gt;       &lt;acpi/&gt;
&gt;&gt;&gt;&gt;       &lt;apic/&gt;
&gt;&gt;&gt;&gt;     &lt;/features&gt;
&gt;&gt;&gt;&gt;     &lt;cpu mode='custom' match='exact' check='full'&gt;
&gt;&gt;&gt;&gt;       &lt;model fallback='forbid'&gt;EPYC-IBPB&lt;/model&gt;
&gt;&gt;&gt;&gt;       &lt;feature policy='require' name='ibpb'/&gt;
&gt;&gt;&gt;&gt;       &lt;feature policy='require' name='ssbd'/&gt;
&gt;&gt;&gt;&gt;       &lt;feature policy='require' name='virt-ssbd'/&gt;
&gt;&gt;&gt;&gt;       &lt;feature policy='disable' name='monitor'/&gt;
&gt;&gt;&gt;&gt;       &lt;feature policy='require' name='x2apic'/&gt;
&gt;&gt;&gt;&gt;       &lt;feature policy='require' name='hypervisor'/&gt;
&gt;&gt;&gt;&gt;       &lt;feature policy='disable' name='svm'/&gt;
&gt;&gt;&gt;&gt;       &lt;feature policy='require' name='topoext'/&gt;
&gt;&gt;&gt;&gt;     &lt;/cpu&gt;
&gt;&gt;&gt;&gt;     &lt;clock offset='utc'&gt;
&gt;&gt;&gt;&gt;       &lt;timer name='rtc' tickpolicy='catchup'/&gt;
&gt;&gt;&gt;&gt;       &lt;timer name='pit' tickpolicy='delay'/&gt;
&gt;&gt;&gt;&gt;       &lt;timer name='hpet' present='no'/&gt;
&gt;&gt;&gt;&gt;     &lt;/clock&gt;
&gt;&gt;&gt;&gt;     &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
&gt;&gt;&gt;&gt;     &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
&gt;&gt;&gt;&gt;     &lt;on_crash&gt;destroy&lt;/on_crash&gt;
&gt;&gt;&gt;&gt;     &lt;pm&gt;
&gt;&gt;&gt;&gt;       &lt;suspend-to-mem enabled='no'/&gt;
&gt;&gt;&gt;&gt;       &lt;suspend-to-disk enabled='no'/&gt;
&gt;&gt;&gt;&gt;     &lt;/pm&gt;
&gt;&gt;&gt;&gt;     &lt;devices&gt;
&gt;&gt;&gt;&gt;       &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;
&gt;&gt;&gt;&gt;       &lt;disk type='file' device='disk'&gt;
&gt;&gt;&gt;&gt; ...
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Initially I submitted a BZ against 'PCS' but continued to filled with it and
&gt;&gt;&gt;&gt; I find 'libvirt' might be the culprit(also?) here.
&gt;&gt;&gt;&gt; There is not much in logs, certainly nothing (with default verbosity) in
&gt;&gt;&gt;&gt; virtqemud.service
&gt;&gt;&gt;&gt; Is it that VM gets migrated but then is restarted on 'migrate_to' host? if
&gt;&gt;&gt;&gt; so then why?
&gt;&gt;&gt;&gt; How to start troubleshooting such 'monstrosity'? - all suggestions
&gt;&gt;&gt;&gt; appreciated.
&gt;&gt;&gt; /var/log/libvirt/qemu/$GUEST.log  on both hosts should have more info
&gt;&gt;&gt;
&gt;&gt; What if there is not much there neither?
&gt;&gt; migrate_to(host A) seems to show only config for qemu, no errors no
&gt;&gt; warnings.
&gt;&gt; migrate_from(host C) shows only:
&gt;&gt; ...
&gt;&gt; 2022-01-11 17:00:40.687+0000: initiating migration
&gt;&gt; 2022-01-11 17:00:43.413+0000: shutting down, reason=migrated
&gt;&gt; 2022-01-11T17:00:43.414063Z qemu-kvm: terminating on signal 15 from pid
&gt;&gt; 24022 (&lt;unknown process&gt;)
&gt;&gt;
&gt;&gt; no errors/warning but that 2nd line - ??
&gt;&gt;
&gt;&gt; Again, migrating back between the same two hosts - where LIVE succeeds
&gt;&gt; migrate_from(host A) also shows:
&gt;&gt; ...
&gt;&gt; 2022-01-11 17:10:27.921+0000: initiating migration
&gt;&gt; 2022-01-11 17:10:30.459+0000: shutting down, reason=migrated
&gt;&gt; 2022-01-11T17:10:30.460528Z qemu-kvm: terminating on signal 15 from pid
&gt;&gt; 73193 (&lt;unknown process&gt;
&gt; Both those logs only show the state on the src QEMU during a
&gt; migration op. There should be corresponding log for the dst
&gt; QEMU at the same point in time.
both these logs are from two different hosts - did I fail to 
make it clear? - when these hosts are 'migrate_from' hosts.
migrate_to in both cases, when LIVE fails and when success, 
seem to show only qemu config, no errors no warning
&gt; All tehse messages show that migration was successful from libvirt and
&gt; QEMU's POV on the src.
&gt;
&gt; So I expect what'ps happening is that QEMU is crashing on the target
&gt; host after migration has finished.
&gt;
&gt; Regards,
&gt; Daniel
by qemu crash - do you mean that:
'qemu-kvm: terminating on signal'
? But as above, this shows for 'success' &amp; 'failure'
Like I said, virtqemud.service shows nothing, no segfaults, 
nothing obvious.
Full picture, live migrations between hosts:
A&lt;-&gt;B works
A,B-&gt;C works
C-&gt;A,B fails





</body></email><email><emailId>20220112090207</emailId><senderName>Daniel =?utf-8?B?UC4gQmVycmFuZ8Op?=</senderName><senderEmail>berrange@redhat.com</senderEmail><timestampReceived>2022-01-12 09:02:07-0400</timestampReceived><subject>Re: DMARC &amp; similar @admins</subject><body>

On Tue, Jan 11, 2022 at 06:58:29PM +0000, lejeczek wrote:
&gt; 
&gt; 
&gt; On 11/01/2022 17:29, Daniel P. Berrangé wrote:
&gt; &gt; On Tue, Jan 11, 2022 at 05:18:53PM +0000, lejeczek wrote:
&gt; &gt; &gt; Hi guys
&gt; &gt; &gt; 
&gt; &gt; &gt; My memory fools me? - I remembered this list had DMAR+other_bits sorted, so
&gt; &gt; &gt; users like myself, on Yahoo, did not loose their own emails.
&gt; &gt; Nope, it is currently unfixable. The mail server software handling
&gt; &gt; @redhat.com culls the DKIM signatures, so anyone sending from a
&gt; &gt; domain that requests strict DMARC policy will have their sent mail
&gt; &gt; dropped by any recipient that honours this.  This basically means
&gt; &gt; that most subscribers to this list won't see any mail sent by
&gt; &gt; @yahoo addresses.
&gt; &gt; 
&gt; &gt; I've had bug report escalated for over a year now and there's no
&gt; &gt; ETA to fix it.
&gt; &gt; 
&gt; I don't know if it's the exact same Redhat(platform) but might be worth
&gt; consulting freeIPA, oVirt, clusterlabs(who recently fixed it) - "it" works
&gt; over there.

The mailing lists for all of those projects are hosted on different
servers - none are using the redhat.com mailman. 

I know what needs to be fixed at the technical level, but the SMTP
service for redhat.com doesn't allow us to do what is needed - ie
not strip the DKIM signature. The outdated version of mailman in
use also does not have the workaround feature for this that newer
mailman releases have

I would love to fix this but there's nothing more I can do at this
time. As soon as something else becomes possible I'll try it.

Regards,
Daniel
-- 
|: https://berrange.com      -o-    https://www.flickr.com/photos/dberrange :|
|: https://libvirt.org         -o-            https://fstop138.berrange.com :|
|: https://entangle-photo.org    -o-    https://www.instagram.com/dberrange :|

</body></email><email><emailId>20220113095007</emailId><senderName>Andrea Bolognani</senderName><senderEmail>abologna@redhat.com</senderEmail><timestampReceived>2022-01-13 09:50:07-0400</timestampReceived><subject>Re: interface hotplug q35 machine type</subject><body>

On Wed, Jan 12, 2022 at 12:37:12PM +0100, Miguel Duarte de Mora Barroso wrote:
&gt; For our use case, I'm considering mimicking Openstack's implementation -
&gt; [1] - and expose a knob that indicates what is the number of PCIe root
&gt; ports to be used upon the domain definition.
&gt;
&gt; I wonder how open would the community be to having a machine type alias
&gt; that would provide a "better" default - in the sense that it would have
&gt; more root port controllers.

The problem with this suggestion is that the definition of "better"
varies depending on who you ask :) There is no one-size-fits-all
solution.

libvirt follows the "mechanism, not policy" principle: the mechanism
is already available, as documented in the page you were quoting, and
the policy is better implemented in your application. OpenStack is a
good example to follow in this regard.

-- 
Andrea Bolognani / Red Hat / Virtualization

</body></email><email><emailId>20220107012743</emailId><senderName>"=?gb18030?B?WGlvbmehow==?="</senderName><senderEmail>sobxiong@qq.com</senderEmail><timestampReceived>2022-01-07 01:27:43-0400</timestampReceived><subject>=?gb18030?B?u9i4tKO6IEZhaWxlZCBpbiB1c2luZyBMRF9QUkVM?= =?gb18030?B?T0FEIHRvIGhvb2sgbW1hcCBzeXN0ZW0gY</subject><body>

[Attachment #2 (text/plain)]

On Thu, Jan 06, 2022 at 07:44:25PM +0800, Xiong¡£ wrote:
&gt; Dear sir: 
&gt;     I want to hook mmap system call in qemu, and I use
&gt; libvirt to passthrough the environment argument like this:
&gt;  &lt;qemu:commandline&gt;
&gt;    &lt;qemu:env name='LD_PRELOAD' value='/glibcHookMMAP.so'/&gt;
&gt;  &lt;/qemu:commandline&gt;
&gt; But it failed. I can hardly find out what is the matter!
&gt; The log in libvirt like this:ERROR: ld.so: object
&gt; '/glibcHookMMAP.so' from LD_PRELOAD cannot be preloaded
&gt; (cannot open shared object file): ignored.    Firstly,
&gt; I think it's the problem of authority. But the file
&gt; glibcHookMMAP.so has been done with command `chmod 777`.
&gt; My environment is as follows: Ubuntu 18.04.2 Linux
&gt; 5.4.0-92 libvirt 4.0.0 qemu 2.11.1

On Thu, Jan 06, 2022 at 09:47:25PM +0800, Daniel P. Berrang¨¦¡£ wrote:
&gt; Aside from normal file permissions, the other likely problem on Ubuntu
&gt; will be AppArmor policy. It likely won't allow QEMU to load files from
&gt; the / directory - if you put your .so in /usr/local/lib it might
&gt; work.



I have a try, but it does not work and makes the same warning:
ld.so: object '/usr/local/lib/glibcHookMMAP.so' from LD_PRELOAD cannot be \
preloaded (cannot open shared object file): ignored. However, I use qemu command \
directly and it works. Command is like this: sudo \
LD_PRELOAD=/usr/local/lib/glibcHookMMAP.so qemu-system-x86_64 -enable-kvm ...(other \
args). After that, I get print information with my hook program. And I think the \
problem is in passing the environment args in libvirt.


[Attachment #3 (text/html)]

&lt;meta http-equiv="Content-Type" content="text/html; charset=GB18030"&gt;&lt;div&gt;On Thu, Jan \
06, 2022 at 07:44:25PM +0800, Xiong¡£ wrote:&lt;/div&gt;&lt;div&gt;&gt; Dear sir: \
&lt;br&gt;&gt;     I want to hook mmap system call in qemu, and I \
use&lt;br&gt;&gt; libvirt to passthrough the environment argument like this:&lt;br&gt;&gt;  \
&lt;qemu:commandline&gt;&lt;br&gt;&gt;    &lt;qemu:env name='LD_PRELOAD' \
value='/glibcHookMMAP.so'/&gt;&lt;br&gt;&gt;  &lt;/qemu:commandline&gt;&lt;br&gt;&gt; But it \
failed. I can hardly find out what is the matter!&lt;br&gt;&gt; The log in libvirt like \
this:ERROR: ld.so: object&lt;br&gt;&gt; '/glibcHookMMAP.so' from LD_PRELOAD cannot be \
preloaded&lt;br&gt;&gt; (cannot open shared object file): ignored.    \
Firstly,&lt;br&gt;&gt; I think it's the problem of authority. But the file&lt;br&gt;&gt; \
glibcHookMMAP.so has been done with command `chmod 777`.&lt;br&gt;&gt; My environment is as \
follows: Ubuntu 18.04.2 Linux&lt;br&gt;&gt; 5.4.0-92 libvirt 4.0.0 qemu 2.11.1&lt;br&gt;&lt;br&gt;On \
Thu, Jan 06, 2022 at 09:47:25PM +0800, Daniel P. Berrang¨¦¡£ wrote:&lt;br&gt;&gt; Aside \
from normal file permissions, the other likely problem on Ubuntu&lt;br&gt;&gt; will be \
AppArmor policy. It likely won't allow QEMU to load files from&lt;br&gt;&gt; the / \
directory - if you put your .so in /usr/local/lib it might&lt;br&gt;&gt; \
work.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I have a try, but it does not work and makes the \
same warning:&lt;/div&gt;&lt;div&gt;ld.so: object '/usr/local/lib/glibcHookMMAP.so' from \
LD_PRELOAD cannot be preloaded (cannot open shared object file): \
ignored.&lt;/div&gt;&lt;div&gt;However, I use qemu command directly and it works. Command is like \
this:&lt;/div&gt;&lt;div&gt;sudo LD_PRELOAD=/usr/local/lib/glibcHookMMAP.so qemu-system-x86_64 \
-enable-kvm ...(other args).&lt;/div&gt;&lt;div&gt;After that, I get print information with my \
hook program. And I think the problem is in passing the environment args in \
libvirt.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;



</body></email><email><emailId>20220111163011</emailId><senderName>lejeczek</senderName><senderEmail>peljasz@yahoo.co.uk</senderEmail><timestampReceived>2022-01-11 16:30:11-0400</timestampReceived><subject>'migrate' says it worked but in reality it did not - centOS 9</subject><body>

Hi guys.

I have a peculiar situation where between boxes:
C-&gt;A
-&gt; $ virsh migrate --unsafe --live c8kubermaster1 
qemu+ssh://10.1.1.99/system
-&gt; $ echo $?
0
but above does _not_ happen, instead!! VM was stopped in 
started, but _not_ migrated LIVE

A-&gt;C
-&gt; $ virsh migrate --unsafe --live c8kubermaster1 
qemu+ssh://10.1.1.100/system
-&gt; $ echo $?
0
indeed VM migrates live.

box A &amp; C have virtually identical OS stack,
HW difference is:
C = Ryzen 5 5600G
A = Ryzen 5 3600

domain XML snippet where I think it matters:
...
   &lt;/metadata&gt;
   &lt;memory unit='GiB'&gt;4&lt;/memory&gt;
   &lt;currentMemory unit='GiB'&gt;4&lt;/currentMemory&gt;
   &lt;vcpu placement='static'&gt;2&lt;/vcpu&gt;
   &lt;resource&gt;
     &lt;partition&gt;/machine&lt;/partition&gt;
   &lt;/resource&gt;
   &lt;os&gt;
     &lt;type arch='x86_64' 
machine='pc-i440fx-rhel7.6.0'&gt;hvm&lt;/type&gt;
     &lt;boot dev='hd'/&gt;
   &lt;/os&gt;
   &lt;features&gt;
     &lt;acpi/&gt;
     &lt;apic/&gt;
   &lt;/features&gt;
   &lt;cpu mode='custom' match='exact' check='full'&gt;
     &lt;model fallback='forbid'&gt;EPYC-IBPB&lt;/model&gt;
     &lt;feature policy='require' name='ibpb'/&gt;
     &lt;feature policy='require' name='ssbd'/&gt;
     &lt;feature policy='require' name='virt-ssbd'/&gt;
     &lt;feature policy='disable' name='monitor'/&gt;
     &lt;feature policy='require' name='x2apic'/&gt;
     &lt;feature policy='require' name='hypervisor'/&gt;
     &lt;feature policy='disable' name='svm'/&gt;
     &lt;feature policy='require' name='topoext'/&gt;
   &lt;/cpu&gt;
   &lt;clock offset='utc'&gt;
     &lt;timer name='rtc' tickpolicy='catchup'/&gt;
     &lt;timer name='pit' tickpolicy='delay'/&gt;
     &lt;timer name='hpet' present='no'/&gt;
   &lt;/clock&gt;
   &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
   &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
   &lt;on_crash&gt;destroy&lt;/on_crash&gt;
   &lt;pm&gt;
     &lt;suspend-to-mem enabled='no'/&gt;
     &lt;suspend-to-disk enabled='no'/&gt;
   &lt;/pm&gt;
   &lt;devices&gt;
     &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;
     &lt;disk type='file' device='disk'&gt;
...

Initially I submitted a BZ against 'PCS' but continued to 
filled with it and I find 'libvirt' might be the 
culprit(also?) here.
There is not much in logs, certainly nothing (with default 
verbosity) in virtqemud.service
Is it that VM gets migrated but then is restarted on 
'migrate_to' host? if so then why?
How to start troubleshooting such 'monstrosity'? - all 
suggestions appreciated.
many thanks, L.

</body></email><email><emailId>20220111171853</emailId><senderName>lejeczek</senderName><senderEmail>peljasz@yahoo.co.uk</senderEmail><timestampReceived>2022-01-11 17:18:53-0400</timestampReceived><subject>DMARC &amp; similar @admins</subject><body>

Hi guys

My memory fools me? - I remembered this list had 
DMAR+other_bits sorted, so users like myself, on Yahoo, did 
not loose their own emails.

regards, L

</body></email><email><emailId>20220112113712</emailId><senderName>Miguel Duarte de Mora Barroso</senderName><senderEmail>mdbarroso@redhat.com</senderEmail><timestampReceived>2022-01-12 11:37:12-0400</timestampReceived><subject>interface hotplug q35 machine type</subject><body>

Hello,

I see that as part of libvirt's documentation [0] the q35 machine type will
feature at most 1 hotplugged PCIe device - default - and users must prepare
in advance according to their expectations of how many ifaces will be
hotplugged:

"""
Slots on the pcie-root controller do not support hotplug, so the device
will be hotplugged into the pcie-root-port controller. If you plan to
hotplug more than a single PCI Express device, you should add a suitable
number of pcie-root-port controllers when defining the guest: for example,
add

```xml
&lt;controller type='pci' model='pcie-root'/&gt;
&lt;controller type='pci' model='pcie-root-port'/&gt;
&lt;controller type='pci' model='pcie-root-port'/&gt;
&lt;controller type='pci' model='pcie-root-port'/&gt;
```
if you expect to hotplug up to three PCI Express devices, either emulated
or assigned from the host.
"""

Is there any alternative to this ?

For our use case, I'm considering mimicking Openstack's implementation -
[1] - and expose a knob that indicates what is the number of PCIe root
ports to be used upon the domain definition.

I wonder how open would the community be to having a machine type alias
that would provide a "better" default - in the sense that it would have
more root port controllers.

[0] - https://libvirt.org/pci-hotplug.html#x86_64-q35
[1] -
https://blueprints.launchpad.net/nova/+spec/configure-amount-of-pcie-ports

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;Hello,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I see that as part of libvirt's \
documentation [0] the q35 machine type will feature at most 1 hotplugged PCIe device \
- default - and users must prepare in advance according to their expectations of how \
many ifaces will be hotplugged:  &lt;br&gt;&lt;br&gt;"""&lt;/div&gt;&lt;div&gt;Slots on the \
pcie-root controller do not support hotplug, so the device will be hotplugged into \
the pcie-root-port controller. If you plan to hotplug more than a single PCI Express \
device, you should add a suitable number of pcie-root-port controllers when defining \
the guest: for example, add&lt;br&gt;&lt;br&gt;```xml&lt;br&gt;&lt;controller type='pci' \
model='pcie-root'/&gt;&lt;br&gt;&lt;controller type='pci' \
model='pcie-root-port'/&gt;&lt;br&gt;&lt;controller type='pci' \
model='pcie-root-port'/&gt;&lt;br&gt;&lt;controller type='pci' \
model='pcie-root-port'/&gt;&lt;/div&gt;&lt;div&gt;```&lt;br&gt;if you expect to hotplug up to \
three PCI Express devices, either emulated or assigned from the host.  \
&lt;br&gt;&lt;/div&gt;&lt;div&gt;"""&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Is there any alternative \
to this ?  &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;For our use case, I'm considering mimicking \
Openstack's implementation - [1] - and expose a knob that indicates what is the \
number of PCIe root ports to be used upon the domain definition.  \
&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I wonder how open would  the community be to having a \
machine type alias that would provide a "better" default - in the sense \
that it would have more root port controllers.  &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;[0] -  &lt;a \
href="https://libvirt.org/pci-hotplug.html#x86_64-q35" \
target="_blank"&gt;https://libvirt.org/pci-hotplug.html#x86_64-q35&lt;/a&gt;&lt;/div&gt;&lt;div&gt;[1] -  \
&lt;a href="https://blueprints.launchpad.net/nova/+spec/configure-amount-of-pcie-ports"&gt;h \
ttps://blueprints.launchpad.net/nova/+spec/configure-amount-of-pcie-ports&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;




</body></email><email><emailId>20220114173910</emailId><senderName>Ahmad Ismail</senderName><senderEmail>ismail783@gmail.com</senderEmail><timestampReceived>2022-01-14 17:39:10-0400</timestampReceived><subject>What does the positional parameters of "virsh backup-begin" actually do?</subject><body>

Normally when I backup a kvm machine I shutdown the machine then run:

virsh list -all
virsh shutdown Ubuntu18
virsh dumpxml Ubuntu18 &gt; /MyBackup/Ubuntu18.xml
cp /var/lib/libvirt/images/Ubuntu18.qcow2 /MyBackup/Ubuntu18.qcow2

However, I found a new sub-command. The help file says:

% virsh backup-begin --help
  NAME
    backup-begin - Start a disk backup of a live domain

  SYNOPSIS
    backup-begin &lt;domain&gt; [--backupxml &lt;string&gt;] [--checkpointxml
&lt;string&gt;] [--reuse-external]

  DESCRIPTION
    Use XML to start a full or incremental disk backup of a live
domain, optionally creating a checkpoint

  OPTIONS
    [--domain] &lt;string&gt;  domain name, id or uuid
    --backupxml &lt;string&gt;  domain backup XML
    --checkpointxml &lt;string&gt;  domain checkpoint XML
    --reuse-external  reuse files provided by caller

The problem with this help is, it is not clear enough.

I understand that I should use virsh backup-begin vm1 to backup a live kvm
machine. However, this command only create .qcow2 files. What about the .xml
file.

What does --backupxml , --checkpointxml &amp; --reuse-external actually do?

When should I use them?

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;&lt;div class="gmail-s-prose gmail-js-post-body"&gt;
                
&lt;p&gt;Normally when I backup a kvm machine I shutdown the machine then run:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;virsh list -all
virsh shutdown Ubuntu18
virsh dumpxml Ubuntu18 &gt; /MyBackup/Ubuntu18.xml
cp /var/lib/libvirt/images/Ubuntu18.qcow2 /MyBackup/Ubuntu18.qcow2
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;However, I found a new sub-command. The help file says:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;% virsh backup-begin --help
  NAME
    backup-begin - Start a disk backup of a live domain

  SYNOPSIS
    backup-begin &lt;domain&gt; [--backupxml &lt;string&gt;] [--checkpointxml \
&lt;string&gt;] [--reuse-external]

  DESCRIPTION
    Use XML to start a full or incremental disk backup of a live domain, optionally \
creating a checkpoint

  OPTIONS
    [--domain] &lt;string&gt;  domain name, id or uuid
    --backupxml &lt;string&gt;  domain backup XML
    --checkpointxml &lt;string&gt;  domain checkpoint XML
    --reuse-external  reuse files provided by caller
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The problem with this help is, it is not clear enough.&lt;/p&gt;
&lt;p&gt;I understand that I should use &lt;code&gt;virsh backup-begin vm1&lt;/code&gt; to backup a \
live kvm machine. However, this command only create &lt;code&gt;.qcow2&lt;/code&gt; files. What \
about the &lt;code&gt;.xml&lt;/code&gt; file.&lt;/p&gt; &lt;p&gt;What does &lt;code&gt;--backupxml&lt;/code&gt; , \
&lt;code&gt;--checkpointxml&lt;/code&gt; &amp; &lt;code&gt;--reuse-external&lt;/code&gt; actually do?  \
&lt;/p&gt;&lt;p&gt;When should I use them?&lt;/p&gt;&lt;/div&gt;&lt;/div&gt;



</body></email><email><emailId>20220127040519</emailId><senderName>"M, Shivakumar"</senderName><senderEmail>shivakumar.m@intel.com</senderEmail><timestampReceived>2022-01-27 04:05:19-0400</timestampReceived><subject>Backend memory object creation - query</subject><body>

Hello,


For our use-case with Libvirt we want to create the Memory backend object ,

Expected QEMU args would be
-object memory-backend-memfd,id=mem1,size=4096M

Request you to please help us to specify this arg in the libvirt XML.

Thanks,
Shiv

[Attachment #3 (text/html)]

&lt;html xmlns:v="urn:schemas-microsoft-com:vml" \
xmlns:o="urn:schemas-microsoft-com:office:office" \
xmlns:w="urn:schemas-microsoft-com:office:word" \
xmlns:m="http://schemas.microsoft.com/office/2004/12/omml" \
xmlns="http://www.w3.org/TR/REC-html40"&gt; &lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=us-ascii"&gt;
&lt;meta name="Generator" content="Microsoft Word 15 (filtered medium)"&gt;
&lt;style&gt;&lt;!--
/* Font Definitions */
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
/* Style Definitions */
p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin:0in;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
span.EmailStyle17
	{mso-style-type:personal-compose;
	font-family:"Calibri",sans-serif;
	color:windowtext;}
.MsoChpDefault
	{mso-style-type:export-only;
	font-family:"Calibri",sans-serif;}
@page WordSection1
	{size:8.5in 11.0in;
	margin:1.0in 1.0in 1.0in 1.0in;}
div.WordSection1
	{page:WordSection1;}
--&gt;&lt;/style&gt;&lt;!--[if gte mso 9]&gt;&lt;xml&gt;
&lt;o:shapedefaults v:ext="edit" spidmax="1026" /&gt;
&lt;/xml&gt;&lt;![endif]--&gt;&lt;!--[if gte mso 9]&gt;&lt;xml&gt;
&lt;o:shapelayout v:ext="edit"&gt;
&lt;o:idmap v:ext="edit" data="1" /&gt;
&lt;/o:shapelayout&gt;&lt;/xml&gt;&lt;![endif]--&gt;
&lt;/head&gt;
&lt;body lang="EN-US" link="#0563C1" vlink="#954F72" style="word-wrap:break-word"&gt;
&lt;div class="WordSection1"&gt;
&lt;p class="MsoNormal"&gt;Hello,&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;For our use-case with Libvirt we want to create the Memory \
backend object ,&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;Expected QEMU args would be &lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;&lt;b&gt;&lt;span style="color:#4472C4"&gt;-object \
memory-backend-memfd,id=mem1,size=4096M &lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/b&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;&lt;b&gt;&lt;span style="color:#4472C4"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/span&gt;&lt;/b&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;Request you to please help us to specify this arg in the libvirt \
XML.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt; &lt;p class="MsoNormal"&gt;&lt;o:p&gt; &lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;Thanks,&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;p class="MsoNormal"&gt;Shiv&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;



</body></email><email><emailId>20220121144258</emailId><senderName>"Hakan E. Duran"</senderName><senderEmail>ehakanduran@gmail.com</senderEmail><timestampReceived>2022-01-21 14:42:58-0400</timestampReceived><subject>frequent network collapse possibly due to bridging</subject><body>


Hi,

I would like some help to troubleshoot the problem I have been having
lately with my VM host, which contains 5 VMs, one of which is for
pi-hole, unbound services. It has been a relatively common occurrence in
the last few weeks for me to find that the host machine has lost its
network when I get back home from work. Restoring the VM/VMs do not fix
the problem, the host needs to be restarted for a fix, otherwise there
is both loss of name resolution, as well as an internet connection; I
cannot ping even IPs such as 8.8.8.8. Since I use the pi-hole VM as the DNS
server for my LAN, this means that my whole LAN gets disconnected from
internet, until the host machine is rebooted. The host machine has a
little complicated network setup: the two gigabit connections are bonded
and bridged to the VMs; however this set up has been serving me so well
for several years now. The problem, on the other hand, appeared a few
weeks ago. This doesn't happen every day but often enough to be annoying
and disruptive for my family.

My question is, how can I troubleshoot this problem and figure out
whether it is truly due to network bridging somehow collapsing or not? I
tried to find some log files but all I could find were the
/var/log/libvirt/qemu/$VM files, and the particular log file for the pi-hole
VM reported the following lines; however, I am not sure if they are
associated with a real crash or just due to shutting down and restarting
the host (please excuse the word-wrapping):

char device redirected to /dev/pts/2 (label charserial0)
qxl_send_events: spice-server bug: guest stopped, ignoring
2022-01-20T23:41:17.012445Z qemu-system-x86_64: terminating on signal 15 from pid 1 (/sbin/init)
2022-01-20 23:41:17.716+0000: shutting down, reason=crashed
2022-01-20 23:42:46.059+0000: starting up libvirt version: 7.10.0, qemu
version: 6.2.0, kernel: 5.10.89-1-MANJARO, hostname: -redacted-

Please excuse my ignorance but is there a way to restart the
networking without rebooting the host machine? This will not solve my
problem since I won't be able to reach to the host remotely if the
networking is down. The real solution would be preventing these network
crashes and the first step in that would be effective troubleshooting in
my opinion. Any input/guidance will be greatly appreciated.

I can provide more info about my host/VM(s) if the above is not adequate.

Thanks,

Hakan Duran


["signature.asc" (application/pgp-signature)]

</body></email><email><emailId>20220124093537</emailId><senderName>Martin Kletzander</senderName><senderEmail>mkletzan@redhat.com</senderEmail><timestampReceived>2022-01-24 09:35:37-0400</timestampReceived><subject>Re: frequent network collapse possibly due to bridging</subject><body>


On Fri, Jan 21, 2022 at 08:42:58AM -0600, Hakan E. Duran wrote:
&gt;Hi,
&gt;
&gt;I would like some help to troubleshoot the problem I have been having
&gt;lately with my VM host, which contains 5 VMs, one of which is for
&gt;pi-hole, unbound services. It has been a relatively common occurrence in
&gt;the last few weeks for me to find that the host machine has lost its
&gt;network when I get back home from work. Restoring the VM/VMs do not fix
&gt;the problem, the host needs to be restarted for a fix, otherwise there
&gt;is both loss of name resolution, as well as an internet connection; I
&gt;cannot ping even IPs such as 8.8.8.8. Since I use the pi-hole VM as the DNS
&gt;server for my LAN, this means that my whole LAN gets disconnected from
&gt;internet, until the host machine is rebooted. The host machine has a
&gt;little complicated network setup: the two gigabit connections are bonded
&gt;and bridged to the VMs; however this set up has been serving me so well
&gt;for several years now. The problem, on the other hand, appeared a few
&gt;weeks ago. This doesn't happen every day but often enough to be annoying
&gt;and disruptive for my family.
&gt;

Always good to check what has changed those weeks ago, but I understand
it is difficult to find out what you were updating and where.

&gt;My question is, how can I troubleshoot this problem and figure out
&gt;whether it is truly due to network bridging somehow collapsing or not? I
&gt;tried to find some log files but all I could find were the
&gt;/var/log/libvirt/qemu/$VM files, and the particular log file for the pi-hole
&gt;VM reported the following lines; however, I am not sure if they are
&gt;associated with a real crash or just due to shutting down and restarting
&gt;the host (please excuse the word-wrapping):
&gt;
&gt;char device redirected to /dev/pts/2 (label charserial0)
&gt;qxl_send_events: spice-server bug: guest stopped, ignoring
&gt;2022-01-20T23:41:17.012445Z qemu-system-x86_64: terminating on signal 15 from pid 1 (/sbin/init)

Probably restarting the host as it got SIGTERM'd by init.  Maybe it was
restarted in a bad time and there is some inconsistency on the disk?
Using something like libvirt-guests which can manage your machines when
rebooting would be a good idea.

&gt;2022-01-20 23:41:17.716+0000: shutting down, reason=crashed
&gt;2022-01-20 23:42:46.059+0000: starting up libvirt version: 7.10.0, qemu
&gt;version: 6.2.0, kernel: 5.10.89-1-MANJARO, hostname: -redacted-
&gt;
&gt;Please excuse my ignorance but is there a way to restart the
&gt;networking without rebooting the host machine? This will not solve my

You can do:

virsh net-destroy &lt;network_name&gt;
virsh net-start &lt;network_name&gt;

but depending on what the network looks like, how it is set up etc. you
might need to restart some of the VMs or manually plug them in.

&gt;problem since I won't be able to reach to the host remotely if the
&gt;networking is down. The real solution would be preventing these network
&gt;crashes and the first step in that would be effective troubleshooting in
&gt;my opinion. Any input/guidance will be greatly appreciated.
&gt;
&gt;I can provide more info about my host/VM(s) if the above is not adequate.
&gt;

I'm not sure how much more I can help as I do not understand what is the
actual setup.  What I would do is try to figure out what exactly happens
when it breaks and then go from that (setting up logging etc.), just
general tips I guess.

&gt;Thanks,
&gt;
&gt;Hakan Duran
&gt;



["signature.asc" (application/pgp-signature)]

</body></email><email><emailId>20220124223016</emailId><senderName>Laine Stump</senderName><senderEmail>laine@redhat.com</senderEmail><timestampReceived>2022-01-24 22:30:16-0400</timestampReceived><subject>Re: frequent network collapse possibly due to bridging</subject><body>



On 1/24/22 4:35 AM, Martin Kletzander wrote:
&gt; On Fri, Jan 21, 2022 at 08:42:58AM -0600, Hakan E. Duran wrote:
&gt;&gt; Hi,
&gt;&gt;
&gt;&gt; I would like some help to troubleshoot the problem I have been having
&gt;&gt; lately with my VM host, which contains 5 VMs, one of which is for
&gt;&gt; pi-hole, unbound services. It has been a relatively common occurrence in
&gt;&gt; the last few weeks for me to find that the host machine has lost its
&gt;&gt; network when I get back home from work. Restoring the VM/VMs do not fix
&gt;&gt; the problem, the host needs to be restarted for a fix, otherwise there
&gt;&gt; is both loss of name resolution, as well as an internet connection; I
&gt;&gt; cannot ping even IPs such as 8.8.8.8. Since I use the pi-hole VM as 
&gt;&gt; the DNS
&gt;&gt; server for my LAN, this means that my whole LAN gets disconnected from
&gt;&gt; internet, until the host machine is rebooted. The host machine has a
&gt;&gt; little complicated network setup: the two gigabit connections are bonded
&gt;&gt; and bridged to the VMs; however this set up has been serving me so well
&gt;&gt; for several years now. The problem, on the other hand, appeared a few
&gt;&gt; weeks ago. This doesn't happen every day but often enough to be annoying
&gt;&gt; and disruptive for my family.
&gt;&gt;
&gt; 
&gt; Always good to check what has changed those weeks ago, but I understand
&gt; it is difficult to find out what you were updating and where.
&gt; 
&gt;&gt; My question is, how can I troubleshoot this problem and figure out
&gt;&gt; whether it is truly due to network bridging somehow collapsing or not? I
&gt;&gt; tried to find some log files but all I could find were the
&gt;&gt; /var/log/libvirt/qemu/$VM files, and the particular log file for the 
&gt;&gt; pi-hole
&gt;&gt; VM reported the following lines; however, I am not sure if they are
&gt;&gt; associated with a real crash or just due to shutting down and restarting
&gt;&gt; the host (please excuse the word-wrapping):
&gt;&gt;
&gt;&gt; char device redirected to /dev/pts/2 (label charserial0)
&gt;&gt; qxl_send_events: spice-server bug: guest stopped, ignoring
&gt;&gt; 2022-01-20T23:41:17.012445Z qemu-system-x86_64: terminating on signal 
&gt;&gt; 15 from pid 1 (/sbin/init)
&gt; 
&gt; Probably restarting the host as it got SIGTERM'd by init.   Maybe it was
&gt; restarted in a bad time and there is some inconsistency on the disk?
&gt; Using something like libvirt-guests which can manage your machines when
&gt; rebooting would be a good idea.
&gt; 
&gt;&gt; 2022-01-20 23:41:17.716+0000: shutting down, reason=crashed
&gt;&gt; 2022-01-20 23:42:46.059+0000: starting up libvirt version: 7.10.0, qemu
&gt;&gt; version: 6.2.0, kernel: 5.10.89-1-MANJARO, hostname: -redacted-
&gt;&gt;
&gt;&gt; Please excuse my ignorance but is there a way to restart the
&gt;&gt; networking without rebooting the host machine? This will not solve my
&gt; 
&gt; You can do:
&gt; 
&gt; virsh net-destroy &lt;network_name&gt;
&gt; virsh net-start &lt;network_name&gt;
&gt; 
&gt; but depending on what the network looks like, how it is set up etc. you
&gt; might need to restart some of the VMs or manually plug them in.

The connection between any guest tap device and a host bridge device 
will be broken by virsh net-destroy, and not restored by virsh net-start 
(because the network driver has no good way of notifying the QEMU driver 
that it has restarted a network). This is something that's been on my 
"list of annoying things I should fix some day" for a very long time, 
but I've never been motivated enough to figure out a clean solution.

In the meantime, if you destroy/start a network, you can get all the 
guest tap devices reconnected by restarting libvirtd:

    systemctl restart libvirtd.service

or if you're using split daemons:

    systemctl restart virtqemud.service

One of the things the QEMU driver does when it's initializing is to 
check where each guest tap device *should* be connected, compare that to 
where it *is* connected, and if those don't match then fix it.

</body></email><email><emailId>20220125012906</emailId><senderName>"Hakan E. Duran"</senderName><senderEmail>ehakanduran@gmail.com</senderEmail><timestampReceived>2022-01-25 01:29:06-0400</timestampReceived><subject>Re: frequent network collapse possibly due to bridging</subject><body>


Thank you for the reply. I truly appreciate them.

I used virt-manager to set up my VMs and manage them on a daily basis.
After reading your responses I used the commands below to gather some
information:

$sudo virsh net-list --all
 Name      State      Autostart   Persistent
----------------------------------------------
 default   inactive   no          yes

$sudo virsh net-info default
Name:           default
UUID:           some-number
Active:         no
Persistent:     yes
Autostart:      no
Bridge:         virbr0

I thought it was interesting that the default network was not marked to
restart at boot and changed that:

$sudo virsh net-autostart default
Network default marked as autostarted

Then due to its inactive status, I thought it would be a good idea to
start it with:

$sudo virsh net-start default
Network default started

Of note, even though the default network was marked as inactive as
above, it was working. In other words, I was able to reach the VMs,
which are part of that network, even before the `virsh net-start
default` command. Nothing seemed to break with the command either, and
everyting still seemed to work afterwards.

$sudo virsh net-info default
Name:           default
UUID:           some-number
Active:         yes
Persistent:     yes
Autostart:      yes
Bridge:         virbr0

I would really appreciate if you can confirm that this is the desired
state for my network for the purposes I discussed previously. I
apologize if I am oversimplifying things here, it is because of my lack
of in-depth understanding the appropriate set up.

Thanks,

Hakan

On 22/01/24 05:30PM, Laine Stump wrote:
&gt;
&gt;
&gt; On 1/24/22 4:35 AM, Martin Kletzander wrote:
&gt; &gt; On Fri, Jan 21, 2022 at 08:42:58AM -0600, Hakan E. Duran wrote:
&gt; &gt; &gt; Hi,
&gt; &gt; &gt;
&gt; &gt; &gt; I would like some help to troubleshoot the problem I have been having
&gt; &gt; &gt; lately with my VM host, which contains 5 VMs, one of which is for
&gt; &gt; &gt; pi-hole, unbound services. It has been a relatively common occurrence in
&gt; &gt; &gt; the last few weeks for me to find that the host machine has lost its
&gt; &gt; &gt; network when I get back home from work. Restoring the VM/VMs do not fix
&gt; &gt; &gt; the problem, the host needs to be restarted for a fix, otherwise there
&gt; &gt; &gt; is both loss of name resolution, as well as an internet connection; I
&gt; &gt; &gt; cannot ping even IPs such as 8.8.8.8. Since I use the pi-hole VM as
&gt; &gt; &gt; the DNS
&gt; &gt; &gt; server for my LAN, this means that my whole LAN gets disconnected from
&gt; &gt; &gt; internet, until the host machine is rebooted. The host machine has a
&gt; &gt; &gt; little complicated network setup: the two gigabit connections are bonded
&gt; &gt; &gt; and bridged to the VMs; however this set up has been serving me so well
&gt; &gt; &gt; for several years now. The problem, on the other hand, appeared a few
&gt; &gt; &gt; weeks ago. This doesn't happen every day but often enough to be annoying
&gt; &gt; &gt; and disruptive for my family.
&gt; &gt; &gt;
&gt; &gt;
&gt; &gt; Always good to check what has changed those weeks ago, but I understand
&gt; &gt; it is difficult to find out what you were updating and where.
&gt; &gt;
&gt; &gt; &gt; My question is, how can I troubleshoot this problem and figure out
&gt; &gt; &gt; whether it is truly due to network bridging somehow collapsing or not? I
&gt; &gt; &gt; tried to find some log files but all I could find were the
&gt; &gt; &gt; /var/log/libvirt/qemu/$VM files, and the particular log file for the
&gt; &gt; &gt; pi-hole
&gt; &gt; &gt; VM reported the following lines; however, I am not sure if they are
&gt; &gt; &gt; associated with a real crash or just due to shutting down and restarting
&gt; &gt; &gt; the host (please excuse the word-wrapping):
&gt; &gt; &gt;
&gt; &gt; &gt; char device redirected to /dev/pts/2 (label charserial0)
&gt; &gt; &gt; qxl_send_events: spice-server bug: guest stopped, ignoring
&gt; &gt; &gt; 2022-01-20T23:41:17.012445Z qemu-system-x86_64: terminating on
&gt; &gt; &gt; signal 15 from pid 1 (/sbin/init)
&gt; &gt;
&gt; &gt; Probably restarting the host as it got SIGTERM'd by init.  Maybe it was
&gt; &gt; restarted in a bad time and there is some inconsistency on the disk?
&gt; &gt; Using something like libvirt-guests which can manage your machines when
&gt; &gt; rebooting would be a good idea.
&gt; &gt;
&gt; &gt; &gt; 2022-01-20 23:41:17.716+0000: shutting down, reason=crashed
&gt; &gt; &gt; 2022-01-20 23:42:46.059+0000: starting up libvirt version: 7.10.0, qemu
&gt; &gt; &gt; version: 6.2.0, kernel: 5.10.89-1-MANJARO, hostname: -redacted-
&gt; &gt; &gt;
&gt; &gt; &gt; Please excuse my ignorance but is there a way to restart the
&gt; &gt; &gt; networking without rebooting the host machine? This will not solve my
&gt; &gt;
&gt; &gt; You can do:
&gt; &gt;
&gt; &gt; virsh net-destroy &lt;network_name&gt;
&gt; &gt; virsh net-start &lt;network_name&gt;
&gt; &gt;
&gt; &gt; but depending on what the network looks like, how it is set up etc. you
&gt; &gt; might need to restart some of the VMs or manually plug them in.
&gt;
&gt; The connection between any guest tap device and a host bridge device will be
&gt; broken by virsh net-destroy, and not restored by virsh net-start (because
&gt; the network driver has no good way of notifying the QEMU driver that it has
&gt; restarted a network). This is something that's been on my "list of annoying
&gt; things I should fix some day" for a very long time, but I've never been
&gt; motivated enough to figure out a clean solution.
&gt;
&gt; In the meantime, if you destroy/start a network, you can get all the guest
&gt; tap devices reconnected by restarting libvirtd:
&gt;
&gt;    systemctl restart libvirtd.service
&gt;
&gt; or if you're using split daemons:
&gt;
&gt;    systemctl restart virtqemud.service
&gt;
&gt; One of the things the QEMU driver does when it's initializing is to check
&gt; where each guest tap device *should* be connected, compare that to where it
&gt; *is* connected, and if those don't match then fix it.
&gt;

["signature.asc" (application/pgp-signature)]

</body></email><email><emailId>20220129064724</emailId><senderName>Charles Polisher</senderName><senderEmail>chas@chasmo.org</senderEmail><timestampReceived>2022-01-29 06:47:24-0400</timestampReceived><subject>Re: frequent network collapse possibly due to bridging</subject><body>

On 1/24/22 17:29, Hakan E. Duran wrote
&gt; Then due to its inactive status, I thought it would be a good idea to
&gt; start it with:
&gt;
&gt; $sudo virsh net-start default
&gt; Network default started
&gt;
&gt; Of note, even though the default network was marked as inactive as
&gt; above, it was working. In other words, I was able to reach the VMs,
&gt; which are part of that network, even before the `virsh net-start
&gt; default` command. Nothing seemed to break with the command either, and
&gt; everyting still seemed to work afterwards.
&gt;
&gt; $sudo virsh net-info default
&gt; Name:           default
&gt; UUID:           some-number
&gt; Active:         yes
&gt; Persistent:     yes
&gt; Autostart:      yes
&gt; Bridge:         virbr0
&gt;
&gt; I would really appreciate if you can confirm that this is the desired
&gt; state for my network for the purposes I discussed previously. I
&gt; apologize if I am oversimplifying things here, it is because of my lack
&gt; of in-depth understanding the appropriate set up.

Seeing as there are no other replies yet, for what it's worth,
on my hypervisor I see similar results for a working system,
and to my knowledge it's all running correctly:

     # virsh net-info default
     Name:           default
     UUID:           32ecb497-5a0b-46fd-9786-df4a6ceec9ce
     Active:         yes
     Persistent:     yes
     Autostart:      yes
     Bridge:         virbr0

Also, this from my library of scripts:

# ---- cut here ----
#!/bin/bash
#
# Yury V. Zaytsev &lt;yury@shurup.com&gt; (C) 2011
# cf. 
http://git.zaytsev.net/?p=anubis-puppet.git;a=blob;f=manifests/files/common/network-restart
#
# This work is herewith placed in public domain.
#
# Use this script to cleanly restart the default libvirt network after its
# definition have been changed (e.g. added new static MAC+IP mappings) 
in order
# for the changes to take effect. Restarting the network alone, however, 
causes
# the guests to lose connectivity with the host until their network 
interfaces
# are re-attached.
#
# The script re-attaches the interfaces by obtaining the information 
about them
# from the current libvirt definitions. It has the following dependencies:
#
#   - virsh (obviously)
#   - tail / head / grep / awk / cut
#   - XML::XPath (e.g. perl-XML-XPath package)
#
# Note that it assumes that the guests have exactly 1 NAC each attached 
to the
# given network! Extensions to account for more (or none) interfaces 
etc. are,
# of course, most welcome.
#
# ZYV
#

set -e
set -u

NETWORK_NAME=default
NETWORK_HOOK=/etc/libvirt/hooks/qemu

virsh net-define /opt/config/libvirt/network-$NETWORK_NAME.xml
virsh net-destroy $NETWORK_NAME
virsh net-start $NETWORK_NAME

MACHINES=$( virsh list | tail -n +3 | head -n -1 | awk '{ print $2; }' )

for m in $MACHINES ; do

     MACHINE_INFO=$( virsh dumpxml "$m" | xpath 
/domain/devices/interface[1] 2&gt; /dev/null )
     MACHINE_MAC=$( echo "$MACHINE_INFO" | grep "mac address" | cut -d 
'"' -f 2 )
     MACHINE_MOD=$( echo "$MACHINE_INFO" | grep "model type" | cut -d 
'"' -f 2 )

     set +e
     virsh detach-interface "$m" network --mac "$MACHINE_MAC" &amp;&amp; sleep 3
     virsh attach-interface "$m" network $NETWORK_NAME --mac 
"$MACHINE_MAC" --model "$MACHINE_MOD"
     set -e

     $NETWORK_HOOK "$m" stopped &amp;&amp; sleep 3
     $NETWORK_HOOK "$m" start

done
# ---- cut here ----


</body></email><email><emailId>20220129180635</emailId><senderName>"Hakan E. Duran"</senderName><senderEmail>ehakanduran@gmail.com</senderEmail><timestampReceived>2022-01-29 18:06:35-0400</timestampReceived><subject>Re: frequent network collapse possibly due to bridging</subject><body>


On 22/01/28 10:47PM, Charles Polisher wrote:
&gt; ...
&gt; Seeing as there are no other replies yet, for what it's worth,
&gt; on my hypervisor I see similar results for a working system,
&gt; and to my knowledge it's all running correctly:
&gt; 
&gt; # virsh net-info default
&gt; Name:           default
&gt; UUID:           32ecb497-5a0b-46fd-9786-df4a6ceec9ce
&gt; Active:         yes
&gt; Persistent:     yes
&gt; Autostart:      yes
&gt; Bridge:         virbr0
&gt; 
&gt; Also, this from my library of scripts:

Thank you so much for confirming this!
&gt; 
&gt; # ---- cut here ----
&gt; #!/bin/bash
&gt; #
&gt; # Yury V. Zaytsev &lt;yury@shurup.com&gt; (C) 2011
&gt; # cf. http://git.zaytsev.net/?p=anubis-puppet.git;a=blob;f=manifests/files/common/network-restart
&gt;  #
&gt; # This work is herewith placed in public domain.
&gt; #
&gt; # Use this script to cleanly restart the default libvirt network after its
&gt; # definition have been changed (e.g. added new static MAC+IP mappings) in
&gt; order
&gt; # for the changes to take effect. Restarting the network alone, however,
&gt; causes
&gt; # the guests to lose connectivity with the host until their network
&gt; interfaces
&gt; # are re-attached.
&gt; #
&gt; # The script re-attaches the interfaces by obtaining the information about
&gt; them
&gt; # from the current libvirt definitions. It has the following dependencies:
&gt; #
&gt; #   - virsh (obviously)
&gt; #   - tail / head / grep / awk / cut
&gt; #   - XML::XPath (e.g. perl-XML-XPath package)
&gt; #
&gt; # Note that it assumes that the guests have exactly 1 NAC each attached to
&gt; the
&gt; # given network! Extensions to account for more (or none) interfaces etc.
&gt; are,
&gt; # of course, most welcome.
&gt; #
&gt; # ZYV
&gt; #
&gt; 
&gt; set -e
&gt; set -u
&gt; 
&gt; NETWORK_NAME=default
&gt; NETWORK_HOOK=/etc/libvirt/hooks/qemu
&gt; 
&gt; virsh net-define /opt/config/libvirt/network-$NETWORK_NAME.xml
&gt; virsh net-destroy $NETWORK_NAME
&gt; virsh net-start $NETWORK_NAME
&gt; 
&gt; MACHINES=$( virsh list | tail -n +3 | head -n -1 | awk '{ print $2; }' )
&gt; 
&gt; for m in $MACHINES ; do
&gt; 
&gt; MACHINE_INFO=$( virsh dumpxml "$m" | xpath /domain/devices/interface[1]
&gt; 2&gt; /dev/null )
&gt; MACHINE_MAC=$( echo "$MACHINE_INFO" | grep "mac address" | cut -d '"' -f
&gt; 2 )
&gt; MACHINE_MOD=$( echo "$MACHINE_INFO" | grep "model type" | cut -d '"' -f
&gt; 2 )
&gt; 
&gt; set +e
&gt; virsh detach-interface "$m" network --mac "$MACHINE_MAC" &amp;&amp; sleep 3
&gt; virsh attach-interface "$m" network $NETWORK_NAME --mac "$MACHINE_MAC"
&gt; --model "$MACHINE_MOD"
&gt; set -e
&gt; 
&gt; $NETWORK_HOOK "$m" stopped &amp;&amp; sleep 3
&gt; $NETWORK_HOOK "$m" start
&gt; 
&gt; done
&gt; # ---- cut here ----
&gt; 
Thank you so much for sharing your script as well! This is so helpful.

I had my LAN crash yesterday again and I did a few experiments. I tested pinging the \
hosts within the LAN from one of my VMs and this wasn't possible (host unreachable). \
So, just to clarify, pinging any host within the LAN as well as outside the LAN was \
not possible from the VM. The hypervisor WAS able to ping the VM though and I was \
able to ssh into the VM from the hypervisor. Hypervisor could not ping any other \
computer in the LAN either (same host unreachable error). Name resolution within the \
LAN was confirmed to be intact while pinging both by hostname and IP. Just to test \
it, I destroyed the libvirt network and restarted it, however, I didn't use several \
commands used by this script such as virsh detach/attach-interface and $NETWORK_HOOK, \
so looking back, it was an incomplete attempt. This did not solve the problem. My LAN \
architecture starts with cable modem that is connected via ethernet cable to my \
router, which is connected to my 24-port switch with the same. All computers that \
were pinged and could not be reached are connected to the switch via ethernet cables, \
just like the hypervisor itself. Wireless access point is also connected to the \
switch via ethernet cable, and the internet access was lost on wireless network as \
well. I use one of my VMs in this hypervisor as the primary DNS server for my lan \
through pi-hole and unbound. I believe the loss of internet is attributable to the \
loss of bridge network on this VM. Internal network between the hypervisor and the VM \
seems to have been preserved somehow (see above). The cable modem seemed OK and \
connected by interpretation of its lights during the crash. Rebooting the hypervisor \
solved the problem and LAN was again restored without needing to do anything else. I \
am stumped. For now, I changed my primary DNS server from the VM to a physical \
raspberry pi as a first step.  Pi used to be the secondary DNS server, now it is \
primary. The VM, on the other hand, is now the secondary DNS server. I am hoping \
that, if the libvirt network crashes again(?) I shouldn't lose the whole LAN perhaps \
by this change. I am not sure what may be the root cause of this problem. virsh \
net-info default during the crash gave the same output as if nothing was wrong with \
it. Thank you for your time, I truly appreciate it knowing that it may not be \
possible to identify what actually is wrong/failing.

Hakan


["signature.asc" (application/pgp-signature)]

</body></email><email><emailId>20220114211853</emailId><senderName>Peter Krempa</senderName><senderEmail>pkrempa@redhat.com</senderEmail><timestampReceived>2022-01-14 21:18:53-0400</timestampReceived><subject>Re: What does the positional parameters of "virsh backup-begin" actually do?</subject><body>

On Fri, Jan 14, 2022 at 23:39:10 +0600, Ahmad Ismail wrote:
&gt; Normally when I backup a kvm machine I shutdown the machine then run:

[...]

&gt; The problem with this help is, it is not clear enough.
&gt; 
&gt; I understand that I should use virsh backup-begin vm1 to backup a live kvm
&gt; machine. However, this command only create .qcow2 files. What about the .xml
&gt; file.
&gt; 
&gt; What does --backupxml , --checkpointxml &amp; --reuse-external actually do?
&gt; 
&gt; When should I use them?

'man virsh' states:

   backup-begin
       Syntax:

          backup-begin domain [backupxml] [checkpointxml] [--reuse-external]

       Begin a new backup job. If backupxml is omitted, this defaults  to
       a  full  backup  using a push model to filenames generated by lib-
       virt; supplying XML allows fine-tuning such as requesting  an  in-
       cremental  backup  relative  to an earlier checkpoint, controlling
       which disks participate or which filenames are  involved,  or  re-
       questing  the use of a pull model backup.  The backup-dumpxml com-
       mand shows any resulting values assigned by libvirt. For more  in-
       formation           on          backup          XML,          see:
       https://libvirt.org/formatbackup.html

       If --reuse-external is used it instructs libvirt to  reuse  tempo-
       rary and output files provided by the user in backupxml.

       If checkpointxml is specified, a second file with a top-level ele-
       ment of domaincheckpoint is used to create a  simultaneous  check-
       point,  for  doing a later incremental backup relative to the time
       the backup was created. See checkpoint-create for more details  on
       checkpoints.

       This  command returns as soon as possible, and the backup job runs
       in the background; the progress of a  push  model  backup  can  be
       checked with domjobinfo or by waiting for an event with event (the
       progress of a pull model backup is under the control  of  whatever
       third  party  connects  to  the NBD export). The job is ended with
       domjobabort.


Does this clarify it sufficiently?

</body></email><email><emailId>20220111172923</emailId><senderName>Daniel =?utf-8?B?UC4gQmVycmFuZ8Op?=</senderName><senderEmail>berrange@redhat.com</senderEmail><timestampReceived>2022-01-11 17:29:23-0400</timestampReceived><subject>Re: DMARC &amp; similar @admins</subject><body>

On Tue, Jan 11, 2022 at 05:18:53PM +0000, lejeczek wrote:
&gt; Hi guys
&gt; 
&gt; My memory fools me? - I remembered this list had DMAR+other_bits sorted, so
&gt; users like myself, on Yahoo, did not loose their own emails.

Nope, it is currently unfixable. The mail server software handling
@redhat.com culls the DKIM signatures, so anyone sending from a
domain that requests strict DMARC policy will have their sent mail
dropped by any recipient that honours this.  This basically means
that most subscribers to this list won't see any mail sent by
@yahoo addresses.

I've had bug report escalated for over a year now and there's no
ETA to fix it.

Regards,
Daniel
-- 
|: https://berrange.com      -o-    https://www.flickr.com/photos/dberrange :|
|: https://libvirt.org         -o-            https://fstop138.berrange.com :|
|: https://entangle-photo.org    -o-    https://www.instagram.com/dberrange :|

</body></email><email><emailId>20220111185829</emailId><senderName>lejeczek</senderName><senderEmail>peljasz@yahoo.co.uk</senderEmail><timestampReceived>2022-01-11 18:58:29-0400</timestampReceived><subject>Re: DMARC &amp; similar @admins</subject><body>



On 11/01/2022 17:29, Daniel P. Berrangé wrote:
&gt; On Tue, Jan 11, 2022 at 05:18:53PM +0000, lejeczek wrote:
&gt;&gt; Hi guys
&gt;&gt;
&gt;&gt; My memory fools me? - I remembered this list had DMAR+other_bits sorted, so
&gt;&gt; users like myself, on Yahoo, did not loose their own emails.
&gt; Nope, it is currently unfixable. The mail server software handling
&gt; @redhat.com culls the DKIM signatures, so anyone sending from a
&gt; domain that requests strict DMARC policy will have their sent mail
&gt; dropped by any recipient that honours this.  This basically means
&gt; that most subscribers to this list won't see any mail sent by
&gt; @yahoo addresses.
&gt;
&gt; I've had bug report escalated for over a year now and there's no
&gt; ETA to fix it.
&gt;
&gt; Regards,
&gt; Daniel
I don't know if it's the exact same Redhat(platform) but 
might be worth consulting freeIPA, oVirt, clusterlabs(who 
recently fixed it) - "it" works over there.

thanks, L.

</body></email><email><emailId>20220111163647</emailId><senderName>Daniel =?utf-8?B?UC4gQmVycmFuZ8Op?=</senderName><senderEmail>berrange@redhat.com</senderEmail><timestampReceived>2022-01-11 16:36:47-0400</timestampReceived><subject>Re: 'migrate' says it worked but in reality it did not - centOS 9</subject><body>

On Tue, Jan 11, 2022 at 04:30:11PM +0000, lejeczek wrote:
&gt; Hi guys.
&gt; 
&gt; I have a peculiar situation where between boxes:
&gt; C-&gt;A
&gt; -&gt; $ virsh migrate --unsafe --live c8kubermaster1
&gt; qemu+ssh://10.1.1.99/system
&gt; -&gt; $ echo $?
&gt; 0
&gt; but above does _not_ happen, instead!! VM was stopped in started, but _not_
&gt; migrated LIVE
&gt; 
&gt; A-&gt;C
&gt; -&gt; $ virsh migrate --unsafe --live c8kubermaster1
&gt; qemu+ssh://10.1.1.100/system
&gt; -&gt; $ echo $?
&gt; 0
&gt; indeed VM migrates live.
&gt; 
&gt; box A &amp; C have virtually identical OS stack,
&gt; HW difference is:
&gt; C = Ryzen 5 5600G
&gt; A = Ryzen 5 3600
&gt; 
&gt; domain XML snippet where I think it matters:
&gt; ...
&gt;   &lt;/metadata&gt;
&gt;   &lt;memory unit='GiB'&gt;4&lt;/memory&gt;
&gt;   &lt;currentMemory unit='GiB'&gt;4&lt;/currentMemory&gt;
&gt;   &lt;vcpu placement='static'&gt;2&lt;/vcpu&gt;
&gt;   &lt;resource&gt;
&gt;     &lt;partition&gt;/machine&lt;/partition&gt;
&gt;   &lt;/resource&gt;
&gt;   &lt;os&gt;
&gt;     &lt;type arch='x86_64' machine='pc-i440fx-rhel7.6.0'&gt;hvm&lt;/type&gt;
&gt;     &lt;boot dev='hd'/&gt;
&gt;   &lt;/os&gt;
&gt;   &lt;features&gt;
&gt;     &lt;acpi/&gt;
&gt;     &lt;apic/&gt;
&gt;   &lt;/features&gt;
&gt;   &lt;cpu mode='custom' match='exact' check='full'&gt;
&gt;     &lt;model fallback='forbid'&gt;EPYC-IBPB&lt;/model&gt;
&gt;     &lt;feature policy='require' name='ibpb'/&gt;
&gt;     &lt;feature policy='require' name='ssbd'/&gt;
&gt;     &lt;feature policy='require' name='virt-ssbd'/&gt;
&gt;     &lt;feature policy='disable' name='monitor'/&gt;
&gt;     &lt;feature policy='require' name='x2apic'/&gt;
&gt;     &lt;feature policy='require' name='hypervisor'/&gt;
&gt;     &lt;feature policy='disable' name='svm'/&gt;
&gt;     &lt;feature policy='require' name='topoext'/&gt;
&gt;   &lt;/cpu&gt;
&gt;   &lt;clock offset='utc'&gt;
&gt;     &lt;timer name='rtc' tickpolicy='catchup'/&gt;
&gt;     &lt;timer name='pit' tickpolicy='delay'/&gt;
&gt;     &lt;timer name='hpet' present='no'/&gt;
&gt;   &lt;/clock&gt;
&gt;   &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
&gt;   &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
&gt;   &lt;on_crash&gt;destroy&lt;/on_crash&gt;
&gt;   &lt;pm&gt;
&gt;     &lt;suspend-to-mem enabled='no'/&gt;
&gt;     &lt;suspend-to-disk enabled='no'/&gt;
&gt;   &lt;/pm&gt;
&gt;   &lt;devices&gt;
&gt;     &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;
&gt;     &lt;disk type='file' device='disk'&gt;
&gt; ...
&gt; 
&gt; Initially I submitted a BZ against 'PCS' but continued to filled with it and
&gt; I find 'libvirt' might be the culprit(also?) here.
&gt; There is not much in logs, certainly nothing (with default verbosity) in
&gt; virtqemud.service
&gt; Is it that VM gets migrated but then is restarted on 'migrate_to' host? if
&gt; so then why?
&gt; How to start troubleshooting such 'monstrosity'? - all suggestions
&gt; appreciated.

/var/log/libvirt/qemu/$GUEST.log  on both hosts should have more info


Regards,
Daniel
-- 
|: https://berrange.com      -o-    https://www.flickr.com/photos/dberrange :|
|: https://libvirt.org         -o-            https://fstop138.berrange.com :|
|: https://entangle-photo.org    -o-    https://www.instagram.com/dberrange :|

</body></email><email><emailId>20220111171453</emailId><senderName>lejeczek</senderName><senderEmail>peljasz@yahoo.co.uk</senderEmail><timestampReceived>2022-01-11 17:14:53-0400</timestampReceived><subject>Re: 'migrate' says it worked but in reality it did not - centOS 9</subject><body>



On 11/01/2022 16:36, Daniel P. Berrangé wrote:
&gt; On Tue, Jan 11, 2022 at 04:30:11PM +0000, lejeczek wrote:
&gt;&gt; Hi guys.
&gt;&gt;
&gt;&gt; I have a peculiar situation where between boxes:
&gt;&gt; C-&gt;A
&gt;&gt; -&gt; $ virsh migrate --unsafe --live c8kubermaster1
&gt;&gt; qemu+ssh://10.1.1.99/system
&gt;&gt; -&gt; $ echo $?
&gt;&gt; 0
&gt;&gt; but above does _not_ happen, instead!! VM was stopped in started, but _not_
&gt;&gt; migrated LIVE
&gt;&gt;
&gt;&gt; A-&gt;C
&gt;&gt; -&gt; $ virsh migrate --unsafe --live c8kubermaster1
&gt;&gt; qemu+ssh://10.1.1.100/system
&gt;&gt; -&gt; $ echo $?
&gt;&gt; 0
&gt;&gt; indeed VM migrates live.
&gt;&gt;
&gt;&gt; box A &amp; C have virtually identical OS stack,
&gt;&gt; HW difference is:
&gt;&gt; C = Ryzen 5 5600G
&gt;&gt; A = Ryzen 5 3600
&gt;&gt;
&gt;&gt; domain XML snippet where I think it matters:
&gt;&gt; ...
&gt;&gt;    &lt;/metadata&gt;
&gt;&gt;    &lt;memory unit='GiB'&gt;4&lt;/memory&gt;
&gt;&gt;    &lt;currentMemory unit='GiB'&gt;4&lt;/currentMemory&gt;
&gt;&gt;    &lt;vcpu placement='static'&gt;2&lt;/vcpu&gt;
&gt;&gt;    &lt;resource&gt;
&gt;&gt;      &lt;partition&gt;/machine&lt;/partition&gt;
&gt;&gt;    &lt;/resource&gt;
&gt;&gt;    &lt;os&gt;
&gt;&gt;      &lt;type arch='x86_64' machine='pc-i440fx-rhel7.6.0'&gt;hvm&lt;/type&gt;
&gt;&gt;      &lt;boot dev='hd'/&gt;
&gt;&gt;    &lt;/os&gt;
&gt;&gt;    &lt;features&gt;
&gt;&gt;      &lt;acpi/&gt;
&gt;&gt;      &lt;apic/&gt;
&gt;&gt;    &lt;/features&gt;
&gt;&gt;    &lt;cpu mode='custom' match='exact' check='full'&gt;
&gt;&gt;      &lt;model fallback='forbid'&gt;EPYC-IBPB&lt;/model&gt;
&gt;&gt;      &lt;feature policy='require' name='ibpb'/&gt;
&gt;&gt;      &lt;feature policy='require' name='ssbd'/&gt;
&gt;&gt;      &lt;feature policy='require' name='virt-ssbd'/&gt;
&gt;&gt;      &lt;feature policy='disable' name='monitor'/&gt;
&gt;&gt;      &lt;feature policy='require' name='x2apic'/&gt;
&gt;&gt;      &lt;feature policy='require' name='hypervisor'/&gt;
&gt;&gt;      &lt;feature policy='disable' name='svm'/&gt;
&gt;&gt;      &lt;feature policy='require' name='topoext'/&gt;
&gt;&gt;    &lt;/cpu&gt;
&gt;&gt;    &lt;clock offset='utc'&gt;
&gt;&gt;      &lt;timer name='rtc' tickpolicy='catchup'/&gt;
&gt;&gt;      &lt;timer name='pit' tickpolicy='delay'/&gt;
&gt;&gt;      &lt;timer name='hpet' present='no'/&gt;
&gt;&gt;    &lt;/clock&gt;
&gt;&gt;    &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
&gt;&gt;    &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
&gt;&gt;    &lt;on_crash&gt;destroy&lt;/on_crash&gt;
&gt;&gt;    &lt;pm&gt;
&gt;&gt;      &lt;suspend-to-mem enabled='no'/&gt;
&gt;&gt;      &lt;suspend-to-disk enabled='no'/&gt;
&gt;&gt;    &lt;/pm&gt;
&gt;&gt;    &lt;devices&gt;
&gt;&gt;      &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;
&gt;&gt;      &lt;disk type='file' device='disk'&gt;
&gt;&gt; ...
&gt;&gt;
&gt;&gt; Initially I submitted a BZ against 'PCS' but continued to filled with it and
&gt;&gt; I find 'libvirt' might be the culprit(also?) here.
&gt;&gt; There is not much in logs, certainly nothing (with default verbosity) in
&gt;&gt; virtqemud.service
&gt;&gt; Is it that VM gets migrated but then is restarted on 'migrate_to' host? if
&gt;&gt; so then why?
&gt;&gt; How to start troubleshooting such 'monstrosity'? - all suggestions
&gt;&gt; appreciated.
&gt; /var/log/libvirt/qemu/$GUEST.log  on both hosts should have more info
&gt;
What if there is not much there neither?
migrate_to(host A) seems to show only config for qemu, no 
errors no warnings.
migrate_from(host C) shows only:
...
2022-01-11 17:00:40.687+0000: initiating migration
2022-01-11 17:00:43.413+0000: shutting down, reason=migrated
2022-01-11T17:00:43.414063Z qemu-kvm: terminating on signal 
15 from pid 24022 (&lt;unknown process&gt;)

no errors/warning but that 2nd line - ??

Again, migrating back between the same two hosts - where 
LIVE succeeds
migrate_from(host A) also shows:
...
2022-01-11 17:10:27.921+0000: initiating migration
2022-01-11 17:10:30.459+0000: shutting down, reason=migrated
2022-01-11T17:10:30.460528Z qemu-kvm: terminating on signal 
15 from pid 73193 (&lt;unknown process&gt;

thanks, L

</body></email><email><emailId>20220111173316</emailId><senderName>Daniel =?utf-8?B?UC4gQmVycmFuZ8Op?=</senderName><senderEmail>berrange@redhat.com</senderEmail><timestampReceived>2022-01-11 17:33:16-0400</timestampReceived><subject>Re: 'migrate' says it worked but in reality it did not - centOS 9</subject><body>

On Tue, Jan 11, 2022 at 05:14:53PM +0000, lejeczek wrote:
&gt; 
&gt; 
&gt; On 11/01/2022 16:36, Daniel P. Berrangé wrote:
&gt; &gt; On Tue, Jan 11, 2022 at 04:30:11PM +0000, lejeczek wrote:
&gt; &gt; &gt; Hi guys.
&gt; &gt; &gt; 
&gt; &gt; &gt; I have a peculiar situation where between boxes:
&gt; &gt; &gt; C-&gt;A
&gt; &gt; &gt; -&gt; $ virsh migrate --unsafe --live c8kubermaster1
&gt; &gt; &gt; qemu+ssh://10.1.1.99/system
&gt; &gt; &gt; -&gt; $ echo $?
&gt; &gt; &gt; 0
&gt; &gt; &gt; but above does _not_ happen, instead!! VM was stopped in started, but _not_
&gt; &gt; &gt; migrated LIVE
&gt; &gt; &gt; 
&gt; &gt; &gt; A-&gt;C
&gt; &gt; &gt; -&gt; $ virsh migrate --unsafe --live c8kubermaster1
&gt; &gt; &gt; qemu+ssh://10.1.1.100/system
&gt; &gt; &gt; -&gt; $ echo $?
&gt; &gt; &gt; 0
&gt; &gt; &gt; indeed VM migrates live.
&gt; &gt; &gt; 
&gt; &gt; &gt; box A &amp; C have virtually identical OS stack,
&gt; &gt; &gt; HW difference is:
&gt; &gt; &gt; C = Ryzen 5 5600G
&gt; &gt; &gt; A = Ryzen 5 3600
&gt; &gt; &gt; 
&gt; &gt; &gt; domain XML snippet where I think it matters:
&gt; &gt; &gt; ...
&gt; &gt; &gt;    &lt;/metadata&gt;
&gt; &gt; &gt;    &lt;memory unit='GiB'&gt;4&lt;/memory&gt;
&gt; &gt; &gt;    &lt;currentMemory unit='GiB'&gt;4&lt;/currentMemory&gt;
&gt; &gt; &gt;    &lt;vcpu placement='static'&gt;2&lt;/vcpu&gt;
&gt; &gt; &gt;    &lt;resource&gt;
&gt; &gt; &gt;      &lt;partition&gt;/machine&lt;/partition&gt;
&gt; &gt; &gt;    &lt;/resource&gt;
&gt; &gt; &gt;    &lt;os&gt;
&gt; &gt; &gt;      &lt;type arch='x86_64' machine='pc-i440fx-rhel7.6.0'&gt;hvm&lt;/type&gt;
&gt; &gt; &gt;      &lt;boot dev='hd'/&gt;
&gt; &gt; &gt;    &lt;/os&gt;
&gt; &gt; &gt;    &lt;features&gt;
&gt; &gt; &gt;      &lt;acpi/&gt;
&gt; &gt; &gt;      &lt;apic/&gt;
&gt; &gt; &gt;    &lt;/features&gt;
&gt; &gt; &gt;    &lt;cpu mode='custom' match='exact' check='full'&gt;
&gt; &gt; &gt;      &lt;model fallback='forbid'&gt;EPYC-IBPB&lt;/model&gt;
&gt; &gt; &gt;      &lt;feature policy='require' name='ibpb'/&gt;
&gt; &gt; &gt;      &lt;feature policy='require' name='ssbd'/&gt;
&gt; &gt; &gt;      &lt;feature policy='require' name='virt-ssbd'/&gt;
&gt; &gt; &gt;      &lt;feature policy='disable' name='monitor'/&gt;
&gt; &gt; &gt;      &lt;feature policy='require' name='x2apic'/&gt;
&gt; &gt; &gt;      &lt;feature policy='require' name='hypervisor'/&gt;
&gt; &gt; &gt;      &lt;feature policy='disable' name='svm'/&gt;
&gt; &gt; &gt;      &lt;feature policy='require' name='topoext'/&gt;
&gt; &gt; &gt;    &lt;/cpu&gt;
&gt; &gt; &gt;    &lt;clock offset='utc'&gt;
&gt; &gt; &gt;      &lt;timer name='rtc' tickpolicy='catchup'/&gt;
&gt; &gt; &gt;      &lt;timer name='pit' tickpolicy='delay'/&gt;
&gt; &gt; &gt;      &lt;timer name='hpet' present='no'/&gt;
&gt; &gt; &gt;    &lt;/clock&gt;
&gt; &gt; &gt;    &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
&gt; &gt; &gt;    &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
&gt; &gt; &gt;    &lt;on_crash&gt;destroy&lt;/on_crash&gt;
&gt; &gt; &gt;    &lt;pm&gt;
&gt; &gt; &gt;      &lt;suspend-to-mem enabled='no'/&gt;
&gt; &gt; &gt;      &lt;suspend-to-disk enabled='no'/&gt;
&gt; &gt; &gt;    &lt;/pm&gt;
&gt; &gt; &gt;    &lt;devices&gt;
&gt; &gt; &gt;      &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;
&gt; &gt; &gt;      &lt;disk type='file' device='disk'&gt;
&gt; &gt; &gt; ...
&gt; &gt; &gt; 
&gt; &gt; &gt; Initially I submitted a BZ against 'PCS' but continued to filled with it and
&gt; &gt; &gt; I find 'libvirt' might be the culprit(also?) here.
&gt; &gt; &gt; There is not much in logs, certainly nothing (with default verbosity) in
&gt; &gt; &gt; virtqemud.service
&gt; &gt; &gt; Is it that VM gets migrated but then is restarted on 'migrate_to' host? if
&gt; &gt; &gt; so then why?
&gt; &gt; &gt; How to start troubleshooting such 'monstrosity'? - all suggestions
&gt; &gt; &gt; appreciated.
&gt; &gt; /var/log/libvirt/qemu/$GUEST.log  on both hosts should have more info
&gt; &gt; 
&gt; What if there is not much there neither?
&gt; migrate_to(host A) seems to show only config for qemu, no errors no
&gt; warnings.
&gt; migrate_from(host C) shows only:
&gt; ...
&gt; 2022-01-11 17:00:40.687+0000: initiating migration
&gt; 2022-01-11 17:00:43.413+0000: shutting down, reason=migrated
&gt; 2022-01-11T17:00:43.414063Z qemu-kvm: terminating on signal 15 from pid
&gt; 24022 (&lt;unknown process&gt;)
&gt; 
&gt; no errors/warning but that 2nd line - ??
&gt; 
&gt; Again, migrating back between the same two hosts - where LIVE succeeds
&gt; migrate_from(host A) also shows:
&gt; ...
&gt; 2022-01-11 17:10:27.921+0000: initiating migration
&gt; 2022-01-11 17:10:30.459+0000: shutting down, reason=migrated
&gt; 2022-01-11T17:10:30.460528Z qemu-kvm: terminating on signal 15 from pid
&gt; 73193 (&lt;unknown process&gt;

Both those logs only show the state on the src QEMU during a
migration op. There should be corresponding log for the dst
QEMU at the same point in time.

All tehse messages show that migration was successful from libvirt and
QEMU's POV on the src.

So I expect what'ps happening is that QEMU is crashing on the target
host after migration has finished.

Regards,
Daniel
-- 
|: https://berrange.com      -o-    https://www.flickr.com/photos/dberrange :|
|: https://libvirt.org         -o-            https://fstop138.berrange.com :|
|: https://entangle-photo.org    -o-    https://www.instagram.com/dberrange :|

</body></email><email><emailId>20220110120443</emailId><senderName>Dana Elfassy</senderName><senderEmail>delfassy@redhat.com</senderEmail><timestampReceived>2022-01-10 12:04:43-0400</timestampReceived><subject>Re: error during host deploy</subject><body>

sorry, I missed your last reply
I didn't reproduce it yet, but fedora rpm would be great. just in case
thanks

On Thu, Dec 23, 2021 at 7:04 AM Michal Pr=C3=ADvozn=C3=ADk &lt;mprivozn@redhat=
.com&gt;
wrote:

&gt; On 12/22/21 08:44, Dana Elfassy wrote:
&gt; &gt; Thanks,
&gt; &gt; Is it possible that you create an rpm with this fix so I can use it on
&gt; &gt; the test runs and try to reproduce?
&gt;
&gt; Oh, sure. Is fedora rpm fine?
&gt;
&gt; Michal
&gt;
&gt;

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;sorry, I missed your last reply&lt;div&gt;I didn't reproduce it yet, but \
fedora rpm would  be great. just in case  &lt;/div&gt;&lt;div&gt;thanks&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div \
class="gmail_quote"&gt;&lt;div dir="ltr" class="gmail_attr"&gt;On Thu, Dec 23, 2021 at 7:04 AM \
Michal Prívozník &lt;&lt;a \
href="mailto:mprivozn@redhat.com"&gt;mprivozn@redhat.com&lt;/a&gt;&gt; \
wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0px 0px 0px \
0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"&gt;On 12/22/21 08:44, \
Dana Elfassy wrote:&lt;br&gt; &gt; Thanks,&lt;br&gt;
&gt; Is it possible that you create an rpm with this fix so I can use it on&lt;br&gt;
&gt; the test runs and try to reproduce?&lt;br&gt;
&lt;br&gt;
Oh, sure. Is fedora rpm fine?&lt;br&gt;
&lt;br&gt;
Michal&lt;br&gt;
&lt;br&gt;
&lt;/blockquote&gt;&lt;/div&gt;



</body></email><email><emailId>20220110140853</emailId><senderName>Michal Prívozník</senderName><senderEmail>mprivozn@redhat.com</senderEmail><timestampReceived>2022-01-10 14:08:53-0400</timestampReceived><subject>Re: error during host deploy</subject><body>

On 1/10/22 13:04, Dana Elfassy wrote:
&gt; sorry, I missed your last reply
&gt; I didn't reproduce it yet, but fedora rpm would be great. just in case 
&gt; thanks
&gt; 

Here you go:

https://koji.fedoraproject.org/koji/buildinfo?buildID=1867760

Michal

</body></email><email><emailId>20220110140956</emailId><senderName>Michal PrÃ­voznÃ­k</senderName><senderEmail>mprivozn@redhat.com</senderEmail><timestampReceived>2022-01-10 14:09:56-0400</timestampReceived><subject>Re: error during host deploy</subject><body>

On 1/10/22 15:08, Michal Prívozník wrote:
&gt; On 1/10/22 13:04, Dana Elfassy wrote:
&gt;&gt; sorry, I missed your last reply
&gt;&gt; I didn't reproduce it yet, but fedora rpm would be great. just in case 
&gt;&gt; thanks
&gt;&gt;
&gt; 
&gt; Here you go:
&gt; 

Ooops, wrong link. This one is correct:

https://koji.fedoraproject.org/koji/taskinfo?taskID=81062331

Michal

</body></email><email><emailId>20220111101349</emailId><senderName>Dana Elfassy</senderName><senderEmail>delfassy@redhat.com</senderEmail><timestampReceived>2022-01-11 10:13:49-0400</timestampReceived><subject>Re: error during host deploy</subject><body>

In the last one I don't see a link to download the RPM, can you check?

On Mon, Jan 10, 2022 at 4:10 PM Michal Prívozník &lt;mprivozn@redhat.com&gt;
wrote:

&gt; On 1/10/22 15:08, Michal Prívozník wrote:
&gt; &gt; On 1/10/22 13:04, Dana Elfassy wrote:
&gt; &gt;&gt; sorry, I missed your last reply
&gt; &gt;&gt; I didn't reproduce it yet, but fedora rpm would be great. just in case
&gt; &gt;&gt; thanks
&gt; &gt;&gt;
&gt; &gt;
&gt; &gt; Here you go:
&gt; &gt;
&gt;
&gt; Ooops, wrong link. This one is correct:
&gt;
&gt; https://koji.fedoraproject.org/koji/taskinfo?taskID=81062331
&gt;
&gt; Michal
&gt;
&gt;

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;In the last one I don't see a link to download the RPM, can you \
check?&lt;/div&gt;&lt;br&gt;&lt;div class="gmail_quote"&gt;&lt;div dir="ltr" class="gmail_attr"&gt;On Mon, \
Jan 10, 2022 at 4:10 PM Michal Prívozník &lt;&lt;a \
href="mailto:mprivozn@redhat.com"&gt;mprivozn@redhat.com&lt;/a&gt;&gt; \
wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0px 0px 0px \
0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"&gt;On 1/10/22 15:08, \
Michal Prívozník wrote:&lt;br&gt; &gt; On 1/10/22 13:04, Dana Elfassy wrote:&lt;br&gt;
&gt;&gt; sorry, I missed your last reply&lt;br&gt;
&gt;&gt; I didn't reproduce it yet, but fedora rpm would  be great. just in case  \
&lt;br&gt; &gt;&gt; thanks&lt;br&gt;
&gt;&gt;&lt;br&gt;
&gt; &lt;br&gt;
&gt; Here you go:&lt;br&gt;
&gt; &lt;br&gt;
&lt;br&gt;
Ooops, wrong link. This one is correct:&lt;br&gt;
&lt;br&gt;
&lt;a href="https://koji.fedoraproject.org/koji/taskinfo?taskID=81062331" \
rel="noreferrer" target="_blank"&gt;https://koji.fedoraproject.org/koji/taskinfo?taskID=81062331&lt;/a&gt;&lt;br&gt;
 &lt;br&gt;
Michal&lt;br&gt;
&lt;br&gt;
&lt;/blockquote&gt;&lt;/div&gt;



</body></email><email><emailId>20220115055430</emailId><senderName>Ahmad Ismail</senderName><senderEmail>ismail783@gmail.com</senderEmail><timestampReceived>2022-01-15 05:54:30-0400</timestampReceived><subject>Re: What does the positional parameters of "virsh backup-begin" actually do?</subject><body>

Understood everything except

or by waiting for an event with event (the progress of a pull model backup
&gt; is under the control  of  whatever third  party  connects  to  the NBD
&gt; export)


How do I wait for an event with event. Can you please give an example.

However, the clarification till now is sufficient for me. Specially the
link was very helpful.

One more thing, There are some documents which say:

backup-begin &lt;domain&gt; [--backupxml &lt;string&gt;] [--checkpointxml
&lt;string&gt;] [--reuse-external]

There are others which say:

backup-begin domain [backupxml] [checkpointxml] [--reuse-external]

Which syntax is right?


On Sat, Jan 15, 2022 at 3:19 AM Peter Krempa &lt;pkrempa@redhat.com&gt; wrote:

&gt; On Fri, Jan 14, 2022 at 23:39:10 +0600, Ahmad Ismail wrote:
&gt; &gt; Normally when I backup a kvm machine I shutdown the machine then run:
&gt;
&gt; [...]
&gt;
&gt; &gt; The problem with this help is, it is not clear enough.
&gt; &gt;
&gt; &gt; I understand that I should use virsh backup-begin vm1 to backup a live
&gt; kvm
&gt; &gt; machine. However, this command only create .qcow2 files. What about the
&gt; .xml
&gt; &gt; file.
&gt; &gt;
&gt; &gt; What does --backupxml , --checkpointxml &amp; --reuse-external actually do?
&gt; &gt;
&gt; &gt; When should I use them?
&gt;
&gt; 'man virsh' states:
&gt;
&gt;    backup-begin
&gt;        Syntax:
&gt;
&gt;           backup-begin domain [backupxml] [checkpointxml]
&gt; [--reuse-external]
&gt;
&gt;        Begin a new backup job. If backupxml is omitted, this defaults  to
&gt;        a  full  backup  using a push model to filenames generated by lib-
&gt;        virt; supplying XML allows fine-tuning such as requesting  an  in-
&gt;        cremental  backup  relative  to an earlier checkpoint, controlling
&gt;        which disks participate or which filenames are  involved,  or  re-
&gt;        questing  the use of a pull model backup.  The backup-dumpxml com-
&gt;        mand shows any resulting values assigned by libvirt. For more  in-
&gt;        formation           on          backup          XML,          see:
&gt;        https://libvirt.org/formatbackup.html
&gt;
&gt;        If --reuse-external is used it instructs libvirt to  reuse  tempo-
&gt;        rary and output files provided by the user in backupxml.
&gt;
&gt;        If checkpointxml is specified, a second file with a top-level ele-
&gt;        ment of domaincheckpoint is used to create a  simultaneous  check-
&gt;        point,  for  doing a later incremental backup relative to the time
&gt;        the backup was created. See checkpoint-create for more details  on
&gt;        checkpoints.
&gt;
&gt;        This  command returns as soon as possible, and the backup job runs
&gt;        in the background; the progress of a  push  model  backup  can  be
&gt;        checked with domjobinfo or by waiting for an event with event (the
&gt;        progress of a pull model backup is under the control  of  whatever
&gt;        third  party  connects  to  the NBD export). The job is ended with
&gt;        domjobabort.
&gt;
&gt;
&gt; Does this clarify it sufficiently?
&gt;
&gt;

[Attachment #3 (text/html)]

&lt;div dir="ltr"&gt;&lt;div&gt;Understood everything except&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote \
class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left:1px solid \
rgb(204,204,204);padding-left:1ex"&gt;or by waiting for an event with event (the \
progress of a pull model backup is under the control   of   whatever third   party   \
connects   to   the NBD export)&lt;/blockquote&gt;&lt;br&gt;&lt;div&gt;How do I wait for an event with \
event. Can you please give an example.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;However, the \
clarification till now is sufficient for me. Specially the link was very \
helpful.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;One more thing, There are some documents which say: \
&lt;/div&gt;&lt;div&gt;&lt;pre style="white-space:pre-wrap"&gt;&lt;code&gt;backup-begin &lt;domain&gt; \
[--backupxml &lt;string&gt;] [--checkpointxml &lt;string&gt;] \
[--reuse-external]&lt;/code&gt;&lt;/pre&gt;&lt;pre style="white-space:pre-wrap"&gt;&lt;span \
style="font-family:Arial,Helvetica,sans-serif;white-space:normal"&gt;There are others \
which say:&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;pre style="white-space:pre-wrap"&gt;backup-begin domain \
[backupxml] [checkpointxml] [--reuse-external]&lt;span \
style="font-family:Arial,Helvetica,sans-serif;white-space:normal"&gt;&lt;br&gt;&lt;/span&gt;&lt;/pre&gt;&lt;pre \
style="white-space:pre-wrap"&gt;&lt;span \
style="font-family:Arial,Helvetica,sans-serif;white-space:normal"&gt;Which syntax is \
right?&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div class="gmail_quote"&gt;&lt;div dir="ltr" \
class="gmail_attr"&gt;On Sat, Jan 15, 2022 at 3:19 AM Peter Krempa &lt;&lt;a \
href="mailto:pkrempa@redhat.com"&gt;pkrempa@redhat.com&lt;/a&gt;&gt; \
wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote class="gmail_quote" style="margin:0px 0px 0px \
0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"&gt;On Fri, Jan 14, 2022 \
at 23:39:10 +0600, Ahmad Ismail wrote:&lt;br&gt; &gt; Normally when I backup a kvm machine \
I shutdown the machine then run:&lt;br&gt; &lt;br&gt;
[...]&lt;br&gt;
&lt;br&gt;
&gt; The problem with this help is, it is not clear enough.&lt;br&gt;
&gt; &lt;br&gt;
&gt; I understand that I should use virsh backup-begin vm1 to backup a live kvm&lt;br&gt;
&gt; machine. However, this command only create .qcow2 files. What about the .xml&lt;br&gt;
&gt; file.&lt;br&gt;
&gt; &lt;br&gt;
&gt; What does --backupxml , --checkpointxml &amp; --reuse-external actually do?&lt;br&gt;
&gt; &lt;br&gt;
&gt; When should I use them?&lt;br&gt;
&lt;br&gt;
'man virsh' states:&lt;br&gt;
&lt;br&gt;
     backup-begin&lt;br&gt;
           Syntax:&lt;br&gt;
&lt;br&gt;
               backup-begin domain [backupxml] [checkpointxml] [--reuse-external]&lt;br&gt;
&lt;br&gt;
           Begin a new backup job. If backupxml is omitted, this defaults   to&lt;br&gt;
           a   full   backup   using a push model to filenames generated by lib-&lt;br&gt;
           virt; supplying XML allows fine-tuning such as requesting   an   in-&lt;br&gt;
           cremental   backup   relative   to an earlier checkpoint, controlling&lt;br&gt;
           which disks participate or which filenames are   involved,   or   re-&lt;br&gt;
           questing   the use of a pull model backup.   The backup-dumpxml com-&lt;br&gt;
           mand shows any resulting values assigned by libvirt. For more   in-&lt;br&gt;
           formation                 on               backup               XML,       \
                see:&lt;br&gt;
           &lt;a href="https://libvirt.org/formatbackup.html" rel="noreferrer" \
target="_blank"&gt;https://libvirt.org/formatbackup.html&lt;/a&gt;&lt;br&gt; &lt;br&gt;
           If --reuse-external is used it instructs libvirt to   reuse   tempo-&lt;br&gt;
           rary and output files provided by the user in backupxml.&lt;br&gt;
&lt;br&gt;
           If checkpointxml is specified, a second file with a top-level ele-&lt;br&gt;
           ment of domaincheckpoint is used to create a   simultaneous   check-&lt;br&gt;
           point,   for   doing a later incremental backup relative to the time&lt;br&gt;
           the backup was created. See checkpoint-create for more details   on&lt;br&gt;
           checkpoints.&lt;br&gt;
&lt;br&gt;
           This   command returns as soon as possible, and the backup job runs&lt;br&gt;
           in the background; the progress of a   push   model   backup   can   \
                be&lt;br&gt;
           checked with domjobinfo or by waiting for an event with event (the&lt;br&gt;
           progress of a pull model backup is under the control   of   whatever&lt;br&gt;
           third   party   connects   to   the NBD export). The job is ended with&lt;br&gt;
           domjobabort.&lt;br&gt;
&lt;br&gt;
&lt;br&gt;
Does this clarify it sufficiently?&lt;br&gt;
&lt;br&gt;
&lt;/blockquote&gt;&lt;/div&gt;



</body></email><email><emailId>20220124102915</emailId><senderName>Raphael Norwitz</senderName><senderEmail>raphael.norwitz@nutanix.com</senderEmail><timestampReceived>2022-01-24 10:29:15-0400</timestampReceived><subject>Best practices for retrying QEMU P2P migrations</subject><body>

Heya,

We've recently hit a number of failures on QEMU P2P live migrations
which appear to be caused by transient networking disconnects at
different points in the migration process. We would like to implement
smarter retry logic in our control plane to ensure such issues don't
stall critical workflows. On the other hand, we cannot blindly retry
every failed migration because doing so greatly lengthens the time to
fail high level autmation when there is a real problem.

Are there currently any generally understood best practices for retrying
migrations from a control plane perspective?  Ideally we would decide
whether or not to retry based on error codes, but especially in the QEMU
P2P migration path many generic codes are returned. For example, see [1]
where we attempted to improve an error code for a likely retry-able set
of failure cases.

[1] https://listman.redhat.com/archives/libvir-list/2022-January/msg00217.html

Thanks,
Raphael

</body></email><email><emailId>20220125173324</emailId><senderName>lejeczek</senderName><senderEmail>peljasz@yahoo.co.uk</senderEmail><timestampReceived>2022-01-25 17:33:24-0400</timestampReceived><subject>cpuset.mems - Device or resource busy</subject><body>

Hi guys

On Centos 9 I get these in journal:

...

libvirt version: 8.0.0, package: 1.el9 (builder@centos.org, 
2022-01-14-15:00:06, )
hostname: dzien.mine.private
Unable to write to 
'/sys/fs/cgroup/machine.slice/machine-qemu\x2d4\x2dubusrv2.scope/libvirt/cpuset.mems': 
Device or resource busy

...

each time I do:

-&gt; virt-admin daemon-log-outputs

There is more VMs running on the host but it's only these Ubuntu VMs 
Libvirt is not happy about.

Any and all suggestions very appreciated.

many thanks, L


</body></email><email><emailId>20220127100713</emailId><senderName>Peter Krempa</senderName><senderEmail>pkrempa@redhat.com</senderEmail><timestampReceived>2022-01-27 10:07:13-0400</timestampReceived><subject>Re: Backend memory object creation - query</subject><body>

On Thu, Jan 27, 2022 at 04:05:19 +0000, M, Shivakumar wrote:
&gt; Hello,

Hi,

note that there's no need to CC both libvir-list and libvirt-users
maling lists.

&gt; 
&gt; 
&gt; For our use-case with Libvirt we want to create the Memory backend object ,
&gt; 
&gt; Expected QEMU args would be
&gt; -object memory-backend-memfd,id=mem1,size=4096M

Your description is a bit vague. Do you want to use it to back the guest
memory?

As by itself a memory object itself is useless without being attached
somewhere

In case you want to configure qemu to back the default memory of the VM
by a memfd:

Per https://www.libvirt.org/formatdomain.html#memory-backing

&lt;domain type='kvm'&gt;
 ...

 &lt;memoryBacking&gt;
   &lt;source type='memfd'/&gt;
 &lt;/memoryBacking&gt;
...
&lt;/domain&gt;

Results into invoking qemu with:

-machine pc-i440fx-2.9,usb=off,vmport=off,dump-guest-core=off,memory-backend=pc.ram \
...
-object '{"qom-type":"memory-backend-memfd","id":"pc.ram","x-use-canonical-path-for-ramblock-id":false,"size":1048576000,"host-nodes":[0],"policy":"bind"}' \
\


&gt; 
&gt; Request you to please help us to specify this arg in the libvirt XML.
&gt; 
&gt; Thanks,
&gt; Shiv


</body></email><email><emailId>20220130054803</emailId><senderName>Charles Polisher</senderName><senderEmail>chas@chasmo.org</senderEmail><timestampReceived>2022-01-30 05:48:03-0400</timestampReceived><subject>Re: frequent network collapse possibly due to bridging</subject><body>

On 1/29/22 10:06, Hakan E. Duran wrote:
&gt; Thank you so much for sharing your script as well! This is so helpful. 
Thank the author, Yury V. Zaytsev &lt;yury@shurup.com&gt;
&gt; I truly appreciate it knowing that it may not be possible to identify what actually is wrong/failing.

Please post the version of your Hypervisor's OS ("cat /etc/os-release").
If that file doesn't exist, any of: /etc/system-release, 
/etc/redhat-release,
/etc/SuSE-release, /etc/debian_version, /etc/arch-release,
/etc/gentoo-release, /etc/slackware-version, /etc/frugalware-release,
/etc/altlinux-release, /etc/mandriva-release, or /etc/meego-release.

Also please post the version of spice-server: considering
https://bugzilla.redhat.com/show_bug.cgi?id=912218 ,
which is described as
      boot up guest in rhel7 host then, do screen via qmp monitor
      in loop, qemu report error message:*"qxl_send_events: spice-server**
**     bug: guest stopped, ignoring*".
      Version-Release number of selected component :
*spice-server-0.12.2-1.el7.x86_64*
      qemu-kvm-1.3.0-5.el7.x86_64
and which is claimed to be fixed. If this is a regression,
and you're running a Red Hat system, you might report it there.

Finally, there is a method for increasing the verbosity of error
logging, but it's a bit tedious to set up and to interpret the
results. See: https://libvirt.org/logging.html#log_config
For example, setting *LIBVIRT_DEBUG=2* in the startup code for
libvirt. Where exactly to set this will depend on your OS.

Best luck,
-- 
Charles

[Attachment #3 (text/html)]

&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8"&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;p&gt;&lt;br&gt;
    &lt;/p&gt;
    &lt;div class="moz-cite-prefix"&gt;On 1/29/22 10:06, Hakan E. Duran wrote:&lt;br&gt;
    &lt;/div&gt;
    &lt;blockquote type="cite"
      cite="mid:20220129180635.pixocebawngls6bl@dizustum.duranonline.net"&gt;Thank
      you so much for sharing your script as well! This is so helpful.
    &lt;/blockquote&gt;
    Thank the author, Yury V. Zaytsev &lt;a class="moz-txt-link-rfc2396E"
      href="mailto:yury@shurup.com"&gt;&lt;yury@shurup.com&gt;&lt;br&gt;
    &lt;/a&gt;
    &lt;blockquote type="cite"
      cite="mid:20220129180635.pixocebawngls6bl@dizustum.duranonline.net"&gt;
      &lt;pre class="moz-quote-pre" wrap=""&gt;I truly appreciate it knowing that it may \
not be possible to identify what actually is wrong/failing. &lt;/pre&gt;
    &lt;/blockquote&gt;
    &lt;p&gt;Please post the version of your Hypervisor's OS ("cat
      /etc/os-release").&lt;br&gt;
      If that file doesn't exist, any of: /etc/system-release,
      /etc/redhat-release,&lt;br&gt;
      /etc/SuSE-release, /etc/debian_version, /etc/arch-release, &lt;br&gt;
      /etc/gentoo-release, /etc/slackware-version,
      /etc/frugalware-release,&lt;br&gt;
      /etc/altlinux-release, /etc/mandriva-release, or
      /etc/meego-release.&lt;/p&gt;
    &lt;p&gt;Also please post the version of spice-server: considering&lt;br&gt;
      &lt;a class="moz-txt-link-freetext" \
href="https://bugzilla.redhat.com/show_bug.cgi?id=912218"&gt;https://bugzilla.redhat.com/show_bug.cgi?id=912218&lt;/a&gt; \
,&lt;br&gt;  which is described as&lt;br&gt;
           boot up guest in rhel7 host then, do screen via qmp monitor &lt;br&gt;
           in loop, qemu report error message:&lt;b&gt; "qxl_send_events:
        spice-server&lt;/b&gt;&lt;b&gt;&lt;br&gt;
      &lt;/b&gt;&lt;b&gt;     bug: guest stopped, ignoring&lt;/b&gt;".&lt;br&gt;
           Version-Release number of selected component :&lt;br&gt;
           &lt;b&gt;spice-server-0.12.2-1.el7.x86_64&lt;/b&gt;&lt;br&gt;
           qemu-kvm-1.3.0-5.el7.x86_64&lt;br&gt;
      and which is claimed to be fixed. If this is a regression,&lt;br&gt;
      and you're running a Red Hat system, you might report it there.&lt;br&gt;
      &lt;br&gt;
      Finally, there is a method for increasing the verbosity of error&lt;br&gt;
      logging, but it's a bit tedious to set up and to interpret the&lt;br&gt;
      results. See: &lt;a class="moz-txt-link-freetext" \
href="https://libvirt.org/logging.html#log_config"&gt;https://libvirt.org/logging.html#log_config&lt;/a&gt;&lt;br&gt;
  For example, setting &lt;b&gt;LIBVIRT_DEBUG=2&lt;/b&gt; in the startup code
      for&lt;br&gt;
      libvirt. Where exactly to set this will depend on your OS.&lt;/p&gt;
    &lt;p&gt;Best luck,&lt;br&gt;
      -- &lt;br&gt;
      Charles&lt;br&gt;
    &lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;



</body></email></emails>